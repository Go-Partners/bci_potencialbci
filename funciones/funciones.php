<?php
function VerificaArregloSQLInjectionV2($arreglo)
{
    $total_arreglo = count($arreglo);

    foreach ($arreglo as $clave => $valor) {

       if (strtoupper(trim($valor)) == "") {
            continue;
        }
     
        $valor = str_replace("'", "", $valor);
        $valor = str_replace('"', "", $valor);
        $valor = str_replace("+'", "", $valor);
        $valor = str_replace('--', "", $valor);
        $valor = str_replace('--', "", $valor);
        $valor = str_replace('--', "", $valor);
        //$valor = str_replace('', "", $valor);
        $valor = str_replace('.php', "", $valor);
        $valor = str_replace('.js', "", $valor);
        $valor = str_replace('.vbs', "", $valor);
        $valor = str_replace('%', "", $valor);
        $//valor = str_replace('&', "", $valor);
        $valor = str_replace('&amp;', "", $valor);
        $valor = str_replace('&#38;', "", $valor);
        $valor = str_replace('<', "", $valor);
        $valor = str_replace('&lt;', "", $valor);
        $valor = str_replace('&#60;', "", $valor);
        $valor = str_replace('>', "", $valor);
        $valor = str_replace('&gt;', "", $valor);
        $valor = str_replace('&#62;', "", $valor);
        $valor = str_replace('&quot;', "", $valor);
        $valor = str_replace('&#34;', "", $valor);
        $valor = str_replace('&#39;', "", $valor);
        $valor = str_replace('select', "", $valor);
        $valor = str_replace('tables', "", $valor);
        $valor = str_replace('union', "", $valor);
        $valor = str_replace('information_schema', "", $valor);
        //$valor = str_replace('', "", $valor);
        $valor = str_replace('delete', "", $valor);
        $valor = str_replace('update', "", $valor);
        $valor = str_replace('show', "", $valor);
        $valor = str_replace('|', "", $valor);
        $arreglo[$clave]= $valor;
    }
    return ($arreglo);
}

function CheckVisualizaMiRxRxCol($miRx,	$miRx_2){
	
	if($miRx=="")		{$visualiza="NO";}
	if($miRx=="R1")	{$visualiza="SI";}

	if($miRx=="R2" and $miRx_2=="R1"){$visualiza="NO";}
	if($miRx=="R2" and $miRx_2=="R2"){$visualiza="NO";}
	if($miRx=="R2" and $miRx_2=="R3"){$visualiza="SI";}
	if($miRx=="R2" and $miRx_2=="R4"){$visualiza="SI";}
	if($miRx=="R2" and $miRx_2=="R5"){$visualiza="SI";}
	if($miRx=="R2" and $miRx_2=="R6"){$visualiza="SI";}
	if($miRx=="R2" and $miRx_2=="R7"){$visualiza="SI";}
	
	if($miRx=="R3" and $miRx_2=="R1"){$visualiza="NO";}
	if($miRx=="R3" and $miRx_2=="R2"){$visualiza="NO";}
	if($miRx=="R3" and $miRx_2=="R3"){$visualiza="NO";}
	if($miRx=="R3" and $miRx_2=="R4"){$visualiza="SI";}
	if($miRx=="R3" and $miRx_2=="R5"){$visualiza="SI";}
	if($miRx=="R3" and $miRx_2=="R6"){$visualiza="SI";}
	if($miRx=="R3" and $miRx_2=="R7"){$visualiza="SI";}

	if($miRx=="R4" and $miRx_2=="R1"){$visualiza="NO";}
	if($miRx=="R4" and $miRx_2=="R2"){$visualiza="NO";}
	if($miRx=="R4" and $miRx_2=="R3"){$visualiza="NO";}
	if($miRx=="R4" and $miRx_2=="R4"){$visualiza="NO";}
	if($miRx=="R4" and $miRx_2=="R5"){$visualiza="SI";}
	if($miRx=="R4" and $miRx_2=="R6"){$visualiza="SI";}
	if($miRx=="R4" and $miRx_2=="R7"){$visualiza="SI";}

	if($miRx=="R5" and $miRx_2=="R1"){$visualiza="NO";}
	if($miRx=="R5" and $miRx_2=="R2"){$visualiza="NO";}
	if($miRx=="R5" and $miRx_2=="R3"){$visualiza="NO";}
	if($miRx=="R5" and $miRx_2=="R4"){$visualiza="NO";}
	if($miRx=="R5" and $miRx_2=="R5"){$visualiza="NO";}
	if($miRx=="R5" and $miRx_2=="R6"){$visualiza="SI";}
	if($miRx=="R5" and $miRx_2=="R7"){$visualiza="SI";}

	if($miRx=="R6" and $miRx_2=="R1"){$visualiza="NO";}
	if($miRx=="R6" and $miRx_2=="R2"){$visualiza="NO";}
	if($miRx=="R6" and $miRx_2=="R3"){$visualiza="NO";}
	if($miRx=="R6" and $miRx_2=="R4"){$visualiza="NO";}
	if($miRx=="R6" and $miRx_2=="R5"){$visualiza="NO";}
	if($miRx=="R6" and $miRx_2=="R6"){$visualiza="NO";}
	if($miRx=="R6" and $miRx_2=="R7"){$visualiza="SI";}
			
	if($miRx=="R7" and $miRx_2=="R1"){$visualiza="NO";}
	if($miRx=="R7" and $miRx_2=="R2"){$visualiza="NO";}
	if($miRx=="R7" and $miRx_2=="R3"){$visualiza="NO";}
	if($miRx=="R7" and $miRx_2=="R4"){$visualiza="NO";}
	if($miRx=="R7" and $miRx_2=="R5"){$visualiza="NO";}
	if($miRx=="R7" and $miRx_2=="R6"){$visualiza="NO";}
	if($miRx=="R7" and $miRx_2=="R7"){$visualiza="NO";}	

	$perfil_super=Potencial_SoySuper($_SESSION["user_"]);
	//print_r($perfil_super);
	if($perfil_super>0){
		$visualiza="SI";
	}

	

	return $visualiza;
	
}
function CheckMiRxRxPropuesto($miRx,	$miRx_2){
	
	
	if($miRx=="")		{$save="NO";}
	if($miRx=="R1")	{$save="SI";}

	if($miRx=="R2" and $miRx_2=="R1"){$save="NO";}
	if($miRx=="R2" and $miRx_2=="R2"){$save="SI";}
	if($miRx=="R2" and $miRx_2=="R3"){$save="SI";}
	if($miRx=="R2" and $miRx_2=="R4"){$save="SI";}
	if($miRx=="R2" and $miRx_2=="R5"){$save="SI";}
	if($miRx=="R2" and $miRx_2=="R6"){$save="SI";}
	if($miRx=="R2" and $miRx_2=="R7"){$save="SI";}
	
	if($miRx=="R3" and $miRx_2=="R1"){$save="NO";}
	if($miRx=="R3" and $miRx_2=="R2"){$save="NO";}
	if($miRx=="R3" and $miRx_2=="R3"){$save="SI";}
	if($miRx=="R3" and $miRx_2=="R4"){$save="SI";}
	if($miRx=="R3" and $miRx_2=="R5"){$save="SI";}
	if($miRx=="R3" and $miRx_2=="R6"){$save="SI";}
	if($miRx=="R3" and $miRx_2=="R7"){$save="SI";}

	if($miRx=="R4" and $miRx_2=="R1"){$save="NO";}
	if($miRx=="R4" and $miRx_2=="R2"){$save="NO";}
	if($miRx=="R4" and $miRx_2=="R3"){$save="NO";}
	if($miRx=="R4" and $miRx_2=="R4"){$save="SI";}
	if($miRx=="R4" and $miRx_2=="R5"){$save="SI";}
	if($miRx=="R4" and $miRx_2=="R6"){$save="SI";}
	if($miRx=="R4" and $miRx_2=="R7"){$save="SI";}

	if($miRx=="R5" and $miRx_2=="R1"){$save="NO";}
	if($miRx=="R5" and $miRx_2=="R2"){$save="NO";}
	if($miRx=="R5" and $miRx_2=="R3"){$save="NO";}
	if($miRx=="R5" and $miRx_2=="R4"){$save="NO";}
	if($miRx=="R5" and $miRx_2=="R5"){$save="SI";}
	if($miRx=="R5" and $miRx_2=="R6"){$save="SI";}
	if($miRx=="R5" and $miRx_2=="R7"){$save="SI";}


	if($miRx=="R6" and $miRx_2=="R1"){$save="NO";}
	if($miRx=="R6" and $miRx_2=="R2"){$save="NO";}
	if($miRx=="R6" and $miRx_2=="R3"){$save="NO";}
	if($miRx=="R6" and $miRx_2=="R4"){$save="NO";}
	if($miRx=="R6" and $miRx_2=="R5"){$save="NO";}
	if($miRx=="R6" and $miRx_2=="R6"){$save="SI";}
	if($miRx=="R6" and $miRx_2=="R7"){$save="SI";}
			
	if($miRx=="R7" and $miRx_2=="R1"){$save="NO";}
	if($miRx=="R7" and $miRx_2=="R2"){$save="NO";}
	if($miRx=="R7" and $miRx_2=="R3"){$save="NO";}
	if($miRx=="R7" and $miRx_2=="R4"){$save="NO";}
	if($miRx=="R7" and $miRx_2=="R5"){$save="NO";}
	if($miRx=="R7" and $miRx_2=="R6"){$save="NO";}
	if($miRx=="R7" and $miRx_2=="R7"){$save="SI";}	

	return $save;
	
}

function PotChecKMisUsuarioFuera($rut_col){
	
	//echo "<h1>rut_col $rut_col</h1>";
	$soy_super=Potencial_SoySuper($_SESSION["user_"]);
	//echo "PotChecKMisUsuarioFuera soy super $soy_super";
	
	if($soy_super>0){
		//echo "soy syper";
	} else {
		//echo "no soy syper. ";
		$bloqueado=Check_Usr_PrimerNivel_Bloqueado($rut_col);
		if($bloqueado>0){
			echo "    <script>         location.href='?sw=home_bci_new';     </script>"; exit;	
		}
	//echo "bloqueado $bloqueado .";	
	
	$bloqueadoGGPP=Check_Usr_PrimerNivel_BloqueadoGGPP($rut_col);
	//echo "bloqueadoGGPP $bloqueadoGGPP .";	
		if($bloqueadoGGPP>0){
				//echo "<br>UNO Bloqueo<br>".$_SESSION["user_"]." rut col ".$rut_col;	
				$BloqueSoyLider=Check_Usr_PrimerNivel_BloqueadoGGPP_soyLider($rut_col);
				//echo "<br>UNO BloqueSoyLider<br>".$BloqueSoyLider;	
				
				if($BloqueSoyLider>0){
					//echo "a"; 
					
				} else {
					$continue="1";
										//echo "<br>b"; continue;
				//echo "    <script>         location.href='?sw=home_bci_new1';     </script>"; exit;	
					
				}
				
		}
	}
	if($soy_super>0){
	} else {
		
	
		if($_SESSION["user_"]==LimpiaRutFront($rut_col)){
			echo "    <script>         location.href='?sw=home_bci_new';     </script>"; exit;		
		}
	}
	return $continue;
}

// panel de liderazgo

function Panel_valor_competencias_en_base_cien($promedio_res){
	
	
//echo "<br>promedio_res $promedio_res<br>";
	
if($promedio_res>=1 and $promedio_res<1.1){$valor=0;}
if($promedio_res>=1.1 and $promedio_res<1.2){$valor=5.5625;}
if($promedio_res>=1.2 and $promedio_res<1.3){$valor=11.125;}
if($promedio_res>=1.3 and $promedio_res<1.4){$valor=16.6875;}
if($promedio_res>=1.4 and $promedio_res<1.5){$valor=22.25;}
if($promedio_res>=1.5 and $promedio_res<1.6){$valor=27.8125;}
if($promedio_res>=1.6 and $promedio_res<1.7){$valor=33.375;}
if($promedio_res>=1.7 and $promedio_res<1.8){$valor=38.9375;}
if($promedio_res>=1.8 and $promedio_res<1.9){$valor=44.5;}
if($promedio_res>=1.9 and $promedio_res<2){$valor=50.0625;}
if($promedio_res>=2 and $promedio_res<2.1){$valor=55.625;}
if($promedio_res>=2.1 and $promedio_res<2.2){$valor=61.1875;}
if($promedio_res>=2.2 and $promedio_res<2.3){$valor=66.75;}
if($promedio_res>=2.3 and $promedio_res<2.4){$valor=72.3125;}
if($promedio_res>=2.4 and $promedio_res<2.5){$valor=77.875;}
if($promedio_res>=2.5 and $promedio_res<2.59){$valor=83.4375;}
if($promedio_res>=2.59 and $promedio_res<2.6){$valor=89;}
if($promedio_res>=2.6 and $promedio_res<2.7){$valor=90;}
if($promedio_res>=2.7 and $promedio_res<2.8){$valor=92;}
if($promedio_res>=2.8 and $promedio_res<2.9){$valor=94;}
if($promedio_res>=2.9 and $promedio_res<3){$valor=96;}
if($promedio_res>=3 and $promedio_res<3.1){$valor=98;}
if($promedio_res>=3.1 and $promedio_res<3.2){$valor=100;}
if($promedio_res>=3.2 and $promedio_res<3.3){$valor=102;}
if($promedio_res>=3.3 and $promedio_res<3.4){$valor=104;}
if($promedio_res>=3.4 and $promedio_res<3.5){$valor=106;}
if($promedio_res>=3.5 and $promedio_res<3.59){$valor=108;}
if($promedio_res>=3.59 and $promedio_res<3.6){$valor=110;}
if($promedio_res>=3.6 and $promedio_res<3.7){$valor=111.33;}
if($promedio_res>=3.7 and $promedio_res<3.8){$valor=112.66;}
if($promedio_res>=3.8 and $promedio_res<3.9){$valor=113.99;}
if($promedio_res>=3.9 and $promedio_res<4){$valor=115.32;}
if($promedio_res>=4 and $promedio_res<4.1){$valor=116.65;}
if($promedio_res>=4.1 and $promedio_res<4.2){$valor=117.98;}
if($promedio_res>=4.2 and $promedio_res<4.3){$valor=119.31;}
if($promedio_res>=4.3 and $promedio_res<4.4){$valor=120.64;}
if($promedio_res>=4.4 and $promedio_res<4.5){$valor=121.97;}
if($promedio_res>=4.5 and $promedio_res<4.6){$valor=123.3;}
if($promedio_res>=4.6 and $promedio_res<4.7){$valor=124.63;}
if($promedio_res>=4.7 and $promedio_res<4.8){$valor=125.96;}
if($promedio_res>=4.8 and $promedio_res<4.9){$valor=127.29;}
if($promedio_res>=4.9 and $promedio_res<5){$valor=128.62;}
if($promedio_res>=5 and $promedio_res<6){$valor=130;}


	return $valor;
	//echo "<br>valor $valor<br>";

}


function Panel_valor_liderazgo_en_base_cien($promedio_res){
	
	
//echo "<br>Panel_valor_liderazgo_en_base_cien $promedio_res<br>";
	
	
if($promedio_res>=100 and $promedio_res<1000){$valor=130;}
if($promedio_res>=99 and $promedio_res<100){$valor=128.5;}
if($promedio_res>=98 and $promedio_res<99){$valor=127;}
if($promedio_res>=97 and $promedio_res<98){$valor=125.5;}
if($promedio_res>=96 and $promedio_res<97){$valor=124;}
if($promedio_res>=95 and $promedio_res<96){$valor=122.5;}
if($promedio_res>=94 and $promedio_res<95){$valor=121;}
if($promedio_res>=93 and $promedio_res<94){$valor=119.5;}
if($promedio_res>=92 and $promedio_res<93){$valor=118;}
if($promedio_res>=91 and $promedio_res<92){$valor=116.5;}
if($promedio_res>=90 and $promedio_res<91){$valor=115;}
if($promedio_res>=89 and $promedio_res<90){$valor=113.5;}
if($promedio_res>=88 and $promedio_res<89){$valor=112;}
if($promedio_res>=87 and $promedio_res<88){$valor=110.5;}
if($promedio_res>=86 and $promedio_res<87){$valor=109;}
if($promedio_res>=85 and $promedio_res<86){$valor=107.5;}
if($promedio_res>=84 and $promedio_res<85){$valor=106;}
if($promedio_res>=83 and $promedio_res<84){$valor=104.5;}
if($promedio_res>=82 and $promedio_res<83){$valor=103;}
if($promedio_res>=81 and $promedio_res<82){$valor=101.5;}
if($promedio_res>=80 and $promedio_res<81){$valor=100;}
if($promedio_res>=79 and $promedio_res<80){$valor=98.5;}
if($promedio_res>=78 and $promedio_res<79){$valor=97;}
if($promedio_res>=77 and $promedio_res<78){$valor=95.5;}
if($promedio_res>=76 and $promedio_res<77){$valor=94;}
if($promedio_res>=75 and $promedio_res<76){$valor=92.5;}
if($promedio_res>=74 and $promedio_res<75){$valor=91;}
if($promedio_res>=73 and $promedio_res<74){$valor=89.5;}
if($promedio_res>=72 and $promedio_res<73){$valor=88;}
if($promedio_res>=71 and $promedio_res<72){$valor=86.5;}
if($promedio_res>=70 and $promedio_res<71){$valor=85;}
if($promedio_res>=69 and $promedio_res<70){$valor=83.5;}
if($promedio_res>=68 and $promedio_res<69){$valor=82;}
if($promedio_res>=67 and $promedio_res<68){$valor=80.5;}
if($promedio_res>=66 and $promedio_res<67){$valor=79;}
if($promedio_res>=65 and $promedio_res<66){$valor=77.5;}
if($promedio_res>=64 and $promedio_res<65){$valor=76;}
if($promedio_res>=63 and $promedio_res<64){$valor=74.5;}
if($promedio_res>=62 and $promedio_res<63){$valor=73;}
if($promedio_res>=61 and $promedio_res<62){$valor=71.5;}
if($promedio_res>=60 and $promedio_res<61){$valor=70;}
if($promedio_res>=59 and $promedio_res<60){$valor=0;}
if($promedio_res>=58 and $promedio_res<59){$valor=0;}
if($promedio_res>0 and $promedio_res<58){$valor=0;}


//echo "<br>Panel_valor_liderazgo_en_base_cien $valor<br>";



	return $valor;
	//echo "<br>valor $valor<br>";

}


function PanelBuscaTipoDatos($PRINCIPAL, $id_empresa, $rut_col, $tipo, $year)
{
	
if($tipo=="QUE"){

$PanelTipoFlexContinue	=PanelBuscoFlexPersonaYDanCotinue($rut_col, $id_empresa);
	//echo "<br>continue para $rut_col es $PanelTipoFlexContinue<br>";
	$Panel_Criterios=PanelBuscaPanelCriterios($tipo, $id_empresa);
	//print_r($Panel_Criterios);
	$cuenta_verde=0;
	$cuenta_todos=0;	
	foreach ($Panel_Criterios as $unico){

		if($unico->id_kpi==$PanelTipoFlexContinue){continue;}
						
			$array_res			=		PanelBuscaResultadoKpiInicioFinal($unico->id_kpi, $rut_col, $id_empresa,$year);
				//echo "<pre>";print_r($array_res);echo "</pre>";		

			$array_res_inicio	=	$array_res[0];
			$array_res_final	=	$array_res[1];
			//echo "<pre>";
			//print_r($array_res_inicio);
			//echo "</pre>";
	
			$resultado_inicial		=		round(100*$array_res_inicio[0]->numerador/$array_res_inicio[0]->dotacion);
			$resultado_final			=		round(100*$array_res_final[0]->numerador/$array_res_final[0]->dotacion);
			//echo "<br>resultado inicial $resultado_inicial, resultado final $resultado_final<br>";

			$resultado_inicial		=		round($array_res_inicio[0]->cumplimiento);
			$resultado_final			=		round($array_res_final[0]->cumplimiento);	
			
			if($unico->id_kpi=="en"){
				$resultado_inicial			=		PanelBuscaResultadoKpiInicioFinalEngLid("eng_c", $rut_col, $id_empresa,$year);
				$resultado_final				=  	$resultado_inicial;
			}

			$gestion				= 	PanelGeneraGestionDadoKpi($resultado_inicial, $resultado_final);
			$semaforo				=		PanelGeneraSemaforoDadoKpi($resultado_inicial, $resultado_final, $unico->kpi_aspiracional);
			$semaforo_txt		=		PanelGeneraTxtSemaforoDadoKpi($resultado_inicial, $resultado_final, $unico->kpi_aspiracional);
			
			
			if($semaforo=="<div class='panel_semaforo_verde'><i class='fas fa-dot-circle'></i></div>"){$cuenta_verde++;}
			$cuenta_todos++;
			//echo "<br>kpi ".$unico->id_kpi."->  $cuenta_verde semaforo ".$semaforo;
			$url="?sw=panel_liderazgo_vista_usuario_tendencia&rutcol=".Encodear3($rut_col)."&idp=".Encodear3($unico->id_kpi);
			
	   	$row.= file_get_contents("views/panel_liderazgo/row_vista_colaborador.html");	
	   	$row = str_replace("{NOMBRE_KPI}",     	utf8_encode($unico->kpi), $row);
	   	$row = str_replace("{PONDERACION}",    	utf8_encode($unico->ponderacion), $row);
	   	$row = str_replace("{ASPIRACIONAL}",   	utf8_encode($unico->kpi_aspiracional), $row);
	   	$row = str_replace("{RESULTADO}",      	utf8_encode($resultado_final), $row);
	   	$row = str_replace("{GESTION}",      		utf8_encode($gestion), $row);
	   	$row = str_replace("{SEMAFORO}",      	utf8_encode($semaforo), $row);
	   	$row = str_replace("{URL}",      				utf8_encode($url), $row);
		//echo "<br>cuenta verde. $semaforo_txt. $cuenta_verde.<br>";
	}

		$resultado_cuenta_verdes_que=PanelResultadoCuentaVerdes($cuenta_verde,$cuenta_todos);
		$PRINCIPAL = str_replace("{RESULTADO_QUE}",         $resultado_cuenta_verdes_que,         $PRINCIPAL);
    $PRINCIPAL = str_replace("{PANEL_ROW_QUE}",         $row,         												$PRINCIPAL);
}


if($tipo=="COMPETENCIAS"){

				PanelBuscaResultadoKpiInicioFinalEngLid($id_kpi, $rut_col, $id_empresa, $year);
				$resultado_inicial_LID			=		PanelBuscaResultadoKpiInicioFinalEngLid("lid_c", $rut_col, $id_empresa,$year);
				$aspiracional_LID						=  	PanelBuscaAspiracionalCriterio("en");
				$semaforo										=		PanelGeneraSemaforoDadoKpi($resultado_inicial_LID, $resultado_inicial_LID, $aspiracional_LID);


    $PRINCIPAL = str_replace("{ASPIRACIONAL_LIDERAZGO}",      $aspiracional_LID,         												$PRINCIPAL);
    $PRINCIPAL = str_replace("{RESULTADO_LIDERAZGO}",         $resultado_inicial_LID,							$PRINCIPAL);
    $PRINCIPAL = str_replace("{GESTION_LIDERAZGO}",           "",         												$PRINCIPAL);
    $PRINCIPAL = str_replace("{SEMAFORO_LIDERAZGO}",          $semaforo,         												$PRINCIPAL);

$cumplimiento_liderazgo=Panel_valor_liderazgo_en_base_cien($resultado_inicial_LID);

    $PRINCIPAL = str_replace("{CUMPLIMIENTO_LIDERAZGO}",          $cumplimiento_liderazgo,         												$PRINCIPAL);

	$Panel_Criterios=PanelBuscaPanelCriterios($tipo, $id_empresa);
	foreach ($Panel_Criterios as $unico){

			//echo "<br><br>id ".$unico->id_kpi."<br><br>";
			$array_res		=PanelBuscaResultadosCompetencias($unico->id_kpi, $rut_col, $year, $id_empresa);
			//print_r($array_res);
			
			foreach ($array_res as $un){
					//print_r($un);
					if($un->evaluacion == "Autoevaluacion")	{								$res_ae	=	$un->resultado;}
					if($un->evaluacion == "Descendente")		{								$res_ds	=	$un->resultado;}
					if($un->evaluacion == "Mis Pares")			{								$res_mp	=	$un->resultado;}
					if($un->evaluacion == "Ascendente")			{								$res_as	=	$un->resultado;}
			}

			//echo "<br><br>AE $res_ae , DS $res_ds, MP $res_mp, AS $res_as";
			$res_linea_competencia			= 	PanelResCompetenciaLinea($res_ae,$res_ds,$res_mp,$res_as);
			
			//print_r($res_linea_competencia);		
			
			$res_linea_competencia_res  =	  $res_linea_competencia[0];
			
			$pon_ds			=		$res_linea_competencia[1];
			$pon_as			=		$res_linea_competencia[2];
			$pon_mp     =		$res_linea_competencia[3];
			$pon_ae     =		$res_linea_competencia[4];		
			
			//echo "<br>pon_ae $pon_ae";
			
			//$res_linea_competencia			=   PanelLiderazgoResultadoFinal($res_ds,$res_ae,$res_as,$res_mp);
			$suma_res										=		$suma_res	+	round($res_linea_competencia_res*20/100,2);
			//echo "<br>$res_linea_competencia, $suma_res	";

			
			//echo "<br>kpi ".$unico->id_kpi.", res $suma_res		= liunea competencia		$res_linea_competencia	+	suma_res	$suma_res ";
			
			$cuenta_competencias++;
			//echo "<br>rut $rut_col,  Resultaso competencias ".$array_res[0]->evaluacion." resultados ".$array_res[0]->resultado." des $res_ds";
			
	   	$row.= file_get_contents("views/panel_liderazgo/row_vista_colaborador_competencias.html");	
	   	$row = str_replace("{NOMBRE_KPI}",     	utf8_encode($unico->kpi), $row);
	   	$row = str_replace("{PONDERACION}",    	utf8_encode($unico->ponderacion), $row);
	   	$row = str_replace("{DESCENDENTE}",   	utf8_encode($res_ds), $row);
	   	$row = str_replace("{ASCENDENTE}",     	utf8_encode($res_as), $row);
	   	$row = str_replace("{AUTOEVALUACION}", 	utf8_encode($res_ae), $row);
	   	$row = str_replace("{PARES}",      			utf8_encode($res_mp), $row);
	   	$row = str_replace("{RESULTADO_PONDERADO_COMPETENCIAS}",    utf8_encode($res_linea_competencia_res), $row);

			$res_ds_number=str_replace(",",".",$res_ds);
			$res_as_number=str_replace(",",".",$res_as);
			$res_ae_number=str_replace(",",".",$res_ae);
			$res_mp_number=str_replace(",",".",$res_mp);
			$res_linea_competencia_number=str_replace(",",".",$res_linea_competencia_res);



			if($res_ds<>""){$suma_res_ds=$res_ds_number+$suma_res_ds; $cuenta_res_ds++;}
			if($res_as<>""){$suma_res_as=$res_as_number+$suma_res_as; $cuenta_res_as++;}
			if($res_ae<>""){$suma_res_ae=$res_ae_number+$suma_res_ae; $cuenta_res_ae++;}
			if($res_mp<>""){$suma_res_mp=$res_mp_number+$suma_res_mp; $cuenta_res_mp++;}
			if($res_linea_competencia<>""){$suma_res_linea=$res_linea_competencia_number+$suma_res_linea; $cuenta_res_linea++;}
		//echo "<br>cuenta verde. $semaforo_txt. $cuenta_verde.<br>";
	}

$promedio_ds		=round($suma_res_ds/$cuenta_res_ds, 2);
$promedio_as		=round($suma_res_as/$cuenta_res_as, 2);
$promedio_ae		=round($suma_res_ae/$cuenta_res_ae, 2);
$promedio_mp		=round($suma_res_mp/$cuenta_res_mp, 2);
$promedio_res		=round($suma_res_linea/$cuenta_res_linea, 2);


			//echo "<br>promedio RE $promedio_res, $suma_res_linea/$cuenta_res_linea";
	   	$row.= file_get_contents("views/panel_liderazgo/row_vista_colaborador_competencias_total.html");	
	   	$row = str_replace("{NOMBRE_KPI}",     	"Resultado Total", $row);
	   	$row = str_replace("{PONDERACION}",    	"", $row);
	   	$row = str_replace("{DESCENDENTE}",   	utf8_encode($promedio_ds), $row);
	   	$row = str_replace("{ASCENDENTE}",     	utf8_encode($promedio_as), $row);
	   	$row = str_replace("{AUTOEVALUACION}", 	utf8_encode($promedio_ae), $row);
	   	$row = str_replace("{PARES}",      			utf8_encode($promedio_mp), $row);
	   	$row = str_replace("{RESULTADO_PONDERADO_COMPETENCIAS}",    utf8_encode($promedio_res), $row);

//LIDERAZGO 
$valor_competencias_en_base_cien=Panel_valor_competencias_en_base_cien($promedio_res);

	   	
	   	$row.= file_get_contents("views/panel_liderazgo/row_vista_colaborador_competencias_total.html");	
	   	$row = str_replace("{NOMBRE_KPI}",     	"Cumplimiento", $row);
	   	$row = str_replace("{PONDERACION}",    	"", $row);
	   	$row = str_replace("{DESCENDENTE}",   	"", $row);
	   	$row = str_replace("{ASCENDENTE}",     	"", $row);
	   	$row = str_replace("{AUTOEVALUACION}", 	"", $row);
	   	$row = str_replace("{PARES}",      			"", $row);
	   	$row = str_replace("{RESULTADO_PONDERADO_COMPETENCIAS}",    utf8_encode($valor_competencias_en_base_cien)."%", $row);
	   	


//echo "<br>lid  $resultado_inicial_LID competencia $valor_competencias_en_base_cien";
$suma_lid		=	round($cumplimiento_liderazgo*20/100,2);
//Suma Competencia
$suma_comp	=	round($valor_competencias_en_base_cien*80/100,2);
$resultado_como	= round($suma_lid+$suma_comp);

if($valor_competencias_en_base_cien==""){
	$resultado_como	= round($cumplimiento_liderazgo);

}


if($cumplimiento_liderazgo>0){
	
}else {
	if($valor_competencias_en_base_cien<>""){
		$resultado_como	= round($valor_competencias_en_base_cien);	
	}
}

//echo "cumplimiento_liderazgo $cumplimiento_liderazgo, $valor_competencias_en_base_cien";
//echo "<br>$suma_total_competencias=$suma_lid+$suma_res";

		//echo "<br>suma_res $suma_res, cuenta_competencias $cuenta_competencias";
		//$resultado_competencia			=		round($suma_res/$cuenta_competencias,2);
		//$resultado_competencia_final	= PanelCompetenciaCriteriosFinal($resultado_competencia);
		//echo "<br>Resultado $resultado_competencia, txt $resultado_competencia_final";
		
		$PRINCIPAL = str_replace("{RESULTADO_COMPETENCIAS}",         $resultado_como,         $PRINCIPAL);
    $PRINCIPAL = str_replace("{PANEL_ROW_COMPETENCIAS}",         $row,         												$PRINCIPAL);
}

	
    $PRINCIPAL             = str_replace("{FOTO_PERSONA}", VerificaFotoPersonal($rut), $PRINCIPAL);
    $datos_usuario         = DatosUsuarioLeftJefeDeTblUsuario($rut);
    //Datos JEfe
    $arreglo_rut_jefe      = explode("-", $datos_usuario[0]->jefe);
    $datos_personales_jefe = DatosUsuarioLeftJefeDeTblUsuario($arreglo_rut_jefe[0]);
    $PRINCIPAL             = str_replace("{NOMBRE}", utf8_encode($datos_usuario[0]->nombre . " " . $datos_usuario[0]->apaterno . " " . $datos_usuario[0]->amaterno), $PRINCIPAL);
    $PRINCIPAL             = str_replace("{CARGO}", utf8_encode($datos_usuario[0]->cargo), $PRINCIPAL);
    $PRINCIPAL             = str_replace("{GERENCIA}", utf8_encode($datos_usuario[0]->gerencia), $PRINCIPAL);
    $PRINCIPAL             = str_replace("{DIVISION}", utf8_encode($datos_usuario[0]->division), $PRINCIPAL);
    $PRINCIPAL             = str_replace("{CORREO}", $datos_usuario[0]->email, $PRINCIPAL);
    $PRINCIPAL             = str_replace("{RUT_ENCODEADO}", Encodear3($rut), $PRINCIPAL);
  


/*  $txt_ae="AE".$pon_ae."%";
  echo "	<br>txt_ae $txt_ae
  				<br>pon_ae $pon_ae";
  $txt_as=$pon_as."%";
  $txt_ds=$pon_ds."%";
  $txt_mp=$pon_mp."%";
  */
  
  //print_r($res_linea_competencia);
  		$pon_ds			=		$res_linea_competencia[1];
			$pon_as			=		$res_linea_competencia[2];
			$pon_mp     =		$res_linea_competencia[3];
			$pon_ae     =		$res_linea_competencia[4];		
  
   
   /* echo "	<br>txt_ae $txt_ae
  				<br>pon_ae $pon_ae";
    */
    
    $ponderadiones_mostrar[1]=$pon_ds;
    $ponderadiones_mostrar[2]=$pon_as;
    $ponderadiones_mostrar[3]=$pon_mp;
    $ponderadiones_mostrar[4]=$pon_ae;
    
    
    $arreglo[0]=$PRINCIPAL;
    $arreglo[1]=$resultado_cuenta_verdes_que;
    $arreglo[2]="";
    $arreglo[3]=$resultado_como;
    $arreglo[4]=$ponderadiones_mostrar;
    
    return ($arreglo);
}



function Potencial_CalculoPorcentaje($cuenta_inmediato,$cuenta_mediano,$cuenta_largo){
		$porcentaje=0;
		if($cuenta_largo>0)					{ $porcentaje=50;}
		if($cuenta_mediano>0)					{ $porcentaje=70;}
		if($cuenta_inmediato>0)					{ $porcentaje=100;}
	
	return $porcentaje;
}
function Potencial_Sucesion_Actualiza_GerentesR2($rut_R1, $id_empresa, $id_comite){
			Potencial_Sucesion_Truncate($id_comite);
			$array_g2=PotencialSucesion_BuscaR2($rut_R1, $id_empresa);
			foreach ($array_g2 as $unico){
					//echo "<br>rut ".$unico->rut;
					Potencial_Sucesion_CheckSave($unico->rut,$unico->d151,$id_comite,$id_empresa);
			}
}


function Potencial_Sucesion_Colaboradores_Comites($PRINCIPAL, $id_comite, $rut, $perfil, $id_empresa)
{
    $lista = Potencial_Sucesion_Colaboradores_Comites_data($id_comite, $rut, $perfil, $id_empresa);
    //print_r($lista);
    
    $num_comites    =   count($lista);
    //echo "<br>num_comites $num_comites<br>";
    if($num_comites>0){
        $potencial_titulo="
					<div class=''>

					</div>";
    }   else   {
        $potencial_titulo="
					<div class=''><br>
					    <div class='col-sm-12 txt_title_pot_hohay'><center>[ No hay cargos a suceder ]</center></div>
					    					<br>
					</div>";
    }
		
		$cuenta_inmediato=0; $cuenta_mediano=0; $cuenta_largo=0;
			
    foreach($lista as $unico) {
        $row_lsita.= file_get_contents("views/potencial/" . $id_empresa . "_potencial_sucesion_row_colaboradores_comites.html");
        $row_lsita = str_replace("{RUT}",           utf8_encode($unico->rut), $row_lsita);
        $Potencial_Mapeado=Potencial_Check_Mapeado($unico->rut);
	        if($Potencial_Mapeado<>""){
	        	$row_lsita = str_replace("{MAPEADO}",           "<span class='badge badge-success' style='font-size: 10px;'><span class='blanco'>Mapeado</span></span>", $row_lsita);
	        } else {
	        	$row_lsita = str_replace("{MAPEADO}",         	"", $row_lsita);
	        }

			$pos_validada=Sucesion_Check_Posicion_validada($unico->cargo_col);
			if($pos_validada>0){
					$pot_sucesion_badge_ok_cerrado="<div class='badge badge-success'><i class='fas fa-check' style='color: #fff;'></i></div>";
				} else {
					$pot_sucesion_badge_ok_cerrado="";
				}
      	$row_lsita = str_replace("{CARGO_SUCEDER_LIDER_CERRADO}",         	$pot_sucesion_badge_ok_cerrado, $row_lsita);



				$modal_row_rutc_col	 = "
				
						<a href='?sw=potencial_ficha_sucesion&id_posicion_enc=".Encodear3($unico->cargo_col)."&id_comite=".Encodear3($id_comite)."&perfil=".Encodear3($perfil)."' class='btn btn-primary'> 
								<span style='color:#fff'> Ver Matriz de Sucesi&oacute;n </span>
						</a>
						
						<!--<button type='button' class='btn btn-primary' data-toggle='modal' data-target='#exampleModal_".$unico->rut."'>
  								Vista Sucesión
						</button>				-->
				";
				
				
				
$sucesores_cuadrantes_2_3_6=0;
$sucesores_cuadrantes_1_9_4_8_7=0;
$cuenta_femenino=0;
$cuenta_total=0;				
				//
				$row_inmediato="";
				$row_lsita1="";
				$cuenta_inmediato="";
				$Inmediato=PotencialSucesion_Vista_Colaboradores_Posicion($id_comite, $unico->rut, $id_empresa, "Inmediato", $unico->cargo_col);
				
				foreach ($Inmediato as $uni1){

			        if($uni1->estado=="No es sucesor"){continue;}
					
							$cuenta_inmediato++;
			        $row_lsita1.= file_get_contents("views/potencial/" . $id_empresa . "_potencial_sucesion_row_colaboradores_comites_sucesion.html");
			        $row_lsita1 = str_replace("{AVATAR_RUT_SUCESORES}",   				VerificaFotoPersonal($uni1->rut_col), $row_lsita1);
							
							$Usua1=DatosUsuario_($uni1->rut_col, $id_empresa);
			        $row_lsita1 = str_replace("{COLABORADOR_SUCESORES}",     utf8_encode($Usua1[0]->nombre_completo), $row_lsita1);
			        $row_lsita1 = str_replace("{CARGO_SUCESORES}",           utf8_encode($Usua1[0]->cargo), $row_lsita1);
			        $row_lsita1 = str_replace("{TEMPORALIDAD}",           	"Inmediato / Hoy", $row_lsita1);

			        $cuadrante1=Potencial_Mi_Cuadrante_Actual($uni1->rut_col);
			        //echo "<br>cuadrante1<br>";print_r($cuadrante1);
			        
			        $genero1=Potencial_Genero($uni1->rut_col);
			        
			        if($cuadrante1=="2" or $cuadrante1=="3" or $cuadrante1=="6")	{$sucesores_cuadrantes_2_3_6++;}
			        if($cuadrante1=="1" or $cuadrante1=="9" or $cuadrante1=="4" or $cuadrante1=="8" or $cuadrante1=="7")	{$sucesores_cuadrantes_1_9_4_8_7++;}
			        if($genero1=="Femenino")																			{$cuenta_femenino++;}        
			        $cuenta_total++;
			        $row_lsita1 = str_replace("{RUT}",           utf8_encode($uni1->rut_col), $row_lsita1);
			        $row_lsita1 = str_replace("{COLABORADOR}",   	utf8_encode($uni1->nombre_completo), $row_lsita1);
			        $row_lsita1 = str_replace("{CARGO_COL}",   		utf8_encode($uni1->cargo_col), $row_lsita1);					
			        $row_lsita1 = str_replace("{BOTON_VER_FICHA}","<a href='?sw=potencial_ficha&rut_col=".Encodear3($uni1->rut)."&id_comite=".Encodear3($id_comite)."' class='btn btn-link' >
			        <span class='azul_comite'><i class='fas fa-user'></i> <span class='mt-comment-authorSM'> Ficha</span></span></a>", $row_lsita1);
						  $row_lsita1 = str_replace("{BOTON_VER_FICHA_A_inicial}","<a href='?sw=potencial_ficha&rut_col=".Encodear3($uni1->rut_col)."&id_comite=".Encodear3($id_comite)."'
						   class='btn btn-link' style='padding-left: 0px;    padding-left: 0px;text-align: left;padding-right: 0px;padding: 0px;'>", $row_lsita1);
						  $row_lsita1 = str_replace("{BOTON_VER_FICHA_B_final}","</a>", $row_lsita1);					
				}
				
				$row_mediano="";
				$row_lsita2="";
				$cuenta_mediano="";
				$Mediano=PotencialSucesion_Vista_Colaboradores_Posicion($id_comite, 	$unico->rut, $id_empresa, "Mediano", $unico->cargo_col);
				
		//$Largo=PotencialSucesion_Vista_Colaboradores_Posicion($id_comite, 		$unico->rut, $id_empresa, "Largo", $unico->cargo_col);
				foreach ($Mediano as $uni2){
							$cuenta_mediano++;
							
			        if($uni2->estado=="No es sucesor"){continue;}
							
			        $row_lsita2.= file_get_contents("views/potencial/" . $id_empresa . "_potencial_sucesion_row_colaboradores_comites_sucesion.html");
			        $row_lsita2 = str_replace("{RUT}",           utf8_encode($uni3->rut_col), $row_lsita2);
			        $row_lsita2 = str_replace("{COLABORADOR}",   	utf8_encode($uni3->nombre_completo), $row_lsita2);
				
		        $row_lsita2 = str_replace("{CARGO_COL}",   		utf8_encode($uni2->cargo_col), $row_lsita2);				
			        $row_lsita2 = str_replace("{TEMPORALIDAD}",           	"Mediano / 1 a 2 a&ntilde;os", $row_lsita2);
			        $row_lsita2 = str_replace("{AVATAR_RUT_SUCESORES}",   				VerificaFotoPersonal($uni2->rut_col), $row_lsita2);
							$cuenta_total++;
			        
			        
							$Usua2=DatosUsuario_($uni2->rut_col, $id_empresa);
			        $row_lsita2 = str_replace("{COLABORADOR_SUCESORES}",     utf8_encode($Usua2[0]->nombre_completo), $row_lsita2);
			        $row_lsita2 = str_replace("{CARGO_SUCESORES}",           utf8_encode($Usua2[0]->cargo), $row_lsita2);

			        $cuadrante2=Potencial_Mi_Cuadrante_Actual($uni2->rut_col);
			        //echo "<br>cuadrante2<br>"; print_r($cuadrante2);
			        
			        $genero2=Potencial_Genero($uni2->rut_col);

			        if($cuadrante2=="2" or $cuadrante2=="3" or $cuadrante2=="6")	{$sucesores_cuadrantes_2_3_6++;}
			        if($cuadrante2=="1" or $cuadrante2=="9" or $cuadrante2=="4" or $cuadrante2=="8" or $cuadrante2=="7")	{$sucesores_cuadrantes_1_9_4_8_7++;}
			        if($genero2=="Femenino")																			{$cuenta_femenino++;}        
		        	
			        $row_lsita2 = str_replace("{BOTON_VER_FICHA}","<a href='?sw=potencial_ficha&rut_col=".Encodear3($uni2->rut)."&id_comite=".Encodear3($id_comite)."' class='btn btn-link' >			        <span class='azul_comite'><i class='fas fa-user'></i> <span class='mt-comment-authorSM'> Ficha</span></span></a>", $row_lsita2);						  
			        $row_lsita2 = str_replace("{BOTON_VER_FICHA_A_inicial}","<a href='?sw=potencial_ficha&rut_col=".Encodear3($uni2->rut_col)."&id_comite=".Encodear3($id_comite)."'
						   class='btn btn-link' style='padding-left: 0px;    padding-left: 0px;text-align: left;padding-right: 0px; padding: 0px;'>", $row_lsita2);
						  $row_lsita2 = str_replace("{BOTON_VER_FICHA_B_final}","</a>", $row_lsita2);									}
				
				$row_largo="";
				$row_lsita3="";
				$cuenta_largo="";
				$Largo=PotencialSucesion_Vista_Colaboradores_Posicion($id_comite, 		$unico->rut, $id_empresa, "Largo", $unico->cargo_col);
				foreach ($Largo as $uni3){
							$cuenta_largo++;
							
			        if($uni3->estado=="No es sucesor"){continue;}
							
			        $row_lsita3.= file_get_contents("views/potencial/" . $id_empresa . "_potencial_sucesion_row_colaboradores_comites_sucesion.html");
			        $row_lsita3 = str_replace("{RUT}",           utf8_encode($uni3->rut_col), $row_lsita3);
			        $row_lsita3 = str_replace("{COLABORADOR}",   	utf8_encode($uni3->nombre_completo), $row_lsita3);
			        $row_lsita3 = str_replace("{CARGO_COL}",   		utf8_encode($uni3->cargo_col), $row_lsita3);			
			        $row_lsita3 = str_replace("{TEMPORALIDAD}",           	"Largo  / 3 a 5 a&ntilde;os", $row_lsita3);
			        $row_lsita3 = str_replace("{AVATAR_RUT_SUCESORES}",   				VerificaFotoPersonal($uni3->rut_col), $row_lsita3);
			        
							$Usua3=DatosUsuario_($uni3->rut_col, $id_empresa);
			        $row_lsita3 = str_replace("{COLABORADOR_SUCESORES}",     utf8_encode($Usua3[0]->nombre_completo), $row_lsita3);
			        $row_lsita3 = str_replace("{CARGO_SUCESORES}",           utf8_encode($Usua3[0]->cargo), $row_lsita3);
			        
				      $cuadrante3=Potencial_Mi_Cuadrante_Actual($uni3->rut_col);
				      //echo "<br>cuadrante3<br>";print_r($cuadrante3);
			        $genero3=Potencial_Genero($uni3->rut_col);
			        //echo "<br>cuadrante3 $cuadrante3, genero3 $genero3";		
			        
			        if($cuadrante3=="2" or $cuadrante3=="3" or $cuadrante3=="6")	{$sucesores_cuadrantes_2_3_6++;}
			        if($cuadrante3=="1" or $cuadrante3=="9" or $cuadrante3=="4" or $cuadrante3=="8" or $cuadrante3=="7")	{$sucesores_cuadrantes_1_9_4_8_7++;}
			        if($genero3=="Femenino")																			{$cuenta_femenino++;}        
			        $cuenta_total++;
			        		
			        $row_lsita3 = str_replace("{BOTON_VER_FICHA}","<a href='?sw=potencial_ficha&rut_col=".Encodear3($uni3->rut)."&id_comite=".Encodear3($id_comite)."' class='btn btn-link'>
			        <span class='azul_comite'><i class='fas fa-user'></i> <span class='mt-comment-authorSM'> Ficha</span></span></a>", $row_lsita3);
						  $row_lsita3 = str_replace("{BOTON_VER_FICHA_A_inicial}","<a href='?sw=potencial_ficha&rut_col=".Encodear3($uni3->rut_col)."&id_comite=".Encodear3($id_comite)."'
						   class='btn btn-link' style='padding-left: 0px;    padding-left: 0px;text-align: left;padding: 0px;'>", $row_lsita3);
						  $row_lsita3 = str_replace("{BOTON_VER_FICHA_B_final}","</a>", $row_lsita3);									
						  


						  
						}


					//echo "<br>Femenino $cuenta_femenino , sucesores_cuadrantes_2_3_6 $sucesores_cuadrantes_2_3_6, sucesores_cuadrantes_1_9_4_8_7 $sucesores_cuadrantes_1_9_4_8_7";
					//echo "<BR> <BR>cARGO $cuenta_inmediato, $cuenta_mediano, $cuenta_largo";
					$Porcentaje_Cargo	=	Potencial_CalculoPorcentaje($cuenta_inmediato,$cuenta_mediano,$cuenta_largo);
					$cuenta_porcentaje_cargo++;
					$suma_porcentaje_cargo		= $suma_porcentaje_cargo + $Porcentaje_Cargo	;
					//echo "<BR> <BR>PORCENTAJE  Porcentaje_Cargo $Porcentaje_Cargo";
					
        $row_lsita = str_replace("{INMEDIATO}", utf8_encode($row_lsita1), $row_lsita);
        $row_lsita = str_replace("{MEDIANO}",   utf8_encode($row_lsita2), $row_lsita);
        $row_lsita = str_replace("{LARGO}",   	utf8_encode($row_lsita3), $row_lsita);

$cuenta_masculino=$cuenta_total-$cuenta_femenino;
//echo "<br> 236 $sucesores_cuadrantes_2_3_6 19478 $sucesores_cuadrantes_1_9_4_8_7 FEM $cuenta_femenino MASC $cuenta_masculino";

$porc_2_3_6=round(100*$sucesores_cuadrantes_2_3_6/$cuenta_total);
$porc_1_9_4_8_6=round(100*$sucesores_cuadrantes_1_9_4_8_7/$cuenta_total);
$porc_fem=round(100*$cuenta_femenino/$cuenta_total);
$porc_mas=round(100*$cuenta_masculino/$cuenta_total);



        $row_lsita = str_replace("{Porcentaje_Cargo}",  						"<small>Cargo: </small><div class='badge badge-info'>			<span style='color:#fff'>".utf8_encode($Porcentaje_Cargo)."%</span></div>", $row_lsita);
        $row_lsita = str_replace("{Sucesores_Cuadrantes_236}",  		"<small>Sucesores en Cuadrantes 2-3-6: </small><div class='badge badge-info'>			<span style='color:#fff'>".$porc_2_3_6."%</span></div>", $row_lsita);
        $row_lsita = str_replace("{Sucesores_Cuadrantes_19487}",  	"<small>Sucesores en Cuadrantes 1-9-4-8-7: </small><div class='badge badge-info'>			<span style='color:#fff'>".$porc_1_9_4_8_6."%</span></div>", $row_lsita);
        $row_lsita = str_replace("{Sucesores_Mujeres}",  						"<small>Sucesores Mujeres: </small><div class='badge badge-info'>			<span style='color:#fff'>".utf8_encode($porc_fem)."%</span></div>", $row_lsita);
        $row_lsita = str_replace("{Sucesores_Hombre}",  						"<small>Sucesores Hombres: </small><div class='badge badge-info'>			<span style='color:#fff'>".utf8_encode($porc_mas)."%</span></div>", $row_lsita);
   
				//if($cuenta_mediano>0){ $titulo_inmediato="<div class='txt_title_pot'>Inmediato</div>"; } else { $titulo_inmediato=""; }
				//if($cuenta_mediano>0){ $titulo_mediano="<div class='txt_title_pot'>Mediano</div>"; } else { $titulo_mediano=""; }
				//if($cuenta_mediano>0){ $titulo_largo="<div class='txt_title_pot'>Largo</div>"; } else { $titulo_largo=""; }


        $row_lsita = str_replace("{LARGO}",   	utf8_encode($row_lsita3), $row_lsita);



        $row_lsita = str_replace("{TITULO_INMEDIATO}", 	$titulo_inmediato, $row_lsita);
        $row_lsita = str_replace("{TITULO_MEDIANO}",   	$titulo_mediano, $row_lsita);
        $row_lsita = str_replace("{TITULO_LARGO}",   		$titulo_largo, $row_lsita);

				
        $row_lsita = str_replace("{COLABORADOR}",   	utf8_encode($unico->nombre_completo), $row_lsita);
        $row_lsita = str_replace("{CARGO_COL}",   		utf8_encode($unico->cargo_col), $row_lsita);
        $row_lsita = str_replace("{NOMBRE_LIDER}",  	utf8_encode($unico->nombre_lider), $row_lsita);
        $row_lsita = str_replace("{AVATAR}",   				VerificaFotoPersonal($unico->rut), $row_lsita);
        $row_lsita = str_replace("{BOTON_MODAL}",  	utf8_encode($modal_row_rutc_col), $row_lsita);

        $row_lsita = str_replace("{BOTON_VER_FICHA}",							"<a href='?sw=potencial_ficha_sucesion&id_posicion_enc=".Encodear3($unico->cargo_col)."&id_comite=".Encodear3($id_comite)."' class='btn btn-link' >
        <span class='azul_comite'><i class='fas fa-user'></i> <span class='mt-comment-authorSM'> Ficha</span></span></a>", $row_lsita);

			  $row_lsita = str_replace("{BOTON_VER_FICHA_A_inicial}",	"<a href='?sw=potencial_ficha_sucesion&id_posicion_enc=".Encodear3($unico->cargo_col)."&id_comite=".Encodear3($id_comite)."'
			   class='btn btn-link' style='padding-left: 0px;    padding-left: 0px;text-align: left;padding-right: 0px;'>", $row_lsita);

			  $row_lsita = str_replace("{BOTON_VER_FICHA_B_final}","</a>", $row_lsita);
        
        
        	$SUMA_sucesores_cuadrantes_2_3_6=	$sucesores_cuadrantes_2_3_6 + $SUMA_sucesores_cuadrantes_2_3_6;
        	$SUMA_sucesores_cuadrantes_1_9_4_8_7=	$sucesores_cuadrantes_1_9_4_8_7 + $SUMA_sucesores_cuadrantes_1_9_4_8_7;
        	$SUMA_cuenta_femenino		=	$cuenta_femenino + $SUMA_cuenta_femenino;
        	$SUMA_cuenta_masculino	=	$cuenta_masculino + $SUMA_cuenta_masculino;
        	$SUMA_cuenta_total			=	$cuenta_total + $SUMA_cuenta_total;

        
		}
		

    
    $PRINCIPAL = str_replace("{MIS_COLABORADORES_COMITES_POTENCIAL}",         $row_lsita,         $PRINCIPAL);
    $PRINCIPAL = str_replace("{COLABORADORES_COMITE_POTENCIAL_TITULO}",  $potencial_titulo,  $PRINCIPAL);
    $PRINCIPAL = str_replace("{PORCENTAJE_AREA_PONDERADO}", "Área Total: <div class='badge badge-info'>			<span style='color:#fff'>".round($suma_porcentaje_cargo/$cuenta_porcentaje_cargo)."%</span></div>",  $PRINCIPAL);


$porc_total_2_3_6=round(100*$SUMA_sucesores_cuadrantes_2_3_6/$SUMA_cuenta_total);
$porc_total_1_9_4_8_6=round(100*$SUMA_sucesores_cuadrantes_1_9_4_8_7/$SUMA_cuenta_total);
$porc_total_fem=round(100*$SUMA_cuenta_femenino/$SUMA_cuenta_total);
$porc_total_mas=round(100*$SUMA_cuenta_masculino/$SUMA_cuenta_total);


    $PRINCIPAL = str_replace("{MASCULINO_PONDERADO}", "Sucesores Hombres: <div class='badge badge-info'>			<span style='color:#fff'>".($porc_total_mas)."%</span></div>",  $PRINCIPAL);
    $PRINCIPAL = str_replace("{FEMENINO_PONDERADO}", 	"Sucesores Mujeres: <div class='badge badge-info'>			<span style='color:#fff'>".($porc_total_fem)."%</span></div>",  $PRINCIPAL);

    $PRINCIPAL = str_replace("{CUADRANTE_236}", 			"Sucesores en Cuadrantes 2-3-6: <div class='badge badge-info'>			<span style='color:#fff'>".($porc_total_2_3_6)."%</span></div>",  $PRINCIPAL);
    $PRINCIPAL = str_replace("{CUADRANTE_19487}", 		"Sucesores en Cuadrantes 1-9-4-8-7: <div class='badge badge-info'>			<span style='color:#fff'>".($porc_total_1_9_4_8_6)."%</span></div>",  $PRINCIPAL);



    return ($PRINCIPAL);
}


function Potencial_Sucesion_Colaboradores_Comites_Ficha($PRINCIPAL, $id_comite, $rut, $perfil, $posicion, $id_empresa)
{
							$MiRx=MiRx($_SESSION["user_"]);
							//echo "potencial_ficha_sucesion mi Rx $MiRx";
						
						  if($perfil=="LIDER"){
						  	$display_acciones_desarrollo = " display:none; ";
						  } else {
						  	$display_acciones_desarrollo = "  ";
						  }
							
							
							$array_comite=Potencial_Comites_Suc_data($id_comite,$id_empresa);
							//print_r($array_comite);
							
							$comite_cerrado_esta=$array_comite[0]->comite_cerrado;
							
							
							//todo0s agregan acciones desarrollo
							$display_acciones_desarrollo = "  ";
//Rx $MiRx";
						
						  if($perfil=="LIDER"){
						  	$display_acciones_desarrollo = " display:none; ";
						  } else {
						  	$display_acciones_desarrollo = "  ";
						  }
							
							
							$array_comite=Potencial_Comites_Suc_data($id_comite,$id_empresa);
							//print_r($array_comite);
							
							$comite_cerrado_esta=$array_comite[0]->comite_cerrado;
							
							
							//todo0s agregan acciones desarrollo
							$display_acciones_desarrollo = "  ";
			$row_inmediato="";
				$row_lsita1="";
				$Inmediato=PotencialSucesion_Vista_Colaboradores_Posicion($id_comite, $unico->rut, $id_empresa, "Inmediato", $posicion);
				//print_r($Inmediato);
				foreach ($Inmediato as $uni1){



							if($comite_cerrado_esta=="SI" and $uni1->estado=="No es sucesor"){
								continue;
							}

			        $row_lsita1.= file_get_contents("views/potencial/" . $id_empresa . "_potencial_sucesion_row_colaboradores_comites_sucesion_avatar.html");
			        $row_lsita1 = str_replace("{AVATAR_RUT_SUCESORES}",   				VerificaFotoPersonal($uni1->rut_col), $row_lsita1);
							$RxCol=MiRx($uni1->rut_col);
							$visualiza1=CheckVisualizaMiRxRxCol($MiRx, $RxCol);
							
							//echo "<br>->".$uni1->rut_col." R ".$RxCol." - Visualiza ".$visualiza;
							$Usua1=DatosUsuario_($uni1->rut_col, $id_empresa);
							$es_posicion_clave=Pot_CheckPosicion_Clave($uni1->rut_col);
											if($es_posicion_clave>0){
													$posicion_clave	=" 
																
																	<div class='badge badge-gray' style='    background-color: transparent !important;padding-left: 0px!important;'>
																		<center>
																			<strong>Posici&oacute;n Clave</strong>
																		</center>
																	</div><br>
															";
													} else {
													$posicion_clave="";	
													}
							$row_lsita1 = str_replace("{POSICION_CLAVE}", 			$posicion_clave, $row_lsita1);

							
							//$Cuad_2020=Potencial_Check_Mapeado_oAnterior($uni1->rut_col);
							$Cuad_2020=Potencial_Mi_Cuadrante_Actual($uni1->rut_col);
							
							$Num_Sucesion=Potencial_Sucesion_Num_Sucesores($uni1->rut_col);
							if($Cuad_2020<>""){
								if($Cuad_2020=="10"){$Cuad_2020="5+";}
								$cuadrante_2020="Cuadrante Actual: $Cuad_2020";
							} else {
								$cuadrante_2020="Sin cuadrante actual";
							}
							if($Num_Sucesion>0){
								$num_sucesion_2020="Veces como sucesor: $Num_Sucesion";
							} else {
								$num_sucesion_2020="1 vez como sucesor";
							}							
							
							
							
							
							$Usua=DatosUsuario_($uni1->rut_col, $id_empresa);
							if($Usua[0]->gerencia=="GERENCIA CORPORATIVA GESTION PERSONAS"){
								$cuadrante_2020="";
							}
							
							
							if($visualiza1=="NO"){$num_sucesion_2020="";}
							if($visualiza1=="NO"){$cuadrante_2020="";}
							
														
			        $row_lsita1 = str_replace("{CARGO_CUDRANTE_SUCESORES}",   $cuadrante_2020, $row_lsita1);
			        $row_lsita1 = str_replace("{CARGO_VECES_SUCESOR}",     		$num_sucesion_2020, $row_lsita1);
							$estado_badge_avatar="";
							if($uni1->estado=="No es sucesor"){
								if($uni1->rutlider==""){
									$estado_badge_avatar="<span class='badge badge-danger' style='color:#fff'>No es Sucesor</span>";
								} else {
								$estado_badge_avatar="<span class='badge badge-danger' style='color:#fff'>No es Sucesor</span> <span style='font-size: 12px;display:none;'>Sugerido por L&iacute;der</span>";	
								}
							}
							
				
							
							if($uni1->estado=="Es Sucesor"){
								if($uni1->rutlider==""){
									$estado_badge_avatar="<span class='badge badge-info' style='color:#fff'>Es Sucesor</span> - <span style='font-size: 12px;'>Propuesta de Sucesi&oacute;n</span>";
								} else {
								$estado_badge_avatar="<span class='badge badge-info' style='color:#fff'>Es Sucesor</span> <span style='font-size: 12px;display:none;'>Sugerido por L&iacute;der</span>";	
								}
							}		
							
					if($comite_cerrado_esta=="SI" and $uni1->estado=="Es Sucesor"){
						$estado_badge_avatar="";
					}
												
							
			        $row_lsita1 = str_replace("{NO_ES_SUCESOR_ESTADO_BADGE}",     		$estado_badge_avatar, $row_lsita1);

							
			        $row_lsita1 = str_replace("{COLABORADOR_SUCESORES}",     utf8_encode($Usua1[0]->nombre_completo), $row_lsita1);
			        $posicion1=Potencial_Sucesion_d145_databci($uni1->rut_col);

			        $row_lsita1 = str_replace("{CARGO_SUCESORES}",           utf8_encode($posicion1), $row_lsita1);
			        $row_lsita1 = str_replace("{RUT_SUCESORES}",           	 utf8_encode($uni1->rut_col), $row_lsita1);
			        $row_lsita1 = str_replace("{RUT_SUCESORES_ENC}",         Encodear3($uni1->rut_col), $row_lsita1);
			        $row_lsita1 = str_replace("{ID_SUCESORES}",           	 Encodear3($uni1->id), $row_lsita1);
			        $row_lsita1 = str_replace("{ID_POSICION_ENC}",           Encodear3($posicion), $row_lsita1);
			        $row_lsita1 = str_replace("{ID_COMITE_ENC}",           	 Encodear3($id_comite), $row_lsita1);
			        $row_lsita1 = str_replace("{ID_COL}",           				 Encodear3($uni1->id), $row_lsita1);
			        $row_lsita1 = str_replace("{PERFIL_ENC}",           		Encodear3($perfil), $row_lsita1);

			        $row_lsita1 = str_replace("{ACTUAL_TEMPORALIDAD}",      "Inmediato", $row_lsita1);
							
							$sucesion_display_none="";
							if($visualiza1=="NO"){$sucesion_display_none=" display:none; ";}
			        $row_lsita1 = str_replace("{sucesion_display_none}",      $sucesion_display_none, $row_lsita1);
			        
			        $row_lsita1 = str_replace("{RUT}",           utf8_encode($uni1->rut), $row_lsita1);
			        $row_lsita1 = str_replace("{COLABORADOR}",   	utf8_encode($uni1->nombre_completo), $row_lsita1);
			        $row_lsita1 = str_replace("{CARGO_COL}",   		utf8_encode($uni1->cargo_col), $row_lsita1);		
			        
			        
			  if($visualiza1=="NO"){
			        $row_lsita1 = str_replace("{BOTON_VER_FICHA}","", $row_lsita1);
						  $row_lsita1 = str_replace("{BOTON_VER_FICHA_A_inicial}","", $row_lsita1);
						  $row_lsita1 = str_replace("{BOTON_VER_FICHA_B_final}","", $row_lsita1);			
			  } else {
			        $row_lsita1 = str_replace("{BOTON_VER_FICHA}","<a href='?sw=potencial_fichaxxx&rut_col=".Encodear3($uni1->rut_col)."&id_comite=".Encodear3($id_comite)."&sucesion=1&sucesion=1&sucesion=1&id_posicion_enc=".Encodear3($posicion)."' class='btn btn-link' >
			        <span class='azul_comite'><i class='fas fa-user'></i> <span class='mt-comment-authorSM'> Ficha</span></span></a>", $row_lsita1);
						  $row_lsita1 = str_replace("{BOTON_VER_FICHA_A_inicial}","<a href='?sw=potencial_ficha&rut_col=".Encodear3($uni1->rut_col)."&id_comite=".Encodear3($id_comite)."&sucesion=1&sucesion=1&id_posicion_enc=".Encodear3($posicion)."'
						   class='btn btn-link' style='padding-left: 0px;    padding-left: 0px;text-align: left;padding-right: 0px;'>", $row_lsita1);
						  $row_lsita1 = str_replace("{BOTON_VER_FICHA_B_final}","</a>", $row_lsita1);			
			  }
			        			
	
						
						  $row_lsita1 = str_replace("{STYLO_AGREGAR_ACCIONES_DESARROLLO}", $display_acciones_desarrollo, $row_lsita1);		
						  
						  $row_lista1_acciones="";
						  $Potencial_Acciones_Desarrollo	=	Potencial_Busca_Acciones_Desarrollo($uni1->rut_col);
						  if(count($Potencial_Acciones_Desarrollo)>0){
						  	foreach ($Potencial_Acciones_Desarrollo as $un1){
						  		$row_lista1_acciones.=" 
						  		
						  		<i class='far fa-file-alt'></i> 
						  				".$un1->plan."
						  				<span class='pull-right'><a href='?sw=potencial_ficha_sucesion&id_posicion_enc=".Encodear3($posicion)."&id_comite=".Encodear3($id_comite)."&perfil=".Encodear3($perfil)."&delad=".Encodear3($un1->id)."'><i class='far fa-trash-alt' style='color: #337ab7;'></i></a></span>
						  		<br>
						  		<i class='fas fa-chevron-right' style='padding-left: 20px;'></i> 
						  				".$un1->fundamento."
						  	<br>";
						  	}
						  		$row_lsita1 = str_replace("{ACCIONES_DE_DESARROLLO_TITULO1}", "<div class='txt_2020' data-toggle='collapse' href='#collapseExample2_".$uni1->rut_col."' role='button' aria-expanded='false' aria-controls='collapseExample2'>Acciones de Desarrollo</div>", $row_lsita1);		
						  		$row_lsita1 = str_replace("{ACCIONES_DE_DESARROLLO}", $row_lista1_acciones, $row_lsita1);		
						  } else {
						  		$row_lsita1 = str_replace("{ACCIONES_DE_DESARROLLO}", "", $row_lsita1);		
						  		$row_lsita1 = str_replace("{ACCIONES_DE_DESARROLLO_TITULO1}", "", $row_lsita1);		
						  	
						  }


						  $Potencial_Bitacora_Desarrollo	=	Potencial_Busca_Bitacora_Desarrollo($uni1->rut_col);
						  $row_lista1_bitacora="";
						  if(count($Potencial_Bitacora_Desarrollo)>0){
						  	foreach ($Potencial_Bitacora_Desarrollo as $un1){
						  		$row_lista1_bitacora.=" 
						  		
						  		".$un1->comite." - Sucesi&oacute;n - ".$un1->fecha." 
						  				 <br> ".$un1->nombre_completo." <br>  ".$un1->accion." ".$un1->comentario."
						  				<!--<span class='pull-right'><a href='?sw=potencial_ficha_sucesion&id_posicion_enc=".Encodear3($posicion)."&id_comite=".Encodear3($id_comite)."&perfil=".Encodear3($perfil)."&delad=".Encodear3($un1->id)."'><i class='far fa-trash-alt' style='color: #337ab7;'></i></a></span>-->
						  	<br><br>";
						  	}
						  		$row_lsita1 = str_replace("{BITACORA_DE_DESARROLLO_TITULO1}", "<div class='txt_2020' data-toggle='collapse' href='#collapseExample1_".$uni1->rut_col."' role='button' aria-expanded='false' aria-controls='collapseExample'>Bit&aacute;cora de Sucesi&oacute;n</div>", $row_lsita1);		
						  		$row_lsita1 = str_replace("{BITACORA_DE_DESARROLLO}", $row_lista1_bitacora, $row_lsita1);		
						  } else {
						  		$row_lsita1 = str_replace("{BITACORA_DE_DESARROLLO_TITULO1}", "", $row_lsita1);		
						  		$row_lsita1 = str_replace("{BITACORA_DE_DESARROLLO}", "", $row_lsita1);		
						  	
						  }
						  		
				}
				
				$row_mediano="";
				$row_lsita2="";
				$Mediano=PotencialSucesion_Vista_Colaboradores_Posicion($id_comite, $unico->rut, $id_empresa, "Mediano", $posicion);
				//echo "mediano";
				//print_r($Mediano);
				foreach ($Mediano as $uni2){

							if($comite_cerrado_esta=="SI" and $uni2->estado=="No es sucesor"){
								continue;
							}
					
			        $row_lsita2.= file_get_contents("views/potencial/" . $id_empresa . "_potencial_sucesion_row_colaboradores_comites_sucesion_avatar.html");
			        $row_lsita2 = str_replace("{RUT}",           utf8_encode($uni2->rut), $row_lsita2);
			        
							$RxCol=MiRx($uni2->rut_col);
							$visualiza2=CheckVisualizaMiRxRxCol($MiRx,	$RxCol);			
							        
			        $row_lsita2 = str_replace("{COLABORADOR}",   	utf8_encode($uni2->nombre_completo), $row_lsita2);
			        $row_lsita2 = str_replace("{CARGO_COL}",   		utf8_encode($uni2->cargo_col), $row_lsita2);				

			        $row_lsita2 = str_replace("{AVATAR_RUT_SUCESORES}",   				VerificaFotoPersonal($uni2->rut_col), $row_lsita2);
			        $row_lsita2 = str_replace("{RUT_SUCESORES}",           utf8_encode($uni2->rut_col), $row_lsita2);
			        $row_lsita2 = str_replace("{RUT_SUCESORES_ENC}",           Encodear3($uni2->rut_col), $row_lsita2);
			        
			        $row_lsita2 = str_replace("{ID_POSICION_ENC}",           	Encodear3($posicion), $row_lsita2);
			        $row_lsita2 = str_replace("{ID_COMITE_ENC}",           		Encodear3($id_comite), $row_lsita2);
			        $row_lsita2 = str_replace("{ID_COL}",           					Encodear3($uni2->id), $row_lsita2);
			        $row_lsita2 = str_replace("{PERFIL_ENC}",           		Encodear3($perfil), $row_lsita2);
							$Usua2=DatosUsuario_($uni2->rut_col, $id_empresa);
							
							$es_posicion_clave=Pot_CheckPosicion_Clave($uni2->rut_col);
											if($es_posicion_clave>0){
													$posicion_clave	=" 
																
																	<div class='badge badge-gray'  style='    background-color: transparent !important;padding-left: 0px!important;'>
																		
																			<strong>Posici&oacute;n Clave</strong>
																	
																	</div><br>
															";
													} else {
													$posicion_clave="";	
													}
							$row_lsita2 = str_replace("{POSICION_CLAVE}", 			$posicion_clave, $row_lsita2);							
							
			        $row_lsita2 = str_replace("{COLABORADOR_SUCESORES}",     utf8_encode($Usua2[0]->nombre_completo), $row_lsita2);
 							$posicion2=Potencial_Sucesion_d145_databci($uni2->rut_col);

			        $row_lsita2 = str_replace("{CARGO_SUCESORES}",           utf8_encode($posicion2), $row_lsita2);
			        $row_lsita2 = str_replace("{ID_SUCESORES}",           		Encodear3($uni2->id), $row_lsita2);
						  $row_lsita2 = str_replace("{STYLO_AGREGAR_ACCIONES_DESARROLLO}", $display_acciones_desarrollo, $row_lsita2);				

			        $row_lsita2 = str_replace("{ACTUAL_TEMPORALIDAD}",      "Mediano", $row_lsita2);

							$sucesion_display_none="";
							if($visualiza2=="NO"){$sucesion_display_none=" display:none; ";}
			        $row_lsita2 = str_replace("{sucesion_display_none}",      $sucesion_display_none, $row_lsita2);
							//$Cuad_2020=Potencial_Check_Mapeado_oAnterior($uni2->rut_col);
							$Cuad_2020=Potencial_Mi_Cuadrante_Actual($uni2->rut_col);							
							$Num_Sucesion=Potencial_Sucesion_Num_Sucesores($uni2->rut_col);
							if($Cuad_2020<>""){
								if($Cuad_2020=="10"){$Cuad_2020="5+";}
								$cuadrante_2020="Cuadrante Actual: $Cuad_2020";
							} else {
								$cuadrante_2020="Sin cuadrante actual";
							}
							if($Num_Sucesion>0){
								$num_sucesion_2020="Veces como sucesor: $Num_Sucesion";
							} else {
								$num_sucesion_2020="1 vez como sucesor";
							}				
							
							$Usua=DatosUsuario_($uni2->rut_col, $id_empresa);
							if($Usua[0]->gerencia=="GERENCIA CORPORATIVA GESTION PERSONAS"){
								$cuadrante_2020="";
							}		
							
							if($visualiza2=="NO"){$num_sucesion_2020="";}
							if($visualiza2=="NO"){$cuadrante_2020="";}					
										
							$estado_badge_avatar2="";
			        $row_lsita2 = str_replace("{CARGO_CUDRANTE_SUCESORES}",   $cuadrante_2020, $row_lsita2);
			        $row_lsita2 = str_replace("{CARGO_VECES_SUCESOR}",     		$num_sucesion_2020, $row_lsita2);
							if($uni2->estado=="No es sucesor"){
								if($uni2->rutlider==""){
									$estado_badge_avatar2="<span class='badge badge-danger' style='color:#fff'>No es Sucesor</span>";
								} else {
								$estado_badge_avatar2="<span class='badge badge-danger' style='color:#fff'>No es Sucesor</span> <span style='font-size: 12px;display:none;'>Sugerido por L&iacute;der</span>";	
								}
							}
							if($uni2->estado=="Es Sucesor"){
								if($uni2->rutlider==""){
									$estado_badge_avatar2="<span class='badge badge-info' style='color:#fff'>Es Sucesor</span> - <span style='font-size: 12px;'>Propuesta de Sucesi&oacute;n</span>";
								} else {
								$estado_badge_avatar2="<span class='badge badge-info' style='color:#fff'>Es Sucesor</span>  <span style='font-size: 12px; display:none;'>Sugerido por L&iacute;der</span>";	
								}
							}								

					if($comite_cerrado_esta=="SI" and $uni3->estado=="Es Sucesor"){
						$estado_badge_avatar2="";
					}							
			        $row_lsita2 = str_replace("{NO_ES_SUCESOR_ESTADO_BADGE}",     		$estado_badge_avatar2, $row_lsita2);


			  if($visualiza2=="NO"){
			        $row_lsita2 = str_replace("{BOTON_VER_FICHA}","", $row_lsita2);
						  $row_lsita2 = str_replace("{BOTON_VER_FICHA_A_inicial}","", $row_lsita2);
						  $row_lsita2 = str_replace("{BOTON_VER_FICHA_B_final}","", $row_lsita2);			
			  } else {
			        $row_lsita2 = str_replace("{BOTON_VER_FICHA}","<a href='?sw=potencial_ficha&rut_col=".Encodear3($uni2->rut_col)."&id_comite=".Encodear3($id_comite)."&sucesion=1&sucesion=1&id_posicion_enc=".Encodear3($posicion)."' class='btn btn-link' >			        <span class='azul_comite'><i class='fas fa-user'></i> <span class='mt-comment-authorSM'> Ficha</span></span></a>", $row_lsita2);
						  $row_lsita2 = str_replace("{BOTON_VER_FICHA_A_inicial}","<a href='?sw=potencial_ficha&rut_col=".Encodear3($uni2->rut_col)."&id_comite=".Encodear3($id_comite)."&sucesion=1&sucesion=1&id_posicion_enc=".Encodear3($posicion)."'
						   class='btn btn-link' style='padding-left: 0px;    padding-left: 0px;text-align: left;padding-right: 0px;'>", $row_lsita2);
						  $row_lsita2 = str_replace("{BOTON_VER_FICHA_B_final}","</a>", $row_lsita2);			
						  }
					

			        	
						
							$row_lista2_acciones="";
									  $Potencial_Acciones_Desarrollo	=	Potencial_Busca_Acciones_Desarrollo($uni2->rut_col);
									  if(count($Potencial_Acciones_Desarrollo)>0){
									  	foreach ($Potencial_Acciones_Desarrollo as $un2){
									  		$row_lista2_acciones.=" <i class='far fa-file-alt'></i> ".$un2->plan."
									  		<span class='pull-right'><a href='?sw=potencial_ficha_sucesion&id_posicion_enc=".Encodear3($posicion)."&id_comite=".Encodear3($id_comite)."&perfil=".Encodear3($perfil)."&delad=".Encodear3($un2->id)."'><i class='far fa-trash-alt' style='color: #337ab7;'></i></a></span>
									  		<br>
									  		<i class='fas fa-chevron-right' style='padding-left: 20px;'></i> ".$un2->fundamento."<br>";
									  	}
									  	$row_lsita2 = str_replace("{ACCIONES_DE_DESARROLLO_TITULO1}", "<div class='txt_2020' data-toggle='collapse' href='#collapseExample2_".$uni2->rut_col."' role='button' aria-expanded='false' aria-controls='collapseExample'>Acciones de Desarrollo</div>", $row_lsita2);		
									  	$row_lsita2 = str_replace("{ACCIONES_DE_DESARROLLO}", $row_lista2_acciones, $row_lsita2);		
									  } else {
									  	$row_lsita2 = str_replace("{ACCIONES_DE_DESARROLLO}", "", $row_lsita2);		
									  	$row_lsita2 = str_replace("{ACCIONES_DE_DESARROLLO_TITULO1}", "", $row_lsita2);		
									  	
									  }

					  $Potencial_Bitacora_Desarrollo	=	Potencial_Busca_Bitacora_Desarrollo($uni2->rut_col);
						  if(count($Potencial_Bitacora_Desarrollo)>0){
						  	$row_lista1_bitacora="";
						  	foreach ($Potencial_Bitacora_Desarrollo as $un1){
						 						  		$row_lista1_bitacora.=" 
						  		
						  		".$un1->comite." - Sucesi&oacute;n - ".$un1->fecha." 
						  				 <br> ".$un1->nombre_completo." <br>  ".$un1->accion." ".$un1->comentario."
						  				<!--<span class='pull-right'><a href='?sw=potencial_ficha_sucesion&id_posicion_enc=".Encodear3($posicion)."&id_comite=".Encodear3($id_comite)."&perfil=".Encodear3($perfil)."&delad=".Encodear3($un1->id)."'><i class='far fa-trash-alt' style='color: #337ab7;'></i></a></span>-->
						  	<br><br>";
						  	}
						  		$row_lsita2 = str_replace("{BITACORA_DE_DESARROLLO_TITULO1}", "<div class='txt_2020' data-toggle='collapse' href='#collapseExample1_".$uni2->rut_col."' role='button' aria-expanded='false' aria-controls='collapseExample'>Bit&aacute;cora de Sucesi&oacute;n</div>", $row_lsita2);		
						  		$row_lsita2 = str_replace("{BITACORA_DE_DESARROLLO}", $row_lista1_bitacora, $row_lsita2);		
						  } else {
						  		$row_lsita2 = str_replace("{BITACORA_DE_DESARROLLO_TITULO1}", "", $row_lsita2);		
						  		$row_lsita2 = str_replace("{BITACORA_DE_DESARROLLO}", "", $row_lsita2);		
						  	
						  }
									  
						  
					}
				
				$row_largo="";
				$row_lsita3="";
				$Largo=PotencialSucesion_Vista_Colaboradores_Posicion($id_comite, $unico->rut, $id_empresa, "Largo", $posicion);
				foreach ($Largo as $uni3){
					
							if($comite_cerrado_esta=="SI" and $uni3->estado=="No es sucesor"){
								continue;
							}
					
			        $row_lsita3.= file_get_contents("views/potencial/" . $id_empresa . "_potencial_sucesion_row_colaboradores_comites_sucesion_avatar.html");
			        $row_lsita3 = str_replace("{RUT}",           utf8_encode($uni3->rut_col), $row_lsita3);
			        
			        $RxCol=MiRx($uni3->rut_col);
							$visualiza3=CheckVisualizaMiRxRxCol($MiRx,	$RxCol);			
			        
			        $row_lsita3 = str_replace("{COLABORADOR}",   	utf8_encode($uni3->nombre_completo), $row_lsita3);
			        $row_lsita3 = str_replace("{CARGO_COL}",   		utf8_encode($uni3->cargo_col), $row_lsita3);			
			        $row_lsita3 = str_replace("{RUT_SUCESORES_ENC}",           Encodear3($uni3->rut_col), $row_lsita3);
			        $row_lsita3 = str_replace("{ID_POSICION_ENC}",           	Encodear3($posicion), $row_lsita3);
			        $row_lsita3 = str_replace("{ID_COMITE_ENC}",           		Encodear3($id_comite), $row_lsita3);
			        $row_lsita3 = str_replace("{ID_COL}",           					Encodear3($uni3->id), $row_lsita3);
			        $row_lsita3 = str_replace("{AVATAR_RUT_SUCESORES}",   				VerificaFotoPersonal($uni3->rut_col), $row_lsita3);
							$row_lsita3 = str_replace("{PERFIL_ENC}",           		Encodear3($perfil), $row_lsita3);
			        $row_lsita3 = str_replace("{ACTUAL_TEMPORALIDAD}",      "Largo", $row_lsita3);

										$sucesion_display_none="";
							if($visualiza3=="NO"){$sucesion_display_none=" display:none; ";}
			        $row_lsita3 = str_replace("{sucesion_display_none}",      $sucesion_display_none, $row_lsita3);        
							$Usua3=DatosUsuario_($uni3->rut_col, $id_empresa);
							
							$es_posicion_clave=Pot_CheckPosicion_Clave($uni3->rut_col);
											if($es_posicion_clave>0){
													$posicion_clave	=" 
																
																	<div class='badge badge-gray'  style='    background-color: transparent !important;padding-left: 0px!important;'>
																		
																			<strong>Posici&oacute;n Clave</strong>
																		
																	</div><br>
															";
													} else {
													$posicion_clave="";	
													}
							$row_lsita3 = str_replace("{POSICION_CLAVE}", 			$posicion_clave, $row_lsita3);									
							
			        $row_lsita3 = str_replace("{COLABORADOR_SUCESORES}",     utf8_encode($Usua3[0]->nombre_completo), $row_lsita3);
			         							$posicion3=Potencial_Sucesion_d145_databci($uni3->rut_col);

			        $row_lsita3 = str_replace("{CARGO_SUCESORES}",           utf8_encode($posicion3), $row_lsita3);
			        $row_lsita3 = str_replace("{RUT_SUCESORES}",           		utf8_encode($uni3->rut_col), $row_lsita3);
						  $row_lsita3 = str_replace("{STYLO_AGREGAR_ACCIONES_DESARROLLO}", $display_acciones_desarrollo, $row_lsita3);				

			        $row_lsita3 = str_replace("{ID_SUCESORES}",           		Encodear3($uni3->id), $row_lsita3);

							//$Cuad_2020=Potencial_Check_Mapeado_oAnterior($uni3->rut_col);
							$Cuad_2020=Potencial_Mi_Cuadrante_Actual($uni3->rut_col);							
							
							$Num_Sucesion=Potencial_Sucesion_Num_Sucesores($uni3->rut_col
							);
							if($Cuad_2020<>""){
								if($Cuad_2020=="10"){$Cuad_2020="5+";}
								$cuadrante_2020="Cuadrante Actual: $Cuad_2020";
							} else {
								$cuadrante_2020="Sin cuadrante actual";
							}
							if($Num_Sucesion>0){
								$num_sucesion_2020="Veces como sucesor: $Num_Sucesion";
							} else {
								$num_sucesion_2020="1 vez como sucesor";
							}							


							$Usua=DatosUsuario_($uni3->rut_col, $id_empresa);
							if($Usua[0]->gerencia=="GERENCIA CORPORATIVA GESTION PERSONAS"){
								$cuadrante_2020="";
							}		

							if($visualiza3=="NO"){$num_sucesion_2020="";}
							if($visualiza3=="NO"){$cuadrante_2020="";}					
							
			        $row_lsita3 = str_replace("{CARGO_CUDRANTE_SUCESORES}",   $cuadrante_2020, $row_lsita3);
			        $row_lsita3 = str_replace("{CARGO_VECES_SUCESOR}",     		$num_sucesion_2020, $row_lsita3);        

							$estado_badge_avatar3="";
							if($uni3->estado=="No es sucesor"){
								if($uni3->rutlider==""){
									$estado_badge_avatar3="<span class='badge badge-danger' style='color:#fff'>No es Sucesor</span>";
								} else {
								$estado_badge_avatar3="<span class='badge badge-danger' style='color:#fff'>No es Sucesor</span>  <span style='font-size: 12px;display:none;'>Sugerido por L&iacute;der</span>";	
								}
							}
							
					if($uni3->estado=="Es Sucesor"){
								if($uni3->rutlider==""){
									$estado_badge_avatar3="<span class='badge badge-info' style='color:#fff'>Es Sucesor</span> - <span style='font-size: 12px;'>Propuesta de Sucesi&oacute;n</span>";
								} else {
								$estado_badge_avatar3="<span class='badge badge-info' style='color:#fff'>Es Sucesor</span>  <span style='font-size: 12px;display:none;'>Sugerido por L&iacute;der</span>";	
								}
							}	
							
					if($comite_cerrado_esta=="SI" and $uni3->estado=="Es Sucesor"){
						$estado_badge_avatar3="";
					}
							
			        $row_lsita3 = str_replace("{NO_ES_SUCESOR_ESTADO_BADGE}",     		$estado_badge_avatar3, $row_lsita3);
								        
			        		
			        $row_lsita3 = str_replace("{BOTON_VER_FICHA}","<a href='?sw=potencial_ficha&rut_col=".Encodear3($uni3->rut_col)."&id_comite=".Encodear3($id_comite)."&sucesion=1&sucesion=1&id_posicion_enc=".Encodear3($posicion)."' class='btn btn-link' >
			        <span class='azul_comite'><i class='fas fa-user'></i> <span class='mt-comment-authorSM'> Ficha</span></span></a>", $row_lsita3);
						  $row_lsita3 = str_replace("{BOTON_VER_FICHA_A_inicial}","<a href='?sw=potencial_ficha&rut_col=".Encodear3($uni3->rut_col)."&id_comite=".Encodear3($id_comite)."&sucesion=1&sucesion=1&id_posicion_enc=".Encodear3($posicion)."'
						   class='btn btn-link' style='padding-left: 0px;    padding-left: 0px;text-align: left;padding-right: 0px;'>", $row_lsita3);
						  $row_lsita3 = str_replace("{BOTON_VER_FICHA_B_final}","</a>", $row_lsita3);									
						  
						  
 if($visualiza3=="NO"){
			        $row_lsita3 = str_replace("{BOTON_VER_FICHA}","<a href='?sw=potencial_ficha&rut_col=".Encodear3($uni3->rut_col)."&id_comite=".Encodear3($id_comite)."&sucesion=1&sucesion=1&id_posicion_enc=".Encodear3($posicion)."' class='btn btn-link' >
			        <span class='azul_comite'><i class='fas fa-user'></i> <span class='mt-comment-authorSM'> Ficha</span></span></a>", $row_lsita3);
						  $row_lsita3 = str_replace("{BOTON_VER_FICHA_A_inicial}","<a href='?sw=potencial_ficha&rut_col=".Encodear3($uni3->rut_col)."&id_comite=".Encodear3($id_comite)."&sucesion=1&sucesion=1&id_posicion_enc=".Encodear3($posicion)."'
						   class='btn btn-link' style='padding-left: 0px;    padding-left: 0px;text-align: left;padding-right: 0px;'>", $row_lsita3);
						  $row_lsita3 = str_replace("{BOTON_VER_FICHA_B_final}","</a>", $row_lsita3);						
			  } else {
			        $row_lsita3 = str_replace("{BOTON_VER_FICHA}","", $row_lsita3);
						  $row_lsita3 = str_replace("{BOTON_VER_FICHA_A_inicial}","", $row_lsita3);
						  $row_lsita3 = str_replace("{BOTON_VER_FICHA_B_final}","", $row_lsita3);				
		 }						  
						  
						  
						  $row_lista3_acciones="";
									  $Potencial_Acciones_Desarrollo	=	Potencial_Busca_Acciones_Desarrollo($uni3->rut_col);
									  if(count($Potencial_Acciones_Desarrollo)>0){
									  	foreach ($Potencial_Acciones_Desarrollo as $un3){
									  		$row_lista3_acciones.=" <i class='far fa-file-alt'></i> ".$un3->plan."
									  		<span class='pull-right'><a href='?sw=potencial_ficha_sucesion&id_posicion_enc=".Encodear3($posicion)."&id_comite=".Encodear3($id_comite)."&perfil=".Encodear3($perfil)."&delad=".Encodear3($un3->id)."'><i class='far fa-trash-alt' style='color: #337ab7;'></i></a></span>
									  		<br>
									  		<i class='fas fa-chevron-right' style='padding-left: 20px;'></i> ".$un3->fundamento."<br>";
									  	}
									  	$row_lsita3 = str_replace("{ACCIONES_DE_DESARROLLO_TITULO1}", "<div class='txt_2020' data-toggle='collapse' href='#collapseExample2_".$uni3->rut_col."' role='button' aria-expanded='false' aria-controls='collapseExample'>Acciones de Desarrollo</div>", $row_lsita3);		
									  	$row_lsita3 = str_replace("{ACCIONES_DE_DESARROLLO}", $row_lista3_acciones, $row_lsita3);		
									  } else {
									  	$row_lsita3 = str_replace("{ACCIONES_DE_DESARROLLO}", "", $row_lsita3);		
									  	$row_lsita3 = str_replace("{ACCIONES_DE_DESARROLLO_TITULO1}", "", $row_lsita3);		
									  	
									  }
									  
									  
					  $Potencial_Bitacora_Desarrollo	=	Potencial_Busca_Bitacora_Desarrollo($uni3->rut_col);
						  if(count($Potencial_Bitacora_Desarrollo)>0){
						  	$row_lista1_bitacora="";
						  	foreach ($Potencial_Bitacora_Desarrollo as $un1){
						 						  		$row_lista1_bitacora.=" 
						  		
						  		".$un1->comite." - Sucesi&oacute;n - ".$un1->fecha." 
						  				 <br> ".$un1->nombre_completo." <br>  ".$un1->accion." ".$un1->comentario."
						  				<!--<span class='pull-right'><a href='?sw=potencial_ficha_sucesion&id_posicion_enc=".Encodear3($posicion)."&id_comite=".Encodear3($id_comite)."&perfil=".Encodear3($perfil)."&delad=".Encodear3($un1->id)."'><i class='far fa-trash-alt' style='color: #337ab7;'></i></a></span>-->
						  	<br><br>";
						  	}
						  		$row_lsita3 = str_replace("{BITACORA_DE_DESARROLLO_TITULO1}", "<div class='txt_2020' data-toggle='collapse' href='#collapseExample1_".$uni3->rut_col."' role='button' aria-expanded='false' aria-controls='collapseExample'>Bit&aacute;cora de Sucesi&oacute;n</div>", $row_lsita3);		
						  		$row_lsita3 = str_replace("{BITACORA_DE_DESARROLLO}", $row_lista1_bitacora, $row_lsita3);		
						  } else {
						  		$row_lsita3 = str_replace("{BITACORA_DE_DESARROLLO_TITULO1}", "", $row_lsita3);		
						  		$row_lsita3 = str_replace("{BITACORA_DE_DESARROLLO}", "", $row_lsita3);		
						  	
						  }									  
						  }







 
 
         $PRINCIPAL = str_replace("{INMEDIATO}", utf8_encode($row_lsita1), $PRINCIPAL);
        $PRINCIPAL = str_replace("{MEDIANO}",   utf8_encode($row_lsita2), $PRINCIPAL);
        $PRINCIPAL = str_replace("{LARGO}",   	utf8_encode($row_lsita3), $PRINCIPAL);
    
    $PRINCIPAL = str_replace("{MIS_COLABORADORES_COMITES_POTENCIAL}",         $row_lsita,         $PRINCIPAL);
    $PRINCIPAL = str_replace("{COLABORADORES_COMITE_POTENCIAL_TITULO}",  $potencial_titulo,  $PRINCIPAL);

    return ($PRINCIPAL);
}

function Potencial_Sucesion_Mis_Comites($PRINCIPAL, $rut, $perfil, $id_empresa)
{		
		$Usua=DatosUsuario_($rut, $id_empresa);
    $lista = Potencial_Mis_Comites_data($id_empresa, $rut, $perfil, $Usua[0]->jefe);
    //print_r($lista);
    
$nomuestracabeceras="";
if($perfil=="VISUALIZADOR"){
	$nomuestracabeceras="1";
}    
    
    if($nomuestracabeceras=="1"){
    	$lider="";
    	$colab="";
    	
    } else {
    	$lider1="LIDER";
    	$colab="COLAB.";
    }
    $num_comites    =   count($lista);
    //echo "<br>num_comites $num_comites<br>";
    if($num_comites>0){
        $potencial_titulo="
        <br>
<div class=''>
    <strong>
        <div class='col-sm-4 txt_title_pot'>COMITE</div>
        <div class='col-sm-2 txt_title_pot'>FECHA REALIZACION</div>
        <div class='col-sm-3 txt_title_pot'>".$lider1."</div>
        <div class='col-sm-1 txt_title_pot'>".$colab."</div>
        <div class='col-sm-2 txt_title_pot'>GESTIONAR</div>
    </strong>
</div>";
    }   else   {
        $potencial_titulo="
<div class='row'>
    <div class='col-sm-12 txt_title_pot'><br><br><center>[ No hay comit&eacute;s creados ]</center></div>
</div>";

    }

    foreach($lista as $unico) {
			$num_colaboradores=0;
    if($perfil=="LIDER")    {   $num_colaboradores=Potencial_Busca_Cantidad_Colaboradores_lider($rut, $unico->id_comite, $id_empresa);
                $Usua=DatosUsuario_($rut, $id_empresa);
                $lider= $Usua[0]->nombre_completo;
    }
    
    if($perfil=="SOCIO DE NEGOCIO")    {   $num_colaboradores=Potencial_Busca_Cantidad_Colaboradores_socio($rut, $unico->id_comite, $id_empresa);


			$lider="";
      $array_lideres=PotencialBuscaLideres($unico->id_comite, $id_empresa);
      //print_r($array_lideres);
      foreach ($array_lideres as $unlid){
          $nombr_l=DatosUsuario_($unlid->rut_lider, $id_empresa);
          $lider.=$nombr_l[0]->nombre_completo."<br>";
      }
    }
        //echo "<br>hola ".$unico->nombre;
        $row_lsita.= file_get_contents("views/potencial/" . $id_empresa . "_potencial_row_comites.html");
        //echo "<br>views/potencial/" . $id_empresa . "_potencial_row_comites.html";
        $row_lsita = str_replace("{ID_COMITE}", utf8_encode($unico->id_comite), $row_lsita);
        $row_lsita = str_replace("{COMITE}", utf8_encode($unico->nombre), $row_lsita);
        $row_lsita = str_replace("{FECHA}", $unico->fecha_comite, $row_lsita);
        $row_lsita = str_replace("{LIDER}", utf8_encode($lider), $row_lsita);
        $row_lsita = str_replace("{COLABORADORES}", $num_colaboradores, $row_lsita);
        $row_lsita = str_replace("{BOTON_VER_COMITE}", "<a href='?sw=potencial_comite&id_comite=".Encodear3($unico->id_comite)."' class='btn btn-success'>
        	<span class='blanco'>Ingresar</span></a>", $row_lsita);
        
        if($perfil=="SOCIO DE NEGOCIO")    { 
        	$row_lsita = str_replace("{BOTON_ELIMINAR_COMITE}", "<a href='?sw=potencial&id_del=".Encodear3($unico->id_comite)."' class='btn btn-link'>
        	<span class='azul_comite'><i class='fas fa-trash-alt'></i></span></a>", $row_lsita);
      	}else {
      		$row_lsita = str_replace("{BOTON_ELIMINAR_COMITE}", "", $row_lsita);
      	}
    }
    //echo  "$row_lsita";
    $PRINCIPAL = str_replace("{MIS_COMITES_POTENCIAL}",         $row_lsita,         $PRINCIPAL);
    $PRINCIPAL = str_replace("{MIS_COMITES_POTENCIAL_TITULO}",  $potencial_titulo,  $PRINCIPAL);

    return ($PRINCIPAL);
}

function Potencial_Sucesion_Mis_Comites_estado_activo($PRINCIPAL, $rut, $perfil, $id_empresa, $comite_cierre)
{
		//echo "<h2>Potencial_Sucesion_Mis_Comiites_estado_activo( $rut, $perfil, $id_empresa, $comite_cierre)<h2>";
    $lista = Potencial_Sucesion_Mis_Comites_data($id_empresa, $rut, $perfil);
    //echo "<br><br>";	    	print_r($lista);    echo "<br><br>";
    //echo "<br>comite_cierre $comite_cierre<br>";
    
		$nomuestracabeceras="";
		if($perfil=="VISUALIZADOR"){
			$nomuestracabeceras="1";
		}    
    
    if($nomuestracabeceras=="1"){
    	$lider="";
    	$colab="";
    	
    } else {
    	$lider1="LIDER";
    	$colab="COLAB.";
    }
    $num_comites    =   count($lista);
    //echo "<br>num_comites $num_comites<br>";
    if($num_comites>0){
        $potencial_titulo="
        <br>
					<div class=''>
					    <strong>
					        <div class='col-sm-4 txt_title_pot'>COMITE SUCESION</div>
					        <div class='col-sm-2 txt_title_pot'>FECHA REALIZACION</div>
					        <div class='col-sm-4 txt_title_pot'>CARGOS A SUCEDER</div>
					        <div class='col-sm-2 txt_title_pot'>GESTIONAR</div>
					    </strong>
					</div>";
    }   else   {
        $potencial_titulo="
					<div class='row'>
					    <div class='col-sm-12 txt_title_pot'><br><br><center>[ No hay comit&eacute;s de sucesión creados ]</center></div>
					</div>";
    }

    foreach($lista as $unico) {
			$num_colaboradores=0;

			$array_comite=Potencial_Comites_Suc_data($unico->id_comite,$id_empresa);
			//echo "<br>";				print_r($array_comite);			echo "<br>";
			
			$id_comite_cerrado = $array_comite[0]->comite_cerrado;
			//echo "<br>IdComite ".$unico->id_comite." comite cerrado ".$comite_cierre." id_comite_cerrado ".$id_comite_cerrado;
			
			if($comite_cierre=="cerrado" and $id_comite_cerrado<>"SI"){
				continue;
			}

			if($comite_cierre=="activo" and $id_comite_cerrado=="SI"){
				continue;
			}
			
    if($perfil=="LIDER")    {   $num_colaboradores=Potencial_Busca_Cantidad_Colaboradores_lider($rut, $unico->id_comite, $id_empresa);
                $Usua=DatosUsuario_($rut, $id_empresa);
                $lider= $Usua[0]->nombre_completo;
    }
    
    if($perfil=="SOCIO DE NEGOCIO" OR $perfil=="SUPER USER")    {   $num_colaboradores=Potencial_Busca_Cantidad_Colaboradores_socio($rut, $unico->id_comite, $id_empresa);


			$g2="";
      $array_g2=PotencialSucesion_BuscaR2($unico->gerenciaR1, $id_empresa);
      
      //echo "<br>";
      //print_r($array_g2);
      
      foreach ($array_g2 as $unlid){
          //$nombr_l=DatosUsuario_($unlid->rut, $id_empresa);
          
          Potencial_Sucesion_CheckSave($unlid->rut,$unlid->d145,$unico->id_comite,$id_empresa);
			$pos_validada=Sucesion_Check_Posicion_validada($unlid->d145);
			if($pos_validada>0){
					$pot_sucesion_badge_ok_cerrado="<div class='badge badge-success'><i class='fas fa-check' style='color: #fff;'></i></div>";
				} else {
					$pot_sucesion_badge_ok_cerrado="";
			}

          $g2.=$unlid->d151." ".$pot_sucesion_badge_ok_cerrado."<br>";


          
          
      }
    }
        //echo "<br>hola ".$unico->nombre;
        $row_lsita.= file_get_contents("views/potencial/" . $id_empresa . "_potencial_row_comites_sucesion.html");
        //echo "<br>views/potencial/" . $id_empresa . "_potencial_row_comites.html";
        $row_lsita = str_replace("{ID_COMITE}", utf8_encode($unico->id_comite), $row_lsita);
        $row_lsita = str_replace("{COMITE}", utf8_encode($unico->nombre), $row_lsita);
        $row_lsita = str_replace("{FECHA}", $unico->fecha_comite, $row_lsita);
        $row_lsita = str_replace("{GERENTES_R2}", utf8_encode($g2), $row_lsita);
        
        
        $row_lsita = str_replace("{COLABORADORES}", $num_colaboradores, $row_lsita);

        $UsuaCreadorComite=DatosUsuario_($unico->rut, $id_empresa);
        $row_lsita = str_replace("{POR_CREADOR_COMITE}", $UsuaCreadorComite[0]->nombre_completo, $row_lsita);
        
        $row_lsita = str_replace("{BOTON_VER_COMITE}", "<a href='?sw=potencial_sucesion_comite&id_comite=".Encodear3($unico->id_comite)."' class='btn btn-success'>
        	<span class='blanco'>Ingresar</span></a>", $row_lsita);
        
        if($perfil=="SOCIO DE NEGOCIO" OR $perfil=="SUPER USER")    { 
        	$row_lsita = str_replace("{BOTON_ELIMINAR_COMITE}", "<a href='?sw=potencial_sucesion&id_del=".Encodear3($unico->id_comite)."' class='btn btn-link'>
        	<span class='azul_comite'><i class='fas fa-trash-alt'></i></span></a>", $row_lsita);
      	}else {
      		$row_lsita = str_replace("{BOTON_ELIMINAR_COMITE}", "", $row_lsita);
      	}
    }
    //echo  "$row_lsita";
    
    if($comite_cierre=="activo"){
    	$PRINCIPAL = str_replace("{MIS_COMITES_POTENCIAL}",         $row_lsita,         $PRINCIPAL);
    	$PRINCIPAL = str_replace("{MIS_COMITES_POTENCIAL_TITULO}",  $potencial_titulo,  $PRINCIPAL);

    	
    } else {
    	$PRINCIPAL = str_replace("{MIS_COMITES_POTENCIAL}",         $row_lsita,         $PRINCIPAL);
    	$PRINCIPAL = str_replace("{MIS_COMITES_POTENCIAL}",  				$potencial_titulo,  $PRINCIPAL);

    }

    return ($PRINCIPAL);
}

function Potencial_Sucesion_Mis_Comites_estado_cierre($PRINCIPAL, $rut, $perfil, $id_empresa, $comite_cierre)
{
    $lista = Potencial_Sucesion_Mis_Comites_data($id_empresa, $rut, $perfil);
    //print_r($lista);
    //echo "<br>comite_cierre $comite_cierre<br>";
    
		$nomuestracabeceras="";
		if($perfil=="VISUALIZADOR"){
			$nomuestracabeceras="1";
		}    
    
    if($nomuestracabeceras=="1"){
    	$lider="";
    	$colab="";
    	
    } else {
    	$lider1="LIDER";
    	$colab="COLAB.";
    }
    $num_comites    =   count($lista);
    //echo "<br>num_comites $num_comites<br>";
    if($num_comites>0){
        $potencial_titulo="
        <br>
<div class=''>
					    <strong>
					        <div class='col-sm-4 txt_title_pot'>COMITE SUCESION</div>
					        <div class='col-sm-2 txt_title_pot'>FECHA REALIZACION</div>
					        <div class='col-sm-4 txt_title_pot'>CARGOS A SUCEDER</div>
					        <div class='col-sm-2 txt_title_pot'>GESTIONAR</div>
					    </strong>
</div>";
    }   else   {
        $potencial_titulo="
<div class='row'>
    <div class='col-sm-12 txt_title_pot'><br><br><center>[ No hay comit&eacute;s creados ]</center></div>
</div>";

    }

    foreach($lista as $unico) {
			$num_colaboradores=0;

			$array_comite=Potencial_Comites_Suc_data($unico->id_comite,$id_empresa);
			//echo "<br>";				print_r($array_comite);			echo "<br>";exit();
			
			$id_comite_cerrado = $array_comite[0]->comite_cerrado;
			//echo "<br>IdComite ".$unico->id_comite." comite cerrado ".$comite_cierre." id_comite_cerrado ".$id_comite_cerrado;
			
			if($comite_cierre=="cerrado" and $id_comite_cerrado<>"SI"){
				continue;
			}

			if($comite_cierre=="activo" and $id_comite_cerrado=="SI"){
				continue;
			}
	  if($perfil=="LIDER")    {   $num_colaboradores=Potencial_Busca_Cantidad_Colaboradores_lider($rut, $unico->id_comite, $id_empresa);
                $Usua=DatosUsuario_($rut, $id_empresa);
                $lider= $Usua[0]->nombre_completo;
    }
    
    if($perfil=="SOCIO DE NEGOCIO" OR $perfil=="SUPER USER")    {   $num_colaboradores=Potencial_Busca_Cantidad_Colaboradores_socio($rut, $unico->id_comite, $id_empresa);


			$g2="";
      $array_g2=PotencialSucesion_BuscaR2($unico->gerenciaR1, $id_empresa);
      //print_r($array_g2);
      foreach ($array_g2 as $unlid){
          //$nombr_l=DatosUsuario_($unlid->rut, $id_empresa);
          
          Potencial_Sucesion_CheckSave($unlid->rut,$unlid->d145,$unico->id_comite,$id_empresa);
			$pos_validada=Sucesion_Check_Posicion_validada($unlid->d145);
			if($pos_validada>0 and $comite_cierre=="activo"){
					$pot_sucesion_badge_ok_cerrado="<div class='badge badge-success'><i class='fas fa-check' style='color: #fff;'></i></div>";
				} else {
					$pot_sucesion_badge_ok_cerrado="";
			}

          $g2.=$unlid->d151." ".$pot_sucesion_badge_ok_cerrado."<br>";


          
          
      }
    }
        //echo "<br>hola ".$unico->nombre;
        $row_lsita.= file_get_contents("views/potencial/" . $id_empresa . "_potencial_row_comites_sucesion.html");
        //echo "<br>views/potencial/" . $id_empresa . "_potencial_row_comites.html";
        $row_lsita = str_replace("{ID_COMITE}", utf8_encode($unico->id_comite), $row_lsita);
        $row_lsita = str_replace("{COMITE}", utf8_encode($unico->nombre), $row_lsita);
        $row_lsita = str_replace("{FECHA}", $unico->fecha_comite, $row_lsita);
        $row_lsita = str_replace("{GERENTES_R2}", utf8_encode($g2), $row_lsita);
        
        $UsuaCreadorComite=DatosUsuario_($unico->rut, $id_empresa);
        $row_lsita = str_replace("{POR_CREADOR_COMITE}", $UsuaCreadorComite[0]->nombre_completo, $row_lsita);
        
        $row_lsita = str_replace("{BOTON_VER_COMITE}", "<a href='?sw=potencial_sucesion_comite&id_comite=".Encodear3($unico->id_comite)."' class='btn btn-success'>
        	<span class='blanco'>Ingresar</span></a>", $row_lsita);
        
        if($perfil=="SOCIO DE NEGOCIO"  OR $perfil=="SUPER USER")    { 
        	$row_lsita = str_replace("{BOTON_ELIMINAR_COMITE}", "<a href='?sw=potencial_sucesion&id_del=".Encodear3($unico->id_comite)."' class='btn btn-link'>
        	<span class='azul_comite'><i class='fas fa-trash-alt'></i></span></a>", $row_lsita);
      	}else {
      		$row_lsita = str_replace("{BOTON_ELIMINAR_COMITE}", "", $row_lsita);
      	}
    }
    //echo  "$row_lsita";
    

    	$PRINCIPAL = str_replace("{MIS_COMITES_POTENCIAL2}",         $row_lsita,         $PRINCIPAL);
    	$PRINCIPAL = str_replace("{MIS_COMITES_POTENCIAL_TITULO2}",  $potencial_titulo,  $PRINCIPAL);

 

    return ($PRINCIPAL);
}


function Potencial_Descripcion_Cuadrantes_TXT($cuadrante){
	
if($cuadrante=="1"){
$texto="Consistentemente no alcanza los estándares de desempeño
Competencias superiores al nivel esperado
Tiene potencial para desempeñarse y contribuir a la organización pero puede estar en la posición equivocada

Acción: Re-posicionar para el éxito, dar feedback, formación
";}

if($cuadrante=="2"){
$texto="Muestra consistentemente un desempeño acorde a lo esperado
Competencias superiores al nivel esperado
Aborda fácilmente nuevos desafíos y se adapta fácilmente a ellos

Acción: Apto para asumir nuevos roles, reconocer, dar exposición
";}

if($cuadrante=="3"){
$texto="Consistentemente excede el desempeño esperado
Competencias superiores al nivel esperado
Prospera frente a desafíos nuevos, ambiguos y complejos
Domina el actual rol

Acción: Acelerar desarrollo, reconocimiento, dar exposición
";}

if($cuadrante=="4"){
$texto="Consistentemente no alcanza los estándares de desempeño
Competencias acorde al nivel esperado
Puede estar en la posición equivocada o en proceso de aprendizaje

Acción: Reevaluar su futuro, proveer feedback, coaching de jefatura
";}

if($cuadrante=="5"){
$texto="Se ajusta 100% a su rol actual y su desempeño cumple con las expectativas de su cargo
Competencias acorde al nivel esperado
Entiende y conoce bien su trabajo actual

Acción: Desafiar y probar
";}

if($cuadrante=="6"){
$texto="Consistentemente excede el desempeño esperado
Competencias acorde al nivel esperado
Es referente en su área de especialidad

Acción: Preparar para extender su rol, reconocer contribución
";}

if($cuadrante=="7"){
$texto="Consistentemente no alcanza los estándares de desempeño
Muestra competencias consistentemente bajo lo esperado
Caso crítico

Acción: Plan de mejora o salida
";}

if($cuadrante=="8"){
$texto="Cumple consistentemente con lo esperado en metas
Competencias por debajo del nivel esperado para su rol
Capacidad limitada para tener éxito en un rol más complejo

Acción: Apoyar y desarrollar, proveer feedback, coaching de jefatura
";}

if($cuadrante=="9"){
$texto="Consistentemente excede el desempeño esperado
Tiene alta experiencia en un área funcional, conoce bien su trabajo
Tiene algunas competencias en nivel esperado y aun hay oportunidades de mejora

Acción: Aprovechar/apalancar la experiencia
";}

if($cuadrante=="5+" or $cuadrante=="10"){
$texto="Se ajusta 100% a su rol actual y su desempeño cumple con las expectativas de su cargo
En oportunidades destaca y comienza a demostrar competencias por sobre lo esperado, pero todavía falta consistencia y tiempo

Acción: Desafiar y consolidar
";}
	
return 	$texto;
	
	
}

function calcular_edad($fecha){
$fecha_nac = new DateTime(date('Y/m/d',strtotime($fecha))); // Creo un objeto DateTime de la fecha ingresada
$fecha_hoy =  new DateTime(date('Y/m/d',time())); // Creo un objeto DateTime de la fecha de hoy
$edad = date_diff($fecha_hoy,$fecha_nac); // La funcion ayuda a calcular la diferencia, esto seria un objeto
return $edad;
}


function Potencial_Bitacora_Comites($PRINCIPAL, $id_comite, $rut, $perfil, $id_empresa){

//echo "<br>Potencial_Bitacora_Comites $id_comite, $id_empresa";

 $lista = Potencial_Bitacora_Comites_data($id_comite, $rut, $perfil, $id_empresa);
    //print_r($lista);
    $num_comentarios    =   count($lista);
    //echo "<br>num_comites $num_comites<br>";
    if($num_comentarios>0){
        $potencial_bitacora_titulo="

<div class='panel panel-info'>
                                    <div class='panel-heading'>Bit&aacute;cora de Cambios de Cuadrantes</div>
                                    <div class='panel-body'>


<div class=''>
    <strong>
        <div class='col-sm-4 txt_title_pot'>Colaborador</div>
        <div class='col-sm-4 txt_title_pot'>Quien realizó Cambio</div>
        <div class='col-sm-1 txt_title_pot' style='padding-left: 36px;'>Cuadrante</div>
        <div class='col-sm-3 txt_title_pot' style='padding-left: 36px;'>Fundamento</div>
   </strong>
</div>";
    }   else   {
        $potencial_bitacora_titulo="

<div class=''><br>
    <div class='col-sm-12 txt_title_pot_hohay'><center>[ No hay bit&aacute;cora de cuadrantes ]</center></div>
    					<br>
</div>
";

    }
    //print_r($lista);
    foreach($lista as $unico) {
        //echo "<br>hola ".$unico->nombre;
        $row_lsita.= file_get_contents("views/potencial/" . $id_empresa . "_potencial_row_colaboradores_bitacora.html");
        //echo "<br>views/potencial/" . $id_empresa . "_potencial_row_comites.html";
        $row_lsita = str_replace("{NOMBRE_AUTOR}",      utf8_encode($unico->nombre_completo), $row_lsita);
        $row_lsita = str_replace("{FOTO_AUTOR}",        VerificaFotoPersonal($unico->rut), $row_lsita);
        $row_lsita = str_replace("{PERFIL}",            utf8_encode($unico->perfil), $row_lsita);
        $row_lsita = str_replace("{FOTO_COLABORADOR}",  VerificaFotoPersonal($unico->rut_colaborador), $row_lsita);
        $row_lsita = str_replace("{NOMBRE_COLABORADOR}",utf8_encode($unico->nombre_completo_col), $row_lsita);
        $box_propuesto=Potencial_Matriz_Box_Nuevo_Propuesta($unico->box_propuesto);

      $row_lsita = str_replace("{BOX}",   utf8_encode($box_propuesto), $row_lsita);
        $row_lsita = str_replace("{COMENTARIO}", utf8_encode($unico->comentario), $row_lsita);
        $row_lsita = str_replace("{FECHA}", utf8_encode($unico->fecha), $row_lsita);
    }
    //echo  "$row_lsita";
    $PRINCIPAL = str_replace("{BITACORA_CAMBIOS_COMENTARIOS_POTENCIAL}",         $row_lsita,         $PRINCIPAL);
    $PRINCIPAL = str_replace("{BITACORA_CAMBIOS_COMENTARIOS_POTENCIAL_TITULO}",  $potencial_bitacora_titulo,  $PRINCIPAL);

    return ($PRINCIPAL);


}
function Potencial_Box9_Comites($PRINCIPAL, $id_comite, $rut, $perfil, $boxfiltro, $id_empresa){

    $row_lsita.= file_get_contents("views/potencial/" . $id_empresa . "_potencial_box9.html");



    $cuenta_total_cols=Potencial_Lista_Colaboradores_Reales($id_comite, $id_empresa);
		for ($i = 1; $i <= 10; $i++){
			//echo "<br>i $i";
				    $array	=	Potencial_lista_colabordores_comite($i, $id_comite, $rut, $perfil, $id_empresa);
				   
				    $row_	=	"";
						$cuenta_array=count( $array) + $cuenta_array;
					  foreach($array as $unico){
					  	
									//echo "<br>Line 1 - i $i rut ".$unico->rut." cuadrante $Cuadrante_Actual lider $Cuadrante_Lider $Sube_Baja_Mantiene, box filtro $boxfiltro";
					  	
				       		$continue= PotChecKMisUsuarioFuera($unico->rut);
				       		if($continue=="1"){ continue;}
				       		
									$cuenta++;					
									$Cuadrante_Actual		= Potencial_Mi_Cuadrante_Actual($unico->rut);
									$Cuadrante_Lider 		= Potencial_Mi_Cuadrante_Lider($unico->rut);	
									$Sube_Baja_Mantiene	=	Potencial_Baja_Igual_Sube($Cuadrante_Actual, $Cuadrante_Lider);	
									
									
									if($boxfiltro==""){
										$MiCuadrante=$Cuadrante_Actual;
									} else {
										$MiCuadrante=$Cuadrante_Lider;
										if($Sube_Baja_Mantiene==$boxfiltro){
											
										} else {
											continue;
										}
									}
									//echo "<br>Line 2 - i $i  $i rut ".$unico->rut." cuadrante $Cuadrante_Actual lider $Cuadrante_Lider $Sube_Baja_Mantiene, box filtro $boxfiltro";
								
									//echo "check $MiCuadrante==$i";
									if($MiCuadrante==$i){
										
									} else {
										continue;
										
									}	
		
									//echo "<br>Line 3 - i $i  $i rut ".$unico->rut." cuadrante $Cuadrante_Actual lider $Cuadrante_Lider $Sube_Baja_Mantiene, box filtro $boxfiltro";
		
									
 								$row_.= file_get_contents("views/potencial/" . $id_empresa . "_potencial_box9_rowpersonas.html");
				
				  
				        $row_ = str_replace("{BOTON_VER_FICHA_A_inicial}",  "<a href='?sw=potencial_ficha&rut_col=".Encodear3($unico->rut)."&id_comite=".Encodear3($id_comite)."'class='btn btn-link' style='padding-left: 0px;    padding-left: 0px;text-align: left;padding-right: 0px;'>",   $row_);
				        $row_ = str_replace("{BOTON_VER_FICHA_B_final}",  "</a>",   $row_);
				        $row_ = str_replace("{AVATAR}",  utf8_encode(VerificaFotoPersonal($unico->rut)),   $row_);
				        $row_ = str_replace("{NOMBRE}", utf8_encode($unico->nombre_completo),             $row_);
				        $row_ = str_replace("{PROPUESTA_MODELO}", "(".utf8_encode($Cuadrante_Actual).")",             $row_);
						        
						    if($i==1){$cuenta1++;}
						    if($i==2){$cuenta2++;}
						    if($i==3){$cuenta3++;}
						    if($i==4){$cuenta4++;}
						    if($i==5){$cuenta5++;}
						    if($i==6){$cuenta6++;}
						    if($i==7){$cuenta7++;}
						    if($i==8){$cuenta8++;}
						    if($i==9){$cuenta9++;}
						    if($i==10){$cuenta10++;}
						    $cuenta++;

						}

				    if($i==1){$row_1=$row_;}
				    if($i==2){$row_2=$row_;}
				    if($i==3){$row_3=$row_;}
				    if($i==4){$row_4=$row_;}
				    if($i==5){$row_5=$row_;}
				    if($i==6){$row_6=$row_;}
				    if($i==7){$row_7=$row_;}
				    if($i==8){$row_8=$row_;}
				    if($i==9){$row_9=$row_;}
				    if($i==10){$row_10=$row_;}

				}
				
				$porc1  =   round(100*$cuenta1/$cuenta_total_cols);
				$porc2  =   round(100*$cuenta2/$cuenta_total_cols);
				$porc3  =   round(100*$cuenta3/$cuenta_total_cols);
				$porc4  =   round(100*$cuenta4/$cuenta_total_cols);
				$porc5  =   round(100*$cuenta5/$cuenta_total_cols);
				$porc6  =   round(100*$cuenta6/$cuenta_total_cols);
				$porc7  =   round(100*$cuenta7/$cuenta_total_cols);
				$porc8  =   round(100*$cuenta8/$cuenta_total_cols);
				$porc9  =   round(100*$cuenta9/$cuenta_total_cols);
				$porc10 =   round(100*$cuenta10/$cuenta_total_cols);

    $row_lsita = str_replace("{1}",   $row_1, $row_lsita);
    $row_lsita = str_replace("{2}",   $row_2, $row_lsita);
    $row_lsita = str_replace("{3}",   $row_3, $row_lsita);
    $row_lsita = str_replace("{4}",   $row_4, $row_lsita);
    $row_lsita = str_replace("{5}",   $row_5, $row_lsita);
    $row_lsita = str_replace("{6}",   $row_6, $row_lsita);
    $row_lsita = str_replace("{7}",   $row_7, $row_lsita);
    $row_lsita = str_replace("{8}",   $row_8, $row_lsita);
    $row_lsita = str_replace("{9}",   $row_9, $row_lsita);
    $row_lsita = str_replace("{10}",   $row_10, $row_lsita);

    $row_lsita = str_replace("{NUM_1}",   $cuenta1, $row_lsita);
    $row_lsita = str_replace("{NUM_2}",   $cuenta2, $row_lsita);
    $row_lsita = str_replace("{NUM_3}",   $cuenta3, $row_lsita);
    $row_lsita = str_replace("{NUM_4}",   $cuenta4, $row_lsita);
    $row_lsita = str_replace("{NUM_5}",   $cuenta5, $row_lsita);
    $row_lsita = str_replace("{NUM_6}",   $cuenta6, $row_lsita);
    $row_lsita = str_replace("{NUM_7}",   $cuenta7, $row_lsita);
    $row_lsita = str_replace("{NUM_8}",   $cuenta8, $row_lsita);
    $row_lsita = str_replace("{NUM_9}",   $cuenta9, $row_lsita);
    $row_lsita = str_replace("{NUM_10}",   $cuenta10, $row_lsita);

    $row_lsita = str_replace("{PORC_1}",   $porc1."%", $row_lsita);
    $row_lsita = str_replace("{PORC_2}",   $porc2."%", $row_lsita);
    $row_lsita = str_replace("{PORC_3}",   $porc3."%", $row_lsita);
    $row_lsita = str_replace("{PORC_4}",   $porc4."%", $row_lsita);
    $row_lsita = str_replace("{PORC_5}",   $porc5."%", $row_lsita);
    $row_lsita = str_replace("{PORC_6}",   $porc6."%", $row_lsita);
    $row_lsita = str_replace("{PORC_7}",   $porc7."%", $row_lsita);
    $row_lsita = str_replace("{PORC_8}",   $porc8."%", $row_lsita);
    $row_lsita = str_replace("{PORC_9}",   $porc9."%", $row_lsita);
    $row_lsita = str_replace("{PORC_10}",   $porc10."%", $row_lsita);
 

// echo "<br> cuenta5 $cuenta5 / cuenta $cuenta_total_cols ";
 
 //echo "<br> cuenta8 $cuenta8 / cuenta $cuenta_total_cols ";
 
 
    if($cuenta_array>0){
    	
    	if($boxfiltro<>""){
    	      $box9_curva_distribucion="
    	      
    	           <br><br>
            
            ";	
    	} else {
               $box9_curva_distribucion="
           
           <center> 
           		<div id='chart_div' style='width: 900px; height: 300px;'></div>
            </center>
            
            <br><br>
            
            ";		
    	}
    	

						    $PRINCIPAL = str_replace("{CHART_PORC_1}",         $porc1,         $PRINCIPAL);
						    $PRINCIPAL = str_replace("{CHART_PORC_2}",         $porc2,         $PRINCIPAL);
						    $PRINCIPAL = str_replace("{CHART_PORC_3}",         $porc3,         $PRINCIPAL);
						    $PRINCIPAL = str_replace("{CHART_PORC_4}",         $porc4,         $PRINCIPAL);
						    $PRINCIPAL = str_replace("{CHART_PORC_5}",         $porc5,         $PRINCIPAL);
						    $PRINCIPAL = str_replace("{CHART_PORC_6}",         $porc6,         $PRINCIPAL);
						    $PRINCIPAL = str_replace("{CHART_PORC_7}",         $porc7,         $PRINCIPAL);
						    $PRINCIPAL = str_replace("{CHART_PORC_8}",         $porc8,         $PRINCIPAL);
						    $PRINCIPAL = str_replace("{CHART_PORC_9}",         $porc9,         $PRINCIPAL);
						    $PRINCIPAL = str_replace("{CHART_PORC_10}",        $porc10,         $PRINCIPAL);

						    $PRINCIPAL = str_replace("{POTENCIAL_BOX9_COMITE_LIDER_PROPUESTA}",         $row_lsita,         $PRINCIPAL);
						    $PRINCIPAL = str_replace("{POTENCIAL_BOX9_CURVA_DISTRIBUCION}", $box9_curva_distribucion,         $PRINCIPAL);
    } else {
							    $PRINCIPAL = str_replace("{POTENCIAL_BOX9_COMITE_LIDER_PROPUESTA}",        "
							   
							    <div class=''><br>
							    	<div class='col-sm-12 txt_title_pot_hohay'><center>[ No hay colaboradores ]</center></div>
							    						<br>
									</div>
							    
							    ",         $PRINCIPAL);
							    $PRINCIPAL = str_replace("{POTENCIAL_BOX9_CURVA_DISTRIBUCION}",         "",         $PRINCIPAL);

    }
    return ($PRINCIPAL);
}

function Potencial_Colaboradores_Comites($PRINCIPAL, $id_comite, $rut, $perfil, $id_empresa)
{
	
	$array_comite_row=Potencial_Comites_data($id_comite,$id_empresa);
	if($array_comite_row[0]->comite_cerrado=="SI"){
		$display_none_lider_mapeado="display:none;";
	} else {
		$display_none_lider_mapeado="";
	}
	
    $lista = Potencial_Colaboradores_Comites_data($id_comite, $rut, $perfil, $id_empresa);
    //print_r($lista);
    $num_comites    =   count($lista);
    //echo "<br>num_comites $num_comites<br>";
    if($num_comites>0){
        $potencial_titulo="
<div class=''>
    <strong>
        <div class='col-sm-3 txt_title_pot'>Colaborador</div>
        <div class='col-sm-2 txt_title_pot'>Metas</div>
        <div class='col-sm-2 txt_title_pot'>Competencias</div>
        <div class='col-sm-1 txt_title_pot'>C. Actual</div>
        <div class='col-sm-1 txt_title_pot'>C. Anterior</div>
        <div class='col-sm-1 txt_title_pot'>C. Propuesta Según Modelo</div>
        <div class='col-sm-1 txt_title_pot' style='".$display_none_lider_mapeado."'>C. Propuesta Líder</div>
        <div class='col-sm-1 txt_title_pot'></div>
    </strong>
</div>";
    }   else   {
        $potencial_titulo="
<div class=''><br>
    <div class='col-sm-12 txt_title_pot_hohay'><center>[ No hay colaboradores ]</center></div>
    					<br>
</div>";

    }
		
		$i_v=0;$i_s=0;$i_m=0;$i_b=0;
			

    foreach($lista as $unico) {
    	
				CheckMapeadoCerrado($unico->rut);     	
    	
       $continue= PotChecKMisUsuarioFuera($unico->rut);
       if($continue=="1"){ continue;}

        //echo "<br>hola ".$unico->nombre;
        $row_lsita.= file_get_contents("views/potencial/" . $id_empresa . "_potencial_row_colaboradores_comites.html");
        //echo "<br>views/potencial/" . $id_empresa . "_potencial_row_comites.html";
        $row_lsita = str_replace("{RUT}",           utf8_encode($unico->rut), $row_lsita);
        
       
        
        $Potencial_Mapeado=Potencial_Check_Mapeado($unico->rut);
	        if($Potencial_Mapeado<>""){
	        	if($array_comite_row[0]->comite_cerrado=="SI"){
	        		$row_lsita = str_replace("{MAPEADO}",         	"", $row_lsita);
	        	} else {
	        			$Potencial_Mapeado_Cerrado=Potencial_Check_Mapeado_Cerrado($unico->rut);
	        			//echo "<br>-->Potencial_Mapeado_Cerrado ".$Potencial_Mapeado_Cerrado;
	        			
	        			$cerrado=Potencial_BuscaUltimoComitedeRut($rut);
	        			
	        			if($Potencial_Mapeado_Cerrado>0 and $cerrado=="1"){
	        				$row_lsita = str_replace("{MAPEADO}",           "", $row_lsita);	
	        			} else {
	        				$row_lsita = str_replace("{MAPEADO}",           "<span class='badge badge-success' style='font-size: 10px;'><span class='blanco'>Mapeado</span></span>", $row_lsita);			
	        			}
	        		
	        	}
	        	
	        } else {
	        		$row_lsita = str_replace("{MAPEADO}",         	"", $row_lsita);
	        }
	        
        $row_lsita = str_replace("{COLABORADOR}",   	utf8_encode($unico->nombre_completo), $row_lsita);
        $row_lsita = str_replace("{CARGO_COL}",   		utf8_encode($unico->cargo_col), $row_lsita);
        $row_lsita = str_replace("{NOMBRE_LIDER}",  	utf8_encode($unico->nombre_lider), $row_lsita);
        
        $row_lsita = str_replace("{AVATAR}",   VerificaFotoPersonal($unico->rut), $row_lsita);

        $array_resultados   =   Potencial_Colaboradores_Matriz_Fields_tbl_data_bci_data($unico->rut);
   
   				//busca Meta 2020
				$Metas2020Array=Potencial_BuscaDesempeno_2020($unico->rut);
        
        
      if($unico->rut=="13715891"){
      	//echo "<br>";
      	//print_r($array_resultados);
      	//echo "<br>";
      	//print_r($Metas2020Array);     	
      	//echo "<br>";

      }
      

        $cuenta_metas=0;    $cuenta_comp=0;    
        $suma_metas=0;      $suma_comp=0;     
        $promedio_metas=""; 
        $promedio_comp="";
       	$comp2019_80="";
       	$comp2019_20="";
       	$comp2018_80="";
       	$comp2018_20="";
       	$comp_2019="";
       	$comp_2018="";
       	

        //			h.d59 as meta_2016,      				h.d60 as meta_2017,     				h.d61 as meta_2018,     				h.d62 as meta_2015,     				h.d63 as meta_2019,

		    //if($array_resultados[0]->meta_2017>0)														{$cuenta_metas++; $suma_metas=$array_resultados[0]->meta_2017+$suma_metas;}
		    if($array_resultados[0]->meta_2018>0)														{$cuenta_metas++; $suma_metas=$array_resultados[0]->meta_2018+$suma_metas;}
		    if($array_resultados[0]->meta_2019>0)														{$cuenta_metas++; $suma_metas=$array_resultados[0]->meta_2019+$suma_metas;}
				if($Metas2020Array[0]->meta_2020>0)															{$cuenta_metas++; $suma_metas=$Metas2020Array[0]->meta_2020+$suma_metas;}
					
 


				//127 Mis Colaboradores - Actua como dueno 2019 + Mis Colaboradores - 130 Logra Objetivos Ambiciosos 2019
		    if($array_resultados[0]->competencia_2019<>'')										{$comp2019_80=($array_resultados[0]->d127+$array_resultados[0]->d130)/2;}
		    // 129 Mis Colaboradores - Se apasiona por el cliente 2019 + 128 Mis Colaboradores - Obtiene lo mejor de las personas 2019
		    if($array_resultados[0]->competencia_2019<>'')										{$comp2019_20=($array_resultados[0]->d129+$array_resultados[0]->d128)/2;}

//79 Mis colaboradores - Innovacion abierta 2018+  80 Mis colaboradores - Trabajo colaborativo 2018 + 77 Mis colaboradores - Agilidad en la ejecucion  2018
		    if($array_resultados[0]->competencia_miscolaboradores_2018<>'')		{$comp2018_80=($array_resultados[0]->d79+$array_resultados[0]->d80+$array_resultados[0]->d77)/3;}
		    if($array_resultados[0]->competencia_miscolaboradores_2018<>'')		{

//87 Mis colaboradores - Liderazgo integrador 2018 + 77 Mis colaboradores - Agilidad en la ejecucion  201 	
			    	if($array_resultados[0]->d87<>""){
			    		$comp2018_20=($array_resultados[0]->d87+$array_resultados[0]->d77)/2;	
			    	} else {
							$comp2018_20=$array_resultados[0]->d77;		    		
			    	}
		    	
		    	}
 
 				if($array_resultados[0]->competencia_2019<>'')										{$comp_2019=round(0.8*$comp2019_80+$comp2019_20*0.2,2); $suma_comp=$suma_comp+$comp_2019; $cuenta_comp++;}
 				
 				//d98
 				if($array_resultados[0]->competencia_miscolaboradores_2018<>'')		{$comp_2018=round(0.8*$comp2018_80+$comp2018_20*0.2,2); $suma_comp=$suma_comp+$comp_2018; $cuenta_comp++;}
 				
 				//print_r($Metas2020Array);
 	
 				
 				
 				if($Metas2020Array[0]->promedio<>'')		{
 					$comp2020_80=($Metas2020Array[0]->acd+$Metas2020Array[0]->lob)/2;
 					$comp2020_20=($Metas2020Array[0]->omp+$Metas2020Array[0]->sac)/2;
 					$comp_2020=round(0.8*$comp2020_80+$comp2020_20*0.2,2);
 					
 					$cuenta_comp++; $suma_comp=$comp_2020+$suma_comp;
 					}
		
		
			


        $promedio_metas         =       $suma_metas/$cuenta_metas;
        $promedio_comp         	=       $suma_comp/$cuenta_comp;

      if($unico->rut=="13715891"){
							//echo "<br>comp 2020 $comp_2020, Comp 2019 $comp_2019, comp 2018, $comp_2018, Competencias $cuenta_comp $suma_comp, Promedio $promedio_comp";
 	
			}

      if($unico->rut=="13715891"){
							//echo "<br>Metas $cuenta_metas $suma_metas, Promedio $promedio_metas";
 	
			}



				$potencial_matriz=Potencial_Matriz_Box_Potencial($promedio_metas, $promedio_comp);
     
        //print_r($potencial_matriz);
				$meta                   =   $potencial_matriz[0];
				$meta_txt               =   $potencial_matriz[1];
				$competencia            =   $potencial_matriz[2];
				$competencia_txt        =   $potencial_matriz[3];
				$box_propuesta          =   $potencial_matriz[4];
				$box_propuesta_txt      =   $potencial_matriz[5];
				
				Potencial_Update_data_tbl_bci($promedio_metas,$promedio_comp,$box_propuesta,$unico->rut);

        //$array_nuevos_cuadrantes=BuscaPotencialActualizado($array_resultados[0]->id, $id_empresa);
        //print_r($array_nuevos_cuadrantes);
        //if($array_nuevos_cuadrantes<>''){
           //$box_propuesta_txt= Potencial_Matriz_Box_Nuevo_Propuesta($array_nuevos_cuadrantes);
        //}
        
        if($cuenta_metas==0){
        	$meta_txt="<center><br><div class='txt_azul_box_v3_SM'>Sin Información de Metas</div></center>";	
        } 
      
        if($cuenta_comp==0){
        	$competencia_txt="<center><br><div class='txt_azul_box_v3_SM'>Sin Información de Competencias</div></center>";	
        } 

      	
      	if($cuenta_metas==0 or $cuenta_comp==0){
      	$box_propuesta_txt	="<center><br><div class='txt_azul_box_v3_SM'>Sin Propuesta de Cuadrante</div></center>";	
      	}
      	
        
    		$box_anterior_txt= Potencial_Matriz_Box_Nuevo_Propuesta($array_resultados[0]->propuesta_anterior);
        $row_lsita = str_replace("{ID}",            $array_resultados[0]->id, $row_lsita);
        $row_lsita = str_replace("{ID_COMITE}",     Encodear3($id_comite), $row_lsita);
        $row_lsita = str_replace("{PERFIL}",        $perfil, $row_lsita);

        $row_lsita = str_replace("{META}",          $meta_txt, $row_lsita);
        $row_lsita = str_replace("{COMPETENCIA}",   $competencia_txt, $row_lsita);
        $row_lsita = str_replace("{BOX_PROPUESTA}", $box_propuesta_txt, $row_lsita);
        
    	   //     				h.d103 as cuadrante_actual,
	     	//			h.d104 as fecha_cuadrante_actual,
  	   	//			h.d105 as cuadrante_anterior,
     		//		h.d106 as meses_cuadrante_anterior,
        
        $hoy   = date('Y-m-d');
        //echo "<br>hoy $hoy,  fecha_cuadrante ".$array_resultados[0]->fecha_cuadrante_actual;
        
				//verifica si hay info en tbl_potencial_cuadrantes
				$array_info_actual_potencial_cuadrantes=Potencial_Cuadrantes_Data($unico->rut);


        $box_propuesta_lider_txt= Potencial_Matriz_Box_Nuevo_Propuesta($array_info_actual_potencial_cuadrantes[0]->cuadrante_2020_lider);
     
     if($array_comite_row[0]->comite_cerrado=="SI"){
     	
     	
     	  $row_lsita = str_replace("{BOX_PROPUESTA_LIDER}", "", $row_lsita);
    } else {
    	
     	$CheckCerrado=Potencial_Check_Mapeado_Cerrado($unico->rut);
     	if($CheckCerrado>0){
    	  $row_lsita = str_replace("{BOX_PROPUESTA_LIDER}", "", $row_lsita);
     		
     	} else {
    	  $row_lsita = str_replace("{BOX_PROPUESTA_LIDER}", $box_propuesta_lider_txt, $row_lsita);
     		
     	}
    	
    	
    }
      


				//print_r($array_info_actual_potencial_cuadrantes);
      	if($array_info_actual_potencial_cuadrantes[0]->cuadrante_2020<>""){
      		
      		$array_resultados[0]->cuadrante_anterior			= $array_resultados[0]->cuadrante_actual;
      		$array_resultados[0]->fecha_cuadrante_actual	=	$array_info_actual_potencial_cuadrantes[0]->fecha_cuadrante_2020;
      		$array_resultados[0]->cuadrante_actual				= $array_info_actual_potencial_cuadrantes[0]->cuadrante_2020;
      		
      	}  
        
        $ts1 =strtotime($array_resultados[0]->fecha_cuadrante_actual); 
				$ts2 = strtotime($hoy); 
				$year1 = date('Y', $ts1); 
				$year2 = date('Y', $ts2); 
				$month1 = date('m', $ts1); $month2 = date('m', $ts2); 
				$meses_actual = (($year2 - $year1) * 12) + ($month2 - $month1) ;
				
        $cuadrante_actual=Potencial_Matriz_Box_Nuevo_Propuesta($array_resultados[0]->cuadrante_actual);
				if($cuadrante_actual==""){ $meses_actual="";}   else {$meses_actual=$meses_actual. " meses";}   
				
				//echo "<br> $cuadrante_actual $meses_actual";
				
				  
				if($cuadrante_actual==""){
      		$cuadrante_actual	="<center><br><div class='txt_azul_box_v3_SM'>Sin Cuadrante Actual</div></center>";	
      	}

        $cuadrante_anterior=Potencial_Matriz_Box_Nuevo_Propuesta($array_resultados[0]->cuadrante_anterior);
				if($cuadrante_anterior==""){ $meses_anterior="";} else {
					
					$meses_anterior=$array_resultados[0]->meses_cuadrante_anterior;
        	$meses_anterior = str_replace(".00", "", $meses_anterior);
					
					$meses_anterior=$meses_anterior. " meses";}
      	if($cuadrante_anterior==""){
      		$cuadrante_anterior	="<center><br><div class='txt_azul_box_v3_SM'>Sin Cuadrante Anterior</div></center>";	
      	}
      	
      	if($array_info_actual_potencial_cuadrantes[0]->cuadrante_2020<>""){
      						$meses_anterior="";
      						
      		        $ts1 =strtotime($array_resultados[0]->fecha_cuadrante_actual); 
									$ts2 = strtotime($hoy); 
									$year1 = date('Y', $ts1); 
									$year2 = date('Y', $ts2); 
									$month1 = date('m', $ts1); $month2 = date('m', $ts2); 
									$meses_actual = (($year2 - $year1) * 12) + ($month2 - $month1) ;
					      	$meses_anterior=$meses_actual. " meses";
					      	
					      	$meses_actual=$meses_actual. " meses";
      	}

        $row_lsita = str_replace("{BOX_ACTUAL}",  	$cuadrante_actual."<center><div class='txt_azul_box_v3_SM' 	style='    margin-top: -7px;'>
        ".$meses_actual."</div></center> ", $row_lsita);
        $row_lsita = str_replace("{BOX_ANTERIOR}",  $cuadrante_anterior."<center><div class='txt_azul_box_v3_SM' style='    margin-top: -7px;'>
        </div></center> ", $row_lsita);

        $row_lsita = str_replace("{FECHA}", $unico->fecha, $row_lsita);
        $row_lsita = str_replace("{LIDER}", $unico->nombre_lider, $row_lsita);
        $row_lsita = str_replace("{COLABORADORES}", $unico->num_colaboradores, $row_lsita);        
        $row_lsita = str_replace("{RUT_COL}", Encodear3($unico->rut), $row_lsita);
        $row_lsita = str_replace("{BOTON_VER_COMITE}", "<a href='?sw=potencial_comite&id_comite=".Encodear3($unico->id_comite)."' class='btn btn-info'><span class='blanco'>Ingresar</span></a>", $row_lsita);
        $boton_ver_editar_box   ="<button type='button' class='btn btn-link' data-toggle='modal' data-target='#".Encodear3($array_resultados[0]->rut)."'>
        <span class='azul_comite'><i class='fas fa-edit'></i></span></button>";
        
       if($perfil=="SOCIO DE NEGOCIO"){
        $row_lsita = str_replace("{BOTON_VER_EDITAR_BOX}", $boton_ver_editar_box, $row_lsita);
      } else {
      	$row_lsita = str_replace("{BOTON_VER_EDITAR_BOX}", $boton_ver_editar_box, $row_lsita);
      }


				//echo "<br>Line ".$unico->rut." ".$unico->nombre_completo." propuesta sistema ".$box_propuesta." lider ".$array_info_actual_potencial_cuadrantes[0]->cuadrante_2020_lider."<br>$box_propuesta_txt<br>";
				$Potencial_Baja_Igual_Sube=Potencial_Baja_Igual_Sube($box_propuesta, $array_info_actual_potencial_cuadrantes[0]->cuadrante_2020_lider);
				
				
				if($box_propuesta_txt=="<center><br><div class='txt_azul_box_v3_SM'>Sin Propuesta de Cuadrante</div></center>"){
					$Arreglo_Cambio_Lider_Vacio[$i_v]=utf8_encode($unico->nombre_completo);$i_v++;
				} else {
					//echo " ----> ".$Potencial_Baja_Igual_Sube;
					
					if($Potencial_Baja_Igual_Sube=="SUBE")			{	$Arreglo_Cambio_Lider_Sube[$i_s]			=utf8_encode($unico->nombre_completo);$i_s++;}
					if($Potencial_Baja_Igual_Sube=="MANTIENE")	{	$Arreglo_Cambio_Lider_Mantiene[$i_m]	=utf8_encode($unico->nombre_completo);$i_m++;}
					if($Potencial_Baja_Igual_Sube=="BAJA")			{	$Arreglo_Cambio_Lider_Baja[$i_b]			=utf8_encode($unico->nombre_completo);$i_b++;}
					if($Potencial_Baja_Igual_Sube=="VACIO")			{	$Arreglo_Cambio_Lider_Vacio[$i_v]			=utf8_encode($unico->nombre_completo);$i_v++;}
					
				}
				//echo "<br>perfil $perfil<br>";
        $row_lsita = str_replace("{BOTON_VER_FICHA}","<a href='?sw=potencial_ficha&rut_col=".Encodear3($unico->rut)."&id_comite=".Encodear3($id_comite)."' class='btn btn-link' >
        <span class='azul_comite'><i class='fas fa-user'></i> <span class='mt-comment-authorSM'> Ficha</span></span></a>", $row_lsita);

			  $row_lsita = str_replace("{BOTON_VER_FICHA_A_inicial}","<a href='?sw=potencial_ficha&rut_col=".Encodear3($unico->rut)."&id_comite=".Encodear3($id_comite)."'
			   class='btn btn-link' style='padding-left: 0px;    padding-left: 0px;text-align: left;padding-right: 0px;'>", $row_lsita);

			  $row_lsita = str_replace("{BOTON_VER_FICHA_B_final}","</a>", $row_lsita);



    }

    /*	
    		echo "<br>Sube<br>";    			print_r($Arreglo_Cambio_Lider_Sube);
    		echo "<br>Mantiene<br>";    	print_r($Arreglo_Cambio_Lider_Mantiene);
    		echo "<br>Baja<br>";    			print_r($Arreglo_Cambio_Lider_Baja);
    		echo "<br>Vacio<br>";    			print_r($Arreglo_Cambio_Lider_Vacio);	
    */
    
    foreach ($Arreglo_Cambio_Lider_Sube as $unS){
    	$row_sube.="<div>".$unS."</div>";
    }

    foreach ($Arreglo_Cambio_Lider_Mantiene as $unM){
    	$row_mantiene.="<div>".$unM."</div>";
    }

    foreach ($Arreglo_Cambio_Lider_Baja as $unB){
    	$row_baja.="<div>".$unB."</div>";
    }

    foreach ($Arreglo_Cambio_Lider_Vacio as $unV){
    	$row_vacio.="<div>".$unV."</div>";
    }

    $PRINCIPAL = str_replace("{LIDER_SUBEN}",         $row_sube,         $PRINCIPAL);
    $PRINCIPAL = str_replace("{LIDER_SEMANTIENEN}",   $row_mantiene,     $PRINCIPAL);
    $PRINCIPAL = str_replace("{LIDER_BAJAN}",         $row_baja,         $PRINCIPAL);
    $PRINCIPAL = str_replace("{LIDER_VACIO}",         $row_vacio,        $PRINCIPAL);
    
    $PRINCIPAL = str_replace("{MIS_COLABORADORES_COMITES_POTENCIAL}",         $row_lsita,         $PRINCIPAL);
    $PRINCIPAL = str_replace("{COLABORADORES_COMITE_POTENCIAL_TITULO}",  $potencial_titulo,  $PRINCIPAL);

    return ($PRINCIPAL);
}


function Potencial_Colaboradores_MiEquipo($PRINCIPAL, $tipo_accion, $rut_completo, $perfil, $id_empresa)
{
    $lista = Potencial_Colaboradores_MiEquipo_data($rut_completo, $perfil, $id_empresa);

    $num_cols    =   count($lista);
    if($num_cols>0){
        $potencial_titulo="
<div class=''>
    <strong>
        <div class='col-sm-4 txt_title_pot'>Colaborador</div>
        <div class='col-sm-7 txt_title_pot'>Acciones de Desarrollo</div>
        <div class='col-sm-1 txt_title_pot'></div>
    </strong>
</div>";
    }   else   {
        $potencial_titulo="
<div class=''><br>
    <div class='col-sm-12 txt_title_pot_hohay'><center>[ No tienes colaboradores a tu cargo ]</center></div>
    					<br>
</div>";

    }
		
		$i_v=0;$i_s=0;$i_m=0;$i_b=0;
			

    foreach($lista as $unico) {

        $row_lsita.= file_get_contents("views/potencial/" . $id_empresa . "_potencial_row_colaboradores_acciones_desarrollo.html");
        $row_lsita = str_replace("{RUT}",           	utf8_encode($unico->rut), $row_lsita);
        $row_lsita = str_replace("{COLABORADOR}",   	utf8_encode($unico->d7)." ".utf8_encode($unico->d8)." ".utf8_encode($unico->d9), $row_lsita);
        $row_lsita = str_replace("{CARGO_COL}",   		utf8_encode($unico->d15), $row_lsita);
        $row_lsita = str_replace("{NOMBRE_LIDER}",  	utf8_encode($unico->nombre_lider), $row_lsita);
        $row_lsita = str_replace("{AVATAR}",   VerificaFotoPersonal($unico->rut), $row_lsita);

       	$row_lsita = str_replace("{BOTON_VER_FICHA}","<a href='?sw=potencial_ficha&rut_col=".Encodear3($unico->rut)."&id_comite=".Encodear3($id_comite)."&accionesDesarrollo=1' class='btn btn-link' >
       		<span class='azul_comite'><i class='fas fa-user'></i> <span class='mt-comment-authorSM'> Ficha</span></span></a>", $row_lsita);
		  	$row_lsita = str_replace("{BOTON_VER_FICHA_A_inicial}","<a href='?sw=potencial_ficha&rut_col=".Encodear3($unico->rut)."&id_comite=".Encodear3($row_lsita)."&accionesDesarrollo=1'
	   			class='btn btn-link' style='padding-left: 0px;    padding-left: 0px;text-align: left;padding-right: 0px;padding: 0px;'>", $row_lsita);
		  	$row_lsita = str_replace("{BOTON_VER_FICHA_B_final}","</a>", $row_lsita);					

					$AD=Potencial_Busca_Acciones_Desarrollo_Dado_Rut($unico->rut);
					$row_ad="";
					$AccDes="";
					foreach ($AD as $unicoAD){
						
							$plan					=utf8_encode($unicoAD->plan);
							$fundamento		=utf8_encode($unicoAD->fundamento);
							$estado				=utf8_encode($unicoAD->estado);
							$fecha_estado	=utf8_encode($unicoAD->fecha_estado);
							$periodo			=utf8_encode($unicoAD->periodo);
			

			if($unicoAD->estado=="Realizado"){
				$estado="<div class='badge badge-success'><span style='color:#fff'>Realizado</span></div>";
			}  elseif($unicoAD->estado=="Suspendido"){
				$estado="<div class='badge badge-danger'><span style='color:#fff'>Suspendido</span></div>";
			}   elseif($unicoAD->estado=="En Proceso"){
				$estado="<div class='badge badge-danger'><span style='color:#fff'>En Proceso</span></div>";
			} 
			elseif($unicoAD->estado=="No Iniciado"){
				$estado="<div class='badge badge-warning'><span style='color:#fff'>No Iniciado</span></div>";
			}
			 elseif($unicoAD->estado=="No Realizado"){
				$estado="<div class='badge badge-danger'><span style='color:#fff'>No Realizado</span></div>";
			} else {
				$estado="<div class='badge badge-gray'><span style='color:#fff'>Sin Información</span></div>";
			
			}
			
					$AccDes.="
	
					  				
																<div class='col-md-7'>
																	<div class=''> 

																		<div class='badge badge-gray'>Periodo: ".utf8_encode($unicoAD->periodo)."</div><br>
																		<div class='badge badge-gray'>".utf8_encode($unicoAD->plan)."</div><br>
																		<div >".($unicoAD->fundamento)."</div>
																	</div>
																</div>
																<div class='col-md-2'><div class=''> <center>".utf8_encode($estado)."
																<br><span style='    font-size: 10px;color: #337ab7;'>".utf8_encode($unicoAD->fecha_estado)." <br> ".($unicoAD->comentario_estado)."</span>
																</center>
																
																 </div></div>
																<div class='col-md-3'><div class=''>  
																
																
							<button type='button' class='btn btn-link' data-toggle='modal' data-target='#exampleAD_Modal_".$unicoAD->id."' style='font-size: 12px;'>
  							<span style='color: #337ab7;'>		Editar Estado <i class='fas fa-pen'></i> </span>
							</button>																


							<div class='modal fade' id='exampleAD_Modal_".$unicoAD->id."' tabindex='-1' role='dialog' aria-labelledby='exampleModalLabel' aria-hidden='true'>
							  <div class='modal-dialog' role='document'>
							    <div class='modal-content'>
							      <div class='modal-body'>
							       	<br>Editar Estado de Acci&oacute;n de Desarrollo:  <strong>".utf8_encode($unicoAD->plan)."</strong>
							       	<br><br>
							       	
							       	<form id='".$unicoAD->id."' name='".$unicoAD->id."' action='' method='post'>
							       	<div class='txt_2020'>Estado</div>
							       		<select name='estado' class='form form-control' required>
							       				<option value='".$unicoAD->estado."'>".$unicoAD->estado."</option>
							       				<option value='Realizado'>Realizado</option>
							       				<option value='Suspendido'>Suspendido</option>
							       				<option value='En Proceso'>En Proceso</option>
							       				<option value='No Iniciado'>No Iniciado</option>

							       		</select>
							       		<div class='txt_2020'>Fundamento / Comentarios</div>
							       		<input type='text' name='fundamento' id='fundamento'  class='form form-control' required value='".$unicoAD->fundamento."'>
							       		<input type='hidden' value='".Encodear3($unicoAD->id)."' name='idEdEst'>
							       		<br><input type='submit' class='btn btn-info' name='editar' value='Actualizar Estado'>
							       	</form>
							      </div>
							    </div>
							  </div>
							</div>
																
																</div></div>
															 <div class='col-md-12'><div class=''><hr> </div></div>
	";	}
        $row_lsita = str_replace("{ACCIONES_DESARROLLO}",           	utf8_encode($AccDes), $row_lsita);


		
		}


    $PRINCIPAL = str_replace("{MIS_COLABORADORES_COMITES_POTENCIAL_MIEQUIPO}",         $row_lsita,         $PRINCIPAL);
    $PRINCIPAL = str_replace("{COLABORADORES_COMITE_POTENCIAL_TITULO_MIEQUIPO}",  $potencial_titulo,  $PRINCIPAL);

    return ($PRINCIPAL);
}

function Potencial_Matriz_Box_Nuevo_Propuesta($id_box_propuesta){
if($id_box_propuesta ==  "10")           {$box_propuesta="10"; $txt_box_propuesta="<div class='alert alert-info'>5+</div>";}

if($id_box_propuesta ==  "5")           {$box_propuesta="5"; $txt_box_propuesta="<div class='alert alert-info'>5</div>";}
if($id_box_propuesta ==  "4")           {$box_propuesta="4"; $txt_box_propuesta="<div class='alert alert-warning'>4</div>";}
if($id_box_propuesta ==  "6")           {$box_propuesta="6"; $txt_box_propuesta="<div class='alert alert-success'>6</div>";}

if($id_box_propuesta ==  "8")           {$box_propuesta="8"; $txt_box_propuesta="<div class='alert alert-warning'>8</div>";}
if($id_box_propuesta ==  "7")           {$box_propuesta="7"; $txt_box_propuesta="<div class='alert alert-danger'>7</div>";}
if($id_box_propuesta ==  "9")           {$box_propuesta="9"; $txt_box_propuesta="<div class='alert alert-info'>9</div>";}

if($id_box_propuesta ==  "2")           {$box_propuesta="2"; $txt_box_propuesta="<div class='alert alert-success'>2</div>";}
if($id_box_propuesta ==  "1")           {$box_propuesta="1"; $txt_box_propuesta="<div class='alert alert-info'>1</div>";}
if($id_box_propuesta ==  "3")           {$box_propuesta="3"; $txt_box_propuesta="<div class='alert alert-success'>3</div>";}

if($id_box_propuesta ==  "5+")           {$box_propuesta="5+"; $txt_box_propuesta="<div class='alert alert-info'>5+</div>";}

return  $txt_box_propuesta;
}
function Potencial_Matriz_Box_Nuevo_Propuesta_Step($id_box_propuesta){
if($id_box_propuesta ==  "10")           {$box_propuesta="10"; $txt_box_propuesta="<div class='step step_info'>5+</div>";}


if($id_box_propuesta ==  "5")           {$box_propuesta="5"; $txt_box_propuesta="<div class='step step_info'>5</div>";}
if($id_box_propuesta ==  "4")           {$box_propuesta="4"; $txt_box_propuesta="<div class='step step_warning'>4</div>";}
if($id_box_propuesta ==  "6")           {$box_propuesta="6"; $txt_box_propuesta="<div class='step step_success'>6</div>";}

if($id_box_propuesta ==  "8")           {$box_propuesta="8"; $txt_box_propuesta="<div class='step step_warning'>8</div>";}
if($id_box_propuesta ==  "7")           {$box_propuesta="7"; $txt_box_propuesta="<div class='step step-danger'>7</div>";}
if($id_box_propuesta ==  "9")           {$box_propuesta="9"; $txt_box_propuesta="<div class='step step_info'>9</div>";}

if($id_box_propuesta ==  "2")           {$box_propuesta="2"; $txt_box_propuesta="<div class='step step_success'>2</div>";}
if($id_box_propuesta ==  "1")           {$box_propuesta="1"; $txt_box_propuesta="<div class='step step_info'>1</div>";}
if($id_box_propuesta ==  "3")           {$box_propuesta="3"; $txt_box_propuesta="<div class='step step_success'>3</div>";}

if($id_box_propuesta ==  "5+")           {$box_propuesta="5+"; $txt_box_propuesta="<div class='step step_info'>5+</div>";}

return  $txt_box_propuesta;
}

function Potencial_Matriz_Box_Potencial($metas_promedio, $competencias_promedio){

//echo "<br> Potencial_Matriz_Box_Potencial metas $metas_promedio, comp $competencias_promedio";

if($metas_promedio<0.9)                                 {$meta="No cumple";             $txt_meta="<div class='alert alert-danger'>No cumple</div>";}
elseif($metas_promedio<1.2 and $metas_promedio>=0.9)    {$meta="Cumple";                $txt_meta="<div class='alert alert-info'>Cumple</div>";}
elseif($metas_promedio>=1.2)                            {$meta="Sobrecumple";           $txt_meta="<div class='alert alert-success'>Sobrecumple</div>";}
else                                                    {$meta="Sin dato Metas";        $txt_meta="";}


//echo "<br>METAS dato $metas_promedio METAS  $meta    $txt_meta";

if($competencias_promedio<2.6)                                          {$competencia="Bajo";       $txt_competencia="<div class='alert alert-danger'>Bajo</div>";}
elseif($competencias_promedio<3.5 and $competencias_promedio>=2.6)      {$competencia="Esperado";   $txt_competencia="<div class='alert alert-info'>Esperado</div>";}
elseif($competencias_promedio>=3.5)                                     {$competencia="Alto";       $txt_competencia="<div class='alert alert-success'>Alto</div>";}
else                                                                    {$competencia="Sin dato Competencias";  $txt_competencia="";}

//echo "<br>COMP dato $competencias_promedio $competencia    $txt_competencia";

if($competencia ==  "Esperado"  and  $meta   == "Cumple")               {$box_propuesta="5"; $txt_box_propuesta="<div class='alert alert-info'>5</div>";}
if($competencia ==  "Esperado"  and  $meta   == "No cumple")            {$box_propuesta="4"; $txt_box_propuesta="<div class='alert alert-warning'>4</div>";}
if($competencia ==  "Esperado"  and  $meta   == "Sobrecumple")          {$box_propuesta="6"; $txt_box_propuesta="<div class='alert alert-success'>6</div>";}

if($competencia ==  "Bajo"      and  $meta   == "Cumple")               {$box_propuesta="8"; $txt_box_propuesta="<div class='alert alert-warning'>8</div>";}
if($competencia ==  "Bajo"      and  $meta   == "No cumple")            {$box_propuesta="7"; $txt_box_propuesta="<div class='alert alert-danger'>7</div>";}
if($competencia ==  "Bajo"      and  $meta   == "Sobrecumple")          {$box_propuesta="9"; $txt_box_propuesta="<div class='alert alert-info'>9</div>";}

if($competencia ==  "Alto"      and  $meta   == "Cumple")               {$box_propuesta="2"; $txt_box_propuesta="<div class='alert alert-success'>2</div>";}
if($competencia ==  "Alto"      and  $meta   == "No cumple")            {$box_propuesta="1"; $txt_box_propuesta="<div class='alert alert-info'>1</div>";}
if($competencia ==  "Alto"      and  $meta   == "Sobrecumple")          {$box_propuesta="3"; $txt_box_propuesta="<div class='alert alert-success'>3</div>";}



$arreglo[0]=$meta;
$arreglo[1]=$txt_meta;

$arreglo[2]=$competencia;
$arreglo[3]=$txt_competencia;

$arreglo[4]=$box_propuesta;
$arreglo[5]=$txt_box_propuesta;

return  $arreglo;
}


function Potencial_Mis_Comites($PRINCIPAL, $rut, $perfil, $id_empresa)
{
		$Usua=DatosUsuario_($rut, $id_empresa);
    $lista = Potencial_Mis_Comites_data($id_empresa, $rut, $perfil, $Usua[0]->jefe);
    //print_r($lista);
    
$nomuestracabeceras="";
if($perfil=="VISUALIZADOR"){
	$nomuestracabeceras="1";
}    
    
    if($nomuestracabeceras=="1"){
    	$lider="";
    	$colab="";
    	
    } else {
    	$lider1="LIDER";
    	$colab="COLAB.";
    }
    $num_comites    =   count($lista);
    //echo "<br>num_comites $num_comites<br>";
    if($num_comites>0){
        $potencial_titulo="
        <br>
<div class=''>
    <strong>
        <div class='col-sm-4 txt_title_pot'>COMITE</div>
        <div class='col-sm-2 txt_title_pot'>FECHA REALIZACION</div>
        <div class='col-sm-3 txt_title_pot'>".$lider1."</div>
        <div class='col-sm-1 txt_title_pot'>".$colab."</div>
        <div class='col-sm-2 txt_title_pot'>GESTIONAR</div>
    </strong>
</div>";
    }   else   {
        $potencial_titulo="
<div class='row'>
    <div class='col-sm-12 txt_title_pot'><br><br><center>[ No hay comit&eacute;s creados ]</center></div>
</div>";

    }

    foreach($lista as $unico) {
			$num_colaboradores=0;
    if($perfil=="LIDER")    {   $num_colaboradores=Potencial_Busca_Cantidad_Colaboradores_lider($rut, $unico->id_comite, $id_empresa);
                $Usua=DatosUsuario_($rut, $id_empresa);
                $lider= $Usua[0]->nombre_completo;
    }
    
    if($perfil=="SOCIO DE NEGOCIO")    {   $num_colaboradores=Potencial_Busca_Cantidad_Colaboradores_socio($rut, $unico->id_comite, $id_empresa);


			$lider="";
      $array_lideres=PotencialBuscaLideres($unico->id_comite, $id_empresa);
      //print_r($array_lideres);
      foreach ($array_lideres as $unlid){
          $nombr_l=DatosUsuario_($unlid->rut_lider, $id_empresa);
          $lider.=$nombr_l[0]->nombre_completo."<br>";
      }
    }
        //echo "<br>hola ".$unico->nombre;
        $row_lsita.= file_get_contents("views/potencial/" . $id_empresa . "_potencial_row_comites.html");
        //echo "<br>views/potencial/" . $id_empresa . "_potencial_row_comites.html";
        $row_lsita = str_replace("{ID_COMITE}", utf8_encode($unico->id_comite), $row_lsita);
        $row_lsita = str_replace("{COMITE}", utf8_encode($unico->nombre), $row_lsita);
        $row_lsita = str_replace("{FECHA}", $unico->fecha_comite, $row_lsita);
        $row_lsita = str_replace("{LIDER}", utf8_encode($lider), $row_lsita);
        $row_lsita = str_replace("{COLABORADORES}", $num_colaboradores, $row_lsita);
        $row_lsita = str_replace("{BOTON_VER_COMITE}", "<a href='?sw=potencial_comite&id_comite=".Encodear3($unico->id_comite)."' class='btn btn-success'>
        	<span class='blanco'>Ingresar</span></a>", $row_lsita);
        
        if($perfil=="SOCIO DE NEGOCIO")    { 
        	$row_lsita = str_replace("{BOTON_ELIMINAR_COMITE}", "<a href='?sw=potencial&id_del=".Encodear3($unico->id_comite)."' class='btn btn-link'>
        	<span class='azul_comite'><i class='fas fa-trash-alt'></i></span></a>", $row_lsita);
      	}else {
      		$row_lsita = str_replace("{BOTON_ELIMINAR_COMITE}", "", $row_lsita);
      	}
    }
    //echo  "$row_lsita";
    $PRINCIPAL = str_replace("{MIS_COMITES_POTENCIAL}",         $row_lsita,         $PRINCIPAL);
    $PRINCIPAL = str_replace("{MIS_COMITES_POTENCIAL_TITULO}",  $potencial_titulo,  $PRINCIPAL);

    return ($PRINCIPAL);
}

function Potencial_Mis_Comites_estado_activo($PRINCIPAL, $rut, $perfil, $id_empresa, $comite_cierre)
{		
		$Usua=DatosUsuario_($rut, $id_empresa);
    $lista = Potencial_Mis_Comites_data($id_empresa, $rut, $perfil, $Usua[0]->jefe);
    
    //echo "<br><br>";	    	print_r($lista);    echo "<br><br>";
    //echo "<br>comite_cierre $comite_cierre<br>";
    
		$nomuestracabeceras="";
		if($perfil=="VISUALIZADOR"){
			$nomuestracabeceras="1";
		}    
    
    if($nomuestracabeceras=="1"){
    	$lider="";
    	$colab="";
    	
    } else {
    	$lider1="LIDER";
    	$colab="COLAB.";
    }
    $num_comites    =   count($lista);
    //echo "<br>num_comites $num_comites<br>";
    if($num_comites>0){
        $potencial_titulo="
        <br>
					<div class=''>
					    <strong>
					        <div class='col-sm-4 txt_title_pot'>COMITE</div>
					        <div class='col-sm-2 txt_title_pot'>FECHA REALIZACION</div>
					        <div class='col-sm-3 txt_title_pot'>".$lider1."</div>
					        <div class='col-sm-1 txt_title_pot'>".$colab."</div>
					        <div class='col-sm-2 txt_title_pot'>GESTIONAR</div>
					    </strong>
					</div>";
    }   else   {
        $potencial_titulo="
					<div class='row'>
					    <div class='col-sm-12 txt_title_pot'><br><br><center>[ No hay comit&eacute;s creados ]</center></div>
					</div>";
    }

    foreach($lista as $unico) {
			$num_colaboradores=0;

			$array_comite=Potencial_Comites_data($unico->id_comite,$id_empresa);
			//echo "<br>";				print_r($array_comite);			echo "<br>";
			
			$id_comite_cerrado = $array_comite[0]->comite_cerrado;
			//echo "<br>IdComite ".$unico->id_comite." comite cerrado ".$comite_cierre." id_comite_cerrado ".$id_comite_cerrado;
			
			if($comite_cierre=="cerrado" and $id_comite_cerrado<>"SI"){
				continue;
			}

			if($comite_cierre=="activo" and $id_comite_cerrado=="SI"){
				continue;
			}
			
    if($perfil=="LIDER")    {   $num_colaboradores=Potencial_Busca_Cantidad_Colaboradores_lider($rut, $unico->id_comite, $id_empresa);
                $Usua=DatosUsuario_($rut, $id_empresa);
                $lider= $Usua[0]->nombre_completo;
    }
    
    if($perfil=="SOCIO DE NEGOCIO")    {   $num_colaboradores=Potencial_Busca_Cantidad_Colaboradores_socio($rut, $unico->id_comite, $id_empresa);


			$lider="";
      $array_lideres=PotencialBuscaLideres($unico->id_comite, $id_empresa);
      //print_r($array_lideres);
      foreach ($array_lideres as $unlid){
          $nombr_l=DatosUsuario_($unlid->rut_lider, $id_empresa);
          $lider.=$nombr_l[0]->nombre_completo."<br>";
      }
    }
        //echo "<br>hola ".$unico->nombre;
        $row_lsita.= file_get_contents("views/potencial/" . $id_empresa . "_potencial_row_comites.html");
        //echo "<br>views/potencial/" . $id_empresa . "_potencial_row_comites.html";
        $row_lsita = str_replace("{ID_COMITE}", utf8_encode($unico->id_comite), $row_lsita);
        $row_lsita = str_replace("{COMITE}", utf8_encode($unico->nombre), $row_lsita);
        $row_lsita = str_replace("{FECHA}", $unico->fecha_comite, $row_lsita);
        $row_lsita = str_replace("{LIDER}", utf8_encode($lider), $row_lsita);
        
        
        $row_lsita = str_replace("{COLABORADORES}", $num_colaboradores, $row_lsita);

        $UsuaCreadorComite=DatosUsuario_($unico->socio, $id_empresa);
        $row_lsita = str_replace("{POR_CREADOR_COMITE}", $UsuaCreadorComite[0]->nombre_completo, $row_lsita);
        
        $row_lsita = str_replace("{BOTON_VER_COMITE}", "<a href='?sw=potencial_comite&id_comite=".Encodear3($unico->id_comite)."' class='btn btn-success'>
        	<span class='blanco'>Ingresar</span></a>", $row_lsita);
        
        if($perfil=="SOCIO DE NEGOCIO")    { 
        	$row_lsita = str_replace("{BOTON_ELIMINAR_COMITE}", "<a href='?sw=potencial&id_del=".Encodear3($unico->id_comite)."' class='btn btn-link'>
        	<span class='azul_comite'><i class='fas fa-trash-alt'></i></span></a>", $row_lsita);
      	}else {
      		$row_lsita = str_replace("{BOTON_ELIMINAR_COMITE}", "", $row_lsita);
      	}
    }
    //echo  "$row_lsita";
    
    if($comite_cierre=="activo"){
    	$PRINCIPAL = str_replace("{MIS_COMITES_POTENCIAL}",         $row_lsita,         $PRINCIPAL);
    	$PRINCIPAL = str_replace("{MIS_COMITES_POTENCIAL_TITULO}",  $potencial_titulo,  $PRINCIPAL);

    	
    } else {
    	$PRINCIPAL = str_replace("{MIS_COMITES_POTENCIAL}",         $row_lsita,         $PRINCIPAL);
    	$PRINCIPAL = str_replace("{MIS_COMITES_POTENCIAL}",  				$potencial_titulo,  $PRINCIPAL);

    }

    return ($PRINCIPAL);
}

function Potencial_Mis_Comites_estado_cierre($PRINCIPAL, $rut, $perfil, $id_empresa, $comite_cierre)
{
		$Usua=DatosUsuario_($rut, $id_empresa);
    $lista = Potencial_Mis_Comites_data($id_empresa, $rut, $perfil, $Usua[0]->jefe);
    //print_r($lista);
    //echo "<br>comite_cierre $comite_cierre<br>";
    
		$nomuestracabeceras="";
		if($perfil=="VISUALIZADOR"){
			$nomuestracabeceras="1";
		}    
    
    if($nomuestracabeceras=="1"){
    	$lider="";
    	$colab="";
    	
    } else {
    	$lider1="LIDER";
    	$colab="COLAB.";
    }
    $num_comites    =   count($lista);
    //echo "<br>num_comites $num_comites<br>";
    if($num_comites>0){
        $potencial_titulo="
        <br>
<div class=''>
    <strong>
        <div class='col-sm-4 txt_title_pot'>COMITE</div>
        <div class='col-sm-2 txt_title_pot'>FECHA REALIZACION</div>
        <div class='col-sm-3 txt_title_pot'>".$lider1."</div>
        <div class='col-sm-1 txt_title_pot'>".$colab."</div>
        <div class='col-sm-2 txt_title_pot'>GESTIONAR</div>
    </strong>
</div>";
    }   else   {
        $potencial_titulo="
<div class='row'>
    <div class='col-sm-12 txt_title_pot'><br><br><center>[ No hay comit&eacute;s creados ]</center></div>
</div>";

    }

    foreach($lista as $unico) {
			$num_colaboradores=0;

			$array_comite=Potencial_Comites_data($unico->id_comite,$id_empresa);
			//echo "<br>";				print_r($array_comite);			echo "<br>";exit();
			
			$id_comite_cerrado = $array_comite[0]->comite_cerrado;
			//echo "<br>IdComite ".$unico->id_comite." comite cerrado ".$comite_cierre." id_comite_cerrado ".$id_comite_cerrado;
			
			if($comite_cierre=="cerrado" and $id_comite_cerrado<>"SI"){
				continue;
			}

			if($comite_cierre=="activo" and $id_comite_cerrado=="SI"){
				continue;
			}
			
    if($perfil=="LIDER")    {   $num_colaboradores=Potencial_Busca_Cantidad_Colaboradores_lider($rut, $unico->id_comite, $id_empresa);
                $Usua=DatosUsuario_($rut, $id_empresa);
                $lider= $Usua[0]->nombre_completo;
    }
    
    if($perfil=="SOCIO DE NEGOCIO")    {   $num_colaboradores=Potencial_Busca_Cantidad_Colaboradores_socio($rut, $unico->id_comite, $id_empresa);


			$lider="";
      $array_lideres=PotencialBuscaLideres($unico->id_comite, $id_empresa);
      //print_r($array_lideres);
      foreach ($array_lideres as $unlid){
          $nombr_l=DatosUsuario_($unlid->rut_lider, $id_empresa);
          $lider.=$nombr_l[0]->nombre_completo."<br>";
      }
    }
        //echo "<br>hola ".$unico->nombre;
        $row_lsita.= file_get_contents("views/potencial/" . $id_empresa . "_potencial_row_comites.html");
        //echo "<br>views/potencial/" . $id_empresa . "_potencial_row_comites.html";
        $row_lsita = str_replace("{ID_COMITE}", utf8_encode($unico->id_comite), $row_lsita);
        $row_lsita = str_replace("{COMITE}", utf8_encode($unico->nombre), $row_lsita);
        $row_lsita = str_replace("{FECHA}", $unico->fecha_comite, $row_lsita);
        $row_lsita = str_replace("{LIDER}", utf8_encode($lider), $row_lsita);
        $row_lsita = str_replace("{COLABORADORES}", $num_colaboradores, $row_lsita);
        
        $UsuaCreadorComite=DatosUsuario_($unico->socio, $id_empresa);
        $row_lsita = str_replace("{POR_CREADOR_COMITE}", $UsuaCreadorComite[0]->nombre_completo, $row_lsita);
        
        $row_lsita = str_replace("{BOTON_VER_COMITE}", "<a href='?sw=potencial_comite&id_comite=".Encodear3($unico->id_comite)."' class='btn btn-success'>
        	<span class='blanco'>Ingresar</span></a>", $row_lsita);
        
        if($perfil=="SOCIO DE NEGOCIO")    { 
        	$row_lsita = str_replace("{BOTON_ELIMINAR_COMITE}", "<a href='?sw=potencial&id_del=".Encodear3($unico->id_comite)."' class='btn btn-link'>
        	<span class='azul_comite'><i class='fas fa-trash-alt'></i></span></a>", $row_lsita);
      	}else {
      		$row_lsita = str_replace("{BOTON_ELIMINAR_COMITE}", "", $row_lsita);
      	}
    }
    //echo  "$row_lsita";
    

    	$PRINCIPAL = str_replace("{MIS_COMITES_POTENCIAL2}",         $row_lsita,         $PRINCIPAL);
    	$PRINCIPAL = str_replace("{MIS_COMITES_POTENCIAL_TITULO2}",  $potencial_titulo,  $PRINCIPAL);

 

    return ($PRINCIPAL);
}


function ColocaMetodologias($rut, $perfil, $id_empresa){
    $datos=DatosMEtodologia($id_empresa, $rut);
    if(count($datos)>0){
        foreach($datos as $dat){
             if($perfil=="jefe") {
             $total_datos_ingresados.= file_get_contents("views/assessment/" . $id_empresa . "_row_metodologia_lectura.html");

                 } else {
             $total_datos_ingresados.= file_get_contents("views/assessment/" . $id_empresa . "_row_metodologia.html");

                 }
            $total_datos_ingresados = str_replace("{METODOLOGIA}", ($dat->metodologia)." ".($dat->metodologia_otro), $total_datos_ingresados);

            $total_datos_ingresados = str_replace("{ID_ENCODEADO}", Encodear3($dat->id), $total_datos_ingresados);
            $total_datos_ingresados = str_replace("{TIPO_BLOQUE}", Encodear3("metodologia"), $total_datos_ingresados);


        }

    }else{

    }

    return($total_datos_ingresados);
}
function array_sort_by_column($arr, $col, $dir = SORT_ASC) {
    $sort_col = array();
    foreach ($arr as $key=> $row) {
        $sort_col[$key] = $row->$col;
    }

    array_multisort($sort_col, $dir, $arr);
}

function array_orderby()
{
    $args = func_get_args();
    $data = array_shift($args);
    foreach ($args as $n => $field) {
        if (is_string($field)) {
            $tmp = array();
            foreach ($data as $key => $row)
                $tmp[$key] = $row[$field];
            $args[$n] = $tmp;
            }
    }
    $args[] = &$data;
    call_user_func_array('array_multisort', $args);
    return array_pop($args);
}

function Skill_terminado_Challenge($rut, $id_cargo, $id_empresa){
                 $cuenta_cierre= skill_buscaData_validacion_data($rut, $id_cargo, $id_empresa);

                 if($cuenta_cierre>0){$terminado=1;} else {$terminado=0;}
return $terminado;
}
function ColocaImpacto($rut, $perfil, $id_empresa){
    $datos=DatosImpacto($id_empresa, $rut);
    if(count($datos)>0){
        foreach($datos as $dat){
                if($perfil=="jefe") {
            $total_datos_ingresados.= file_get_contents("views/assessment/" . $id_empresa . "_row_impacto_lectura.html");

                    } else {
            $total_datos_ingresados.= file_get_contents("views/assessment/" . $id_empresa . "_row_impacto.html");

                    }
            $total_datos_ingresados = str_replace("{VOLUMEN}", $dat->volumen, $total_datos_ingresados);
            $total_datos_ingresados = str_replace("{COMPLEJIDAD}", $dat->complejidad, $total_datos_ingresados);
            $total_datos_ingresados = str_replace("{DIFICULTADES}", $dat->dificultades, $total_datos_ingresados);
            $total_datos_ingresados = str_replace("{ID_ENCODEADO}", Encodear3($dat->id), $total_datos_ingresados);
            $total_datos_ingresados = str_replace("{TIPO_BLOQUE}", Encodear3("impacto"), $total_datos_ingresados);

        }

    }else{

    }

    return($total_datos_ingresados);
}

function ColocaExperienciasLaborales($rut, $perfil, $id_empresa){
    $datos=DatosExperienciasLaborales($id_empresa, $rut);
    if(count($datos)>0){
        foreach($datos as $dat){
            if($perfil=="jefe") {
            $total_datos_ingresados.= file_get_contents("views/assessment/" . $id_empresa . "_row_exp_lab_lectura.html");
            }   else {
            $total_datos_ingresados.= file_get_contents("views/assessment/" . $id_empresa . "_row_exp_lab.html");
            }
            $total_datos_ingresados = str_replace("{TAREAS}", $dat->tareas, $total_datos_ingresados);
            $total_datos_ingresados = str_replace("{EMPRESA}", $dat->empresa, $total_datos_ingresados);
            $dat->duracion = str_replace('�', '&ntilde;', $dat->duracion);
            $total_datos_ingresados = str_replace("{DURACION}", ($dat->duracion), $total_datos_ingresados);

            $total_datos_ingresados = str_replace("{ID_ENCODEADO}", Encodear3($dat->id), $total_datos_ingresados);
            $total_datos_ingresados = str_replace("{TIPO_BLOQUE}", Encodear3("experiencias_laborales"), $total_datos_ingresados);




        }
        //$PRINCIPAL = str_replace("{BLOQUE_OTROS_ESTUDIOS_FORMALES_INGRESADOS}", $total_datos_ingresados, $PRINCIPAL);



    }else{
        //$PRINCIPAL = str_replace("{BLOQUE_OTROS_ESTUDIOS_FORMALES_INGRESADOS}", "Sin datos", $PRINCIPAL);
    }

    return($total_datos_ingresados);
}

function ColocaOtrosEstudiosFormales($rut, $perfil, $id_empresa){
    $datos=DatosOtrosEstudiosFormales($id_empresa, $rut);
    if(count($datos)>0){
        foreach($datos as $dat){
             if($perfil=="jefe"){
                            $total_datos_ingresados.= file_get_contents("views/assessment/" . $id_empresa . "_row_preg2_lectura.html");

             }   else {
                            $total_datos_ingresados.= file_get_contents("views/assessment/" . $id_empresa . "_row_preg2.html");

             }
            if($dat->tipo_estudio=="Otro"){
                $total_datos_ingresados = str_replace("{ESTUDIO}", $dat->otro_estudio, $total_datos_ingresados);
            }else{
                $total_datos_ingresados = str_replace("{ESTUDIO}", $dat->tipo_estudio, $total_datos_ingresados);
            }
            if($dat->nombre_item=="Otro"){
                $total_datos_ingresados = str_replace("{CARRERA}", $dat->otro_nombre_estudio, $total_datos_ingresados);
            }else{
                $total_datos_ingresados = str_replace("{CARRERA}", $dat->nombre_item, $total_datos_ingresados);
            }

            if($dat->casa_estudio=="Otro"){
                $total_datos_ingresados = str_replace("{UNIVERSIDAD}", $dat->otra_casa_estudio, $total_datos_ingresados);
            }else{
                $total_datos_ingresados = str_replace("{UNIVERSIDAD}", $dat->descripcion_casa_estudio, $total_datos_ingresados);
            }

            $total_datos_ingresados = str_replace("{FECHA_INICIO}", $dat->fecha_inicio, $total_datos_ingresados);
            $total_datos_ingresados = str_replace("{FECHA_TERMINO}", $dat->fecha_termino, $total_datos_ingresados);
            $total_datos_ingresados = str_replace("{ID_ENCODEADO}", Encodear3($dat->id), $total_datos_ingresados);
            $total_datos_ingresados = str_replace("{TIPO_BLOQUE}", Encodear3("estudios_formales"), $total_datos_ingresados);


        }
        //$PRINCIPAL = str_replace("{BLOQUE_OTROS_ESTUDIOS_FORMALES_INGRESADOS}", $total_datos_ingresados, $PRINCIPAL);



    }else{
        //$PRINCIPAL = str_replace("{BLOQUE_OTROS_ESTUDIOS_FORMALES_INGRESADOS}", "Sin datos", $PRINCIPAL);
    }

    return($total_datos_ingresados);
}
function Lms_Aprobacion_Curso($rut,$id_curso, $id_empresa){
                //echo "<br>Lms_Aprobacion_Curso $id_curso";
        $array_datos_objeto=DatosObjetoDadoIdCurso($id_curso);
            foreach($array_datos_objeto as $unico)
            {
              $arreglo_obj_fin=ObjetoFinalizadoDadoIdYRut($rut, $unico->id);
                //echo "<br>id ".$unico->id;
               // echo "<br>";
                //print_r($arreglo_obj_fin);  echo "<br>";
                if($arreglo_obj_fin[0]->id>0){
                    //echo "<br>no escribe";
                }   else {
                    //echo "<br> Escribir Objeto Finalizado";
                    InsertaObjetoFinalizadoFull($rut, $unico->id, $id_curso, $id_empresa);
                }
            }


}




function Ben_benlistaPorDimension($PRINCIPAL, $id_empresa, $rut, $id_dimension)
{

    $array_lista_ben_dim = Ben_benlistaPorDimension_data($id_empresa, $rut, $id_dimension);
    foreach($array_lista_ben_dim as $unico) {
    //echo "<br>hola ".$unico->id_beneficios;
        $row_lsita.= file_get_contents("views/beneficios/" . $id_empresa . "_row_lista_beneficios.html");

        $row_lsita = str_replace("{ID_DIMENSION}", $unico->id_dimension, $row_lsita);
        $row_lsita = str_replace("{ID_ITEM}", $unico->id_beneficios, $row_lsita);
        $row_lsita = str_replace("{ID_ITEM_IMAGEN}", $unico->imagen, $row_lsita);
        $row_lsita = str_replace("{NOMBRE_ITEM}", $unico->nombre, $row_lsita);
        $row_lsita = str_replace("{DESCRIPCION_ITEM}", $unico->descripcion, $row_lsita);
    }
    //echo  "$row_lsita";
    $PRINCIPAL = str_replace("{ROW_LISTA_VISTA_BENEFICIOS_POR_DIMENSION}", $row_lsita, $PRINCIPAL);

    return ($PRINCIPAL);
}


function com_mp_personal_lista($PRINCIPAL, $id_empresa, $rut, $ord_by, $filt_by, $filt_cat, $vp, $tag, $rut_enviado, $tipo_query, $ambiente, $start_limit, $subcategoria, $idamb, $template)
{



    //echo "<br><br><br>4146 function com_mp_personal_lista template $template";
    if ($rut_enviado <> '') {
        $Rut_Perfil = $rut_enviado;
    } else {
        $Rut_Perfil = $rut;
    }

    $start = round(microtime(true) * 1000);

    if ($vp == 1 or $vp == 2 or $vp == 3) { //echo "VP";
        $datos_usuario_perfil           = UsuarioEnBasePersonas($Rut_Perfil);
        $datos_usuario_biografia_perfil = TraeDatosBiografiaProfesionalUnico($Rut_Perfil);
        $datos_interacciones            = TraeDatosInteraccionComRut($Rut_Perfil, $id_empresa);
        $vista_mejoramiento             = "display:none";
        if ($Rut_Perfil == $rut) {
            $vista_mejoramiento = "display:block;";
        }
        $datos_interaccion_personal = TraeBuscaInteraccionPersonal($Rut_Perfil, $id_empresa);
        $sesiguepersona             = count(VerificandompaSeguidores($rut, $Rut_Perfil, $id_empresa));
        if ($sesiguepersona > 0) {
            $boton_seguir = "<center>    <div class='badge_small badge-verde blanco mgtop5'>    <i class='icon-check icons'></i> Siguiendo </div><a href='?sw=com_mp_personal&rut_enviado={RUT_ENVIADO}&vp=1&sg=2' class='badge_small bg-white_borderBlue negro'>
    <i class='icon-user-following icons'></i> Dejar de seguir (-)</a></center>";
        } else {
            $boton_seguir = "<br><center><a href='?sw=com_mp_personal&rut_enviado={RUT_ENVIADO}&vp=1&sg=1' class='badge_small bg-amarillos_seguir negro'>
        <i class='icon-user-following icons'></i> Seguir (+)</a></center>";
        }
        if ($rut == $Rut_Perfil) {
            $boton_seguir = "";
        }
        if ($datos_interaccion_personal[0]->numbcicoins == "") {
            $num_coins = 0;
        } else {
            $num_coins = $datos_interaccion_personal[0]->numbcicoins;
        }
        if ($datos_interaccion_personal[0]->numseguidores == "") {
            $num_seguidores = 0;
        } else {
            $num_seguidores = $datos_interaccion_personal[0]->numseguidores;
        }
        if ($datos_interaccion_personal[0]->numseguidos == "") {
            $num_seguidos = 0;
        } else {
            $num_seguidos = $datos_interaccion_personal[0]->numseguidos;
        }
        if ($datos_interaccion_personal[0]->numpublicaciones == "") {
            $num_publicaciones = 0;
        } else {
            $num_publicaciones = $datos_interaccion_personal[0]->numpublicaciones;
        }
        if ($datos_interaccion_personal[0]->numaptitudesvalidadas == "") {
            $num_aptitudesvalidadas = 0;
        } else {
            $num_aptitudesvalidadas = $datos_interaccion_personal[0]->numaptitudesvalidadas;
        }
        if ($vp == 1) {
            $perfil_personal .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_perfil.html");
        } elseif ($vp == 2) {
            $perfil_personal .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_perfil_interacciones.html");
        } elseif ($vp == 3) {
            $perfil_personal .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_perfil_puntos.html");
        }


        $perfil_personal       = str_replace("{BOTON_SEGUIR}", $boton_seguir, $perfil_personal);
        $perfil_personal       = str_replace("{PERFIL_COMUNIDAD_FOTO}", VerificaFotoPersonal($Rut_Perfil), $perfil_personal);
        $perfil_personal       = str_replace("{PERFIL_COMUNIDAD_NOMBRE}", $datos_usuario_perfil[0]->nombre_completo, $perfil_personal);
        $perfil_personal       = str_replace("{PERFIL_COMUNIDAD_NOMBRE_EMAIL}", $datos_usuario_perfil[0]->email, $perfil_personal);
        $perfil_personal       = str_replace("{PERFIL_COMUNIDAD_CARGO}", $datos_usuario_perfil[0]->cargo, $perfil_personal);
        $perfil_personal       = str_replace("{PERFIL_COMUNIDAD_GERENCIA}", $datos_usuario_perfil[0]->gerencia, $perfil_personal);
        $perfil_personal       = str_replace("{PERFIL_COMUNIDAD_BIOGRAFIA}", $datos_usuario_biografia_perfil[0]->motivacion, $perfil_personal);
        $perfil_personal       = str_replace("{PERFIL_COMUNIDAD_QUIENSOY}", $datos_usuario_biografia_perfil[0]->estudios, $perfil_personal);
        $perfil_personal       = str_replace("{PERFIL_COMUNIDAD_CANTIDAD_POSTS}", $cantidad_post, $perfil_personal);
        $perfil_personal       = str_replace("{PERFIL_COMUNIDAD_VISITAS_POST}", $suma_visitas_interaccion, $perfil_personal);
        $perfil_personal       = str_replace("{PERFIL_COMUNIDAD_TAGS}", $tags_publicados, $perfil_personal);
        $perfil_personal       = str_replace("{PERFIL_COMUNIDAD_INTERESES}", $tags_misintereses, $perfil_personal);
        $perfil_personal       = str_replace("{PERFIL_COMUNIDAD_MIS_ULTIMAS_PUBLICACIONES}", $titulo_publicaciones, $perfil_personal);
        $datos_mi_perfil       = TraeDatosMiPerfil($Rut_Perfil, $id_empresa);

        $perfil_personal       = str_replace("{BIOGRAFIA}", $datos_mi_perfil[0]->biografia, $perfil_personal);
        $perfil_personal       = str_replace("{NUM_BCICOINS}", $num_coins, $perfil_personal);
        $perfil_personal       = str_replace("{NUM_SEGUIDORES}", $num_seguidores, $perfil_personal);
        $perfil_personal       = str_replace("{NUM_SEGUIDOS}", $num_seguidos, $perfil_personal);
        $perfil_personal       = str_replace("{NUM_PUBLICACIONES}", $num_publicaciones, $perfil_personal);
        $perfil_personal       = str_replace("{NUM_MEGUSTA_FAVORITAS}", $datos_interaccion_personal[0]->nummegustafavorita, $perfil_personal);
        $perfil_personal       = str_replace("{NUM_VISITAS}", $datos_interaccion_personal[0]->numvisitas, $perfil_personal);
        $perfil_personal       = str_replace("{NUM_COMENTARIOS}", $datos_interaccion_personal[0]->numcomentarios, $perfil_personal);
        $perfil_personal       = str_replace("{NUM_APTITUDESVALIDADAS}", $num_aptitudesvalidadas, $perfil_personal);
        $perfil_personal       = str_replace("{NUM_PUBLICACIONESSEGUIDAS}", $datos_interaccion_personal[0]->publicacionesseguidas, $perfil_personal);
        $perfil_personal       = str_replace("{NUM_INTERACCIONES}", $datos_interaccion_personal[0]->numinteracciones, $perfil_personal);
        $perfil_personal       = str_replace("{NUM_NOTIFICACIONES}", $cuenta_notificaciones, $perfil_personal);
        $perfil_personal       = str_replace("{NUM_NOTIFICACIONES_SINVER}", $cuenta_notificaciones_sinver, $perfil_personal);

        if ($cuenta_validacion == 0) {
            $perfil_personal                 = str_replace("{TITULO_COMP_MP_CATEGORIAS_VALIDAR_APTITUDES_CHECKBOXS}", "", $perfil_personal);
            $total_listado_validar_aptitudes = $datos_usuario_perfil[0]->nombre_completo . " no ha ingresado Aptitudes";
        }
        $perfil_personal          = str_replace("{ROW_COMP_MP_CATEGORIAS_VALIDAR_APTITUDES_CHECKBOXS}", ($total_listado_validar_aptitudes), $perfil_personal);

        $perfil_personal          = str_replace("{ROW_COMP_ACTIVIDADES_INTERES_CHECKBOXS_VALIDAR}", ($total_listado_mis_interacciones), $perfil_personal);

        $perfil_personal                   = str_replace("{MIS_PUBLICACIONES_MIPERFIL}", ($total_listado_mis_publicaciones), $perfil_personal);

        $perfil_personal = str_replace("{MIS_PUBLICACIONES_SEGUIDAS_MIPERFIL}", ($total_listado_mis_publicaciones_seguidas), $perfil_personal);
        $perfil_personal = str_replace("{MP_VISUALIZA_MEJORAMIENTO}", ($vista_mejoramiento), $perfil_personal);
    } else {
        $perfil_personal = "";
    }

     if ($rut_enviado <> '') {





         // Mis Seguidores
        $com_mp_mis_seguidores = com_mp_busca_interaccion($id_empresa, $Rut_Perfil, "", "SEGUIDO", "10");
        foreach ($com_mp_mis_seguidores as $com_mp_mi_seguidor) {
            $total_listado_mis_seguidores .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_perfil_mis_seguidores.html");
            $total_listado_mis_seguidores = str_replace("{NOMBRE_SEGUIDOR}", ($com_mp_mi_seguidor->nombreR), $total_listado_mis_seguidores);
            $total_listado_mis_seguidores = str_replace("{CARGO_SEGUIDOR}", ($com_mp_mi_seguidor->cargoR), $total_listado_mis_seguidores);
            $total_listado_mis_seguidores = str_replace("{GERENCIA_SEGUIDOR}", ($com_mp_mi_seguidor->gerenciaR), $total_listado_mis_seguidores);
            $total_listado_mis_seguidores = str_replace("{FOTO_SEGUIDOR}", VerificaFotoPersonal($com_mp_mi_seguidor->rut_remitente), $total_listado_mis_seguidores);
            $total_listado_mis_seguidores = str_replace("{RUT_ENVIADO}", ($com_mp_mi_seguidor->rut_remitente), $total_listado_mis_seguidores);
        }
        $perfil_personal     = str_replace("{ROW_COMP_MP_MIS_SEGUIDORES}", ($total_listado_mis_seguidores), $perfil_personal);
        $perfil_personal     = str_replace("{ROW_COMP_MP_MIS_NOTIFICACIONES}", ($total_notificaciones), $perfil_personal);
        // Mis Seguidos
        $com_mp_mis_seguidos = com_mp_busca_interaccion($id_empresa, "", $Rut_Perfil, "SEGUIDO", "10");
        foreach ($com_mp_mis_seguidos as $com_mp_mi_seguido) {
            $total_listado_mis_seguidos .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_perfil_mis_seguidores.html");
            $total_listado_mis_seguidos = str_replace("{NOMBRE_SEGUIDOR}", ($com_mp_mi_seguido->nombre), $total_listado_mis_seguidos);
            $total_listado_mis_seguidos = str_replace("{CARGO_SEGUIDOR}", ($com_mp_mi_seguido->cargo), $total_listado_mis_seguidos);
            $total_listado_mis_seguidos = str_replace("{GERENCIA_SEGUIDOR}", ($com_mp_mi_seguido->gerencia), $total_listado_mis_seguidos);
            $total_listado_mis_seguidos = str_replace("{FOTO_SEGUIDOR}", VerificaFotoPersonal($com_mp_mi_seguido->rut), $total_listado_mis_seguidos);
            $total_listado_mis_seguidos = str_replace("{RUT_ENVIADO}", ($com_mp_mi_seguido->rut), $total_listado_mis_seguidos);
        }
        $perfil_personal      = str_replace("{ROW_COMP_MP_MIS_SEGUIDOS}", ($total_listado_mis_seguidos), $perfil_personal);
        // MIS APTITUDES
        $com_mp_mis_aptitudes = com_mp_busca_categorias_comunidad_e_interaccion($Rut_Perfil, "APTITUD", $id_empresa);
        //PRINT_R($com_mp_mis_aptitudes);
        foreach ($com_mp_mis_aptitudes as $com_mp_mis_aptitud) {
            //print_r($com_mp_mis_aptitud);
            $total_listado_mis_aptitudes .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_perfil_mis_aptitudes.html");
            $chequado = "";
            $checked  = "  ";
            if ($com_mp_mis_aptitud->cuenta > 0) {
                $chequado = "Mi Expertise";
                $checked  = " checked ";
            }
            $total_listado_mis_aptitudes = str_replace("{CATEGORIA}", ($com_mp_mis_aptitud->categoria), $total_listado_mis_aptitudes);
            $total_listado_mis_aptitudes = str_replace("{CHECKED}", utf8_decode($checked), $total_listado_mis_aptitudes);
            $total_listado_mis_aptitudes = str_replace("{CHEQUEADO}", utf8_decode($chequeado), $total_listado_mis_aptitudes);
            $total_listado_mis_aptitudes = str_replace("{ID_CATEGORIA}", utf8_decode($com_mp_mis_aptitud->id_categoria), $total_listado_mis_aptitudes);
        }
        $perfil_personal              = str_replace("{ROW_COMP_MP_CATEGORIAS_MIS_APTITUDES_CHECKBOXS}", ($total_listado_mis_aptitudes), $perfil_personal);
        $datos                        = TraeDatosBiografiaProfesionalPorEmpresa($Rut_Perfil, $id_empresa);
        $perfil_personal              = str_replace("{INFO_BIOGRAFIA}", ($datos[0]->estudios), $perfil_personal);
        // VALIDACION APTITUDES
        $com_mp_mis_validar_aptitudes = com_mp_busca_validacion_aptitudes($Rut_Perfil, "", "APTITUD_VALIDADA", $id_empresa);
        //PRINT_R($com_mp_mis_aptitudes);
        $cuenta_validacion            = 0;
        foreach ($com_mp_mis_validar_aptitudes as $com_mp_mis_validar_aptitud) {
            //    print_r($com_mp_mis_validar_aptitud);
            $total_listado_validar_aptitudes .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_perfil_validar_aptitudes.html");
            //Aca veo si el usuario de sesion, ya hizo me gusta a esta aptitud para esta categoria y para este usuarios
            //$tiene_megusta=UsuarioHizoMegustaEnAptitud($Rut_Perfil, $com_mp_mis_validar_aptitud->rut_receptor, $com_mp_mis_validar_aptitud->idcategoria, "APTITUD_VALIDADA", $id_empresa);
            $tiene_megusta = UsuarioHizoMegustaEnAptitud($Rut_Perfil, $_SESSION["user_"], $com_mp_mis_validar_aptitud->idcategoria, "APTITUD_VALIDADA", $id_empresa);
            if ($tiene_megusta) {
                $total_listado_validar_aptitudes = str_replace("{BLOQUE_PARA_MEGUSTA_APTITUDES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_yamegusta_aptitudes.html"), $total_listado_validar_aptitudes);
            } else {
                $total_listado_validar_aptitudes = str_replace("{BLOQUE_PARA_MEGUSTA_APTITUDES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_megusta_aptitudes.html"), $total_listado_validar_aptitudes);
            }
            $total_listado_validar_aptitudes = str_replace("{ID_CATEGORIA}", ($com_mp_mis_validar_aptitud->idcategoria), $total_listado_validar_aptitudes);
            $total_listado_validar_aptitudes = str_replace("{RUT_RECEPTOR}", ($com_mp_mis_validar_aptitud->rut_receptor), $total_listado_validar_aptitudes);
            //echo "$com_mp_mis_validar_aptitud->vecesvalidada";
            if ($com_mp_mis_validar_aptitud->vecesvalidada > 0) {
                //$estrellas_com_mp=0;
                $estrellas_com_mp          = "";
                $estrellas_com_mp_promedio = "";
                //    for ($i = 1; $i <= $com_mp_mis_validar_aptitud->vecesvalidada; $i++) {
                //            $estrellas_com_mp_promedio.="<span class='badge badge-pill badge-success'><span class='blanco'><i class='icon-star icons'></i></span></span>";
                //    }
                $estrellas_com_mp          = $com_mp_mis_validar_aptitud->vecesvalidada;
                $transforma100             = (25 * $estrellas_com_mp - 25);
                if ($transforma100 < 10) {
                    $transforma100 = 10;
                }
                if ($transforma100 > 100) {
                    $transforma100 = 100;
                }
                //$transforma101=33;
                //$transforma102=44;
                //echo
                $estrellas_com_mp_promedio         = "<ul class='skills'>
                            <li data-percent='" . $transforma100 . "'>
                                <div class='progress skills-animated' style='width: " . $transforma100 . "%;'>
                                    <div class='progress-percent'><div class='counter counter-inherit counter-instant'><span data-from='0' data-to='" . $estrellas_com_mp . "' data-refresh-interval='30' data-speed='1100'>" . $transforma100 . "</span></div></div>
                                </div>
                            </li>
                </ul>";
                //$total_listado_validar_aptitudes = str_replace("{ESTRELLAsS_ACTUALES}",$com_mp_mis_validar_aptitud->vecesvalidada." ".$estrellas_com_mp,$total_listado_validar_aptitudes);
                $total_listado_validar_aptitudes   = str_replace("{ESTRELLAS_ACTUALES}", $estrellas_com_mp_promedio, $total_listado_validar_aptitudes);
                $datos_estrellas_aptitudes_usuario = busca_Estrellas_Aptitud($com_mp_mis_validar_aptitud->idcategoria, $rut_autor, $rut_receptor, $id_empresa);
                for ($k = 1; $k <= $datos_estrellas_aptitudes_usuario[0]->mensaje; $k++) {
                    $estrellas_com_mp_usuario .= "<span class='badge badge-pill badge-success'><span class='blanco'><i class='icon-star icons'></i></span></span>";
                }
                $total_listado_validar_aptitudes = str_replace("{ESTRELLAS}", $estrellas_com_mp_usuario, $total_listado_validar_aptitudes);
            } else {
                $total_listado_validar_aptitudes = str_replace("{ESTRELLAS_ACTUALES}", "<span class='badge badge-pill badge-default'>S&eacute; el primero en valorar la aptitud</span>", $total_listado_validar_aptitudes);
            }
            $total_listado_validar_aptitudes = str_replace("{CATEGORIA}", ($com_mp_mis_validar_aptitud->categoria), $total_listado_validar_aptitudes);
            $total_listado_validar_aptitudes = str_replace("{CHECKED}", utf8_encode($checked), $total_listado_validar_aptitudes);
            $total_listado_validar_aptitudes = str_replace("{CHEQUEADO}", utf8_encode($chequeado), $total_listado_validar_aptitudes);
            $perfil_personal                 = str_replace("{TITULO_COMP_MP_CATEGORIAS_VALIDAR_APTITUDES_CHECKBOXS}", "
                Validas las aptitudes de " . $datos_usuario_perfil[0]->nombre_completo . "<BR><BR>
    <div class='row'>
        <div class='col-xs-3 col-sm-3 col-lg-3  col-md-3'><strong><small>Aptitud</small></strong></div>
        <div class='col-xs-6 col-sm-6 col-lg-6  col-md-6'><strong><small>Valoraci&oacute;n</div>
        <div class='col-xs-3 col-sm-3 col-lg-3  col-md-3'></div>
    </div>
                ", $perfil_personal);
            $cuenta_validacion++;
        }
        if ($cuenta_validacion == 0) {
            $perfil_personal                 = str_replace("{TITULO_COMP_MP_CATEGORIAS_VALIDAR_APTITUDES_CHECKBOXS}", "", $perfil_personal);
            $total_listado_validar_aptitudes = $datos_usuario_perfil[0]->nombre_completo . " no ha ingresado Aptitudes";
        }
        $perfil_personal          = str_replace("{ROW_COMP_MP_CATEGORIAS_VALIDAR_APTITUDES_CHECKBOXS}", ($total_listado_validar_aptitudes), $perfil_personal);
        // Mis Interacciones
        $com_mp_mis_interacciones = com_mp_mis_interacciones_perfil($Rut_Perfil, $id_empresa, "50");
        //print_r($com_mp_mis_interacciones);
        foreach ($com_mp_mis_interacciones as $com_mp_mi_interaccion) {
            $total_listado_mis_interacciones .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_perfil_mis_interacciones.html");
            $total_listado_mis_interacciones = str_replace("{FECHA}", utf8_encode(formatearFechaSmall($com_mp_mi_interaccion->fecha)), $total_listado_mis_interacciones);
            $total_listado_mis_interacciones = str_replace("{TIPO}", utf8_encode($com_mp_mi_interaccion->tipo), $total_listado_mis_interacciones);
            if ($com_mp_mi_interaccion->mensaje <> '') {
                $postM = "<em><strong>" . $com_mp_mi_interaccion->mensaje . "</strong></em><br>";
            } else {
                $postM = "";
            }
            if ($com_mp_mi_interaccion->post <> '') {
                $postR = "Publicaci&oacute;n: <a href='?sw=com_mp_full&id_mp=" . $com_mp_mi_interaccion->id_mp . "'><strong>" . $com_mp_mi_interaccion->post . "</strong></a><br>";
            } else {
                $postR = "";
            }
            if ($com_mp_mi_interaccion->categoria <> '') {
                $postC = "<a href='?sw=com_mp_personal&amb=mp_cat&idcat=" . $com_mp_mi_interaccion->contenido . "&cat=General'>" . $com_mp_mi_interaccion->categoria . "</a><br>";
            } else {
                $postC = "";
            }
            if ($com_mp_mi_interaccion->remitente <> '') {
                $postRe = "Realizado por <a href='?sw=com_mp_personal&rut_enviado=" . $com_mp_mi_interaccion->rut_remitente . "&vp=1&mp=1'>" . $com_mp_mi_interaccion->remitente . "</a><br>";
            } else {
                $postRe = "";
            }
            //if($com_mp_mi_interaccion->autor<>''){$postA="<a href='?sw=com_mp_personal&rut_enviado=".$com_mp_mi_interaccion->rutautor."&vp=1&mp=1'>".$com_mp_mi_interaccion->autor."</a>";} else { $postA="";}
            $sujeto                          = $postM . $postR . $postC . $postRe . $postA;
            $total_listado_mis_interacciones = str_replace("{SUJETO}", ($sujeto), $total_listado_mis_interacciones);
        }
        $perfil_personal          = str_replace("{ROW_COMP_ACTIVIDADES_INTERES_CHECKBOXS_VALIDAR}", ($total_listado_mis_interacciones), $perfil_personal);
        //MIS publicaciones
        $com_mp_mis_publicaciones = com_mp_mis_publicaciones($id_empresa, $Rut_Perfil, "mis_publicaciones", "25");

       //print_r($com_mp_mis_publicaciones);
       foreach ($com_mp_mis_publicaciones as $com_mp_mi_publicacion) {
            $total_listado_mis_publicaciones .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_persona_listado_tipoA1R.html");
            //echo "<br>loop<br>views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_persona_listado_tipoA1R.html";
            //print_r($com_mp_mi_publicacion);
            if ($unico->rut_mentor <> '') {
                $nombre_mentor = UsuarioEnBasePersonaPorEmpresa($unico->rut_mentor, $id_empresa);
                $mentor        = "<a href='?sw=com_mp_personal&rut_enviado=" . $nombre_mentor[0]->rut . "&vp=1'><div class='badge_small badge-verde blanco mgtop5'>    <i class='icon-check icons'></i> Respondido por " . $nombre_mentor[0]->nombre_completo . "</div></a>";
            } else {
                $mentor = "";
            }
            $total_listado_mis_publicaciones = str_replace("{NOMBRE_MENTOR}", ($mentor), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_listado_mis_publicaciones);
            if ($com_mp_mi_publicacion->rut == $rut) {
                $total_listado_mis_publicaciones = str_replace("{EDITAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_editar_mp.html"), $total_listado_mis_publicaciones);
                $total_listado_mis_publicaciones = str_replace("{ELIMINAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_borrar_mp.html"), $total_listado_mis_publicaciones);
            } else {
                $total_listado_mis_publicaciones = str_replace("{EDITAR_MP}", "", $total_listado_mis_publicaciones);
                $total_listado_mis_publicaciones = str_replace("{ELIMINAR_MP}", "", $total_listado_mis_publicaciones);
            }
            $tiene_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $com_mp_mi_publicacion->id_mp, "MEGUSTA", $rut);
            if ($tiene_megusta) {
                $total_listado_mis_publicaciones = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta.html"), $total_listado_mis_publicaciones);
            } else {
                $total_listado_mis_publicaciones = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta.html"), $total_listado_mis_publicaciones);
            }
            $tiene_no_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $com_mp_mi_publicacion->id_mp, "NOMEGUSTA", $rut);
            if ($tiene_no_megusta) {
                $total_listado_mis_publicaciones = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_nomegusta.html"), $total_listado_mis_publicaciones);
            } else {
                $total_listado_mis_publicaciones = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_nomegusta.html"), $total_listado_mis_publicaciones);
            }
            $total_listado_mis_publicaciones = ColocaCantidadDeMegusta($total_listado_mis_publicaciones, $com_mp_mi_publicacion->id_mp, $id_empresa);
            $tiene_favorito                  = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $com_mp_mi_publicacion->id_mp, "FAVORITA", $rut);
            if ($tiene_favorito) {
                $total_listado_mis_publicaciones = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_favorito.html"), $total_listado_mis_publicaciones);
            } else {
                $total_listado_mis_publicaciones = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_favorito.html"), $total_listado_mis_publicaciones);
            }
            $post_categoria = '<a href="?sw=com_mp_personal&amb=mp_cat&idcat=' . $com_mp_mi_publicacion->id_categoria . '&cat=' . $com_mp_mi_publicacion->categoria . '"><span class="badge_small badge-azul"><span class="blanco"><i class="icon-people icons"></i> ' . $com_mp_mi_publicacion->categoria . '</span></span></a>';
            if ($com_mp_mi_publicacion->tipo == "MejorPractica") {
                $ico = "img/bci_mp_practica_icon.png";
            }
            if ($com_mp_mi_publicacion->tipo == "Papers") {
                $ico = "img/bci_mp_paper_icon.png";
            }
            if ($com_mp_mi_publicacion->tipo == "Publicacion") {
                $ico = "img/bci_mp_publicacion.png";
            }
            if ($com_mp_mi_publicacion->tipo == "Video" or $com_mp_mi_publicacion->tipo == "VideoInterno") {
                $ico = "img/bci_mp_practica_video.png";
            }
            if ($com_mp_mi_publicacion->tipo == "Links" or $com_mp_mi_publicacion->tipo == "LinkExterno") {
                $ico = "img/bci_mp_link_icon.png";
            }
            if ($com_mp_mi_publicacion->tipo == "Experiencias") {
                $ico = "img/bci_mp_experiencias_icon.png";
            }
            if ($com_mp_mi_publicacion->tipo == "Experto") {
                $ico = "img/bci_mp_experto_icon.png";
            }
            if ($com_mp_mi_publicacion->tipo == "OportunidadMejora") {
                $ico = "img/bci_mp_oportunidadmejora_icon.png";
            }
            if ($com_mp_mi_publicacion->tipo == "Udnolohaga") {
                $ico = "img/bci_mp_udnolohaga_icon.png";
            }
            if ($com_mp_mi_publicacion->tipo == "RRPP") {
                $ico = "img/bci_mp_rrpp_icon.png";
            }
            if ($com_mp_mi_publicacion->tipo == "Pregunta") {
                $ico = "img/bci_mp_pregunta_icon.png";
            }
            if ($com_mp_mi_publicacion->tipo == "Respuesta") {
                $ico = "img/bci_mp_pregunta_icon.png";
            }
            $total_listado_mis_publicaciones = str_replace("{ICONO}", $ico, $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{ICONO_DESC}", $ico, $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = ColocaCantidadDeFavorito($total_listado_mis_publicaciones, $com_mp_mi_publicacion->id_mp, $id_empresa);
            $total_listado_mis_publicaciones = str_replace("{ID_MP}", $com_mp_mi_publicacion->id_mp, $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{ID_MP_ENCODEADO}", Encodear3($com_mp_mi_publicacion->id_mp), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{TIPO}", "A", $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{LINK}", $link_MP, $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{CATEGORIA_MP}", $post_categoria, $total_listado_mis_publicaciones);
            $post_ambito                     = '<a href="?sw=com_mp_personal&amb=mp_amb&idamb=' . $com_mp_mi_publicacion->id_ambito . '&ambito=' . $com_mp_mi_publicacion->ambito . '">
<span class="badge_small badge-azul"><span class="blanco"><i class="icon-people icons"></i> ' . $com_mp_mi_publicacion->ambito . '</span></span></a>';
            $total_listado_mis_publicaciones = str_replace("{AMBITO_MP}", $post_ambito, $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($com_mp_mi_publicacion->descripcion_categoria), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{NOMBRE}", ($com_mp_mi_publicacion->nombre), $total_listado_mis_publicaciones);
            if ($com_mp_mi_publicacion->contenido == "") {
                $resumen = ($com_mp_mi_publicacion->resumen);
            } else {
                $resumen = limit_text($com_mp_mi_publicacion->contenido, 35);
            }
            $total_listado_mis_publicaciones = str_replace("{CONTENIDO}", $resumen, $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{FECHA}", formatearFechaSmall($com_mp_mi_publicacion->fecha), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{ESTADO}", ($com_mp_mi_publicacion->estado), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{DESCRIPCION_ESTADO}", ($com_mp_mi_publicacion->descripcion_estado), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{RUT_AUTOR}", ($com_mp_mi_publicacion->rut), $total_listado_mis_publicaciones);

            $nombre_arroba=rutemailaarroba($com_mp_mi_publicacion->rut, $id_empresa);
            $total_listado_mis_publicaciones = str_replace("{NOMBRE_AUTOR_ARROBA}", ($nombre_arroba), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{RUT}", ($rut), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{NOMBRE_AUTOR}", ($com_mp_mi_publicacion->nombre_autor), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{NOMBRE_AUTOR}", ($com_mp_mi_publicacion->nombre_autor), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($com_mp_mi_publicacion->rut), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{NUMVISITAS}", round($com_mp_mi_publicacion->numvisitas), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{NUMMEGUSTA}", ($com_mp_mi_publicacion->nummegusta), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{NUMCOMPARTIDA}", ($com_mp_mi_publicacion->numcompartido), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{NUMCOMENTARIO}", ($com_mp_mi_publicacion->numcomentarios), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{NUMCOMENTARIOSREALES}", ($com_mp_mi_publicacion->numcomentariosreales), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{NUMFAVORITA}", ($com_mp_mi_publicacion->numfavorita), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{ESTILOESTADO}", ($com_mp_mi_publicacion->estilo), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{ICONOESTADO}", ($com_mp_mi_publicacion->icono_estado), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{ESTILOCATEGORIA}", ($com_mp_mi_publicacion->style), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{ICONOCATEGORIA}", ($com_mp_mi_publicacion->icono), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{CATEGORIA_MP}", ($com_mp_mi_publicacion->categoria), $total_listado_mis_publicaciones);
            if ($com_mp_mi_publicacion->tipo_multimedia == "imagen" and $com_mp_mi_publicacion->imagen_fondo <> '') {
                $imagen = "../../front/multimedia/" . $com_mp_mi_publicacion->multimedia;
            } else {
                $imagen = "";
            }
            if ($com_mp_mi_publicacion->tipo_multimedia == "video") {
                $video = "../../front/multimedia/" . $com_mp_mi_publicacion->multimedia;
            } else {
                $video = "";
            }
            $total_listado_mis_publicaciones = str_replace("{IMAGEN_POST}", "multimedia/" . $com_mp_mi_publicacion->imagenfondo, $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{VIDEO}", ($video), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{TIPOMULTIMEDIA}", ($com_mp_mi_publicacion->tipo_multimedia), $total_listado_mis_publicaciones);
            $listado_comentarios             = MuestraComentariosPorPost($com_mp_mi_publicacion->id_mp);
            $total_listado_mis_publicaciones = str_replace("{BLOQUE_COMENTARIOS}", $listado_comentarios, $total_listado_mis_publicaciones);
            if ($com_mp_mi_publicacion->url_documento) {
                $total_listado_mis_publicaciones = str_replace("{BLOQUE_URL_DOCUMENTO}", file_get_contents("views/comunidad_mp/row_com_mp_url_documento.html"), $total_listado_mis_publicaciones);
                $total_listado_mis_publicaciones = str_replace("{URL_DOCUMENTO}", ($com_mp_mi_publicacion->url_documento), $total_listado_mis_publicaciones);
            } else {
                $total_listado_mis_publicaciones = str_replace("{BLOQUE_URL_DOCUMENTO}", "", $total_listado_mis_publicaciones);
            }
            if ($com_mp_mi_publicacion->video) {
                $video_youtube                   = ColocaVideoYoutube($com_mp_mi_publicacion->video,  $com_mp_mi_publicacion->id_mp);
                $total_listado_mis_publicaciones = str_replace("{VIDEO_IMAGEN}", $video_youtube, $total_listado_mis_publicaciones);
            } else {
                $bloque_imagen_fondo             = ColocaImagenPost($com_mp_mi_publicacion->imagenfondo);
                $total_listado_mis_publicaciones = str_replace("{VIDEO_IMAGEN}", $bloque_imagen_fondo, $total_listado_mis_publicaciones);
            }
            $TagsPorPosts = TagsPorMPEmpresa($com_mp_mi_publicacion->id_mp, $id_empresa);
            $tag_por_post = "";
            foreach ($TagsPorPosts as $TagsPorPost) {
                $tag_por_post .= '<a href="?sw=com_mp_personal&amb=mp_tag&tag=' . $TagsPorPost->tag . '"><span class="badge_small badge-white"><span class="negro">#' . $TagsPorPost->tag . '</span></span></a> ';
            }
            $total_listado_mis_publicaciones = str_replace("{TAGS_POR_POST}", ($tag_por_post), $total_listado_mis_publicaciones);
        }
        //echo $total_listado_mis_publicaciones;
        $perfil_personal                   = str_replace("{MIS_PUBLICACIONES_MIPERFIL2}", ($total_listado_mis_publicaciones), $perfil_personal);

        $perfil_personal = str_replace("{MP_VISUALIZA_MEJORAMIENTO}", ($vista_mejoramiento), $perfil_personal);









    }

       //echo $perfil_personal;


    /*$
    $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>VP : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/

    //TITULO RESULTADOS
    if ($idamb <> '') {
        $nombre_ambito = nombre_ambitoMP($idamb, $id_empresa);
    }
    $titulo_R_resultados = "";
    $titulo_E_resultados = "";
    if ($vp == "" and $ambiente <> "") {
        if ($ambiente == 'mp_resultados') {
            $tituloR = "Resultados de B?squeda";
        }
        if ($ambiente == 'mp_rec') {
            $tituloR = "Recientes";
        }
        if ($ambiente == 'mp_interes') {
            $tituloR = "Publicaciones de Inter?s";
        }
        if ($ambiente == 'mp_populares') {
            $tituloR = "Publicaciones Populares";
        }
        if ($ambiente == 'mp_tag') {
            $tituloR = "Tag: <strong>$tag</strong>";
        }
        if ($ambiente == 'mp_cat') {
            $tituloR = "Grupo de Inter?s: <strong>$tag</strong>";
        }
        if ($ambiente == 'mp_amb') {
            $tituloR = "Temas: <strong>" . utf8_encode($nombre_ambito[0]->ambito) . "</strong>";
        }
        if ($ambiente == 'mp_rec') {
            $tituloR = "Recientes";
        }
        if ($ambiente == 'mp_mp') {
            $tituloR = "Mis Publicaciones";
        }
        if ($ambiente == 'mp_mf') {
            $tituloR = "Publicaciones Guardadas";
        }
        if ($ambiente == 'mp_cc') {
            $tituloR = "Compartidas conmigo";
        }
        if ($ambiente == 'mp_tipo') {
            $tituloR = "Tipo de Publicaci?n: <strong>$tag</strong>";
        }
        $titulo_R_resultados .= file_get_contents("views/comunidad_mp/row_com_mp_persona_titulo_tipoR.html");
        $titulo_R_resultados = str_replace("{TITULO_R}", $tituloR, $titulo_R_resultados);
        $titulo_E_resultados .= file_get_contents("views/comunidad_mp/row_com_mp_persona_titulo_tipoE.html");
        $titulo_E_resultados = str_replace("{TITULO_E}", $tituloR, $titulo_E_resultados);
    }
    if ($tipo_query <> '') {
        $tituloR = "Resultados de B?squeda: <strong>$tipo_query</strong>";
        $titulo_R_resultados .= file_get_contents("views/comunidad_mp/row_com_mp_persona_titulo_tipoR.html");
        $titulo_R_resultados = str_replace("{TITULO_R}", $tituloR, $titulo_R_resultados);
    }
    //COMUNIDAD AMBIENTE INICIAL PRINCIPAL
    //echo "ambiente $ambiente";
    $com_limit = "20";
    $com_start = "0";


    /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>VR : $time_elapsed<br><br>"; */



    if ($ambiente == "" or $ambiente == "mp_cat" or $ambiente == "mp_amb" or $ambiente == "mp_tag" or $ambiente == "mp_mp" or $ambiente == "mp_mf" or $ambiente == "mp_cc" or $ambiente == "mp_tipo") {
        $todas                        = com_mp_lista_personal($id_empresa, $Rut_Perfil, $ord_by, $filt_by, $filt_cat, $vp, $arreglo_tag, utf8_decode($tag), $rut_enviado, $ambiente, $com_limit, $com_start, $start_limit, $subcategoria, $idamb);


        //print_r($todas);
        $total_listado_post_recientes = "";

        /*$start = round(microtime(true) * 1000);    */

        foreach ($todas as $unico) {


        $start = round(microtime(true) * 1000);

        $Usuario=TraeDatosBiografiayUsuario($unico->rut, $id_empresa);


            if ($_GET["sw"] == "com_mp_home") {
                $total_listado_post_recientes .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_persona_listado_tipoA1R_home.html");
            } else {
                $total_listado_post_recientes .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_persona_listado_tipoA1R.html");
            }
            //print_r($unico);
            //echo "views/comunidad_mp/".$template.$id_empresa."_row_com_mp_persona_listado_tipoA1R.html";
            if ($unico->rut_mentor <> '') {
                $nombre_mentor = UsuarioEnBasePersonaPorEmpresa($unico->rut_mentor, $id_empresa);
                $mentor        = "<a href='?sw=com_mp_personal&rut_enviado=" . $nombre_mentor[0]->rut . "&vp=1'><div class='badge_small badge-verde blanco mgtop5'>    <i class='icon-check icons'></i> Respondido por " . $nombre_mentor[0]->nombre_completo . "</div></a>";
            } else {
                $mentor = "";
            }
            $total_listado_post_recientes = str_replace("{NOMBRE_MENTOR}", ($mentor), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_listado_post_recientes);
            //echo "<br>".$unico->rut."==".$rut;
            if ($unico->rut == $rut) {
                $total_listado_post_recientes = str_replace("{EDITAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_editar_mp.html"), $total_listado_post_recientes);
                $total_listado_post_recientes = str_replace("{ELIMINAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_borrar_mp.html"), $total_listado_post_recientes);
            } else {
                $total_listado_post_recientes = str_replace("{EDITAR_MP}", "", $total_listado_post_recientes);
                $total_listado_post_recientes = str_replace("{ELIMINAR_MP}", "", $total_listado_post_recientes);
            }

    /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>foreach 1 : $time_elapsed<br><br>";
    $start = round(microtime(true) * 1000);        */

            $tiene_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $unico->id_mp, "MEGUSTA", $rut);
            if ($tiene_megusta) {
                $total_listado_post_recientes = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta.html"), $total_listado_post_recientes);
            } else {
                $total_listado_post_recientes = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta.html"), $total_listado_post_recientes);
            }
            //$tiene_no_megusta=COMUNIDAD_TieneInteraccionPorRut($id_empresa, $unico->id_mp, "NOMEGUSTA", $rut);
            //if($tiene_no_megusta){
            //    $total_listado_post_recientes = str_replace("{BLOQUE_NOMEGUSTA_POST}",file_get_contents("views/comunidad_mp/".$template.$id_empresa."_bloque_ya_nomegusta.html"),$total_listado_post_recientes);
            //}else{
            //    $total_listado_post_recientes = str_replace("{BLOQUE_NOMEGUSTA_POST}",file_get_contents("views/comunidad_mp/".$template.$id_empresa."_bloque_nomegusta.html"),$total_listado_post_recientes);
            //    }
            ///$total_listado_post_recientes =ColocaCantidadDeMegusta($total_listado_post_recientes , $unico->id_mp, $id_empresa);
            ///$tiene_favorito=COMUNIDAD_TieneInteraccionPorRut($id_empresa, $unico->id_mp, "FAVORITA", $rut);
            //if($tiene_favorito){        $total_listado_post_recientes = str_replace("{BLOQUE_FAVORITO_POR_POST}",file_get_contents("views/comunidad_mp/".$template.$id_empresa."_bloque_ya_favorito.html"),$total_listado_post_recientes);
            //}else{        $total_listado_post_recientes = str_replace("{BLOQUE_FAVORITO_POR_POST}",file_get_contents("views/comunidad_mp/".$template.$id_empresa."_bloque_favorito.html"),$total_listado_post_recientes);
            //}


             /* $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>foreach 2 : $time_elapsed<br><br>";
    $start = round(microtime(true) * 1000);    */


         $post_categoria               = '<a href="?sw=com_mp_personal&amb=mp_cat&idcat=' . $unico->id_categoria . '&cat=' . $unico->categoria . '"><span class="badge_small badge-azul"><span class="blanco"><i class="icon-people icons"></i> ' . $unico->categoria . '</span></span></a>';
            $total_listado_post_recientes = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_listado_post_recientes);
            //$total_listado_post_recientes =ColocaCantidadDeFavorito($total_listado_post_recientes, $unico->id_mp, $id_empresa);
            $total_listado_post_recientes = str_replace("{ID_MP}", $unico->id_mp, $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{ID_MP_ENCODEADO}", Encodear3($unico->id_mp), $total_listado_post_recientes);
            if ($id_empresa == '62') {
                $url_mp_comparte = "https://www.compartebci.cl/front/?sw=login_ext%26ambiente=com_mp_full%26id_mp=" . $unico->id_mp . "";
            }
            $total_listado_post_recientes = str_replace("{URL_MP_COMPARTE}", ($url_mp_comparte), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{TIPO}", "A", $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{LINK}", $link_MP, $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{CATEGORIA_MP}", $post_categoria, $total_listado_post_recientes);
            $post_ambito                  = '<a href="?sw=com_mp_personal&amb=mp_amb&idamb=' . $unico->id_ambito . '&ambito=' . $unico->ambito . '">
<span class="badge_small badge-azul"><span class="blanco"><i class="icon-people icons"></i> ' . $unico->ambito . '</span></span></a>';
            $total_listado_post_recientes = str_replace("{AMBITO_MP}", $post_ambito, $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($unico->descripcion_categoria), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{NOMBRE}", ($unico->nombre), $total_listado_post_recientes);

          /*    $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>foreach 3 : $time_elapsed<br><br>";
    $start = round(microtime(true) * 1000);    */

          if ($unico->resumen == "" and $unico->contenido == "") {
                $resumen = ($unico->resumen);
            } elseif ($unico->resumen <> "" and $unico->contenido == "") {
                $resumen = ($unico->resumen);
            } elseif ($unico->resumen == "" and $unico->contenido <> "") {
                $resumen = limit_text($unico->contenido, 35);
            } elseif ($unico->resumen <> "" and $unico->contenido <> "") {
                $resumen = ($unico->resumen);
            } else {
                $resumen = "";
            }
        /*    if ($unico->tipo == "MejorPractica") {
                $ico = "img/bci_mp_practica_icon.png";
            }
            if ($unico->tipo == "Papers") {
                $ico = "img/bci_mp_paper_icon.png";
            }
            if ($unico->tipo == "Publicacion") {
                $ico = "img/bci_mp_publicacion.png";
            }
            if ($unico->tipo == "Video" or $unico->tipo == "VideoInterno") {
                $ico = "img/bci_mp_practica_video.png";
            }
            if ($unico->tipo == "Links" or $unico->tipo == "LinkExterno") {
                $ico = "img/bci_mp_link_icon.png";
            }
            if ($unico->tipo == "Experiencias") {
                $ico = "img/bci_mp_experiencias_icon.png";
            }
            if ($unico->tipo == "Experto") {
                $ico = "img/bci_mp_experto_icon.png";
            }
            if ($unico->tipo == "OportunidadMejora") {
                $ico = "img/bci_mp_oportunidadmejora_icon.png";
            }
            if ($unico->tipo == "Udnolohaga") {
                $ico = "img/bci_mp_udnolohaga_icon.png";
            }
            if ($unico->tipo == "RRPP") {
                $ico = "img/bci_mp_rrpp_icon.png";
            }
            if ($unico->tipo == "Pregunta") {
                $ico = "img/bci_mp_pregunta_icon.png";
            }
            if ($unico->tipo == "Respuesta") {
                $ico = "img/bci_mp_pregunta_icon.png";
            }    */

        /*       $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>foreach 4 : $time_elapsed<br><br>";
    $start = round(microtime(true) * 1000);    */

           $total_listado_post_recientes = str_replace("{ICONO}", $ico, $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{DESC_ICONO}", $unico->tipo, $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{CONTENIDO}", $resumen, $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{FECHA}", formatearFechaSmall($unico->fecha), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{ESTADO}", ($unico->estado), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{DESCRIPCION_ESTADO}", ($unico->descripcion_estado), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{RUT_AUTOR}", ($unico->rut), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{RUT}", ($rut), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{NOMBRE_AUTOR}", ($Usuario[0]->nombre_completo), $total_listado_post_recientes);


    /* $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>foreach 5 : $time_elapsed<br><br>";
    $start = round(microtime(true) * 1000);    */


            $nombre_arroba=rutemailaarroba($unico->rut, $id_empresa);
            $total_listado_post_recientes = str_replace("{NOMBRE_AUTOR_ARROBA}", ($nombre_arroba), $total_listado_post_recientes);
           $total_listado_post_recientes = str_replace("{RUT_ENVIADO}", ($unico->rut), $total_listado_post_recientes);

    /*        $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>foreach 6 : $time_elapsed<br><br>";
    $start = round(microtime(true) * 1000);    */

            $total_listado_post_recientes = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($unico->rut), $total_listado_post_recientes);

            $total_listado_post_recientes = str_replace("{NUMVISITAS}", round($unico->numvisitas), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{NUMMEGUSTA}", ($unico->nummegusta), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{NUMNOMEGUSTA}", ($unico->numnomegusta), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{NUMCOMPARTIDA}", ($unico->numcompartido), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{NUMCOMENTARIO}", ($unico->numcomentarios), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{NUMCOMENTARIOSREALES}", ($unico->numcomentariosreales), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{NUMFAVORITA}", ($unico->numfavorita), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{ESTILOESTADO}", ($unico->estilo), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{ICONOESTADO}", ($unico->icono_estado), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{ESTILOCATEGORIA}", ($unico->style), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{ICONOCATEGORIA}", ($unico->icono), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{CATEGORIA_MP}", ($unico->categoria), $total_listado_post_recientes);

            if ($unico->tipo_multimedia == "imagen" and $unico->imagen_fondo <> '') {
                $imagen = "../../front/multimedia/" . $unico->multimedia;
            } else {
                $imagen = "";
            }
            if ($unico->tipo_multimedia == "video") {
                $video = "../../front/multimedia/" . $unico->multimedia;
            } else {
                $video = "";
            }

    /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>foreach 7 : $time_elapsed<br><br>";
    $start = round(microtime(true) * 1000);    */
            //echo "video $video";
            //echo $unico->video;

            $total_listado_post_recientes = str_replace("{IMAGEN_POST}", "multimedia/" . $unico->imagenfondo, $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{VIDEO}", ($video), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{TIPOMULTIMEDIA}", ($unico->tipo_multimedia), $total_listado_post_recientes);
            ///$listado_comentarios=MuestraComentariosPorPost($unico->id_mp);
            $total_listado_post_recientes = str_replace("{BLOQUE_COMENTARIOS}", $listado_comentarios, $total_listado_post_recientes);
           if ($unico->url_documento<>'' and $unico->url_documento<>'{LINK_DOCUMENTO}') {
                $total_listado_post_recientes = str_replace("{BLOQUE_URL_DOCUMENTO}", file_get_contents("views/comunidad_mp/row_com_mp_url_documento.html"), $total_listado_post_recientes);
                $total_listado_post_recientes = str_replace("{URL_DOCUMENTO}", ($unico->url_documento), $total_listado_post_recientes);
            } else {
                $total_listado_post_recientes = str_replace("{BLOQUE_URL_DOCUMENTO}", "", $total_listado_post_recientes);
            }
            if ($unico->video<>'' and $unico->video<>'{LINK_YOUTUBE}') {
                $video_youtube                = ColocaVideoYoutube($unico->video, $unico->id_mp);
                $total_listado_post_recientes = str_replace("{VIDEO_IMAGEN}", $video_youtube, $total_listado_post_recientes);
            } else {

$bloque_imagen_fondo          = ColocaImagenPost($unico->imagenfondo);
                $total_listado_post_recientes = str_replace("{VIDEO_IMAGEN}", $bloque_imagen_fondo, $total_listado_post_recientes);
            }
            //tags por post
            $TagsPorPosts = TagsPorMPEmpresa($unico->id_mp, $id_empresa);
            $tag_por_post = "";
            foreach ($TagsPorPosts as $TagsPorPost) {
                $tag_por_post .= '<a href="?sw=com_mp_personal&amb=mp_tag&tag=' . $TagsPorPost->tag . '"><span class="badge_small badge-white"><span class="negro">#' . $TagsPorPost->tag . '</span></span></a> ';
            }
            $total_listado_post_recientes = str_replace("{TAGS_POR_POST}", ($tag_por_post), $total_listado_post_recientes);
        }

    /*
    $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>foreach 8 : $time_elapsed<br><br>";
    $start = round(microtime(true) * 1000);    */




    }
    //echo "<br><br><br><br><br><br><br><br>ambiente $ambiente $tipo_query";//TIMELINE BUSCADOR INTELIGENTE



/*
    $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Ambiente : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/


 if ($tipo_query <> '') {
        $todas                                  = com_mp_resultados_inteligentes($id_empresa, $tipo_query, "", $ambiente, $subcategoria);
        $total_listado_post_personas_resultados = "";
        foreach ($todas as $unico) {
            $tpi++;
            //  echo  "<br><br><br><br>";print_r($unico);
            //    echo "<br>3475 tipopost ".$unico->tipopost." tipo ".$unico->tipo;
            //    echo "<br>".$unico->id_estado;
            //echo "subc $subcategoria, id_subcategoria ".$unico->id_subcategoria;
            if ($subcategoria <> '' and $subcategoria <> $unico->id_subcategoria) {
                // continue;
            }
            if ($subcategoria == '' and $unico->id_subcategoria <> '' and $unico->impacto <> 'PUBLICO') {
                continue;
            }
            if (in_array($unico->codigo, $guardo_codigo)) {
                continue;
            }
            $guardo_codigo[$tpi] = $unico->codigo;
            $post_categoria      = '<a href="?sw=com_mp_personal&amb=mp_cat&idcat=' . $unico->id_categoria . '&cat=' . $unico->categoria_mp . '"><span class="badge_small badge-azul"><span class="blanco"><i class="icon-people icons"></i> ' . $unico->categoria_mp . '</span></span></a>';
            if ($unico->tipoVista <> 'expertos' and $unico->tipoVista <> 'vistaexperto' and $unico->tipoVista <> 'Links' and $unico->id_estado >= 5) {
                $total_listado_post_personas_resultados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_persona_listado_tipoA1R.html");
                $total_listado_post_personas_resultados = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_listado_post_personas_resultados);
            }
            // vista personas en comunidad
            elseif ($unico->tipoVista == 'expertos') {
                $total_listado_post_personas_resultados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_persona_listado_tipoE.html");
                $total_listado_post_personas_resultados = str_replace("{HUINCHA_INTERACCIONES}", "", $total_listado_post_personas_resultados);
                $datos_interaccion_personal             = TraeBuscaInteraccionPersonal($unico->codigo, $id_empresa);
                $array_Reco_Gracias                     = BuscaDatosReconocimientoAgradecimientos($unico->codigo, $id_empresa);
                if ($array_Reco_Gracias[0]->num_gracias > 0) {
                    $num_gracias = $array_Reco_Gracias[0]->num_gracias;
                } else {
                    $num_gracias = 0;
                }
                if ($array_Reco_Gracias[0]->num_reconocimientos > 0) {
                    $num_reconocimientos = $array_Reco_Gracias[0]->num_reconocimientos;
                } else {
                    $num_reconocimientos = 0;
                }
                $total_listado_post_personas_resultados = str_replace("{NUM_RECONOCIMIENTOS}", $num_reconocimientos, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_GRACIAS}", $num_gracias, $total_listado_post_personas_resultados);
                if ($datos_interaccion_personal[0]->numbcicoins == "") {
                    $num_coins = 0;
                } else {
                    $num_coins = $datos_interaccion_personal[0]->numbcicoins;
                }
                if ($datos_interaccion_personal[0]->numaptitudesvalidadas == "") {
                    $num_aptitudes = 0;
                } else {
                    $num_aptitudes = $datos_interaccion_personal[0]->numaptitudesvalidadas;
                }
                if ($datos_interaccion_personal[0]->numpublicaciones == "") {
                    $num_publicaciones = 0;
                } else {
                    $num_publicaciones = $datos_interaccion_personal[0]->numpublicaciones;
                }
                if ($datos_interaccion_personal[0]->numseguidores == "") {
                    $num_seguidores = 0;
                } else {
                    $num_seguidores = $datos_interaccion_personal[0]->numseguidores;
                }
                $total_listado_post_personas_resultados = str_replace("{NUM_BCICOINS}", $num_coins, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_SEGUIDORES}", $num_seguidores, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_SEGUIDOS}", $datos_interaccion_personal[0]->numseguidos, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_PUBLICACIONES}", $num_publicaciones, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_MEGUSTA_FAVORITAS}", $datos_interaccion_personal[0]->nummegustafavorita, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_VISITAS}", $datos_interaccion_personal[0]->numvisitas, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_COMENTARIOS}", $datos_interaccion_personal[0]->numcomentarios, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_APTITUDESVALIDADAS}", $num_aptitudes, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_PUBLICACIONESSEGUIDAS}", $datos_interaccion_personal[0]->publicacionesseguidas, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_INTERACCIONES}", $datos_interaccion_personal[0]->numinteracciones, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{RUTEXPERTO}", $unico->codigo, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{CARGO_EXPERTO}", $unico->cargo_experto, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NOMBRE_EXPERTO}", $unico->nombre_experto, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($unico->codigo), $total_listado_post_personas_resultados);
            } elseif ($unico->tipoVista == 'vistaexperto') {
                $total_listado_post_personas_resultados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_persona_listado_tipoEX.html");
                $total_listado_post_personas_resultados = str_replace("{HUINCHA_INTERACCIONES}", "", $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NOMBRE_EXPERTO}", $unico->nombre_experto, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{GRUPOINTERES}", $unico->categoria_mp, $total_listado_post_personas_resultados);
                $datos_interaccion_personal             = TraeBuscaInteraccionPersonal($unico->codigo, $id_empresa);
                if ($datos_interaccion_personal[0]->numbcicoins == "") {
                    $num_coins = 0;
                } else {
                    $num_coins = $datos_interaccion_personal[0]->numbcicoins;
                }
                if ($datos_interaccion_personal[0]->numaptitudesvalidadas == "") {
                    $num_aptitudes = 0;
                } else {
                    $num_aptitudes = $datos_interaccion_personal[0]->numaptitudesvalidadas;
                }
                if ($datos_interaccion_personal[0]->numpublicaciones == "") {
                    $num_publicaciones = 0;
                } else {
                    $num_publicaciones = $datos_interaccion_personal[0]->numpublicaciones;
                }
                if ($datos_interaccion_personal[0]->numseguidores == "") {
                    $num_seguidores = 0;
                } else {
                    $num_seguidores = $datos_interaccion_personal[0]->numseguidores;
                }
                $total_listado_post_personas_resultados = str_replace("{NUM_BCICOINS}", $num_coins, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_SEGUIDORES}", $num_seguidores, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_SEGUIDOS}", $datos_interaccion_personal[0]->numseguidos, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_PUBLICACIONES}", $num_publicaciones, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_MEGUSTA_FAVORITAS}", $datos_interaccion_personal[0]->nummegustafavorita, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_VISITAS}", $datos_interaccion_personal[0]->numvisitas, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_COMENTARIOS}", $datos_interaccion_personal[0]->numcomentarios, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_APTITUDESVALIDADAS}", $num_aptitudes, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_PUBLICACIONESSEGUIDAS}", $datos_interaccion_personal[0]->publicacionesseguidas, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_INTERACCIONES}", $datos_interaccion_personal[0]->numinteracciones, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{RUTEXPERTO}", $unico->codigo, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{CARGO_EXPERTO}", $unico->cargo_experto, $total_listado_post_personas_resultados);
            } elseif ($unico->tipoVista == 'Links' and $unico->id_estado >= 5) {
                $total_listado_post_personas_resultados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_persona_listado_tipoL.html");
                $total_listado_post_personas_resultados = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{LINK_IDMP}", $unico->url_documento, $total_listado_post_personas_resultados);
            } else {
            }
            if ($unico->rut == $rut) {
                $total_listado_post_personas_resultados = str_replace("{EDITAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_editar_mp.html"), $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{ELIMINAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_borrar_mp.html"), $total_listado_post_personas_resultados);
            } else {
                $total_listado_post_personas_resultados = str_replace("{EDITAR_MP}", "", $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{ELIMINAR_MP}", "", $total_listado_post_personas_resultados);
            }
            //echo "<br>hola post tipo".$unico->tipo;

            if ($unico->rut_mentor <> '') {
                $nombre_mentor = UsuarioEnBasePersonaPorEmpresa($unico->rut_mentor, $id_empresa);
                $mentor        = "<a href='?sw=com_mp_personal&rut_enviado=" . $nombre_mentor[0]->rut . "&vp=1'><div class='badge_small badge-verde blanco mgtop5'>    <i class='icon-check icons'></i> Respondido por " . $nombre_mentor[0]->nombre_completo . "</div></a>";
            } else {
                $mentor = "";
            }
            $total_listado_post_personas_resultados = str_replace("{NOMBRE_MENTOR}", ($mentor), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{ICONO}", $ico, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{DESC_ICONO}", $unico->tipo, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = ColocaCantidadDeFavorito($total_listado_post_personas_resultados, $unico->id_mp, $id_empresa);
            $total_listado_post_personas_resultados = str_replace("{ID_MP}", $unico->codigo, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{LINK}", $link_MP, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($unico->descripcion_categoria), $total_listado_post_personas_resultados);
            if ($unico->resumen == "" and $unico->contenido == "") {
                $resumen = ($unico->resumen);
            } elseif ($unico->resumen <> "" and $unico->contenido == "") {
                $resumen = ($unico->resumen);
            } elseif ($unico->resumen == "" and $unico->contenido <> "") {
                $resumen = limit_text($unico->contenido, 35);
            } elseif ($unico->resumen <> "" and $unico->contenido <> "") {
                $resumen = ($unico->resumen);
            } else {
                $resumen = "";
            }
            if ($unico->tipopost <> 'expertos') {
                $total_listado_post_personas_resultados = str_replace("{NOMBRE}", ($unico->nombre), $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{CATEGORIA_MP}", $post_categoria, $total_listado_post_personas_resultados);
                $post_ambito                            = '<a href="?sw=com_mp_personal&amb=mp_amb&idamb=' . $unico->id_ambito . '&ambito=' . $unico->ambito . '">
<span class="badge_small badge-azul"><span class="blanco"><i class="icon-people icons"></i> ' . $unico->ambito . '</span></span></a>';
                $total_listado_post_personas_resultados = str_replace("{AMBITO_MP}", $post_ambito, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{RUT_AUTOR}", ($unico->rut), $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($unico->rut), $total_listado_post_personas_resultados);
                $link                                   = "?sw=com_mp_full&id_mp=" . $unico->codigo . "";
            } else {
                $total_listado_post_personas_resultados = str_replace("{NOMBRE}", ("$resumen"), $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{CATEGORIA_MP}", $post_categoria, $total_listado_post_personas_resultados);
                $post_ambito                            = '<a href="?sw=com_mp_personal&amb=mp_amb&idamb=' . $unico->id_ambito . '&ambito=' . $unico->ambito . '">
<span class="badge_small badge-azul"><span class="blanco"><i class="icon-people icons"></i> ' . $unico->ambito . '</span></span></a>';
                $total_listado_post_personas_resultados = str_replace("{AMBITO_MP}", $post_ambito, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{RUT_AUTOR}", ($unico->contenido), $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($unico->codigo), $total_listado_post_personas_resultados);
                $link                                   = "?sw=com_mp_personal&rut_enviado=" . $unico->codigo . "&vp=1&mp=1";
            }
            $tiene_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $unico->codigo, "MEGUSTA", $rut);
            if ($tiene_megusta) {
                $total_listado_post_personas_resultados = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta.html"), $total_listado_post_personas_resultados);
            } else {
                $total_listado_post_personas_resultados = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta.html"), $total_listado_post_personas_resultados);
            }
            $total_listado_post_personas_resultados = ColocaCantidadDeMegusta($total_listado_post_personas_resultados, $unico->codigo, $id_empresa);
            //$total_listado_post_personas_resultados =ColocaCantidadDeNoMegusta($total_listado_post_personas_resultados , $unico->codigo, $id_empresa);
            $total_listado_post_personas_resultados = str_replace("{TIPO}", "A", $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{ID_MP}", ($unico->codigo), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{CONTENIDO}", $resumen, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{FECHA}", formatearFechaSmall($unico->fecha), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{ESTADO}", ($unico->estado), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{DESCRIPCION_ESTADO}", ($unico->descripcion_estado), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{RUT}", ($rut), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NOMBRE_AUTOR}", ($unico->nombre_autor), $total_listado_post_personas_resultados);
                        $nombre_arroba=rutemailaarroba($unico->rut, $id_empresa);
            $total_listado_post_personas_resultados = str_replace("{NOMBRE_AUTOR_ARROBA}", ($nombre_arroba), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{RUT_ENVIADO}", ($unico->rut), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUMVISITAS}", round($unico->numvisitas), $total_listado_post_personas_resultados);
            //$total_listado_post_personas_resultados = str_replace("{NUMMEGUSTA}",($unico->nummegusta),$total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUMNOMEGUSTA}", ($unico->numnomegusta), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUMCOMPARTIDA}", ($unico->numcompartido), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUMCOMENTARIO}", ($unico->numcomentarios), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUMCOMENTARIOSREALES}", ($unico->numcomentariosreales), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUMFAVORITA}", ($unico->numfavorita), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{ESTILOESTADO}", ($unico->estilo), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{ICONOESTADO}", ($unico->icono_estado), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{ESTILOCATEGORIA}", ($unico->style), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{ICONOCATEGORIA}", ($unico->icono), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{CATEGORIA_MP}", ($unico->categoria), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{LINK}", ($link), $total_listado_post_personas_resultados);
            if ($unico->tipo_multimedia == "imagen") {
                $imagen = "../../front/multimedia/" . $unico->multimedia;
            } else {
                $imagen = "";
            }
            if ($unico->tipo_multimedia == "video") {
                $video = "../../front/multimedia/" . $unico->multimedia;
            } else {
                $video = "";
            }
            $total_listado_post_personas_resultados = str_replace("{IMAGEN_POST}", "multimedia/" . $unico->imagenfondo, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{VIDEO}", ($video), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{TIPOMULTIMEDIA}", ($unico->tipo_multimedia), $total_listado_post_personas_resultados);
            $listado_comentarios                    = MuestraComentariosPorPost($unico->id_mp);
            $total_listado_post_personas_resultados = str_replace("{BLOQUE_COMENTARIOS}", $listado_comentarios, $total_listado_post_personas_resultados);
            if ($unico->url_documento) {
                $total_listado_post_personas_resultados = str_replace("{BLOQUE_URL_DOCUMENTO}", file_get_contents("views/comunidad_mp/row_com_mp_url_documento.html"), $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{URL_DOCUMENTO}", ($unico->url_documento), $total_listado_post_personas_resultados);
            } else {
                $total_listado_post_personas_resultados = str_replace("{BLOQUE_URL_DOCUMENTO}", "", $total_listado_post_personas_resultados);
            }
            //echo "<br> video".$unico->video." imagen".$unico->imagenfondo;
            if ($unico->video) {
                $video_youtube                          = ColocaVideoYoutube($unico->video, $unico->id_mp);
                $total_listado_post_personas_resultados = str_replace("{VIDEO_IMAGEN}", $video_youtube, $total_listado_post_personas_resultados);
            } elseif ($unico->imagenfondo) {
                $bloque_imagen_fondo                    = ColocaImagenPost($unico->imagenfondo);
                $total_listado_post_personas_resultados = str_replace("{VIDEO_IMAGEN}", $bloque_imagen_fondo, $total_listado_post_personas_resultados);
            } else {
                $total_listado_post_personas_resultados = str_replace("{VIDEO_IMAGEN}", "", $total_listado_post_personas_resultados);
            }
            $total_listado_post_personas_resultados = str_replace("{TITULO_R}", $tituloR, $total_listado_post_personas_resultados);
            //tags por post
            $TagsPorPosts                           = TagsPorMPEmpresa($unico->codigo, $id_empresa);
            $tag_por_post                           = "";
            foreach ($TagsPorPosts as $TagsPorPost) {
                $tag_por_post .= '<a href="?sw=com_mp_personal&amb=mp_tag&tag=' . $TagsPorPost->tag . '"><span class="badge_small badge-white"><span class="negro">#' . $TagsPorPost->tag . '</span></span></a> ';
            }
            $total_listado_post_personas_resultados = str_replace("{TAGS_POR_POST}", ($tag_por_post), $total_listado_post_personas_resultados);
        }
        // no encontraste resultados?
        $mp_hacerpregunta .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_hacer_pregunta.html");
        $mp_hacerpregunta = str_replace("{PREGUNTA}", $tipo_query, $mp_hacerpregunta);
    }



    $ultimos_posteos_publicados       = com_mp_preguntas_ultimos_recientes($rut, $id_empresa, $subcategoria);
    $total_ultimos_posteos_publicados = "";
    //print_r($ultimos_posteos_publicados);
    foreach ($ultimos_posteos_publicados as $post_reciente) {
        $total_ultimos_posteos_publicados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_mini.html");
        $total_ultimos_posteos_publicados = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($post_reciente->rut), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{ID_MP}", $post_reciente->id_mp, $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{LINK}", $link_MP, $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{TIPO}", "F", $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{CATEGORIA_MP}", ($post_reciente->categoria), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($post_reciente->descripcion_categoria), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{NOMBRE}", ($post_reciente->nombre), $total_ultimos_posteos_publicados);
        /*    $total_ultimos_posteos_publicados= str_replace("{CONTENIDO}",limit_text($post_reciente->contenido,35),$total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados= str_replace("{FECHA}",formatearFechaSmall($post_reciente->fecha),$total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados= str_replace("{ESTADO}",($post_reciente->estado),$total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados= str_replace("{DESCRIPCION_ESTADO}",($post_reciente->descripcion_estado),$total_ultimos_posteos_publicados);
        */
        $total_ultimos_posteos_publicados = str_replace("{RUT_AUTOR}", ($post_reciente->rut), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{RUT}", ($rut), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{NOMBRE_AUTOR}", ($post_reciente->nombre_autor), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($post_reciente->rut), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{ESTILOESTADO}", ($post_reciente->estilo), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{ICONOESTADO}", ($post_reciente->icono_estado), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{ESTILOCATEGORIA}", ($post_reciente->style), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{ICONOCATEGORIA}", ($post_reciente->icono), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{CATEGORIA_MP}", ($post_reciente->categoria), $total_ultimos_posteos_publicados);
        /*
        $total_ultimos_posteos_publicados= str_replace("{IMAGEN_POST}","multimedia/".$post_reciente->imagenfondo,$total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados= str_replace("{VIDEO}",($video),$total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados= str_replace("{TIPOMULTIMEDIA}",($post_reciente->tipo_multimedia),$total_ultimos_posteos_publicados);
        */
        $total_ultimos_posteos_publicados = str_replace("{NOMBRE}", ($post_reci_reciente->nombre), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{RUT_ENVIADO}", ($post_reciente->rut), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{ID_MP}", ($post_reciente->id_mp), $total_ultimos_posteos_publicados);
    }
    //$ultimos_preguntas_publicadas_sinresponder = com_mp_preguntas_ultimos_recientes($rut, $id_empresa, $array_MP_template[0]->template);
    //print_r($ultimos_preguntas_publicadas_sinresponder);
    $total_preguntas_sin_responder             = "";

    //$mp_com_frases_comunidad = com_mp_frases($id_empresa);
    //print_r($mp_com_frases);
    $total_mp_com_frases     = "";

    $mp_com_grupos_interes_subcategorias_comunidad = com_mp_grupos_interes_subcategorias($rut, $id_empresa);
    //echo "<br><br><br><br>".count($mp_com_grupos_interes_subcategorias_comunidad);
    //echo "<br><br><br><br>function 5439 hola";
    //print_r($mp_com_grupos_interes_subcategorias_comunidad);
    if (count($mp_com_grupos_interes_subcategorias_comunidad) > 0) {
        $tit_mp_com_grupos_interes_subcategorias_comunidad = "
        <div class='widget clearfix hidden-xs'>
<h4><i class='fab fa-slideshare'></i> Tus Grupos Privados</h4>
<div class='panel-body' style='display: block'>


        ";

    /*     <div class='acctitle'>
&nbsp;<i class='icon-bookmark icons'></i><small> Grupos Cerrados a los que perteneces</small>
</div> */

    } else {
        $tit_mp_com_grupos_interes_subcategorias_comunidad = "";
    }

//eventos

 $array_eventos=Lista_eventos_postulables_mp_com_general_data($id_empresa);
     if (count($array_eventos) > 0) {
          foreach($array_eventos as $unico ){// print_r($unico);
        //echo "<br>cuenta ".$unico->cuenta.">".$unico->cupos;
    $cuposinscritos=0;
                   if($unico->cupos<=$unico->cuenta){$cuposinscritos=1;}
        $lista_eventos_postulables_mp_com_general .= file_get_contents("views/comunidad_mp/".  $id_empresa . "_com_mp_row_eventos.html");
        $lista_eventos_postulables_mp_com_general = str_replace("{ID_EVENTO_ENCODEADO}", Encodear3($unico->codigo), $lista_eventos_postulables_mp_com_general);
        $lista_eventos_postulables_mp_com_general = str_replace("{NOMBRE_EVENTO}", ($unico->nombre), $lista_eventos_postulables_mp_com_general);
        $lista_eventos_postulables_mp_com_general = str_replace("{DESCRIPCION_EVENTO}", ($unico->descripcion), $lista_eventos_postulables_mp_com_general);
        $lista_eventos_postulables_mp_com_general = str_replace("{IMAGEN_EVENTO}", ($unico->imagen), $lista_eventos_postulables_mp_com_general);

        $array_inscripcion_evento=Lista_eventos_postulables_mp_com_generalRut_data($id_empresa, $rut, $unico->codigo);
        $suma_inscritos=Lista_eventos_postulables_mp_com_generalSUma_data($id_empresa,  $unico->codigo);

        if($array_inscripcion_evento[0]->id>0) {
              $boton_postulacion_ya_inscrito= "<span class='badge bg-verde'><span class='blanco'><i class='icon-check icons'></i> Ya inscrito</span></span> <br><small>Junto contigo ya hay ".$suma_inscritos." inscritos.</small>";
        }
         elseif($cuposinscritos>0) {
            $boton_postulacion_ya_inscrito=   "
            <small>Los cupos ya se completaron.</small>";

        }  else {
            $boton_postulacion_ya_inscrito=   "<a href='?sw=save_inscripcion_evento&amp;idc=".Encodear3($unico->codigo)."' class='btn btn-warning btn btn-block' data-original-title='' title=''><span class='blanco'>Inscr&iacute;bete aqu&iacute;</span></a>
            <br><small>Sumate a los ".$suma_inscritos." inscritos.</small>";

        }

//        print_r($array_inscripcion_evento);
         // $boton_postulacion_ya_inscrito=
        $lista_eventos_postulables_mp_com_general = str_replace("{POSTULACION_EVENTOS_MP}", ($boton_postulacion_ya_inscrito), $lista_eventos_postulables_mp_com_general);

          }
     }else {

$lista_eventos_postulables_mp_com_general="Sin Eventos";
     }


     //BUSCAMISEVENTOS}
     $lista_eventos_inscritos_mp_com_general="";
     $cuenta_mis_inscripcion_eventos=0;
     $array_misEnventos_inscritos=MP_Lee_misPostulaciones_eventos($rut, $id_empresa);
     foreach($array_misEnventos_inscritos as $unico){
         //print_r($unico);
        $lista_eventos_inscritos_mp_com_general .= file_get_contents("views/comunidad_mp/".  $id_empresa . "_com_mp_row_eventos_desinscribir.html");
        $lista_eventos_inscritos_mp_com_general = str_replace("{ID_EVENTO_ENCODEADO}", Encodear3($unico->id), $lista_eventos_inscritos_mp_com_general);
        $lista_eventos_inscritos_mp_com_general = str_replace("{NOMBRE_EVENTO}", utf8_decode($unico->nombre_evento), $lista_eventos_inscritos_mp_com_general);
        $lista_eventos_inscritos_mp_com_general = str_replace("{DESCRIPCION_EVENTO}", utf8_decode($unico->dato3), $lista_eventos_inscritos_mp_com_general);
        $lista_eventos_inscritos_mp_com_general = str_replace("{ID_EVENTO}", ($unico->id), $lista_eventos_inscritos_mp_com_general);
     }



    $total_mp_com_grupos_interes_subcat = "";
    foreach ($mp_com_grupos_interes_subcategorias_comunidad as $mp_com_grupo_int_subc_com) {
        //print_r($mp_com_grupo_int_subc_com);
        //echo "<br>template $template";
        $total_mp_com_grupos_intereses_subcat .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_grupos_interes_subcategoria.html");
        $link_id_subcatg                      = "?sw=com_mp_personal&sess=" . Encodear3($mp_com_grupo_int_subc_com->id_subcategoria);
        $link_id_subcatg_pasivo               = "?sw=com_mp_personal";
        $total_mp_com_grupos_intereses_subcat = str_replace("{LINK_GRUPO}", ($link_id_subcatg), $total_mp_com_grupos_intereses_subcat);
        $total_mp_com_grupos_intereses_subcat = str_replace("{TITULO_GRUPO}", ($mp_com_grupo_int_subc_com->nombre), $total_mp_com_grupos_intereses_subcat);
        $total_mp_com_grupos_intereses_subcat = str_replace("{ICONO_GRUPO}", ($mp_com_grupo_int_subc_com->icon), $total_mp_com_grupos_intereses_subcat);
    }


    /* $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_01 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000); */

    // MP MAS VALORADOS
    $posteos_mas_valorados       = com_mp_post_mas_valorados($rut, $id_empresa, $subcategoria);
    $total_posteos_mas_valorados = "";
    //print_r($posteos_mas_valorados);
    foreach ($posteos_mas_valorados as $post_recent) {
        if ($subcategoria <> '' and $subcategoria <> $post_recent->id_subcategoria) {
            continue;
        }
        if ($subcategoria == '' and $post_recent->id_subcategoria <> '') {
            continue;
        }
        $total_posteos_mas_valorados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_mini.html");
        $total_posteos_mas_valorados = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($post_recent->rut), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{ID_MP}", $post_recent->id_mp, $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{LINK}", $link_MP, $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{TIPO}", "F", $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{CATEGORIA_MP}", ($post_recent->categoria), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($post_recent->descripcion_categoria), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{NOMBRE}", ($post_recent->nombre), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{CONTENIDO}", ($post_recent->contenido), $total_posteos_mas_valorados);

        /*
        $total_posteos_mas_valorados = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_posteos_mas_valorados);
        if ($post_recent->rut == $rut) {
            $total_posteos_mas_valorados = str_replace("{EDITAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_editar_mp.html"), $total_posteos_mas_valorados);
            $total_posteos_mas_valorados = str_replace("{ELIMINAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_borrar_mp.html"), $total_posteos_mas_valorados);
        } else {
            $total_posteos_mas_valorados = str_replace("{EDITAR_MP}", "", $total_posteos_mas_valorados);
            $total_posteos_mas_valorados = str_replace("{ELIMINAR_MP}", "", $total_posteos_mas_valorados);
        }
       // $tiene_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "MEGUSTA", $rut);
        if ($tiene_megusta) {
            $total_posteos_mas_valorados = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta.html"), $total_posteos_mas_valorados);
        } else {
            $total_posteos_mas_valorados = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta.html"), $total_posteos_mas_valorados);
        }
       // $tiene_no_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "NOMEGUSTA", $rut);
        if ($tiene_no_megusta) {
            $total_posteos_mas_valorados = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_nomegusta.html"), $total_posteos_mas_valorados);
        } else {
            $total_posteos_mas_valorados = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_nomegusta.html"), $total_posteos_mas_valorados);
        }
        //$total_posteos_mas_valorados = ColocaCantidadDeMegusta($total_posteos_mas_valorados, $post_recent->id_mp, $id_empresa);
       // $tiene_favorito              = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "FAVORITA", $rut);
        if ($tiene_favorito) {
            $total_posteos_mas_valorados = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_favorito.html"), $total_posteos_mas_valorados);
        } else {
            $total_posteos_mas_valorados = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_favorito.html"), $total_posteos_mas_valorados);
        }
        */
        $total_posteos_mas_valorados = str_replace("{ESTADO}", ($post_recent->estado), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{DESCRIPCION_ESTADO}", ($post_recent->descripcion_estado), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{RUT_AUTOR}", ($post_recent->rut), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{RUT}", ($rut), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{NOMBRE_AUTOR}", ($post_recent->nombre_autor), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($post_recent->rut), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{ESTILOESTADO}", ($post_recent->estilo), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{ICONOESTADO}", ($post_recent->icono_estado), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{ESTILOCATEGORIA}", ($post_recent->style), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{ICONOCATEGORIA}", ($post_recent->icono), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{CATEGORIA_MP}", ($post_recent->categoria), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{NOMBRE}", ($post_recent->nombre), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{RUT_ENVIADO}", ($post_recent->rut), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{ID_MP}", ($post_recent->id_mp), $total_posteos_mas_valorados);
    }

    /* $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_02 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/


    // MP NOVEDADES
    $posteos_mas_novedades   = com_mp_post_portipo("Novedades", $id_empresa, $subcategoria);
    $total_posteos_novedades = "";
    foreach ($posteos_mas_novedades as $post_recent) {
        $total_posteos_novedades .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_mini_banner.html");
        $total_posteos_novedades = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($post_recent->rut), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{ID_MP}", $post_recent->id_mp, $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{LINK}", $link_MP, $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{TIPO}", "F", $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{CATEGORIA_MP}", ($post_recent->categoria), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($post_recent->descripcion_categoria), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{NOMBRE}", ($post_recent->nombre), $total_posteos_novedades);
        if ($id_empresa == 53) {
            $total_posteos_novedades = str_replace("{CONTENIDO}", substr($post_recent->contenido, 0, 150), $total_posteos_novedades);
        } else {
            $total_posteos_novedades = str_replace("{CONTENIDO}", ($post_recent->contenido), $total_posteos_novedades);
        }
        $total_posteos_novedades = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_posteos_novedades);
        if ($post_recent->rut == $rut) {
            $total_posteos_novedades = str_replace("{EDITAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_editar_mp.html"), $total_posteos_novedades);
            $total_posteos_novedades = str_replace("{ELIMINAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_borrar_mp.html"), $total_posteos_novedades);
        } else {
            $total_posteos_novedades = str_replace("{EDITAR_MP}", "", $total_posteos_novedades);
            $total_posteos_novedades = str_replace("{ELIMINAR_MP}", "", $total_posteos_novedades);
        }
        $tiene_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "MEGUSTA", $rut);
        if ($tiene_megusta) {
            $total_posteos_novedades = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta.html"), $total_posteos_novedades);
        } else {
            $total_posteos_novedades = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta.html"), $total_posteos_novedades);
        }
        $tiene_no_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "NOMEGUSTA", $rut);
        if ($tiene_no_megusta) {
            $total_posteos_novedades = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_nomegusta.html"), $total_posteos_novedades);
        } else {
            $total_posteos_novedades = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_nomegusta.html"), $total_posteos_novedades);
        }
        $total_posteos_novedades = ColocaCantidadDeMegusta($total_posteos_novedades, $post_recent->id_mp, $id_empresa);
        $tiene_favorito          = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "FAVORITA", $rut);
        if ($tiene_favorito) {
            $total_posteos_novedades = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_favorito.html"), $total_posteos_novedades);
        } else {
            $total_posteos_novedades = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_favorito.html"), $total_posteos_novedades);
        }
        $total_posteos_novedades = str_replace("{ESTADO}", ($post_recent->estado), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{DESCRIPCION_ESTADO}", ($post_recent->descripcion_estado), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{RUT_AUTOR}", ($post_recent->rut), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{RUT}", ($rut), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{NOMBRE_AUTOR}", ($post_recent->nombre_autor), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($post_recent->rut), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{ESTILOESTADO}", ($post_recent->estilo), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{ICONOESTADO}", ($post_recent->icono_estado), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{ESTILOCATEGORIA}", ($post_recent->style), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{ICONOCATEGORIA}", ($post_recent->icono), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{CATEGORIA_MP}", ($post_recent->categoria), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{IMAGEN_POST}", "multimedia/" . $post_recent->imagenfondo, $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{VIDEO}", ($video), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{TIPOMULTIMEDIA}", ($post_recent->tipo_multimedia), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{NOMBRE}", ($post_recent->nombre), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{RUT_ENVIADO}", ($post_recent->rut), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{ID_MP}", ($post_recent->id_mp), $total_posteos_novedades);
    }

    /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_03 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);    */

    // MP FOTOS
    $posteos_mas_fotos   = com_mp_post_portipo("Foto", $id_empresa, $subcategoria);
    $total_posteos_fotos = "";
    foreach ($posteos_mas_fotos as $post_recent) {
        $total_posteos_fotos .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_mini_banner.html");
        $total_posteos_fotos = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($post_recent->rut), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{ID_MP}", $post_recent->id_mp, $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{LINK}", $link_MP, $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{TIPO}", "F", $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{CATEGORIA_MP}", ($post_recent->categoria), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($post_recent->descripcion_categoria), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{NOMBRE}", ($post_recent->nombre), $total_posteos_fotos);
        if ($id_empresa == 53) {
            $total_posteos_fotos = str_replace("{CONTENIDO}", substr($post_recent->contenido, 0, 150), $total_posteos_fotos);
        } else {
            $total_posteos_fotos = str_replace("{CONTENIDO}", ($post_recent->contenido), $total_posteos_fotos);
        }
        $total_posteos_fotos = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_posteos_fotos);
        if ($post_recent->rut == $rut) {
            $total_posteos_fotos = str_replace("{EDITAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_editar_mp.html"), $total_posteos_fotos);
            $total_posteos_fotos = str_replace("{ELIMINAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_borrar_mp.html"), $total_posteos_fotos);
        } else {
            $total_posteos_fotos = str_replace("{EDITAR_MP}", "", $total_posteos_fotos);
            $total_posteos_fotos = str_replace("{ELIMINAR_MP}", "", $total_posteos_fotos);
        }
        $tiene_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "MEGUSTA", $rut);
        if ($tiene_megusta) {
            $total_posteos_fotos = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta.html"), $total_posteos_fotos);
        } else {
            $total_posteos_fotos = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta.html"), $total_posteos_fotos);
        }
        $tiene_no_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "NOMEGUSTA", $rut);
        if ($tiene_no_megusta) {
            $total_posteos_fotos = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_nomegusta.html"), $total_posteos_fotos);
        } else {
            $total_posteos_fotos = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_nomegusta.html"), $total_posteos_fotos);
        }
        $total_posteos_fotos = ColocaCantidadDeMegusta($total_posteos_fotos, $post_recent->id_mp, $id_empresa);
        $tiene_favorito      = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "FAVORITA", $rut);
        if ($tiene_favorito) {
            $total_posteos_fotos = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_favorito.html"), $total_posteos_fotos);
        } else {
            $total_posteos_fotos = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_favorito.html"), $total_posteos_fotos);
        }
        $total_posteos_fotos = str_replace("{ESTADO}", ($post_recent->estado), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{DESCRIPCION_ESTADO}", ($post_recent->descripcion_estado), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{RUT_AUTOR}", ($post_recent->rut), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{RUT}", ($rut), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{NOMBRE_AUTOR}", ($post_recent->nombre_autor), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($post_recent->rut), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{ESTILOESTADO}", ($post_recent->estilo), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{ICONOESTADO}", ($post_recent->icono_estado), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{ESTILOCATEGORIA}", ($post_recent->style), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{ICONOCATEGORIA}", ($post_recent->icono), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{CATEGORIA_MP}", ($post_recent->categoria), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{IMAGEN_POST}", "multimedia/" . $post_recent->imagenfondo, $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{VIDEO}", ($video), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{TIPOMULTIMEDIA}", ($post_recent->tipo_multimedia), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{NOMBRE}", ($post_recent->nombre), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{RUT_ENVIADO}", ($post_recent->rut), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{ID_MP}", ($post_recent->id_mp), $total_posteos_fotos);
    }


    /* $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_04 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/
    // MP CAPACITACIONES


    /* $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_05 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000); */
    /*
    $peoples_mas_seguida      = com_mp_people_mas_seguida($rut, $id_empresa, $subcategoria);
    $total_people_mas_seguida = "";
    //print_r($peoples_mas_seguida);
    foreach ($peoples_mas_seguida as $people_maseguidA) {
        $total_people_mas_seguida .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_people_mini.html");
        $total_people_mas_seguida = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($people_maseguidA->rut), $total_people_mas_seguida);
        $total_people_mas_seguida = str_replace("{NOMBRE}", ($people_maseguidA->nombre), $total_people_mas_seguida);
        $total_people_mas_seguida = str_replace("{RUT_ENVIADO}", ($people_maseguidA->rut), $total_people_mas_seguida);
        $total_people_mas_seguida = str_replace("{SEGUIDORES}", ($people_maseguidA->seguidores . " seguidores"), $total_people_mas_seguida);
        $total_people_mas_seguida = str_replace("{PUNTOS}", "", $total_people_mas_seguida);
        // BOTON SEGUIR
        $sesiguepersona           = count(VerificandompaSeguidores($rut, $people_maseguidA->rut, $id_empresa));
        if ($sesiguepersona > 0) {
            $boton_seguir = "<center style='display: inline;'>    <div class='badge_small badge-verde blanco mgtop5'>    <i class='icon-check icons'></i> Siguiendo </div>
        <a href='?sw=com_mp_personal&rut_enviado=" . $people_maseguidA->rut . "&vp=1&sg=2' class='badge_small bg-white_borderBlue negro'>
        <i class='icon-user-following icons'></i> Dejar de seguir (-)</a></center>";
        } else {
            $boton_seguir = "<center style='display: inline;'><a href='?sw=com_mp_personal&rut_enviado=" . $people_maseguidA->rut . "&vp=1&sg=1'
         class='badge_small bg-amarillos negro'>
        <i class='icon-user-following icons'></i> Seguir (+)</a></center>";
        }
        $total_people_mas_seguida = str_replace("{BOTON_SEGUIR}", ($boton_seguir), $total_people_mas_seguida);
    }



    /* $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_06 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000); */
     /*
    $peoples_mas_puntos      = com_mp_people_mas_puntos($rut, $id_empresa, $subcategoria);
    $total_people_mas_puntos = "";
    //print_r($peoples_mas_puntos);
    //exit();
    foreach ($peoples_mas_puntos as $peoples_ma_punto) {
        $total_people_mas_puntos .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_people_mini.html");
        $total_people_mas_puntos = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($peoples_ma_punto->rut), $total_people_mas_puntos);
        $total_people_mas_puntos = str_replace("{NOMBRE}", ($peoples_ma_punto->nombre), $total_people_mas_puntos);
        $total_people_mas_puntos = str_replace("{RUT_ENVIADO}", ($peoples_ma_punto->rut), $total_people_mas_puntos);
        $total_people_mas_puntos = str_replace("{SEGUIDORES}", "", $total_people_mas_puntos);
        $total_people_mas_puntos = str_replace("{PUNTOS}", $peoples_ma_punto->puntos . " Bci Coins", $total_people_mas_puntos);
        // BOTON SEGUIR
        $sesiguepersona          = count(VerificandompaSeguidores($rut, $peoples_ma_punto->rut, $id_empresa));
        if ($sesiguepersona > 0) {
            $boton_seguir = "<center>    <div class='badge_small badge-verde blanco mgtop5'>    <i class='icon-check icons'></i> Siguiendo </div>
        <a href='?sw=com_mp_personal&rut_enviado=" . $peoples_ma_punto->rut . "&vp=1&sg=2'
        class='badge_small bg-amarillos negro'>
        <i class='icon-user-following icons'></i> Dejar de seguir (-)</a></center>";
        } else {
            $boton_seguir = "<center><a href='?sw=com_mp_personal&rut_enviado=" . $peoples_ma_punto->rut . "&vp=1&sg=1' class='badge_small bg-amarillos negro'>        <i class='icon-user-following icons'></i> Seguir (+)</a></center>";
        }
        $total_people_mas_puntos = str_replace("{BOTON_SEGUIR}", ($boton_seguir), $total_people_mas_puntos);
    }

    /*
    $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_07 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/
      /*
    $peoples_mas_interacciones = com_mp_people_mas_interacciones($rut, $id_empresa, $subcategoria);
    $total_people_mas_interacc = "";
    //print_r($peoples_mas_interacciones);
    foreach ($peoples_mas_interacciones as $people_mas_interacc) {
        $total_people_mas_interacc .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_people_mini.html");
        $total_people_mas_interacc = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($people_mas_interacc->rut), $total_people_mas_interacc);
        $total_people_mas_interacc = str_replace("{NOMBRE}", ($people_mas_interacc->nombre), $total_people_mas_interacc);
        $total_people_mas_interacc = str_replace("{RUT_ENVIADO}", ($people_mas_interacc->rut), $total_people_mas_interacc);
        $total_people_mas_interacc = str_replace("{SEGUIDORES}", ($people_mas_interacc->seguidores . " seguidores"), $total_people_mas_interacc);
        $total_people_mas_interacc = str_replace("{PUNTOS}", "", $total_people_mas_interacc);
        // BOTON SEGUIR
        $sesiguepersona            = count(VerificandompaSeguidores($rut, $people_mas_interacc->rut, $id_empresa));
        if ($sesiguepersona > 0) {
            $boton_seguir = "<center>    <div class='badge_small badge-verde blanco mgtop5'>    <i class='icon-check icons'></i> Siguiendo </div>
        <a href='?sw=com_mp_personal&rut_enviado=" . $people_mas_interacc->rut . "&vp=1&sg=2'
        class='badge_small bg-amarillos negro'>
        <i class='icon-user-following icons'></i> Dejar de seguir (-)</a></center>";
        } else {
            $boton_seguir = "<center><a href='?sw=com_mp_personal&rut_enviado=" . $people_mas_interacc->rut . "&vp=1&sg=1' class='badge_small bg-amarillos negro'>        <i class='icon-user-following icons'></i> Seguir (+)</a></center>";
        }
        $total_people_mas_interacc = str_replace("{BOTON_SEGUIR}", ($boton_seguir), $total_people_mas_interacc);
    }


    /* $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_08 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/
    /*
    $peoples_quesigos     = com_mp_people_quesigo($rut, $id_empresa);
    $total_people_quesigo = "";
    foreach ($peoples_quesigos as $people_quesigo) {
        $total_people_quesigo .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_people_mini.html");
        $datos                = $people_quesigo->cuenta . " seguidores";
        $total_people_quesigo = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($people_quesigo->rut), $total_people_quesigo);
        $total_people_quesigo = str_replace("{NOMBRE}", ($people_quesigo->nombrecompleto), $total_people_quesigo);
        $total_people_quesigo = str_replace("{RUT_ENVIADO}", ($people_quesigo->rut), $total_people_quesigo);
        $total_people_quesigo = str_replace("{DATOS}", ($datos), $total_people_quesigo);
        $total_people_quesigo = str_replace("{SEGUIDORES}", ($people_mas_interacc->seguidores . " seguidores"), $total_people_quesigo);
        $total_people_quesigo = str_replace("{PUNTOS}", "", $total_people_quesigo);
        // BOTON SEGUIR
        $sesiguepersona       = count(VerificandompaSeguidores($rut, $people_quesigo->rut, $id_empresa));
        if ($sesiguepersona > 0) {
            $boton_seguir = "<center>    <div class='badge_small badge-verde blanco mgtop5'>    <i class='icon-check icons'></i> Siguiendo </div>
        <a href='?sw=com_mp_personal&rut_enviado=" . $people_quesigo->rut . "&vp=1&sg=2'
        class='badge_small bg-amarillos negro'>
        <i class='icon-user-following icons'></i> Dejar de seguir (-)</a></center>";
        } else {
            $boton_seguir = "<center><a href='?sw=com_mp_personal&rut_enviado=" . $people_quesigo->rut . "&vp=1&sg=1' class='badge_small bg-white_borderBlue negro'>        <i class='icon-user-following icons'></i> Seguir (+)</a></center>";
        }
        $total_people_quesigo = str_replace("{BOTON_SEGUIR}", ($boton_seguir), $total_people_quesigo);
    }

    /*    $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_09 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/

    $limit                   = 9;
    $total_listado_tags      = com_mp_tag_data($id_empresa, $rut, $limit);
    $total_listado_tag_cloud = "";
    foreach ($total_listado_tags as $total_listado_tag_unico) {
        $total_listado_tag_cloud .= file_get_contents("views/comunidad_mp/com_mp_row_tag_cloud_search.html");
        $total_listado_tag_cloud = str_replace("{TAG}", $total_listado_tag_unico->tag, $total_listado_tag_cloud);
        $total_listado_tag_cloud = str_replace("{NUM}", $total_listado_tag_unico->cuenta, $total_listado_tag_cloud);
        $link                    = "?sw=com_mp_personal&amb=mp_tag&tag=" . $total_listado_tag_unico->tag . "";
        $total_listado_tag_cloud = str_replace("{LINK}", $link, $total_listado_tag_cloud);
    }


    /*    $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_10 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/
    /*
    $agrup_categorias      = MPObtengoCategoriasNumero($id_empresa);
    $total_agrup_categoria = "";
    foreach ($agrup_categorias as $agrup_categoria) {
        //revisa si usuario esta registrado en algun grupo
        $cuenta_seguido = com_mp_revisa_grupo_seguido($agrup_categoria->id_categoria, "GRUPOSEGUIDO", $id_empresa, $rut);
        //echo $cuenta_seguido[0]->cuenta;
        if ($cuenta_seguido[0]->cuenta == 0) {
            $var_gruposeguir       = "<a href='?sw=com_mp_personal&amb=mp_cat&idcat=" . $agrup_categoria->id_categoria . "&cat=" . $agrup_categoria->categoria . "&groupseguir=1'
            class='negro'> Seguir (+)</a>";
            $var_groupseguir_class = "azul";
        } else {
            $var_gruposeguir       = "<a href='?sw=com_mp_personal&amb=mp_cat&idcat=" . $agrup_categoria->id_categoria . "&cat=" . $agrup_categoria->categoria . "&groupseguir=2'
            class='negro'> Dejar de seguir (-)</a>";
            $var_groupseguir_class = "verde";
        }
        $var_gruposeguir       = "<a href='?sw=com_mp_personal&amb=mp_cat&idcat=" . $agrup_categoria->id_categoria . "&cat=" . $agrup_categoria->categoria . "&groupseguir=1'
            class='negro'> </a>";
        $var_groupseguir_class = "azul";
        $total_agrup_categoria .= file_get_contents("views/comunidad_mp/row_com_mp_grupo_interes.html");
        $total_agrup_categoria = str_replace("{ITEM}", ($agrup_categoria->categoria), $total_agrup_categoria);
        $total_agrup_categoria = str_replace("{NUM}", ($agrup_categoria->cuenta), $total_agrup_categoria);
        $link_cat_amb          = "?sw=com_mp_personal&amb=mp_cat&idcat=" . $agrup_categoria->id_categoria . "&cat=" . $agrup_categoria->categoria . "";
        $total_agrup_categoria = str_replace("{LINK}", $link_cat_amb, $total_agrup_categoria);
        $total_agrup_categoria = str_replace("{GRUPO_SEGUIR_SEGUIDO_BOTON}", $var_gruposeguir, $total_agrup_categoria);
        $total_agrup_categoria = str_replace("{GRUPO_SEGUIR_SEGUIDO_CLASS}", $var_groupseguir_class, $total_agrup_categoria);
        //    echo $agrup_categoria->categoria;
    }


    /*    $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_11 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/
     /*
    $agrup_ambitos       = MPObtengoAmbitosNumero($id_empresa, $array_MP_template[0]->template);
    $total_agrup_ambitos = "";
    foreach ($agrup_ambitos as $agrup_ambito) {
        //revisa si usuario esta registrado en algun grupo
        $cuenta_seguido        = com_mp_revisa_grupo_seguido($agrup_ambito->id_ambito, "GRUPOSEGUIDO", $id_empresa, $rut);
        //echo $cuenta_seguido[0]->cuenta;
        $var_gruposeguir       = "<a href='?sw=com_mp_personal&amb=mp_amb&idamb=" . $agrup_ambito->id_ambito . "&cat=" . $agrup_ambito->ambito . "&groupseguir=1'
            class='negro'> </a>";
        $var_groupseguir_class = "azul";
        $total_agrup_ambitos .= file_get_contents("views/comunidad_mp/row_com_mp_grupo_ambito.html");
        $total_agrup_ambitos = str_replace("{ITEM}", ($agrup_ambito->ambito), $total_agrup_ambitos);
        $total_agrup_ambitos = str_replace("{NUM}", ($agrup_ambito->cuenta), $total_agrup_ambitos);
        $link_cat_amb        = "?sw=com_mp_personal&amb=mp_amb&idamb=" . $agrup_ambito->id_ambito . "&ambito=" . $agrup_ambito->ambito . "";
        $total_agrup_ambitos = str_replace("{LINK}", $link_cat_amb, $total_agrup_ambitos);
        $total_agrup_ambitos = str_replace("{GRUPO_SEGUIR_SEGUIDO_BOTON}", $var_gruposeguir, $total_agrup_ambitos);
        $total_agrup_ambitos = str_replace("{GRUPO_SEGUIR_SEGUIDO_CLASS}", $var_groupseguir_class, $total_agrup_ambitos);
        //    echo $agrup_categoria->categoria;
    }



    /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_12 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000); */
    //categorias expertos
    /*
    $agrup_categoria_expertos_expertos = MPObtengoCategoriasNumero($id_empresa);
    $total_agrup_categoria_expertos    = "";
    foreach ($agrup_categoria_expertos_expertos as $agrup_categoria_experto) {
       // $cuenta_num = MP_numero_expertos_categoria($agrup_categoria_experto->id_categoria, $id_empresa);
        //if ($cuenta_num > 0) {
            $total_agrup_categoria_expertos .= file_get_contents("views/comunidad_mp/row_com_mp_grupo_interes_expertos.html");
            $total_agrup_categoria_expertos = str_replace("{ITEM}", ($agrup_categoria_experto->categoria), $total_agrup_categoria_expertos);
            $total_agrup_categoria_expertos = str_replace("{NUM}", ($cuenta_num), $total_agrup_categoria_expertos);
            $link_cat_amb                   = "?sw=com_mp_personal&=mp_cat&soloexpertos=1&q=" . $agrup_categoria_experto->categoria . "";
            $total_agrup_categoria_expertos = str_replace("{LINK}", $link_cat_amb, $total_agrup_categoria_expertos);
            $total_agrup_categoria_expertos = str_replace("{GRUPO_SEGUIR_SEGUIDO_BOTON}", $var_gruposeguir, $total_agrup_categoria_expertos);
            $total_agrup_categoria_expertos = str_replace("{GRUPO_SEGUIR_SEGUIDO_CLASS}", $var_groupseguir_class, $total_agrup_categoria_expertos);
        //}
    }


    /* $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_13 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/
    //filtro por tipo
    /*
    $agrup_tiposPub    = MPObtengoTiposPubNumero($id_empresa); //print_r($agrup_tiposPub);
    $total_agrup_tipos = "";
    foreach ($agrup_tiposPub as $agrup_tipoPub) {
        $total_agrup_tipos .= file_get_contents("views/comunidad_mp/row_com_mp_grupo_tipos.html");
        $total_agrup_tipos = str_replace("{ITEM}", ($agrup_tipoPub->tipo), $total_agrup_tipos);
        //$total_agrup_tipos = str_replace("{NUM}",($agrup_categoria->cuenta),$total_agrup_tipos);
        $link_cat_amb      = "?sw=com_mp_personal&amb=mp_tipo&idcat=" . $agrup_tipoPub->tipo . "&cat=" . $agrup_tipoPub->tipo . "";
        $total_agrup_tipos = str_replace("{LINK}", $link_cat_amb, $total_agrup_tipos);
        //$total_agrup_tipos = str_replace("{GRUPO_SEGUIR_SEGUIDO_BOTON}",$var_gruposeguir,$total_agrup_tipos);
        //$total_agrup_tipos = str_replace("{GRUPO_SEGUIR_SEGUIDO_CLASS}",$var_groupseguir_class,$total_agrup_tipos);
        //echo $agrup_categoria->categoria;
    }


    /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_14 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/

    $PRINCIPAL = str_replace("{NUM_FAV}", MPbuscaFav($rut, $id_empresa), $PRINCIPAL);
    $PRINCIPAL = str_replace("{NUM_MISPR}", MPbuscaMp($rut, $id_empresa), $PRINCIPAL);
    $PRINCIPAL = str_replace("{INSIGNIA}", "", $PRINCIPAL);
    $PRINCIPAL = str_replace("{RUT_USUARIO}", $rut, $PRINCIPAL);
    $PRINCIPAL = str_replace("{MIRUT}", $rut, $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_LISTADO_POST_VIDEOS}", utf8_encode($total_listado_post_tipo_new_videos), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_LISTADO_POST_NEWS_BIG}", utf8_encode($total_listado_post_tipo_news_big), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_LISTADO_POST_NEWS_3POST}", utf8_encode($total_listado_post_tipo_news_3post), $PRINCIPAL);
    //echo "4096 <br><br><br><br>ambiente $ambiente";


    /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_15 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/

    if ($ambiente <> '') {
        $PRINCIPAL = str_replace("{IMAGEN_CONCURSO_HOME}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{POST_RESULTADOS_COMUNIDAD_MP}", utf8_encode($total_listado_post_personas_resultados), $PRINCIPAL);
        $PRINCIPAL = str_replace("{POST_RESULTADOS_EXPERTOS_MP}", utf8_encode($total_listado_post_expertos_resultados), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ROW_TITULO_R_RESULTADOS}", ($titulo_R_resultados), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ROW_TITULO_E_RESULTADOS}", ($titulo_E_resultados), $PRINCIPAL);
        $PRINCIPAL = str_replace("{MP_HACERPREGUNTA}", utf8_encode($mp_hacerpregunta), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{IMAGEN_CONCURSO_HOME}", "<div class='row'><div class='col-xs-12'><a href='?sw=com_mp_concurso'><img src='img/comunidadmpa_banner_central_VF_rod.gif' border='0'></a>
    </div></div>", $PRINCIPAL);
        $PRINCIPAL = str_replace("{POST_RESULTADOS_COMUNIDAD_MP}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{POST_RESULTADOS_EXPERTOS_MP}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ROW_TITULO_R_RESULTADOS}", ($titulo_R_resultados), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ROW_TITULO_E_RESULTADOS}", ($titulo_E_resultados), $PRINCIPAL);
        $PRINCIPAL = str_replace("{MP_HACERPREGUNTA}", utf8_encode($mp_hacerpregunta), $PRINCIPAL);
    }
    //echo "<br>perfil personal<br>";
    //echo   $perfil_personal;
    $PRINCIPAL = str_replace("{PERFIL_PERSONAL_COMUNIDAD_MP}", utf8_encode($perfil_personal), $PRINCIPAL);
    $PRINCIPAL = str_replace("{POST_FIJOS_COMUNIDAD_MP}", utf8_encode($post_fijo_personal), $PRINCIPAL);
    $PRINCIPAL = str_replace("{POST_ESTADISTICAS_COMUNIDAD_MP}", utf8_encode($post_fijo_estadisticas), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_LISTADO_POST_RECIENTES_FACEBOOK}", utf8_encode($total_listado_post_tipo_facebook), $PRINCIPAL);
    //echo "<br><br><br><br><br><br><br><br>vp $vp, amb $ambiente";
    if ($vp == "" and ($ambiente == "" or $ambiente == "mp_cat" or $ambiente == "mp_tag" or $ambiente == "mp_mp" or $ambiente == "mp_mf" or $ambiente == "mp_cc" or $ambiente == "mp_tipo")) {
        //echo "uno";
        //$total_listado_post_recientes.=file_get_contents("views/comunidad_mp/".$template.$id_empresa."_boton_carga_mas_post.html");
        //$total_listado_post_recientes = str_replace("{NUMERO_COMENTARIOS}","1",$total_listado_post_recientes);
        $PRINCIPAL = str_replace("{ROW_LISTADO_POST_RECIENTES}", utf8_encode($total_listado_post_recientes), $PRINCIPAL);
        //<div class='com_mp_title_featured fc-container__inner '><a href='?sw=com_mp_personal&amb=mp_rec'><span class='blanco'> Lo ?ltimo en la Comunidad <i class='icon-arrow-right icons'></i></span></a></div>
        $PRINCIPAL = str_replace("{TITULO_LISTADO_POST_RECIENTES}", "", $PRINCIPAL);
    } else {
        //echo "dos";
        $PRINCIPAL = str_replace("{ROW_LISTADO_POST_RECIENTES}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{TITULO_LISTADO_POST_RECIENTES}", "", $PRINCIPAL);
    }


    /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_16 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/
   // echo "hola";
    $PRINCIPAL  = str_replace("{ROW_LISTADO_TIMELINE_PERSONAL}", utf8_encode($total_listado_post_timeline), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{ROW_LISTADO_TIMELINE_POST_POPULARES}", utf8_encode($total_listado_post_populares), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{ROW_LISTADO_TIMELINE_PERSONAS_INTERES}", utf8_encode($total_listado_post_personas_interes), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{ROW_LISTADO_TIMELINE_PERSONAL}", utf8_encode($total_listado), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{TITULO_LISTADO_TIMELINE_TAG1}", utf8_encode($Top_Tag[0]->tag), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{TITULO_LISTADO_TIMELINE_TAG2}", utf8_encode($Top_Tag[1]->tag), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{TITULO_LISTADO_TIMELINE_TAG3}", utf8_encode($Top_Tag[2]->tag), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{ROW_LISTADO_TIMELINE_TAG1}", utf8_encode($total_listado_post_tag1), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{ROW_LISTADO_TIMELINE_TAG2}", utf8_encode($total_listado_post_tag2), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{ROW_LISTADO_TIMELINE_TAG3}", utf8_encode($total_listado_post_tag3), $PRINCIPAL);
    //    }
    //preguntas
    $PRINCIPAL  = str_replace("{ROW_ULTIMOS_PREGUNTAS_PUBLICO}", utf8_encode($total_ultimos_posteos_publicados), $PRINCIPAL);
    //soy experto??


    /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_17 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/

    //$soyexperto = mp_verificaquesoy_experto($rut, $id_empresa, $subcategoria);
    if ($soyexperto[0]->cuenta >= 1) {
       // $mp_num_preg_sin_contestar = mp_num_preguntas_sincontestar($rut, $id_empresa, $subcategoria);
        if ($mp_num_preg_sin_contestar[0]->cuenta == 1) {
            $alerta_experto_preguntas = "
    <div class='alert alert-danger' role='alert'>
          <strong>Existen " . $mp_num_preg_sin_contestar[0]->cuenta . " preguntas sin contestar</strong><br>Has click en el boton Responder, para contestar.<br> Tu respuesta quedara publicada en la Comunidad.
    </div>";
        } elseif ($mp_num_preg_sin_contestar[0]->cuenta > 1) {
            $alerta_experto_preguntas = "
    <div class='alert alert-danger' role='alert'>
          <strong>Existen " . $mp_num_preg_sin_contestar[0]->cuenta . " preguntas sin contestar</strong><br>Has click en el boton Responder, para contestar.<br> Tu respuesta quedara publicada en la Comunidad.
    </div>";
            ;
        } else {
            $alerta_experto_preguntas = "";
        }
        $PRINCIPAL = str_replace("{PREGUNTAS_COMUNIDAD_PARA_RESPONDER}", utf8_encode($total_preguntas_sin_responder), $PRINCIPAL);
        $PRINCIPAL = str_replace("{TITULO_PREGUNTAS_COMUNIDAD_PARA_RESPONDER}", utf8_encode($alerta_experto_preguntas), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{PREGUNTAS_COMUNIDAD_PARA_RESPONDER}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{TITULO_PREGUNTAS_COMUNIDAD_PARA_RESPONDER}", "", $PRINCIPAL);
    }


    /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_18 : $time_elapsed<br><br>"; */


    $PRINCIPAL                      = str_replace("{GRUPO_INTERES_1}", utf8_encode($mas_grupo_interes1[0]->categoria), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{GRUPO_INTERES_2}", utf8_encode($mas_grupo_interes2[0]->categoria), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{GRUPO_INTERES_3}", utf8_encode($mas_grupo_interes3[0]->categoria), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_MAS_PUBLICADOR_GRUPO_INTERES_1}", utf8_encode($total_mas_post_grupo_interes1), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_MAS_PUBLICADOR_GRUPO_INTERES_2}", utf8_encode($total_mas_post_grupo_interes2), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_MAS_PUBLICADOR_GRUPO_INTERES_3}", utf8_encode($total_mas_post_grupo_interes3), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{COM_MP_FRASES}", utf8_encode($total_mp_com_frases), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{TITULO_BOTONS_GRUPO_INTERES}", utf8_encode($tit_mp_com_grupos_interes_subcategorias_comunidad), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{LISTA_EVENTOS_POSTULABLES_MP}", utf8_encode($lista_eventos_postulables_mp_com_general), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{MIS_EVENTOS_DESINSCRIBIRME}", utf8_encode($lista_eventos_inscritos_mp_com_general), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{BOTONS_GRUPOS_INTERES}", utf8_encode($total_mp_com_grupos_intereses_subcat), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_POST_VALORADOS}", utf8_encode($total_posteos_mas_valorados), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{MP_NOVEDADES}", utf8_encode($total_posteos_novedades), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{MP_FOTOS}", utf8_encode($total_posteos_fotos), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{MIS_CAPACITACIONES_novedades}", utf8_encode($total_posteos_capacitaciones), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_PEOPLE_INTERACCIONES}", utf8_encode($total_people_mas_interacc), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_PEOPLE_MAS_SEGUIDOS}", utf8_encode($total_people_mas_seguida), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_PEOPLE_MAS_PUNTOS}", utf8_encode($total_people_mas_puntos), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{AGRUPACION_CATEGORIAS}", utf8_encode($total_agrup_categoria), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_PEOPLE_EXPERTOS}", utf8_encode($total_agrup_categoria_expertos), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_PEOPLE_QUESIGO}", utf8_encode($total_people_quesigo), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_TIPO_PUBLICACION}", utf8_encode($total_agrup_tipos), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{AGRUPACION_AMBITOS}", utf8_encode($total_agrup_ambitos), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{TAG_CLOUD}", utf8_encode($total_listado_tag_cloud), $PRINCIPAL);


    /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_19 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/
    //        $start = microtime(true);


    //Mini encuesta
    $total_mini_encuestas           = com_mp_mini_encuesta($id_empresa, $rut);
    $total_mini_encuesta_titulo     = "";
    $total_mini_encuesta_opciones   = "";
    $total_mini_encuesta_resultados = "";
    foreach ($total_mini_encuestas as $total_mini_encuesta) {
        //print_r($total_mini_encuesta);
        $total_mini_encuesta_titulo .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_titulo.html");
        $total_mini_encuesta_titulo = str_replace("{MINI_ENCUESTA_PREGUNTA}", ($total_mini_encuesta->pregunta), $total_mini_encuesta_titulo);
        if ($total_mini_encuesta->respuesta == 0) {
            //muestra  opciones
            if ($total_mini_encuesta->opcion1 <> '') {
                $total_mini_encuesta_opciones .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_opciones.html");
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION}", ($total_mini_encuesta->opcion1), $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION_ID}", "opcion1", $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_ID}", $total_mini_encuesta->id, $total_mini_encuesta_opciones);
            }
            if ($total_mini_encuesta->opcion2 <> '') {
                $total_mini_encuesta_opciones .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_opciones.html");
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION}", ($total_mini_encuesta->opcion2), $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION_ID}", "opcion2", $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_ID}", $total_mini_encuesta->id, $total_mini_encuesta_opciones);
            }
            if ($total_mini_encuesta->opcion3 <> '') {
                $total_mini_encuesta_opciones .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_opciones.html");
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION}", ($total_mini_encuesta->opcion3), $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION_ID}", "opcion3", $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_ID}", $total_mini_encuesta->id, $total_mini_encuesta_opciones);
            }
            if ($total_mini_encuesta->opcion4 <> '') {
                $total_mini_encuesta_opciones .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_opciones.html");
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION}", ($total_mini_encuesta->opcion4), $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION_ID}", "opcion4", $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_ID}", $total_mini_encuesta->id, $total_mini_encuesta_opciones);
            }
        } else {
            //muestra  respuesta
            if ($total_mini_encuesta->opcion1 <> '') {
                $total_mini_encuesta_resultados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_resultados.html");
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_PORCENTAJE}", $total_mini_encuesta->porcop1 . "%", $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_TEXTO}", $total_mini_encuesta->opcion1, $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_NUMERO}", $total_mini_encuesta->porcop1, $total_mini_encuesta_resultados);
            }
            if ($total_mini_encuesta->opcion2 <> '') {
                $total_mini_encuesta_resultados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_resultados.html");
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_PORCENTAJE}", $total_mini_encuesta->porcop2 . "%", $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_TEXTO}", $total_mini_encuesta->opcion2, $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_NUMERO}", $total_mini_encuesta->porcop2, $total_mini_encuesta_resultados);
            }
            if ($total_mini_encuesta->opcion3 <> '') {
                $total_mini_encuesta_resultados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_resultados.html");
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_PORCENTAJE}", $total_mini_encuesta->porcop3 . "%", $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_TEXTO}", $total_mini_encuesta->opcion3, $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_NUMERO}", $total_mini_encuesta->porcop3, $total_mini_encuesta_resultados);
            }
            if ($total_mini_encuesta->opcion4 <> '') {
                $total_mini_encuesta_resultados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_resultados.html");
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_PORCENTAJE}", $total_mini_encuesta->porcop4 . "%", $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_TEXTO}", $total_mini_encuesta->opcion4, $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_NUMERO}", $total_mini_encuesta->porcop4, $total_mini_encuesta_resultados);
            }
        }
    }

    /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_20 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/

    $PRINCIPAL = str_replace("{ENCUESTA_MINI_TITULO_PREGUNTA}", utf8_encode($total_mini_encuesta_titulo), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ENCUESTA_MINI_OPCIONES}", utf8_encode($total_mini_encuesta_opciones), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ENCUESTA_MINI_RESULTADOS}", utf8_encode($total_mini_encuesta_resultados), $PRINCIPAL);
    if ($tipo_query == "" and $ambiente == "" AND $rut_enviado == "") {
        //echo "<br><br><br><br><br><br>hola";
        $PRINCIPAL = str_replace("{ROW_CARGAS_MAS}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_personal_solo_post_cargar.html"), $PRINCIPAL);
    } else {
        //echo "<br><br><br><br><br><br>chao";
        // $PRINCIPAL = str_replace("{ROW_CARGAS_MAS}","",$PRINCIPAL);
        $PRINCIPAL = str_replace("{ROW_CARGAS_MAS}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_personal_solo_post_cargar.html"), $PRINCIPAL);
    }
    $arreglo_get               = $_GET;
    $array_para_enviar_via_url = serialize($arreglo_get);
    $array_para_enviar_via_url = urlencode($array_para_enviar_via_url);
    $PRINCIPAL                 = str_replace("{VARIABLES_GET_ENCODEADAS}", $array_para_enviar_via_url, $PRINCIPAL);
    //    $mp_comp_estadistica=MPO_Compestadistica($id_empresa);
    /*$categorias_mp             = TraeCategoriasMejoresPracticas($id_empresa);
    $options_categorias        = "";
    foreach ($categorias_mp as $cat) {
        $options_categorias .= "<option value='" . $cat->id_categoria . "'>" . $cat->categoria . "</option>";
    }
    $PRINCIPAL                    = str_replace("{CATEGORIAS_FORM}", utf8_encode($options_categorias), $PRINCIPAL);
     */
    /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_21 : $time_elapsed<br><br>"; */




//$time_elapsed_secs = microtime(true) - $start;
//$time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
//echo "<br>VP encuesta : $time_elapsed<br><br>";


    //$start = microtime(true);

    // notificaciones sin ver
    // Mis Notificaciones

    /*$com_mp_mis_notificaciones    = mp_interacciones_notificaciones_home($rut, $id_empresa, "");
    //print_r($com_mp_mis_notificaciones); echo "5613";
    $cuenta_notificaciones        = 0;
    $cuenta_notificaciones_sinver = 0;
    $total_notificaciones         = "";
    foreach ($com_mp_mis_notificaciones as $com_mp_mi_notificacion) {
        $muestra = 0;
        $cuenta_notificaciones++;
        $ico   = "";
        $texto = "";
        if ($com_mp_mi_notificacion->tipo == "COMENTARIO") {
            $ico = '<i class="icon-speech icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small>';
            if ($com_mp_mi_notificacion->rutAutor == $Rut_Perfil) {
                $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut_remitente . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreRemitente . '</strong>
                    </a> coment&oacute;:
                     tu publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
                if ($com_mp_mi_notificacion->visto_autor === null or $com_mp_mi_notificacion->visto_autor <> 1) {
                    $cuenta_notificaciones_sinver++;
                    $muestra = 1;
                }
            } else {
                $texto = 'Comentaste la publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '">
                    <strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a>  ';
            }
        }
        if ($com_mp_mi_notificacion->tipo == "SEGUIDO" and $Rut_Perfil <> $com_mp_mi_notificacion->rut_remitente) {
            $ico = '<i class="icon-user icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
            if ($com_mp_mi_notificacion->rut_remitenteAutor == $Rut_Perfil) {
                $texto = 'Seguiste a <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a>';
            } else {
                $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut_remitente . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreRemitente . '</strong> te sigue';
                if ($com_mp_mi_notificacion->visto === null or $com_mp_mi_notificacion->visto <> 1 and $com_mp_mi_notificacion->rut_remitente <> $Rut_Perfil) {
                    $cuenta_notificaciones_sinver++;
                    $muestra = 1;
                }
            }
        }
        //publicaciones sin ver
        //echo "<br> rut $Rut_Perfil==".$com_mp_mi_notificacion->rut_remitente;
        if ($com_mp_mi_notificacion->tipo == "PUBLICACION_SEGUIDO" and $Rut_Perfil == $com_mp_mi_notificacion->rut_remitente) {
            if ($com_mp_mi_notificacion->rut_remitenteAutor <> $Rut_Perfil) {
                $ico   = '<i class="icon-user icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
                //echo "<br> sigues a que publico ".$com_mp_mi_notificacion->rut_autor;
                //exit();
                $texto = $com_mp_mi_notificacion->NombreAutor . ' ha publicado
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '">
                    <strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a>  ';
                //echo "$com_mp_mi_notificacion->visto_remitente===null or $com_mp_mi_notificacion->visto_remitente<>1 and $com_mp_mi_notificacion->rut_remitente==$Rut_Perfil";
                if ($com_mp_mi_notificacion->visto_remitente === null or $com_mp_mi_notificacion->visto_remitente <> 1 and $com_mp_mi_notificacion->rut_remitente == $Rut_Perfil) {
                    $cuenta_notificaciones_sinver++;
                    $muestra = 1;
                }
            }
        }
        if ($com_mp_mi_notificacion->tipo == "MEGUSTA") {
            $ico = '<i class="icon-thumbs-up icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
            if ($com_mp_mi_notificacion->rut == $Rut_Perfil) {
                $texto = 'Te gusta la publicaci&oacute;n <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '">
                    <strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
            } else {
                $texto = 'A <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a> le Gusta tu publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
                if ($com_mp_mi_notificacion->visto_autor === null or $com_mp_mi_notificacion->visto_autor <> 1) {
                    $cuenta_notificaciones_sinver++;
                    $muestra = 1;
                }
            }
        }
        if ($com_mp_mi_notificacion->tipo == "GRUPOSEGUIDO") {
            $ico = '<i class="icon-people icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
            if ($com_mp_mi_notificacion->rut == $Rut_Perfil) {
                $texto = 'Seguiste el Grupo de Inter&eacute;s
                    <a href="?sw=com_mp_personal&amb=mp_cat&idcat=' . $com_mp_mi_notificacion->contenido . '&cat=' . $com_mp_mi_notificacion->NombreCategoria . '">
                    <strong>' . $com_mp_mi_notificacion->NombreCategoria . '</strong></a>
                    ';
            }
        }
        if ($com_mp_mi_notificacion->tipo == "COMPARTIDOCONMIGO") {
            $ico = '<i class="icon-share icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
            if ($com_mp_mi_notificacion->rut <> $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente <> $Rut_Perfil and $com_mp_mi_notificacion->rut == $com_mp_mi_notificacion->rut_remitente) {
                $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a> guard&oacute; tu publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
                if ($com_mp_mi_notificacion->visto_autor === null or $com_mp_mi_notificacion->visto_autor <> 1) {
                    $cuenta_notificaciones_sinver++;
                    $muestra = 1;
                }
            } elseif ($com_mp_mi_notificacion->rut == $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente == $Rut_Perfil) {
                $texto = 'Guardaste la publicaci&oacute;n <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '">
                    <strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
            } elseif ($com_mp_mi_notificacion->rut == $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente <> $Rut_Perfil) {
                $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreRemitente . '</strong>
                    </a> comparti&oacute; contigo la publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a>';
                if ($com_mp_mi_notificacion->visto === null or $com_mp_mi_notificacion->visto <> 1) {
                    $cuenta_notificaciones_sinver++;
                    $muestra = 1;
                }
            } elseif ($com_mp_mi_notificacion->rut <> $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente == $Rut_Perfil) {
                $texto = 'Compartiste con <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a> la publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a>
                    ';
            }
        }
        if ($muestra == 1 and $cuenta_notificaciones_sinver <= 10) {
            $total_notificaciones .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_perfil_mis_notificaciones_mini.html");
            $total_notificaciones = str_replace("{ICO}", ($ico), $total_notificaciones);
            $total_notificaciones = str_replace("{TEXTO}", ($texto), $total_notificaciones);
        }
    }
    $PRINCIPAL = str_replace("{MI_RUT}", $rut, $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_COMP_MP_MIS_NOTIFICACIONES_SIN_VER}", utf8_encode($total_notificaciones), $PRINCIPAL);
    if ($cuenta_notificaciones_sinver > 0) {
        $PRINCIPAL = str_replace("{NUM_NOTIFICACIONES_SINVER_GLOBO}", "<span class='badge_bell badge-default-bell'>" . $cuenta_notificaciones_sinver . " </span> ", $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{NUM_NOTIFICACIONES_SINVER_GLOBO}", "", $PRINCIPAL);
    }
    */


     $PRINCIPAL = str_replace("{NUM_NOTIFICACIONES_SINVER_GLOBO}", "", $PRINCIPAL);

    /*
$time_elapsed_secs = microtime(true) - $start;
$time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
echo "<br>VP Final : $time_elapsed<br><br>";*/

    $PRINCIPAL = str_replace("{COMP_MP_PUBLICACIONES_TOTALES}", $mp_comp_estadistica[0]->CuentaPublicaciones, $PRINCIPAL);
    $PRINCIPAL = str_replace("{COMP_MP_PUBLICACIONES_TOTALES}", $mp_comp_estadistica[0]->CuentaPublicaciones, $PRINCIPAL);
    $PRINCIPAL = str_replace("{COMP_MP_VISTAS_TOTALES}", $mp_comp_estadistica[0]->CuentaVisitas, $PRINCIPAL);
    $PRINCIPAL = str_replace("{COMP_MP_FAVORITAS_TOTALES}", $mp_comp_estadistica[0]->CuentaFavoritas, $PRINCIPAL);
    $PRINCIPAL = str_replace("{COMP_MP_MEGUSTA_TOTALES}", $mp_comp_estadistica[0]->CuentaMeGusta, $PRINCIPAL);
    return ($PRINCIPAL);
}

function ColocaMegustaGPW($id, $id_empresa, $rut){

    $tiene_megusta=TieneMEgustaGPW($id_empresa."_gpw_".$id, $id_empresa, $rut);
    $cantidad_megusta=TieneMEgustaGPWPorPost($id_empresa."_gpw_".$id, $id_empresa);
    if($tiene_megusta){
            $bloque=file_get_contents("views/comunidad_mp/" . $id_empresa . "_bloque_ya_megusta_gpw.html");
    }else{
        $bloque=file_get_contents("views/comunidad_mp/" . $id_empresa . "_bloque_megusta_gpw.html");
        $bloque = str_replace("{RUT}", ($rut) , $bloque);
        $bloque = str_replace("{ID_MP_GW}", ($id_empresa."_gpw_".$id) , $bloque);

    }

    $bloque = str_replace("{NUMMEGUSTA}", count($cantidad_megusta) , $bloque);
    $bloque = str_replace("{RUT}", ($rut) , $bloque);
    $bloque = str_replace("{ID_MP_GW}", ($id_empresa."_gpw_".$id) , $bloque);

    return($bloque);

}

function LMS_MiEquipoVista($PRINCIPAL, $id_empresa, $rut, $id_curso, $id_programa, $id_foco)
{

    //echo "<br> LMS_MiEquipoVista $id_empresa, $rut, $id_curso, $id_programa, $id_foco";
    $array_miequipo_all = LMS_MiEquipoVista_Data($id_empresa, $rut, $id_curso, $id_programa, $id_foco);




    $avance = 0;
    $aprobacion = 0;
    foreach($array_miequipo_all as $unico) {
        $cuenta_rank++;
        $datos_usuarios = TraeDatosBiografiayUsuario($unico->rut, $id_empresa);
        $avance = $unico->avance;
        $aprobacion = round(100 * $unico->num_aprobados / $unico->total_cursos);
        $row.= file_get_contents("views/mi_equipo_vista/" . $id_empresa . "_row_index.html");
        $row = str_replace("{RANKING}", $cuenta_rank, $row);
        $row = str_replace("{NOMBRE_PERSONA}", ($datos_usuarios[0]->nombre_completo) , $row);
        $row = str_replace("{FOTO_PERSONA}", VerificaFotoPersonal($unico->rut) , $row);
        $row = str_replace("{CARGO}", utf8_encode($datos_usuarios[0]->cargo) , $row);
        $row = str_replace("{GERENCIA}", utf8_encode($datos_usuarios[0]->c1) , $row);
        $row = str_replace("{PUNTOS}", $unico->puntos, $row);
        $row = str_replace("{BADGES}", $unico->badges, $row);

        //vista de cursos ordenados por programa
        $array_cursos_all = LMS_MiEquiposVista_Cursos_Data($id_empresa, $unico->rut, $id_curso, $id_programa, $id_foco);

    //print_r($array_cursos_all);
        $row_cursos=""; $cuenta_cursos=0;  $suma_cursos=0;
  foreach($array_cursos_all as $unico2) {
    if($unico2->AvancePromedio>=100)
        {$icono="<span class=''>    <span class='' style='color:#399847'> <i class='fas fa-check-square'></i>       </span>   </span> ";} else {
         $icono="<span class=''>    <span class='' style='color:#bbb'>    <i class='fas fa-exclamation-circle'></i> </span>   </span> ";
        }


                    $row_cursos.= file_get_contents("views/mi_equipo_vista/" . $id_empresa . "_row_cursos.html");
                    $row_cursos = str_replace("{NOMBRE_CURSO}", utf8_encode($unico2->nombre_curso) , $row_cursos);
                    $row_cursos = str_replace("{NOMBRE_PROGRAMA}", ($unico2->nombre_programa), $row_cursos);
                    $row_cursos = str_replace("{ESTADO}", $unico2->estado, $row_cursos);
                    $row_cursos = str_replace("{AVANCE}", $unico2->AvancePromedio, $row_cursos);
                    $row_cursos = str_replace("{ICONO}", $icono, $row_cursos);
                $cuenta_cursos++;
                $suma_cursos=$unico2->AvancePromedio+    $suma_cursos;

            }
            $promedio_avance=round($suma_cursos/$cuenta_cursos);
        $row = str_replace("{AVANCE}", $promedio_avance, $row);

        $row = str_replace("{LISTA_CURSOS_MI_EQUIPO_VISTA}", $row_cursos, $row);

    }

    $PRINCIPAL = str_replace("{LISTA_COLABORADORES_RANKING}", $row, $PRINCIPAL);


    return ($PRINCIPAL);
}

function LMS_MiEquipoVista_cursos_disponibles($PRINCIPAL, $id_empresa, $rut, $id_curso, $id_programa, $id_foco)
{

    //echo "<br> LMS_MiEquipoVista $id_empresa, $rut, $id_curso, $id_programa, $id_foco";
    $array_cursos_all = LMS_MiEquipoVista_Cursos_disponibles_Data($id_empresa, $rut, $id_curso, $id_programa, $id_foco);



    $avance = 0;
    $aprobacion = 0;
    foreach($array_cursos_all as $unico) {
        $cuenta_rank++;

        $row.= file_get_contents("views/dnc_miequipo/" . $id_empresa . "_row_cursos_disponibles.html");
        $row = str_replace("{RANKING}", $cuenta_rank, $row);
        $row = str_replace("{NOMBRE_CURSO_DISPONIBLE}", ($unico->nombre) , $row);
        $row = str_replace("{DESCRIPCION_CURSO_DISPONIBLE}", $unico->descripcion, $row);





    }

    $PRINCIPAL = str_replace("{LISTA_CURSOS_DISPONIBLES}", $row, $PRINCIPAL);


    return ($PRINCIPAL);
}

function LMS_DNC_MiCurso($PRINCIPAL, $id_empresa, $rut, $id_curso, $id_programa, $id_foco)
{

    //echo "<br> LMS_DNC_MiCurso $id_empresa, $rut, $id_curso, $id_programa, $id_foco";
    $array_miscursos_all = LMS_DNC_MiCurso_Data($id_empresa, $rut, $id_curso, $id_programa, $id_foco);
    $avance = 0;
    $aprobacion = 0;

    foreach($array_miscursos_all as $unico) {
        $row.= file_get_contents("views/dnc_miequipo/" . $id_empresa . "_row_cursos_dnc.html");
        $row = str_replace("{NOMBRE_CURSO_DNC}", utf8_encode($unico->curso), $row);
        $row = str_replace("{DESCRIPCION_CURSO_DNC}", ($unico->descripcion) , $row);
        $row = str_replace("{LINKTEMARIO}", utf8_encode($unico->linktemario) , $row);
        $row = str_replace("{ID_CURSO_DNC}", utf8_encode($unico->id_curso) , $row);
    }

    $PRINCIPAL = str_replace("{LISTA_CURSOS_DNC}", $row, $PRINCIPAL);


    return ($PRINCIPAL);
}

function LMS_DNC_MiEquipoVista($PRINCIPAL, $id_empresa, $rut, $id_curso, $id_programa, $id_foco)
{

    //echo "<br> LMS_MiEquipoVista $id_empresa, $rut, $id_curso, $id_programa, $id_foco";
    $array_miequipo_all = LMS_DNC_MiEquipoVista_Data($id_empresa, $rut, $id_curso, $id_programa, $id_foco);




    $avance = 0;
    $aprobacion = 0;
    foreach($array_miequipo_all as $unico) {
        $cuenta_rank++;
        $datos_usuarios = TraeDatosBiografiayUsuario($unico->rut, $id_empresa);
        $avance = $unico->avance;
        $aprobacion = round(100 * $unico->num_aprobados / $unico->total_cursos);
        $row.= file_get_contents("views/dnc_miequipo/" . $id_empresa . "_row_index.html");
        $row = str_replace("{RANKING}", $cuenta_rank, $row);
        $row = str_replace("{NOMBRE_PERSONA}", ($datos_usuarios[0]->nombre_completo) , $row);
        $row = str_replace("{FOTO_PERSONA}", VerificaFotoPersonal($unico->rut) , $row);
        $row = str_replace("{CARGO}", utf8_encode($datos_usuarios[0]->cargo) , $row);
        $row = str_replace("{GERENCIA}", utf8_encode($datos_usuarios[0]->c1) , $row);
        $row = str_replace("{PUNTOS}", $unico->puntos, $row);
        $row = str_replace("{RUT_COL_ENC}", Encodear3($unico->rut), $row);

        $row = str_replace("{BADGES}", $unico->badges, $row);

        //vista de cursos ordenados por programa
        $array_cursos_all = LMS_MiEquiposVista_Cursos_Data($id_empresa, $unico->rut, $id_curso, $id_programa, $id_foco);

    //print_r($array_cursos_all);
        $row_cursos=""; $cuenta_cursos=0;  $suma_cursos=0;
  foreach($array_cursos_all as $unico2) {
    if($unico2->AvancePromedio>=100)
        {$icono="<span class=''>    <span class='' style='color:#399847'> <i class='fas fa-check-square'></i>       </span>   </span> ";} else {
         $icono="<span class=''>    <span class='' style='color:#bbb'>    <i class='fas fa-exclamation-circle'></i> </span>   </span> ";
        }


                    $row_cursos.= file_get_contents("views/mi_equipo_vista/" . $id_empresa . "_row_cursos.html");
                    $row_cursos = str_replace("{NOMBRE_CURSO}", utf8_encode($unico2->nombre_curso) , $row_cursos);
                    $row_cursos = str_replace("{NOMBRE_PROGRAMA}", ($unico2->nombre_programa), $row_cursos);
                    $row_cursos = str_replace("{ESTADO}", $unico2->estado, $row_cursos);
                    $row_cursos = str_replace("{AVANCE}", $unico2->AvancePromedio, $row_cursos);
                    $row_cursos = str_replace("{ICONO}", $icono, $row_cursos);
                $cuenta_cursos++;
                $suma_cursos=$unico2->AvancePromedio+    $suma_cursos;

            }
            $promedio_avance=round($suma_cursos/$cuenta_cursos);
        $row = str_replace("{AVANCE}", $promedio_avance, $row);

        $row = str_replace("{LISTA_CURSOS_MI_EQUIPO_VISTA}", $row_cursos, $row);

    }

    $PRINCIPAL = str_replace("{LISTA_COLABORADORES_RANKING}", $row, $PRINCIPAL);


    return ($PRINCIPAL);
}

function VistaRanking($PRINCIPAL, $id_empresa, $tipoc1c2c3c4, $id_programa, $id_foco, $orden, $jefe, $groupby)
{ // echo "<br />VistaRanking id empresa $id_empresa, tipo filtro $tipoc1c2c3c4, id programa $id_programa, orden $orden, jefe $jefe, groupby $groupby";
    // if($orden=="avance"){echo "orden por avance";}
    // if($orden=="puntos"){echo "orden por puntos";}
    // echo "<br />orden $orden";
    // echo "<br />id_programa $id_programa";
    // if($id_programa==""){echo "<br />filtro programas TODOS";} else {echo "<br />programa $id_programa";}
    // if($id_foco==""){echo "<br />filtro id foco TODOS";} else {echo "<br />id foco $id_foco";}
    // echo "<br />hola";
    if ($orden == "avance" and $tipoc1c2c3c4 == "") {
        $array_Rank_all = Ranking_desafios_avance_Data("", $id_programa, $id_foco, $id_empresa, $rut, $groupby);
        // echo "<pre>"; print_r($array_Rank_all);
    }
    if ($orden == "puntos" and $tipoc1c2c3c4 == "") {
        $array_Rank_all = Ranking_desafios_puntos_Data("", $id_programa, $id_foco, $id_empresa, $rut, $groupby);
        // echo "<pre>"; print_r($array_Rank_all);
    }
    if ($orden == "puntos" and $tipoc1c2c3c4 == "tipo_cargo") {
        $array_Rank_all = Ranking_desafios_puntos_Data("", "tipo_cargo", $id_programa, $id_empresa, $rut, $groupby);
        // echo "<pre>"; print_r($array_Rank_all);
    }
    if ($orden == "avance" and ($tipoc1c2c3c4 == "c1" or $tipoc1c2c3c4 == "c2" or $tipoc1c2c3c4 == "c3" or $tipoc1c2c3c4 == "c4")) {
        $array_Rank_all = Ranking_desafios_avance_C1C2C3C4_Data("", $id_programa, $id_foco, $id_empresa, $rut, $groupby);
        // echo "<pre>"; print_r($array_Rank_all);
    }
    if ($orden == "avance" and ($tipoc1c2c3c4 == "c1" or $tipoc1c2c3c4 == "c2" or $tipoc1c2c3c4 == "c3" or $tipoc1c2c3c4 == "c4")) {
        $array_Rank_all = Ranking_desafios_avance_C1C2C3C4_Data("", $id_programa, $id_foco, $id_empresa, $rut, $groupby);
        // echo "<pre>"; print_r($array_Rank_all);
    }
    //echo "<br>orden $orden tipoc1c2c3c4 $tipoc1c2c3c4";

    $avance = 0;
    $aprobacion = 0;
    foreach($array_Rank_all as $unico) {
        $cuenta_rank++;
        $datos_usuarios = TraeDatosBiografiayUsuario($unico->rut, $id_empresa);
        $avance = $unico->avance;
        $aprobacion = round(100 * $unico->num_aprobados / $unico->total_cursos);

        if ($orden == "avance" and $tipoc1c2c3c4 == "") {
            $row.= file_get_contents("views/ranking/" . $id_empresa . "_ranking_vistas_personas_avance.html");
        }
        if ($orden == "puntos" and $tipoc1c2c3c4 == "") {
            $row.= file_get_contents("views/ranking/" . $id_empresa . "_ranking_vistas_personas.html");
        }
        if ($orden == "puntos" and $tipoc1c2c3c4 == "tipo_cargo") {
            $row.= file_get_contents("views/ranking/" . $id_empresa . "_ranking_vistas_personas.html");
        }
        if ($orden == "avance" and ($tipoc1c2c3c4 == "c1" or $tipoc1c2c3c4 == "c2" or $tipoc1c2c3c4 == "c3" or $tipoc1c2c3c4 == "c4")) {
            $row.= file_get_contents("views/ranking/" . $id_empresa . "_ranking_vistas_gerencias.html");
        }
        $row = str_replace("{RANKING}", $cuenta_rank, $row);
        $row = str_replace("{NOMBRE_PERSONA}", utf8_encode($datos_usuarios[0]->nombre_completo) , $row);
        $row = str_replace("{FOTO_PERSONA}", VerificaFotoPersonal($unico->rut) , $row);
        $row = str_replace("{CARGO}", ($datos_usuarios[0]->cargo) , $row);
        $row = str_replace("{GERENCIA}", ($datos_usuarios[0]->gerencia) , $row);
        $row = str_replace("{GERENCIA_C1C2C3C4}", ($unico->gerencia) , $row);
        $row = str_replace("{PUNTOS}", $unico->total_puntos, $row);
        $row = str_replace("{BADGES}", $unico->total_medallas, $row);
                $SaldoPuntosLG=premios_buscadatos($unico->rut, $id_empresa);
        $row = str_replace("{PUNTOS_CANJE_USUARIO}", $SaldoPuntosLG[0]->puntossaldo, $row);

        $row = str_replace("{AVANCE}", $unico->avance, $row);
    }
    if ($orden == "avance") {
        if ($tipoc1c2c3c4 == "") {
            $PRINCIPAL = str_replace("{RANKING_REAL_INDIVIDUAL_AVANCE_TOTAL}", $row, $PRINCIPAL);
        }
        if ($tipoc1c2c3c4 == "c1") {
            $PRINCIPAL = str_replace("{RANKING_C1_REAL_INDIVIDUAL_AVANCE_TOTAL}", $row, $PRINCIPAL);
        }
        if ($tipoc1c2c3c4 == "c2") {
            $PRINCIPAL = str_replace("{RANKING_C2_REAL_INDIVIDUAL_AVANCE_TOTAL}", $row, $PRINCIPAL);
        }
        if ($tipoc1c2c3c4 == "c3") {
            $PRINCIPAL = str_replace("{RANKING_C3_REAL_INDIVIDUAL_AVANCE_TOTAL}", $row, $PRINCIPAL);
        }
        if ($tipoc1c2c3c4 == "c4") {
            $PRINCIPAL = str_replace("{RANKING_C4_REAL_INDIVIDUAL_AVANCE_TOTAL}", $row, $PRINCIPAL);
        }
    }
    if ($orden == "puntos") {
        if ($tipoc1c2c3c4 == "") {
            $PRINCIPAL = str_replace("{RANKING_REAL_INDIVIDUAL_PUNTOS_TOTAL}", $row, $PRINCIPAL);
        }
        if ($tipoc1c2c3c4 == "tipo_cargo") {
            $PRINCIPAL = str_replace("{RANKING_REAL_INDIVIDUAL_PUNTOS_TIPO_CARGO_TOTAL}", $row, $PRINCIPAL);
        }
        if ($tipoc1c2c3c4 == "c1") {
            $PRINCIPAL = str_replace("{RANKING_C1_REAL_INDIVIDUAL_PUNTOS_TOTAL}", $row, $PRINCIPAL);
        }
        if ($tipoc1c2c3c4 == "c2") {
            $PRINCIPAL = str_replace("{RANKING_C2_REAL_INDIVIDUAL_PUNTOS_TOTAL}", $row, $PRINCIPAL);
        }
        if ($tipoc1c2c3c4 == "c3") {
            $PRINCIPAL = str_replace("{RANKING_C3_REAL_INDIVIDUAL_PUNTOS_TOTAL}", $row, $PRINCIPAL);
        }
        if ($tipoc1c2c3c4 == "c4") {
            $PRINCIPAL = str_replace("{RANKING_C4_REAL_INDIVIDUAL_PUNTOS_TOTAL}", $row, $PRINCIPAL);
        }
    }
    return ($PRINCIPAL);
}



        function Emb_Lista_PostMeGusta($id_empresa, $id_grupo_interes)
{
    //$id_grupo_interes="";
    //echo "<br>1133";

$arr_grupo=Emb_Lista_PostMeGusta_Data($id_empresa, $id_grupo_interes);
//print_r($arr_grupo);

    foreach($arr_grupo as $unicoG){

                 $datos_usuario=DatosUsuario_($unicoG->rut,$id_empresa);

    //echo "<br> grupo $emb_grupo, emb_avance $emb_avance";
        $row .= file_get_contents("views/comunidad_mp/".$id_empresa."_row_com_mp_mini_megusta.html");
        $row         = str_replace("{NOMBRE_USUARIO}", $datos_usuario[0]->nombre_completo, $row);
        $row         = str_replace("{NOMBRE}", $unicoG->nombre, $row);
        $row         = str_replace("{RUT_ENVIADO}", $unicoG->rut, $row);
        $row         = str_replace("{ID_MP}", $unicoG->id_mp, $row);
        $row         = str_replace("{ME_GUSTA}", $unicoG->MeGusta, $row);
        $row         = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($unicoG->rut), $row);



    }



    return utf8_encode($row);
}

function Emb_Lista_MasPublicadores($id_empresa, $id_grupo_interes)
{
    //$id_grupo_interes="";
    //echo "<br>1133";

$arr_grupo=Emb_Lista_PostMasPublicador($id_empresa, $id_grupo_interes);


    foreach($arr_grupo as $unicoG){



    //echo "<br> grupo $emb_grupo, emb_avance $emb_avance";
        $row .= file_get_contents("views/comunidad_mp/".$id_empresa."_row_com_mp_people_mas_publicador.html");
        $row         = str_replace("{NOMBRE}", $unicoG->nombre_completo, $row);
        $row         = str_replace("{RUT_ENVIADO}", $unicoG->rut, $row);
        $row         = str_replace("{ID_MP}", $unicoG->id_mp, $row);
        $row         = str_replace("{PUBLICACIONES}", $unicoG->publicaciones , $row);
        $row           = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($unicoG->rut), $row);



    }



    return utf8_encode($row);
}
function validateDate($date, $format = 'Y-m-d')
{
if (DateTime::createFromFormat('Y-m-d', $date) !== FALSE) {
    // it's a date
    return("SI");
}
}
function FechaaNombredia($date){

//Convert the date string into a unix timestamp.
$unixTimestamp = strtotime($date);
//Get the day of the week using PHP's date function.
$dayOfWeek = date("l", $unixTimestamp);
//Print out the day that our date fell on.
//echo $date . ' fell on a ' . $dayOfWeek;


if($dayOfWeek=="Sunday")    {$dia="DO";}
if($dayOfWeek=="Monday")    {$dia="LU";}
if($dayOfWeek=="Tuesday")    {$dia="MA";}
if($dayOfWeek=="Wednesday")    {$dia="MI";}
if($dayOfWeek=="Thursday")    {$dia="JU";}
if($dayOfWeek=="Friday")    {$dia="VI";}
if($dayOfWeek=="Saturday")    {$dia="SA";}


        return $dia;

}

function BuscaCursosPrograma($PRINCIPAL, $id_programa, $id_empresa){
        $rut=$_SESSION["user_"];
        $array_cursos=BuscaCursosProgramaData($id_programa, $id_empresa);

        foreach ($array_cursos as $list) {
            $i++;
                $verificaEstadoCursoArray=VerificaEstadoCursoRut($rut, $list->id_curso, $id_empresa);
                 //print_r($verificaEstadoCursoArray);

                if($verificaEstadoCursoArray<>100){$estado="<span class='badge badge-info'>Pendiente</span>";}
                if($verificaEstadoCursoArray==100){$estado="<span class='badge badge-success'>Realizado</span>";}



            //print_r($list);
            $row .= file_get_contents("views/templates/bci_intnova_row_cursos.html");
            $row = str_replace("{ID_CURSO_ENCODEADO}",         Encodear3($list->id_curso), $row);
            $row = str_replace("{NOMBRE_CAPSULA}",         utf8_encode($list->nombre_curso), $row);
            $row = str_replace("{DESCRIPCION_CAPSULA}", utf8_encode($list->descripcion_curso), $row);
            $row = str_replace("{IMAGEN_CAPSULA}",         ($list->imagen_curso), $row);
            $row = str_replace("{AVANCE}",         ($verificaEstadoCursoArray), $row);
            $row = str_replace("{ESTADO}",         ($estado), $row);

            }


    $PRINCIPAL = str_replace("{BCI_NOVA_LISTA_CAPSULAS}", $row, $PRINCIPAL);

    return ($PRINCIPAL);



}


function allPersonasPorDealer($buscar, $id_empresa, $rut)
{

    $dataPersonas  = allDealers($buscar, $id_empresa);
    if ($dataPersonas) {
        foreach ($dataPersonas as $dataPersonas_aux) {
            echo utf8_encode($dataPersonas_aux->descripcion) . " " . utf8_encode($dataPersonas_aux->apaterno) . " " . utf8_encode($dataPersonas_aux->amaterno) . " " . "|" . $dataPersonas_aux->id_dealer . "\n";
            //echo utf8_encode($dataPersonas_aux->nombre)."\n";
        }
    } else {
        $data = 'No Existe coincidencia';
    }
    return $data;
}



function Seguimiento_BloqueArchivosAdjuntos    ($PRINCIPAL, $id_empresa, $id_registro){
    $datos_registro=SEGUIMIENTO_DatosRegistroSoloId($id_empresa, $id_registro);

    $contador=0;

        if($datos_registro[0]->archivo1){ $listado_archivos.="<label class='col-md-12 control-label'><a target='_blank' class='btn btn-info' href='documentos_hotline/".$datos_registro[0]->archivo1."'>Archivo N?1 >></a></label><br>"; $contador++; }
        if($datos_registro[0]->archivo2){ $listado_archivos.="<label class='col-md-12 control-label'><a target='_blank' class='btn btn-info' href='documentos_hotline/".$datos_registro[0]->archivo2."'>Archivo N?2 >></a></label><br>"; $contador++; }
        if($datos_registro[0]->archivo3){ $listado_archivos.="<label class='col-md-12 control-label'><a target='_blank' class='btn btn-info' href='documentos_hotline/".$datos_registro[0]->archivo3."'>Archivo N?3 >></a></label><br>"; $contador++; }
        if($datos_registro[0]->archivo4){ $listado_archivos.="<label class='col-md-12 control-label'><a target='_blank' class='btn btn-info' href='documentos_hotline/".$datos_registro[0]->archivo4."'>Archivo N?4 >></a></label><br>"; $contador++; }
        if($datos_registro[0]->archivo5){ $listado_archivos.="<label class='col-md-12 control-label'><a target='_blank' class='btn btn-info' href='documentos_hotline/".$datos_registro[0]->archivo5."'>Archivo N?5 >></a></label><br>"; $contador++; }

    if($contador==0){
        $PRINCIPAL = str_replace("{BLOQUE_ARCHIVOS_ADJUNTOS}", "No existen Archivos Adjuntos", $PRINCIPAL);
    }else{
        $PRINCIPAL = str_replace("{BLOQUE_ARCHIVOS_ADJUNTOS}", $listado_archivos, $PRINCIPAL);
    }

    return($PRINCIPAL);
}
    function RankingGerencialGlobal($PRINCIPAL, $id_programa, $id_empresa){


        $row = file_get_contents("views/ranking/" . $id_empresa . "_ranking_gerencial.html");
        $listado=RankingGerencialGlobal_data($id_programa, $id_empresa);
        array_multisort($avance, SORT_DESC, $listado);
        foreach ($listado as $list) {
        $i++;
            $row2 .= file_get_contents("views/ranking/" . $id_empresa . "_ranking_gerencial_row.html");
            $row2 = str_replace("{NUMERO_RANKING}", $i, $row2);
            $row2 = str_replace("{NOMBRE_GERENCIA}", $list->c1, $row2);
            $row2 = str_replace("{AVANCE}", ($list->avance), $row2);
        }

    $row = str_replace("{ROW_RANKING_GERENCIAL}", $row2, $row);

    $PRINCIPAL = str_replace("{RANKING_POR_GERENCIA_TOTAL}", $row, $PRINCIPAL);

    return ($PRINCIPAL);

    }


    function RankingIndividualGlobal($PRINCIPAL, $id_programa, $id_empresa){


        $row = file_get_contents("views/ranking/" . $id_empresa . "_ranking_individual.html");
        $listado=RankingIndividualGlobal_data($id_programa, $id_empresa);
        array_multisort($avance, SORT_DESC, $listado);
        foreach ($listado as $list) {
        $i++;
            $row2 .= file_get_contents("views/ranking/" . $id_empresa . "_ranking_individual_row.html");
            $row2 = str_replace("{NUMERO_RANKING}", $i, $row2);
            $row2 = str_replace("{FOTO_PERSONA}",VerificaFotoPersonal($list->rut), $row2);

            $row2 = str_replace("{NOMBRE_PERSONA}", $list->nombre, $row2);
            $row2 = str_replace("{PUNTOSTOTAL}", ($list->puntostotal), $row2);
        }
    $row = str_replace("{ROW_RANKING_INDIVIDUAL}", $row2, $row);

    $PRINCIPAL = str_replace("{RANKING_INDIVIDUAL_TOTAL}", $row, $PRINCIPAL);

    return ($PRINCIPAL);



    }


function RankingTop1IndividualGlobal($PRINCIPAL, $id_programa, $id_empresa){

        $row = file_get_contents("views/ranking/" . $id_empresa . "_ranking_destacado.html");
        $listado=RankingIndividualGlobalTop1_data($id_programa, $id_empresa);
        //print_r($listado);

        $row = str_replace("{FOTO_USUARIO_DESTACADO}",         VerificaFotoPersonal($listado[0]->rut), $row);
        $row = str_replace("{BIOGRAFIA_USUARIO_DESTACADO}", $listado[0]->biografia, $row);
        $row = str_replace("{NOMBRE_USUARIO_DESTACADO}",     $listado[0]->nombre, $row);
        $row = str_replace("{CARGO_USUARIO_DESTACADO}",     $listado[0]->cargo, $row);

    $PRINCIPAL = str_replace("{TOP1_RANKING_DESTACADO}", $row, $PRINCIPAL);

    return ($PRINCIPAL);

    }



function ColocaComentariosPorRegistro($id_registro, $id_empresa, $estado, $rut_supervisor){
    //traigo los comentarios
    if($estado=="Cerrado"){
        //Traigo el ultimo comentario ingresado por el supervisor
        $ultimo_comentario=SEGUIMIENTO_UltimoComentarioDeSupervisor($id_registro, $rut_supervisor);
        $comentario=file_get_contents("views/seguimiento/" . $id_empresa . "_seguimiento_registro_comentario_correcto.html");
        $comentario = str_replace("{NOMBRE_COLABORADOR}", utf8_encode($ultimo_comentario[0]->nombre_completo), $comentario);
        $comentario = str_replace("{COMENTARIO_INGRESADO}", utf8_encode($ultimo_comentario[0]->comentario), $comentario);
        $comentario = str_replace("{FECHA}", $ultimo_comentario[0]->fecha, $comentario);
        $comentario = str_replace("{HORA_INGRESO}", $ultimo_comentario[0]->hora, $comentario);
        if($ultimo_comentario[0]->archivo){
            $comentario = str_replace("{BLOQUE_ARCHIVO_POR_COMENTARIO}", '<br><div class="">
                    <span class="com_mp_texto"><a class="badge btn btn-info" href="documentos_hotline/archivos_por_comentarios/'.$come->archivo.'" target="_blank">Descargar Documento</a></span>
                </div>', $comentario);


        }else{
            $comentario = str_replace("{BLOQUE_ARCHIVO_POR_COMENTARIO}", "", $comentario);
        }


    }
    $comentarios=Seguimiento_ComentariosPorRegistro($id_registro);
    foreach($comentarios as $come){
        if($estado=="Cerrado"){
            if($ultimo_comentario[0]->id==$come->id){
                //$comentario.=file_get_contents("views/seguimiento/" . $id_empresa . "_seguimiento_registro_comentario_correcto.html");
            }else{
                $comentario.=file_get_contents("views/seguimiento/" . $id_empresa . "_seguimiento_registro_comentario.html");
            }
        }else{
            $comentario.=file_get_contents("views/seguimiento/" . $id_empresa . "_seguimiento_registro_comentario.html");

        }

        $comentario = str_replace("{NOMBRE_COLABORADOR}", utf8_encode($come->nombre_completo), $comentario);
        $comentario = str_replace("{COMENTARIO_INGRESADO}", utf8_encode($come->comentario), $comentario);
        $comentario = str_replace("{FECHA}", $come->fecha, $comentario);
        $comentario = str_replace("{HORA_INGRESO}", $come->hora, $comentario);
        if($come->archivo){
            $comentario = str_replace("{BLOQUE_ARCHIVO_POR_COMENTARIO}", '<br><div class="">
                    <span class="com_mp_texto"><a class="badge btn btn-info" href="documentos_hotline/archivos_por_comentarios/'.$come->archivo.'" target="_blank">Descargar Documento</a></span>
                </div>', $comentario);


        }else{
            $comentario = str_replace("{BLOQUE_ARCHIVO_POR_COMENTARIO}", "", $comentario);
        }

    }
    return($comentario);
}

function ColocaFiltrosMinvest($PRINCIPAL, $id_empresa, $id_registro){
    //Filtros Marca
    $marcas=SIS_seg_marcas($id_empresa);
    $datos_registro=SEGUIMIENTO_DatosRegistroSoloId($id_empresa, $id_registro);

    $options_marcas="<option value=''>Todos</option>";
    foreach($marcas as $marc){
        if($marc->id_marca==$datos_registro[0]->marca){
            $options_marcas.="<option selected value='".$marc->id_marca."'>".$marc->descripcion."</option>";
        }else{
            $options_marcas.="<option value='".$marc->id_marca."'>".$marc->descripcion."</option>";
        }

        }
    $PRINCIPAL = str_replace("{OPTION_MARCA}", $options_marcas, $PRINCIPAL);

    //modelos
    $modelos=SIS_seg_modelos($id_empresa, "");
    $options_modelo="<option value=''>Todos</option>";
    foreach($modelos as $mod){
        if($mod->id_modelo==$datos_registro[0]->modelo){
            $options_modelo.="<option value='".$mod->id_modelo."' selected>".$mod->descripcion."</option>";
        }else{
            $options_modelo.="<option value='".$mod->id_modelo."'>".$mod->descripcion."</option>";
        }

    }
    $PRINCIPAL = str_replace("{OPTION_MODELOS}", $options_modelo, $PRINCIPAL);

    //Sistemas
    $sistemas=SIS_seg_istemasmarcas($id_empresa);
    $options_sistemas="<option value=''>Todos</option>";

    foreach($sistemas as $sist){
        if($sist->id_sistema==$datos_registro[0]->sistema){
            $options_sistemas.='<option selected value="'.$sist->id_sistema.'">'.$sist->descripcion.'</option>';
        }else{
            $options_sistemas.='<option value="'.$sist->id_sistema.'">'.$sist->descripcion.'</option>';
        }

    }
    $PRINCIPAL = str_replace("{OPTION_SISTEMA}", utf8_encode($options_sistemas), $PRINCIPAL);

    return($PRINCIPAL);

}
function ColocaEventosCalendario($PRINCIPAL, $id_empresa, $tipo, $filtro_cui, $filtro_rut, $filtro_tipo)
{
    $eventos          = EVENTOS_TraeEventos($id_empresa, $tipo, $filtro_cui, $filtro_rut, $filtro_tipo);
    //print_r($eventos);
    $contador_eventos = 1;
    $fecha_actual     = date("Y-m-d");
    foreach ($eventos as $eve) {
        if ($eve->fecha_inicio < $eve->fecha_termino) {
            $html_evento .= file_get_contents("views/calendario/eventos/" . $id_empresa . "_row_basic-views_rangos.html");
        } else if ($eve->fecha_inicio == $eve->fecha_termino) {
            $html_evento .= file_get_contents("views/calendario/eventos/" . $id_empresa . "_row_basic-views.html");
        }
        $html_evento = str_replace("{NOMBRE}", $eve->nombre, $html_evento);
        $html_evento = str_replace("{FECHA_INICIO}", $eve->fecha_inicio, $html_evento);
        $html_evento = str_replace("{FECHA_TERMINO}", $eve->fecha_termino, $html_evento);
        if ($eve->target == "1") {
            $html_evento = str_replace("{URL_EXTERNA}", "url: '" . $eve->link_acceso . "',", $html_evento);
        }
        $html_evento = str_replace("{IDEVENTO}", $eve->id_evento, $html_evento);
        $html_evento = str_replace("{URL_EXTERNA}", "", $html_evento);
        if ($contador_eventos < count($eventos)) {
            $html_evento .= ", ";
        }
        $contador_eventos++;
        $total_eventos .= $html_evento;
    }
    $PRINCIPAL = str_replace("{ROW_EVENTOS}", utf8_encode($html_evento), $PRINCIPAL);
    $PRINCIPAL = str_replace("{FECHA_ACTUAL}", utf8_encode($fecha_actual), $PRINCIPAL);
    return ($PRINCIPAL);
}
function lms_medicion_por_jefe($rut, $id_empresa)
{
    $listaMediciones = Lista_mediciones_jefe_data($rut, $id_empresa);
    foreach ($listaMediciones as $listaMedicion) {

        if($listaMedicion->fecha1<>''){
            $bloque_archivos .= file_get_contents("views/medicion/" . $id_empresa . "_medicion_por_usuario.html");
            $bloque_archivos = str_replace("{FECHA}", utf8_encode($listaMedicion->fecha1), $bloque_archivos);
            if($listaMedicion->Porcentaje>=1){
                $link="";
                $icon="<span class='comp_verde_circle'><i class='icon-check icons'></i></span>";
                } else {
                $link="<a href='?sw=medicion_preguntas&rutcol=".$listaMedicion->rut."&idm=".$listaMedicion->id_medicion."&fecha=".$listaMedicion->fecha1."' > ";
            $icon="<span class='comp_rojo_circle'><i class='far fa-times-circle'></i></span>";    }
            $bloque_archivos = str_replace("{LINK}", $link, $bloque_archivos);
            $bloque_archivos = str_replace("{LINKFIN}", "</a>", $bloque_archivos);
            $bloque_archivos = str_replace("{ICON}", $icon, $bloque_archivos);
        }
        if($listaMedicion->fecha2<>''){
            $bloque_archivos = str_replace("{FECHA}", utf8_encode($listaMedicion->fecha2), $bloque_archivos);
            $bloque_archivos .= file_get_contents("views/medicion/" . $id_empresa . "_medicion_por_usuario.html");
            if($listaMedicion->Porcentaje>=1){
                $link="";
                $icon="<span class='comp_verde_circle'><i class='icon-check icons'></i></span>";

                } else {
                $link="<a href='?sw=medicion_preguntas&rutcol=".$listaMedicion->rut."&idm=".$listaMedicion->id_medicion."&fecha=".$listaMedicion->fecha1."' > ";
            $icon="<span class='comp_rojo_circle'><i class='far fa-times-circle'></i></span>";
                }
            $bloque_archivos = str_replace("{LINK}", $link, $bloque_archivos);
            $bloque_archivos = str_replace("{LINKFIN}", "</a>", $bloque_archivos);
            $bloque_archivos = str_replace("{ICON}", $icon, $bloque_archivos);
        }
        if($listaMedicion->fecha3<>''){
            $bloque_archivos .= file_get_contents("views/medicion/" . $id_empresa . "_medicion_por_usuario.html");
            $bloque_archivos = str_replace("{FECHA}", utf8_encode($listaMedicion->fecha3), $bloque_archivos);
            if($listaMedicion->Porcentaje>=1){
                $link="";
                $icon="<span class='comp_verde_circle'><i class='icon-check icons'></i></span>";

                } else {
                $link="<a href='?sw=medicion_preguntas&rutcol=".$listaMedicion->rut."&idm=".$listaMedicion->id_medicion."&fecha=".$listaMedicion->fecha1."' > ";
            $icon="<span class='comp_rojo_circle'><i class='far fa-times-circle'></i></span>";
                }
            $bloque_archivos = str_replace("{LINK}", $link, $bloque_archivos);
            $bloque_archivos = str_replace("{LINKFIN}", "</a>", $bloque_archivos);
            $bloque_archivos = str_replace("{ICON}", $icon, $bloque_archivos);
        }
        if($listaMedicion->fecha1==''){
            $bloque_archivos .= file_get_contents("views/medicion/" . $id_empresa . "_medicion_por_usuario.html");
            $bloque_archivos = str_replace("{FECHA}", "", $bloque_archivos);
            if($listaMedicion->Porcentaje>=1){
                $link="";
                $icon="<div class='comp_verde_circle'><i class='icon-check icons'></i></div>";
                } else {
                $link="<a href='?sw=medicion_preguntas&rutcol=".$listaMedicion->rut."&idm=".$listaMedicion->id_medicion."&fecha=".$listaMedicion->fecha1."' > ";
                $icon="<div class='comp_rojo_circle'><i class='far fa-times-circle'></i></div>";
                }
            $bloque_archivos = str_replace("{LINK}", $link, $bloque_archivos);
            $bloque_archivos = str_replace("{LINKFIN}", "</a>", $bloque_archivos);
            $bloque_archivos = str_replace("{ICON}", $icon, $bloque_archivos);
        }

        $bloque_archivos = str_replace("{TITULO_MEDICION}", utf8_encode($listaMedicion->medicion), $bloque_archivos);
        $bloque_archivos = str_replace("{FOTO_PERSONA}", VerificaFotoPersonal($listaMedicion->rut), $bloque_archivos);
        $bloque_archivos = str_replace("{NOMBRE}", utf8_encode($listaMedicion->nombre), $bloque_archivos);
        $bloque_archivos = str_replace("{CARGO}", utf8_encode($listaMedicion->cargo), $bloque_archivos);
        $bloque_archivos = str_replace("{GERENCIA}", utf8_encode($listaMedicion->gerencia), $bloque_archivos);
        $cuenta_mediciones++;
        $bloque_archivos = str_replace("{ID_ENCUESTA}", utf8_encode($listaMedicion->id_encuesta), $bloque_archivos);
        $bloque_archivos = str_replace("{ID_MEDICION}", utf8_encode($listaMedicion->id_medicion), $bloque_archivos);
        $bloque_archivos = str_replace("{RUT}", utf8_encode($rut), $bloque_archivos);
        $bloque_archivos = str_replace("{RUT_COLABORADOR}", utf8_encode($listaMedicion->rut), $bloque_archivos);
        $estado          = ValidaEstadoMedicion($rut, $id_empresa, $listaMedicion->id_encuesta, $listaMedicion->id_medicion, $listaMedicion->rut);
        $bloque_archivos = str_replace("{ESTADO}", $estado, $bloque_archivos);
    }
    $arreglo[0] = $bloque_archivos;
    $arreglo[1] = $cuenta_mediciones;
    return $arreglo;
}


function lms_medicion_encuestas_por_estado($rut, $estado_sent, $id_empresa)
{
    $listaMediciones = Lista_mediciones_encuestas_data($rut, $id_empresa);

        //echo "<br>Mediciones, filtrado por $estado<br>";
        //print_r($listaMediciones);
    foreach ($listaMediciones as $listaMedicion) {

        $hoy=date("Y-m-d");
        $estado          = ValidaEstadoMedicionIndividual($rut, $id_empresa, $listaMedicion->id_encuesta, $listaMedicion->id_medicion);

        //echo "<br>Estado $estado";
        //echo "<br> Col ".$listaMedicion->rut." $rut     $hoy, f1 ".$listaMedicion->fecha1." estadof1 $estado_f1   f2 ".$listaMedicion->fecha2." estadof2 $estado_f2  f3 ".$listaMedicion->fecha3." estadof3 $estado_f3 ";
        $bloque_archivos ="";

                        if($estado_sent==$estado and $estado_sent=="FINALIZADO"){
                                //echo "<br>finalizado_2";



                                    $bloque_archivos .= file_get_contents("views/medicion/" . $id_empresa . "_medicion_por_encuestas_finalizados.html");
                                    $bloque_archivos = str_replace("{FECHA}", utf8_encode($listaMedicion->fecha1), $bloque_archivos);
                                    $icon="<span class='comp_verde_circle'><i class='icon-check icons'></i></span>";
                                    $link="";
                                    $bloque_archivos = str_replace("{LINK}", $link, $bloque_archivos);
                                    $bloque_archivos = str_replace("{LINKFIN}", "</a>", $bloque_archivos);
                                    $bloque_archivos = str_replace("{ICON}", $icon, $bloque_archivos);
                                $bloque_archivos = str_replace("{TITULO_MEDICION}", utf8_encode($listaMedicion->medicion), $bloque_archivos);
                                $bloque_archivos = str_replace("{FOTO_PERSONA}", VerificaFotoPersonal($listaMedicion->rut), $bloque_archivos);
                                $bloque_archivos = str_replace("{NOMBRE}", utf8_encode($listaMedicion->nombre), $bloque_archivos);
                                $bloque_archivos = str_replace("{CARGO}", utf8_encode($listaMedicion->cargo), $bloque_archivos);
                                $bloque_archivos = str_replace("{GERENCIA}", utf8_encode($listaMedicion->gerencia), $bloque_archivos);
                                $cuenta_mediciones++;
                                $bloque_archivos = str_replace("{ID_ENCUESTA}", utf8_encode($listaMedicion->id_encuesta), $bloque_archivos);
                                $bloque_archivos = str_replace("{ID_MEDICION}", utf8_encode($listaMedicion->id_medicion), $bloque_archivos);
                                $bloque_archivos = str_replace("{RUT}", utf8_encode($rut), $bloque_archivos);
                                $bloque_archivos = str_replace("{RUT_COLABORADOR}", utf8_encode($listaMedicion->rut), $bloque_archivos);
                                $bloque_archivos = str_replace("{ESTADO}", $estado, $bloque_archivos);


                        }

                //echo "<br>$estado_sent==$estado and $estado_sent==PENDIENTE";

                        if($estado_sent==$estado and $estado_sent=="PENDIENTE"){

                               // echo "<br>pendiente_2";
                                    $bloque_archivos .= file_get_contents("views/medicion/" . $id_empresa . "_medicion_por_encuestas.html");
                                    $bloque_archivos = str_replace("{FECHA}", utf8_encode($listaMedicion->fecha1), $bloque_archivos);

                                        $link="<a href='?sw=medicion_encuestas_preguntas&idm=".$listaMedicion->id_medicion."' > ";
                                        $icon="<span class='comp_amarillo_circle'><i class='fas fa-exclamation-circle'></i></span>";

                                    $bloque_archivos = str_replace("{LINK}", $link, $bloque_archivos);
                                    $bloque_archivos = str_replace("{LINKFIN}", "</a>", $bloque_archivos);
                                    $bloque_archivos = str_replace("{ICON}", $icon, $bloque_archivos);
                                $bloque_archivos = str_replace("{TITULO_MEDICION}", utf8_encode($listaMedicion->medicion), $bloque_archivos);
                                $bloque_archivos = str_replace("{FOTO_PERSONA}", VerificaFotoPersonal($listaMedicion->rut), $bloque_archivos);
                                $bloque_archivos = str_replace("{NOMBRE}", utf8_encode($listaMedicion->nombre), $bloque_archivos);
                                $bloque_archivos = str_replace("{CARGO}", utf8_encode($listaMedicion->cargo), $bloque_archivos);
                                $bloque_archivos = str_replace("{GERENCIA}", utf8_encode($listaMedicion->gerencia), $bloque_archivos);
                                $cuenta_mediciones++;
                                $bloque_archivos = str_replace("{ID_ENCUESTA}", utf8_encode($listaMedicion->id_encuesta), $bloque_archivos);
                                $bloque_archivos = str_replace("{ID_MEDICION}", utf8_encode($listaMedicion->id_medicion), $bloque_archivos);
                                $bloque_archivos = str_replace("{RUT}", utf8_encode($rut), $bloque_archivos);
                                $bloque_archivos = str_replace("{RUT_COLABORADOR}", utf8_encode($listaMedicion->rut), $bloque_archivos);
                                $bloque_archivos = str_replace("{ESTADO}", $estado, $bloque_archivos);

                        }
                       // echo  $bloque_archivos;
    }
    $arreglo[0] = $bloque_archivos;
    $arreglo[1] = $cuenta_mediciones;
    return $arreglo;
}
function lms_medicion_encuestas_evaluacion_por_estado($rut, $estado_sent, $id_empresa)
{
    $listaMediciones = Lista_mediciones_encuestas_data($rut, $id_empresa);

        //echo "<br>Mediciones, filtrado por $estado<br>";
        //print_r($listaMediciones);
    foreach ($listaMediciones as $listaMedicion) {

        $hoy=date("Y-m-d");
        $estado          = ValidaEstadoMedicionIndividual($rut, $id_empresa, $listaMedicion->id_encuesta, $listaMedicion->id_medicion);

        //echo "<br>Estado $estado";
        //echo "<br> Col ".$listaMedicion->rut." $rut     $hoy, f1 ".$listaMedicion->fecha1." estadof1 $estado_f1   f2 ".$listaMedicion->fecha2." estadof2 $estado_f2  f3 ".$listaMedicion->fecha3." estadof3 $estado_f3 ";
        $bloque_archivos ="";

                        if($estado_sent==$estado and $estado_sent=="FINALIZADO"){
                                //echo "<br>finalizado_2";



                                    $bloque_archivos .= file_get_contents("views/medicion/" . $id_empresa . "_medicion_por_encuestas_finalizados.html");
                                    $bloque_archivos = str_replace("{FECHA}", utf8_encode($listaMedicion->fecha1), $bloque_archivos);
                                    $icon="<span class='comp_verde_circle'><i class='icon-check icons'></i></span>";
                                    $link="<a href='?sw=medicion_encuestas_evaluacion_preguntas_lb_res&idm=".$listaMedicion->id_encuesta."' > ";
                                    $bloque_archivos = str_replace("{LINK}", $link, $bloque_archivos);
                                    $bloque_archivos = str_replace("{LINKFIN}", "</a>", $bloque_archivos);
                                    $bloque_archivos = str_replace("{ICON}", $icon, $bloque_archivos);
                                $bloque_archivos = str_replace("{TITULO_MEDICION}", utf8_encode($listaMedicion->medicion), $bloque_archivos);
                                $bloque_archivos = str_replace("{FOTO_PERSONA}", VerificaFotoPersonal($listaMedicion->rut), $bloque_archivos);
                                $bloque_archivos = str_replace("{NOMBRE}", utf8_encode($listaMedicion->nombre), $bloque_archivos);
                                $bloque_archivos = str_replace("{CARGO}", utf8_encode($listaMedicion->cargo), $bloque_archivos);
                                $bloque_archivos = str_replace("{GERENCIA}", utf8_encode($listaMedicion->gerencia), $bloque_archivos);
                                $cuenta_mediciones++;
                                $bloque_archivos = str_replace("{ID_ENCUESTA}", utf8_encode($listaMedicion->id_encuesta), $bloque_archivos);
                                $bloque_archivos = str_replace("{ID_MEDICION}", utf8_encode($listaMedicion->id_medicion), $bloque_archivos);
                                $bloque_archivos = str_replace("{RUT}", utf8_encode($rut), $bloque_archivos);
                                $bloque_archivos = str_replace("{RUT_COLABORADOR}", utf8_encode($listaMedicion->rut), $bloque_archivos);
                                $bloque_archivos = str_replace("{ESTADO}", $estado, $bloque_archivos);


                        }

                //echo "<br>$estado_sent==$estado and $estado_sent==PENDIENTE";

                        if($estado_sent==$estado and $estado_sent=="PENDIENTE"){

                               // echo "<br>pendiente_2";
                                    $bloque_archivos .= file_get_contents("views/medicion/" . $id_empresa . "_medicion_por_encuestas.html");
                                    $bloque_archivos = str_replace("{FECHA}", utf8_encode($listaMedicion->fecha1), $bloque_archivos);

                                        $link="<a href='?sw=medicion_encuestas_evaluacion_preguntas_lb&idm=".$listaMedicion->id_medicion."' > ";
                                        $icon="<span class='comp_amarillo_circle'><i class='fas fa-exclamation-circle'></i></span>";

                                    $bloque_archivos = str_replace("{LINK}", $link, $bloque_archivos);
                                    $bloque_archivos = str_replace("{LINKFIN}", "</a>", $bloque_archivos);
                                    $bloque_archivos = str_replace("{ICON}", $icon, $bloque_archivos);
                                $bloque_archivos = str_replace("{TITULO_MEDICION}", utf8_encode($listaMedicion->medicion), $bloque_archivos);
                                $bloque_archivos = str_replace("{FOTO_PERSONA}", VerificaFotoPersonal($listaMedicion->rut), $bloque_archivos);
                                $bloque_archivos = str_replace("{NOMBRE}", utf8_encode($listaMedicion->nombre), $bloque_archivos);
                                $bloque_archivos = str_replace("{CARGO}", utf8_encode($listaMedicion->cargo), $bloque_archivos);
                                $bloque_archivos = str_replace("{GERENCIA}", utf8_encode($listaMedicion->gerencia), $bloque_archivos);
                                $cuenta_mediciones++;
                                $bloque_archivos = str_replace("{ID_ENCUESTA}", utf8_encode($listaMedicion->id_encuesta), $bloque_archivos);
                                $bloque_archivos = str_replace("{ID_MEDICION}", utf8_encode($listaMedicion->id_medicion), $bloque_archivos);
                                $bloque_archivos = str_replace("{RUT}", utf8_encode($rut), $bloque_archivos);
                                $bloque_archivos = str_replace("{RUT_COLABORADOR}", utf8_encode($listaMedicion->rut), $bloque_archivos);
                                $bloque_archivos = str_replace("{ESTADO}", $estado, $bloque_archivos);

                        }
                       // echo  $bloque_archivos;
    }
    $arreglo[0] = $bloque_archivos;
    $arreglo[1] = $cuenta_mediciones;
    return $arreglo;
}
function lms_medicion_encuestas_lb_por_estado($rut, $estado_sent, $id_empresa)
{
    $listaMediciones = Lista_mediciones_encuestas_lb_data($rut, $id_empresa);

    //echo "<br>Mediciones, filtrado por $estado<br>";
    //print_r($listaMediciones);
    foreach ($listaMediciones as $listaMedicion) {

        $hoy=date("Y-m-d");
        $estado          = ValidaEstadoMedicionIndividual($rut, $id_empresa, $listaMedicion->id_encuesta, $listaMedicion->id);
        //print_r($estado);
        //echo "<br>Estado $estado, estado sent $estado_sent";
        //echo "<br> Col ".$listaMedicion->rut." $rut     $hoy, f1 ".$listaMedicion->fecha1." estadof1 $estado_f1   f2 ".$listaMedicion->fecha2." estadof2 $estado_f2  f3 ".$listaMedicion->fecha3." estadof3 $estado_f3 ";
        $bloque_archivos ="";

                        if($estado_sent==$estado and $estado_sent=="FINALIZADO"){
                                //echo "<br>finalizado_2";



                        $bloque_archivos .= file_get_contents("views/medicion/" . $id_empresa . "_medicion_por_encuestas_finalizados.html");
                        $bloque_archivos = str_replace("{FECHA}", utf8_encode($listaMedicion->fecha1), $bloque_archivos);
                        $icon="<span class='comp_verde_circle'><i class='icon-check icons'></i></span>";
                                $link="<a href='?sw=medicion_encuestas_preguntas_lb&idm=".$listaMedicion->id."' > ";
                        $bloque_archivos = str_replace("{LINK}", $link, $bloque_archivos);
                        $bloque_archivos = str_replace("{LINKFIN}", "</a>", $bloque_archivos);
                        $bloque_archivos = str_replace("{ICON}", $icon, $bloque_archivos);

                        $bloque_archivos = str_replace("{TITULO_MEDICION}", utf8_encode($listaMedicion->medicion), $bloque_archivos);
                        $bloque_archivos = str_replace("{FOTO_PERSONA}", VerificaFotoPersonal($listaMedicion->rut), $bloque_archivos);
                        $bloque_archivos = str_replace("{NOMBRE}", utf8_encode($listaMedicion->nombre), $bloque_archivos);
                        $bloque_archivos = str_replace("{CARGO}", utf8_encode($listaMedicion->cargo), $bloque_archivos);
                        $bloque_archivos = str_replace("{GERENCIA}", utf8_encode($listaMedicion->gerencia), $bloque_archivos);
                        $cuenta_mediciones++;
                        $bloque_archivos = str_replace("{ID_ENCUESTA}", utf8_encode($listaMedicion->id_encuesta), $bloque_archivos);
                        $bloque_archivos = str_replace("{ID_MEDICION}", utf8_encode($listaMedicion->id_medicion), $bloque_archivos);
                        $bloque_archivos = str_replace("{RUT}", utf8_encode($rut), $bloque_archivos);
                        $bloque_archivos = str_replace("{RUT_COLABORADOR}", utf8_encode($listaMedicion->rut), $bloque_archivos);
                        $bloque_archivos = str_replace("{ESTADO}", $estado, $bloque_archivos);


                        }


                        if($estado_sent==$estado and $estado_sent=="PENDIENTE"){

                        //echo "<br>pendiente_2";
                        $bloque_archivos .= file_get_contents("views/medicion/" . $id_empresa . "_medicion_por_encuestas.html");
                        $bloque_archivos = str_replace("{FECHA}", utf8_encode($listaMedicion->fecha1), $bloque_archivos);

                                $link="<a href='?sw=medicion_encuestas_preguntas_lb&idm=".$listaMedicion->id."' > ";
                                $icon="<span class='comp_amarillo_circle'><i class='fas fa-exclamation-circle'></i></span>";

                        $bloque_archivos = str_replace("{LINK}", $link, $bloque_archivos);
                        $bloque_archivos = str_replace("{LINKFIN}", "</a>", $bloque_archivos);
                        $bloque_archivos = str_replace("{ICON}", $icon, $bloque_archivos);
                        $bloque_archivos = str_replace("{TITULO_MEDICION}", utf8_encode($listaMedicion->medicion), $bloque_archivos);
                        $bloque_archivos = str_replace("{FOTO_PERSONA}", VerificaFotoPersonal($listaMedicion->rut), $bloque_archivos);
                        $bloque_archivos = str_replace("{NOMBRE}", utf8_encode($listaMedicion->nombre), $bloque_archivos);
                        $bloque_archivos = str_replace("{CARGO}", utf8_encode($listaMedicion->cargo), $bloque_archivos);
                        $bloque_archivos = str_replace("{GERENCIA}", utf8_encode($listaMedicion->gerencia), $bloque_archivos);
                        $cuenta_mediciones++;
                        $bloque_archivos = str_replace("{ID_ENCUESTA}", utf8_encode($listaMedicion->id_encuesta), $bloque_archivos);
                        $bloque_archivos = str_replace("{ID_MEDICION}", utf8_encode($listaMedicion->id_medicion), $bloque_archivos);
                        $bloque_archivos = str_replace("{RUT}", utf8_encode($rut), $bloque_archivos);
                        $bloque_archivos = str_replace("{RUT_COLABORADOR}", utf8_encode($listaMedicion->rut), $bloque_archivos);
                        $bloque_archivos = str_replace("{ESTADO}", $estado, $bloque_archivos);

                        }
    }
    $arreglo[0] = $bloque_archivos;
    $arreglo[1] = $cuenta_mediciones;
    return $arreglo;
}

function lms_medicion_encuestas_clima_por_estado($rut, $estado_sent, $id_empresa)
{
    $listaMediciones = Lista_mediciones_encuestas_data($rut, $id_empresa);

        //echo "<br>Mediciones, filtrado por $estado<br>";
        //print_r($listaMediciones);
    foreach ($listaMediciones as $listaMedicion) {

        $hoy=date("Y-m-d");
        $estado          = ValidaEstadoMedicionIndividual($rut, $id_empresa, $listaMedicion->id_encuesta, $listaMedicion->id_medicion);

        //echo "<br>Estado $estado";
        //echo "<br> Col ".$listaMedicion->rut." $rut     $hoy, f1 ".$listaMedicion->fecha1." estadof1 $estado_f1   f2 ".$listaMedicion->fecha2." estadof2 $estado_f2  f3 ".$listaMedicion->fecha3." estadof3 $estado_f3 ";
        $bloque_archivos ="";

                        if($estado_sent==$estado and $estado_sent=="FINALIZADO"){
                                //echo "<br>finalizado_2";



                                    $bloque_archivos .= file_get_contents("views/medicion/" . $id_empresa . "_medicion_por_encuestas_clima_finalizados.html");
                                    $bloque_archivos = str_replace("{FECHA}", utf8_encode($listaMedicion->fecha1), $bloque_archivos);
                                    $icon="<span class='comp_verde_circle'><i class='icon-check icons'></i></span>";
                                    $link="";
                                    $bloque_archivos = str_replace("{LINK}", $link, $bloque_archivos);
                                    $bloque_archivos = str_replace("{LINKFIN}", "</a>", $bloque_archivos);
                                    $bloque_archivos = str_replace("{ICON}", $icon, $bloque_archivos);
                                $bloque_archivos = str_replace("{TITULO_MEDICION}", utf8_encode($listaMedicion->medicion), $bloque_archivos);
                                $bloque_archivos = str_replace("{FOTO_PERSONA}", VerificaFotoPersonal($listaMedicion->rut), $bloque_archivos);
                                $bloque_archivos = str_replace("{NOMBRE}", utf8_encode($listaMedicion->nombre), $bloque_archivos);
                                $bloque_archivos = str_replace("{CARGO}", utf8_encode($listaMedicion->cargo), $bloque_archivos);
                                $bloque_archivos = str_replace("{GERENCIA}", utf8_encode($listaMedicion->gerencia), $bloque_archivos);
                                $cuenta_mediciones++;
                                $bloque_archivos = str_replace("{ID_ENCUESTA}", utf8_encode($listaMedicion->id_encuesta), $bloque_archivos);
                                $bloque_archivos = str_replace("{ID_MEDICION}", utf8_encode($listaMedicion->id_medicion), $bloque_archivos);
                                $bloque_archivos = str_replace("{RUT}", utf8_encode($rut), $bloque_archivos);
                                $bloque_archivos = str_replace("{RUT_COLABORADOR}", utf8_encode($listaMedicion->rut), $bloque_archivos);
                                $bloque_archivos = str_replace("{ESTADO}", $estado, $bloque_archivos);


                        }


                        if($estado_sent==$estado and $estado_sent=="PENDIENTE"){

                                //echo "<br>pendiente_2";
                                    $bloque_archivos .= file_get_contents("views/medicion/" . $id_empresa . "_medicion_por_encuestas_clima.html");
                                    $bloque_archivos = str_replace("{FECHA}", utf8_encode($listaMedicion->fecha1), $bloque_archivos);

                                        $link="<a href='?sw=medicion_encuestas_preguntas&idm=".$listaMedicion->id_medicion."&tipo=clima' > ";
                                        $icon="<span class='comp_amarillo_circle'><i class='fas fa-exclamation-circle'></i></span>";

                                    $bloque_archivos = str_replace("{LINK}", $link, $bloque_archivos);
                                    $bloque_archivos = str_replace("{LINKFIN}", "</a>", $bloque_archivos);
                                    $bloque_archivos = str_replace("{ICON}", $icon, $bloque_archivos);
                                $bloque_archivos = str_replace("{TITULO_MEDICION}", utf8_encode($listaMedicion->medicion), $bloque_archivos);
                                $bloque_archivos = str_replace("{FOTO_PERSONA}", VerificaFotoPersonal($listaMedicion->rut), $bloque_archivos);
                                $bloque_archivos = str_replace("{NOMBRE}", utf8_encode($listaMedicion->nombre), $bloque_archivos);
                                $bloque_archivos = str_replace("{CARGO}", utf8_encode($listaMedicion->cargo), $bloque_archivos);
                                $bloque_archivos = str_replace("{GERENCIA}", utf8_encode($listaMedicion->gerencia), $bloque_archivos);
                                $cuenta_mediciones++;
                                $bloque_archivos = str_replace("{ID_ENCUESTA}", utf8_encode($listaMedicion->id_encuesta), $bloque_archivos);
                                $bloque_archivos = str_replace("{ID_MEDICION}", utf8_encode($listaMedicion->id_medicion), $bloque_archivos);
                                $bloque_archivos = str_replace("{RUT}", utf8_encode($rut), $bloque_archivos);
                                $bloque_archivos = str_replace("{RUT_COLABORADOR}", utf8_encode($listaMedicion->rut), $bloque_archivos);
                                $bloque_archivos = str_replace("{ESTADO}", $estado, $bloque_archivos);

                        }
    }
    $arreglo[0] = $bloque_archivos;
    $arreglo[1] = $cuenta_mediciones;
    return $arreglo;
}

function lms_medicion_por_jefe_por_estado($rut, $estado, $id_empresa)
{
    $listaMediciones = Lista_mediciones_jefe_data($rut, $id_empresa);
    //print_r($listaMediciones);

    foreach ($listaMediciones as $listaMedicion) {

    $hoy=date("Y-m-d");
//$estado          = ValidaEstadoMedicion($rut, $id_empresa, $listaMedicion->id_encuesta, $listaMedicion->id_medicion, $listaMedicion->rut);

$estado_f1          = ValidaEstadoMedicionFecha($rut, $id_empresa, $listaMedicion->id_encuesta, $listaMedicion->id_medicion,$listaMedicion->fecha1, $listaMedicion->rut);
$estado_f2          = ValidaEstadoMedicionFecha($rut, $id_empresa, $listaMedicion->id_encuesta, $listaMedicion->id_medicion,$listaMedicion->fecha2, $listaMedicion->rut);
$estado_f3          = ValidaEstadoMedicionFecha($rut, $id_empresa, $listaMedicion->id_encuesta, $listaMedicion->id_medicion,$listaMedicion->fecha3, $listaMedicion->rut);

//echo "<br> Col ".$listaMedicion->rut." $rut     $hoy, f1 ".$listaMedicion->fecha1." estadof1 $estado_f1   f2 ".$listaMedicion->fecha2." estadof2 $estado_f2  f3 ".$listaMedicion->fecha3." estadof3 $estado_f3 ";


if($estado=="realizadas"){


        if($listaMedicion->fecha1<>'' AND $estado_f1=="FINALIZADO"){
            $bloque_archivos .= file_get_contents("views/medicion/" . $id_empresa . "_medicion_por_usuario.html");
            $bloque_archivos = str_replace("{FECHA_INICIO}", utf8_encode($listaMedicion->fecha1), $bloque_archivos);
            $icon="<span class='comp_verde_circle'><i class='icon-check icons'></i></span>";
            $link="";
            $bloque_archivos = str_replace("{LINK}", $link, $bloque_archivos);
            $bloque_archivos = str_replace("{LINKFIN}", "</a>", $bloque_archivos);
            $bloque_archivos = str_replace("{ICON}", $icon, $bloque_archivos);
        }
        if($listaMedicion->fecha2<>''  AND $estado_f2=="FINALIZADO"){
            $bloque_archivos .= file_get_contents("views/medicion/" . $id_empresa . "_medicion_por_usuario.html");
            $bloque_archivos = str_replace("{FECHA_INICIO}", utf8_encode($listaMedicion->fecha2), $bloque_archivos);
            $link="";
            $icon="<span class='comp_verde_circle'><i class='icon-check icons'></i></span>";
            $bloque_archivos = str_replace("{LINK}", $link, $bloque_archivos);
            $bloque_archivos = str_replace("{LINKFIN}", "</a>", $bloque_archivos);
            $bloque_archivos = str_replace("{ICON}", $icon, $bloque_archivos);
        }
        if($listaMedicion->fecha3<>''  AND $estado_f3=="FINALIZADO"){
            $bloque_archivos .= file_get_contents("views/medicion/" . $id_empresa . "_medicion_por_usuario.html");
            $bloque_archivos = str_replace("{FECHA_INICIO}", utf8_encode($listaMedicion->fecha3), $bloque_archivos);
            $link="";
            $icon="<span class='comp_verde_circle'><i class='icon-check icons'></i></span>";
            $bloque_archivos = str_replace("{LINK}", $link, $bloque_archivos);
            $bloque_archivos = str_replace("{LINKFIN}", "</a>", $bloque_archivos);
            $bloque_archivos = str_replace("{ICON}", $icon, $bloque_archivos);
        }

}
//echo "<br><br>$rut, $estado, $id_empresa";
//echo "<pre>";//print_r($bloque_archivos);
//echo "<br> fechas ".$listaMedicion->fecha1." ".$listaMedicion->fecha2." ".$listaMedicion->fecha3."";

if($estado=="pendientes"){

        if($listaMedicion->fecha1<>'' and $listaMedicion->fecha1<=$hoy  AND $estado_f1=="PENDIENTE"){
            $bloque_archivos .= file_get_contents("views/medicion/" . $id_empresa . "_medicion_por_usuario.html");
            $bloque_archivos = str_replace("{FECHA_INICIO}", utf8_encode($listaMedicion->fecha1), $bloque_archivos);

                $link="<a href='?sw=medicion_preguntas&rutcol=".$listaMedicion->rut."&idm=".$listaMedicion->id_medicion."&fecha=".$listaMedicion->fecha1."' > ";
                $icon="<span class='comp_amarillo_circle'><i class='fas fa-exclamation-circle'></i></span>";

            $bloque_archivos = str_replace("{LINK}", $link, $bloque_archivos);
            $bloque_archivos = str_replace("{LINKFIN}", "</a>", $bloque_archivos);
            $bloque_archivos = str_replace("{ICON}", $icon, $bloque_archivos);
        }
        if($listaMedicion->fecha2<>'' and $listaMedicion->fecha2<=$hoy   AND $estado_f2=="PENDIENTE"){
            $bloque_archivos .= file_get_contents("views/medicion/" . $id_empresa . "_medicion_por_usuario.html");
            $bloque_archivos = str_replace("{FECHA_INICIO}", utf8_encode($listaMedicion->fecha2), $bloque_archivos);

                $link="<a href='?sw=medicion_preguntas&rutcol=".$listaMedicion->rut."&idm=".$listaMedicion->id_medicion."&fecha=".$listaMedicion->fecha2."' > ";
                $icon="<span class='comp_amarillo_circle'><i class='fas fa-exclamation-circle'></i></span>";

            $bloque_archivos = str_replace("{LINK}", $link, $bloque_archivos);
            $bloque_archivos = str_replace("{LINKFIN}", "</a>", $bloque_archivos);
            $bloque_archivos = str_replace("{ICON}", $icon, $bloque_archivos);
        }
        if($listaMedicion->fecha3<>'' and $listaMedicion->fecha3<=$hoy   AND $estado_f3=="PENDIENTE"){
            $bloque_archivos .= file_get_contents("views/medicion/" . $id_empresa . "_medicion_por_usuario.html");
            $bloque_archivos = str_replace("{FECHA_INICIO}", utf8_encode($listaMedicion->fecha3), $bloque_archivos);

                $link="<a href='?sw=medicion_preguntas&rutcol=".$listaMedicion->rut."&idm=".$listaMedicion->id_medicion."&fecha=".$listaMedicion->fecha3."' > ";
                $icon="<span class='comp_amarillo_circle'><i class='fas fa-exclamation-circle'></i></span>";

            $bloque_archivos = str_replace("{LINK}", $link, $bloque_archivos);
            $bloque_archivos = str_replace("{LINKFIN}", "</a>", $bloque_archivos);
            $bloque_archivos = str_replace("{ICON}", $icon, $bloque_archivos);
        }

}





        $bloque_archivos = str_replace("{TITULO_MEDICION}", utf8_encode($listaMedicion->medicion), $bloque_archivos);
        $bloque_archivos = str_replace("{FOTO_PERSONA}", VerificaFotoPersonal($listaMedicion->rut), $bloque_archivos);
        $bloque_archivos = str_replace("{NOMBRE}", utf8_encode($listaMedicion->nombre), $bloque_archivos);
        $bloque_archivos = str_replace("{CARGO}", utf8_encode($listaMedicion->cargo), $bloque_archivos);
        $bloque_archivos = str_replace("{GERENCIA}", utf8_encode($listaMedicion->gerencia), $bloque_archivos);
        $cuenta_mediciones++;
        $bloque_archivos = str_replace("{ID_ENCUESTA}", utf8_encode($listaMedicion->id_encuesta), $bloque_archivos);
        $bloque_archivos = str_replace("{ID_MEDICION}", utf8_encode($listaMedicion->id_medicion), $bloque_archivos);
        $bloque_archivos = str_replace("{RUT}", utf8_encode($rut), $bloque_archivos);
        $bloque_archivos = str_replace("{RUT_COLABORADOR}", utf8_encode($listaMedicion->rut), $bloque_archivos);
        $bloque_archivos = str_replace("{ESTADO}", $estado, $bloque_archivos);
    }
    $arreglo[0] = $bloque_archivos;
    $arreglo[1] = $cuenta_mediciones;
    return $arreglo;
}


function Entorno_Medicion_Encuesta($rut,$rut, $idm, $fecha, $id_empresa)
{
    //echo "Entorno_Medicion_Encuesta($rut,$rut, $idm, $fecha, $id_empresa)";

        $bloque_archivos = str_replace("{TITULO_MEDICION}", utf8_encode($listaMedicion->medicion), $bloque_archivos);
        $bloque_archivos = str_replace("{FOTO_PERSONA}", VerificaFotoPersonal($listaMedicion->rut), $bloque_archivos);
        $bloque_archivos = str_replace("{NOMBRE}", utf8_encode($listaMedicion->nombre), $bloque_archivos);
        $bloque_archivos = str_replace("{CARGO}", utf8_encode($listaMedicion->cargo), $bloque_archivos);
        $bloque_archivos = str_replace("{GERENCIA}", utf8_encode($listaMedicion->gerencia), $bloque_archivos);
        $cuenta_mediciones++;
        $bloque_archivos = str_replace("{ID_ENCUESTA}", utf8_encode($listaMedicion->id_encuesta), $bloque_archivos);
        $bloque_archivos = str_replace("{ID_MEDICION}", utf8_encode($listaMedicion->id_medicion), $bloque_archivos);
        $bloque_archivos = str_replace("{RUT}", utf8_encode($rut), $bloque_archivos);
        $bloque_archivos = str_replace("{RUT_COLABORADOR}", utf8_encode($listaMedicion->rut), $bloque_archivos);
        $bloque_archivos = ColocaPreguntasMedicionColaboradores($bloque_archivos, $id_empresa, $rut,$rutcol, $idm, $fecha);
        $estado          = ValidaEstadoMedicion($rut, $id_empresa, $listaMedicion->id_encuesta, $listaMedicion->id_medicion, $listaMedicion->rut);
        $bloque_archivos = str_replace("{ESTADO}", $estado, $bloque_archivos);

    //print_r($bloque_archivos);


    return ($bloque_archivos);
}



function lms_medicion_por_jefe_pregunta($rut,$rutcol, $idm, $fecha, $id_empresa)
{

        //echo "$rut,$rutcol, $idm, $fecha, $id_empresa";
        ///echo "<br>function lms_medicion_por_jefe_pregunta($rut, $rutcol, $idm, $fecha, $id_empresa)";
        $bloque_archivos = str_replace("{FOTO_PERSONA}", VerificaFotoPersonal($listaMedicion->rut), $bloque_archivos);
        $bloque_archivos = str_replace("{NOMBRE}", utf8_encode($listaMedicion->nombre), $bloque_archivos);
        $bloque_archivos = str_replace("{CARGO}", utf8_encode($listaMedicion->cargo), $bloque_archivos);
        $bloque_archivos = str_replace("{GERENCIA}", utf8_encode($listaMedicion->gerencia), $bloque_archivos);
        $cuenta_mediciones++;
        $bloque_archivos = str_replace("{ID_ENCUESTA}", utf8_encode($listaMedicion->id_encuesta), $bloque_archivos);
        $bloque_archivos = str_replace("{ID_MEDICION}", utf8_encode($listaMedicion->id_medicion), $bloque_archivos);
        $bloque_archivos = str_replace("{RUT}", utf8_encode($rut), $bloque_archivos);
        $bloque_archivos = str_replace("{RUT_COLABORADOR}", utf8_encode($listaMedicion->rut), $bloque_archivos);
        $bloque_archivos = ColocaPreguntasMedicionColaboradores($bloque_archivos, $id_empresa, $rut,$rutcol, $idm, $fecha);
        $estado          = ValidaEstadoMedicion($rut, $id_empresa, $listaMedicion->id_encuesta, $listaMedicion->id_medicion, $listaMedicion->rut);
        $bloque_archivos = str_replace("{ESTADO}", $estado, $bloque_archivos);

    //print_r($bloque_archivos);


    return ($bloque_archivos);
}

function lms_medicion_por_pregunta_lb($rut,$rutcol, $idm, $fecha, $id_empresa)
{

       // echo "$rut,$rutcol, $idm, $fecha, $id_empresa";
        //echo "<br>function lms_medicion_por_jefe_pregunta($rut, $rutcol, $idm, $fecha, $id_empresa)";
        $bloque_archivos = str_replace("{FOTO_PERSONA}", VerificaFotoPersonal($listaMedicion->rut), $bloque_archivos);
        $bloque_archivos = str_replace("{NOMBRE}", utf8_encode($listaMedicion->nombre), $bloque_archivos);
        $bloque_archivos = str_replace("{CARGO}", utf8_encode($listaMedicion->cargo), $bloque_archivos);
        $bloque_archivos = str_replace("{GERENCIA}", utf8_encode($listaMedicion->gerencia), $bloque_archivos);
        $cuenta_mediciones++;
        $bloque_archivos = str_replace("{ID_ENCUESTA}", utf8_encode($listaMedicion->id_encuesta), $bloque_archivos);
        $bloque_archivos = str_replace("{ID_MEDICION}", utf8_encode($listaMedicion->id_medicion), $bloque_archivos);
        $bloque_archivos = str_replace("{RUT}", utf8_encode($rut), $bloque_archivos);
        $bloque_archivos = str_replace("{RUT_COLABORADOR}", utf8_encode($listaMedicion->rut), $bloque_archivos);
        $bloque_archivos = ColocaPreguntasMedicionColaboradoresLibre($bloque_archivos, $id_empresa, $rut, $idm, $fecha,"");


        $estado          = ValidaEstadoMedicion($rut, $id_empresa, $listaMedicion->id_encuesta, $listaMedicion->id_medicion, $listaMedicion->rut);
        $bloque_archivos = str_replace("{ESTADO}", $estado, $bloque_archivos);

    //print_r($bloque_archivos);


    return ($bloque_archivos);
}

function lms_medicion_por_pregunta_lb_opcion($opcion, $rut,$rutcol, $idm, $fecha, $id_empresa)
{

        //echo "opcion $opcion $rut,$rutcol, $idm, $fecha, $id_empresa";
        //echo "<br>function lms_medicion_por_jefe_pregunta($rut, $rutcol, $idm, $fecha, $id_empresa)";
        $bloque_archivos = str_replace("{FOTO_PERSONA}", VerificaFotoPersonal($listaMedicion->rut), $bloque_archivos);
        $bloque_archivos = str_replace("{NOMBRE}", utf8_encode($listaMedicion->nombre), $bloque_archivos);
        $bloque_archivos = str_replace("{CARGO}", utf8_encode($listaMedicion->cargo), $bloque_archivos);
        $bloque_archivos = str_replace("{GERENCIA}", utf8_encode($listaMedicion->gerencia), $bloque_archivos);
        $cuenta_mediciones++;
        $bloque_archivos = str_replace("{ID_ENCUESTA}", utf8_encode($listaMedicion->id_encuesta), $bloque_archivos);
        $bloque_archivos = str_replace("{ID_MEDICION}", utf8_encode($listaMedicion->id_medicion), $bloque_archivos);
        $bloque_archivos = str_replace("{RUT}", utf8_encode($rut), $bloque_archivos);
        $bloque_archivos = str_replace("{RUT_COLABORADOR}", utf8_encode($listaMedicion->rut), $bloque_archivos);
        $bloque_archivos = ColocaPreguntasMedicionColaboradoresLibre($bloque_archivos, $id_empresa, $rut, $idm, $fecha, $opcion);


        $estado          = ValidaEstadoMedicion($rut, $id_empresa, $listaMedicion->id_encuesta, $listaMedicion->id_medicion, $listaMedicion->rut);
        $bloque_archivos = str_replace("{ESTADO}", $estado, $bloque_archivos);

    //print_r($bloque_archivos);


    return ($bloque_archivos);
}

function ColocaPreguntasMedicionColaboradoresReplace($PRINCIPAL, $id_empresa, $rut, $id_encuesta, $id_medicion, $rut_colaborador, $replace)
{
    $preguntas = PreguntasMedicion($id_empresa, $id_encuesta, $id_medicion, $rut, $rut_colaborador);
    //echo "<br><br> $id_encuesta, $id_medicion<br>";print_r($preguntas);

    //echo "<br>---$rut" .$id_encuesta ." ". $preg->id_pregunta;
    $row       = "";
    foreach ($preguntas as $preg) {
        if ($preg->respuesta) {
            $row .= file_get_contents("views/medicion/" . $id_empresa . "_preguntas_medicion_lectura.html");
        } else {
            $row .= file_get_contents("views/medicion/" . $id_empresa . "_preguntas_medicion.html");
        }


         if ($preg->tipo == "NIV1_7") {
                  $alternativas="";
                  //$alternativas= file_get_contents("views/medicion/" . $id_empresa . "_preguntas_niv1_7.html");
            if ($preg->respuesta) {

         $alternativas .= "<center> <input id='".$rut .$id_encuesta . $preg->id_pregunta."' name='".$rut .$id_encuesta . $preg->id_pregunta."' type='number'
            class='rating' max='7' data-step='1' data-stars='7' data-size='md' data-glyphicon='false'
            data-rating-class='fontawesome-icon' data-symbol='&#xe73b;'  value='".$preg->respuesta."'   ></center>";
            } else {


                 $alternativas .= "<center> <input id='".$rut .$id_encuesta . $preg->id_pregunta."' name='".$rut .$id_encuesta . $preg->id_pregunta."' type='number'
            class='rating' max='7' data-step='1' data-stars='7' data-size='md' data-glyphicon='false'
            data-rating-class='fontawesome-icon' data-symbol='&#xe73b;'  ></center>";
            }


         }

        if ($preg->tipo == "NIV1_10") {
            $alternativas = "<table width='100%'><tr>";
            for ($i = 1; $i <= 10; $i++) {
                if ($preg->respuesta == $i) {
                    $checked = " checked ";
                } else {
                    $checked = "  ";
                }
                $alternativas .= "<td width='10%'>
                        <center>
                            <input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "' value='" . $i . "' " . $checked . ">
                            <br>" . $i . "</center>
                            </td>";
            }
            $alternativas .= "</tr></table>";
        }
        //echo $preg->tipo;
        if ($preg->tipo == "SI_NO") {
            if ($preg->respuesta == "SI") {
                $checkedSI = " checked ";
            } else {
                $checkedSI = "  ";
            }
            if ($preg->respuesta == "NO") {
                $checkedNO = " checked ";
            } else {
                $checkedNO = "  ";
            }
            $alternativas = "<table width='100%' border=0><tr>";
            $alternativas .= "<td width='50%'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                    value='NO' " . $checkedNO . " required><br>
                    <span class='badge badge-danger'><span class='blanco'>NO</span></span></center><br></td>";
            $alternativas .= "<td width='50%'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                    value='SI' " . $checkedSI . " required><br>
                    <span class='badge badge-info'><span class='blanco'>SI</span></span></center><br></td>";
            $alternativas .= "</tr></table>";
        }
        if ($preg->tipo == "LIK_1_5") {
            if ($preg->respuesta == "1") {
                $checkedUno = " checked ";
            } else {
                $checkedUno = "  ";
            }
            if ($preg->respuesta == "2") {
                $checkedDos = " checked ";
            } else {
                $checkedDos = "  ";
            }
            if ($preg->respuesta == "3") {
                $checkedTres = " checked ";
            } else {
                $checkedTres = "  ";
            }
            if ($preg->respuesta == "4") {
                $checkedCuatro = " checked ";
            } else {
                $checkedCuatro = "  ";
            }
            if ($preg->respuesta == "5") {
                $checkedCinco = " checked ";
            } else {
                $checkedCinco = "  ";
            }
            $alternativas = "<table width='100%'><tr>";
            $alternativas .= "<td width='20%'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                    value='1' " . $checkedUno . " required><br><img src='img/med_sad.png' width='32px'><br>
                    <span class='badge badge-danger'><span class='blanco'>Totalmente en Desacuerdo</span></span></center><br></td>";
            $alternativas .= "<td width='20%'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                    value='2' " . $checkedDos . " required><br><img src='img/med_sad.png' width='32px'><br>
                    <span class='badge badge-danger'><span class='blanco'>En Desacuerdo</span></span></center><br></td>";
            $alternativas .= "<td width='20%'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                    value='3' " . $checkedTres . " required><br><img src='img/med_confused.png' width='32px'>  <br>
                    <span class='badge badge-info'><span class='blanco'>Ni de Acuerdo ni en Desacuerdo</span></span></center><br></td>";
            $alternativas .= "<td width='20%'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                    value='4' " . $checkedCuatro . " required><br><img src='img/med_happy.png' width='32px'> <br>
                    <span class='badge badge-info'><span class='blanco'>De Acuerdo</span></span></center><br></td>";
            $alternativas .= "<td width='20%'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                    value='5' " . $checkedCinco . " required><br><img src='img/med_happy.png' width='32px'> <br>
                    <span class='badge badge-success'><span class='blanco'>Totalmente  de Acuerdo</span></span></center><br></td>";
            $alternativas .= "</tr></table>";
        }



    if ($preg->tipo == "LIK1_4") {

    echo "hola";

        if ($preg->respuesta == "1") {
                $checkedUno = " checked ";
            } else {
                $checkedUno = "  ";
            }
            if ($preg->respuesta == "2") {
                $checkedDos = " checked ";
            } else {
                $checkedDos = "  ";
            }
            if ($preg->respuesta == "3") {
                $checkedTres = " checked ";
            } else {
                $checkedTres = "  ";
            }
            if ($preg->respuesta == "4") {
                $checkedCuatro = " checked ";
            } else {
                $checkedCuatro = "  ";
            }
            if ($preg->respuesta == "5") {
                $checkedCinco = " checked ";
            } else {
                $checkedCinco = "  ";
            }
            $alternativas = "<table width='100%'><tr>";
            $alternativas .= "<td width='20%'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                    value='1' " . $checkedUno . " required><br><img src='img/med_sad.png' width='32px'><br>
                    <span class='badge badge-danger'><span class='blanco'>Muy en desacuerdo</span></span></center><br><br></td>";
            $alternativas .= "<td width='20%'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                    value='2' " . $checkedDos . " required><br><img src='img/med_sad.png' width='32px'><br>
                    <span class='badge badge-danger'><span class='blanco'>Desacuerdo</span></span></center><br><br></td>";
            $alternativas .= "<td width='20%'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                    value='3' " . $checkedTres . " required><br><img src='img/med_happy.png' width='32px'>  <br>
                    <span class='badge badge-info'><span class='blanco'>De acuerdo</span></span></center><br><br></td>";
            $alternativas .= "<td width='20%'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                    value='4' " . $checkedCuatro . " required><br><img src='img/med_happy.png' width='32px'> <br>
                    <span class='badge badge-info'><span class='blanco'>Muy de acuerdo</span></span></center><br><br></td>";

            $alternativas .= "</tr></table>";
        }







        $row = str_replace("{ID_PREGUNTA}", $preg->id_pregunta, $row);
        $row = str_replace("{PREGUNTA}", ($preg->pregunta), $row);
        $row = str_replace("{ALTERNATIVAS}", $alternativas, $row);
        $row = str_replace("{RUT}", $rut, $row);
        $row = str_replace("{RUT_COLABORADOR}", $rut_colaborador, $row);
        $row = str_replace("{ID_PREGUNTA}", $preg->id_pregunta, $row);
    }
    if ($replace <> '') {
        $PRINCIPAL = str_replace($replace, utf8_encode($row), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{ROW_PREGUNTAS}", utf8_encode($row), $PRINCIPAL);
    }
    return ($PRINCIPAL);
}


function ColocaPreguntasMedicionColaboradores($PRINCIPAL, $id_empresa, $rut, $rutcol, $idm, $fecha)
{
    //echo "<br>function ColocaPreguntasMedicionColaboradores  $id_empresa, $rut, $rutcol, $idm, $fecha";

    $id_encuesta_array=MedBuscaIdEncuestraMed($idm, $id_empresa);
    $id_medicion=$idm;
    //print_r($id_encuesta_array);
    //echo "<br><br>$id_medicion, $rutcol";

    $id_encuesta=$id_encuesta_array[0]->id_encuesta;

    $preguntas = PreguntasMedicionColaboradoresFecha($id_empresa, $id_encuesta_array[0]->id_encuesta, $id_medicion, $rut, $rutcol, $fecha);

    $rut_colaborador=$rutcol;
    //echo "<br><br>ColocaPreguntasMedicionColaboradores $id_empresa, ".$id_encuesta_array[0]->id_encuesta.", $id_medicion, $rut, $rutcol, $fecha";// echo "<br>";
    $row       = "";
    foreach ($preguntas as $preg) {

          //echo "<br> RUT COLABORADOR  $rut_colaborador ID ENCUESTA $id_encuesta ID PREGUNTA ".$preg->id_pregunta." ";

        if ($preg->respuesta) {
            $row .= file_get_contents("views/medicion/" . $id_empresa . "_preguntas_medicion.html");
        } else {
            $row .= file_get_contents("views/medicion/" . $id_empresa . "_preguntas_medicion.html");
        }
        //echo "views/medicion/" . $id_empresa . "_preguntas_medicion.html";

            //echo "<br>".$preg->tipo." ".$preg->id_pregunta."";

         if ($preg->tipo == "NIV1_7") {

         //echo "hola";
                  $alternativas="";
                  //$alternativas= file_get_contents("views/medicion/" . $id_empresa . "_preguntas_niv1_7.html");
            if ($preg->respuesta) {

         $alternativas .= "<center> <input id='".$rut .$id_encuesta . $preg->id_pregunta."' name='".$rut .$id_encuesta . $preg->id_pregunta."'
            type='number' class='rating' max='7' data-step='1' data-stars='7' data-size='md' data-glyphicon='false'
            data-rating-class='fontawesome-icon' data-symbol='&#xe73b;' value='".$preg->respuesta."'   ></center>";
            } else {


                 $alternativas .= "<center> <input id='".$rut .$id_encuesta . $preg->id_pregunta."' name='".$rut .$id_encuesta . $preg->id_pregunta."'
                 type='number' class='rating' max='7' data-step='1' data-stars='7' data-size='md' data-glyphicon='false'
            data-rating-class='fontawesome-icon' data-symbol='&#xe73b;'  ></center>";
            }


         }

        if ($preg->tipo == "NIV1_10") {
            $alternativas="";
                            $alternativas = "<table width='100%'><tr>";
                            for ($i = 1; $i <= 10; $i++) {
                                if ($preg->respuesta == $i) {
                                    $checked = " checked ";
                                } else {
                                    $checked = "  ";
                                }

                            //echo "<br> NIV1_10 RUT COLABORADOR  $rut_colaborador ID ENCUESTA $id_encuesta ID PREGUNTA ".$preg->id_pregunta." ";

                                $alternativas .= "<td width='10%'>
                                        <center>
                                            <input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "' value='" . $i . "' " . $checked . ">
                                            <br>" . $i . "</center>
                                            </td>";
                            }
                            $alternativas .= "</tr></table>";
        }


        if ($preg->tipo == "SI_NO") {     $alternativas="";
                                //echo "<br>SI NO";
                                    if ($preg->respuesta == "SI") {
                                        $checkedSI = " checked ";
                                    } else {
                                        $checkedSI = "  ";
                                    }
                                    if ($preg->respuesta == "NO") {
                                        $checkedNO = " checked ";
                                    } else {
                                        $checkedNO = "  ";
                                    }
                                    $alternativas = "<table width='100%' border=0><tr>";
                                    $alternativas .= "<td width='50%'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                                            value='NO' " . $checkedNO . " required><br>
                                            <span class='badge badge-danger'><span class='blanco'>NO</span></span></center><br></td>";
                                    $alternativas .= "<td width='50%'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                                            value='SI' " . $checkedSI . " required><br>
                                            <span class='badge badge-info'><span class='blanco'>SI</span></span></center><br></td>";
                                    $alternativas .= "</tr></table>";
        }

        //echo $preg->tipo;

        if ($preg->tipo == "LIK_1_5") {      $alternativas="";

                                //echo "<br>LI5 594";
                                if ($preg->respuesta == "1") {
                                    $checkedUno = " checked ";
                                } else {
                                    $checkedUno = "  ";
                                }
                                if ($preg->respuesta == "2") {
                                    $checkedDos = " checked ";
                                } else {
                                    $checkedDos = "  ";
                                }
                                if ($preg->respuesta == "3") {
                                    $checkedTres = " checked ";
                                } else {
                                    $checkedTres = "  ";
                                }
                                if ($preg->respuesta == "4") {
                                    $checkedCuatro = " checked ";
                                } else {
                                    $checkedCuatro = "  ";
                                }
                                if ($preg->respuesta == "5") {
                                    $checkedCinco = " checked ";
                                } else {
                                    $checkedCinco = "  ";
                                }

                                //echo "hola";

                                $alternativas = "<table width='100%'><tr>";
                                $alternativas .= "<td width='20%'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                                        value='1' " . $checkedUno . " required><br><img src='img/med_sad.png' width='32px'><br>
                                        <span class='badge badge-danger'><span class='blanco'>Totalmente en Desacuerdo</span></span></center><br></td>";
                                $alternativas .= "<td width='20%'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                                        value='2' " . $checkedDos . " required><br><img src='img/med_sad.png' width='32px'><br>
                                        <span class='badge badge-danger'><span class='blanco'>En Desacuerdo</span></span></center><br></td>";
                                $alternativas .= "<td width='20%'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                                        value='3' " . $checkedTres . " required><br><img src='img/med_confused.png' width='32px'>  <br>
                                        <span class='badge badge-info'><span class='blanco'>Ni de Acuerdo ni en Desacuerdo</span></span></center><br></td>";
                                $alternativas .= "<td width='20%'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                                        value='4' " . $checkedCuatro . " required><br><img src='img/med_happy.png' width='32px'> <br>
                                        <span class='badge badge-info'><span class='blanco'>De Acuerdo</span></span></center><br></td>";
                                $alternativas .= "<td width='20%'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                                        value='5' " . $checkedCinco . " required><br><img src='img/med_happy.png' width='32px'> <br>
                                        <span class='badge badge-success'><span class='blanco'>Totalmente  de Acuerdo</span></span></center><br></td>";
                                $alternativas .= "</tr></table>";

                                //echo "$alternativas";
        }


        if ($preg->tipo == "LIK1_4") {       $alternativas="";

                                //echo "<br>LI5 594";
                                if ($preg->respuesta == "1") {
                                    $checkedUno = " checked ";
                                } else {
                                    $checkedUno = "  ";
                                }
                                if ($preg->respuesta == "2") {
                                    $checkedDos = " checked ";
                                } else {
                                    $checkedDos = "  ";
                                }
                                if ($preg->respuesta == "3") {
                                    $checkedTres = " checked ";
                                } else {
                                    $checkedTres = "  ";
                                }
                                if ($preg->respuesta == "4") {
                                    $checkedCuatro = " checked ";
                                } else {
                                    $checkedCuatro = "  ";
                                }
                                if ($preg->respuesta == "5") {
                                    $checkedCinco = " checked ";
                                } else {
                                    $checkedCinco = "  ";
                                }

                                //echo "hola";

                                $alternativas = "<table width='100%'><tr>";
                                $alternativas .= "<td width='20%'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                                        value='1' " . $checkedUno . " required><br><img src='img/med_sad.png' width='32px'><br>
                                        <span class='badge badge-danger'><span class='blanco'>Muy en desacuerdo</span></span></center><br></td>";
                                $alternativas .= "<td width='20%'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                                        value='2' " . $checkedDos . " required><br><img src='img/med_confused.png' width='32px'><br>
                                        <span class='badge badge-warning'><span class='blanco'>Desacuerdo</span></span></center><br></td>";
                                $alternativas .= "<td width='20%'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                                        value='3' " . $checkedTres . " required><br><img src='img/med_happy.png' width='32px'>  <br>
                                        <span class='badge badge-info'><span class='blanco'>De acuerdo</span></span></center><br></td>";
                                $alternativas .= "<td width='20%'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                                        value='4' " . $checkedCuatro . " required><br><img src='img/med_happy.png' width='32px'> <br>
                                        <span class='badge badge-success'><span class='blanco'>Muy de acuerdo</span></span></center><br></td>";

                                $alternativas .= "</tr></table>";

                                //echo "$alternativas";
        }


        //echo "<br>row ".$row;
              // echo "<br><br>";echo "$alternativas";

        $row = str_replace("{PREGUNTA}", utf8_encode($preg->pregunta), $row);
        $row = str_replace("{ALTERNATIVAS}", $alternativas, $row);
        $row = str_replace("{RUT}", $rut, $row);
        $row = str_replace("{RUT_COLABORADOR}", $rut_colaborador, $row);
        $row = str_replace("{ID_PREGUNTA}", $preg->id_pregunta, $row);
    }

        $PRINCIPAL = str_replace("{ROW_PREGUNTAS}", utf8_encode($row), $PRINCIPAL);


    $row_datatable       = "";
    foreach ($preguntas as $preg) {

            //echo "<pre>";        print_r($preg);
        if ($preg->respuesta) {
            $row_datatable .= file_get_contents("views/medicion/" . $id_empresa . "_preguntas_medicion_datatables.html");
        } else {
           $row_datatable .= file_get_contents("views/medicion/" . $id_empresa . "_preguntas_medicion_datatables.html");
        }


        if ($preg->tipo == "NIV1_7") {

         //echo "hola";
                  $alternativas="";
                  //$alternativas= file_get_contents("views/medicion/" . $id_empresa . "_preguntas_niv1_7.html");
            if ($preg->respuesta) {

         $alternativas .= "<center> <input id='".$rut .$id_encuesta . $preg->id_pregunta."' name='".$rut .$id_encuesta . $preg->id_pregunta."'
            type='number' class='rating' max='7' data-step='1' data-stars='7' data-size='md' data-glyphicon='false'
            data-rating-class='fontawesome-icon' data-symbol='&#xe73b;' value='".$preg->respuesta."'   ></center>";
            } else {


                 $alternativas .= "<center> <input id='".$rut .$id_encuesta . $preg->id_pregunta."' name='".$rut .$id_encuesta . $preg->id_pregunta."'
                 type='number' class='rating' max='7' data-step='1' data-stars='7' data-size='md' data-glyphicon='false'
            data-rating-class='fontawesome-icon' data-symbol='&#xe73b;'  ></center>";
            }


         }

        if ($preg->tipo == "NIV1_10") {
            $alternativas="";
                            $alternativas = "<table width='100%'><tr>";
                            for ($i = 1; $i <= 10; $i++) {
                                if ($preg->respuesta == $i) {
                                    $checked = " checked ";
                                } else {
                                    $checked = "  ";
                                }

                        //echo "<br> NIV1_10 RUT COLABORADOR  $rut_colaborador ID ENCUESTA $id_encuesta ID PREGUNTA ".$preg->id_pregunta." ";

                                $alternativas .= "<td width='10%'>
                                        <center>
                                            <input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "' value='" . $i . "' " . $checked . " required>
                                            <br>" . $i . "</center>
                                            </td>";
                            }
                            $alternativas .= "</tr></table>";
        }


        if ($preg->tipo == "SI_NO") {     $alternativas="";
                                //echo "<br>SI NO";
                                    if ($preg->respuesta == "SI") {
                                        $checkedSI = " checked ";
                                    } else {
                                        $checkedSI = "  ";
                                    }
                                    if ($preg->respuesta == "NO") {
                                        $checkedNO = " checked ";
                                    } else {
                                        $checkedNO = "  ";
                                    }
                                    $alternativas = "<table width='100%' border=0><tr>";
                                    $alternativas .= "<td width='50%'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                                            value='NO' " . $checkedNO . " required><br>
                                            <span class='badge badge-danger'><span class='blanco'>NO</span></span></center><br></td>";
                                    $alternativas .= "<td width='50%'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                                            value='SI' " . $checkedSI . " required><br>
                                            <span class='badge badge-info'><span class='blanco'>SI</span></span></center><br></td>";
                                    $alternativas .= "</tr></table>";
        }

        //echo $preg->tipo;

        if ($preg->tipo == "LIK_1_5") {      $alternativas="";

                                //echo "<br>LI5 594";
                                if ($preg->respuesta == "1") {
                                    $checkedUno = " checked ";
                                } else {
                                    $checkedUno = "  ";
                                }
                                if ($preg->respuesta == "2") {
                                    $checkedDos = " checked ";
                                } else {
                                    $checkedDos = "  ";
                                }
                                if ($preg->respuesta == "3") {
                                    $checkedTres = " checked ";
                                } else {
                                    $checkedTres = "  ";
                                }
                                if ($preg->respuesta == "4") {
                                    $checkedCuatro = " checked ";
                                } else {
                                    $checkedCuatro = "  ";
                                }
                                if ($preg->respuesta == "5") {
                                    $checkedCinco = " checked ";
                                } else {
                                    $checkedCinco = "  ";
                                }

                                //echo "hola";

                                $alternativas = "<table width='100%'><tr>";
                                $alternativas .= "<td width='20%'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                                        value='1' " . $checkedUno . " required><br><img src='img/med_sad.png' width='32px'><br>
                                        <span class='badge badge-danger'><span class='blanco'>Totalmente en Desacuerdo</span></span></center><br></td>";
                                $alternativas .= "<td width='20%'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                                        value='2' " . $checkedDos . " required><br><img src='img/med_sad.png' width='32px'><br>
                                        <span class='badge badge-danger'><span class='blanco'>En Desacuerdo</span></span></center><br></td>";
                                $alternativas .= "<td width='20%'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                                        value='3' " . $checkedTres . " required><br><img src='img/med_confused.png' width='32px'>  <br>
                                        <span class='badge badge-info'><span class='blanco'>Ni de Acuerdo ni en Desacuerdo</span></span></center><br></td>";
                                $alternativas .= "<td width='20%'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                                        value='4' " . $checkedCuatro . " required><br><img src='img/med_happy.png' width='32px'> <br>
                                        <span class='badge badge-info'><span class='blanco'>De Acuerdo</span></span></center><br></td>";
                                $alternativas .= "<td width='20%'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                                        value='5' " . $checkedCinco . " required><br><img src='img/med_happy.png' width='32px'> <br>
                                        <span class='badge badge-success'><span class='blanco'>Totalmente  de Acuerdo</span></span></center><br></td>";
                                $alternativas .= "</tr></table>";

                                //echo "$alternativas";
        }

        if ($preg->tipo == "LIK1_4") {

                                if ($preg->respuesta == "1") {$checkedUno = " checked ";
                                } else {$checkedUno = "  ";    }
                                if ($preg->respuesta == "2") {$checkedDos = " checked ";
                                } else {$checkedDos = "  ";    }
                                if ($preg->respuesta == "3") {$checkedTres = " checked ";
                                } else {$checkedTres = "  ";}
                                if ($preg->respuesta == "4") {$checkedCuatro = " checked ";
                                } else {$checkedCuatro = "  ";}
                                if ($preg->respuesta == "5") {$checkedCinco = " checked ";
                                } else {$checkedCinco = "  ";}

                                $alternativas = "";
                                $alternativas .= "<div class='col-xs-3'><center>
                                <input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                                        value='1' " . $checkedUno . " required><br><img src='img/med_sad.png' width='32px'><br>
                                        <span class='badge badge-danger'><span class='blanco'>Muy en desacuerdo</span></span></center></div>";

                                $alternativas .= "<div class='col-xs-3'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                                        value='2' " . $checkedDos . " required><br><img src='img/med_confused.png' width='32px'><br>
                                        <span class='badge badge-warning'><span class='blanco'>Desacuerdo</span></span></center></div>";

                                $alternativas .= "<div class='col-xs-3'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                                        value='3' " . $checkedTres . " required><br><img src='img/med_happy.png' width='32px'><br>
                                        <span class='badge badge-info'><span class='blanco'>De acuerdo</span></span></center></div>";

                                $alternativas .= "<div class='col-xs-3'><center><input type='radio' name='" . $rut_colaborador . $id_encuesta . $preg->id_pregunta . "'
                                        value='4' " . $checkedCuatro . " required><br><img src='img/med_happy.png' width='32px'> <br>
                                        <span class='badge badge-success'><span class='blanco'>Muy de acuerdo</span></span></center></div>";
                                $alternativas .= "";

        }

        $row_datatable = str_replace("{PREGUNTA}", utf8_encode($preg->pregunta), $row_datatable);
        $row_datatable = str_replace("{ALTERNATIVAS}", $alternativas, $row_datatable);
        $row_datatable = str_replace("{RUT}", $rut, $row_datatable);
        $row_datatable = str_replace("{RUT_COLABORADOR}", $rut_colaborador, $row_datatable);
        $row_datatable = str_replace("{ID_PREGUNTA}", $preg->id_pregunta, $row_datatable);
    }

         $PRINCIPAL = str_replace("{ROW_PREGUNTAS_DATATABLE}", utf8_encode($row_datatable), $PRINCIPAL);

        //print_r($row_datatable);

    return ($row_datatable);
}

function ColocaPreguntasMedicionColaboradoresLibre($PRINCIPAL, $id_empresa, $rut, $idm, $fecha, $opcion)
{
   // echo "<br>function ColocaPreguntasMedicionColaboradores  $id_empresa, $rut, $idm, $fecha, opcion $opcion";

    $id_encuesta_array=MedBuscaIdEncuestraMed($idm, $id_empresa);
    $id_medicion=$idm;
    //print_r($id_encuesta_array);

    $id_encuesta=$id_encuesta_array[0]->id_encuesta;

        //echo "<br><br>$id_medicion, $rutcol";
        //echo "<br><br>id_medicion $id_medicion,nrut $rut, id_encuesta $id_encuesta";
    if($opcion<>''){
    $preguntas = PreguntasMedicionColaboradoresLibreOpcion($id_empresa, $id_encuesta_array[0]->id_encuesta, $id_medicion, $rut, $opcion);

    }   else {
    $preguntas = PreguntasMedicionColaboradoresLibre($id_empresa, $id_encuesta_array[0]->id_encuesta, $id_medicion, $rut);
    }
    //print_r($preguntas);

    //echo "<br><br>ColocaPreguntasMedicionColaboradores $id_empresa, ".$id_encuesta_array[0]->id_encuesta.", $id_medicion, $rut, $rutcol, $fecha";// echo "<br>";
    $row       = "";
    foreach ($preguntas as $preg) {

          //echo "<br> RUT COLABORADOR  $rut_colaborador ID ENCUESTA $id_encuesta ID PREGUNTA ".$preg->id_pregunta." ";



        if ($preg->respuesta) {
            $row .= file_get_contents("views/medicion/" . $id_empresa . "_preguntas_medicion.html");
        } else {
            $row .= file_get_contents("views/medicion/" . $id_empresa . "_preguntas_medicion.html");
        }
        //echo "views/medicion/" . $id_empresa . "_preguntas_medicion.html";

         //echo "<br>".$preg->tipo."<br>".$preg->id_pregunta."";
         //echo "<BR>".$preg->id_pregunta." hola preg tipo ".$preg->tipo;
         if ($preg->tipo == "TEXT") {    //echo "-> hola txt";
                         $alternativas="";
                  //$alternativas= file_get_contents("views/medicion/" . $id_empresa . "_preguntas_niv1_7.html");
            if ($preg->respuesta) {

$alternativas .= "<center> <input id='".$id_encuesta . $preg->id_pregunta."' name='".$id_encuesta . $preg->id_pregunta."' value='".utf8_encode($preg->respuesta)."' type='text' class='form form-control' required  ></center>";

            } else {


$alternativas .= "<center> <input id='".$id_encuesta . $preg->id_pregunta."' name='".$id_encuesta . $preg->id_pregunta."' type='text'  class='form form-control' required ></center>";
            }

         }

         if ($preg->tipo == "TEXT2") {    //echo "-> hola txt";
                         $alternativas="";
                  //$alternativas= file_get_contents("views/medicion/" . $id_empresa . "_preguntas_niv1_7.html");
            if ($preg->respuesta) {

$alternativas .= "<center> <input id='".$id_encuesta . $preg->id_pregunta."' name='".$id_encuesta . $preg->id_pregunta."' value='".utf8_encode($preg->respuesta)."' type='text' class='form form-control' required  ></center>";

            } else {


$alternativas .= "<center> <input id='".$id_encuesta . $preg->id_pregunta."' name='".$id_encuesta . $preg->id_pregunta."' type='text'  class='form form-control' required ></center>";
            }

         }

        if ($preg->tipo == "NUMBER") {    //echo "-> hola txt";
                         $alternativas="";
                  //$alternativas= file_get_contents("views/medicion/" . $id_empresa . "_preguntas_niv1_7.html");
            if ($preg->respuesta) {

$alternativas .= "<center> <input id='".$id_encuesta . $preg->id_pregunta."' name='".$id_encuesta . $preg->id_pregunta."' value='".utf8_encode($preg->respuesta)."' type='number' class='form form-control' required  ></center>";

            } else {


$alternativas .= "<center> <input id='".$id_encuesta . $preg->id_pregunta."' name='".$id_encuesta . $preg->id_pregunta."' type='number'  class='form form-control' required ></center>";
            }

         }

         if ($preg->tipo == "TEXTAREA") {    //echo "-> hola txt";
                         $alternativas="";
                  //$alternativas= file_get_contents("views/medicion/" . $id_empresa . "_preguntas_niv1_7.html");
            if ($preg->respuesta) {

$alternativas .= "<center> <textarea id='".$id_encuesta . $preg->id_pregunta."' rows='4' name='".$id_encuesta . $preg->id_pregunta."'  class='form form-control' required  >".utf8_encode($preg->respuesta)."</textarea></center>";

            } else {


$alternativas .= "<center> <textarea id='".$id_encuesta . $preg->id_pregunta."' rows='4' name='".$id_encuesta . $preg->id_pregunta."'  class='form form-control' required  ></textarea></center>";
            }

         }

         if ($preg->tipo == "SELMUL") {   //echo "-> hola SELMUL";
                         $alternativas=""; $option="";
                  //$alternativas= file_get_contents("views/medicion/" . $id_empresa . "_preguntas_niv1_7.html");
            if ($preg->respuesta) {

     $option.="<option value=''></option> ";
if($preg->alt1<>'')   {if($preg->alt1==$preg->respuesta){$check1=" selected ";} $option.="<option value='".utf8_encode($preg->alt1)."' $check1>".utf8_encode($preg->alt1)."</option> ";}
if($preg->alt2<>'')   {if($preg->alt2==$preg->respuesta){$check2=" selected ";} $option.="<option value='".utf8_encode($preg->alt2)."' $check2>".utf8_encode($preg->alt2)."</option> ";}
if($preg->alt3<>'')   {if($preg->alt3==$preg->respuesta){$check3=" selected ";} $option.="<option value='".utf8_encode($preg->alt3)."' $check3>".utf8_encode($preg->alt3)."</option> ";}
if($preg->alt4<>'')   {if($preg->alt4==$preg->respuesta){$check4=" selected ";} $option.="<option value='".utf8_encode($preg->alt4)."' $check4>".utf8_encode($preg->alt4)."</option> ";}
if($preg->alt5<>'')   {if($preg->alt5==$preg->respuesta){$check5=" selected ";} $option.="<option value='".utf8_encode($preg->alt5)."' $check5>".utf8_encode($preg->alt5)."</option> ";}
if($preg->alt6<>'')   {if($preg->alt6==$preg->respuesta){$check6=" selected ";} $option.="<option value='".utf8_encode($preg->alt6)."' $check6>".utf8_encode($preg->alt6)."</option> ";}
if($preg->alt7<>'')   {if($preg->alt7==$preg->respuesta){$check7=" selected ";} $option.="<option value='".utf8_encode($preg->alt7)."' $check7>".utf8_encode($preg->alt7)."</option> ";}
if($preg->alt8<>'')   {if($preg->alt8==$preg->respuesta){$check8=" selected ";} $option.="<option value='".utf8_encode($preg->alt8)."' $check8>".utf8_encode($preg->alt8)."</option> ";}
if($preg->alt9<>'')   {if($preg->alt9==$preg->respuesta){$check9=" selected ";} $option.="<option value='".utf8_encode($preg->alt9)."' $check9>".utf8_encode($preg->alt9)."</option> ";}
if($preg->alt10<>'')  {if($preg->alt10==$preg->respuesta){$check10=" selected ";} $option.="<option value='".utf8_encode($preg->alt10)."' $check10>".utf8_encode($preg->alt10)."</option> ";}
if($preg->alt11<>'')   {if($preg->alt11==$preg->respuesta){$check11=" selected ";} $option.="<option value='".utf8_encode($preg->alt11)."' $check11>".utf8_encode($preg->alt11)."</option> ";}
if($preg->alt12<>'')   {if($preg->alt12==$preg->respuesta){$check12=" selected ";} $option.="<option value='".utf8_encode($preg->alt12)."' $check12>".utf8_encode($preg->alt12)."</option> ";}
if($preg->alt13<>'')   {if($preg->alt13==$preg->respuesta){$check13=" selected ";} $option.="<option value='".utf8_encode($preg->alt13)."' $check13>".utf8_encode($preg->alt13)."</option> ";}
if($preg->alt14<>'')   {if($preg->alt14==$preg->respuesta){$check14=" selected ";} $option.="<option value='".utf8_encode($preg->alt14)."' $check14>".utf8_encode($preg->alt14)."</option> ";}
if($preg->alt15<>'')   {if($preg->alt15==$preg->respuesta){$check15=" selected ";} $option.="<option value='".utf8_encode($preg->alt15)."' $check15>".utf8_encode($preg->alt15)."</option> ";}
if($preg->alt16<>'')   {if($preg->alt16==$preg->respuesta){$check16=" selected ";} $option.="<option value='".utf8_encode($preg->alt16)."' $check16>".utf8_encode($preg->alt16)."</option> ";}
if($preg->alt17<>'')   {if($preg->alt17==$preg->respuesta){$check17=" selected ";} $option.="<option value='".utf8_encode($preg->alt17)."' $check17>".utf8_encode($preg->alt17)."</option> ";}
if($preg->alt18<>'')   {if($preg->alt18==$preg->respuesta){$check18=" selected ";} $option.="<option value='".utf8_encode($preg->alt18)."' $check18>".utf8_encode($preg->alt18)."</option> ";}
if($preg->alt19<>'')   {if($preg->alt19==$preg->respuesta){$check19=" selected ";} $option.="<option value='".utf8_encode($preg->alt19)."' $check19>".utf8_encode($preg->alt19)."</option> ";}

$alternativas .= "<center>


 <select id='".$id_encuesta . $preg->id_pregunta."' name='".$id_encuesta . $preg->id_pregunta."' class='form form-control' required>
    ".$option."
</select>  </center>";



            } else {

    //echo  "<br>preg selmul ".$preg->alt1;
    $option.="<option value=''></option> ";
if($preg->alt1<>'')   {$option.="<option value='".utf8_encode($preg->alt1)."'>".utf8_encode($preg->alt1)."</option> ";}
if($preg->alt2<>'')   {$option.="<option value='".utf8_encode($preg->alt2)."'>".utf8_encode($preg->alt2)."</option> ";}
if($preg->alt3<>'')   {$option.="<option value='".utf8_encode($preg->alt3)."'>".utf8_encode($preg->alt3)."</option> ";}
if($preg->alt4<>'')   {$option.="<option value='".utf8_encode($preg->alt4)."'>".utf8_encode($preg->alt4)."</option> ";}
if($preg->alt5<>'')   {$option.="<option value='".utf8_encode($preg->alt5)."'>".utf8_encode($preg->alt5)."</option> ";}
if($preg->alt6<>'')   {$option.="<option value='".utf8_encode($preg->alt6)."'>".utf8_encode($preg->alt6)."</option> ";}
if($preg->alt7<>'')   {$option.="<option value='".utf8_encode($preg->alt7)."'>".utf8_encode($preg->alt7)."</option> ";}
if($preg->alt8<>'')   {$option.="<option value='".utf8_encode($preg->alt8)."'>".utf8_encode($preg->alt8)."</option> ";}
if($preg->alt9<>'')   {$option.="<option value='".utf8_encode($preg->alt9)."'>".utf8_encode($preg->alt9)."</option> ";}
if($preg->alt10<>'')   {$option.="<option value='".utf8_encode($preg->alt10)."'>".utf8_encode($preg->alt10)."</option> ";}
if($preg->alt11<>'')   {$option.="<option value='".utf8_encode($preg->alt11)."'>".utf8_encode($preg->alt11)."</option> ";}
if($preg->alt12<>'')   {$option.="<option value='".utf8_encode($preg->alt12)."'>".utf8_encode($preg->alt12)."</option> ";}
if($preg->alt13<>'')   {$option.="<option value='".utf8_encode($preg->alt13)."'>".utf8_encode($preg->alt13)."</option> ";}
if($preg->alt14<>'')   {$option.="<option value='".utf8_encode($preg->alt14)."'>".utf8_encode($preg->alt14)."</option> ";}
if($preg->alt15<>'')   {$option.="<option value='".utf8_encode($preg->alt15)."'>".utf8_encode($preg->alt15)."</option> ";}
if($preg->alt16<>'')   {$option.="<option value='".utf8_encode($preg->alt16)."'>".utf8_encode($preg->alt16)."</option> ";}
if($preg->alt17<>'')   {$option.="<option value='".utf8_encode($preg->alt17)."'>".utf8_encode($preg->alt17)."</option> ";}
if($preg->alt18<>'')   {$option.="<option value='".utf8_encode($preg->alt18)."'>".utf8_encode($preg->alt18)."</option> ";}
if($preg->alt19<>'')   {$option.="<option value='".utf8_encode($preg->alt19)."'>".utf8_encode($preg->alt19)."</option> ";}



$alternativas .= "<center>


 <select  id='".$id_encuesta . $preg->id_pregunta."' name='".$id_encuesta . $preg->id_pregunta."' class='form form-control' required>
   ".$option."
</select>  </center>";            }

         }

 if ($preg->tipo == "CHECKBOX") {   //echo "-> hola SELMUL";
    $alternativas=""; $option=""; $checkbox="";

$check1=0;
$check2=0;
$check3=0;
$check4=0;
$check5=0;
$check6=0;
$check7=0;
$check8=0;
$check9=0;
$check10=0;
$check11=0;
$check12=0;
$check13=0;
$check14=0;
$check15=0;
$check16=0;
$check17=0;
$check18=0;                  //$alternativas= file_get_contents("views/medicion/" . $id_empresa . "_preguntas_niv1_7.html");
            if ($preg->respuesta) {
  //echo "<br>preg alt1 ".$preg->alt1."==".$preg->respuesta;
    // $option.="<option value=''></option> ";
if($preg->alt1<>'')   {if(strstr($preg->respuesta, "Op1")) {$check1=" checked='checked' ";}     $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt1)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_1' value='1'   $check1>   <span class='checkmark'></span></label> ";}
if($preg->alt2<>'')   {if(strstr($preg->respuesta, "Op2")) {$check2=" checked='checked' ";}     $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt2)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_2' value='1'   $check1>   <span class='checkmark'></span></label> ";}
if($preg->alt3<>'')   {if(strstr($preg->respuesta, "Op3")) {$check3=" checked='checked' ";}     $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt3)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_3' value='1'   $check3>  <span class='checkmark'></span></label> ";}
if($preg->alt4<>'')   {if(strstr($preg->respuesta, "Op4")) {$check4=" checked='checked' ";}     $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt4)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_4' value='1'   $check4>  <span class='checkmark'></span></label> ";}
if($preg->alt5<>'')   {if(strstr($preg->respuesta, "Op5")) {$check5=" checked='checked' ";}     $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt5)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_5' value='1'   $check5>  <span class='checkmark'></span></label> ";}
if($preg->alt6<>'')   {if(strstr($preg->respuesta, "Op6")) {$check6=" checked='checked' ";}     $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt6)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_6' value='1'   $check6>  <span class='checkmark'></span></label> ";}
if($preg->alt7<>'')   {if(strstr($preg->respuesta, "Op7")) {$check7=" checked='checked' ";}     $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt7)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_7' value='1'   $check7>  <span class='checkmark'></span></label> ";}
if($preg->alt8<>'')   {if(strstr($preg->respuesta, "Op8")) {$check8=" checked='checked' ";}     $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt8)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_8' value='1'   $check8>  <span class='checkmark'></span></label> ";}
if($preg->alt9<>'')   {if(strstr($preg->respuesta, "Op9")) {$check9=" checked='checked' ";}     $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt9)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_9' value='1'   $check9>  <span class='checkmark'></span></label> ";}
if($preg->alt10<>'')  {if(strstr($preg->respuesta, "Op10")) {$check10=" checked='checked' ";}  $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt10)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_10' value='1'   $check10> <span class='checkmark'></span></label> ";}
if($preg->alt11<>'')   {if(strstr($preg->respuesta, "Op11")) {$check11=" checked='checked' ";} $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt11)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_11' value='1'   $check11> <span class='checkmark'></span></label> ";}
if($preg->alt12<>'')   {if(strstr($preg->respuesta, "Op12")) {$check12=" checked='checked' ";} $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt12)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_12' value='1'   $check12> <span class='checkmark'></span></label> ";}
if($preg->alt13<>'')   {if(strstr($preg->respuesta, "Op13")) {$check13=" checked='checked' ";} $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt13)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_13' value='1'   $check13> <span class='checkmark'></span></label> ";}
if($preg->alt14<>'')   {if(strstr($preg->respuesta, "Op14")) {$check14=" checked='checked' ";} $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt14)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_14' value='1'   $check14> <span class='checkmark'></span></label> ";}
if($preg->alt15<>'')   {if(strstr($preg->respuesta, "Op15")) {$check15=" checked='checked' ";} $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt15)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_15' value='1'   $check15> <span class='checkmark'></span></label> ";}
if($preg->alt16<>'')   {if(strstr($preg->respuesta, "Op16")) {$check16=" checked='checked' ";} $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt16)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_16' value='1   $check16> <span class='checkmark'></span></label> ";}
if($preg->alt17<>'')   {if(strstr($preg->respuesta, "Op17")) {$check17=" checked='checked' ";} $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt17)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_17' value='1'   $check17> <span class='checkmark'></span></label> ";}
if($preg->alt18<>'')   {if(strstr($preg->respuesta, "Op18")) {$check18=" checked='checked' ";} $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt18)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_18' value='1'   $check18> <span class='checkmark'></span></label> ";}
if($preg->alt19<>'')   {if(strstr($preg->respuesta, "Op19")) {$check19=" checked='checked' ";} $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt19)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_19' value='1'   $check19> <span class='checkmark'></span></label> ";}
 $preg->respuesta ="";
$alternativas .= " ".$checkbox." <br>";

            } else {

if($preg->alt1<>'')   {if($preg->alt1==$preg->respuesta){$check1=" selected ";}$checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt1)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_1' value='1'   $check1>   <span class='checkmark'></span></label> ";}
if($preg->alt2<>'')   {if($preg->alt2==$preg->respuesta){$check2=" selected ";} $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt2)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_2' value='1'   $check2>  <span class='checkmark'></span></label> ";}
if($preg->alt3<>'')   {if($preg->alt3==$preg->respuesta){$check3=" selected ";} $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt3)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_3' value='1'   $check3>  <span class='checkmark'></span></label> ";}
if($preg->alt4<>'')   {if($preg->alt4==$preg->respuesta){$check4=" selected ";} $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt4)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_4' value='1'   $check4>  <span class='checkmark'></span></label> ";}
if($preg->alt5<>'')   {if($preg->alt5==$preg->respuesta){$check5=" selected ";} $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt5)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_5' value='1'   $check5>  <span class='checkmark'></span></label> ";}
if($preg->alt6<>'')   {if($preg->alt6==$preg->respuesta){$check6=" selected ";} $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt6)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_6' value='1'   $check6>  <span class='checkmark'></span></label> ";}
if($preg->alt7<>'')   {if($preg->alt7==$preg->respuesta){$check7=" selected ";} $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt7)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_7' value='1'   $check7>  <span class='checkmark'></span></label> ";}
if($preg->alt8<>'')   {if($preg->alt8==$preg->respuesta){$check8=" selected ";} $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt8)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_8' value='1'   $check8>  <span class='checkmark'></span></label> ";}
if($preg->alt9<>'')   {if($preg->alt9==$preg->respuesta){$check9=" selected ";} $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt9)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_9' value='1'   $check9>  <span class='checkmark'></span></label> ";}
if($preg->alt10<>'')  {if($preg->alt10==$preg->respuesta){$check10=" selected ";}  $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt10)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_10' value='1'   $check10> <span class='checkmark'></span></label> ";}
if($preg->alt11<>'')   {if($preg->alt11==$preg->respuesta){$check11=" selected ";} $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt11)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_11' value='1'   $check11> <span class='checkmark'></span></label> ";}
if($preg->alt12<>'')   {if($preg->alt12==$preg->respuesta){$check12=" selected ";} $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt12)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_12' value='1'   $check12> <span class='checkmark'></span></label> ";}
if($preg->alt13<>'')   {if($preg->alt13==$preg->respuesta){$check13=" selected ";} $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt13)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_13' value='1'   $check13> <span class='checkmark'></span></label> ";}
if($preg->alt14<>'')   {if($preg->alt14==$preg->respuesta){$check14=" selected ";} $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt14)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_14' value='1'   $check14> <span class='checkmark'></span></label> ";}
if($preg->alt15<>'')   {if($preg->alt15==$preg->respuesta){$check15=" selected ";} $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt15)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_15' value='1'   $check15> <span class='checkmark'></span></label> ";}
if($preg->alt16<>'')   {if($preg->alt16==$preg->respuesta){$check16=" selected ";} $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt16)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_16' value='1'   $check16> <span class='checkmark'></span></label> ";}
if($preg->alt17<>'')   {if($preg->alt17==$preg->respuesta){$check17=" selected ";} $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt17)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_17' value='1'   $check17> <span class='checkmark'></span></label> ";}
if($preg->alt18<>'')   {if($preg->alt18==$preg->respuesta){$check18=" selected ";} $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt18)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_18' value='1'   $check18> <span class='checkmark'></span></label> ";}
if($preg->alt19<>'')   {if($preg->alt19==$preg->respuesta){$check19=" selected ";} $checkbox.="<br> <label class='customcheck'>".utf8_encode($preg->alt19)." <input type='checkbox'  name='".$id_encuesta . $preg->id_pregunta."_19' value='1'   $check19> <span class='checkmark'></span></label> ";}

  $preg->respuesta="";


$alternativas .= "".$checkbox." <br>";


         }
    }

       if ($preg->tipo == "SELMUL+OTRA") {   //echo "-> hola SELMUL";
                         $alternativas=""; $option="";
                  //$alternativas= file_get_contents("views/medicion/" . $id_empresa . "_preguntas_niv1_7.html");
            if ($preg->respuesta) {

     $option.="<option value=''></option> ";
if($preg->alt1<>'')   {if($preg->alt1==$preg->respuesta){$check1=" selected ";} $option.="<option value='".utf8_encode($preg->alt1)."' $check1>".utf8_encode($preg->alt1)."</option> ";}
if($preg->alt2<>'')   {if($preg->alt2==$preg->respuesta){$check2=" selected ";} $option.="<option value='".utf8_encode($preg->alt2)."' $check2>".utf8_encode($preg->alt2)."</option> ";}
if($preg->alt3<>'')   {if($preg->alt3==$preg->respuesta){$check3=" selected ";} $option.="<option value='".utf8_encode($preg->alt3)."' $check3>".utf8_encode($preg->alt3)."</option> ";}
if($preg->alt4<>'')   {if($preg->alt4==$preg->respuesta){$check4=" selected ";} $option.="<option value='".utf8_encode($preg->alt4)."' $check4>".utf8_encode($preg->alt4)."</option> ";}
if($preg->alt5<>'')   {if($preg->alt5==$preg->respuesta){$check5=" selected ";} $option.="<option value='".utf8_encode($preg->alt5)."' $check5>".utf8_encode($preg->alt5)."</option> ";}
if($preg->alt6<>'')   {if($preg->alt6==$preg->respuesta){$check6=" selected ";} $option.="<option value='".utf8_encode($preg->alt6)."' $check6>".utf8_encode($preg->alt6)."</option> ";}
if($preg->alt7<>'')   {if($preg->alt7==$preg->respuesta){$check7=" selected ";} $option.="<option value='".utf8_encode($preg->alt7)."' $check7>".utf8_encode($preg->alt7)."</option> ";}
if($preg->alt8<>'')   {if($preg->alt8==$preg->respuesta){$check8=" selected ";} $option.="<option value='".utf8_encode($preg->alt8)."' $check8>".utf8_encode($preg->alt8)."</option> ";}
if($preg->alt9<>'')   {if($preg->alt9==$preg->respuesta){$check9=" selected ";} $option.="<option value='".utf8_encode($preg->alt9)."' $check9>".utf8_encode($preg->alt9)."</option> ";}
if($preg->alt10<>'')  {if($preg->alt10==$preg->respuesta){$check10=" selected ";} $option.="<option value='".utf8_encode($preg->alt10)."' $check10>".utf8_encode($preg->alt10)."</option> ";}
if($preg->alt11<>'')   {if($preg->alt11==$preg->respuesta){$check11=" selected ";} $option.="<option value='".utf8_encode($preg->alt11)."' $check11>".utf8_encode($preg->alt11)."</option> ";}
if($preg->alt12<>'')   {if($preg->alt12==$preg->respuesta){$check12=" selected ";} $option.="<option value='".utf8_encode($preg->alt12)."' $check12>".utf8_encode($preg->alt12)."</option> ";}
if($preg->alt13<>'')   {if($preg->alt13==$preg->respuesta){$check13=" selected ";} $option.="<option value='".utf8_encode($preg->alt13)."' $check13>".utf8_encode($preg->alt13)."</option> ";}
if($preg->alt14<>'')   {if($preg->alt14==$preg->respuesta){$check14=" selected ";} $option.="<option value='".utf8_encode($preg->alt14)."' $check14>".utf8_encode($preg->alt14)."</option> ";}
if($preg->alt15<>'')   {if($preg->alt15==$preg->respuesta){$check15=" selected ";} $option.="<option value='".utf8_encode($preg->alt15)."' $check15>".utf8_encode($preg->alt15)."</option> ";}
if($preg->alt16<>'')   {if($preg->alt16==$preg->respuesta){$check16=" selected ";} $option.="<option value='".utf8_encode($preg->alt16)."' $check16>".utf8_encode($preg->alt16)."</option> ";}
if($preg->alt17<>'')   {if($preg->alt17==$preg->respuesta){$check17=" selected ";} $option.="<option value='".utf8_encode($preg->alt17)."' $check17>".utf8_encode($preg->alt17)."</option> ";}
if($preg->alt18<>'')   {if($preg->alt18==$preg->respuesta){$check18=" selected ";} $option.="<option value='".utf8_encode($preg->alt18)."' $check18>".utf8_encode($preg->alt18)."</option> ";}
if($preg->alt19<>'')   {if($preg->alt19==$preg->respuesta){$check19=" selected ";} $option.="<option value='".utf8_encode($preg->alt19)."' $check19>".utf8_encode($preg->alt19)."</option> ";}
      $option.="<option value='Otra'>Otra</option> ";
$alternativas .= "<center>


 <select id='".$id_encuesta . $preg->id_pregunta."' name='".$id_encuesta . $preg->id_pregunta."' class='form form-control' required>
    ".$option."
</select>
    <small><div style='text-align: left;'>Escriba aqu? tu opci?n</div></small><br><input type='text' id='".$id_encuesta . $preg->id_pregunta."_otra' name='".$id_encuesta . $preg->id_pregunta."_otra' value=''  class='form form-control' />

 </center>";



            } else {

    //echo  "<br>preg selmul ".$preg->alt1;
    $option.="<option value=''></option> ";
if($preg->alt1<>'')   {$option.="<option value='".utf8_encode($preg->alt1)."'>".utf8_encode($preg->alt1)."</option> ";}
if($preg->alt2<>'')   {$option.="<option value='".utf8_encode($preg->alt2)."'>".utf8_encode($preg->alt2)."</option> ";}
if($preg->alt3<>'')   {$option.="<option value='".utf8_encode($preg->alt3)."'>".utf8_encode($preg->alt3)."</option> ";}
if($preg->alt4<>'')   {$option.="<option value='".utf8_encode($preg->alt4)."'>".utf8_encode($preg->alt4)."</option> ";}
if($preg->alt5<>'')   {$option.="<option value='".utf8_encode($preg->alt5)."'>".utf8_encode($preg->alt5)."</option> ";}
if($preg->alt6<>'')   {$option.="<option value='".utf8_encode($preg->alt6)."'>".utf8_encode($preg->alt6)."</option> ";}
if($preg->alt7<>'')   {$option.="<option value='".utf8_encode($preg->alt7)."'>".utf8_encode($preg->alt7)."</option> ";}
if($preg->alt8<>'')   {$option.="<option value='".utf8_encode($preg->alt8)."'>".utf8_encode($preg->alt8)."</option> ";}
if($preg->alt9<>'')   {$option.="<option value='".utf8_encode($preg->alt9)."'>".utf8_encode($preg->alt9)."</option> ";}
if($preg->alt10<>'')   {$option.="<option value='".utf8_encode($preg->alt10)."'>".utf8_encode($preg->alt10)."</option> ";}
if($preg->alt11<>'')   {$option.="<option value='".utf8_encode($preg->alt11)."'>".utf8_encode($preg->alt11)."</option> ";}
if($preg->alt12<>'')   {$option.="<option value='".utf8_encode($preg->alt12)."'>".utf8_encode($preg->alt12)."</option> ";}
if($preg->alt13<>'')   {$option.="<option value='".utf8_encode($preg->alt13)."'>".utf8_encode($preg->alt13)."</option> ";}
if($preg->alt14<>'')   {$option.="<option value='".utf8_encode($preg->alt14)."'>".utf8_encode($preg->alt14)."</option> ";}
if($preg->alt15<>'')   {$option.="<option value='".utf8_encode($preg->alt15)."'>".utf8_encode($preg->alt15)."</option> ";}
if($preg->alt16<>'')   {$option.="<option value='".utf8_encode($preg->alt16)."'>".utf8_encode($preg->alt16)."</option> ";}
if($preg->alt17<>'')   {$option.="<option value='".utf8_encode($preg->alt17)."'>".utf8_encode($preg->alt17)."</option> ";}
if($preg->alt18<>'')   {$option.="<option value='".utf8_encode($preg->alt18)."'>".utf8_encode($preg->alt18)."</option> ";}
if($preg->alt19<>'')   {$option.="<option value='".utf8_encode($preg->alt19)."'>".utf8_encode($preg->alt19)."</option> ";}


           $option.="<option value='Otra'>Otra</option> ";
$alternativas.="
<script>function MuestraOtra_".$preg->id_pregunta."(valor){
if(valor=='Otra'){
        document.getElementById('otra_".$preg->id_pregunta."').style.display = 'block';

}else{
    document.getElementById('otra_".$preg->id_pregunta."').style.display = 'none';
}


}</script>
";
$alternativas .= "<center>


 <select  id='".$id_encuesta . $preg->id_pregunta."' name='".$id_encuesta . $preg->id_pregunta."' onchange=\"MuestraOtra_".$preg->id_pregunta."(this.value);\" class='form form-control' required>
   ".$option."
</select>
    <span id='otra_".$preg->id_pregunta."' style='display:none;'>
    <small><div style='text-align: left;'>Escriba aqu? tu opci?n</div></small><br><input type='text' id='".$id_encuesta . $preg->id_pregunta."_otra' name='".$id_encuesta . $preg->id_pregunta."_otra' value=''  class='form form-control' />
    </span>
 </center>";            }

         }
         if ($preg->tipo == "NIV1_7") {

         //echo "hola";
                  $alternativas="";
                  //$alternativas= file_get_contents("views/medicion/" . $id_empresa . "_preguntas_niv1_7.html");
            if ($preg->respuesta) {

         $alternativas .= "<center> <input id='".$id_encuesta . $preg->id_pregunta."' name='".$id_encuesta . $preg->id_pregunta."'
            type='number' class='rating' max='7' data-step='1' data-stars='7' data-size='md' data-glyphicon='false'
            data-rating-class='fontawesome-icon' data-symbol='&#xe73b;' value='".$preg->respuesta."'   ></center>";
            } else {


                 $alternativas .= "<center> <input id='".$id_encuesta . $preg->id_pregunta."' name='".$id_encuesta . $preg->id_pregunta."'
                 type='number' class='rating' max='7' data-step='1' data-stars='7' data-size='md' data-glyphicon='false'
            data-rating-class='fontawesome-icon' data-symbol='&#xe73b;'  ></center>";
            }

             //echo "<br><br>$alternativas";
         }

        if ($preg->tipo == "NIV1_10") {
            $alternativas="";
                            $alternativas = "<table width='100%'><tr>";
                            for ($i = 1; $i <= 10; $i++) {
                                if ($preg->respuesta == $i) {
                                    $checked = " checked ";
                                } else {
                                    $checked = "  ";
                                }

                            //echo "<br> NIV1_10 RUT COLABORADOR  $rut_colaborador ID ENCUESTA $id_encuesta ID PREGUNTA ".$preg->id_pregunta." ";

                                $alternativas .= "<td width='10%'>
                                        <center>
                                            <input type='radio' name='" . $id_encuesta . $preg->id_pregunta . "' value='" . $i . "' " . $checked . ">
                                            <br>" . $i . "</center>
                                            </td>";
                            }
                            $alternativas .= "</tr></table>";
        }


        if ($preg->tipo == "SI_NO") {     $alternativas="";
                                //echo "<br>SI NO";
                                    if ($preg->respuesta == "SI") {
                                        $checkedSI = " checked ";
                                    } else {
                                        $checkedSI = "  ";
                                    }
                                    if ($preg->respuesta == "NO") {
                                        $checkedNO = " checked ";
                                    } else {
                                        $checkedNO = "  ";
                                    }
                                    $alternativas = "<table width='100%' border=0><tr>";
                                    $alternativas .= "<td width='50%'><center><input type='radio' name='" . $id_encuesta . $preg->id_pregunta . "'
                                            value='NO' " . $checkedNO . " required><br>
                                            <span class='badge badge-danger'><span class='blanco'>NO</span></span></center><br></td>";
                                    $alternativas .= "<td width='50%'><center><input type='radio' name='" .  $id_encuesta . $preg->id_pregunta . "'
                                            value='SI' " . $checkedSI . " required><br>
                                            <span class='badge badge-info'><span class='blanco'>SI</span></span></center><br></td>";
                                    $alternativas .= "</tr></table>";
        }

        if ($preg->tipo == "SI_NO_BOTON") {
            $alternativas="";
                                //echo "<br>SI NO";
                                    if ($preg->respuesta == "SI") {
                                        $checkedSI = " checked ";
                                    } else {
                                        $checkedSI = "  ";
                                    }
                                    if ($preg->respuesta == "NO") {
                                        $checkedNO = " checked ";
                                    } else {
                                        $checkedNO = "  ";
                                    }
                                    $alternativas = "<table width='100%' border=0><tr>";
                                    $alternativas .= "<td width='50%'><center><input type='radio' name='" . $id_encuesta . $preg->id_pregunta . "'
                                            value='NO' " . $checkedNO . " onclick=\"myFunctionOpcion2('".$preg->id_pregunta."')\" required><br>
                                            <span class='badge badge-danger'><span class='blanco'>NO</span></span></center><br></td>";
                                    $alternativas .= "<td width='50%'><center><input type='radio' name='" .  $id_encuesta . $preg->id_pregunta . "'
                                            value='SI' " . $checkedSI . " onclick=\"myFunctionOpcion1('".$preg->id_pregunta."')\" required><br>
                                            <span class='badge badge-info'><span class='blanco'>SI</span></span></center><br></td>";
                                    $alternativas .= "</tr></table>";





        }

        //echo $preg->tipo;

        if ($preg->tipo == "LIK_1_5") {      $alternativas="";

                                //echo "<br>LI5 594";
                                if ($preg->respuesta == "1") {
                                    $checkedUno = " checked ";
                                } else {
                                    $checkedUno = "  ";
                                }
                                if ($preg->respuesta == "2") {
                                    $checkedDos = " checked ";
                                } else {
                                    $checkedDos = "  ";
                                }
                                if ($preg->respuesta == "3") {
                                    $checkedTres = " checked ";
                                } else {
                                    $checkedTres = "  ";
                                }
                                if ($preg->respuesta == "4") {
                                    $checkedCuatro = " checked ";
                                } else {
                                    $checkedCuatro = "  ";
                                }
                                if ($preg->respuesta == "5") {
                                    $checkedCinco = " checked ";
                                } else {
                                    $checkedCinco = "  ";
                                }

                                //echo "hola";

                                $alternativas = "<table width='100%'><tr>";
                                $alternativas .= "<td width='20%'><center><input type='radio' name='" .  $id_encuesta . $preg->id_pregunta . "'
                                        value='1' " . $checkedUno . " required><br><img src='img/med_sad.png' width='32px'><br>
                                        <span class='badge badge-danger'><span class='blanco'>Totalmente en Desacuerdo</span></span></center><br></td>";
                                $alternativas .= "<td width='20%'><center><input type='radio' name='" .  $id_encuesta . $preg->id_pregunta . "'
                                        value='2' " . $checkedDos . " required><br><img src='img/med_sad.png' width='32px'><br>
                                        <span class='badge badge-danger'><span class='blanco'>En Desacuerdo</span></span></center><br></td>";
                                $alternativas .= "<td width='20%'><center><input type='radio' name='" .  $id_encuesta . $preg->id_pregunta . "'
                                        value='3' " . $checkedTres . " required><br><img src='img/med_confused.png' width='32px'>  <br>
                                        <span class='badge badge-info'><span class='blanco'>Ni de Acuerdo ni en Desacuerdo</span></span></center><br></td>";
                                $alternativas .= "<td width='20%'><center><input type='radio' name='" .  $id_encuesta . $preg->id_pregunta . "'
                                        value='4' " . $checkedCuatro . " required><br><img src='img/med_happy.png' width='32px'> <br>
                                        <span class='badge badge-info'><span class='blanco'>De Acuerdo</span></span></center><br></td>";
                                $alternativas .= "<td width='20%'><center><input type='radio' name='" .  $id_encuesta . $preg->id_pregunta . "'
                                        value='5' " . $checkedCinco . " required><br><img src='img/med_happy.png' width='32px'> <br>
                                        <span class='badge badge-success'><span class='blanco'>Totalmente  de Acuerdo</span></span></center><br></td>";
                                $alternativas .= "</tr></table>";

                                //echo "$alternativas";
        }


        if ($preg->tipo == "LIK1_4") {       $alternativas="";

                                //echo "<br>LI5 594";
                                if ($preg->respuesta == "1") {
                                    $checkedUno = " checked ";
                                } else {
                                    $checkedUno = "  ";
                                }
                                if ($preg->respuesta == "2") {
                                    $checkedDos = " checked ";
                                } else {
                                    $checkedDos = "  ";
                                }
                                if ($preg->respuesta == "3") {
                                    $checkedTres = " checked ";
                                } else {
                                    $checkedTres = "  ";
                                }
                                if ($preg->respuesta == "4") {
                                    $checkedCuatro = " checked ";
                                } else {
                                    $checkedCuatro = "  ";
                                }
                                if ($preg->respuesta == "5") {
                                    $checkedCinco = " checked ";
                                } else {
                                    $checkedCinco = "  ";
                                }

                                //echo "hola";

                                $alternativas = "<table width='100%'><tr>";
                                $alternativas .= "<td width='20%'><center><input type='radio' name='" .  $id_encuesta . $preg->id_pregunta . "'
                                        value='1' " . $checkedUno . " required><br><img src='img/med_sad.png' width='32px'><br>
                                        <span class='badge badge-danger'><span class='blanco'>Muy en desacuerdo</span></span></center><br></td>";
                                $alternativas .= "<td width='20%'><center><input type='radio' name='" .  $id_encuesta . $preg->id_pregunta . "'
                                        value='2' " . $checkedDos . " required><br><img src='img/med_confused.png' width='32px'><br>
                                        <span class='badge badge-warning'><span class='blanco'>Desacuerdo</span></span></center><br></td>";
                                $alternativas .= "<td width='20%'><center><input type='radio' name='" .  $id_encuesta . $preg->id_pregunta . "'
                                        value='3' " . $checkedTres . " required><br><img src='img/med_happy.png' width='32px'>  <br>
                                        <span class='badge badge-info'><span class='blanco'>De acuerdo</span></span></center><br></td>";
                                $alternativas .= "<td width='20%'><center><input type='radio' name='" .  $id_encuesta . $preg->id_pregunta . "'
                                        value='4' " . $checkedCuatro . " required><br><img src='img/med_happy.png' width='32px'> <br>
                                        <span class='badge badge-success'><span class='blanco'>Muy de acuerdo</span></span></center><br></td>";

                                $alternativas .= "</tr></table>";

                                //echo "$alternativas";
        }

       // echo "<br>$alternativas";

       //echo "<br>row ".$row;
       //echo "<br><br>";echo "$alternativas";

        $row = str_replace("{PREGUNTA}", utf8_encode($preg->pregunta), $row);
        $row = str_replace("{ALTERNATIVAS}", $alternativas, $row);
        $row = str_replace("{RUT}", $rut, $row);
        $row = str_replace("{RUT_COLABORADOR}", $rut_colaborador, $row);
        $row = str_replace("{ID_PREGUNTA}", $preg->id_pregunta, $row);
    }

        $PRINCIPAL = str_replace("{ROW_PREGUNTAS_LIBRE}", utf8_encode($row), $PRINCIPAL);

    return ($row);
}

function ColocaPreguntasFinNivel($PRINCIPAL, $id_empresa, $rut, $id_curso, $id_malla, $id_encuesta)
{
    $preguntas = PreguntasFinNivel($id_empresa, $id_encuesta, $rut, $id_curso, $id_malla, $id_encuesta);
    $row       = "";
    foreach ($preguntas as $preg) {
        if ($preg->respuesta) {
            $row .= file_get_contents("views/cursos/informe/" . $id_empresa . "_fin_nivel_pregunta_lectura.html");
        } else {
            $row .= file_get_contents("views/cursos/informe/" . $id_empresa . "_fin_nivel_pregunta.html");
            }
        $row = str_replace("{PREGUNTA}", $preg->pregunta, $row);
        $row = str_replace("{ALTERNATIVA_SELECCIONADA}", '<span class="label label-success">' . $preg->respuesta . '</span>', $row);
        $row = str_replace("{ID_PREGUNTA}", $preg->id_pregunta, $row);
        $row = str_replace("{RUT}", $rut, $row);
    }
    $PRINCIPAL = str_replace("{ROW_PREGUNTAS}", utf8_encode($row), $PRINCIPAL);
    return ($PRINCIPAL);
}

function ColocaVideosLidWom($PRINCIPAL)
{
    $videos = VideosPorCategoria("lidwom");
    foreach ($videos as $vid) {
        $row .= file_get_contents("views/womLid/row_videos.html");
        if ($vid->activo == 1) {
            $row = str_replace("{LINK_VIDEO}", "?sw=veVideo&i=" . Encodear3($vid->id), $row);
            $row = str_replace("{IMAGEN}", $vid->imagen . ".png", $row);
        } else {
            $row = str_replace("{LINK_VIDEO}", "#", $row);
            $row = str_replace("{IMAGEN}", $vid->imagen . "_over.png", $row);
        }
    }
    $PRINCIPAL = str_replace("{LISTADO_VIDEOS_LIDWOM}", $row, $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaArchivosWonLid($PRINCIPAL, $rut)
{
    //Traigo los documentos subidos por el usuario de sesion
    $es_facilitador = UsuarioEsFacilitadorWomLid($rut);
    if ($es_facilitador) {
        $womLids = TotalWonLidsTodos();
    } else {
        $womLids = TotalWonLids($rut);
    }
    if ($womLids) {
        $i = 1;
        foreach ($womLids as $wom) {
            $row .= file_get_contents("views/womLid/row.html");
            $row = str_replace("{N}", $i, $row);
            $row = str_replace("{NOMBRE}", $wom->nombre_completo, $row);
            $row = str_replace("{DESCRIPCION}", $wom->descripcion, $row);
            $row = str_replace("{FECHA}", $wom->fecha, $row);
            $row = str_replace("{HORA}", $wom->hora, $row);
            $row = str_replace("{NOMBRE_ARCHIVO}", $wom->nombre_archivo, $row);
            $i++;
        }
        $PRINCIPAL = str_replace("{LISTADO_ARCHIVOS_SUBIDOS}", utf8_encode($row), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{LISTADO_ARCHIVOS_SUBIDOS}", "No se han ingresado documentos", $PRINCIPAL);
    }
    return ($PRINCIPAL);
}
function SuboArchivoDocWomLid($FILES, $extension_doc, $prefijo, $ruta, $numero)
{
    //echo "$extension_archivo, $prefijo, $ruta";exit;
    //$ruta_con_archivo=$ruta."/".$prefijo."_BK.".$extension_archivo;
    $ruta_con_archivo = $ruta . "/" . $prefijo . "." . $extension_doc;
    copy($FILES['doc' . $numero]['tmp_name'], $ruta_con_archivo);
    $nombre_imagen_video = $prefijo . "." . $extension_doc;
    //RedimensionarImagenSlider($ruta_con_archivo, $nombre_imagen_slider);
    //Devuelvol un arreglo, con datos del archivo subido
    $arreglo[0]          = $ruta_con_archivo; //Ruta Completa
    $arreglo[1]          = $prefijo . "." . $extension_doc; //Nombre del Archivo
    $arreglo[2]          = $ruta . "/" . $prefijo; //Ruta del Objeto sin el index
    return ($arreglo);
}
function MenuCursosProd2018($PRINCIPAL, $id_empresa, $rut, $prodtipo)
{
    $arr_malla    = BuscaIdmallaDadoProgramaRut_Prd($rut, $id_empresa, $prodtipo);
    $id_malla     = $arr_malla[0]->id_malla;
    $datos_cursos = BuscaCursosPorIdmallaDadoProgramaRut_Prd($rut, $id_empresa, $id_malla);
    foreach ($datos_cursos as $unico) {
        $row .= file_get_contents("views/templates/" . $id_empresa . "_bci_productivizate_2018_cursos.html");
        $row = str_replace("{ID_CURSO}", ($unico->id_curso), $row);
        $row = str_replace("{ID_CURSO_ENCODEADO}", Encodear3($unico->id_curso), $row);
        $row = str_replace("{NOMBRE_CURSO}", utf8_encode($unico->nombre_curso), $row);
        $row = str_replace("{DESCRIPCION_CURSO}", utf8_encode($unico->descripcion_curso), $row);
        $row = str_replace("{AVANCE_CURSO}", ($unico->avance), $row);
        $row = str_replace("{IMAGEN_CURSO}", ($unico->imagen_curso), $row);
        $row = str_replace("{ESTILO}", $unico->avance, $row);
    }
    $PRINCIPAL = str_replace("{ROW_CURSOS_PROD}", $row, $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaSolicitudesParaAprobar($PRINCIPAL, $rut, $id_empresa)
{
    //Veo si tiene solicitudes de el como responsble, en estado
    $listado = ConsultasituacionesSeguimientoPorEstado($id_empresa, $rut, "Sin Iniciar");
    if ($listado) {
        $i   = 1;
        $row = file_get_contents("views/seguimiento/" . $id_empresa . "_seguimiento_entorno_solicitudes.html");
        foreach ($listado as $list) {
            $row .= file_get_contents("views/seguimiento/" . $id_empresa . "_seguimiento_solicitudes.html");
            $row = str_replace("{NUMERO}", $i, $row);
            $row = str_replace("{ID_SOLICITUD_ENCODEADA}", Encodear3($list->id), $row);
            $row = str_replace("{ID_REGISTRO}", ($list->id_seguimiento), $row);
            $row = str_replace("{TEMAS_LEVANTADSOS}", $list->antecedentes, $row);
            $row = str_replace("{SOLICITUD}", utf8_encode($list->solicitud), $row);
            $row = str_replace("{OBSERVACIONES_DE_LA_ATENCION}", $list->observaciones, $row);
            $row = str_replace("{DPTO_RESPONSABLE}", "falta_dato", $row);
            $row = str_replace("{FECHA_COMPROMISO}", $list->fecha_compromiso, $row);
        }
        $PRINCIPAL = str_replace("{ROW_SOLICITUDES_PENDIENTES}", $row, $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{ROW_SOLICITUDES_PENDIENTES}", "", $PRINCIPAL);
    }
    return ($PRINCIPAL);
}
function ColocaDatosSituacionDadoIdRegistro($id_registro,  $id_empresa, $perfil)
{
    $datos_registro_inicial = Sis_busLista_id($_GET["idr"], $id_empresa);
    $registros              = DAtosSituacionPorRegistro($id_registro, $id_empresa);
    $i                      = 1;
    foreach ($registros as $reg) {
        $row .= "<div class='row'>";
        if ($datos_registro_inicial[0]->tipo_registro == "BAC") {
            $row .= file_get_contents("views/seguimiento/" . $id_empresa . "_seguimiento_registro_bac.html");
        } else if ($datos_registro_inicial[0]->tipo_registro == "BUS") {
            $row .= file_get_contents("views/seguimiento/" . $id_empresa . "_seguimiento_registro_visita.html");
        }
        else if ($datos_registro_inicial[0]->tipo_registro == "DCR") {
            $row .= file_get_contents("views/seguimiento/" . $id_empresa . "_seguimiento_registro_dcr.html");
        }
        $row                       = str_replace("{ROW_LISTADO_DATOS_SITUACION_BAC}", "", $row);
        $row                       = str_replace("{ANTECEDENTES_ENTREGADOS}", utf8_encode($reg->antecedentes), $row);
        $row                       = str_replace("{INFORMACION_ENTREGADA_BUS}", utf8_encode($reg->antecedentes), $row);
        $row                       = str_replace("{OBSERVACIONES_ATENCION}", utf8_encode($reg->observaciones), $row);
        $row                       = str_replace("{FECHA_COMPROMISO_BUS}", utf8_encode($reg->fecha_compromiso), $row);
        $row                       = str_replace("{FECHA_COMPROMISO}", utf8_encode($reg->fecha_compromiso), $row);

    //$perfil_bacbus="NP";
   // echo "<br>".$reg->fecha_compromiso<>''." perfil $perfil";
    if($reg->fecha_compromiso<>'' and $perfil<>"Super Registrador"){
        $row= str_replace("{READONLY_FECHA_COMPROMISO}"," readonly ",$row);
    } else {
        $row= str_replace("{READONLY_FECHA_COMPROMISO}","  ",$row);
    }
    //echo utf8_encode($reg->id_departamento_res);echo "<br><br>";

        $row                       = str_replace("{OBSERVACIONES_ATENCION_BUS}", utf8_encode($reg->observaciones), $row);
        $row                       = str_replace("{VALUE_" . utf8_encode($reg->solicitud) . "}", "selected='selected'", $row);
        $row                       = str_replace("{SELECTED_SOLICITUD_BUS_" . utf8_encode($reg->solicitud) . "}", "selected='selected'", $row);
        $row                       = str_replace("{VALUE_CLASIFICACION_" . utf8_encode($reg->clasificacion) . "}", "selected='selected'", $row);
        $row                       = str_replace("{SELECTED_MOTIVO_" . utf8_encode($reg->motiva_atencion) . "}", "selected='selected'", $row);
        $row                       = str_replace("{VALUE_" . utf8_encode($reg->id_departamento_res) . "}", "selected='selected'", $row);
        $datos_usuario_responsable = UsuarioEnBasePersonas($reg->rut_res);
        $combo_inicial_responsable = "<option value='" . utf8_encode($reg->rut_res) . "'>" . utf8_encode($datos_usuario_responsable[0]->nombre_completo) . "</option>";
        $row                       = str_replace("{COLABORADOR_RESPONSABLE_BUS}", utf8_encode($combo_inicial_responsable), $row);
        $rut_denunciante           = $reg->rut_den;
        $datos_denunciante         = UsuarioEnBasePersonas($rut_denunciante);
        $row                       = str_replace("{NOMBRE_DENUNCIADO}", $datos_denunciante[0]->nombre_completo . " " . $datos_denunciante[0]->rut_completo, $row);
        $row                       = str_replace("{RUT_DENUNCIADO_VALOR}", $rut_denunciante, $row);

        $row                       = str_replace("{ID_DEPARTAMENTO_BUS}", $reg->id_departamento_res, $row);
$arr_Cui=BuscaSucursalCui_data($reg->id_departamento_res,$id_empresa);
$row= str_replace("{ID_CUI_DCR2}",
"".utf8_encode($reg->id_departamento_res)." ".utf8_encode($arr_Cui[0]->sucursal),$row);


        $row                       = str_replace("{NUMERO}", $i, $row);
        $row                       = str_replace("{COL}", "12", $row);
        $row                       = str_replace("{ID_SITUACION}", $reg->id, $row);
        $row                       = str_replace("{ID_SITUACION_ENCODEADA}", Encodear3($reg->id), $row);
        $row                       = str_replace("{EDITA}", "Edita", $row);
        $row                       = str_replace("{STYLE_DISPLAY}", "style='display:none;'", $row);
        //$row = str_replace("{BOTON_SUBMIT}","",$row);
        $row                       = str_replace("{BOTON_SUBMIT}", "<center><input type='submit' value='Guardar Cambios' class='btn btn-success'></center>", $row);
        $i++;
        $row .= "</div>";
    }
    return ($row);
}
function Emb_Lista_Tareas($rut, $estado, $id_empresa, $id_grupo_interes)
{    //echo "<br>$rut, $estado, $id_empresa, $id_grupo_interes";
        $arr_Emb_tareas = EMB_buscalista_tareas($rut, $estado, $id_empresa, $id_grupo_interes);

       //echo "<br>$rut, $estado, $id_empresa, $id_grupo_interes";
       ///print_r($arr_Emb_tareas);

    foreach ($arr_Emb_tareas as $unico) {
       //echo "<br><br>";        print_r($unico);


        if($unico->pregunta1==""){

            $pregunta1="    <div class='f-title-one'>
                                &iquest;Con qui&eacute;n trabajaste esta tarea? (ejemplo: @veronica.huerta, @carolina.majluf, @paulina.cruz, @ricardo.ross)
                            </div>
                            <div class='controls'>
                                <input type='text' name='conquientrabajaste' id='conquientrabajaste' value='{CONQUIENTRABAJASTE}'    class='span9 valid' onblur='validateEmail(this);' required />
                                <!--<input name='conquientrabajaste' id='conquientrabajaste' type='email' multiple class='span9 valid' required>-->
                            </div>";

        } else {

            $pregunta1="";

        }

        if($unico->pregunta2==""){

            $pregunta2="    <div class='f-title-one'>
                                &iquest;Cu&aacute;nto tiempo tom&oacute; realizar tu tarea?
                            </div>
                            <div class='controls'>
                                <input name='dias' id='dias' class='span9 valid' value='{DIAS}' required  >
                            </div>";

        } else {

            $pregunta2="";

        }

        if($unico->pregunta3==""){

            $pregunta3="    <div class='f-title-one'>
                                Ind&iacute;canos tus observaciones sobre el desarrollo de la tarea, &iquest;Te falt&oacute; algo?, &iquest;Te falt&oacute; tiempo?
                            </div>
                            <div class='controls'>
                                <input name='comentarios' id='comentarios'   value='{COMENTARIOS}'  class='span9 valid' required >
                            </div>";

        } else {

            $pregunta3="";

        }
    //echo "<br><br> respuesta estado ".$unico->respuesta_estado;

        if ($estado <> '') {
            if ($unico->respuesta_estado == "") {
                $row .= file_get_contents("views/embajadores/row_emb_tareas_bloque_no_iniciada.html");
                $row = str_replace("{ESTADO}", "NO INICIADA", $row);
                $row = str_replace("{COLOR_ESTADO}", "bg-rojo", $row);
            } elseif ($unico->respuesta_estado == "INICIADA") {
                $row .= file_get_contents("views/embajadores/row_emb_tareas_bloque_iniciada.html");
                $row = str_replace("{ESTADO}", "NO INICIADA", $row);
                $row = str_replace("{COLOR_ESTADO}", "bg-rojo", $row);
            } elseif ($unico->respuesta_estado == "EN_REVISION") {
                $row .= file_get_contents("views/embajadores/row_emb_tareas_bloque_ingresada.html");
                $row = str_replace("{ESTADO}", "EN REVISION", $row);
                $row = str_replace("{COLOR_ESTADO}", "bg-azul", $row);
            } elseif ($unico->respuesta_estado == "VALIDADA") {
                $row .= file_get_contents("views/embajadores/row_emb_tareas_bloque_validada.html");
                $row = str_replace("{ESTADO}", "VALIDADA", $row);
                $row = str_replace("{COLOR_ESTADO}", "bg-verde", $row);
            }elseif ($unico->respuesta_estado == "DEVUELTA") {
                $row .= file_get_contents("views/embajadores/row_emb_tareas_bloque_devuelta.html");
                $row = str_replace("{ESTADO}", "DEVUELTA", $row);
                $row = str_replace("{COLOR_ESTADO}", "bg-amarillo", $row);

            } else {
                $row .= file_get_contents("views/embajadores/row_emb_tareas_bloque_no_iniciada.html");
                $row = str_replace("{ESTADO}", "NO INICIADA", $row);
                $row = str_replace("{COLOR_ESTADO}", "bg-danger", $row);
            }
        } else {

            if ($unico->respuesta_estado == "") {
                $row .= file_get_contents("views/embajadores/row_emb_tareas_bloque_no_iniciadaT.html");
                $row = str_replace("{ESTADO}", "NO INICIADA", $row);
                $row = str_replace("{COLOR_ESTADO}", "bg-rojo", $row);
            } elseif ($unico->respuesta_estado == "NO INICIADA") {
                $row .= file_get_contents("views/embajadores/row_emb_tareas_bloque_iniciadaT.html");
                $row = str_replace("{ESTADO}", "NO INICIADA", $row);
                $row = str_replace("{COLOR_ESTADO}", "bg-rojo", $row);
            } elseif ($unico->respuesta_estado == "EN_REVISION") {
                $row .= file_get_contents("views/embajadores/row_emb_tareas_bloque_ingresadaT.html");
                $row = str_replace("{ESTADO}", "EN REVISION", $row);
                $row = str_replace("{COLOR_ESTADO}", "bg-azul", $row);
            } elseif ($unico->respuesta_estado == "VALIDADA") {
                $row .= file_get_contents("views/embajadores/row_emb_tareas_bloque_validadaT.html");
                $row = str_replace("{ESTADO}", "VALIDADA", $row);
                $row = str_replace("{COLOR_ESTADO}", "bg-verde", $row);
             }elseif ($unico->respuesta_estado == "DEVUELTA") {
                $row .= file_get_contents("views/embajadores/row_emb_tareas_bloque_devueltaT.html");
                $row = str_replace("{ESTADO}", "DEVUELTA", $row);
                $row = str_replace("{COLOR_ESTADO}", "bg-amarillo", $row);



            } else {
                $row .= file_get_contents("views/embajadores/row_emb_tareas_bloque_no_iniciadaT.html");
                $row = str_replace("{ESTADO}", "NO INICIADA", $row);
                $row = str_replace("{COLOR_ESTADO}", "bg-danger", $row);
            }
        }
        if ($unico->tarea_link_material <> '') {
            $link_material = "<a href='" . $unico->tarea_link_material . "' target='_blank'><div class='btn-featured'>Ver Material</div></a>";
        } else {
            $link_material = "";
        }
        if ($unico->tarea_link_material2 <> '') {
            $link_material2 = "<a href='" . $unico->tarea_link_material2 . "' target='_blank'><div class='btn-featured'>Ver Material</div></a>";
        } else {
            $link_material2 = "";
        }
        if ($unico->tarea_link_material3 <> '') {
            $link_material3 = "<a href='" . $unico->tarea_link_material3 . "' target='_blank'><div class='btn-featured'>Ver Material</div></a>";
        } else {
            $link_material3 = "";
        }
        if ($unico->accion == "Forms") {
            $form_option_tarea       = "<a href='" . $unico->link_archivo_trabajo . "' target='_blank'><div class='btn-featured2'>Ir a Link Google Forms</div></a>";
            $form_option_tarea_tutor = "<a href='" . $unico->link_tutor . "' target='_blank'><div class='btn-featured2'>Ir a Link Google Forms</div></a>";
        } elseif ($unico->accion == "Upload") {
            $form_option_tarea       = "<input name='link' id='link' class='span9 valid' required>";
            $form_option_tarea_tutor = "<a href='" . $unico->link_archivo_trabajo . "' target='_blank'><div class='btn-featured2'>Ir a Link Google Forms</div></a>";
        }
        //echo "<br><br><br><br>".$unico->accion." tarea".$form_option_tarea;
        $row = str_replace("{ID_TAREA_RESPUESTA}", $unico->idt, $row);
        $row = str_replace("{FECHA_TERMINO}", $unico->fecha_termino, $row);
        $row = str_replace("{LINK_FORM_O_LINK_UPLOAD}", $form_option_tarea, $row);
        $row = str_replace("{LINK_FORM_O_LINK_UPLOAD_TUTOR}", $form_option_tarea_tutor, $row);
        $row = str_replace("{ID_TAREA}", $unico->id_tarea, $row);
        $row = str_replace("{ID_TAREA_ENCODEADA}", Encodear3($unico->id_tarea), $row);
        $row = str_replace("{TAREA_NOMBRE}", $unico->tarea_nombre, $row);
        $row = str_replace("{TAREA_DESCRIPCION}", $unico->tarea_descripcion, $row);
        $row = str_replace("{TAREA_LINK_MATERIAL}", $link_material, $row);
        $row = str_replace("{TAREA_LINK_MATERIAL2}", $link_material2, $row);
        $row = str_replace("{TAREA_LINK_MATERIAL3}", $link_material3, $row);

        $row = str_replace("{FECHA_TERMINO}", $fecha_termino, $row);



        $row = str_replace("{PREGUNTA_ADICIONAL_01}", $pregunta1, $row);
        $row = str_replace("{PREGUNTA_ADICIONAL_02}", $pregunta2, $row);
        $row = str_replace("{PREGUNTA_ADICIONAL_03}", $pregunta3, $row);
        $row = str_replace("{TAREA_DESCRIPCION_TUTOR}", $unico->instruccion_tutor, $row);

        $row = str_replace("{TAREA_ACCION}", $unico->tarea_accion, $row);
        $row = str_replace("{TAREA_DESCRIPCION_ACCION}", $unico->tarea_descripcion_accion, $row);
        $row = str_replace("{RESPUESTA_FECHA_REGISTRO}", $unico->respuesta_fecha_registro, $row);
        $row = str_replace("{RESPUESTA_FECHA_INICIO}", $unico->respuesta_fecha_inicio, $row);
        $row = str_replace("{RESPUESTA_LINK}", $unico->respuesta_link, $row);
        $row = str_replace("{RESPUESTA_COMENTARIOS}", $unico->respuesta_comentarios, $row);
        $row = str_replace("{LIDERES}", $unico->respuesta_lider1, $row);
        $row = str_replace("{CONQUIENTRABAJASTE}", $unico->conquientrabajaste, $row);
        $row = str_replace("{DIAS}", $unico->dias, $row);
        $row = str_replace("{COMENTARIOS}", $unico->respuesta_comentarios, $row);
        $row = str_replace("{RUT}", $unico->rut, $row);
        $row = str_replace("{BOTON_EMB_VALIDAR_TAREA}", "", $row);
        $cuenta++;
    }
    $arreglo[0] = utf8_encode($row);
    $arreglo[1] = $cuenta;
    //print_r($arreglo);
    return $arreglo;
}
function Emb_rankingEmbajadores($id_empresa, $id_grupo_interes)
{
    $arr_Lista = Emb_Lista_Embajadores($id_empresa, $id_grupo_interes);
    foreach ($arr_Lista as $unico) {
        $row .= file_get_contents("views/embajadores/row_lista_embajadores_ranking.html");
        $arr_persona     = TraeDatosBiografiayUsuario($unico->rut, $id_empresa);
        $row             = str_replace("{RUT}", $unico->rut, $row);
        $row             = str_replace("{NOMBRE}", $arr_persona[0]->nombre_completo, $row);
        $email           = $unico->email;
       // $arr_email       = explode("@", $email);
        $nombre_email    = $email;
        $tareas          = $unico->CuentaTareas;
        $tareas_inicia   = $unico->CuentaTareasIniciada;
        $tareas_revision = $unico->CuentaTareasvRevision;
        $tareas_validada = $unico->CuentaTareasvValidada;
        $row             = str_replace("{NOMBRE_EMAIL}", $nombre_email." <br><small><strong>".$unico->grupo."</small></strong>", $row);
        $row             = str_replace("{AVATAR}", VerificaFotoPersonal($unico->rut), $row);
        $row             = str_replace("{AVANCE_TAREAS}", round($unico->avance), $row);
        $row             = str_replace("{CARGO}", $arr_persona[0]->cargo, $row);
        $row             = str_replace("{RUTPERSONA}", $unico->rut, $row);
    }
    return utf8_encode($row);
}



function MP_Row_Carrusel_Vista($id_empresa)
{
    $arr_Lista = MP_Row_Carrusel_Vista_data($id_empresa);



    foreach ($arr_Lista as $unico) {

        //print_r($unico);
        $row .= file_get_contents("views/comunidad_mp/".$id_empresa."_row_com_carrusel_stories.html");

        $arr_persona     = TraeDatosBiografiayUsuario($unico->rut, $id_empresa);

        if($unico->imagen<>''){
            $contenido="<img src='".$unico->imagen."' class='img_stories'>";
        } else {
            $contenido=utf8_encode($unico->stories);
        }

   //echo $contenido;
$row             = str_replace("{ID_STORIES}",     ($unico->id_st), $row);
$row             = str_replace("{IMAGEN_USER_STORIES}",     VerificaFotoPersonal($unico->rut), $row);
$row             = str_replace("{CONTENIDO_STORIES}",         $contenido, $row);
$row             = str_replace("{NOMBRE_USER_STORIES}",     $arr_persona[0]->nombre_completo, $row);
$row             = str_replace("{CARGO_USER_STORIES}",         $arr_persona[0]->cargo, $row);



    }



    return utf8_encode($row);
}

function MP_Row_Carrusel_360($id_empresa)
{
    $arr_Lista = MP_Row_Carrusel_360_data($id_empresa);


    //print_r($arr_Lista);//
    foreach ($arr_Lista as $unico) {

        //print_r($unico);
        $row .= file_get_contents("views/comunidad_mp/".$id_empresa."_row_com_carrusel_360.html");

        $arr_persona     = TraeDatosBiografiayUsuario($unico->rut, $id_empresa);

        if($unico->imagen<>''){
            $contenido="<img src='".$unico->imagen."' class='img_stories'>";
        } else {
            $contenido=utf8_encode($unico->stories);
        }

   //echo $contenido;
$row             = str_replace("{ID_STORIES}",     ($unico->id_st), $row);
$row             = str_replace("{IMAGEN_USER_STORIES}",     VerificaFotoPersonal($unico->rut), $row);
$row             = str_replace("{CONTENIDO_STORIES}",         $contenido, $row);
$user_name= explode("@", $arr_persona[0]->email);
$user_name_email="@".$user_name[0];
$row             = str_replace("{NOMBRE_USER_STORIES}",     $user_name_email, $row);
$row             = str_replace("{CARGO_USER_STORIES}",         $arr_persona[0]->cargo, $row);



    }



    return utf8_encode($row);
}

function MP_Row_Carrusel_Foto_GPTW($id_empresa, $rut)
{
    $arr_Lista = MP_Row_Carrusel_FotoGPTW_data($id_empresa);

    // print_r($arr_Lista);//

    foreach($arr_Lista as $unico) {

        //print_r($unico);

        $row.= file_get_contents("views/comunidad_mp/" . $id_empresa . "_row_com_carrusel_fotos_gptw.html");
        $arr_persona = TraeDatosBiografiayUsuario($unico->rut, $id_empresa);
        $foto = "<img src='multimedia/" . $unico->foto . "' class='img_fotos' width='100%'>";

       // echo " <br>Contenido ".$foto;
        $row        = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones_full.html"), $row);

        $row = str_replace("{ID_FOTOS}", ($unico->id_st) , $row);
        $row = str_replace("{FOTOS}", $foto, $row);
        $row = str_replace("{MENSAJE_FOTOS}", ($unico->mensaje) , $row);
        $user_name = explode("@", $unico->email);
        $user_name_email = "@" . $user_name[0];
        $row = str_replace("{NOMBRE_FOTOS}", $user_name_email, $row);
        $row = str_replace("{IMAGEN_FOTOS}", VerificaFotoPersonal($unico->rut) , $row);
        $row = str_replace("{ID_MP_GPW}", ($unico->id) , $row);

        $row = str_replace("{HUINCHA_SOLO_MEGUSTA}", ColocaMegustaGPW($unico->id, $id_empresa, $rut) , $row);


    }

    return utf8_encode($row);
}

function MP_Row_Carrusel_Foto_TuTransDiamini($id_empresa,$grupo, $rut)
{
    $arr_Lista = MP_Row_Carrusel_FotoTuTransDia_data($id_empresa,$grupo);

    // print_r($arr_Lista);//

    foreach($arr_Lista as $unico) {

        //print_r($unico);

        $row.= file_get_contents("views/comunidad_mp/" . $id_empresa . "_row_com_carrusel_fotos_gptw.html");
        $arr_persona = TraeDatosBiografiayUsuario($unico->rut, $id_empresa);
        $foto = "<img src='multimedia/" . $unico->foto . "' class='img_fotos' width='100%'>";

       // echo " <br>Contenido ".$foto;
        $row        = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones_full.html"), $row);

        $row = str_replace("{ID_FOTOS}", ($unico->id_st) , $row);
        $row = str_replace("{FOTOS}", $foto, $row);
        $row = str_replace("{MENSAJE_FOTOS}", ($unico->mensaje) , $row);
        $user_name = explode("@", $unico->email);
        $user_name_email = "@" . $user_name[0];
        $row = str_replace("{NOMBRE_FOTOS}", $user_name_email, $row);
        $row = str_replace("{IMAGEN_FOTOS}", VerificaFotoPersonal($unico->rut) , $row);
        $row = str_replace("{ID_MP_GPW}", ($unico->id) , $row);

        $row = str_replace("{HUINCHA_SOLO_MEGUSTA}", ColocaMegustaGPW($unico->id, $id_empresa, $rut) , $row);


    }

    return utf8_encode($row);
}

 function MP_Row_Tendecias_TAG_MP($id_empresa)
{
    $arr_Lista = MP_Row_Tendecias_TAG_MP_data($id_empresa);

    // print_r($arr_Lista);//

    foreach($arr_Lista as $unico) {

        //print_r($unico);

        $row.= file_get_contents("views/comunidad_mp/" . $id_empresa . "_com_mp_row_tendencias.html");
        //$arr_persona = TraeDatosBiografiayUsuario($unico->rut, $id_empresa);
        //$foto = "<img src='multimedia/" . $unico->foto . "' class='img_fotos' width='100%'>";

       // echo " <br>Contenido ".$foto;
        //$row        = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones_full.html"), $row);

        $row = str_replace("{TAG}", ($unico->tag) , $row);
        $row = str_replace("{CUENTA}", ($unico->cuenta) , $row);
        $row = str_replace("{FOTOS}", $foto, $row);



    }

    return utf8_encode($row);
}

function MP_Row_Carrusel_twit($id_empresa)
{
    $arr_Lista = MP_Row_Carrusel_twit_data($id_empresa);

    foreach ($arr_Lista as $unico) {
        //print_r($unico);
        $arr_persona     = TraeDatosBiografiayUsuario($unico->rut, $id_empresa);

        if($unico->imagen<>''){
        $row .= file_get_contents("views/comunidad_mp/".$id_empresa."_row_com_carrusel_twit_foto.html");
            $contenido="<img src='multimedia/".$unico->imagen."' class='img_stories'>";
            } else {
        $row .= file_get_contents("views/comunidad_mp/".$id_empresa."_row_com_carrusel_twit.html");
            $contenido="";
        }

$row             = str_replace("{ID_STORIES}",     ($unico->id_st), $row);
$row             = str_replace("{IMAGEN_USER_STORIES}",     VerificaFotoPersonal($unico->rut), $row);
$row             = str_replace("{CONTENIDO_STORIES}",         $contenido, $row);
$row             = str_replace("{TWIT}",         ($unico->stories), $row);

$user_name= explode("@", $arr_persona[0]->email);
$user_name_email="@".$user_name[0];
$row             = str_replace("{NOMBRE_USER_STORIES}",     $user_name_email, $row);
$row             = str_replace("{CARGO_USER_STORIES}",         $arr_persona[0]->cargo, $row);



    }



    return utf8_encode($row);
}

function Emb_rankingEmbajadoresSponsorGrupal($id_empresa, $id_grupo_interes)
{

    //echo "<br>1133";

$arr_grupo=Emb_Lista_EmbajadoresSponsorGrupaldata($id_empresa, $id_grupo_interes);


    foreach($arr_grupo as $unicoG){

    $emb_idgrupo= $unicoG->idgrupo;
    $emb_grupo= $unicoG->grupo;
    $emb_avance= $unicoG->avance;
    $asesor_arr=mp_buscaDATOSPERSONAS($unicoG->rut_tutor, $id_empresa);
    $sponsor_arr=mp_buscaDATOSPERSONAS($unicoG->sponsor, $id_empresa);

    //echo "<br> grupo $emb_grupo, emb_avance $emb_avance";
        $row .= file_get_contents("views/embajadores/row_lista_embajadores_ranking_grupal.html");
        $arr_Lista=Emb_Lista_EmbajadoresGrupalTutor_xRUTData($id_empresa, $id_grupo_interes, $unicoG->rut_tutor);
        $row2="";
            foreach ($arr_Lista as $unico) {
                    $row2 .= file_get_contents("views/embajadores/row_lista_embajadores_ranking.html");
                    $arr_persona     = TraeDatosBiografiayUsuario($unico->rut, $id_empresa);
                    $row2             = str_replace("{RUT}", $unico->rut, $row2);
                    $row2            = str_replace("{NOMBRE}", $arr_persona[0]->nombre_completo, $row2);
                    $email           = $unico->email;
                    $nombre_email    = $email;
                    $tareas          = $unico->CuentaTareas;
                    $tareas_inicia   = $unico->CuentaTareasIniciada;
                    $tareas_revision = $unico->CuentaTareasvRevision;
                    $tareas_validada = $unico->CuentaTareasvValidada;
                    $row2           = str_replace("{NOMBRE_EMAIL}", $nombre_email."</strong>", $row2);
                    $row2           = str_replace("{AVATAR}", VerificaFotoPersonal($unico->rut), $row2);
                    $row2           = str_replace("{AVANCE_TAREAS}", round($unico->avance), $row2);
                    $row2           = str_replace("{CARGO}", $arr_persona[0]->cargo, $row2);
                    $row2           = str_replace("{RUTPERSONA}", $unico->rut, $row2);
            }

        $row         = str_replace("{LISTA_LIDERES_AVANCE}", $row2, $row);
        $row         = str_replace("{NOMBRE_GRUPO}", $emb_grupo, $row);
        $row         = str_replace("{ID_GRUPO}", $unicoG->rut_tutor, $row);
        $row         = str_replace("{AVANCE_GRUPO}", round($emb_avance), $row);
        $row         = str_replace("{CAPITAN_GRUPO}", $asesor_arr[0]->nombre_completo, $row);
        $row         = str_replace("{SPONSOR_GRUPO}", $sponsor_arr[0]->nombre_completo, $row);


    }



    return utf8_encode($row);
}


function Emb_rankingEmbajadoresGrupal($id_empresa, $id_grupo_interes)
{

    //echo "<br>1133";

$arr_grupo=Emb_Lista_EmbajadoresGrupaldata($id_empresa, $id_grupo_interes);


    foreach($arr_grupo as $unicoG){

    $emb_idgrupo= $unicoG->idgrupo;
    $emb_grupo= $unicoG->grupo;
    $emb_avance= $unicoG->avance;
    $asesor_arr=mp_buscaDATOSPERSONAS($unicoG->asesor, $id_empresa);
    $sponsor_arr=mp_buscaDATOSPERSONAS($unicoG->sponsor, $id_empresa);

    //echo "<br> grupo $emb_grupo, emb_avance $emb_avance";
        $row .= file_get_contents("views/embajadores/row_lista_embajadores_ranking_grupal.html");
        $arr_Lista=Emb_Lista_EmbajadoresGrupal_xRUTData($id_empresa, $id_grupo_interes, $emb_idgrupo);
        $row2="";
            foreach ($arr_Lista as $unico) {
                    $row2 .= file_get_contents("views/embajadores/row_lista_embajadores_ranking.html");
                    $arr_persona     = TraeDatosBiografiayUsuario($unico->rut, $id_empresa);
                    $row2             = str_replace("{RUT}", $unico->rut, $row2);
                    $row2            = str_replace("{NOMBRE}", $arr_persona[0]->nombre_completo, $row2);
                    $email           = $unico->email;
                    $nombre_email    = $email;
                    $tareas          = $unico->CuentaTareas;
                    $tareas_inicia   = $unico->CuentaTareasIniciada;
                    $tareas_revision = $unico->CuentaTareasvRevision;
                    $tareas_validada = $unico->CuentaTareasvValidada;
                    $row2           = str_replace("{NOMBRE_EMAIL}", $nombre_email."</strong>", $row2);
                    $row2           = str_replace("{AVATAR}", VerificaFotoPersonal($unico->rut), $row2);
                    $row2             = str_replace("{AVANCE_TAREAS}", round($unico->avance), $row2);
                    $row2           = str_replace("{CARGO}", $arr_persona[0]->cargo, $row2);
                    $row2           = str_replace("{RUTPERSONA}", $unico->rut, $row2);
            }

        $row         = str_replace("{LISTA_LIDERES_AVANCE}", $row2, $row);
        $row         = str_replace("{NOMBRE_GRUPO}", $emb_grupo, $row);
        $row         = str_replace("{ID_GRUPO}", $emb_idgrupo, $row);
        $row         = str_replace("{AVANCE_GRUPO}", round($emb_avance), $row);
        $row         = str_replace("{CAPITAN_GRUPO}", $asesor_arr[0]->nombre_completo, $row);
        $row         = str_replace("{SPONSOR_GRUPO}", $sponsor_arr[0]->nombre_completo, $row);


    }



    return utf8_encode($row);
}

function Emb_PerfilMiTutor($rut,$grupointeres, $id_empresa)
{
    //echo "<br><br><br><br>$rut, $id_empresa";
    $arr_Lista = BuscaTutor_Embajador($rut, $id_empresa);
    foreach ($arr_Lista as $unico) {
        $row .= file_get_contents("views/embajadores/".$grupointeres."/row_mi_tutor.html");
        $arr_persona     = TraeDatosBiografiayUsuario($unico->rut_tutor, $id_empresa);

        $email           = $arr_persona[0]->email;
        $arr_email       = explode("@", $email);
        $nombre_email    = $arr_email[0];
        $row             = str_replace("{RUT}", $unico->rut, $row);
        $row             = str_replace("{NOMBRE}", $arr_persona[0]->nombre_completo, $row);
        $row             = str_replace("{PERFIL_COMUNIDAD_NOMBRE_EMAIL}", "@" . $nombre_email, $row);
        $row             = str_replace("{AVATAR}", VerificaFotoPersonal($unico->rut_tutor), $row);
        $email           = $unico->email;
       // $arr_email       = explode("@", $email);
        //$nombre_email    = $arr_email[0];
        $tareas          = $unico->CuentaTareas;
        $tareas_inicia   = $unico->CuentaTareasIniciada;
        $tareas_revision = $unico->CuentaTareasvRevision;
        $tareas_validada = $unico->CuentaTareasvValidada;
        $row             = str_replace("{NOMBRE_EMAIL}", $nombre_email." ".$unico->grupo, $row);
        $row             = str_replace("{AVANCE_TAREAS}", round($unico->avance), $row);
        $row             = str_replace("{CARGO}", $arr_persona[0]->cargo, $row);
        $row             = str_replace("{RUTPERSONA}", $unico->rut_tutor, $row);
        $row             = str_replace("{MIRUT}", $unico->rut_tutor, $row);

        }
    return utf8_encode($row);
}
function Emb_rankingEmbajadoresParaTutor($rut, $id_empresa, $id_grupo_interes)
{
    $arr_Lista = Emb_Lista_EmbajadoresTutor($rut, $id_empresa, $id_grupo_interes);
    foreach ($arr_Lista as $unico) {
    //print_r($unico);

        $row .= file_get_contents("views/embajadores/row_lista_embajadores_ranking_tutor.html");
        $arr_persona      = TraeDatosBiografiayUsuario($unico->rut, $id_empresa);
        $arr_nombre_email = explode("@", $arr_persona[0]->email);
        $nombre_email     = "@" . $arr_nombre_email[0];
        if ($unico->respuesta_estado == "") {
            $row            = str_replace("{ESTADO}", "NO INICIADA", $row);
            $row            = str_replace("{COLOR_ESTADO}", "bg-rojo", $row);
            $row            = str_replace("{RESPUESTA_FECHA_REGISTRO}", "", $row);
            $datos          = "";
            $validar_estado = "";
        } elseif ($unico->respuesta_estado == "INICIADA") {
            $row            = str_replace("{ESTADO}", "EN PROCESO", $row);
            $row            = str_replace("{COLOR_ESTADO}", "bg-amarillo", $row);
            $row            = str_replace("{RESPUESTA_FECHA_REGISTRO}", "| FECHA: " . $unico->respuesta_fecha_inicio, $row);
            $datos          = "Con Quien Trabajaras: " . $unico->conquientrabajaras;
            $validar_estado = "";
        } elseif ($unico->respuesta_estado == "EN_REVISION") {
            $row            = str_replace("{ESTADO}", "EN REVISION", $row);
            $row            = str_replace("{COLOR_ESTADO}", "bg-azul", $row);
            $row            = str_replace("{RESPUESTA_FECHA_REGISTRO}", "| FECHA: " . $unico->respuesta_fecha_registro, $row);
            $datos          = "Con Quien trabajaste: " . $unico->conquientrabajaste . "<br>Dias: " . $unico->dias . "<br>Comentarios: " . $unico->respuesta_comentarios;
            $validar_estado = "
            <form method='post' action='?sw=saveEmb1' class='peThemeContactForm'  form='name_{ID_TAREA}'>
            <input type='hidden' name='it' value='" . Encodear3($unico->id_tarea) . "'>
            <input type='hidden' name='rut_tarea' value='" . Encodear3($unico->rut) . "'>
            <input type='hidden' name='validar' value='1'>
            <input type='submit' value='Validar Tarea' class='contour-btn red'>
            </form>";
        } elseif ($unico->respuesta_estado == "VALIDADA") {
            $row            = str_replace("{ESTADO}", "VALIDADA", $row);
            $row            = str_replace("{COLOR_ESTADO}", "bg-verde", $row);
            $row            = str_replace("{RESPUESTA_FECHA_REGISTRO}", "| FECHA: " . $unico->respuesta_fecha_validada, $row);
            $datos          = "Con Quien trabajaste: " . $unico->conquientrabajaste . "<br>Dias Qque tardo: " . $unico->dias . "<br>Comentarios: " . $unico->respuesta_comentarios;
            $validar_estado = "";
        } else {
            $row            = str_replace("{ESTADO}", "NO INICIADA", $row);
            $row            = str_replace("{COLOR_ESTADO}", "bg-danger", $row);
            $row            = str_replace("{RESPUESTA_FECHA_REGISTRO}", "", $row);
            $datos          = "";
            $validar_estado = "";
        }
        if ($unico->respuesta_link <> '') {
            $link = "<a href='" . $unico->respuesta_link . "' target='_blank' class='btn btn-info btn-xs'>Ver Link Tarea</a>";
        } else {
            $link = "";
        }
        $row                        = str_replace("{ID_TAREA_ENCODEADA}", Encodear3($unico->id_tarea), $row);
        $row                        = str_replace("{RUT}", $unico->rut, $row);
        $row                        = str_replace("{NOMBRE_EMAIL}", $nombre_email, $row);
        $row                        = str_replace("{AVATAR}", VerificaFotoPersonal($unico->rut), $row);
        $row                        = str_replace("{TAREA}", $unico->tarea_nombre, $row);
        $row                        = str_replace("{LINK}", $link, $row);
        $row                        = str_replace("{DATOS}", $datos, $row);
        $row                        = str_replace("{VALIDAR}", $validar_estado, $row);
        $row                        = str_replace("{RUTPERSONA}", $unico->rut, $row);
        $row                        = str_replace("{AVANCE}", round($unico->avance), $row);
        //TAREAS
        $row_emb_tareas_no_iniciado = Emb_Lista_Tareas($unico->rut, "", $id_empresa,$id_grupo_interes);
        //print_r($row_emb_tareas_no_iniciado);
        $row                        = str_replace("{VISTA_TAREAS}", $row_emb_tareas_no_iniciado[0], $row);
        $PRINCIPAL                  = str_replace("{COM_MP_EMBAJADORES_MIS_TAREAS_NO_INICIADO}", $row_emb_tareas_no_iniciado[0], $PRINCIPAL);
    }
    return ($row);
}
function allCuiPorEmpresa($buscar, $id_empresa)
{
    $dataPersonas = allCuiData($buscar, $id_empresa);
    if ($dataPersonas) {
        foreach ($dataPersonas as $dataPersonas_aux) {
            echo utf8_encode($dataPersonas_aux->area) . "   " . utf8_encode($buscar) . " " . utf8_encode($dataPersonas_aux->amaterno) . " " . "|" . $dataPersonas_aux->rut . "\n";
            //echo utf8_encode($dataPersonas_aux->nombre)."\n";
        }
    } else {
        $data = 'No Existe este CUI';
    }
    return $data;
}

function allCuiPorNombreOficina($buscar, $id_empresa)
{
    $dataPersonas = allCuiOficData($buscar, $id_empresa);
    //print_r($dataPersonas);
    if ($dataPersonas) {
        foreach ($dataPersonas as $dataPersonas_aux) {
            $data=utf8_encode($dataPersonas_aux->id_gerencia) . " " . utf8_encode($dataPersonas_aux->sucursal) . "";
            //echo utf8_encode($dataPersonas_aux->nombre)."\n";
        }
    } else {
        $data = 'No Existe CUI';
    }
   // print_r($data);exit();
    return $data;
}



function allPersonasPorNombreCargoPorEmpresa($buscar, $id_empresa, $rut)
{
    //$datos_usuario=UsuarioEnBasePersonas($rut);
    //$dataPersonas = allPersonasPorEmpresa($buscar, $id_empresa);
    $buscar       = LimpiaRutFront($buscar);
    $dataPersonas = allPersonasPorEmpresa($buscar, $id_empresa, $datos_usuario[0]->gerencia);
    if ($dataPersonas) {
        foreach ($dataPersonas as $dataPersonas_aux) {
            echo utf8_encode($dataPersonas_aux->nombre_completo) . " / " . utf8_encode($dataPersonas_aux->cargo) . " " . utf8_encode($dataPersonas_aux->rut_completo) . "" . "|" . $dataPersonas_aux->rut . "" . "|" . $dataPersonas_aux->local . "\n";
            //echo utf8_encode($dataPersonas_aux->nombre)."\n";
        }
    } else {
        $data = 'No Existe este nombre';
    }
    return $data;
}

function allPersonasPorNombreCargoPorEmpresaSinDivPersonas($buscar, $id_empresa, $rut)
{
    //$datos_usuario=UsuarioEnBasePersonas($rut);
    //$dataPersonas = allPersonasPorEmpresa($buscar, $id_empresa);
    $buscar       = LimpiaRutFront($buscar);
    $dataPersonas = allPersonasPorEmpresaSinDivPersona($buscar, $id_empresa, $datos_usuario[0]->gerencia);
    if ($dataPersonas) {
        foreach ($dataPersonas as $dataPersonas_aux) {
            echo utf8_encode($dataPersonas_aux->nombre_completo) . " " . utf8_encode($dataPersonas_aux->rut_completo) . "" . "|" . $dataPersonas_aux->rut . "" . "|" . $dataPersonas_aux->local . "\n";
            //echo utf8_encode($dataPersonas_aux->nombre)."\n";
        }
    } else {
        $data = 'No Existen Resultados';    }
    return $data;
}
function allPersonasPorNombreCargoPorEmpresaSinDivPersonasJefe($buscar, $id_empresa, $rut)
{
    //$datos_usuario=UsuarioEnBasePersonas($rut);
    //$dataPersonas = allPersonasPorEmpresa($buscar, $id_empresa);
    $buscar       = LimpiaRutFront($buscar);
    $dataPersonas = allPersonasPorEmpresaSinDivPersonaJefe($buscar, $id_empresa, $datos_usuario[0]->gerencia);
    if ($dataPersonas) {
        foreach ($dataPersonas as $dataPersonas_aux) {
            echo utf8_encode($dataPersonas_aux->nombre_completo) . " " . utf8_encode($dataPersonas_aux->rut_completo) . "" . "|" . $dataPersonas_aux->rut . "" . "|" . $dataPersonas_aux->local ." ". $dataPersonas_aux->unidad_negocio. "    \n";
            //echo utf8_encode($dataPersonas_aux->nombre)."\n";
        }
    } else {
        $data = 'No Existen Resultados';
    }
    return $data;
}

function RO_BuscaEstadoCursos($id_malla, $id_empresa, $rut, $PRINCIPAL)
{
    $arreglo_cursos = Ro_escuela_busca_cursosmalla($id_malla, $id_empresa);
    //echo "<br>";                print_r($arreglo_cursos);            echo "<br>";
    foreach ($arreglo_cursos as $arreglo_curso) {
        $arreglo = CAPACITACION_ObtenerEstadoAvanceCurso($rut, $arreglo_curso->id_curso, "", $id_empresa);
        if ($arreglo[4] >= 100) {
            $PRINCIPAL = str_replace("{ESTADO_" . $arreglo_curso->id_curso . "}", "Curso Realizado", $PRINCIPAL);
            $PRINCIPAL = str_replace("{ESTILO_ESCRO_" . $arreglo_curso->id_curso . "}", "fbox-icon-success", $PRINCIPAL);
            $PRINCIPAL = str_replace("{ICONO_ESCRO_" . $arreglo_curso->id_curso . "}", "icon-check", $PRINCIPAL);
        } elseif ($arreglo[4] > 0 and $arreglo[4] < 100) {
            $PRINCIPAL = str_replace("{ESTADO_" . $arreglo_curso->id_curso . "}", "Curso en Proceso", $PRINCIPAL);
            $PRINCIPAL = str_replace("{ESTILO_ESCRO_" . $arreglo_curso->id_curso . "}", "fbox-icon-warning", $PRINCIPAL);
            $PRINCIPAL = str_replace("{ICONO_ESCRO_" . $arreglo_curso->id_curso . "}", "icon-laptop", $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{ESTADO_" . $arreglo_curso->id_curso . "}", "Curso no Iniciado", $PRINCIPAL);
            $PRINCIPAL = str_replace("{ESTILO_ESCRO_" . $arreglo_curso->id_curso . "}", "fbox-icon", $PRINCIPAL);
            $PRINCIPAL = str_replace("{ICONO_ESCRO_" . $arreglo_curso->id_curso . "}", "icon-laptop", $PRINCIPAL);
        }
        //echo "<br>".$arreglo_curso->id_curso." rut ".$rut;
        //echo "<br>";
        //print_r($arreglo);
    }
    return ($PRINCIPAL);
}
function VerificaArregloSQLInjection($arreglo)
{
    //print_R($arreglo);
    //echo "aca";
    $flag          = "Todo Bien";
    //veo si es un arreglo
    $total_arreglo = count($arreglo);

    foreach ($arreglo as $clave => $valor) {
        //echo "El valor de $clave es: $valor<br><br>";
        //lo paso por la tabla de sql_injection
        if (strtoupper(trim($valor)) == "") {
            continue;
        }
        $valor = str_replace("'", "", $valor);
        $valor = str_replace('"', "", $valor);
        $valor = str_replace("+'", "", $valor);
        $valor = str_replace('--', "", $valor);





        $palabra_injection = buscaPalabraSqlInjection(strtoupper(trim($valor)));
        if ($palabra_injection) {
            //echo "<br><span class='badge_small badge-azul'> SQL INJECTION</span><br>";
            //echo $arreglo[$clave];
            $arreglo[$clave] = "";
            //echo "variable limpiada ".$arreglo[$clave]." <- <br>";
            //exit;
        } else {
            //Ahora traigo todas las palabras de la tabla, y las busco si estan, s
            $palabras = TraePalabraSqlInjection();
            foreach ($palabras as $pal) {
                $arreglo[$clave] = str_replace($pal->palabra, "", $arreglo[$clave]);
                $arreglo[$clave] = str_replace(strtoupper($pal->palabra), "", $arreglo[$clave]);
                $arreglo[$clave] = str_replace(strtolower($pal->palabra), "", $arreglo[$clave]);
            }
            //echo "<br>";
        }
    }
    exit;
    return ($arreglo);
}
function fechaCastellano($fecha)
{
    $fecha     = substr($fecha, 0, 10);
    $numeroDia = date('d', strtotime($fecha));
    $dia       = date('l', strtotime($fecha));
    $mes       = date('F', strtotime($fecha));
    $anio      = date('Y', strtotime($fecha));
    $dias_ES   = array(
        "Lunes",
        "Martes",
        "Mi?rcoles",
        "Jueves",
        "Viernes",
        "S?bado",
        "Domingo"
    );
    $dias_EN   = array(
        "Monday",
        "Tuesday",
        "Wednesday",
        "Thursday",
        "Friday",
        "Saturday",
        "Sunday"
    );
    $nombredia = str_replace($dias_EN, $dias_ES, $dia);
    $meses_ES  = array(
    "Enero",
        "Febrero",
        "Marzo",
        "Abril",
        "Mayo",
        "Junio",
        "Julio",
        "Agosto",
        "Septiembre",
        "Octubre",
        "Noviembre",
        "Diciembre"
    );
    $meses_EN  = array(
        "January",
        "February",
        "March",
        "April",
        "May",
        "June",
        "July",
        "August",
        "September",
        "October",
        "November",
        "December"
    );
    $nombreMes = str_replace($meses_EN, $meses_ES, $mes);
    return $nombredia . " " . $numeroDia . " de " . $nombreMes . " de " . $anio;
}

function fechaCastellano2($fecha)
{
    $fecha     = substr($fecha, 0, 10);
    $numeroDia = date('d', strtotime($fecha));
    $dia       = date('l', strtotime($fecha));
    $mes       = date('F', strtotime($fecha));
    $anio      = date('Y', strtotime($fecha));
    $dias_ES   = array(
        "Lunes",
        "Martes",
        "Mi?rcoles",
        "Jueves",
        "Viernes",
        "S?bado",
        "Domingo"
    );
    $dias_EN   = array(
        "Monday",
        "Tuesday",
        "Wednesday",
        "Thursday",
        "Friday",
        "Saturday",
        "Sunday"
    );
    $nombredia = str_replace($dias_EN, $dias_ES, $dia);
    $meses_ES  = array(
    "Enero",
        "Febrero",
        "Marzo",
        "Abril",
        "Mayo",
        "Junio",
        "Julio",
        "Agosto",
        "Septiembre",
        "Octubre",
        "Noviembre",
        "Diciembre"
    );
    $meses_EN  = array(
        "January",
        "February",
        "March",
        "April",
        "May",
        "June",
        "July",
        "August",
        "September",
        "October",
        "November",
        "December"
    );
    $nombreMes = str_replace($meses_EN, $meses_ES, $mes);
    return $numeroDia . " de " . $nombreMes . " de " . $anio;
}
function ColocaEstadosPorClasificacion($PRINCIPAL, $rut, $id_malla, $id_empresa)
{
    //Traigo las clasificaciones de esta malla de la rel_lms_malla_curso
    $clasificaciones = ClasificacionesPorMalla($id_empresa, $id_malla);
    foreach ($clasificaciones as $clas) {
        //Ahora por cada clasificacion, traigo los cursos de esta malla
        $cursos                              = CursosPorClasificacionesMalla($id_empresa, $id_malla, $clas->id_clasificacion);
        $acumulador_avance_por_clasificacion = 0;
        foreach ($cursos as $curso) {
            //Traigo los avances por dimensiones desde la tabla cierre
            $datos_cierre                        = DatosInscripcioncierreRutCursoEmpresa($rut, $curso->id_curso, $id_empresa);
            $acumulador_avance_por_clasificacion = $acumulador_avance_por_clasificacion + $datos_cierre[0]->avance;
        }
        $avance    = round($acumulador_avance_por_clasificacion / count($cursos));
        $PRINCIPAL = str_replace("{AVANCE_" . $clas->id_clasificacion . "}", $avance, $PRINCIPAL);
        if ($avance == 100) {
            $PRINCIPAL = str_replace("{ICONO_" . $clas->id_clasificacion . "}", "<img src='img/ok.png'>", $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{ICONO_" . $clas->id_clasificacion . "}", "", $PRINCIPAL);
        }
    }
    return ($PRINCIPAL);
}
function ColocaEstadColocaEstadosPorClasificacionOrderSlider($PRINCIPAL, $rut, $id_malla, $id_empresa)
{
    //Traigo las clasificaciones de esta malla de la rel_lms_malla_curso
    $clasificaciones = ClasificacionesPorMalla($id_empresa, $id_malla);
    foreach ($clasificaciones as $clas) {
        $contador++;
        //Ahora por cada clasificacion, traigo los cursos de esta malla
        $cursos                              = CursosPorClasificacionesMalla($id_empresa, $id_malla, $clas->id_clasificacion);
        $acumulador_avance_por_clasificacion = 0;
        foreach ($cursos as $curso) {
            //Traigo los avances por dimensiones desde la tabla cierre
            $datos_cierre                        = DatosInscripcioncierreRutCursoEmpresa($rut, $curso->id_curso, $id_empresa);
            $acumulador_avance_por_clasificacion = $acumulador_avance_por_clasificacion + $datos_cierre[0]->avance;
        }
        $avance_array[$contador] = round($acumulador_avance_por_clasificacion / count($cursos));
    }
    if ($avance_array[1] < "100") {
        $row_slider .= file_get_contents("views/templates/tc_slider1.html");
        $row_slider .= file_get_contents("views/templates/tc_slider2.html");
        $row_slider .= file_get_contents("views/templates/tc_slider3.html");
        $row_slider .= file_get_contents("views/templates/tc_slider4.html");
    }
    if ($avance_array[1] == "100") {
        $row_slider .= file_get_contents("views/templates/tc_slider2.html");
        $row_slider .= file_get_contents("views/templates/tc_slider3.html");
        $row_slider .= file_get_contents("views/templates/tc_slider4.html");
        $row_slider .= file_get_contents("views/templates/tc_slider1.html");
    }
    if ($avance_array[2] == "100") {
        $row_slider .= file_get_contents("views/templates/tc_slider3.html");
        $row_slider .= file_get_contents("views/templates/tc_slider4.html");
        $row_slider .= file_get_contents("views/templates/tc_slider1.html");
        $row_slider .= file_get_contents("views/templates/tc_slider2.html");
    }
    if ($avance_array[3] == "100") {
        $row_slider .= file_get_contents("views/templates/tc_slider4.html");
        $row_slider .= file_get_contents("views/templates/tc_slider1.html");
        $row_slider .= file_get_contents("views/templates/tc_slider2.html");
        $row_slider .= file_get_contents("views/templates/tc_slider3.html");
    }
    if ($avance_array[4] == "100") {
        $row_slider .= file_get_contents("views/templates/tc_slider1.html");
        $row_slider .= file_get_contents("views/templates/tc_slider2.html");
        $row_slider .= file_get_contents("views/templates/tc_slider3.html");
        $row_slider .= file_get_contents("views/templates/tc_slider4.html");
    }
    return $row_slider;
}
function Trivia_Gamificada_Desafio_Arana($PRINCIPAL, $rut, $id_curso, $id_evaluacion, $id_empresa){

//echo "<br>Trivia_Gamificada_Desafio_Arana $rut, $id_curso, $id_evaluacion, $id_empresa";
$array_dim=Triv_BuscaDimensionesArana($id_evaluacion, $id_empresa);
//echo "<br><br>dim<br>";
//print_r($array_dim);
//echo "<br><br>Res<br>";
     $j=0;
foreach($array_dim as $unico){
        //print_r($unico);
        $array_res=Triv_BuscaDatosArana($rut,$id_evaluacion, $unico->Dimension, $id_empresa);
            //echo "<br><br>res ".$unico->Dimension."<br>";
            //print_r($array_res);
            $cuento_res=0;
            $suma_res=0;
            $puntaje_prom=0;
        foreach($array_res as $unico_res){
             $cuento_res++;
             $suma_res=   $unico_res->puntaje   +   $suma_res;
        }
       $puntaje_prom=  round($suma_res/ $cuento_res);
       //echo   "<br>. dim ".$unico->Dimension." puntaje ". $puntaje_prom;
       $array_dimensiones.=      "'".($unico->Dimension)."',";
       $array_resultados.=      "".$puntaje_prom.",";
       $j++;
}

        $row .= file_get_contents("views/trivia_gamificada/".$id_empresa."_".$id_curso."_vista_profile.html");
        $row = str_replace("{AVATAR}", VerificaFotoPersonal($unico->rut), $row);
        $row = str_replace("{NOMBRE_COMPLETO}", utf8_decode($DatosUsuarioLista[0]->nombre_completo), $row);
        $row = str_replace("{TEXTO}", ($texto), $row);

        $row = str_replace("{EJE_X}", ($array_dimensiones), $row);
        $row = str_replace("{EJE_Y}", ($array_resultados), $row);

        $PRINCIPAL = str_replace("{VISTA_PERFIL_ARANA_PERSONAL}", ($row), $PRINCIPAL);

 //print_r($array_resultados);
 // print_r($array_dimensiones);
 // echo "<br>;";
 // print_r($array_resultados);
 // echo "<br>;";
     return ($PRINCIPAL);


}

function nivel_ass_obtenido($RESULTADO_PONDERADO, $id_empresa){

 if($RESULTADO_PONDERADO>=1     and $RESULTADO_PONDERADO<=1.5){  $nivel="Sin Nivel Desarrollado";}
 if($RESULTADO_PONDERADO>1.5   and $RESULTADO_PONDERADO<=2.5){  $nivel="Base";}
 if($RESULTADO_PONDERADO>2.5   and $RESULTADO_PONDERADO<=3.5){  $nivel="Medio";}
 if($RESULTADO_PONDERADO>3.5   and $RESULTADO_PONDERADO<=5){    $nivel="Experto";}
 //echo "<br>RESULTADO_PODERADO $RESULTADO_PONDERADO, nivel $nivel";
    return $nivel;

}

function ass_resultado_ajuste_final($mayor_ajuste,$nivel_ec){
 //echo    "<br>cat $mayor_ajuste,$nivel_ec";
 if($mayor_ajuste=="Sin Nivel Desarrollado"){$num_ma=1;}
 if($mayor_ajuste=="Base"){$num_ma=2;}
 if($mayor_ajuste=="Medio"){$num_ma=3;}
 if($mayor_ajuste=="Experto"){$num_ma=4;}

 if($nivel_ec=="Menor a Nivel de Referencia"){$num_ec=1;}
 if($nivel_ec=="Base"){$num_ec=2;}
 if($nivel_ec=="Medio"){$num_ec=3;}
 if($nivel_ec=="Experto"){$num_ec=4;}
 //echo    "<br>num $num_ma,$num_ec";

 $promedio=round(($num_ma+$num_ec)/2,2);
// echo "<br>$num_ma+$num_ec,promedio $promedio";

 if($promedio>=1        and $promedio<=1.5){    $nivelf="Sin Nivel Desarrollado";}
 if($promedio>1.5       and $promedio<=2.5){    $nivelf="Base";}
 if($promedio>2.5       and $promedio<=3.5){    $nivelf="Medio";}
 if($promedio>3.5       and $promedio<=5){      $nivelf="Experto";}
 //echo "<br>nivel final $nivelf";
 return  $nivelf;
}

function nivel_ass_obtenido_num($RESULTADO_PONDERADO, $id_empresa){

 if($RESULTADO_PONDERADO>=1     and $RESULTADO_PONDERADO<=1.5){  $nivel="1";}
 if($RESULTADO_PONDERADO>1.5   and $RESULTADO_PONDERADO<=2.5){  $nivel="2";}
 if($RESULTADO_PONDERADO>2.5   and $RESULTADO_PONDERADO<=3.5){  $nivel="3";}
 if($RESULTADO_PONDERADO>3.5   and $RESULTADO_PONDERADO<=5){    $nivel="4";}
 //echo "<br>RESULTADO_PONDERADO $RESULTADO_PONDERADO";
 return $nivel;

}

function nivel_ass_ec_obtenido($resultado_ec){

 if($resultado_ec>=0     and $resultado_ec<=12)     {  $nivel="Menor a Nivel de Referencia";}
 if($resultado_ec>12   and $resultado_ec<=22)       {  $nivel="Base";}
 if($resultado_ec>22   and $resultado_ec<=33)       {  $nivel="Medio";}
 if($resultado_ec>33   and $resultado_ec<=50)       {  $nivel="Experto";}
 //echo "<br>RESULTADO_PONDERADO $RESULTADO_PONDERADO";
    return $nivel;

}


function ajuste_ass_obtenido($RESULTADO_PONDERADO, $id_empresa){

 if($RESULTADO_PONDERADO>=70 )                              {  $nivel="Alto Ajuste";}
 if($RESULTADO_PONDERADO>=40 and $RESULTADO_PONDERADO<70)   {  $nivel="Ajuste Medio";}
 if($RESULTADO_PONDERADO>=0 and $RESULTADO_PONDERADO<40)    {  $nivel="Bajo Ajuste";}

    //echo "<br>RESULTADO_PONDERADO $RESULTADO_PONDERADO, nivel  $nivel";
    return $nivel;

}

function Ass_Desafio_Profile_Arana($PRINCIPAL, $rut_col, $id_inst, $nivel, $tipoarana, $id_empresa){
    //echo "<br> Ass_Desafio_Profile_Arana  $rut_col, $id_inst, $nivel, $tipoarana, $id_empresa";
    $id_empresa = $_SESSION["id_empresa"];
    $array_Skill_cargo  =   Skill_Busca_datos_id_Cargo($id_inst, $id_empresa);
//echo "nivel $nivel";
$desajuste_positivo_base=0;     $ajuste_perfecto_base=0;   $desajuste_negativo_base=0;
$desajuste_positivo_medio=0;    $ajuste_perfecto_medio=0;  $desajuste_negativo_medio=0;
$desajuste_positivo_experto=0;  $ajuste_perfecto_experto=0;$desajuste_negativo_experto=0;
$cuentalineas=0;
foreach($array_Skill_cargo as $unico){
    //echo "<br>".$unico->id_skill;
    $array_respuestas=Ass_busca_rut_ins_perfil_respuestas_x_skill($rut_col, $id_inst, $unico->id_skill, $id_empresa);

    if($array_respuestas[0]->col_respuesta==1)  {$col_respuesta=1;}
    if($array_respuestas[0]->col_respuesta==2)  {$col_respuesta=2;}
    if($array_respuestas[0]->col_respuesta==3)  {$col_respuesta=3;}
    if($array_respuestas[0]->col_respuesta==4)  {$col_respuesta=4;}

    if($array_respuestas[0]->jefe_respuesta==1) {$jefe_respuesta=1;}
    if($array_respuestas[0]->jefe_respuesta==2) {$jefe_respuesta=2;}
    if($array_respuestas[0]->jefe_respuesta==3) {$jefe_respuesta=3;}
    if($array_respuestas[0]->jefe_respuesta==4) {$jefe_respuesta=4;}

    $RESULTADO_PONDERADO        =round($col_respuesta*50)/100 + ($jefe_respuesta*50)/100;
    $RESULTADO_PONDERADO_NUM    =round($array_respuestas[0]->col_respuesta*50)/100 + ($array_respuestas[0]->jefe_respuesta*50)/100;
    $texto_nivel                =nivel_ass_obtenido($RESULTADO_PONDERADO_NUM, $id_empresa);
    $texto_nivel_num            =nivel_ass_obtenido_num($RESULTADO_PONDERADO_NUM, $id_empresa);

    $res_esperado               =Ass_Busca_nivel_esperado_skill_cargo($id_inst, $unico->id_skill, $nivel,      $id_empresa);

    if($res_esperado=="")   {$espe_respuesta=0;}
    if($res_esperado==1)    {$espe_respuesta=1;}
    if($res_esperado==2)    {$espe_respuesta=2;}
    if($res_esperado==3)    {$espe_respuesta=3;}
    if($res_esperado==4)    {$espe_respuesta=4;}

     $cuentalineas++;

        //$array_dimensiones.=      "'skill_".($unico->id_skill)."',";
        $col_progreso=round(    ((50*$col_respuesta)/100) + ((50*$jefe_respuesta)/100));

        $array_resultados_progreso.= "".$col_progreso.",";
        $array_resultados_col.=      "".$col_respuesta.",";
        $array_resultados_jefe.=      "".$jefe_respuesta.",";
        $array_resultados_esperado.=    "".$espe_respuesta.",";
        $ejex.="'".$unico->id_skill."',";
        $j++;
}
/*
echo "ejex $ejex
<br> array_resultados_col $array_resultados_col
<br> array_resultados_jefe $array_resultados_jefe
<br> array_resultados_esperado $array_resultados_esperado";
*/
//exit();
        $mi_progreso= "";

       $row .= file_get_contents("views/assessment/".$id_empresa."_vista_arana_small_".$nivel.".html");


        $row = str_replace("{AVATAR}", VerificaFotoPersonal($unico->rut), $row);
        $row = str_replace("{NOMBRE_COMPLETO}", utf8_decode($DatosUsuarioLista[0]->nombre_completo), $row);
        $row = str_replace("{TEXTO}", ($texto), $row);

        $row = str_replace("{EJE_X}", ($ejex), $row);
        $row = str_replace("{EJE_Y_AE}", ($array_resultados_col), $row);
        $row = str_replace("{EJE_Y_CJ}", ($array_resultados_jefe), $row);
        $row = str_replace("{EJE_Y_ESP}", ($array_resultados_esperado), $row);
        $row = str_replace("{NOMBRE_ARANA}", "Profile_AranaNivel0", $row);

        $row = str_replace("{NIVEL_ESPERADO}", $nivel, $row);
        //echo "<br>nivel $nivel, tipoarana $tipoarana";
        $PRINCIPAL = str_replace("{VISTA_ASS_PERFIL_ARANA_SMALL_PROFILE_".$nivel."}", ($row), $PRINCIPAL);

        $PRINCIPAL = str_replace("{VISTA_ASS_PERFIL_ARANA_PROFILE}", ($row), $PRINCIPAL);

        return ($PRINCIPAL);


}

function Ass_Desafio_Profile_Arana_MayorAjuste($PRINCIPAL, $rut_col, $id_inst, $nivel, $tipoarana, $id_empresa){
    //echo "<br> Ass_Desafio_Profile_Arana  $rut_col, $id_inst, $nivel, $tipoarana, $id_empresa";
    $id_empresa = $_SESSION["id_empresa"];
    $array_Skill_cargo  =   Skill_Busca_datos_id_Cargo($id_inst, $id_empresa);
//echo "nivel $nivel";
$desajuste_positivo_base=0;     $ajuste_perfecto_base=0;   $desajuste_negativo_base=0;
$desajuste_positivo_medio=0;    $ajuste_perfecto_medio=0;  $desajuste_negativo_medio=0;
$desajuste_positivo_experto=0;  $ajuste_perfecto_experto=0;$desajuste_negativo_experto=0;
$cuentalineas=0;
foreach($array_Skill_cargo as $unico){
    //echo "<br>".$unico->id_skill;
    $array_respuestas=Ass_busca_rut_ins_perfil_respuestas_x_skill($rut_col, $id_inst, $unico->id_skill, $id_empresa);

    if($array_respuestas[0]->col_respuesta==1)  {$col_respuesta=1;}
    if($array_respuestas[0]->col_respuesta==2)  {$col_respuesta=2;}
    if($array_respuestas[0]->col_respuesta==3)  {$col_respuesta=3;}
    if($array_respuestas[0]->col_respuesta==4)  {$col_respuesta=4;}

    if($array_respuestas[0]->jefe_respuesta==1) {$jefe_respuesta=1;}
    if($array_respuestas[0]->jefe_respuesta==2) {$jefe_respuesta=2;}
    if($array_respuestas[0]->jefe_respuesta==3) {$jefe_respuesta=3;}
    if($array_respuestas[0]->jefe_respuesta==4) {$jefe_respuesta=4;}

    $RESULTADO_PONDERADO        =round($col_respuesta*50)/100 + ($jefe_respuesta*50)/100;
    $RESULTADO_PONDERADO_NUM    =round($array_respuestas[0]->col_respuesta*50)/100 + ($array_respuestas[0]->jefe_respuesta*50)/100;
    $texto_nivel                =nivel_ass_obtenido($RESULTADO_PONDERADO_NUM, $id_empresa);
    $texto_nivel_num            =nivel_ass_obtenido_num($RESULTADO_PONDERADO_NUM, $id_empresa);

    $res_esperado               =Ass_Busca_nivel_esperado_skill_cargo($id_inst, $unico->id_skill, $nivel,      $id_empresa);

    if($res_esperado=="")   {$espe_respuesta=0;}
    if($res_esperado==1)    {$espe_respuesta=1;}
    if($res_esperado==2)    {$espe_respuesta=2;}
    if($res_esperado==3)    {$espe_respuesta=3;}
    if($res_esperado==4)    {$espe_respuesta=4;}

     $cuentalineas++;

        //$array_dimensiones.=      "'skill_".($unico->id_skill)."',";
        $col_progreso=round(    ((50*$col_respuesta)/100) + ((50*$jefe_respuesta)/100));

        $array_resultados_progreso.= "".$col_progreso.",";
        $array_resultados_col.=      "".$col_respuesta.",";
        $array_resultados_jefe.=      "".$jefe_respuesta.",";
        $array_resultados_esperado.=    "".$espe_respuesta.",";
        $ejex.="'".$unico->id_skill."',";
        $j++;
}
/*
echo "ejex $ejex
<br> array_resultados_col $array_resultados_col
<br> array_resultados_jefe $array_resultados_jefe
<br> array_resultados_esperado $array_resultados_esperado";
*/
//exit();
        $mi_progreso= "";
    $row .= file_get_contents("views/assessment/".$id_empresa."_vista_arana.html");
        //echo "<br>template <br>views/assessment/".$id_empresa."_vista_arana.html";


        $row = str_replace("{AVATAR}", VerificaFotoPersonal($unico->rut), $row);
        $row = str_replace("{NOMBRE_COMPLETO}", utf8_decode($DatosUsuarioLista[0]->nombre_completo), $row);
        $row = str_replace("{TEXTO}", ($texto), $row);

        $row = str_replace("{EJE_X}", ($ejex), $row);
        $row = str_replace("{EJE_Y_AE}", ($array_resultados_col), $row);
        $row = str_replace("{EJE_Y_CJ}", ($array_resultados_jefe), $row);
        $row = str_replace("{EJE_Y_ESP}", ($array_resultados_esperado), $row);
        $row = str_replace("{NOMBRE_ARANA}", "Profile_AranaNivel0", $row);

        $row = str_replace("{NIVEL_ESPERADO}", $nivel, $row);
        //echo "<br>nivel $nivel, tipoarana $tipoarana";

        $PRINCIPAL = str_replace("{VISTA_ASS_PERFIL_ARANA_MAYORAJUSTE}", ($row), $PRINCIPAL);

        return ($PRINCIPAL);


}

function buscaarrobadomain($texto, $id_mp, $rut, $id_empresa)
{
   // echo "<br>texto $texto";
    $porciones = explode("@", $texto);
   // print_R($porciones);   sleep(2);

    for ($i = 0; $i < count($porciones); $i++) {
           //echo   "<br>porciones ".$porciones[$i];
            $texto=str_replace(' ', '_', $texto);
            $texto=str_replace(',', '_', $texto);
            $texto=str_replace(';', '_', $texto);
            $texto=str_replace('-', '_', $texto);
            $texto=str_replace('_', '_', $texto);
                    $porcionesX = explode("_", $texto);
                    for ($j = 0; $j < count($porcionesX); $j++) {
                     // echo   "<br>porciones X ".$porcionesX[$j];
                     if(substr( $porcionesX[$j], 0, 1 ) === "@"){
                       // echo $porcionesX[$j];

                       $arreglo[]= $porcionesX[$j];

                      }

                    }

                    //echo "<br> arreglo";



        }
    $i=0;
    $arreglo=(array_unique($arreglo));
    //print_r($arreglo);
    foreach ($arreglo as $unico){
       // echo "UNICO $unico";
      $tagueados[$i] = SaveMpTagPeople($unico, $id_mp, $rut, $id_empresa);
      $i++;
    }
                    // echo "<br>";sleep(4);


      // print_r($tagueados); exit();

        return $tagueados;
}

function lms_busca_carrusel_ultimos_diez($rut, $tipofiltro, $filtroreportes, $id_empresa){

        $DatosUsuario=UsuarioEnBasePersonaPorEmpresa($rut, $id_empresa);
        $dato= $DatosUsuario[0]-> $tipofiltro;
        $campo=  $filtroreportes;

        $lista_rut_diez=lms_busca_carrusel_ultimos_diez_data($campo, $dato, $id_empresa);
        //print_r($lista_rut_diez);
           foreach ($lista_rut_diez as $unico){
        $array_data          =lms_busca_ultimo_curso_aprobado_data($unico->rut, $id_empresa);
        $DatosUsuarioLista   =UsuarioEnBasePersonaPorEmpresa($array_data[0]->rut, $id_empresa);
        $DatosCursoLista     =DatosCursoTodos($array_data[0]->id_curso);

    /*  echo "<br><br> data array_data <br>"; print_r($array_data);
    echo "<br><br> DatosUsuarioLista <br>"; print_r($DatosUsuarioLista);
    echo "<br><br> DatosCursoLista <br>"; print_r($DatosCursoLista);   */

    if($array_data[0]->resultado>0)
        {$texto="Aprob? el curso <br>".utf8_encode($DatosCursoLista[0]->nombre)." con un ".$array_data[0]->resultado."%";}  else
        {$texto="Finaliz? el curso <br>".utf8_encode($DatosCursoLista[0]->nombre)."";}
        $row .= file_get_contents("views/carrusel_personas/".$id_empresa."_row_carrusel_personas.html");
        $row = str_replace("{AVATAR}", VerificaFotoPersonal($unico->rut), $row);
        $row = str_replace("{NOMBRE_COMPLETO}", utf8_decode($DatosUsuarioLista[0]->nombre_completo), $row);
        $row = str_replace("{TEXTO}", ($texto), $row);


           }

           // echo "<br>row<br>";
           //print_r($row); exit();
          return ($row);
}

function lms_busca_carrusel_top_diez_perfil_puntos_medallas($rut, $id_empresa){

        $DatosUsuario=UsuarioEnBasePersonaPorEmpresa($rut, $id_empresa);
        $perfil= $DatosUsuario[0]-> tipo_cargo;

        $lista_rut_diez=lms_busca_carrusel_top_diez_perfil_puntos_medallas_data($perfil, $id_empresa);
            //print_r($lista_rut_diez);
        foreach ($lista_rut_diez as $unico){
        $row .= file_get_contents("views/carrusel_personas/".$id_empresa."_row_carrusel_personas_puntos.html");
        $row = str_replace("{AVATAR}", VerificaFotoPersonal($unico->rut), $row);
        $row = str_replace("{NOMBRE_COMPLETO}", utf8_encode($unico->nombre_completo), $row);
        $row = str_replace("{PUNTOS}", ($unico->puntos), $row);
        $SaldoPuntosLG=premios_buscadatos($unico->rut, $id_empresa);
        $row = str_replace("{PUNTOS_CANJE_USUARIO}", $SaldoPuntosLG[0]->puntossaldo, $row);
        $row = str_replace("{MEDALLAS}", ($unico->medallas), $row);
           }
           // echo "<br>row<br>";
           //print_r($row); exit();
          return ($row);
}

function lms_busca_carrusel_programa_ultimos_diez($id_programa, $id_empresa){



        $lista_rut_diez=lms_busca_carrusel_programa_ultimos_diez_data($id_programa, $id_empresa);
      // print_r($lista_rut_diez);
           foreach ($lista_rut_diez as $unico){
           // print_r($unico);
        $DatosUsuarioLista   =UsuarioEnBasePersonaPorEmpresa($unico->rut, $id_empresa);




        $row .= file_get_contents("views/carrusel_personas/".$id_empresa."_row_carrusel_personas.html");
        $row = str_replace("{AVATAR}", VerificaFotoPersonal($unico->rut), $row);
        $row = str_replace("{NOMBRE_COMPLETO}", utf8_decode($DatosUsuarioLista[0]->nombre_completo), $row);
        $row = str_replace("{TEXTO}", "", $row);



           }

           // echo "<br>row<br>";
          // print_r($row); exit();
          return ($row);
}

function lms_busca_lms_sliders_ultimos_diez($rut, $tipofiltro, $filtroreportes, $id_empresa){



        $lista_rut_diez=lms_busca_carrusel_sliders_ultimos_diez_data($campo, $dato, $id_empresa);
        foreach ($lista_rut_diez as $unico){

        $row .= file_get_contents("views/slider/".$id_empresa."_lms_slider_row.html");
        $row = str_replace("{IMAGEN_LMS_SLIDER}", ($unico->foto), $row);
        $row = str_replace("{TEXTO_LMS_SLIDER_CONTENIDO}", $unico->mensaje, $row);


           }

           // echo "<br>row<br>";
           //print_r($row); exit();
          return ($row);
}

function lms_busca_lms_sliders_ultimos_programa_diez($rut, $id_programa, $id_empresa){



        $lista_rut_diez=lms_busca_carrusel_sliders_ultimos_diez_data($campo, $dato, $id_empresa);
        foreach ($lista_rut_diez as $unico){

        $row .= file_get_contents("views/slider/".$id_empresa."_lms_slider_row.html");
        $row = str_replace("{IMAGEN_LMS_SLIDER}", ($unico->foto), $row);
        $row = str_replace("{TEXTO_LMS_SLIDER_CONTENIDO}", $unico->mensaje, $row);


           }

           // echo "<br>row<br>";
           //print_r($row); exit();
          return ($row);
}

function ColocaMegustaNomegustaPorReply($html, $id_reply, $rut, $id_mp)
{
    //Primero veo si tiene o no tiene megusta para el REPLY
    $id_empresa          = $_SESSION["id_empresa"];
    $tiene_megusta_reply = COMUNIDAD_ReplyTieneMegusta($id_reply, $rut, $id_mp);
    if ($tiene_megusta_reply) {
        $html = str_replace("{BLOQUE_MEGUSTA_POST_REPLY}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta_post_reply.html"), $html);
        $html = str_replace("{ID_REPLY}", $id_reply, $html);
        $html = str_replace("{ID_MP}", $id_mp, $html);
    } else {
        $html = str_replace("{BLOQUE_MEGUSTA_POST_REPLY}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta_post_reply.html"), $html);
    }
    $html                 = str_replace("{ID_REPLY}", $id_reply, $html);
    $html                 = str_replace("{ID_MP}", $id_mp, $html);
    $total_megusta_global = COMUNIDAD_ReplyTieneMegustaGlobal($id_reply, $id_mp);
    $html                 = str_replace("{CANTIDAD_MEGUSTA_POR_REPLY}", count($total_megusta_global), $html);
    return ($html);
}
function MuestraReplyPorReply($id_mp, $id_reply)
{
    //Traigo los comentarios por Reply Reply
    $comentarios_reply_reply = COMUNIDAD_ReplyPorReply($id_mp, $id_reply);
    foreach ($comentarios_reply_reply as $reply) {
        $row_reply_reply .= file_get_contents("views/comunidad_mp/row_comentario_mp_persona_listado_reply_reply.html");
        $row_reply_reply = str_replace("{COMENTARIO_REPLY_REPLY}", $reply->comentario, $row_reply_reply);
        $row_reply_reply = str_replace("{NOMBRE_AUTOR_REPLY_REPLY}", $reply->nombre_completo, $row_reply_reply);
        $row_reply_reply = str_replace("{FOTO_AUTOR_REPLY_REPLY}", VerificaFotoPersonal($reply->rut), $row_reply_reply);
        $row_reply_reply = str_replace("{FECHA_REPLY_REPLY}", ($reply->fecha), $row_reply_reply);
    }
    return (utf8_encode($row_reply_reply));
}
function XSendMailpPhpMailerRod($to, $nombrefrom, $from, $subject, $message)
{
    // using SendGrid's PHP Library
    // https://github.com/sendgrid/sendgrid-php
    // If you are using Composer (recommended)
    //require 'vendor/autoload.php';
    // If you are not using Composer
    require("script/sendgrid-php/sendgrid-php.php");
    $from     = new SendGrid\Email("Notificaciones Bci", "notificaciones@bci.cl");
    $subject  = "Probando env?os de emails desde plataforma via Api Google";
    $to       = new SendGrid\Email("rod", "rod@gop.cl");
    $content  = new SendGrid\Content("text/plain", $message);
    $mail     = new SendGrid\Mail($from, $subject, $to, $content);
    $apiKey   = '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';
    $sg       = new \SendGrid($apiKey);
    $response = $sg->client->mail()->send()->post($mail);
    echo $response->statusCode();
    print_r($response->headers());
    echo $response->body();
}


function SendGrid_Email($to, $nombreto, $from, $nombrefrom, $tipo, $subject, $titulo1, $subtitulo1, $texto1, $url,
$texto_url, $texto2, $texto3, $texto4, $logo, $id_empresa, $url, $tipomensaje, $rut, $key, $otro_template)
{


 if($tipo==""){$tipo="text/html";}

 if($id_empresa==""){
        $id_empresa = $_SESSION["id_empresa"];
    }

  //echo $otro_template;


        $message = file_get_contents("views/emails_notificaciones/" . $id_empresa . "_template_notificacion.html");
        //echo " template normal ";
       // echo "/views/emails_notificaciones/" . $id_empresa . "_template_notificacion.html";

  

//   echo "<br>";
 //  echo "https://".$_SERVER['SERVER_NAME']."/front/views/emails_notificaciones/".$id_empresa."_template_notificacion.html";
  // echo "<br>";


 /* echo "<br>SendGrid_Email<br>
     <br>to $to,
     <br>nombreto $nombreto,
     <br>from $from, <br>nombrefrom $nombrefrom,
     <br> tipo $tipo,<br>
     subject $subject,<br> titulo1 $titulo1,
     <br> subtitulo1 $subtitulo1,<br>texto1 $texto1,<br>url $url,<br>txto url $texto_url,
     <br>texto2 $texto2, <br>texto3 $texto3, <br>texto4 $texto4, <br>logo $logo, <br>id_empresa $id_empresa, <br>url $url, <br>tipomensaje $tipomensaje,<br>    rut $rut,
     <br>key $key,<br>otro_template $otro_template";
   */

    $message = str_replace("{TITULO1}", $titulo1, $message);
    $message = str_replace("{SUBTITULO1}", $subtitulo1, $message);
    $message = str_replace("{TEXTO1}", $texto1, $message);
    $message = str_replace("{URL}", $url, $message);
    $message = str_replace("{TEXTO_URL}", $texto_url, $message);
    $message = str_replace("{TEXTO2}", $texto2, $message);
    $message = str_replace("{TEXTO3}", $texto3, $message);
    $message = str_replace("{TEXTO4}", $texto4, $message);
    $message = str_replace("{LOGO}", $logo, $message);

    require("script/sendgrid-php/sendgrid-php.php");
    $from       = new SendGrid\Email($nombrefrom, $from);
    $to         = new SendGrid\Email($nombreto, $to);
    $content    = new SendGrid\Content($tipo, $message);
    $mail       = new SendGrid\Mail($from, $subject, $to, $content);
    $apiKey     = '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';
    $sg         = new \SendGrid($apiKey);
    $response   = $sg->client->mail()->send()->post($mail);

   //echo "<br>mensaje<br><br>$message";

    $statuscode = $response->statusCode();
    $headers    = $response->headers();
    $body       = $response->body();
    $fecha      = date("Y-m-d");
/*
echo "<br><br>statuscode_";    print_r($statuscode);
echo "<br><br>headers_";        print_r($headers);
echo "<br><br>body_";       print_r($body);
exit();*/

SaveLogEmails($id_empresa, $tipo, $subject, $to, $nombreto, $fecha, $statuscode, $headers, $body, $tipomensaje, $rut, $key);
}


function SendGrid_Email_template($to, $nombreto, $from, $nombrefrom, $tipo, $subject, $titulo1, $subtitulo1, $texto1, $url, $texto_url, $texto2, $texto3, $texto4, $logo, $id_empresa, $url, $tipomensaje, $rut, $key, $template)
{

      if($id_empresa==""){ $id_empresa = $_SESSION["id_empresa"];}

    //$to="rod@gop.cl";

// echo "<br>SendGrid_Email_template<br><br>to $to, nombre $nombreto, from $from, nombre $nombrefrom, tipo $tipo,<br>
// subject $subject, titulo1 $titulo1, subtitulo1 $subtitulo1, t1 $texto1,url $url, texto url $texto_url, texto2 $texto2,
// texto3 $texto3, texto4 $texto4,
// logo $logo, idempresa $id_empresa, url $url, tipomensaje $tipomensaje, rut $rut, key $key template $template";
 //echo "<br>";    echo "https://".$_SERVER['SERVER_NAME']."/front/views/emails_notificaciones/".$id_empresa."_template_notificacion.html";    echo "<br>";

    $message = file_get_contents("".$template."");
    //echo "<br>message url $message";
    $message = str_replace("{TITULO1}", $titulo1, $message);
    $message = str_replace("{SUBTITULO1}", $subtitulo1, $message);
    $message = str_replace("{TEXTO1}", $texto1, $message);
    $message = str_replace("{URL}", $url, $message);
    $message = str_replace("{TEXTO_URL}", $texto_url, $message);
    $message = str_replace("{TEXTO2}", $texto2, $message);
    $message = str_replace("{TEXTO3}", $texto3, $message);
    $message = str_replace("{TEXTO4}", $texto4, $message);
    $message = str_replace("{LOGO}", $logo, $message);

    require("script/sendgrid-php/sendgrid-php.php");
    $from       = new SendGrid\Email($nombrefrom, $from);
    $to         = new SendGrid\Email($nombreto, $to);
    $content    = new SendGrid\Content($tipo, $message);
    $mail       = new SendGrid\Mail($from, $subject, $to, $content);
    $apiKey     = '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';
    $sg         = new \SendGrid($apiKey);
    $response   = $sg->client->mail()->send()->post($mail);
    $statuscode = $response->statusCode();
    $headers    = $response->headers();
    $body       = $response->body();
    $fecha      = date("Y-m-d");

    //echo "<br><br>statuscode_";    print_r($statuscode);   echo "<br><br>headers_";    print_r($headers);    echo "<br><br>body_";    print_r($body); sleep(10);
    SaveLogEmails($id_empresa, $tipo, $subject, $to, $nombreto, $fecha, $statuscode, $headers, $body, $tipomensaje, $rut, $key);
}

function SendGrid_Email_Gcloud($to, $nombreto, $from, $nombrefrom, $tipo, $subject, $titulo1, $subtitulo1, $texto1, $url, $texto_url, $texto2, $texto3, $texto4, $logo, $id_empresa, $url, $tipomensaje, $rut, $key)
{

    //echo "ro $to, $nombreto, $from, $nombrefrom, $tipo, $subject, $titulo1,$subtitulo1,$texto1,$url,$texto_url, $texto2, $texto3, $texto4, $logo, $id_empresa, $url,$tipomensaje, $rut, $key";
    $message = file_get_contents("https://gcloud.cl/front/views/emails_notificaciones/gcloud_template_notificacion.html");
    //$message =file_get_contents("views/emails_notificaciones/gcloud_template_notificacion.html");
    $message = str_replace("{TITULO1}", $titulo1, $message);
    $message = str_replace("{SUBTITULO1}", $subtitulo1, $message);
    $message = str_replace("{TEXTO1}", $texto1, $message);
    $message = str_replace("{URL}", $url, $message);
    $message = str_replace("{TEXTO_URL}", $texto_url, $message);
    $message = str_replace("{TEXTO2}", $texto2, $message);
    $message = str_replace("{TEXTO3}", $texto3, $message);
    $message = str_replace("{TEXTO4}", $texto4, $message);
    $message = str_replace("{LOGO}", $logo, $message);
    require("script/sendgrid-php/sendgrid-php.php");
    $from       = new SendGrid\Email($nombrefrom, $from);
    $to         = new SendGrid\Email($nombreto, $to);
    $content    = new SendGrid\Content($tipo, $message);
    $mail       = new SendGrid\Mail($from, $subject, $to, $content);
    $apiKey     = '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';
    $sg         = new \SendGrid($apiKey);
    $response   = $sg->client->mail()->send()->post($mail);
    //echo "$message";
    $statuscode = $response->statusCode();
    $headers    = $response->headers();
    $body       = $response->body();
    $fecha      = date("Y-m-d");
    //echo "<br><br>statuscode_";
    //print_r($statuscode);
    //echo "<br><br>headers_";
    //print_r($headers);
    //echo "<br><br>tipo_";
    //print_r($tipo);
    //echo "<br><br>body_";
    //print_r($body);
    sleep(3);
    SaveLogEmails($id_empresa, $tipo, $subject, $to, $nombreto, $fecha, $statuscode, $headers, $body, $tipomensaje, $rut, $key);
}


function XSendMailpPhpMailer09112017SinUser()
{
    $mail      = new PHPMailer();
    $to        = 'daniel@gop.cl';
    $from      = "notiicacion@bci.cl";
    $from_name = 'Test';
    $mail->IsSMTP(); // enable SMTP
    $mail->SMTPDebug = 2; // debugging: 1 = errors and messages, 2 = messages only
    $mail->SMTPAuth  = false; // authentication enabled
    $mail->Host      = 'smtp-relay.gmail.com';
    $mail->Port      = 25;
    //$mail->AddReplyTo("test@xxx.in");
    $mail->SetFrom($from, $from_name);
    $mail->Subject = 'Test';
    $mail->Body    = 'Test';
    $mail->AddAddress($to);
    if (!$mail->Send()) {
        $error = 'Mail error: ' . $mail->ErrorInfo;
        return false;
    } else {
        $error = 'Message sent!';
        return true;
    }
}
function XSendMailpPhpMailer09112017($to, $nombrefrom, $from, $subject, $message)
{
    //echo "$to,$nombrefrom,$from,$subject,$message";
    $mail = new PHPMailer();
    $mail->SetFrom($from, $nombrefrom);
    $mail->FromName = $nombrefrom;
    $mail->Subject  = $subject;
    $mail->Helo     = 'gop.cl';
    $mail->IsSMTP();
    $mail->SMTPSecure = "ssl";
    $mail->Host       = 'smtp-relay.gmail.com';
    $mail->Port       = 465;
    $mail->SMTPAuth   = false;
    $mail->Body       = $message;
    $mail->AltBody    = "";
    $mail->IsHTML(true);
    $mail->AddAddress($to);
    if (!$mail->Send()) {
        $error_message = "Mailer Error: " . $mail->ErrorInfo;
        echo $error_message;
    } else {
        $error_message = "Successfully sent!";
    }
    //if(!$mail->Send())
    //            return -1;
    // Clear all addresses and attachments for next loop
    $mail->ClearAddresses();
    $mail->ClearAttachments();
}
function ColocaCheckPorDia($PRINCIPAL, $id_empresa, $rut_jefe, $rut_colaborador, $dia)
{
    $datos_colaborador = UsuarioEnBasePersonas($rut_colaborador);
    $PRINCIPAL         = str_replace("{NOMBRE_COLABORADOR_CHECK}", $datos_colaborador[0]->nombre_completo, $PRINCIPAL);
    $PRINCIPAL         = str_replace("{DIA}", $dia, $PRINCIPAL);
    $PRINCIPAL         = str_replace("{RUT_COLABORADOR}", $rut_colaborador, $PRINCIPAL);
    $PRINCIPAL         = str_replace("{DIA}", $dia, $PRINCIPAL);
    $actividades       = CHECK_LIST_PreguntasPorDia($dia);
    $titulo            = "";
    foreach ($actividades as $act) {
        if ($titulo <> $act->actividad) {
            $row_actividad .= file_get_contents("views/home/home_esc_bp_jof_pregunta_titulo.html");
            $row_actividad = str_replace("{TITULO}", $act->actividad, $row_actividad);
            $titulo        = $act->actividad;
        } else {
            $titulo = $act->actividad;
        }
        $row_actividad .= file_get_contents("views/home/home_esc_bp_jof_pregunta.html");
        $row_actividad = str_replace("{PAUTA_OBSERVACION}", $act->pauta, $row_actividad);
        $row_actividad = str_replace("{ID_ACTIVIDAD}", $act->id, $row_actividad);
    }
    $PRINCIPAL = str_replace("{BLOQUE_CHECK_LIST}", utf8_encode($row_actividad), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaColaboradoresDeCampoLider($PRINCIPAL, $id_empresa, $rut_lider)
{
    $colaboradores = LIDER_Colaboradores($rut_lider, $id_empresa);
    foreach ($colaboradores as $col) {
        $row_equipo .= file_get_contents("views/mi_equipo_lider/" . $id_empresa . "_row_equipo_campo_lider.html");
        $malla_colaborador = LMSMallaEcuelaBP($col->rut, $id_empresa);
        $row_equipo        = str_replace("{NOMBRE}", $col->nombre_completo, $row_equipo);
        $row_equipo        = str_replace("{CARGO}", $col->cargo, $row_equipo);
        $row_equipo        = str_replace("{GERENCIA}", $col->gerencia, $row_equipo);
        if ($malla_colaborador[0]->id_malla == "bci_escbp_ola7") {
            $row_equipo = str_replace("{LINK_EVALUACION}", "
            <a href='?sw=checjof&d=" . Encodear3(11) . "&re=" . Encodear3($col->rut) . "' style='color:#000000'>Check Dia 1</a><br>
            <a href='?sw=checjof&d=" . Encodear3(12) . "&re=" . Encodear3($col->rut) . "' style='color:#000000'>Check Dia 2</a><br>
            <a href='?sw=checjof&d=" . Encodear3(13) . "&re=" . Encodear3($col->rut) . "' style='color:#000000'>Check Dia 3</a><br>
            <a href='?sw=checjof&d=" . Encodear3(14) . "&re=" . Encodear3($col->rut) . "' style='color:#000000'>Check Dia 4</a><br>
            <a href='?sw=checjof&d=" . Encodear3(15) . "&re=" . Encodear3($col->rut) . "' style='color:#000000'>Check Dia 5</a><br>
            <a href='?sw=checjof&d=" . Encodear3(16) . "&re=" . Encodear3($col->rut) . "' style='color:#000000'>Check Dia 6</a><br>
            <a href='?sw=checjof&d=" . Encodear3(17) . "&re=" . Encodear3($col->rut) . "' style='color:#000000'>Check Dia 7</a><br>
            <br>
            ", $row_equipo);
        } else {
            $row_equipo = str_replace("{LINK_EVALUACION}", "
            <a href='?sw=checjof&d=" . Encodear3(1) . "&re=" . Encodear3($col->rut) . "' style='color:#000000'>Check Dia 1</a><br>
            <a href='?sw=checjof&d=" . Encodear3(2) . "&re=" . Encodear3($col->rut) . "' style='color:#000000'>Check Dia 2</a><br>
            <a href='?sw=checjof&d=" . Encodear3(3) . "&re=" . Encodear3($col->rut) . "' style='color:#000000'>Check Dia 3</a><br>
            <a href='?sw=checjof&d=" . Encodear3(4) . "&re=" . Encodear3($col->rut) . "' style='color:#000000'>Check Dia 4</a><br>
            <a href='?sw=checjof&d=" . Encodear3(5) . "&re=" . Encodear3($col->rut) . "' style='color:#000000'>Check Dia 5</a><br>
            <a href='?sw=checjof&d=" . Encodear3(6) . "&re=" . Encodear3($col->rut) . "' style='color:#000000'>Check Dia 6</a><br>
            <br>
            ", $row_equipo);
        }
        $row_equipo = str_replace("{URL_PERSONA}", VerificaFotoPersonal($col->rut), $row_equipo);
    }
    $PRINCIPAL = str_replace("{ROW_COLABORADORES}", $row_equipo, $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaLinksPorPEstanas($PRINCIPAL, $rut_embajador, $rut_r2, $id_empresa)
{
    $datos_reunion_inicial       = EMBAJADORES_DatosPlanReunionInicial($id_empresa, $rut_embajador, $rut_r2);
    $estado_embajador            = ObtenerPorcentajeAvanceSemana3($datos_reunion_inicial[0]->rut, $id_empresa, $datos_reunion_inicial[0]->tutor, $datos_reunion_inicial[0]->r2);
    $estado_embajador_validacion = EstadoAvanceValidacionesEmbajadores($datos_reunion_inicial[0]->tutor, $datos_reunion_inicial[0]->r2, $datos_reunion_inicial[0]->rut, $id_empresa);
    //echo $estado_embajador_validacion;
    if ($_GET["sw"] == "emb_levantamient") {
        $PRINCIPAL = str_replace("{LINK_SEGUNDO}", "?sw=emb_vista1&r2={RUT_R2_ENCODEADO}", $PRINCIPAL);
        $PRINCIPAL = str_replace("{LINK_TERCERO}", "?sw=emb_vista1&r2={RUT_R2_ENCODEADO}", $PRINCIPAL);
        $PRINCIPAL = str_replace("{LINK_CUARTO}", "?sw=emb_vista1&r2={RUT_R2_ENCODEADO}", $PRINCIPAL);
        $PRINCIPAL = str_replace("{LINK_QUINTO}", "?sw=emb_vista1&r2={RUT_R2_ENCODEADO}", $PRINCIPAL);
        $PRINCIPAL = str_replace("{LINK_SEXTO}", "?sw=emb_vista1&r2={RUT_R2_ENCODEADO}", $PRINCIPAL);
        $PRINCIPAL = str_replace("{LINK_SIETE}", "?sw=emb_vista1&r2={RUT_R2_ENCODEADO}", $PRINCIPAL);
    }
    //x_ratioecho $estado_embajador;
    if ($estado_embajador == 0) {
    } else if ($estado_embajador == 25) {
        $PRINCIPAL = str_replace("{LINK_SEGUNDO}", "#second", $PRINCIPAL);
        $PRINCIPAL = str_replace("{LINK_TERCERO}", "#third", $PRINCIPAL);
        $PRINCIPAL = str_replace("{LINK_CUARTO}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{LINK_QUINTO}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{LINK_SEXTO}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{LINK_SIETE}", "#seven", $PRINCIPAL);
        $PRINCIPAL = str_replace("{BLOQUE_FINALIZADO_ETAPA_1}", file_get_contents("views/embajadores/huincha_finalizado_etapa.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{BLOQUE_FINALIZADO_ETAPA_2}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{BLOQUE_FINALIZADO_ETAPA_3}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{BLOQUE_FINALIZADO_ETAPA_4}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{BLOQUE_FINALIZADO_ETAPA_5}", "", $PRINCIPAL);
    } else if ($estado_embajador == 50) {
        $PRINCIPAL = str_replace("{LINK_SEGUNDO}", "#second", $PRINCIPAL);
        $PRINCIPAL = str_replace("{LINK_TERCERO}", "#third", $PRINCIPAL);
        $PRINCIPAL = str_replace("{LINK_CUARTO}", "#four", $PRINCIPAL);
        $PRINCIPAL = str_replace("{LINK_QUINTO}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{LINK_SEXTO}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{LINK_SIETE}", "#seven", $PRINCIPAL);
        $PRINCIPAL = str_replace("{BLOQUE_FINALIZADO_ETAPA_1}", file_get_contents("views/embajadores/huincha_finalizado_etapa.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{BLOQUE_FINALIZADO_ETAPA_2}", file_get_contents("views/embajadores/huincha_finalizado_etapa.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{BLOQUE_FINALIZADO_ETAPA_3}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{BLOQUE_FINALIZADO_ETAPA_4}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{BLOQUE_FINALIZADO_ETAPA_5}", "", $PRINCIPAL);
    } else if ($estado_embajador == 75) {
        $PRINCIPAL = str_replace("{LINK_SEGUNDO}", "#second", $PRINCIPAL);
        $PRINCIPAL = str_replace("{LINK_TERCERO}", "#third", $PRINCIPAL);
        $PRINCIPAL = str_replace("{LINK_CUARTO}", "#four", $PRINCIPAL);
        $PRINCIPAL = str_replace("{LINK_QUINTO}", "#five", $PRINCIPAL);
        $PRINCIPAL = str_replace("{LINK_SEXTO}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{LINK_SIETE}", "#seven", $PRINCIPAL);
        $PRINCIPAL = str_replace("{BLOQUE_FINALIZADO_ETAPA_1}", file_get_contents("views/embajadores/huincha_finalizado_etapa.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{BLOQUE_FINALIZADO_ETAPA_2}", file_get_contents("views/embajadores/huincha_finalizado_etapa.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{BLOQUE_FINALIZADO_ETAPA_3}", file_get_contents("views/embajadores/huincha_finalizado_etapa.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{BLOQUE_FINALIZADO_ETAPA_4}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{BLOQUE_FINALIZADO_ETAPA_5}", "", $PRINCIPAL);
    } else if ($estado_embajador == 100) {
        $PRINCIPAL = str_replace("{LINK_SEGUNDO}", "#second", $PRINCIPAL);
        $PRINCIPAL = str_replace("{LINK_TERCERO}", "#third", $PRINCIPAL);
        $PRINCIPAL = str_replace("{LINK_CUARTO}", "#four", $PRINCIPAL);
        $PRINCIPAL = str_replace("{LINK_QUINTO}", "#five", $PRINCIPAL);
        $PRINCIPAL = str_replace("{LINK_SEXTO}", "#six", $PRINCIPAL);
        $PRINCIPAL = str_replace("{LINK_SIETE}", "#seven", $PRINCIPAL);
        $PRINCIPAL = str_replace("{BLOQUE_FINALIZADO_ETAPA_1}", file_get_contents("views/embajadores/huincha_finalizado_etapa.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{BLOQUE_FINALIZADO_ETAPA_2}", file_get_contents("views/embajadores/huincha_finalizado_etapa.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{BLOQUE_FINALIZADO_ETAPA_3}", file_get_contents("views/embajadores/huincha_finalizado_etapa.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{BLOQUE_FINALIZADO_ETAPA_4}", file_get_contents("views/embajadores/huincha_finalizado_etapa.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{BLOQUE_FINALIZADO_ETAPA_5}", "", $PRINCIPAL);
    }
    //$row_r2 = str_replace("{AVANCE_ETAPA_VAL}",EstadoAvanceValidacionesEmbajadores($unico->tutor, $unico->r2, $unico->rut, $id_empresa),$row_r2);
    //$row_r2 = str_replace("{AVANCE_TAREAS}",EstadoIngresoTareas($unico->rut, $unico->r2, $unico->tutor, $id_empresa),$row_r2);
    //$row_r2 = str_replace("{AVANCE_TAREAS_VAL}",EstadoIngresoTareasValidacion($unico->rut, $unico->r2, $unico->tutor, $id_empresa),$row_r2);
    ;
    return ($PRINCIPAL);
}
function EstadoIngresoTareasValidacion($rut_embajador, $rut_r2, $rut_tutor, $id_empresa)
{
    $selecciona_tareas = EMBAJADORES_TraigoTareasPorActividadYRutSoloRutYEmpresa($id_empresa, $rut_embajador, $rut_r2);
    $total_tares       = count($selecciona_tareas);
    $ingresadas        = 0;
    foreach ($selecciona_tareas as $tarea) {
        if ($tarea->fecha_tarea_validada) {
            $ingresadas++;
        }
    }
    $avance = round(($ingresadas * 100) / $total_tares);
    return ($avance);
}
function EstadoIngresoTareas($rut_embajador, $rut_r2, $rut_tutor, $id_empresa)
{
    $selecciona_tareas = EMBAJADORES_TraigoTareasPorActividadYRutSoloRutYEmpresa($id_empresa, $rut_embajador, $rut_r2);
    $total_tares       = count($selecciona_tareas);
    $ingresadas        = 0;
    foreach ($selecciona_tareas as $tarea) {
        if ($tarea->link_drive) {
            $ingresadas++;
        }
    }
    $avance = round(($ingresadas * 100) / $total_tares);
    return ($avance);
}
function EstadoAvanceValidacionesEmbajadores($rut_tutor, $r2, $rut_embajador, $id_empresa)
{
    $estapa_validada = EMBAJADORES_VerificaValidacion3($id_empresa, $rut_embajador, $r2, $rut_tutor);
    $porcentaje      = (count($estapa_validada) * 100) / 5;
    return (round($porcentaje));
}
function mp_search_banned_words($string, $banned_words)
{
    //echo "<br><br>$string<br>";
    //print_r($banned_words);
    foreach ($banned_words as $banned_word) {
        if (stristr($string, $banned_word->palabra)) {
            //echo "<br>banned $banned_word->palabra";

            return true;
        }
    }
    return false;
}

function mp_search_banned_words_replace_sanitizar($string, $banned_words)
{
    //echo "<br><br>string-> $string< br>";
    //print_r($banned_words);
    foreach ($banned_words as $banned_word) {
            //echo $banned_word->palabra."<br>";
        if (stristr($string, $banned_word->palabra)) {
           // echo "<br>banned $banned_word->palabra ";
            // echo "<br>string  $string";

            //$string=str_replace($banned_word->palabra, "", $string);
            $string  = str_replace($banned_word->palabra, "", $string);
            $string  = str_replace(strtoupper($banned_word->palabra), "", $string);
            $string  = str_replace(strtolower($banned_word->palabra), "", $string);
            //return true;
        }
    }
    //echo "<br>nuevo string ".$string;
    return $string;
}

function BuscaCategoriasEmpresa($PRINCIPAL, $id_empresa, $comunidad)
{
    $rut_sesion       = $_SESSION["user_"];
    $Categorias_array = BuscaCategoriasEmpresa_data($id_empresa, $comunidad);
    foreach ($Categorias_array as $cat) {
        //Veo si esta categor?a est? perfilada
        $esta_perfilada = VerificoPerfilamentoDeBiblioteca($cat->id, $id_empresa);
        if ($esta_perfilada) {
            //Veo si el usuario de sesion, tiene acceso a esta categoria
            $usuario_tiene_acceso = VerificoPerfilamentoDeBibliotecaUsuario($cat->id, $id_empresa, $rut_sesion);
            if ($usuario_tiene_acceso) {
                $row .= file_get_contents("views/biblioteca/" . $id_empresa . "_biblio_categoria.html");
            } else {
                continue;
            }
        } else {
            $row .= file_get_contents("views/biblioteca/" . $id_empresa . "_biblio_categoria.html");
        }
        $row              = str_replace("{NUM_ARCHIVOS}", $cat->total_archivos, $row);
        $row              = str_replace("{NOMBRE_CATEGORIA}", $cat->categoria, $row);
        //Traigo el listado de sub categorias por cada categoria
        $subcategorias    = BuscaSubCategoriasEmpresa_data($id_empresa, $comunidad, $cat->id);
        $row_subcategoria = "";
        foreach ($subcategorias as $subcate) {
            //print_r($subcate);
            $row_subcategoria .= file_get_contents("views/biblioteca/" . $id_empresa . "_biblio_subcategoria.html");
            $row_subcategoria = str_replace("{NUM_ARCHIVOS}", $subcate->total_archivos, $row_subcategoria);
            $row_subcategoria = str_replace("{NOMBRE_CATEGORIA}", $subcate->categoria, $row_subcategoria);
            $row_subcategoria = str_replace("{ID_SUBCAT}", $subcate->id, $row_subcategoria);
        }
        $row = str_replace("{BIBLIO_SUBCATEGORIAS}", $row_subcategoria, $row);
    }
    $PRINCIPAL = str_replace("{BIBLIO_CATEGORIAS}", utf8_encode($row), $PRINCIPAL);
    return ($PRINCIPAL);
}


function BuscaCategoriasFullEmpresa($PRINCIPAL, $id_empresa, $comunidad)
{
    $rut_sesion       = $_SESSION["user_"];
    $Categorias_array = BuscaCategoriasEmpresa_data($id_empresa, $comunidad);
    foreach ($Categorias_array as $cat) {
        //Veo si esta categor?a est? perfilada
        $esta_perfilada = VerificoPerfilamentoDeBiblioteca($cat->id, $id_empresa);
        if ($esta_perfilada) {
            //Veo si el usuario de sesion, tiene acceso a esta categoria
            $usuario_tiene_acceso = VerificoPerfilamentoDeBibliotecaUsuario($cat->id, $id_empresa, $rut_sesion);
            if ($usuario_tiene_acceso) {
                $row .= file_get_contents("views/biblioteca/" . $id_empresa . "_biblio_full.html");
            } else {
                continue;
            }
        } else {
            $row .= file_get_contents("views/biblioteca/" . $id_empresa . "_biblio_full.html");
        }
        $row              = str_replace("{NUM_ARCHIVOS}",       $cat->total_archivos, $row);
        $row              = str_replace("{NOMBRE_CATEGORIA}",   $cat->categoria, $row);
        $row              = str_replace("{ID_CATEGORIA}",       $cat->id, $row);

        //Traigo el listado de sub categorias por cada categoria
        $subcategorias    = BuscaSubCategoriasEmpresa_data($id_empresa, $comunidad, $cat->id);
        $row_subcategoria = "";
        foreach ($subcategorias as $subcate) {
            //print_r($subcate);
            $row_subcategoria .= file_get_contents("views/biblioteca/" . $id_empresa . "_biblio_full_subcat.html");
            $row_subcategoria = str_replace("{NUM_ARCHIVOS}", $subcate->total_archivos, $row_subcategoria);
            $row_subcategoria = str_replace("{NOMBRE_CATEGORIA}", $subcate->categoria, $row_subcategoria);
            $row_subcategoria = str_replace("{ID_SUBCAT}", $cat->id, $row_subcategoria);

                               $archivos_biblio_full= buscarArchivoSubCatFull($subcate->id) ;
                                       $row_archivos="";
                                        foreach ($archivos_biblio_full as $unico_archivo) {
                                            $row_archivos .= file_get_contents("views/biblioteca/" . $id_empresa . "_biblio_full_archivos.html");
                                            $row_archivos = str_replace("{NOMBRE_ARCHIVO_BIBLIOTECA_FULL}", $unico_archivo->titulo, $row_archivos);
                                            $row_archivos = str_replace("{DESCARGA_ARCHIVO_BIBLIOTECA_FULL}", $unico_archivo->archivo, $row_archivos);
                                            $row_archivos = str_replace("{ID_SUBCAT}", $subcate->id, $row_archivos);

                                    }

               $row_subcategoria = str_replace("{LISTA_ARCHIVO_BIBLIOTECA_FULL}", $row_archivos, $row_subcategoria);


        }
        $row = str_replace("{LISTA_SUBCATEGORIAS_BIBLIOTECA_FULL}", $row_subcategoria, $row);
    }
    $PRINCIPAL = str_replace("{BIBLIO_CATEGORIAS}", utf8_encode($row), $PRINCIPAL);
    return ($PRINCIPAL);
}

function EnviaCorreoPuntosGenerico($rut_colaborador, $rut_jefe, $tipo, $template, $premio, $fecha_premio)
{
    $rut_colaborador = UsuarioEnBasePersonas($rut_colaborador);
    $rut_jefe        = UsuarioEnBasePersonas($rut_jefe);
    if ($tipo == "SolicitudColaborador") {
        $recipiente_email = $rut_colaborador[0]->email;
        $texto1           = "Estimad@ " . $rut_colaborador[0]->nombre_completo . ", se ha registrado exitosamente tu solicitud de Beneficio";
        $subject          = "Has solicitado un Beneficio en personasrf.cl";
        $texto2           = "Has solicitado el Beneficio: <strong>" . $premio . "</strong> para el dia " . $fecha_premio . ".";
        $texto3           = "Tu jefe, " . $rut_jefe[0]->nombre_completo . ", debe validar tu solicitud en personasrf.cl";
        $footer           = "Atentamente, equipo Retail Financiero<br>";
    } elseif ($tipo == "SolicitudJefe") {
        $recipiente_email = $rut_jefe[0]->email;
        $texto1           = "Estimad@ " . $rut_jefe[0]->nombre_completo . ", has recibido una solicitud de Beneficio.";
        $subject          = "Has recibido una solicitud de Beneficio en personasrf.cl";
        $texto2           = $rut_colaborador[0]->nombre_completo . " ha solicitado el Beneficio: <strong>" . $premio . "</strong> para el dia " . $fecha_premio . ".";
        $texto3           = "Debes validar esta tu solicitud en <a href='https://www.personasrf.cl'><strong>personasrf.cl</strong></a>";
        $footer           = "Atentamente, equipo Retail Financiero<br>";
    } elseif ($tipo == "ValidacionColaborador") {
        $recipiente_email = $rut_colaborador[0]->email;
        $texto1           = "Estimad@ " . $rut_colaborador[0]->nombre_completo . ", se ha validado tu solicitud de Beneficio";
        $subject          = "Se ha validado tu solicitud de Beneficio en personasrf.cl";
        $texto2           = "Tu jefe, " . $rut_jefe[0]->nombre_completo . " ha validado el Beneficio: <strong>" . $premio . "</strong> para el dia " . $fecha_premio . ".";
        $texto3           = "";
        $footer           = "Atentamente, equipo Retail Financiero<br>";
    } elseif ($tipo == "ValidacionJefe") {
        $recipiente_email = $rut_jefe[0]->email;
        $texto1           = "Estimad@ " . $rut_jefe[0]->nombre_completo . ", has validado una solicitud de Beneficio";
        $subject          = "Has validado una solicitud de Beneficio en personasrf.cl";
        $texto2           = "Has validado la solicitud de " . $rut_colaborador[0]->nombre_completo . " sobre el Beneficio: <strong>" . $premio . "</strong> para el dia " . $fecha_premio . ".";
        $texto3           = "";
        $footer           = "Atentamente, equipo Retail Financiero<br>";
    }
    $fecha    = date("Y-m-d");
    $hora     = date("H:i:s");
    $template = str_replace("{TEXTO1}", $texto1, $template);
    $template = str_replace("{TEXTO2}", $texto2, $template);
    $template = str_replace("{TEXTO3}", $texto3, $template);
    $template = str_replace("{FOOTER}", $footer, $template);
    $mail     = new PHPMailer();
    $mail->SetFrom('soporte@gop.cl', 'Soporte');
    $mail->FromName = "PersonasRF";
    $mail->Subject  = $subject;
    $mail->Helo     = 'gop.cl';
    $mail->IsSMTP();
    $mail->SMTPSecure = "ssl";
    $mail->Host       = 'smtp-relay.gmail.com';
    $mail->Port       = 465;
    $mail->SMTPAuth   = false;
    $mail->Body       = $template;
    $mail->AltBody    = "";
    $mail->IsHTML(true);
    $mail->AddAddress($recipiente_email);
    if (!$mail->Send()) {
        $error_message = "Mailer Error: " . $mail->ErrorInfo;
        echo $error_message;
    } else {
        $error_message = "Email enviado exitosamente";
    }
    //if(!$mail->Send())
    //            return -1;
    // Clear all addresses and attachments for next loop
    $mail->ClearAddresses();
    $mail->ClearAttachments();
}
function ColocoObjetosPorCurso($PRINCIPAL, $id_empresa, $id_curso, $rut)
{
    //Traigo los ovjetos por curso
    $objetos = CHECK_ObjetosPorCurso($id_curso);
    foreach ($objetos as $obj) {
        $row .= file_get_contents("views/google_expand/row_objeto.html");
        $row = str_replace("{NOMBRE_OBJETO}", $obj->titulo, $row);
        $row = str_replace("{DESCRIPCION}", $obj->descripcion, $row);
        $row = str_replace("{IDOBJETO}", $obj->id, $row);
        $row = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($obj->id), $row);
        $row = str_replace("{IMAGEN}", $obj->imagen, $row);
        $row = str_replace("{ESTILO_OVERLAY}", $obj->imagentexto, $row);
        $row = str_replace("{RUT}", $rut, $row);
        $row = str_replace("{ID_OBJETO}", $obj->id, $row);
    }
    $PRINCIPAL = str_replace("{ROW_LISTADO_OBJETOS_GOOGLE_EXPANDS}", utf8_encode($row), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ActualizaTablatblLmsReportePorRutPrograma($rut, $id_programa)
{
}
function EMBAJADORES_ColocaSeguimientoPorPlan($id_empresa, $rut, $id_plan)
{
    //traigo los seguimientos ingresados por plan y usuario
    $seguimientos = Embajadores_traigoSeguimientoPorPlan($rut, $id_empresa, $id_plan);
    if ($seguimientos) {
        $row .= file_get_contents("views/embajadores/row_seguimientos_por_planes_encabezado.html");
        foreach ($seguimientos as $seg) {
            $row .= file_get_contents("views/embajadores/row_seguimientos_por_planes.html");
            $row = str_replace("{FECHA}", $seg->fecha, $row);
            $row = str_replace("{SEGUIMIENTO}", $seg->resultado, $row);
        }
        return (utf8_encode($row));
    } else {
        return ("No se han ingresado datos");
    }
}
function VeEstadoTriviaPreguntadosPorIntentos($rut, $numero_intentos, $id_objeto, $id_empresa)
{
    $respuestas_por_intento = ObtengoCantidadDeIntentosPorColaboradorPorIntentos($rut, $id_objeto, $id_empresa, $numero_intentos);
    $total_correctas        = 0;
    foreach ($respuestas_por_intento as $resp) {
        if ($resp->correcta == 1) {
            $total_correctas++;
        }
    }
    //    echo "<br>correctas $total_correctas de ".count($respuestas_por_intento);
    if ($total_correctas == count($respuestas_por_intento)) {
        return ("Ganaste");
    } else {
        return ("Perdiste");
    }
}
function ColocaDatosGanador($PRINCIPAL, $datos_desafio_desafiante, $datos_desafio_desafiado)
{
    //echo "<br>";
    //echo "<br>";
    //print_r($datos_desafio_desafiante);
    //echo "<br>";
    //print_r($datos_desafio_desafiado);
    $rut_sesion = $_SESSION["user_"];
    $id_empresa = $_SESSION["id_empresa"];
    if ($datos_desafio_desafiante[9] == "Pendiente" or $datos_desafio_desafiado[9] == "Pendiente") {
        //echo "1";
        $PRINCIPAL = str_replace("{BLOQUE_ESPERA_GANADOR}", file_get_contents("views/goplay/" . $id_empresa . "_previa_evaluacion_desafio_espera.html"), $PRINCIPAL);
    } else if ($datos_desafio_desafiante[9] == "Finalizado" && $datos_desafio_desafiado[9] == "Cerrado") {
        //echo "2";
        PREGUNTADOS_ActualizaRutGanadorDesafio($datos_desafio_desafiante[14], $datos_desafio_desafiante[15]);
        PREGUNTADOS_insertaRegistroGanador($datos_desafio_desafiante[14], "", $datos_desafio_desafiante[15], $datos_desafio_desafiante[16]);
        if ($rut_sesion == $datos_desafio_desafiante[14]) {
            $PRINCIPAL = str_replace("{BLOQUE_ESPERA_GANADOR}", file_get_contents("views/goplay/" . $id_empresa . "_previa_evaluacion_desafio_ganador.html"), $PRINCIPAL);
            //echo "3";
        } else {
            $PRINCIPAL = str_replace("{BLOQUE_ESPERA_GANADOR}", file_get_contents("views/goplay/" . $id_empresa . "_previa_evaluacion_desafio_perdedor.html"), $PRINCIPAL);
            //echo "4";
        }
        $PRINCIPAL = str_replace("{NOMBRE}", $datos_desafio_desafiante[12], $PRINCIPAL);
    } else if ($datos_desafio_desafiante[9] == "Cerrado" && $datos_desafio_desafiado[9] == "Finalizado") {
        //echo "5";
        PREGUNTADOS_ActualizaRutGanadorDesafio($datos_desafio_desafiado[14], $datos_desafio_desafiante[15]);
        PREGUNTADOS_insertaRegistroGanador($datos_desafio_desafiado[14], "", $datos_desafio_desafiante[15], $datos_desafio_desafiado[16]);
        if ($rut_sesion == $datos_desafio_desafiado[14]) {
            $PRINCIPAL = str_replace("{BLOQUE_ESPERA_GANADOR}", file_get_contents("views/goplay/" . $id_empresa . "_previa_evaluacion_desafio_ganador.html"), $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{BLOQUE_ESPERA_GANADOR}", file_get_contents("views/goplay/" . $id_empresa . "_previa_evaluacion_desafio_perdedor.html"), $PRINCIPAL);
        }
        //$PRINCIPAL = str_replace("{BLOQUE_ESPERA_GANADOR}",file_get_contents("views/goplay/".$id_empresa."_previa_evaluacion_desafio_ganador.html"),$PRINCIPAL);
        $PRINCIPAL = str_replace("{NOMBRE}", $datos_desafio_desafiado[12], $PRINCIPAL);
    }
    //Los dos est?n finalizados, veo quien tiene mas respuestas correctas
    else if ($datos_desafio_desafiante[9] == "Finalizado" && $datos_desafio_desafiado[9] == "Finalizado") {
        //echo "6";
        //desafiante tiene mas respuestas correctas
        if ($datos_desafio_desafiante[11] > $datos_desafio_desafiado[11]) {
            PREGUNTADOS_ActualizaRutGanadorDesafio($datos_desafio_desafiante[14], $datos_desafio_desafiante[15]);
            PREGUNTADOS_insertaRegistroGanador($datos_desafio_desafiante[14], "", $datos_desafio_desafiante[15], $datos_desafio_desafiante[16]);
            if ($rut_sesion == $datos_desafio_desafiante[14]) {
                //echo "7";
                $PRINCIPAL = str_replace("{BLOQUE_ESPERA_GANADOR}", file_get_contents("views/goplay/" . $id_empresa . "_previa_evaluacion_desafio_ganador.html"), $PRINCIPAL);
            } else {
                //echo "8";
                $PRINCIPAL = str_replace("{BLOQUE_ESPERA_GANADOR}", file_get_contents("views/goplay/" . $id_empresa . "_previa_evaluacion_desafio_perdedor.html"), $PRINCIPAL);
            }
            //$PRINCIPAL = str_replace("{BLOQUE_ESPERA_GANADOR}",file_get_contents("views/goplay/".$id_empresa."_previa_evaluacion_desafio_ganador.html"),$PRINCIPAL);
            $PRINCIPAL = str_replace("{NOMBRE}", $datos_desafio_desafiante[12], $PRINCIPAL);
        } else
        //Desafiado tiene mas respuestas correctas
            if ($datos_desafio_desafiante[11] < $datos_desafio_desafiado[11]) {
            PREGUNTADOS_ActualizaRutGanadorDesafio($datos_desafio_desafiado[14], $datos_desafio_desafiante[15]);
            PREGUNTADOS_insertaRegistroGanador($datos_desafio_desafiado[14], "", $datos_desafio_desafiante[15], $datos_desafio_desafiado[16]);
            if ($rut_sesion == $datos_desafio_desafiado[14]) {
                $PRINCIPAL = str_replace("{BLOQUE_ESPERA_GANADOR}", file_get_contents("views/goplay/" . $id_empresa . "_previa_evaluacion_desafio_ganador.html"), $PRINCIPAL);
                //echo "9";
            } else {
                $PRINCIPAL = str_replace("{BLOQUE_ESPERA_GANADOR}", file_get_contents("views/goplay/" . $id_empresa . "_previa_evaluacion_desafio_perdedor.html"), $PRINCIPAL);
                //echo "10";
            }
            //$PRINCIPAL = str_replace("{BLOQUE_ESPERA_GANADOR}",file_get_contents("views/goplay/".$id_empresa."_previa_evaluacion_desafio_ganador.html"),$PRINCIPAL);
            $PRINCIPAL = str_replace("{NOMBRE}", $datos_desafio_desafiado[12], $PRINCIPAL);
        } else
        //empate en respuestas correctas
            {
            if ($datos_desafio_desafiante[16] < $datos_desafio_desafiado[16]) {
                PREGUNTADOS_ActualizaRutGanadorDesafio($datos_desafio_desafiante[14], $datos_desafio_desafiante[15]);
                PREGUNTADOS_insertaRegistroGanador($datos_desafio_desafiante[14], "", $datos_desafio_desafiante[15], $datos_desafio_desafiante[16]);
                if ($rut_sesion == $datos_desafio_desafiante[14]) {
                    //echo "11";
                    $PRINCIPAL = str_replace("{BLOQUE_ESPERA_GANADOR}", file_get_contents("views/goplay/" . $id_empresa . "_previa_evaluacion_desafio_ganador.html"), $PRINCIPAL);
                } else {
                    //echo "12";
                    $PRINCIPAL = str_replace("{BLOQUE_ESPERA_GANADOR}", file_get_contents("views/goplay/" . $id_empresa . "_previa_evaluacion_desafio_perdedor.html"), $PRINCIPAL);
                }
                //$PRINCIPAL = str_replace("{BLOQUE_ESPERA_GANADOR}",file_get_contents("views/goplay/".$id_empresa."_previa_evaluacion_desafio_ganador.html"),$PRINCIPAL);
                $PRINCIPAL = str_replace("{NOMBRE}", $datos_desafio_desafiante[12], $PRINCIPAL);
            } elseif ($datos_desafio_desafiante[16] > $datos_desafio_desafiado[16]) {
                PREGUNTADOS_ActualizaRutGanadorDesafio($datos_desafio_desafiado[14], $datos_desafio_desafiado[15]);
                PREGUNTADOS_insertaRegistroGanador($datos_desafio_desafiado[14], "", $datos_desafio_desafiado[15], $datos_desafio_desafiado[16]);
                if ($rut_sesion == $datos_desafio_desafiante[14]) {
                    //echo "13";
                    $PRINCIPAL = str_replace("{BLOQUE_ESPERA_GANADOR}", file_get_contents("views/goplay/" . $id_empresa . "_previa_evaluacion_desafio_perdedor.html"), $PRINCIPAL);
                } else {
                    //echo "14";
                    $PRINCIPAL = str_replace("{BLOQUE_ESPERA_GANADOR}", file_get_contents("views/goplay/" . $id_empresa . "_previa_evaluacion_desafio_ganador.html"), $PRINCIPAL);
                }
                //$PRINCIPAL = str_replace("{BLOQUE_ESPERA_GANADOR}",file_get_contents("views/goplay/".$id_empresa."_previa_evaluacion_desafio_ganador.html"),$PRINCIPAL);
                $PRINCIPAL = str_replace("{NOMBRE}", $datos_desafio_desafiado[12], $PRINCIPAL);
            } else {
                PREGUNTADOS_ActualizaRutGanadorDesafio($datos_desafio_desafiado[14], $datos_desafio_desafiante[15]);
                PREGUNTADOS_insertaRegistroGanador($datos_desafio_desafiado[14], "", $datos_desafio_desafiante[15], $datos_desafio_desafiado[16]);
                PREGUNTADOS_ActualizaRutGanadorDesafio($datos_desafio_desafiante[14], $datos_desafio_desafiante[15]);
                PREGUNTADOS_insertaRegistroGanador($datos_desafio_desafiante[14], "", $datos_desafio_desafiante[15], $datos_desafio_desafiante[16]);
                //    echo "15";
                $PRINCIPAL = str_replace("{BLOQUE_ESPERA_GANADOR}", file_get_contents("views/goplay/" . $id_empresa . "_previa_evaluacion_desafio_ganador.html"), $PRINCIPAL);
                //$PRINCIPAL = str_replace("{BLOQUE_ESPERA_GANADOR}",file_get_contents("views/goplay/".$id_empresa."_previa_evaluacion_desafio_ganador.html"),$PRINCIPAL);
                $PRINCIPAL = str_replace("{NOMBRE}", "", $PRINCIPAL);
            }
        }
    }
    return ($PRINCIPAL);
}
function EnviaCorreosPreguntados($rut_desafiante, $rut_desafiado, $tipo, $nombrefrom, $from, $subject, $message)
{
    $datos_desafiante = UsuarioEnBasePersonas($rut_desafiante);
    $datos_desafiado  = UsuarioEnBasePersonas($rut_desafiado);
    if ($tipo == "email_desafiado") {
        $email_a_enviar = $datos_desafiado[0]->email;
    } elseif ($tipo == "email_desafiante") {
        $email_a_enviar = $datos_desafiante[0]->email;
    }
    $message = str_replace("{NOMBRE_DESAFIADO}", $datos_desafiado[0]->nombre_completo, $message);
    $message = str_replace("{NOMBRE_DESAFIANTE}", $datos_desafiante[0]->nombre_completo, $message);
    $fecha   = date("Y-m-d");
    $hora    = date("H:i:s");
    $imagen  = "<img src='http://gcloud.cl/front/img/logo_empresa/be_logo_fen.png'>";
    $message = str_replace("{FECHA_DESAFIO}", $fecha, $message);
    $message = str_replace("{HORA_DESAFIO}", $hora, $message);
    $message = str_replace("{HORA_DESAFIO}", $hora, $message);
    $message = str_replace("{IMAGEN_PREGUNTADOS}", $imagen, $message);
    $message = str_replace("{LINK_ACCESO}", "https://www.gcloud.cl/gurupagorut", $message);
    $mail    = new PHPMailer();
    if ($nombrefrom != "" && $from != "")
        $mail->SetFrom($from, $nombrefrom);
    else
        $mail->SetFrom('soporte@gop.cl', 'Soporte');
    $mail->FromName = $nombrefrom;
    $mail->Subject  = $subject;
    $mail->Helo     = 'gop.cl';
    $mail->IsSMTP();
    $mail->SMTPSecure = "ssl";
    $mail->Host       = 'smtp-relay.gmail.com';
    $mail->Port       = 465;
    $mail->SMTPAuth   = false;
    $mail->Body       = $message;
    $mail->AltBody    = "";
    $mail->IsHTML(true);
    $mail->AddAddress($email_a_enviar);
    if (!$mail->Send()) {
        $error_message = "Mailer Error: " . $mail->ErrorInfo;
        echo $error_message;
    } else {
        $error_message = "Successfully sent!";
    }
    //if(!$mail->Send())
    //            return -1;
    // Clear all addresses and attachments for next loop
    $mail->ClearAddresses();
    $mail->ClearAttachments();
}
function tiempoTranscurridoFechasPreguntados($fechaInicio, $fechaFin)
{
    $fecha1 = new DateTime($fechaInicio);
    $fecha2 = new DateTime($fechaFin);
    $fecha  = $fecha1->diff($fecha2);
    $tiempo = "";
    //a?os
    if ($fecha->y > 0) {
        $tiempo .= $fecha->y;
        if ($fecha->y == 1)
            $tiempo .= " a?o, ";
        else
            $tiempo .= " a?os, ";
    }
    //meses
    if ($fecha->m > 0) {
        $tiempo .= $fecha->m;
        if ($fecha->m == 1)
            $tiempo .= " mes, ";
        else
            $tiempo .= " meses, ";
    }
    //dias
    if ($fecha->d > 0) {
        $total_dias = $fecha->d;
        $tiempo .= $fecha->d;
        if ($fecha->d == 1)
            $tiempo .= " d?a, ";
        else
            $tiempo .= " d?as, ";
    }
    //horas
    if ($fecha->h > 0) {
        $segundos_totales = $segundos_totales + (($fecha->h * 60) * 60);
        $tiempo .= $fecha->h;
        if ($fecha->h == 1)
            $tiempo .= " hora, ";
        else
            $tiempo .= " horas, ";
    }
    //minutos
    if ($fecha->i > 0) {
        $segundos_totales = $segundos_totales + ($fecha->i * 60);
        $tiempo .= $fecha->i;
        if ($fecha->i == 1)
            $tiempo .= " minuto";
        else
            $tiempo .= " minutos";
    } else if ($fecha->i == 0) //segundos
        $tiempo .= $fecha->s . " segundos";
    $segundos_totales = $segundos_totales + $fecha->s;
    //total de dias completo
    $arreglo[0]       = $tiempo;
    //solo numero de dias
    $arreglo[1]       = $fecha->d;
    $segundos         = strtotime($fechaFin) - strtotime($fechaInicio);
    $arreglo[2]       = $segundos;
    $arreglo[3]       = $segundos_totales;
    return $arreglo;
}
function ObtenerDatosTriviaPreguntados($rut, $id_empresa, $id_objeto, $id_desafio_preguntados)
{
    $datos_objeto               = DatosObjeto($id_objeto);
    $cantidad_preguntas         = $datos_objeto[0]->preguntas_aleatorias;
    $total_respuestas           = TraeRespuestasTriviasPreguntadosPorDesafio($id_empresa, $id_desafio_preguntados, $rut);
    $total_respuestas_correctas = TraeRespuestasTriviasPreguntadosPorDesafioCorrectas($id_empresa, $id_desafio_preguntados, $rut);
    $datos_desafio              = TraeDatosDEsafioPreguntados($id_desafio_preguntados);
    $datos_usuario              = UsuarioEnBasePersonas($rut);
    //total de preguntas para este desafio
    $arreglo[0]                 = $cantidad_preguntas;
    //total de respuestas realizadas por el usuario para este desafio
    $arreglo[1]                 = count($total_respuestas);
    //fecha que se cre? el desaf?o
    $arreglo[2]                 = $datos_desafio[0]->fecha;
    //hora que se cre? el desaf?o
    $arreglo[3]                 = $datos_desafio[0]->hora;
    //Fecha de la ultima respuesta
    $arreglo[4]                 = $total_respuestas[$cantidad_preguntas - 1]->fecha;
    //HORA de la ultima respuesta
    $arreglo[5]                 = $total_respuestas[$cantidad_preguntas - 1]->hora;
    //Tiempo Transcurrido
    $tiempo_transcurrido        = tiempoTranscurridoFechasPreguntados($arreglo[2] . " " . $arreglo[3], $arreglo[4] . " " . $arreglo[5]);
    $arreglo[6]                 = $tiempo_transcurrido[0];
    //dias transcurridos
    $arreglo[7]                 = $tiempo_transcurrido[1];
    //Estado del Desafio
    if ($arreglo[0] == $arreglo[1]) {
        $arreglo[8] = "<span class='badge badge-pill badge-info'>Finalizado</span>";
        $arreglo[9] = "Finalizado";
    } else {
        if ($arreglo[7] >= 1) {
            $arreglo[8] = "<span class='badge badge-pill badge-danger'>Finalizado tiempo agotado</span>";
            $arreglo[9] = "Cerrado";
        } else {
            $arreglo[8] = "<span class='badge badge-pill badge-proceso'>Pendiente</span>";
            $arreglo[9] = "Pendiente";
        }
    }
    //Total Tiempo por desafio
    $total_Tiempo_desafio = tiempoTranscurridoFechasPreguntados($total_respuestas[0]->fecha . " " . $total_respuestas[0]->hora, $total_respuestas[$cantidad_preguntas - 1]->fecha . " " . $total_respuestas[$cantidad_preguntas - 1]->hora);
    $arreglo[10]          = $total_Tiempo_desafio[0];
    //total de respuestas correctas
    $arreglo[11]          = count($total_respuestas_correctas);
    //Nombre completo
    $arreglo[12]          = $datos_usuario[0]->nombre_completo;
    //total de segundos
    $arreglo[13]          = $tiempo_transcurrido[2];
    //Rut
    $arreglo[14]          = $datos_usuario[0]->rut;
    //ID DESAFIO
    $arreglo[15]          = $id_desafio_preguntados;
    //TOTAL en Segundos
    $arreglo[16]          = $total_Tiempo_desafio[3];
    return ($arreglo);
}
function ColocaR2PorEmbajador($PRINCIPAL, $rut, $id_empresa)
{
    //Veo si este usuario tiene mas de un R2
    $r2 = TraeR2PorEmbajador($rut, $id_empresa);
    //if(count($r2)>1){
    foreach ($r2 as $unico) {
        $row_r2 .= file_get_contents("views/embajadores/emb_row_vista_r2.html");
        $row_r2 = str_replace("{NOMBRE_USUARIO}", $unico->nombre_completo, $row_r2);
        $row_r2 = str_replace("{FECHA_R2}", $unico->fecha, $row_r2);
        $row_r2 = str_replace("{RUT_R2_ENCODEADO}", Encodear3($unico->r2), $row_r2);
        $row_r2 = str_replace("{AVANCE_ETAPA}", ObtenerPorcentajeAvanceSemana3($unico->rut, $id_empresa, $unico->tutor, $unico->r2), $row_r2);
        $row_r2 = str_replace("{AVANCE_ETAPA_VAL}", EstadoAvanceValidacionesEmbajadores($unico->tutor, $unico->r2, $unico->rut, $id_empresa), $row_r2);
        $row_r2 = str_replace("{AVANCE_TAREAS}", EstadoIngresoTareas($unico->rut, $unico->r2, $unico->tutor, $id_empresa), $row_r2);
        $row_r2 = str_replace("{AVANCE_TAREAS_VAL}", EstadoIngresoTareasValidacion($unico->rut, $unico->r2, $unico->tutor, $id_empresa), $row_r2);
    }
    $row_r2titulo    = file_get_contents("views/embajadores/emb_titulo_vista_r2.html");
    $row_r2fintitulo = file_get_contents("views/embajadores/emb_titulofin_vista_r2.html");
    $PRINCIPAL       = str_replace("{TITULO_BLOQUE_LISTADO_R2}", $row_r2titulo, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{BLOQUE_LISTADO_R2}", $row_r2, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{FIN_TITULO_BLOQUE_LISTADO_R2}", $row_r2fintitulo, $PRINCIPAL);
    /*
    if(Decodear3($_GET["r2"])){
    $PRINCIPAL = str_replace("{LINK_SEGUNDO}","#second",$PRINCIPAL);
    $PRINCIPAL = str_replace("{LINK_TERCERO}","#third",$PRINCIPAL);
    $PRINCIPAL = str_replace("{LINK_CUARTO}","#four",$PRINCIPAL);
    $PRINCIPAL = str_replace("{LINK_QUINTO}","#five",$PRINCIPAL);
    $PRINCIPAL = str_replace("{LINK_SEXTO}","#six",$PRINCIPAL);
    $PRINCIPAL = str_replace("{LINK_SIETE}","#seven",$PRINCIPAL);
    }else{
    $PRINCIPAL = str_replace("{LINK_SEGUNDO}","",$PRINCIPAL);
    $PRINCIPAL = str_replace("{LINK_TERCERO}","",$PRINCIPAL);
    $PRINCIPAL = str_replace("{LINK_CUARTO}","",$PRINCIPAL);
    $PRINCIPAL = str_replace("{LINK_QUINTO}","",$PRINCIPAL);
    $PRINCIPAL = str_replace("{LINK_SEXTO}","",$PRINCIPAL);
    $PRINCIPAL = str_replace("{LINK_SIETE}","",$PRINCIPAL);
    $PRINCIPAL = str_replace("{EMB_ESTADO_ICONO1}","",$PRINCIPAL);
    $PRINCIPAL = str_replace("{EMB_ESTADO_ICONO2}","",$PRINCIPAL);
    $PRINCIPAL = str_replace("{EMB_ESTADO_ICONO3}","",$PRINCIPAL);
    $PRINCIPAL = str_replace("{EMB_ESTADO_ICONO4}","",$PRINCIPAL);
    $PRINCIPAL = str_replace("{EMB_ESTADO_ICONO5}","",$PRINCIPAL);
    $PRINCIPAL = str_replace("{EMB_ESTADO_ICONO6}","",$PRINCIPAL);
    $PRINCIPAL = str_replace("{EMB_ESTADO_ICONO7}","",$PRINCIPAL);
    }
    */
    /*
    }else{
    $PRINCIPAL = str_replace("{BLOQUE_LISTADO_R2}","",$PRINCIPAL);
    $PRINCIPAL = str_replace("{TITULO_BLOQUE_LISTADO_R2}","",$PRINCIPAL);
    $PRINCIPAL = str_replace("{BLOQUE_LISTADO_R2}","",$PRINCIPAL);
    $PRINCIPAL = str_replace("{FIN_TITULO_BLOQUE_LISTADO_R2}","",$PRINCIPAL);
    $PRINCIPAL = str_replace("{LINK_SEGUNDO}","#second",$PRINCIPAL);
    $PRINCIPAL = str_replace("{LINK_TERCERO}","#third",$PRINCIPAL);
    $PRINCIPAL = str_replace("{LINK_CUARTO}","#four",$PRINCIPAL);
    $PRINCIPAL = str_replace("{LINK_QUINTO}","#five",$PRINCIPAL);
    $PRINCIPAL = str_replace("{LINK_SEXTO}","#six",$PRINCIPAL);
    $PRINCIPAL = str_replace("{LINK_SIETE}","#seven",$PRINCIPAL);
    }
    */
    return ($PRINCIPAL);
}
function ColocaReplyInterraccionesGenerico($id_empresa, $id_comentario)
{
    //Traigo los comentarios
    $comentarios = INTERACCIONES_TotalComentariosPorId($id_comentario);
    foreach ($comentarios as $comen) {
        $row_comentario .= file_get_contents("views/embajadores/row_reply.html");
        $row_comentario = str_replace("{COMENTARIO}", $comen->comentario, $row_comentario);
        $row_comentario = str_replace("{ID_COMENTARIO}", $comen->id, $row_comentario);
        $row_comentario = str_replace("{AUTOR}", $comen->nombre_completo, $row_comentario);
        $row_comentario = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($comen->rut_autor), $row_comentario);
    }
    return (utf8_encode($row_comentario));
}
function ColocaComentariosInterraccionesGenerico($id_empresa, $etapa_embajadores, $usuario_embajadores, $r2)
{
    $bloque_comentarios = "bloque comentarios";
    //Traigo los comentarios
    $comentarios        = EMBAJADORES_TraigoInterraccionesEmbajadores($id_empresa, $etapa_embajadores, $usuario_embajadores, $r2);
    foreach ($comentarios as $comen) {
        /*
        if($etapa_embajadores==99){
        $row_comentario.=file_get_contents("views/embajadores/row_interacciones_con_reply.html");
        }else if($etapa_embajadores==100){
        $row_comentario.=file_get_contents("views/embajadores/row_interacciones_con_reply.html");
        }else{
        $row_comentario.=file_get_contents("views/embajadores/row_interacciones.html");
        }
        */
        $row_comentario .= file_get_contents("views/embajadores/row_interacciones_con_reply.html");
        $row_comentario           = str_replace("{COMENTARIO}", $comen->comentario, $row_comentario);
        $row_comentario           = str_replace("{ID_COMENTARIO}", $comen->id, $row_comentario);
        $row_comentario           = str_replace("{AUTOR}", $comen->nombre_completo, $row_comentario);
        $bloque_comentarios_reply = ColocaReplyInterraccionesGenerico($id_empresa, $comen->id);
        $row_comentario           = str_replace("{BLOQUE_ROW_COMENTARIOS_REPLY}", $bloque_comentarios_reply, $row_comentario);
        $row_comentario           = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($comen->rut_autor), $row_comentario);
    }
    return (utf8_encode($row_comentario));
}
function ColocaComentariosInterraccionesGenericoObjetos($id_empresa, $etapa_embajadores, $usuario_embajadores)
{
    $bloque_comentarios = "bloque comentarios";
    //Traigo los comentarios
    $comentarios        = ColocaComentariosInterraccionesGenericoObjetosDATA($id_empresa, $etapa_embajadores, $usuario_embajadores);
    foreach ($comentarios as $comen) {
        /*
        if($etapa_embajadores==99){
        $row_comentario.=file_get_contents("views/embajadores/row_interacciones_con_reply.html");
        }else if($etapa_embajadores==100){
        $row_comentario.=file_get_contents("views/embajadores/row_interacciones_con_reply.html");
        }else{
        $row_comentario.=file_get_contents("views/embajadores/row_interacciones.html");
        }
        */
        $row_comentario .= file_get_contents("views/embajadores/row_interacciones_con_reply.html");
        $row_comentario           = str_replace("{COMENTARIO}", $comen->comentario, $row_comentario);
        $row_comentario           = str_replace("{ID_COMENTARIO}", $comen->id, $row_comentario);
        $row_comentario           = str_replace("{AUTOR}", $comen->nombre_completo, $row_comentario);
        $bloque_comentarios_reply = ColocaReplyInterraccionesGenerico($id_empresa, $comen->id);
        $row_comentario           = str_replace("{BLOQUE_ROW_COMENTARIOS_REPLY}", $bloque_comentarios_reply, $row_comentario);
        $row_comentario           = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($comen->rut_autor), $row_comentario);
    }
    return (utf8_encode($row_comentario));
}
function ColocaBloqueValidacion($PRINCIPAL, $tutor, $embajador, $etapa, $id_empresa, $rut_r2)
{
    $esta_validado         = EMBAJADORES_VerificaValidacion2($id_empresa, $embajador, $etapa, $rut_r2);
    $datos_reunion_inicial = EMBAJADORES_DatosPlanReunionInicial($id_empresa, $embajador, $rut_r2);
    if ($esta_validado) {
        $formulario = file_get_contents("views/embajadores/texto_validacion_tutor.html");
        $formulario = str_replace("{ESTADO_VALIDACION}", $esta_validado[0]->estado_validacion, $formulario);
        $formulario = str_replace("{NUMERO_ETAPA}", $etapa, $formulario);
        $formulario = str_replace("{RUT_EMBAJADOR_ENCODEADO}", Encodear3($embajador), $formulario);
        $formulario = str_replace("{RUT_TUTOR_ENCODEADO}", Encodear3($datos_reunion_inicial[0]->tutor), $formulario);
        $formulario = str_replace("{RUT_R2_ENCODEADO}", Encodear3($rut_r2), $formulario);
    } else {
        $formulario = file_get_contents("views/embajadores/form_validacion_tutor.html");
        $formulario = str_replace("{ETAPA}", $etapa, $formulario);
        if ($etapa == 1) {
            $formulario = str_replace("{NOMBRE_ETAPA}", "Reuni?n Inicial", $formulario);
        } else if ($etapa == 2) {
            $formulario = str_replace("{NOMBRE_ETAPA}", "Selecci?n de Plan", $formulario);
        } else if ($etapa == 3) {
            $formulario = str_replace("{NOMBRE_ETAPA}", "Selecci?n de Tareas", $formulario);
        } else if ($etapa == 4) {
            $formulario = str_replace("{NOMBRE_ETAPA}", "Calendarizaci?n de Tareas", $formulario);
        } else if ($etapa == 5) {
            $formulario = str_replace("{NOMBRE_ETAPA}", "Desarrollo de Tareas", $formulario);
        } else if ($etapa == 6) {
            $formulario = str_replace("{NOMBRE_ETAPA}", "Levantamientos", $formulario);
        }
        $formulario = str_replace("{RUT_EMBAJADOR}", $embajador, $formulario);
        $formulario = str_replace("{RUT_R2}", $rut_r2, $formulario);
    }
    return ($formulario);
}
function ColocaEmbajadoresPorTutor($PRINCIPAL, $rut, $id_empresa)
{
    //Traigo el listado de embajadores por el tutor
    $listado_embajadores = EMBAJADORES_UsuarioEsTutor($id_empresa, $rut);
    foreach ($listado_embajadores as $lis_emb) {
        $row_embajadores .= file_get_contents("views/embajadores/emb_row_vista_tutor.html");
        $row_embajadores = str_replace("{NOMBRE_USUARIO}", ($lis_emb->nombre_completo), $row_embajadores);
        $row_embajadores = str_replace("{FECHA}", ($lis_emb->fecha), $row_embajadores);
        $row_embajadores = str_replace("{RUT_EMBAJADOR_ENCODEADO}", Encodear3($lis_emb->rut), $row_embajadores);
        $row_embajadores = str_replace("{RUT_R2_ENCODEADO}", Encodear3($lis_emb->r2), $row_embajadores);
        $row_embajadores = str_replace("{NOMBRE_R2}", ($lis_emb->nombre_r2), $row_embajadores);
        $row_embajadores = str_replace("{PORCENTAJE_AVANCE_SEMANA_3}", ObtenerPorcentajeAvanceSemana3($lis_emb->rut, $id_empresa, $rut, $lis_emb->r2), $row_embajadores);
        $row_embajadores = str_replace("{AVANCE_ETAPA_VAL}", EstadoAvanceValidacionesEmbajadores($rut, $lis_emb->r2, $lis_emb->rut, $id_empresa), $row_embajadores);
        $row_embajadores = str_replace("{AVANCE_TAREAS}", EstadoIngresoTareas($lis_emb->rut, $lis_emb->r2, $rut, $id_empresa), $row_embajadores);
        $row_embajadores = str_replace("{AVANCE_TAREAS_VAL}", EstadoIngresoTareasValidacion($lis_emb->rut, $lis_emb->r2, $rut, $id_empresa), $row_embajadores);
    }
    $PRINCIPAL = str_replace("{ROW_COLABORADORES}", ($row_embajadores), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaEmbajadoresPorTareasTaguados($PRINCIPAL, $id_empresa)
{
    //Traigo el listado de embajadores por el tutor
    $listado_embajadores = Emb_Vista_Tareas($id_empresa);
    foreach ($listado_embajadores as $lis_emb) {
        //por tagueado
        $row_embajadores .= file_get_contents("views/embajadores/emb_row_vista_groups_tareas.html");
        $row_embajadores      = str_replace("{TIPO}", "TAREA PADRE", $row_embajadores);
        $row_embajadores      = str_replace("{RUT_EMBAJADOR}", ($lis_emb->rut), $row_embajadores);
        $row_embajadores      = str_replace("{NOMBRE_EMBAJADOR}", ($lis_emb->nombreEmbajador), $row_embajadores);
        $row_embajadores      = str_replace("{ID_TAREA}", ($lis_emb->id_tarea), $row_embajadores);
        $row_embajadores      = str_replace("{TAREA}", ($lis_emb->nombre_tarea), $row_embajadores);
        $row_embajadores      = str_replace("{ESTADO}", ($lis_emb->estado), $row_embajadores);
        $tagueados            = "";
        $tagueados            = buscaarrobadomain($lis_emb->conquientrabajaste, $idmp, $rut, $id_empresa);
        $arreglo_Destinatario = "";
        $row_embajadores2     = "";
        //        print_r($tagueados);
        foreach ($tagueados as $tagueado) {
            $arreglo_Destinatario = mp_DATOSPERSONAS($tagueado, $id_empresa);
            //echo "<br>".$tagueado." ".$arreglo_Destinatario[0]->nombre_completo;
            $row_embajadores2 .= file_get_contents("views/embajadores/emb_row_vista_groups_tareas_tagueados.html");
            $row_embajadores2 = str_replace("{RUT_EMBAJADOR_TAGUEADO}", ($tagueado), $row_embajadores2);
            $row_embajadores2 = str_replace("{TIPO_TAGUEADO}", "   ...REPLICA", $row_embajadores2);
            $row_embajadores2 = str_replace("{NOMBRE_EMBAJADOR_TAGUEADO}", $arreglo_Destinatario[0]->nombre_completo, $row_embajadores2);
            //$row_embajadores2 = str_replace("{ID_TAREA}",($lis_emb->id_tarea),$row_embajadores2);
            //                $row_embajadores2 = str_replace("{TAREA}",($lis_emb->nombre_tarea),$row_embajadores2);
            //                $row_embajadores2 = str_replace("{ESTADO}",($lis_emb->estado),$row_embajadores2);
        }
        $row_embajadores = str_replace("{ROW_TAGUEADOS}", ($row_embajadores2), $row_embajadores);
    }
    //echo $row_embajadores;
    $PRINCIPAL = str_replace("{ROW_EMBAJADORES_TAGUEADOS}", $row_embajadores, $PRINCIPAL);
    return ($PRINCIPAL);
}
function EnviaCorreoTest3()
{
    $mail = new PHPMailer;
    //Tell PHPMailer to use SMTP
    $mail->isSMTP(); //Enable SMTP debugging
    // 0 = off (for production use)
    // 1 = client messages
    // 2 = client and server messages
    $mail->SMTPDebug   = 1;
    //Ask for HTML-friendly debug output
    $mail->Debugoutput = 'error_log';
    //Set the hostname of the mail server
    //$mail->Host = $datos_empresa[0]->server;
    $mail->Host        = "mail.ngd.cl";
    //Set the SMTP port number - likely to be 25, 465 or 587
    $mail->Port        = 25;
    //Whether to use SMTP authentication
    $mail->SMTPAuth    = true;
    //Username to use for SMTP authentication
    //$mail->Username = $datos_empresa[0]->envio_correos;
    $mail->Username    = "soporte@ngd.cl";
    $mail->Password    = "N+N5TMTuS3=p";
    //Set who the message is to be sent from
    //$mail->setFrom($datos_empresa[0]->envio_correos, $datos_empresa[0]->envio_correos);
    $mail->setFrom("info-intranet@tntchile.cl", "TNT Informaciones");
    //Set an alternative reply-to address
    //$mail->addReplyTo('replyto@example.com', 'First Last');
    //Set who the message is to be sent to
    //$mail->addAddress($datos_destinatario[0]->email, $datos_destinatario[0]->nombre_completo);
    $mail->addAddress("daniel@gop.cl", $datos_destinatario[0]->nombre_completo);
    //Set the subject line
    $mail->Subject = "Nueva Postulaci?n Movimiento Interno Plataforma TNT";
    //Read an HTML message body from an external file, convert referenced images to embedded,
    //convert HTML into a basic plain-text alternative body
    $mail->msgHTML("MENSAJE", dirname(__FILE__));
    //Replace the plain text body with one created manually
    $mail->AltBody = 'Si no puedes visualizar este correo ....';
    //Attach an image file
    //$mail->addAttachment('images/phpmailer_mini.png');
    //send the message, check for errors
    if (!$mail->send()) {
        //echo "Mailer Error: " . $mail->ErrorInfo;
    } else {
        //echo "Message sent!";
    }
    //exit;
}
function EnviaCorreoTest2()
{
    $mail = new PHPMailer;
    $mail->isSMTP(); //Enable SMTP debugging
    $mail->SMTPDebug   = 1;
    $mail->Debugoutput = 'error_log';
    $mail->Host        = "mail.ngd.cl";
    $mail->Port        = 25;
    $mail->SMTPAuth    = true;
    $mail->Username    = "soporte@ngd.cl";
    $mail->Password    = "N+N5TMTuS3=p";
    $mail->setFrom("soporte@ngd.cl", "CapacitacionBci");
    $mail->addAddress("daniel@gop.cl", "Daniel Pezoa");
    //$mail->addAddress("rod@gop.cl", $datos_destinatario[0]->nombre_completo);
    //$mail->AddBCC("rod@gop.cl","BCC: ".$datos_destinatario[0]->nombre_completo);
    $mail->Subject = "Asunto";
    $mail->msgHTML("TExto", dirname(__FILE__));
    $mail->AltBody = 'Si no puedes visualizar este correo ....';
    //send the message, check for errors
    if (!$mail->send()) {
        //echo "Mailer Error: " . $mail->ErrorInfo;
    } else {
        echo "Notificaci?n Enviada a daniel@gop.cl";
    }
}
function ObtenerPorcentajeAvanceSemana3($rut_embajador, $id_empresa, $rut_Sesion, $rut_r2)
{
    //echo "<br><br>r2 ".$rut_r2."<br>";
    $datos_reunion_inicial = EMBAJADORES_DatosPlanReunionInicial($id_empresa, $rut_embajador, $rut_r2);
    $contador_etapas       = 0;
    if ($datos_reunion_inicial[0]->fecha) {
        $contador_etapas++;
    }
    //echo "<br>---et1 reunion inicial ".$contador_etapas;
    if ($datos_reunion_inicial[0]->plan and $datos_reunion_inicial[0]->factor_exito and $datos_reunion_inicial[0]->ambito and $datos_reunion_inicial[0]->periodicidad and $datos_reunion_inicial[0]->nombre_kpi and $datos_reunion_inicial[0]->kpi_inicial >= 0 and $datos_reunion_inicial[0]->kpi_esperado >= 0) {
        $contador_etapas++;
    }
    //echo "<br>---et2 datos_reunion_inicial[0]->plan ".$contador_etapas;
    $selecciona_tareas = EMBAJADORES_TraigoTareasPorActividadYRutSoloRutYEmpresa($id_empresa, $rut_embajador, $rut_r2);
    if ($selecciona_tareas) {
        $contador_etapas++;
        //echo $rut_embajador."<br>";
    }
    //echo "<br>---et3 selecciona_tareas ".$contador_etapas;
    $tareas_calendarizadas = EMBAJADORES_CalendarizacionTareaPorUsuario($id_empresa, $rut_embajador, $rut_r2);
    if ($tareas_calendarizadas) {
        $contador_etapas++;
    }
    //echo "<br>---et4 selecciona_tareas_calendarizadas ".$contador_etapas;
    /*$estado_ingreso_tareas=EstadoIngresoTareas($rut_embajador, $rut_r2, $datos_reunion_inicial[0]->tutor, $id_empresa);
    if($estado_ingreso_tareas==100){
    $contador_etapas++;
    }*/
    //echo "<br>---et5 estado_ingreso_tareas ".$contador_etapas;
    $porcentaje = (100 * $contador_etapas) / 4;
    if ($porcentaje >= 100)
        $porcentaje = 100;
    return ($porcentaje);
}
function EMBAJADORES_ColocaEstadosPorPEstana($PRINCIPAL, $id_empresa, $rut, $rut_r2)
{
    $datos_reunion_inicial = EMBAJADORES_DatosPlanReunionInicial($id_empresa, $rut, $rut_r2);
    $etapa1                = "no";
    $etapa2                = "no";
    $etapa3                = "no";
    $etapa4                = "no";
    $etapa5                = "no";
    $etapa6                = "no";
    /*
    if(Decodear3($_GET["r2"])){
    if($_GET["n"]==2){
    $PRINCIPAL = str_replace("{LINK_IR}","third",$PRINCIPAL);
    }else if($_GET["n"]==3){
    $PRINCIPAL = str_replace("{LINK_IR}","four",$PRINCIPAL);
    }else if($_GET["n"]==4){
    $PRINCIPAL = str_replace("{LINK_IR}","five",$PRINCIPAL);
    }else if($_GET["n"]==5){
    $PRINCIPAL = str_replace("{LINK_IR}","six",$PRINCIPAL);
    }else if($_GET["n"]==6){
    $PRINCIPAL = str_replace("{LINK_IR}","seven",$PRINCIPAL);
    }else{
    $PRINCIPAL = str_replace("{LINK_IR}","second",$PRINCIPAL);
    }
    }else{
    if($_GET["n"]==2){
    $PRINCIPAL = str_replace("{LINK_IR}","third",$PRINCIPAL);
    }else if($_GET["n"]==3){
    $PRINCIPAL = str_replace("{LINK_IR}","four",$PRINCIPAL);
    }else if($_GET["n"]==4){
    $PRINCIPAL = str_replace("{LINK_IR}","five",$PRINCIPAL);
    }else if($_GET["n"]==5){
    $PRINCIPAL = str_replace("{LINK_IR}","six",$PRINCIPAL);
    }else if($_GET["n"]==6){
    $PRINCIPAL = str_replace("{LINK_IR}","seven",$PRINCIPAL);
    }else{
    $PRINCIPAL = str_replace("{LINK_IR}","second",$PRINCIPAL);
    }
    $PRINCIPAL = str_replace("{LINK_IR}","",$PRINCIPAL);
    }
    */
    if ($datos_reunion_inicial) {
        //Veo si la etapa 1 esta validada
        //$validado_1=EMBAJADORES_VerificaValidacion($id_empresa,  $rut, "REUNION_INICIAL");
        $validado_1 = EMBAJADORES_VerificaValidacion2($id_empresa, $rut, "1", $rut_r2);
        if ($validado_1) {
            $PRINCIPAL        = str_replace("{EMB_ESTADO_ICONO1}", file_get_contents("views/embajadores/icono_validado.html"), $PRINCIPAL);
            $usuario_es_tutor = EMBAJADORES_UsuarioEsTutor($id_empresa, $rut);
            if ($usuario_es_tutor) {
                $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO1}", "", $PRINCIPAL);
                $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO2}", "", $PRINCIPAL);
                $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO3}", "", $PRINCIPAL);
                $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO4}", "", $PRINCIPAL);
                $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO5}", "", $PRINCIPAL);
                $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO6}", "", $PRINCIPAL);
                $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO7}", "", $PRINCIPAL);
                $PRINCIPAL = str_replace("{LINK_IR}", "", $PRINCIPAL);
            }
            $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO1}", "ui-tabs-active", $PRINCIPAL);
        } else {
            $PRINCIPAL        = str_replace("{EMB_ESTADO_ICONO1}", file_get_contents("views/embajadores/icono_pendiente_validacion.html"), $PRINCIPAL);
            $usuario_es_tutor = EMBAJADORES_UsuarioEsTutor($id_empresa, $rut);
            if ($usuario_es_tutor) {
                $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO1}", "", $PRINCIPAL);
                $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO2}", "", $PRINCIPAL);
                $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO3}", "", $PRINCIPAL);
                $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO4}", "", $PRINCIPAL);
                $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO5}", "", $PRINCIPAL);
                $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO6}", "", $PRINCIPAL);
                $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO7}", "", $PRINCIPAL);
                $PRINCIPAL = str_replace("{LINK_IR}", "", $PRINCIPAL);
            }
            $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO1}", "", $PRINCIPAL);
            $etapa1    = "si";
        }
    } else {
        $PRINCIPAL        = str_replace("{EMB_ESTADO_ICONO1}", file_get_contents("views/embajadores/icono_pendiente.html"), $PRINCIPAL);
        $usuario_es_tutor = EMBAJADORES_UsuarioEsTutor($id_empresa, $rut);
        if ($usuario_es_tutor) {
            $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO1}", "", $PRINCIPAL);
            $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO2}", "", $PRINCIPAL);
            $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO3}", "", $PRINCIPAL);
            $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO4}", "", $PRINCIPAL);
            $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO5}", "", $PRINCIPAL);
            $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO6}", "", $PRINCIPAL);
            $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO7}", "", $PRINCIPAL);
            $PRINCIPAL = str_replace("{LINK_IR}", "", $PRINCIPAL);
        }
        $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO1}", "ui-tabs-active", $PRINCIPAL);
        $PRINCIPAL = str_replace("{LINK_IR}", "second", $PRINCIPAL);
    }
    if ($datos_reunion_inicial[0]->plan and $datos_reunion_inicial[0]->factor_exito and $datos_reunion_inicial[0]->ambito and $datos_reunion_inicial[0]->periodicidad and $datos_reunion_inicial[0]->nombre_kpi and $datos_reunion_inicial[0]->kpi_inicial >= 0 and $datos_reunion_inicial[0]->kpi_esperado >= 0) {
        //Veo si la etapa 2 est? Validada
        //$validado_2=EMBAJADORES_VerificaValidacion($id_empresa,  $rut, "SELECCION_PLAN");
        $validado_2 = EMBAJADORES_VerificaValidacion2($id_empresa, $rut, "2", $rut_r2);
        if ($validado_2) {
            $PRINCIPAL = str_replace("{EMB_ESTADO_ICONO2}", file_get_contents("views/embajadores/icono_validado.html"), $PRINCIPAL);
            $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO2}", "", $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{EMB_ESTADO_ICONO2}", file_get_contents("views/embajadores/icono_pendiente_validacion.html"), $PRINCIPAL);
            $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO2}", "", $PRINCIPAL);
            $etapa2    = "si";
        }
    } else {
        $PRINCIPAL = str_replace("{EMB_ESTADO_ICONO2}", file_get_contents("views/embajadores/icono_pendiente.html"), $PRINCIPAL);
        if ($etapa1 == "si") {
            $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO2}", "ui-tabs-active", $PRINCIPAL);
            $PRINCIPAL = str_replace("{LINK_IR}", "third", $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO2}", "", $PRINCIPAL);
        }
    }
    //Etapa 3
    $tiene_tareas = EMBAJADORES_TraigoTareasPorActividadYRutSoloRut($id_empresa, $datos_reunion_inicial[0]->plan, $rut);
    if ($tiene_tareas) {
        //$validado_3=EMBAJADORES_VerificaValidacion($id_empresa,  $rut, "SELECCION_TAREAS");
        $validado_3 = EMBAJADORES_VerificaValidacion2($id_empresa, $rut, "3", $rut_r2);
        if ($validado_3) {
            $PRINCIPAL = str_replace("{EMB_ESTADO_ICONO3}", file_get_contents("views/embajadores/icono_validado.html"), $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{EMB_ESTADO_ICONO3}", file_get_contents("views/embajadores/icono_pendiente_validacion.html"), $PRINCIPAL);
            $etapa3    = "si";
        }
    } else {
        $PRINCIPAL = str_replace("{EMB_ESTADO_ICONO3}", file_get_contents("views/embajadores/icono_pendiente.html"), $PRINCIPAL);
        if ($etapa2 == "si") {
            $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO3}", "ui-tabs-active", $PRINCIPAL);
            $PRINCIPAL = str_replace("{LINK_IR}", "four", $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO3}", "", $PRINCIPAL);
        }
    }
    //Etapa 4
    $tiene_calendarizada_tareas = EMBAJADORES_CalendarizacionTareaPorUsuario($id_empresa, $rut);
    if ($tiene_calendarizada_tareas) {
        //$validado_4=EMBAJADORES_VerificaValidacion($id_empresa,  $rut, "CALENDARIZACION_TAREAS");
        $validado_4 = EMBAJADORES_VerificaValidacion2($id_empresa, $rut, "4", $rut_r2);
        if ($validado_4) {
            $PRINCIPAL = str_replace("{EMB_ESTADO_ICONO4}", file_get_contents("views/embajadores/icono_validado.html"), $PRINCIPAL);
        } else {
            $etapa4    = "si";
            $PRINCIPAL = str_replace("{EMB_ESTADO_ICONO4}", file_get_contents("views/embajadores/icono_pendiente_validacion.html"), $PRINCIPAL);
        }
    } else {
        $PRINCIPAL = str_replace("{EMB_ESTADO_ICONO4}", file_get_contents("views/embajadores/icono_pendiente.html"), $PRINCIPAL);
        if ($etapa3 == "si") {
            $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO4}", "ui-tabs-active", $PRINCIPAL);
            $PRINCIPAL = str_replace("{LINK_IR}", "five", $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO4}", "", $PRINCIPAL);
        }
    }
    //Etapa 5
    $tiene_desarrollada_tareas = EMBAJADORES_TieneDesarrolloTareaSoloRut($id_empresa, $rut);
    if ($tiene_desarrollada_tareas) {
        $PRINCIPAL  = str_replace("{LINK_IR}", "six", $PRINCIPAL);
        $validado_5 = EMBAJADORES_VerificaValidacion($id_empresa, $rut, "TAREAS_DESARROLLADAS");
        if ($validado_5) {
            $PRINCIPAL = str_replace("{EMB_ESTADO_ICONO5}", file_get_contents("views/embajadores/icono_validado.html"), $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{EMB_ESTADO_ICONO5}", file_get_contents("views/embajadores/icono_pendiente_validacion.html"), $PRINCIPAL);
            $etapa5    = "si";
        }
    } else {
        $PRINCIPAL = str_replace("{EMB_ESTADO_ICONO5}", file_get_contents("views/embajadores/icono_pendiente.html"), $PRINCIPAL);
        if ($etapa4 == "si") {
            $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO5}", "ui-tabs-active", $PRINCIPAL);
            $PRINCIPAL = str_replace("{LINK_IR}", "six", $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO5}", "", $PRINCIPAL);
        }
    }
    $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO1}", "", $PRINCIPAL);
    $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO2}", "", $PRINCIPAL);
    $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO3}", "", $PRINCIPAL);
    $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO4}", "", $PRINCIPAL);
    $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO5}", "", $PRINCIPAL);
    $PRINCIPAL = str_replace("{EMB_ESTADO_ACTIVO6}", "", $PRINCIPAL);
    $PRINCIPAL = str_replace("{EMB_ESTADO_ICONO1}", file_get_contents("views/embajadores/icono_pendiente.html"), $PRINCIPAL);
    $PRINCIPAL = str_replace("{EMB_ESTADO_ICONO2}", file_get_contents("views/embajadores/icono_pendiente.html"), $PRINCIPAL);
    $PRINCIPAL = str_replace("{EMB_ESTADO_ICONO3}", file_get_contents("views/embajadores/icono_pendiente.html"), $PRINCIPAL);
    $PRINCIPAL = str_replace("{EMB_ESTADO_ICONO4}", file_get_contents("views/embajadores/icono_pendiente.html"), $PRINCIPAL);
    $PRINCIPAL = str_replace("{EMB_ESTADO_ICONO5}", file_get_contents("views/embajadores/icono_pendiente.html"), $PRINCIPAL);
    $PRINCIPAL = str_replace("{EMB_ESTADO_ICONO6}", file_get_contents("views/embajadores/icono_pendiente.html"), $PRINCIPAL);
    return ($PRINCIPAL);
}
function EMBAJADORES_ColocaTabs($PRINCIPAL, $id_empresa, $rut, $rut_r2)
{
    $datos_reunion_inicial = EMBAJADORES_DatosPlanReunionInicial($id_empresa, $rut, $rut_r2);
    $tareas                = EMBAJADORES_TraigoTareasPorActividadYRutSoloRut($id_empresa, $datos_reunion_inicial[0]->plan, $rut);
    $i                     = 1;
    foreach ($tareas as $tar) {
        $row_tabs .= file_get_contents("views/embajadores/row_tab.html");
        $row_tabs_contenidos .= file_get_contents("views/embajadores/row_tab_contenido.html");
        $verifica_tarea_validad = EMBAJADORES_VerificaValidacionTareaSubida($id_empresa, $datos_reunion_inicial[0]->rut, $datos_reunion_inicial[0]->r2, $datos_reunion_inicial[0]->tutor, $tar->id_tarea);
        //if($tar->link_drive){
        if ($verifica_tarea_validad) {
            $row_tabs = str_replace("{ESTADO}", "<i class='icon-check icons'></i>", $row_tabs);
            $row_tabs = str_replace("{TIPOBADGEESTADO}", "success", $row_tabs);
        } else {
            if ($tar->link_drive) {
                $row_tabs = str_replace("{ESTADO}", "<i class='icon-minus icons'></i>", $row_tabs);
                $row_tabs = str_replace("{TIPOBADGEESTADO}", "warning", $row_tabs);
            } else {
                $row_tabs = str_replace("{ESTADO}", "<i class='icon-minus icons'></i>", $row_tabs);
                $row_tabs = str_replace("{TIPOBADGEESTADO}", "danger", $row_tabs);
            }
        }
        $row_tabs            = str_replace("{ID}", ($tar->id), $row_tabs);
        $row_tabs            = str_replace("{TIPOBADGEESTADO}", "*", $row_tabs);
        $row_tabs_contenidos = str_replace("{LINK_DRIVE_VALUE}", ($tar->link_drive), $row_tabs_contenidos);
        $row_tabs_contenidos = str_replace("{ID}", ($tar->id), $row_tabs_contenidos);
        if ($_GET["sw"] == "emb_vista1_tut") {
            $tarea_validada = EMBAJADORES_VerificaValidacionTareaSubida($id_empresa, $datos_reunion_inicial[0]->rut, $datos_reunion_inicial[0]->r2, $datos_reunion_inicial[0]->tutor, utf8_encode($tar->id_tarea));
            if ($tarea_validada) {
                $row_tabs_contenidos = str_replace("{BLOQUE_PARA_VALIDAR}", "", $row_tabs_contenidos);
            } else {
                //$row_tabs_contenidos = str_replace("{BLOQUE_PARA_VALIDAR}","",$row_tabs_contenidos);
                $row_tabs_contenidos = str_replace("{BLOQUE_PARA_VALIDAR}", file_get_contents("views/embajadores/row_tab_contenido_form_validacion.html"), $row_tabs_contenidos);
            }
            $row_tabs_contenidos = str_replace("{RUT_R2}", $datos_reunion_inicial[0]->r2, $row_tabs_contenidos);
            $row_tabs_contenidos = str_replace("{RUT_EMBAJADOR}", $datos_reunion_inicial[0]->rut, $row_tabs_contenidos);
            $row_tabs_contenidos = str_replace("{RUT_TUTOR}", $datos_reunion_inicial[0]->tutor, $row_tabs_contenidos);
        } else {
            $row_tabs_contenidos = str_replace("{BLOQUE_PARA_VALIDAR}", "", $row_tabs_contenidos);
        }
        $row_tabs = str_replace("{TAREA_CORTO}", "Tarea " . $i, $row_tabs);
        $i++;
        $row_tabs_contenidos = str_replace("{TAREA}", utf8_encode($tar->tarea), $row_tabs_contenidos);
        $row_tabs_contenidos = str_replace("{ID_TAREA}", utf8_encode($tar->id_tarea), $row_tabs_contenidos);
        $row_tabs_contenidos = str_replace("{RUT_R2_ENCODEADO}", Encodear3($rut_r2), $row_tabs_contenidos);
        $row_tabs_contenidos = str_replace("{DESCRIPCION_TAREA}", utf8_encode($tar->descripcion_tarea), $row_tabs_contenidos);
        $entregables         = EMBAJADORES_EntregablesPorTarea($id_empresa, $tar->id_tarea);
        $total_entregables   = "";
        foreach ($entregables as $entre) {
            $total_entregables .= file_get_contents("views/embajadores/row_entregable_por_actividad.html");
            $total_entregables = str_replace("{LINK}", $entre->link, $total_entregables);
            $total_entregables = str_replace("{ENTREGABLE}", $entre->entregable, $total_entregables);
        }
        $row_tabs_contenidos = str_replace("{BLOQUE_ACTIVIDADES_POR_TAREA}", utf8_encode($total_entregables), $row_tabs_contenidos);
    }
    $PRINCIPAL = str_replace("{ROW_TABS}", ($row_tabs), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_TABS_CONTENIDOS}", ($row_tabs_contenidos), $PRINCIPAL);
    return ($PRINCIPAL);
}
function EMBAJADORES_ColocaCalendarizacionTareas($PRINCIPAL, $id_empresa, $rut, $rut_r2)
{
    $datos_reunion_inicial = EMBAJADORES_DatosPlanReunionInicial($id_empresa, $rut, $rut_r2);
    $tareas                = EMBAJADORES_TraigoTareasPorActividadYRutSoloRut($id_empresa, $datos_reunion_inicial[0]->plan, $rut);
    foreach ($tareas as $tar) {
        if ($_GET["sw"] == "emb_vista1_tut") {
            $row_tarea .= file_get_contents("views/embajadores/row_calendariza_tareas_vista_tutor.html");
        } else {
            $row_tarea .= file_get_contents("views/embajadores/row_calendariza_tareas.html");
        }
        $row_tarea     = str_replace("{NOMBRE_TAREA}", utf8_encode($tar->tarea), $row_tarea);
        $row_tarea     = str_replace("{ID_TAREA}", utf8_encode($tar->id_tarea), $row_tarea);
        $observaciones = EMBAJADORES_CalendarizacionTareaPorSemanaTexto($id_empresa, $tar->id_tarea, $rut);
        $row_tarea     = str_replace("{COMENTARIO}", utf8_encode($observaciones[0]->texto), $row_tarea);
        for ($i = 1; $i <= 12; $i++) {
            $tiene_calendarizacion = EMBAJADORES_CalendarizacionTareaPorSemana($id_empresa, $tar->id_tarea, $rut, $i);
            if ($tiene_calendarizacion) {
                $row_tarea = str_replace("{CHECKEADO_" . $i . "}", "checked='checked'", $row_tarea);
            } else {
                $row_tarea = str_replace("{CHECKEADO_" . $i . "}", "", $row_tarea);
            }
        }
    }
    $PRINCIPAL = str_replace("{ROW_ACTIVIDADES_SEMANALES}", ($row_tarea), $PRINCIPAL);
    return ($PRINCIPAL);
}
function EMBAJADORES_ColocaActividadesTareas($PRINCIPAL, $id_empresa, $rut, $rut_r2)
{
    $datos_reunion_inicial = EMBAJADORES_DatosPlanReunionInicial($id_empresa, $rut, $rut_r2);
    $id_plan_emb           = $datos_reunion_inicial[0]->plan;
    //Con el plan traigo las actividades
    $actividades           = EMBAJADORES_DistinctActividadesDadoPlan($id_empresa, $id_plan_emb);
    foreach ($actividades as $act) {
        $tareas = EMBAJADORES_TraigoTareasPorActividad($id_empresa, ($act->valor), $id_plan_emb);
        if ($_GET["sw"] == "emb_vista1_tut") {
            $row_actividades .= "";
        } else {
            $row_actividades .= file_get_contents("views/embajadores/row_actividad.html");
        }
        $row_actividades = str_replace("{ACTIVIDAD}", utf8_encode($act->valor), $row_actividades);
        //ahora por cada actividad, traigo sus tareas
        foreach ($tareas as $tarea) {
            //Veo si esta actividad esta seleccionada para este uusuario / empresa / actividad / plan
            $tiene_actividad_usuario = EMBAJADORES_TraigoTareasPorActividadYRut($id_empresa, $act->valor, $id_plan_emb, $rut, $tarea->tarea);
            if ($_GET["sw"] == "emb_vista1_tut") {
                if ($tiene_actividad_usuario) {
                    $row_actividades .= file_get_contents("views/embajadores/row_tarea_por_actividad_vista_tutor.html");
                }
            } else {
                $row_actividades .= file_get_contents("views/embajadores/row_tarea_por_actividad.html");
            }
            $row_actividades   = str_replace("{ID_TAREA}", utf8_encode($tarea->id_tarea), $row_actividades);
            $row_actividades   = str_replace("{TAREA}", utf8_encode($tarea->tarea), $row_actividades);
            $row_actividades   = str_replace("{TIEMPO}", utf8_encode($tarea->tiempo), $row_actividades);
            //Traigo entregables por Tarea
            $entregables       = EMBAJADORES_EntregablesPorTarea($id_empresa, $tarea->id_tarea);
            $total_entregables = "";
            foreach ($entregables as $entre) {
                $total_entregables .= file_get_contents("views/embajadores/row_entregable_por_actividad.html");
                $total_entregables = str_replace("{LINK}", $entre->link, $total_entregables);
                $total_entregables = str_replace("{ENTREGABLE}", $entre->entregable, $total_entregables);
            }
            //$row_actividades = str_replace("{ENTREGABLE}",utf8_encode($tarea->entregable),$row_actividades);
            $row_actividades = str_replace("{ENTREGABLE}", utf8_encode($total_entregables), $row_actividades);
            if ($tiene_actividad_usuario) {
                $row_actividades = str_replace("{CHECKED}", "checked='checked'", $row_actividades);
            } else {
                $row_actividades = str_replace("{CHECKED}", "", $row_actividades);
            }
        }
    }
    $PRINCIPAL = str_replace("{ROW_ACTIVIDADES_TAREAS}", $row_actividades, $PRINCIPAL);
    return ($PRINCIPAL);
}
function EMBAJADORES_ColocaComboTutores($PRINCIPAL, $id_empresa, $rut, $rut_r2)
{
    $usuarios              = EMBAJADORES_ListadoTutores($id_empresa);
    $datos_reunion_inicial = EMBAJADORES_DatosPlanReunionInicial($id_empresa, $rut, $rut_r2);
    $options               = "";
    foreach ($usuarios as $usu) {
        if ($datos_reunion_inicial[0]->tutor == $usu->rut) {
            $options .= "<option value='" . $usu->rut . "' selected='selected'>" . $usu->nombre_completo . "</option>";
        } else {
            $options .= "<option value='" . $usu->rut . "'>" . $usu->nombre_completo . "</option>";
        }
    }
    $r2 = TraeR2PorEmbajador($rut, $id_empresa);
    if ($datos_reunion_inicial[0]->tutor && $datos_reunion_inicial[0]->r2 && $datos_reunion_inicial[0]->fecha) {
        /*
        if(count($r2)>1){
        $PRINCIPAL = str_replace("{ACTIVO_DESACTIVO_TUTOR}","disabled",$PRINCIPAL);
        }else{
        $PRINCIPAL = str_replace("{ACTIVO_DESACTIVO_TUTOR}","",$PRINCIPAL);
        }
        */
        $PRINCIPAL = str_replace("{ACTIVO_DESACTIVO_TUTOR}", "readonly", $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{ACTIVO_DESACTIVO_TUTOR}", "", $PRINCIPAL);
    }
    $arreglo_fecha = explode("-", $datos_reunion_inicial[0]->fecha);
    //$PRINCIPAL = str_replace("{FECHA}",$arreglo_fecha[0]."-".$arreglo_fecha[1]."-".$arreglo_fecha[2],$PRINCIPAL);
    $PRINCIPAL     = str_replace("{FECHA}", $datos_reunion_inicial[0]->fecha, $PRINCIPAL);
    if ($datos_reunion_inicial[0]->fecha) {
        if (count($r2) > 1) {
            $PRINCIPAL = str_replace("{ACTIVO_DESACTIVO_FECHA}", "readonly", $PRINCIPAL);
        } else {
            //$PRINCIPAL = str_replace("{ACTIVO_DESACTIVO_FECHA}","",$PRINCIPAL);
        }
    } else {
        $PRINCIPAL = str_replace("{ACTIVO_DESACTIVO_FECHA}", "", $PRINCIPAL);
    }
    if ($datos_reunion_inicial[0]->fecha && $datos_reunion_inicial[0]->tutor && $datos_reunion_inicial[0]->r2) {
        if (count($r2) > 1) {
            $PRINCIPAL = str_replace("{DISPLAU_BOTONES_GUARDAR_R2}", 'style="display:none;"', $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{DISPLAU_BOTONES_GUARDAR_R2}", '', $PRINCIPAL);
        }
        $PRINCIPAL = str_replace("{BOTON_GUARDA_EDITA_REUNION_INICIAL}", file_get_contents("views/embajadores/boton_edita_reunion_inicial.html"), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BOTON_GUARDA_EDITA_REUNION_INICIAL}", file_get_contents("views/embajadores/boton_guarda_reunion_inicial.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{DISPLAU_BOTONES_GUARDAR_R2}", "", $PRINCIPAL);
    }
    $PRINCIPAL = str_replace("{OPTION_TUTOR_EMB}", utf8_encode($options), $PRINCIPAL);
    return ($PRINCIPAL);
}
function EMBAJADORES_ColocaComboR2($PRINCIPAL, $id_empresa, $rut, $rut_r2)
{
    $usuarios              = EMBAJADORES_ListadoR2($id_empresa);
    $datos_reunion_inicial = EMBAJADORES_DatosPlanReunionInicial($id_empresa, $rut, $rut_r2);
    $options               = "";
    foreach ($usuarios as $usu) {
        if ($datos_reunion_inicial[0]->r2 == $usu->rut) {
            $options .= "<option value='" . $usu->rut . "' selected='selected'>" . $usu->nombre_completo . "</option>";
        } else {
            $options .= "<option value='" . $usu->rut . "'>" . $usu->nombre_completo . "</option>";
        }
    }
    $r2 = TraeR2PorEmbajador($rut, $id_empresa);
    if ($datos_reunion_inicial[0]->r2 && $datos_reunion_inicial[0]->tutor && $datos_reunion_inicial[0]->fecha) {
        /*
        if(count($r2)>1){
        $PRINCIPAL = str_replace("{ACTIVO_DESACTIVO_R2}","disabled",$PRINCIPAL);
        }else{
        $PRINCIPAL = str_replace("{ACTIVO_DESACTIVO_R2}","",$PRINCIPAL);
        }
        */
        $PRINCIPAL = str_replace("{ACTIVO_DESACTIVO_R2}", "readonly", $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{ACTIVO_DESACTIVO_R2}", "", $PRINCIPAL);
    }
    $PRINCIPAL = str_replace("{OPTIONS_R2}", utf8_encode($options), $PRINCIPAL);
    return ($PRINCIPAL);
}
function EMBAJADORES_ColocaPlanesPorEmpresa($id_empresa, $rut, $rut_r2, $id_plan_seleccionado)
{
    $embajadores           = TraeEmbajadoresDistinct($id_empresa, $rut, $rut_r2, $id_plan_seleccionado);
    $datos_reunion_inicial = EMBAJADORES_DatosPlanReunionInicial($id_empresa, $rut, $rut_r2);
    foreach ($embajadores as $emb) {
        if ($id_plan_seleccionado) {
            $row_embajadores .= file_get_contents("views/embajadores/row_plan_lectura.html");
        } else {
            $row_embajadores .= file_get_contents("views/embajadores/row_plan.html");
        }
        $row_embajadores = str_replace("{VALOR}", $emb->valor, $row_embajadores);
        $row_embajadores = str_replace("{LINK}", $emb->linkresumen, $row_embajadores);
        $row_embajadores = str_replace("{VALOR_LINK}", $emb->resumen, $row_embajadores);
        $row_embajadores = str_replace("{ID}", $emb->id, $row_embajadores);
        $row_embajadores = str_replace("{ID_PLAN_EMB}", $emb->id_plan_emb, $row_embajadores);
        if ($datos_reunion_inicial[0]->plan == $emb->id_plan_emb) {
            $row_embajadores = str_replace("{VALUE_" . $emb->id_plan_emb . "}", $datos_reunion_inicial[0]->factor_exito, $row_embajadores);
        } else {
            $row_embajadores = str_replace("{VALUE_" . $emb->id_plan_emb . "}", "", $row_embajadores);
        }
    }
    $row_embajadores = str_replace("{SELECTED_" . $datos_reunion_inicial[0]->plan . "}", " checked='checked' ", $row_embajadores);
    return (utf8_encode($row_embajadores));
}
function ColocaListadoCertificaciones($PRINCIPAL, $rut, $id_empresa)
{
    $certificaciones = TraeCerficicacionesPorRutEmpresa($id_empresa, $rut);
    foreach ($certificaciones as $cert) {
        $row_certificacion .= file_get_contents("views/home/home_row_certificacion.html");
        $row_certificacion = str_replace("{NOMBRE_CERTIFICACIONES}", ($cert->certificacion), $row_certificacion);
        $valor             = str_replace(",", ".", $cert->nota);
        $row_certificacion = str_replace("{RESULTADO_CERTIFICACION}", $valor, $row_certificacion);
    }
    $PRINCIPAL = str_replace("{ROW_CERTIFICACIONES}", utf8_encode($row_certificacion), $PRINCIPAL);
    return ($PRINCIPAL);
}
function FormularioPost($PRINCIPAL, $id_mp, $id_empresa)
{
    $unico = com_mp_full_data($id_empresa, $id_mp);
    if ($unico) {
        $PRINCIPAL = str_replace("{VALOR_BOTON}", "Editar Publicacion", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ACTION}", "com_mp_edit_post", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_MP}", Encodear3($id_mp), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{VALOR_BOTON}", "Publicar", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ACTION}", "com_mp_save_post", $PRINCIPAL);
    }
    $PRINCIPAL          = str_replace("{TITULO}", utf8_encode($unico[0]->nombre), $PRINCIPAL);
    $PRINCIPAL          = str_replace("{LINK_YOUTUBE}", utf8_encode($unico[0]->video), $PRINCIPAL);
    //$PRINCIPAL = str_replace("{LINK_DOCUMENTO}",utf8_encode($unico[0]->archivo),$PRINCIPAL);
    $PRINCIPAL          = str_replace("{LINK_DOCUMENTO}", utf8_encode($unico[0]->url_documento), $PRINCIPAL);
    $PRINCIPAL          = str_replace("{FUENTE}", utf8_encode($unico[0]->fuente), $PRINCIPAL);
    $PRINCIPAL          = str_replace("{CONTENIDO}", utf8_encode($unico[0]->contenido), $PRINCIPAL);
    $PRINCIPAL          = str_replace("{RESUMEN}", utf8_encode($unico[0]->resumen), $PRINCIPAL);
    $PRINCIPAL          = str_replace("{SELECT_" . utf8_encode($unico[0]->tipo) . "}", "selected='selected'", $PRINCIPAL);
    $tags               = TagsPorMPEmpresa($id_mp, $id_empresa);
    $arreglo_tags       = "";
    $contador           = 1;
    $categorias_mp      = TraeCategoriasMejoresPracticas($id_empresa);
    $options_categorias = "";
    foreach ($categorias_mp as $cat) {
        if ($unico[0]->id_categoria == $cat->id_categoria) {
            $options_categorias .= "<option value='" . $cat->id_categoria . "' selected='selected'>" . $cat->categoria . "</option>";
        } else {
            $options_categorias .= "<option value='" . $cat->id_categoria . "'>" . $cat->categoria . "</option>";
        }
    }
    $array_MP_template = MP_BuscaTemplate($rut, $id_empresa);
    if ($array_MP_template[0]->template <> '') {
        $template = $array_MP_template[0]->template . "";
    } else {
        $template = "";
    }
    $ambitos_mp      = TraeAmbitosMejoresPracticas($id_empresa, $template);
    $options_ambitos = "";
    $options_ambitos .= "<option value=''>[ SELECCIONA ]</option>";
    foreach ($ambitos_mp as $ambito) {
        if ($unico[0]->id_ambito == $ambito->id_ambito) {
            $options_ambitos .= "<option value='" . $ambito->id_ambito . "' selected='selected'>" . $ambito->ambito . "</option>";
        } else {
            $options_ambitos .= "<option value='" . $ambito->id_ambito . "'>" . $ambito->ambito . "</option>";
        }
    }
    $PRINCIPAL = str_replace("{CATEGORIAS}", utf8_encode($options_categorias), $PRINCIPAL);
    $PRINCIPAL = str_replace("{AMBITOS}", utf8_encode($options_ambitos), $PRINCIPAL);
    foreach ($tags as $tg) {
        $arreglo_tags .= "#" . $tg->tag;
        if ($contador < count($tags)) {
            $arreglo_tags .= " ";
        }
        $contador++;
    }
    $PRINCIPAL = str_replace("{TAGS_MP}", utf8_encode($arreglo_tags), $PRINCIPAL);
    return ($PRINCIPAL);
}
function FormularioPostPregunta($PRINCIPAL, $id_mp, $id_empresa)
{
    $unico = com_mp_full_data($id_empresa, $id_mp);
    if ($unico) {
        $PRINCIPAL = str_replace("{VALOR_BOTON}", "Editar Pregunta", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ACTION}", "com_mp_edit_post_question", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_MP}", Encodear3($id_mp), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{VALOR_BOTON}", "Preguntar", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ACTION}", "com_mp_save_post_question", $PRINCIPAL);
    }
    $PRINCIPAL          = str_replace("{TITULO}", utf8_encode($unico[0]->nombre), $PRINCIPAL);
    $PRINCIPAL          = str_replace("{CONTENIDO}", utf8_encode($unico[0]->contenido), $PRINCIPAL);
    $PRINCIPAL          = str_replace("{RESUMEN}", utf8_encode($unico[0]->resumen), $PRINCIPAL);
    $contador           = 1;
    $categorias_mp      = TraeCategoriasMejoresPracticas($id_empresa);
    $options_categorias = "";
    foreach ($categorias_mp as $cat) {
        if ($unico[0]->id_categoria == $cat->id_categoria) {
            $options_categorias .= "<option value='" . $cat->id_categoria . "' selected='selected'>" . $cat->categoria . "</option>";
        } else {
            $options_categorias .= "<option value='" . $cat->id_categoria . "'>" . $cat->categoria . "</option>";
        }
    }
    $array_MP_template = MP_BuscaTemplate($rut, $id_empresa);
    if ($array_MP_template[0]->template <> '') {
        $template = $array_MP_template[0]->template . "";
    } else {
        $template = "";
    }
    $ambitos_mp      = TraeAmbitosMejoresPracticas($id_empresa, $template);
    $options_ambitos = "";
    $options_ambitos .= "<option value='' >[ SELECCIONA ]</option>";
    foreach ($ambitos_mp as $ambito) {
        if ($unico[0]->id_ambito == $ambito->id_ambito) {
            $options_ambitos .= "<option value='" . $ambito->id_ambito . "' selected='selected'>" . $ambito->ambito . "</option>";
        } else {
            $options_ambitos .= "<option value='" . $ambito->id_ambito . "'>" . $ambito->ambito . "</option>";
        }
    }
    $PRINCIPAL = str_replace("{CATEGORIAS}", utf8_encode($options_categorias), $PRINCIPAL);
    $PRINCIPAL = str_replace("{AMBITOS}", utf8_encode($options_ambitos), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaClasificacionesPrevia($PRINCIPAL, $id_empresa, $id_malla, $id_programa)
{
    $listado_clasificaciones = TraeClasificacionesPorEmpresaPrograma($id_empresa, $id_programa);
    foreach ($listado_clasificaciones as $list) {
        $row_listado .= file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_avance_clasificacion_home_plan.html");
        $row_listado = str_replace("{TITULO}", $list->nombre_clasificacion, $row_listado);
        $row_listado = str_replace("{DESCRIPCION}", $list->descripcion_clasificacion, $row_listado);
        $row_listado = str_replace("{CLAS_IMG_NIVEL}", $list->imagen_clasificacion, $row_listado);
        $row_listado = str_replace("{ID_MALLA_ENCODEADA}", Encodear3($id_malla), $row_listado);
    }
    $PRINCIPAL = str_replace("{ROWS_LISTADO_CLASIFICACIONES}", utf8_encode($row_listado), $PRINCIPAL);
    return ($PRINCIPAL);
}
function Com_Premios_ListadoPremios_RUT($PRINCIPAL, $rut, $id_empresa)
{
    $row_premio       = "";
    $traigoPremiosRut = traigoDimensionPremios_data_rut($rut, $id_empresa);
    foreach ($traigoPremiosRut as $traigoPremioRut) {
        //print_r($traigoPremioRut);
        $row_premio .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_row_premios.html");
        $row_premio = str_replace("{TITULO_PREMIO}", utf8_encode($traigoPremioRut->premio), $row_premio);
        $row_premio = str_replace("{TITULO_PREMIOLUDICO}", utf8_encode($traigoPremioRut->premioludico), $row_premio);
        $row_premio = str_replace("{NUM_PUNTOS}", utf8_encode($traigoPremioRut->puntos), $row_premio);



        $row_premio = str_replace("{ID_PREMIO}", utf8_encode($traigoPremioRut->id_premio), $row_premio);
        $row_premio = str_replace("{CONDICIONES}", utf8_encode($traigoPremioRut->condiciones), $row_premio);
        $row_premio = str_replace("{REQUISITOS}", utf8_encode($traigoPremioRut->requisitos), $row_premio);
    }
    //$row = str_replace("{ROW_PREMIOS}",$row_premio,$row);
    //print_r($row_premio);
    $PRINCIPAL = str_replace("{LISTADO_PREMIOS_RUT}", $row_premio, $PRINCIPAL);
    return $PRINCIPAL;
}
function Com_Premios_ListadoPremios($PRINCIPAL, $segmento, $id_empresa)
{
    $traigoDimensionPremios = traigoDimensionPremios_data($segmento, $id_empresa);
    //print_r($traigoDimensionPremios);
    foreach ($traigoDimensionPremios as $traigoDimensionPremio) {
       // print_r($traigoDimensionPremio);
        $row .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_row_dimensiones_premios.html");
        $row           = str_replace("{IMAGEN_DIMENSION}", $traigoDimensionPremio->foto, $row);
        $row           = str_replace("{ID_DIMENSION}", $traigoDimensionPremio->id_dimension, $row);
        $row           = str_replace("{ID_DIMENSION_ENCODEADA}", Encodear3($traigoDimensionPremio->id_dimension), $row);
        $row           = str_replace("{NOMBRE_DIMENSION}", $traigoDimensionPremio->dimension, $row);
        $row           = str_replace("{NUM_ITEMS_DIMENSION}", $traigoDimensionPremio->cuenta, $row);


        $traigoPremios = traigoPremios_data($segmento, $id_empresa, $traigoDimensionPremio->id_dimension);
        $row_premio    = "";
        foreach ($traigoPremios as $traigoPremio) {
            //print_r($traigoPremio);
            $row_premio .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_row_premios.html");
            $row_premio = str_replace("{TITULO_PREMIO}", utf8_encode($traigoPremio->premio), $row_premio);
            $row_premio = str_replace("{TITULO_PREMIOLUDICO}", utf8_encode($traigoPremio->premioludico), $row_premio);
            $row_premio = str_replace("{NUM_PUNTOS}", utf8_encode($traigoPremio->puntos), $row_premio);
            $row_premio = str_replace("{ID_PREMIO}", utf8_encode($traigoPremio->id_premio), $row_premio);
            $row_premio = str_replace("{CONDICIONES}", utf8_encode($traigoPremio->condiciones), $row_premio);
            $row_premio = str_replace("{REQUISITOS}", utf8_encode($traigoPremio->requisitos), $row_premio);
        }
        $row = str_replace("{ROW_PREMIOS}", $row_premio, $row);
    }
    $PRINCIPAL = str_replace("{LISTADO_PREMIOS}", $row, $PRINCIPAL);
    return $PRINCIPAL;
}

function Com_Premios_ListadoPremios_SinDimension_items($PRINCIPAL, $segmento, $id_empresa)
{
    $traigoDimensionPremios = traigoDimensionPremiosDimension_Item_Todos_data( $segmento, $id_empresa);

   foreach ($traigoDimensionPremios as $traigoDimensionPremio) {
        //print_r($traigoDimensionPremio);
        $row .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_Lista_Item_row_dimensiones_premios.html");
        $row           = str_replace("{IMAGEN_DIMENSION}", $traigoDimensionPremio->foto, $row);
        $row           = str_replace("{ID_DIMENSION}", $traigoDimensionPremio->id_dimension, $row);
        $row           = str_replace("{ID_DIMENSION_ENCODEADA}", Encodear3($traigoDimensionPremio->id_dimension), $row);
        $row           = str_replace("{NOMBRE_DIMENSION}", $traigoDimensionPremio->dimension, $row);

        $traigoPremios = traigoPremios_data($segmento, $id_empresa, $traigoDimensionPremio->id_dimension);
        $row_premio    = "";
        foreach ($traigoPremios as $traigoPremio) {
        //print_r($traigoPremio);

        $rut=$_SESSION["user_"];
        $exclusion=VerificaRutPremioExclusion($rut,$traigoPremio->id_premio, $id_empresa);

        if($exclusion>0){continue;}

        $estilo_imagen=" ";
        // echo "<br>premio ".$traigoPremio->id_premio." Saldo ".$traigoPremio->saldo." ultimas ".$traigoPremio->alertaultimasunidades."";

        $stock_txt="";
            if($traigoPremio->stock<=$traigoPremio->alertaultimasunidades){



        $stock_txt="<span class='badge badge-warning'><span class='blanco'><i class='fab fa-hotjar'></i>
Quedan s?lo ".$traigoPremio->saldo." disponibles </span> </span>";



            }

            if($traigoPremio->stock==0 and $traigoPremio->temporalidad==''){

        $stock_txt="<span class='badge badge-danger'><span class='blanco'>
Sin stock disponible </span> </span>";
        $estilo_imagen=" img_bn_grasycale ";

            }
                if($traigoPremio->stock==0 and $traigoPremio->temporalidad=='SI'){
                    continue;
            }



            $row_premio .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_Lista_Item_row_premios.html");

            $row_premio = str_replace("{ID_PREMIO_ENCODEADO}", Encodear3($traigoPremio->id_premio), $row_premio);
            $row_premio = str_replace("{ID_DIMENSION_ENCODEADO}", Encodear3($iddim), $row_premio);

            $row_premio = str_replace("{TITULO_PREMIO}", utf8_encode($traigoPremio->premio), $row_premio);
            $row_premio = str_replace("{TITULO_PREMIOLUDICO}", utf8_encode($traigoPremio->premioludico), $row_premio);

            $row_premio = str_replace("{DESCRIPCION_PREMIO}",resumir(utf8_encode($traigoPremio->premio_descripcion), 80," ", "..."), $row_premio);

            $row_premio = str_replace("{NUM_PUNTOS}", utf8_encode($traigoPremio->puntos), $row_premio);
            $row_premio = str_replace("{ID_PREMIO}", utf8_encode($traigoPremio->id_premio), $row_premio);
            $row_premio = str_replace("{CONDICIONES}", utf8_encode($traigoPremio->condiciones), $row_premio);
            $row_premio = str_replace("{REQUISITOS}", utf8_encode($traigoPremio->requisitos), $row_premio);
            $row_premio = str_replace("{ICONO}", utf8_encode($traigoPremio->premio_icono), $row_premio);
            $row_premio = str_replace("{IMAGEN}", utf8_encode($traigoPremio->imagen), $row_premio);

            $row_premio = str_replace("{ESTILO_IMAGEN}", $estilo_imagen, $row_premio);


            $row_premio = str_replace("{PUNTOS}", utf8_encode($traigoPremio->puntos), $row_premio);
            $row_premio = str_replace("{STOCK}", $stock_txt, $row_premio);



     }

        $row = str_replace("{ROW_PREMIOS}", $row_premio, $row);
    }
    $PRINCIPAL = str_replace("{LISTADO_DIMENSION_PREMIOS_ITEMS}", $row, $PRINCIPAL);
    return $PRINCIPAL;
}

function Com_Premios_ListadoPremios_dimension_items($PRINCIPAL, $segmento, $iddim, $id_empresa)
{
    $traigoDimensionPremios = traigoDimensionPremiosDimension_Item_data($iddim, $segmento, $id_empresa);

    foreach ($traigoDimensionPremios as $traigoDimensionPremio) {
        //print_r($traigoDimensionPremio);
        $row .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_Lista_Item_row_dimensiones_premios.html");
        $row           = str_replace("{IMAGEN_DIMENSION}", $traigoDimensionPremio->foto, $row);
        $row           = str_replace("{ID_DIMENSION}", $traigoDimensionPremio->id_dimension, $row);
        $row           = str_replace("{ID_DIMENSION_ENCODEADA}", Encodear3($traigoDimensionPremio->id_dimension), $row);
        $row           = str_replace("{NOMBRE_DIMENSION}", $traigoDimensionPremio->dimension, $row);

        $traigoPremios = traigoPremios_data($segmento, $id_empresa, $traigoDimensionPremio->id_dimension);
        $row_premio    = "";
        foreach ($traigoPremios as $traigoPremio) {
        //print_r($traigoPremio);

        $rut=$_SESSION["user_"];
        $exclusion=VerificaRutPremioExclusion($rut,$traigoPremio->id_premio, $id_empresa);

        if($exclusion>0){continue;}

        $estilo_imagen=" ";
       /*  echo "<br>premio ".$traigoPremio->id_premio." ".$traigoPremio->premio."
          Saldo ".$traigoPremio->saldo." stock ".$traigoPremio->stock." ultimas ".$traigoPremio->alertaultimasunidades.
          " temporalidad ".$traigoPremio->temporalidad;     */

        $stock_txt="";
            if($traigoPremio->saldo<=$traigoPremio->alertaultimasunidades){

        $stock_txt="<span class='badge badge-warning'><span class='blanco'><i class='fab fa-hotjar'></i>
        Quedan s?lo ".$traigoPremio->saldo." disponibles </span> </span>";

            }

            if($traigoPremio->saldo==0 or $traigoPremio->saldo<0){
                //echo "CERO";
                if($traigoPremio->temporalidad==''){
                   // echo "C";
                    $stock_txt="<span class='badge badge-danger'><span class='blanco'>
                    Sin stock disponible </span> </span>";
                    $estilo_imagen=" img_bn_grasycale ";
                }

                if($traigoPremio->temporalidad=='SI'){
                     //echo "B";
                     continue;
                }
            }


               // echo "<br>".$traigoPremio->premio." ";
               // echo "<br>fecha inicio ".$traigoPremio->fecha_inicio;
               // echo "<br>fecha_vencimiento ".$traigoPremio->fecha_vencimiento;
            $hoy=date("Y-m-d");
             if($traigoPremio->fecha_inicio=='0000-00-00' or $traigoPremio->fecha_inicio=='')
               {

               } else {
                    //echo "<br>".$traigoPremio->premio." SI&nbsp;TIENE fecha inicio";
                    if($traigoPremio->fecha_inicio>$hoy){continue;}
               }

               if($traigoPremio->fecha_vencimiento=='0000-00-00' or $traigoPremio->fecha_vencimiento=='')
               {
               } else {
                   if($traigoPremio->fecha_vencimiento<$hoy){continue;}
                   // echo "<br>".$traigoPremio->premio." SI&nbsp;TIENE fecha_vencimiento";

               }

            $row_premio .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_Lista_Item_row_premios.html");

            $row_premio = str_replace("{ID_PREMIO_ENCODEADO}", Encodear3($traigoPremio->id_premio), $row_premio);
            $row_premio = str_replace("{ID_DIMENSION_ENCODEADO}", Encodear3($iddim), $row_premio);

            $row_premio = str_replace("{TITULO_PREMIO}", utf8_encode($traigoPremio->premio), $row_premio);
            $row_premio = str_replace("{TITULO_PREMIOLUDICO}", utf8_encode($traigoPremio->premioludico), $row_premio);

            $row_premio = str_replace("{DESCRIPCION_PREMIO}",resumir(utf8_encode($traigoPremio->premio_descripcion), 80," ", "..."), $row_premio);

            $row_premio = str_replace("{NUM_PUNTOS}", utf8_encode($traigoPremio->puntos), $row_premio);
            $row_premio = str_replace("{ID_PREMIO}", utf8_encode($traigoPremio->id_premio), $row_premio);
            $row_premio = str_replace("{CONDICIONES}", utf8_encode($traigoPremio->condiciones), $row_premio);
            $row_premio = str_replace("{REQUISITOS}", utf8_encode($traigoPremio->requisitos), $row_premio);
            $row_premio = str_replace("{ICONO}", utf8_encode($traigoPremio->premio_icono), $row_premio);
            $row_premio = str_replace("{IMAGEN}", utf8_encode($traigoPremio->imagen), $row_premio);

            $row_premio = str_replace("{ESTILO_IMAGEN}", $estilo_imagen, $row_premio);


            $row_premio = str_replace("{PUNTOS}", utf8_encode($traigoPremio->puntos), $row_premio);
            $row_premio = str_replace("{STOCK}", $stock_txt, $row_premio);



     }

        $row = str_replace("{ROW_PREMIOS}", $row_premio, $row);
    }
    $PRINCIPAL = str_replace("{LISTADO_DIMENSION_PREMIOS_ITEMS}", $row, $PRINCIPAL);
    return $PRINCIPAL;
}


function resumir($texto, $limite, $car=".", $final="?")
{
if(strlen($texto) <= $limite) return $texto;
  if(false !== ($breakpoint = strpos($texto, $car, $limite)))
  {
   $val=strlen($texto)-1;
   if( $breakpoint < $val)
   {
    $texto= substr($texto, 0, $breakpoint) . $final;
   }
  }
return $texto;
}

function Com_Premios_ListadoPremios_ITEMS($PRINCIPAL, $id_dimension, $segmento, $id_empresa)
{


        $traigoPremios = traigoPremios_data($segmento, $id_empresa, $id_dimension);
        $row_premio    = "";
        foreach ($traigoPremios as $traigoPremio) {
            //print_r($traigoPremio);
            $row_premio .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_row_premios.html");
            $row_premio = str_replace("{TITULO_PREMIO}", utf8_encode($traigoPremio->premio), $row_premio);
            $row_premio = str_replace("{TITULO_PREMIOLUDICO}", utf8_encode($traigoPremio->premioludico), $row_premio);
            $row_premio = str_replace("{NUM_PUNTOS}", utf8_encode($traigoPremio->puntos), $row_premio);
            $row_premio = str_replace("{ID_PREMIO}", utf8_encode($traigoPremio->id_premio), $row_premio);
            $row_premio = str_replace("{CONDICIONES}", utf8_encode($traigoPremio->condiciones), $row_premio);
            $row_premio = str_replace("{REQUISITOS}", utf8_encode($traigoPremio->requisitos), $row_premio);
            $row_premio = str_replace("{DESCRIPCION}", utf8_encode($traigoPremio->premio_descripcion), $row_premio);
        }

    $PRINCIPAL = str_replace("{LISTADO_PREMIOS_ITEMS}", $row_premio, $PRINCIPAL);
    return $PRINCIPAL;
}


function Com_Premios_ListadoPremios_ITEMS_portfolio($PRINCIPAL, $id_empresa)
{


        $traigoPremios = traigoPremios_Portfolio_data($id_empresa);
       // print_r($traigoPremios);
        $row_premio    = "";
        foreach ($traigoPremios as $traigoPremio) {
            //print_r($traigoPremio);
            $row_premio .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_Lista_Item_row_premios.html");
            $row_premio = str_replace("{TITULO_PREMIO}", utf8_encode($traigoPremio->premio), $row_premio);
            $row_premio = str_replace("{TITULO_PREMIOLUDICO}", utf8_encode($traigoPremio->premioludico), $row_premio);
            $row_premio = str_replace("{NUM_PUNTOS}", utf8_encode($traigoPremio->puntos), $row_premio);
            $row_premio = str_replace("{ID_PREMIO}", utf8_encode($traigoPremio->id_premio), $row_premio);
            $row_premio = str_replace("{CONDICIONES}", utf8_encode($traigoPremio->condiciones), $row_premio);
            $row_premio = str_replace("{REQUISITOS}", utf8_encode($traigoPremio->requisitos), $row_premio);
            $row_premio = str_replace("{DESCRIPCION_PREMIOS}", utf8_encode($traigoPremio->premio_descripcion), $row_premio);
            $row_premio = str_replace("{IMAGEN}", utf8_encode($traigoPremio->imagen), $row_premio);

            $row_premio = str_replace("{ID_DIMENSION}", utf8_encode($traigoPremio->id_dimension), $row_premio);
            $row_premio = str_replace("{ID_PREMIO_ENCODEADO}",      Encodear3($traigoPremio->id_premio), $row_premio);
            $row_premio = str_replace("{ID_DIMENSION_ENCODEADO}",   Encodear3($traigoPremio->id_dimension), $row_premio);

        }

    $PRINCIPAL = str_replace("{LISTADO_PREMIOS_ITEMS}", $row_premio, $PRINCIPAL);
    return $PRINCIPAL;
}

function ColocaListadoSesionesPorImparticion($PRINCIPAL, $rut, $id_imparticion, $id_empresa)
{
    $sesiones = TraeSesionesPorImparticion2($id_empresa, $id_imparticion);
    //echo "<pre>";
    //print_r($sesiones);
    foreach ($sesiones as $sesion) {
        $sesion_fecha        = date("d-m-Y", strtotime($sesion->fecha));
        $hoy                 = date("Y-m-d");
        $fecha_ses           = $sesion->fecha;
        //echo "<br>$hoy $fecha_ses _ ";
        //echo " - $rut, $id_imparticion, $id_empresa, $sesion->id";
        $EstaChequeadoSesion = VerificaSesionChequeado($rut, $id_imparticion, $id_empresa, $sesion->id);
        //echo "<br>";    echo $EstaChequeadoSesion[0]->cuenta;
        $Iconocheck          = "";
        if ($EstaChequeadoSesion[0]->cuenta == 1) {
            $Iconocheck = "<i class='icon-check icons'></i>";
        }
        //echo
        if ($fecha_ses > $hoy) {
            //echo  "1";
            //verifica si est? o no chequear
            $boton_checkin = "    <center>Falta a?n tiempo para que te chequees en esta sesi?n</center>";
        } elseif ($fecha_ses == $hoy) {
            //echo "2";
            //aparece boton chequear
            $boton_checkin = "    <center>
                <a href='?sw=CI_registraUsuarioCurso&buscacodigo={CODIGO_IMPARTICION}&idse={IDSESION}&fec=" . $fecha_ses . "' class='btn btn-success btn-block '>
                <span class='blanco'> $Iconocheck Hacer Check In </span></a>
            </center>";
        } elseif ($fecha_ses < $hoy) {
            //echo "3";
            //boton Ingresar
            $boton_checkin = "
                <a href='?sw=CI_registraUsuarioCurso&buscacodigo={CODIGO_IMPARTICION}&idse={IDSESION}&fec=" . $fecha_ses . "''
                 class='btn btn-success'>
                    <span class='blanco'> $Iconocheck Ingresar </span></a>
            ";
        }
        $row .= file_get_contents("views/checkin/CI_row_entorno_home_codigo.html");
        $row = str_replace("{FECHA}", $sesion_fecha, $row);
        $row = str_replace("{BOTON_CHECKIN}", $boton_checkin, $row);
        $row = str_replace("{CODIGO_IMPARTICION}", Encodear3($sesion->codigo_inscripcion), $row);
        $row = str_replace("{IDSESION}", $sesion->id, $row);
        $row = str_replace("{NOMBRE_RELATOR}", $sesion->nombre_relator, $row);
    }
    $PRINCIPAL = str_replace("{ROW_LISTADO_CHECKINS}", $row, $PRINCIPAL);
    return ($PRINCIPAL);
}
//Muestra fecha tipo Facebook
function nicetime($date)
{
    if (empty($date)) {
        return "No hay fecha que mostrar";
    }
    $periods   = array(
        "segundo",
        "minuto",
        "hora",
        "dia",
        "semana",
        "mes",
        "a?o",
        "decada"
    );
    $lengths   = array(
        "60",
        "60",
        "24",
        "7",
        "4.35",
        "12",
        "10"
    );
    $now       = time();
    $unix_date = strtotime($date);
    // check validity of date
    if (empty($unix_date)) {
        return "Bad date";
    }
    // is it future date or past date
    if ($now > $unix_date) {
        $difference = $now - $unix_date;
        $tense      = "hace";
    } else {
        $difference = $unix_date - $now;
        $tense      = "from now";
    }
    for ($j = 0; $difference >= $lengths[$j] && $j < count($lengths) - 1; $j++) {
        $difference /= $lengths[$j];
    }
    $difference = round($difference);
    if ($difference != 1) {
        $periods[$j] .= "s";
    }
    return "<span class=\"mini\">{$tense}</span><span class=\"big\"> $difference </span><span class=\"mini\">$periods[$j]</span> ";
}
function MisDesafios($id_empresa, $id_objeto, $rut)
{
    $desafios = TotalDesafiosPreguntados($id_empresa, $id_objeto, $rut);
    foreach ($desafios as $desa) {
        //$row.=file_get_contents("views/goplay/row_desafios.html");
        $row .= file_get_contents("views/goplay/" . $id_empresa . "_row_desafios.html");
        if ($desa->rut_desafiante == $rut) {
            $row = str_replace("{TIPO_DESAFIO}", "Desafiante", $row);
        } else {
            $row = str_replace("{TIPO_DESAFIO}", "Desafiado", $row);
        }
        $avance_por_usuario    = Goplay_ColocaAvancePorNivel($row, $desa->rut, $id_empresa, $id_objeto);
        $row                   = $avance_por_usuario[0];
        //$row = str_replace("{BOTON_ACCEDER_GANO_O_PERDIO}",file_get_contents("views/goplay/".$id_empresa."_row_desafios_perdido.html"),$row);
        //$row = str_replace("{BOTON_ACCEDER_GANO_O_PERDIO}",file_get_contents("views/goplay/".$id_empresa."_row_desafios_ganado.html"),$row);
        //$row = str_replace("{BOTON_ACCEDER_GANO_O_PERDIO}",file_get_contents("views/goplay/".$id_empresa."_row_desafios_acceso.html"),$row);
        //$row = str_replace("{BOTON_ACCEDER_GANO_O_PERDIO}",file_get_contents("views/goplay/".$id_empresa."_row_desafios_perdido.html"),$row);
        //$row = str_replace("{BOTON_ACCEDER_GANO_O_PERDIO}",file_get_contents("views/goplay/".$id_empresa."_row_desafios_ganado.html"),$row);
        //print_R($datos_resumen_desafio);
        //echo "<br><br>";
        $datos_resumen_desafio = ObtenerDatosTriviaPreguntados($rut, $id_empresa, $id_objeto, $desa->id);
        $row                   = str_replace("{ESTADO}", $datos_resumen_desafio[8], $row);
        if ($datos_resumen_desafio[9] == "Finalizado" or $datos_resumen_desafio[9] == "Cerrado") {
            //Traigo el rut ganador de este desafio
            $datos_desafio = TraeDatosDEsafioPreguntados($desa->id);
            if ($datos_desafio[0]->rut_ganador) {
                if ($rut == $datos_desafio[0]->rut_ganador) {
                    $row = str_replace("{GANADO_PERDIDO}", "<img src='img/be_winbig.png' width='50px'><span class='badge badge-pill badge-success'>Desaf?o Ganado</span>", $row);
                } else {
                    $row = str_replace("{GANADO_PERDIDO}", "<img src='img/be_crying.png' width='50px'><span class='badge badge-pill badge-danger'>Desaf?o Perdido</span>", $row);
                }
                $row = str_replace("{BOTON_ACCEDER_GANO_O_PERDIO}", file_get_contents("views/goplay/" . $id_empresa . "_row_desafios_acceso_finalizado.html"), $row);
            } else {
                $row = str_replace("{GANADO_PERDIDO}", "", $row);
                $row = str_replace("{BOTON_ACCEDER_GANO_O_PERDIO}", file_get_contents("views/goplay/" . $id_empresa . "_row_desafios_acceso.html"), $row);
            }
        } else {
            $row = str_replace("{GANADO_PERDIDO}", "", $row);
            $row = str_replace("{BOTON_ACCEDER_GANO_O_PERDIO}", file_get_contents("views/goplay/" . $id_empresa . "_row_desafios_acceso.html"), $row);
        }
        $row = str_replace("{IMAGEN_DESAFIANTE}", VerificaFotoPersonal($desa->rut_desafiante), $row);
        $row = str_replace("{IMAGEN_DESAFIADO}", VerificaFotoPersonal($desa->rut_desafiado), $row);
        $row = str_replace("{NOMBRE_DESAFIANTE}", $desa->nombre_desafiante, $row);
        $row = str_replace("{NOMBRE_DESAFIADO}", $desa->nombre_desafiado, $row);
        $row = str_replace("{FECHA_DESAFIO}", $desa->fecha, $row);
        $row = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($id_objeto), $row);
        $row = str_replace("{ID_DESAFIO_ENCODEADO}", Encodear3($desa->id), $row);
    }
    $arreglo[0] = $row;
    return ($arreglo);
}
function Goplay_SalonDeLaFamaPreguntados($PRINCIPAL, $id_empresa, $id_objeto, $nivel_vista, $nivel)
{
    //$usuarios=TotalUsuariosSalonFamaPreguntados($id_empresa, $id_objeto);
    $usuarios            = TotalUsuariosSalonFamaPreguntadosOrdenGanadosPuntosTiempo($id_empresa, $id_objeto);
    //echo "<pre>";    //print_r($usuarios);    //exit();
    $num_resultados_fama = count($usuarios);
    //echo "num resultados fama $num_resultados_fama";
    $i                   = 1;
    foreach ($usuarios as $usu) {
        if ($nivel_vista == "nivel2") {
            $template_row = file_get_contents("views/goplay/" . $id_empresa . "row_salon_fama_nivel2.html");
            $avances      = Goplay_ColocaAvancePorNivel($template_row, $usu->rut, $id_empresa, $id_objeto, $nivel);
            if ($avances[1] == 100) {
                $html_salon_fama .= $avances[0];
            } else {
                continue;
            }
        } else {
            $template_row = file_get_contents("views/goplay/" . $id_empresa . "_row_salon_fama.html");
            $avances      = Goplay_ColocaAvancePorNivel($template_row, $usu->rut, $id_empresa, $id_objeto, 1);
            $html_salon_fama .= $avances[0];
        }
        $html_salon_fama = str_replace("{NOMBRE_USUARIO}", utf8_decode($usu->nombre_completo), $html_salon_fama);
        $html_salon_fama = str_replace("{NUMERO}", $i, $html_salon_fama);
        $i++;
        $html_salon_fama = str_replace("{RUT_DESAFIANTE}", $_SESSION["user_"], $html_salon_fama);
        $html_salon_fama = str_replace("{RUT_DESAFIADO}", $usu->rut, $html_salon_fama);
        $html_salon_fama = str_replace("{ID_OBJETO}", $id_objeto, $html_salon_fama);
        if ($usu->rut == $_SESSION["user_"]) {
            $html_salon_fama = str_replace("{CLASE_SELECCIONADO}", "seleccionado_salon_fama", $html_salon_fama);
        } else {
            $html_salon_fama = str_replace("{CLASE_SELECCIONADO}", "", $html_salon_fama);
        }
        //$html_salon_fama=$avances[0];
        $html_salon_fama = str_replace("{IMAGEN_PERSONA}", VerificaFotoPersonal($usu->rut), $html_salon_fama);
    }
    $PRINCIPAL = str_replace("{LISTADO_SALON_FAMA_GOPLAY}", $html_salon_fama, $PRINCIPAL);
    return ($PRINCIPAL);
}
function Goplay_ColocaAvancePorNivel($PRINCIPAL, $rut, $id_empresa, $id_objeto, $nivel)
{
    $resultados_por_intento = TotalPuntajesPorIntento($id_empresa, $id_objeto, $rut, $nivel);
    $avance_nivel           = 0;
    $suma_correctas         = 0;
    $desafios_ganados       = 0;
    foreach ($resultados_por_intento as $res) {
        if ($res->total <> 5)
            continue;
        if ($res->total == $res->suma_correctas) {
            $avance_nivel = $avance_nivel + 20;
            $desafios_ganados++;
        } else {
            //$avance_nivel=$avance_nivel+5;
            $avance_nivel = $avance_nivel + 20;
        }
        $suma_correctas   = $suma_correctas + $res->suma_correctas;
        $total_respuestas = $total_respuestas + $res->total;
    }
    $desafios_ganados_nivel2 = PreguntadosDesafiosGanadosTablaDesafios($rut);
    $PRINCIPAL               = str_replace("{TOTAL_DESAFIOS_GANADOS_PREGUNTADOS}", count($desafios_ganados_nivel2), $PRINCIPAL);
    if ($avance_nivel >= 100) {
        $avance_nivel = 100;
    }
    //echo "--- ".$avance_nivel." avance nivel <br>";
    $porcentaje_efectivida = round((100 * $suma_correctas) / $total_respuestas);
    $PRINCIPAL             = str_replace("{POR_AVANCE_NIVEL}", $avance_nivel, $PRINCIPAL);
    $PRINCIPAL             = str_replace("{POR_AVANCE_NIVEL" . $nivel . "}", $avance_nivel, $PRINCIPAL);
    $PRINCIPAL             = str_replace("{SUMA_BCI_COINS}", $suma_correctas, $PRINCIPAL);
    $PRINCIPAL             = str_replace("{TOTAL_DESAFIOS_GANADOS}", $desafios_ganados, $PRINCIPAL);
    //$PRINCIPAL = str_replace("{TOTAL_DESAFIOS_GANADOS_PREGUNTADOS_GLOBAL}",$desafios_ganados+count($desafios_ganados_nivel2),$PRINCIPAL);
    //Total trivias ganadas
    $total_global_ganados  = PREGUNTADOS_RegistrosGanadosPorRut($rut);
    $PRINCIPAL             = str_replace("{TOTAL_DESAFIOS_GANADOS_PREGUNTADOS_GLOBAL}", count($total_global_ganados), $PRINCIPAL);
    $PRINCIPAL             = str_replace("{PORCENTAJE_EFECTIVIDAD}", $porcentaje_efectivida, $PRINCIPAL);
    $PRINCIPAL             = str_replace("{CANTIDAD_DESAFIOS}", count($resultados_por_intento), $PRINCIPAL);
    //echo "entrenamientos ganados $desafios_ganados desafios ganados ".count($desafios_ganados_nivel2);
    //ESTADO GLOBAL
    $estado_nivel0         = PreguntadosEstadoNivel0($rut);
    if ($estado_nivel0) {
        if ($avance_nivel == 100) {
            $PRINCIPAL = str_replace("{NIVEL_GLOBAL}", "3", $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{NIVEL_GLOBAL}", "2", $PRINCIPAL);
        }
    } else {
        $PRINCIPAL = str_replace("{NIVEL_GLOBAL}", "1", $PRINCIPAL);
    }
    $arreglo[0] = $PRINCIPAL;
    $arreglo[1] = $avance_nivel;
    return ($arreglo);
}

function limit_words($string, $word_limit)
{
    $words = explode(" ",$string);
    return implode(" ",array_splice($words,0,$word_limit));
}


function MuestraEvaluacionFeedbackPreguntados($id_evaluacion, $rut, $id_desafio_preguntados, $numero_intentos_actual)
{
    //echo "$id_evaluacion, $rut, $id_desafio_preguntados, $numero_intentos_actual";
    $id_empresa               = $_SESSION["id_empresa"];
    //function MuestraEvaluacion($PRINCIPAL, $id_evaluacion, $rut){
    //ID_EVALUACION CORRESPONDE AL ID DEL OBJETO
    $datos_objeto             = DatosObjeto($id_evaluacion);
    $id_evaluacion_por_objeto = $datos_objeto[0]->id_evaluacion; //Id de la evaluacion. Este es el que se obtiene desde el campo id evaluacion de la tabla objeto
    $datos_evaluacion         = DatosEvaluacion($datos_objeto[0]->id_evaluacion);
    //Veo si est? en la tabla sesion esta evaluacion, y este usuario
    $tiene_sesion             = SesionEvaluacionContenidos($id_evaluacion, $rut);
    $total_preguntas          = PreguntasDadoEvaluacion($id_evaluacion_por_objeto);
    //ACA VALIDA SI ES QUE EL OBJETO, QUE CONTIENE ESTA EVALUACION, TIENE PREGUNTAS ALEATORIAS O NO.
    //SI NO TIENE ALEATORIAS, LAS MUESTRA TODAS
    if ($datos_objeto[0]->preguntas_aleatorias > 0) {
        //Asigno a una tabla,si es que no esta asignado obviamente. La cantidad que corresponda de preguntas, asociadas al rut, curso y objeto.
        $tiene_preguntas_asociadas = VerificaSiTienePReguntasAsociadasRandomicas($rut, $id_evaluacion_por_objeto, $datos_objeto[0]->id);
        if (count($tiene_preguntas_asociadas) == 0) {
            shuffle($total_preguntas);
            $vueltas = 1;
            foreach ($total_preguntas as $pre) {
                InsertoRegistroPreguntasAleatorias($rut, $id_evaluacion_por_objeto, $datos_objeto[0]->id, $vueltas, $pre->id, $datos_objeto[0]->id_curso);
                if ($vueltas == $datos_objeto[0]->preguntas_aleatorias)
                    break;
                $vueltas++;
            }
        }
        if ($tiene_sesion) {
            //echo "1.1<br>";
            $pagina                           = $tiene_sesion[0]->pagina - 1;
            $pregunta                         = PreguntaDeEvaluacionAleatorias($id_evaluacion_por_objeto, $pagina, $rut);
            //echo "views/cursos/evaluacion/".$pregunta[0]->template_pregunta_feedback;
            $PRINCIPAL                        = FuncionesTransversales(file_get_contents("views/goplay/" . $id_empresa . "_ambiente_evaluacion_con_textos_feedback.html"));
            $PRINCIPAL                        = str_replace("{TEXTO_PREGUNTA}", ($pregunta[0]->pregunta), $PRINCIPAL);
            //Funcion para mostrar las alternativas
            $PRINCIPAL                        = str_replace("{OPCIONES}", MuestraAlternativas($pregunta[0]->id_grupo_alternativas, $pregunta[0]->id), $PRINCIPAL);
            $PRINCIPAL                        = str_replace("{ID_PREGUNTA_ENCODEADO}", Encodear3($pregunta[0]->id), $PRINCIPAL);
            $PRINCIPAL                        = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($id_evaluacion), $PRINCIPAL);
            $PRINCIPAL                        = str_replace("{URL_IMAGEN}", $pregunta[0]->url_archivo, $PRINCIPAL);
            $PRINCIPAL                        = str_replace("{NUMERO_PREGUNTA}", $pagina, $PRINCIPAL);
            $PRINCIPAL                        = str_replace("{TEXTO_PREGUNTA_BAJADA1}", $pregunta[0]->bajada1, $PRINCIPAL);
            $PRINCIPAL                        = str_replace("{TEXTO_PREGUNTA_BAJADA2}", $pregunta[0]->bajada2, $PRINCIPAL);
            $PRINCIPAL                        = str_replace("{TEXTO_PREGUNTA_BAJADA3}", $pregunta[0]->bajada3, $PRINCIPAL);
            $PRINCIPAL                        = str_replace("{TEXTO_PREGUNTA_BAJADA4}", $pregunta[0]->bajada4, $PRINCIPAL);
            $PRINCIPAL                        = str_replace("{TEXTO_PREGUNTA_REFUERZO1}", $pregunta[0]->refuerzo1, $PRINCIPAL);
            $PRINCIPAL                        = str_replace("{TEXTO_PREGUNTA_REFUERZO2}", $pregunta[0]->refuerzo2, $PRINCIPAL);
            $PRINCIPAL                        = str_replace("{TEXTO_PREGUNTA_REFUERZO3}", $pregunta[0]->refuerzo3, $PRINCIPAL);
            $PRINCIPAL                        = str_replace("{TEXTO_PREGUNTA_REFUERZO4}", $pregunta[0]->refuerzo4, $PRINCIPAL);
            $PRINCIPAL                        = str_replace("{TEXTO_PREGUNTA_REFUERZO5}", $pregunta[0]->refuerzo5, $PRINCIPAL);
            $PRINCIPAL                        = str_replace("{TEXTO_PREGUNTA_REFUERZO6}", $pregunta[0]->refuerzo6, $PRINCIPAL);
            $respuesta_correcta               = ObtenerRespuestaDeUsuario($pregunta[0]->id, $rut);
            $respuestas_correctas_por_intento = ObtengoCantidadDeRespuestasPorColaboradorPorIntentos($rut, $datos_objeto[0]->id, $id_empresa, $numero_intentos_actual);
            $puntos_obtenidos                 = $respuestas_correctas_por_intento[0]->puntos;
            //echo "$puntos_obtenidos $puntos_obtenidos";
            //print_r($respuestas_correctas_por_intento);
            $estado_eval                      = VeEstadoTriviaPreguntadosPorIntentos($rut, $numero_intentos_actual, $datos_objeto[0]->id, $id_empresa);
            //if($respuesta_correcta[0]->correcta=="1"){
            if ($estado_eval == "Ganaste") {
                $total_respuestas = PREGUNTADOS_TraeRespuestasTriviasPreguntadosPorIntento($id_empresa, $numero_intentos_actual, $rut);
                $total_Tiempo     = tiempoTranscurridoFechasPreguntados($total_respuestas[0]->fecha . " " . $total_respuestas[0]->hora, $total_respuestas[4]->fecha . " " . $total_respuestas[4]->hora);
                //PREGUNTADOS_insertaRegistroGanador($rut, $numero_intentos_actual, "", $total_Tiempo[3]);
                $PRINCIPAL        = str_replace("{RESULTADO}", "CORRECTO", $PRINCIPAL);
                $PRINCIPAL        = str_replace("{CLASERESULTADO}", "goplay_feedbackcorrecto", $PRINCIPAL);
                $PRINCIPAL        = str_replace("{GOPLAY_FOTO_ANIMADA}", "<img src='img/go_play_ok.png' class='img-rounded'>", $PRINCIPAL);
                $PRINCIPAL        = str_replace("{GOPLAY_ICON}", "<img src='img/be_in-love.png' class='img-rounded'>", $PRINCIPAL);
                $PRINCIPAL        = str_replace("{GOPLAY_TITULO_TEXTO}", "?Excelente! ?Muy buen trabajo!", $PRINCIPAL);
                $PRINCIPAL        = str_replace("{GOPLAY_TITULO_TEXTO_puntos}", "Ganaste $puntos_obtenidos Punto(s)", $PRINCIPAL);
                $PRINCIPAL        = str_replace("{GOPLAY_TEXTO}", "Recuerda que siempre puedes volver a revisar los contenidos en la secci?n <STRONG>Prepara</STRONG> y as? obtener cada vez mejores resultados.", $PRINCIPAL);
            } else {
                $PRINCIPAL = str_replace("{RESULTADO}", "INCORRECTO", $PRINCIPAL);
                $PRINCIPAL = str_replace("{CLASERESULTADO}", "goplay_feedbackincorrecto", $PRINCIPAL);
                $PRINCIPAL = str_replace("{GOPLAY_FOTO_ANIMADA}", "<img src='img/go_play_nook.png' class='img-rounded'>", $PRINCIPAL);
                $PRINCIPAL = str_replace("{GOPLAY_ICON}", "<img src='img/be_crying.png' class='img-rounded'>", $PRINCIPAL);
                $PRINCIPAL = str_replace("{GOPLAY_TITULO_TEXTO}", "No te ha ido muy bien...", $PRINCIPAL);
                $PRINCIPAL = str_replace("{GOPLAY_TITULO_TEXTO_puntos}", "Ganaste $puntos_obtenidos Punto(s)", $PRINCIPAL);
                $PRINCIPAL = str_replace("{GOPLAY_TEXTO}", "Te recomendamos que vuelvas a revisar y a leer con atenci?n los contenidos en la secci?n Prepara<BR><BR>
                <STRONG> ?Vamos que se puede!</STRONG>", $PRINCIPAL);
            }
        } else {
            //echo "2.1<br>";
            $pagina = 1;
            //Ingreso el registro de la sesion con pagina 1
            InsertaRegistroTablaSesionEvaluacionContenido($rut, $id_evaluacion, $pagina);
            $pregunta                         = PreguntaDeEvaluacionAleatorias($id_evaluacion_por_objeto, $pagina, $rut);
            $PRINCIPAL                        = FuncionesTransversales(file_get_contents("views/goplay/" . $id_empresa . "_ambiente_evaluacion_con_textos_feedback.html"));
            $PRINCIPAL                        = str_replace("{TEXTO_PREGUNTA}", ($pregunta[0]->pregunta), $PRINCIPAL);
            //Funcion para mostrar las alternativas
            $PRINCIPAL                        = str_replace("{OPCIONES}", MuestraAlternativas($pregunta[0]->id_grupo_alternativas, $pregunta[0]->id), $PRINCIPAL);
            $PRINCIPAL                        = str_replace("{ID_PREGUNTA_ENCODEADO}", Encodear3($pregunta[0]->id), $PRINCIPAL);
            $PRINCIPAL                        = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($id_evaluacion), $PRINCIPAL);
            $PRINCIPAL                        = str_replace("{NUMERO_PREGUNTA}", $pagina, $PRINCIPAL);
            $PRINCIPAL                        = str_replace("{TEXTO_PREGUNTA_BAJADA1}", $pregunta[0]->bajada1, $PRINCIPAL);
            $PRINCIPAL                        = str_replace("{TEXTO_PREGUNTA_BAJADA2}", $pregunta[0]->bajada2, $PRINCIPAL);
            $PRINCIPAL                        = str_replace("{TEXTO_PREGUNTA_BAJADA3}", $pregunta[0]->bajada3, $PRINCIPAL);
            $PRINCIPAL                        = str_replace("{TEXTO_PREGUNTA_BAJADA4}", $pregunta[0]->bajada4, $PRINCIPAL);
            $PRINCIPAL                        = str_replace("{TEXTO_PREGUNTA_REFUERZO1}", $pregunta[0]->refuerzo1, $PRINCIPAL);
            $PRINCIPAL                        = str_replace("{TEXTO_PREGUNTA_REFUERZO2}", $pregunta[0]->refuerzo2, $PRINCIPAL);
            $PRINCIPAL                        = str_replace("{TEXTO_PREGUNTA_REFUERZO3}", $pregunta[0]->refuerzo3, $PRINCIPAL);
            $PRINCIPAL                        = str_replace("{TEXTO_PREGUNTA_REFUERZO4}", $pregunta[0]->refuerzo4, $PRINCIPAL);
            $PRINCIPAL                        = str_replace("{TEXTO_PREGUNTA_REFUERZO5}", $pregunta[0]->refuerzo5, $PRINCIPAL);
            $PRINCIPAL                        = str_replace("{TEXTO_PREGUNTA_REFUERZO6}", $pregunta[0]->refuerzo6, $PRINCIPAL);
            $respuesta_correcta               = ObtenerRespuestaDeUsuario($pregunta[0]->id, $rut);
            $estado_eval                      = VeEstadoTriviaPreguntadosPorIntentos($rut, $numero_intentos_actual, $datos_objeto[0]->id, $id_empresa);
            $respuestas_correctas_por_intento = ObtengoCantidadDeRespuestasPorColaboradorPorIntentos($rut, $datos_objeto[0]->id, $id_empresa, $numero_intentos_actual);
            $puntos_obtenidos                 = $respuestas_correctas_por_intento[0]->puntos;
            if ($estado_eval == "Ganaste") {
                $PRINCIPAL        = str_replace("{RESULTADO}", "CORRECTO", $PRINCIPAL);
                $PRINCIPAL        = str_replace("{CLASERESULTADO}", "goplay_feedbackcorrecto", $PRINCIPAL);
                $PRINCIPAL        = str_replace("{GOPLAY_FOTO_ANIMADA}", "<img src='img/go_play_ok.png' class='img-rounded'>", $PRINCIPAL);
                $PRINCIPAL        = str_replace("{GOPLAY_ICON}", "<img src='img/be_in-love.png' class='img-rounded'>", $PRINCIPAL);
                $PRINCIPAL        = str_replace("{GOPLAY_TITULO_TEXTO}", "?Excelente! ?Muy buen trabajo!", $PRINCIPAL);
                $PRINCIPAL        = str_replace("{GOPLAY_TITULO_TEXTO_puntos}", "Ganaste $puntos_obtenidos Punto(s)", $PRINCIPAL);
                $PRINCIPAL        = str_replace("{GOPLAY_TEXTO}", "Recuerda que siempre puedes volver a revisar los contenidos en la secci?n <STRONG>Prepara</STRONG> y as? obtener cada vez mejores resultados.", $PRINCIPAL);
                $total_respuestas = PREGUNTADOS_TraeRespuestasTriviasPreguntadosPorIntento($id_empresa, $numero_intentos_actual, $rut);
                $total_Tiempo     = tiempoTranscurridoFechasPreguntados($total_respuestas[0]->fecha . " " . $total_respuestas[0]->hora, $total_respuestas[4]->fecha . " " . $total_respuestas[4]->hora);
                //PREGUNTADOS_insertaRegistroGanador($rut, $numero_intentos_actual, "", $total_Tiempo[3]);
            } else {
                $PRINCIPAL = str_replace("{RESULTADO}", "INCORRECTO", $PRINCIPAL);
                $PRINCIPAL = str_replace("{CLASERESULTADO}", "goplay_feedbackincorrecto", $PRINCIPAL);
                $PRINCIPAL = str_replace("{GOPLAY_FOTO_ANIMADA}", "<img src='img/go_play_nook.png' class='img-rounded'>", $PRINCIPAL);
                $PRINCIPAL = str_replace("{GOPLAY_ICON}", "<img src='img/be_crying.png' class='img-rounded'>", $PRINCIPAL);
                $PRINCIPAL = str_replace("{GOPLAY_TITULO_TEXTO}", "No te ha ido muy bien...", $PRINCIPAL);
                $PRINCIPAL = str_replace("{GOPLAY_TITULO_TEXTO_puntos}", "Ganaste $puntos_obtenidos Punto(s)", $PRINCIPAL);
                $PRINCIPAL = str_replace("{GOPLAY_TEXTO}", "Te recomendamos que vuelvas a revisar y a leer con atenci?n los contenidos en la secci?n Prepara<BR><BR>
                <STRONG> ?Vamos que se puede!</STRONG>", $PRINCIPAL);
            }
        }
    } else {
        //echo "3.1<br>";
        if ($tiene_sesion) {
            //$pagina=$tiene_sesion[0]->pagina;
            $pagina             = $tiene_sesion[0]->pagina - 1;
            $pregunta           = PreguntaDeEvaluacion($id_evaluacion_por_objeto, $pagina);
            $PRINCIPAL          = FuncionesTransversales(file_get_contents("views/goplay/" . $id_empresa . "_ambiente_evaluacion_con_textos_feedback.html"));
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA}", ($pregunta[0]->pregunta), $PRINCIPAL);
            //Funcion para mostrar las alternativas
            $PRINCIPAL          = str_replace("{OPCIONES}", MuestraAlternativas($pregunta[0]->id_grupo_alternativas, $pregunta[0]->id), $PRINCIPAL);
            $PRINCIPAL          = str_replace("{ID_PREGUNTA_ENCODEADO}", Encodear3($pregunta[0]->id), $PRINCIPAL);
            $PRINCIPAL          = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($id_evaluacion), $PRINCIPAL);
            $PRINCIPAL          = str_replace("{URL_IMAGEN}", $pregunta[0]->url_archivo, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{NUMERO_PREGUNTA}", $pregunta[0]->orden, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_BAJADA1}", $pregunta[0]->bajada1, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_BAJADA2}", $pregunta[0]->bajada2, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_BAJADA3}", $pregunta[0]->bajada3, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_BAJADA4}", $pregunta[0]->bajada4, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_REFUERZO1}", $pregunta[0]->refuerzo1, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_REFUERZO2}", $pregunta[0]->refuerzo2, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_REFUERZO3}", $pregunta[0]->refuerzo3, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_REFUERZO4}", $pregunta[0]->refuerzo4, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_REFUERZO5}", $pregunta[0]->refuerzo5, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_REFUERZO6}", $pregunta[0]->refuerzo6, $PRINCIPAL);
            $respuesta_correcta = ObtenerRespuestaDeUsuario($pregunta[0]->id, $rut);
            if ($respuesta_correcta[0]->correcta == "1") {
                $PRINCIPAL = str_replace("{RESULTADO}", "CORRECTO", $PRINCIPAL);
                $PRINCIPAL = str_replace("{CLASERESULTADO}", "goplay_feedbackcorrecto", $PRINCIPAL);
                $PRINCIPAL = str_replace("{GOPLAY_FOTO_ANIMADA}", "<img src='img/go_play_ok.png' class='img-rounded'>", $PRINCIPAL);
            } else {
                $PRINCIPAL = str_replace("{RESULTADO}", "INCORRECTO", $PRINCIPAL);
                $PRINCIPAL = str_replace("{CLASERESULTADO}", "goplay_feedbackincorrecto", $PRINCIPAL);
                $PRINCIPAL = str_replace("{GOPLAY_FOTO_ANIMADA}", "<img src='img/go_play_nook.png' class='img-rounded'>", $PRINCIPAL);
            }
            //echo "4.1<br>";
            $pagina   = 1;
            //obtengo la primera pregunta
            $pregunta = PreguntaDeEvaluacion($id_evaluacion_por_objeto, $pagina1);
            //Inserto en la tabla de sesion la pgina 1.
            InsertaRegistroTablaSesionEvaluacionContenido($rut, $id_evaluacion, "1");
            $PRINCIPAL = FuncionesTransversales(file_get_contents("views/goplay/" . $id_empresa . "_ambiente_evaluacion_con_textos_feedback.html"));
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA}", ($pregunta[0]->pregunta), $PRINCIPAL);
            //Funcion para mostrar las alternativas
            $PRINCIPAL = str_replace("{OPCIONES}", MuestraAlternativas($pregunta[0]->id_grupo_alternativas, $pregunta[0]->id), $PRINCIPAL);
            $PRINCIPAL = str_replace("{ID_PREGUNTA_ENCODEADO}", Encodear3($pregunta[0]->id), $PRINCIPAL);
            $PRINCIPAL = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($id_evaluacion), $PRINCIPAL);
            $PRINCIPAL = str_replace("{NUMERO_PREGUNTA}", $pregunta[0]->orden, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA1}", $pregunta[0]->bajada1, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA2}", $pregunta[0]->bajada2, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA3}", $pregunta[0]->bajada3, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA4}", $pregunta[0]->bajada4, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_REFUERZO1}", $pregunta[0]->refuerzo1, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_REFUERZO2}", $pregunta[0]->refuerzo2, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_REFUERZO3}", $pregunta[0]->refuerzo3, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_REFUERZO4}", $pregunta[0]->refuerzo4, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_REFUERZO5}", $pregunta[0]->refuerzo5, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_REFUERZO6}", $pregunta[0]->refuerzo6, $PRINCIPAL);
        }
    }
    //PAGINACION////////////
    if ($datos_objeto[0]->preguntas_aleatorias > 0) {
        $total_preguntas = VerificaSiTienePReguntasAsociadasRandomicas($rut, $id_evaluacion_por_objeto, $datos_objeto[0]->id);
    } else {
        $total_preguntas = PreguntasDadoEvaluacion($id_evaluacion_por_objeto);
    }
    $PRINCIPAL             = str_replace("{ENTORNO_PAGINACION}", ArmaPaginacionEvaluacion($total_preguntas, $pagina), $PRINCIPAL);
    $PRINCIPAL             = str_replace("{ID_PREGUNTA_ENCODEADO}", Encodear3($id_evaluacion_por_objeto), $PRINCIPAL);
    $PRINCIPAL             = str_replace("{ID_DESAFIO_PREGUNTADOS_ENCODEADO}", Encodear3($id_desafio_preguntados), $PRINCIPAL);
    $PRINCIPAL             = str_replace("{NAME_FORMULARIO}", "FormRespuestas", $PRINCIPAL);
    $PRINCIPAL             = str_replace("{VALOR_BOTON}", "Guardar y Avanzar", $PRINCIPAL);
    $PRINCIPAL             = str_replace("{NOMBRE_EVALUACION}", $datos_evaluacion[0]->nombre_evaluacion, $PRINCIPAL);
    $PRINCIPAL             = str_replace("{NOMBRE_OBJETO}", $datos_evaluacion[0]->nombre_evaluacion, $PRINCIPAL);
    $datos_usuario         = UsuarioEnBasePersonas($rut);
    $PRINCIPAL             = str_replace("{NOMBRE_USUARIO}", ($datos_usuario[0]->nombre_completo), $PRINCIPAL);
    //$num_goplay_respuestas=goplay_cuentarespuestas($datos_objeto[0]->id, $rut);
    $num_goplay_respuestas = goplay_cuentarespuestasDesdeIntentos($datos_objeto[0]->id, $rut, $numero_intentos_actual);
    foreach ($num_goplay_respuestas as $num_goplay_respuesta) {
        if ($num_goplay_respuesta->correcta == '1') {
            $goplay_iconorespuestas .= '<i class="i-rounded icon-check " style="background-color:#009843"></i>';
        } else {
            $goplay_iconorespuestas .= '<i class="i-rounded icon-close " style="background-color:#de2b38"></i>';
        }
    }
    $avance_preguntas = round(100 * ($pagina + 1) / count($total_preguntas));
    $PRINCIPAL        = str_replace("{AVANCEEVALUACION}", ($avance_preguntas), $PRINCIPAL);
    $PRINCIPAL        = str_replace("{CORRECTASEVALUACION}", ($goplay_iconorespuestas), $PRINCIPAL);
    return ($PRINCIPAL);
}
function MuestraAlternativasPreguntados($id_grupo_alternativas, $id_pregunta, $id_desafio_preguntados)
{
    $alternativas = AlternativasDadoId($id_grupo_alternativas);
    $opciones     = "";
    foreach ($alternativas as $alt) {
        $colorI++;
        $opciones .= file_get_contents("views/goplay/" . $_SESSION["id_empresa"] . "_alternativas.html");
        $opciones = str_replace("{ID_PREGUNTA}", $id_pregunta, $opciones);
        $opciones = str_replace("{ALT_ID}", Encodear($alt->id), $opciones);
        $opciones = str_replace("{ALTERNATIVA}", $alt->alternativa, $opciones);
        $opciones = str_replace("{ID_DESAFIO_PREGUNTADOS_ENCODEADO}", Encodear3($id_desafio_preguntados), $opciones);
        /*
        if($_SESSION["id_empresa"]==77){
        $opciones.="
        <div class='col-xs-12 col-lg-12 col-md-12'>
        <a href='?sw=savanswG&".($id_pregunta)."=".Encodear($alt->id)."&idp={ID_PREGUNTA_ENCODEADO}&ido={ID_OBJETO_ENCODEADO}' class='btn btn-info' >
        <span class='blanco'>".$alt->alternativa."</span>
        </a>
        </div>
        ";
        }else{
        $opciones.="
        <div class='col-xs-12 col-lg-6 col-md-6'>
        <a href='?sw=savanswG&".($id_pregunta)."=".Encodear($alt->id)."&idp={ID_PREGUNTA_ENCODEADO}&ido={ID_OBJETO_ENCODEADO}' class='btn btn-goplay btn-goplay".$colorI."' >
        <span class='blanco'>".$alt->alternativa."</span>
        </a>
        </div>
        ";
        }
        */
    }
    $opciones .= "</table>";
    return ($opciones);
}
function MuestraEvaluacionPreguntados($id_evaluacion, $rut, $id_desafio_preguntados)
{
    //function MuestraEvaluacion($PRINCIPAL, $id_evaluacion, $rut){
    //ID_EVALUACION CORRESPONDE AL ID DEL OBJETO
    $datos_objeto             = DatosObjeto($id_evaluacion);
    $id_evaluacion_por_objeto = $datos_objeto[0]->id_evaluacion; //Id de la evaluacion. Este es el que se obtiene desde el campo id evaluacion de la tabla objeto
    $datos_evaluacion         = DatosEvaluacion($datos_objeto[0]->id_evaluacion);
    //Veo si est? en la tabla sesion esta evaluacion, y este usuario
    if (!$id_desafio_preguntados) {
        $intentos_por_usuario   = ObtengoCantidadDeIntentosPorColaborador($rut, $id_objeto, $id_empresa);
        $numero_intentos_actual = count($intentos_por_usuario) + 1;
    }
    $tiene_sesion    = SesionEvaluacionContenidos($id_evaluacion, $rut);
    //print_r($tiene_sesion);
    $total_preguntas = PreguntasDadoEvaluacion($id_evaluacion_por_objeto);
    //ACA VALIDA SI ES QUE EL OBJETO, QUE CONTIENE ESTA EVALUACION, TIENE PREGUNTAS ALEATORIAS O NO.
    //SI NO TIENE ALEATORIAS, LAS MUESTRA TODAS
    if ($datos_objeto[0]->preguntas_aleatorias > 0) {
        //Asigno a una tabla,si es que no esta asignado obviamente. La cantidad que corresponda de preguntas, asociadas al rut, curso y objeto.
        $tiene_preguntas_asociadas = VerificaSiTienePReguntasAsociadasRandomicas($rut, $id_evaluacion_por_objeto, $datos_objeto[0]->id);
        if (count($tiene_preguntas_asociadas) == 0) {
            shuffle($total_preguntas);
            $vueltas = 1;
            foreach ($total_preguntas as $pre) {
                InsertoRegistroPreguntasAleatorias($rut, $id_evaluacion_por_objeto, $datos_objeto[0]->id, $vueltas, $pre->id, $datos_objeto[0]->id_curso);
                if ($vueltas == $datos_objeto[0]->preguntas_aleatorias)
                    break;
                $vueltas++;
            }
        }
        if ($tiene_sesion) {
            //echo "1";
            $pagina    = $tiene_sesion[0]->pagina;
            //$pregunta=PreguntaDeEvaluacionAleatorias($id_evaluacion_por_objeto, $pagina, $rut);
            $pregunta  = PREGUNTADOS_PreguntaDeEvaluacionAleatorias($id_evaluacion_por_objeto, $pagina, $rut, $id_desafio_preguntados);
            $PRINCIPAL = FuncionesTransversales(file_get_contents("views/goplay/" . $_SESSION["id_empresa"] . "_ambiente_evaluacion.html"));
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA}", ($pregunta[0]->pregunta), $PRINCIPAL);
            //Funcion para mostrar las alternativas
            $PRINCIPAL = str_replace("{OPCIONES}", MuestraAlternativasPreguntados($pregunta[0]->id_grupo_alternativas, $pregunta[0]->id, $id_desafio_preguntados), $PRINCIPAL);
            $PRINCIPAL = str_replace("{ID_PREGUNTA_ENCODEADO}", Encodear3($pregunta[0]->id), $PRINCIPAL);
            $PRINCIPAL = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($id_evaluacion), $PRINCIPAL);
            $PRINCIPAL = str_replace("{URL_IMAGEN}", $pregunta[0]->url_archivo, $PRINCIPAL);
            $PRINCIPAL = str_replace("{NUMERO_PREGUNTA}", $pagina, $PRINCIPAL);
            $PRINCIPAL = str_replace("{DESCRIPCION_EVALUACION}", $contexto_descripcion, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA1}", $pregunta[0]->bajada1, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA2}", $pregunta[0]->bajada2, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA3}", $pregunta[0]->bajada3, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA4}", $pregunta[0]->bajada4, $PRINCIPAL);
        } else {
            //echo "2";
            $pagina = 1;
            InsertaRegistroTablaSesionEvaluacionContenido($rut, $id_evaluacion, $pagina);
            //$pregunta=PreguntaDeEvaluacionAleatorias($id_evaluacion_por_objeto, $pagina, $rut);
            $pregunta  = PREGUNTADOS_PreguntaDeEvaluacionAleatorias($id_evaluacion_por_objeto, $pagina, $rut, $id_desafio_preguntados);
            $PRINCIPAL = FuncionesTransversales(file_get_contents("views/goplay/" . $_SESSION["id_empresa"] . "_ambiente_evaluacion.html"));
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA}", ($pregunta[0]->pregunta), $PRINCIPAL);
            //Funcion para mostrar las alternativas
            $PRINCIPAL = str_replace("{OPCIONES}", MuestraAlternativasPreguntados($pregunta[0]->id_grupo_alternativas, $pregunta[0]->id, $id_desafio_preguntados), $PRINCIPAL);
            $PRINCIPAL = str_replace("{ID_PREGUNTA_ENCODEADO}", Encodear3($pregunta[0]->id), $PRINCIPAL);
            $PRINCIPAL = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($id_evaluacion), $PRINCIPAL);
            $PRINCIPAL = str_replace("{NUMERO_PREGUNTA}", $pagina, $PRINCIPAL);
            $PRINCIPAL = str_replace("{URL_IMAGEN}", $pregunta[0]->url_archivo, $PRINCIPAL);
            $PRINCIPAL = str_replace("{DESCRIPCION_EVALUACION}", $contexto_descripcion, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA1}", $pregunta[0]->bajada1, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA2}", $pregunta[0]->bajada2, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA3}", $pregunta[0]->bajada3, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA4}", $pregunta[0]->bajada4, $PRINCIPAL);
        }
    } else {
        if ($tiene_sesion) {
            //echo "3";
            $pagina    = $tiene_sesion[0]->pagina;
            //$pregunta=PreguntaDeEvaluacion($id_evaluacion_por_objeto, $pagina);
            $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/evaluacion/" . $_SESSION["id_empresa"] . "_" . $pregunta[0]->template_pregunta));
            //$PRINCIPAL=FuncionesTransversales(file_get_contents("views/cursos/evaluacion/$id_empresa_".$pregunta[0]->template_pregunta));
            //echo "views/cursos/evaluacion/$id_empresa_".$pregunta[0]->template_pregunta;
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA}", ($pregunta[0]->pregunta), $PRINCIPAL);
            //Funcion para mostrar las alternativas
            $PRINCIPAL = str_replace("{OPCIONES}", MuestraAlternativas($pregunta[0]->id_grupo_alternativas, $pregunta[0]->id), $PRINCIPAL);
            $PRINCIPAL = str_replace("{ID_PREGUNTA_ENCODEADO}", Encodear3($pregunta[0]->id), $PRINCIPAL);
            $PRINCIPAL = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($id_evaluacion), $PRINCIPAL);
            $PRINCIPAL = str_replace("{URL_IMAGEN}", $pregunta[0]->url_archivo, $PRINCIPAL);
            $PRINCIPAL = str_replace("{NUMERO_PREGUNTA}", $pregunta[0]->orden, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA1}", $pregunta[0]->bajada1, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA2}", $pregunta[0]->bajada2, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA3}", $pregunta[0]->bajada3, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA4}", $pregunta[0]->bajada4, $PRINCIPAL);
            $PRINCIPAL = str_replace("{DESCRIPCION_EVALUACION}", $contexto_descripcion, $PRINCIPAL);
        } else {
            $pagina = 1;
            //echo "4";
            //obtengo la primera pregunta
            //$pregunta=PreguntaDeEvaluacion($id_evaluacion_por_objeto, $pagina);
            //Inserto en la tabla de sesion la pgina 1.
            InsertaRegistroTablaSesionEvaluacionContenido($rut, $id_evaluacion, "1");
            //$PRINCIPAL=FuncionesTransversales(file_get_contents("views/cursos/evaluacion/$id_empresa_".$pregunta[0]->template_pregunta));
            $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/evaluacion/" . $_SESSION["id_empresa"] . "_" . $pregunta[0]->template_pregunta));
            //$PRINCIPAL=FuncionesTransversales(file_get_contents("views/cursos/evaluacion/".$_SESSION["id_empresa"]."_".$pregunta[0]->template_pregunta));
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA}", ($pregunta[0]->pregunta), $PRINCIPAL);
            //Funcion para mostrar las alternativas
            $PRINCIPAL = str_replace("{OPCIONES}", MuestraAlternativas($pregunta[0]->id_grupo_alternativas, $pregunta[0]->id), $PRINCIPAL);
            $PRINCIPAL = str_replace("{ID_PREGUNTA_ENCODEADO}", Encodear3($pregunta[0]->id), $PRINCIPAL);
            $PRINCIPAL = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($id_evaluacion), $PRINCIPAL);
            $PRINCIPAL = str_replace("{NUMERO_PREGUNTA}", $pregunta[0]->orden, $PRINCIPAL);
            $PRINCIPAL = str_replace("{URL_IMAGEN}", $pregunta[0]->url_archivo, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA1}", $pregunta[0]->bajada1, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA2}", $pregunta[0]->bajada2, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA3}", $pregunta[0]->bajada3, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA4}", $pregunta[0]->bajada4, $PRINCIPAL);
            $PRINCIPAL = str_replace("{DESCRIPCION_EVALUACION}", $contexto_descripcion, $PRINCIPAL);
        }
    }
    //PAGINACION////////////
    if ($datos_objeto[0]->preguntas_aleatorias > 0) {
        $total_preguntas = VerificaSiTienePReguntasAsociadasRandomicas($rut, $id_evaluacion_por_objeto, $datos_objeto[0]->id);
    } else {
        $total_preguntas = PreguntasDadoEvaluacion($id_evaluacion_por_objeto);
    }
    $PRINCIPAL             = str_replace("{ENTORNO_PAGINACION}", ArmaPaginacionEvaluacion($total_preguntas, $pagina), $PRINCIPAL);
    $PRINCIPAL             = str_replace("{ID_PREGUNTA_ENCODEADO}", Encodear3($id_evaluacion_por_objeto), $PRINCIPAL);
    $PRINCIPAL             = str_replace("{NAME_FORMULARIO}", "FormRespuestas", $PRINCIPAL);
    $PRINCIPAL             = str_replace("{VALOR_BOTON}", "Guardar y Avanzar", $PRINCIPAL);
    $PRINCIPAL             = str_replace("{NOMBRE_EVALUACION}", $datos_evaluacion[0]->nombre_evaluacion, $PRINCIPAL);
    $PRINCIPAL             = str_replace("{NOMBRE_OBJETO}", $datos_evaluacion[0]->nombre_evaluacion, $PRINCIPAL);
    $PRINCIPAL             = str_replace("{DESCRIPCION_EVALUACION}", $contexto_descripcion, $PRINCIPAL);
    $datos_usuario         = UsuarioEnBasePersonas($rut);
    $num_goplay_respuestas = goplay_cuentarespuestas($datos_objeto[0]->id, $rut);
    foreach ($num_goplay_respuestas as $num_goplay_respuesta) {
        if ($num_goplay_respuesta->correcta == '1') {
            $goplay_iconorespuestas .= '<i class="i-rounded icon-check " style="background-color:#009843;"></i>';
        } else {
            $goplay_iconorespuestas .= '<i class="i-rounded icon-close " style="background-color:#de2b38"></i>';
        }
    }
    if (count($num_goplay_respuestas) < 5) {
        $goplay_iconorespuestas .= '<i class="i-rounded icon-circle " style="background-color:#CCCCCC"></i>';
    }
    $avance_preguntas   = round(100 * $pagina / count($total_preguntas));
    $avance_preguntados = $avance_preguntas - 20;
    if ($avance_preguntados == 0) {
        $avance_preguntados = 1;
    }
    //echo $avance_preguntados;
    //$PRINCIPAL = str_replace("{AVANCEEVALUACION}",($avance_preguntas),$PRINCIPAL);
    $PRINCIPAL = str_replace("{AVANCEEVALUACION}", ($avance_preguntados), $PRINCIPAL);
    $PRINCIPAL = str_replace("{CORRECTASEVALUACION}", ($goplay_iconorespuestas), $PRINCIPAL);
    $PRINCIPAL = str_replace("{NOMBRE_USUARIO}", ($datos_usuario[0]->nombre_completo), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaDatosPuntosMedallas($PRINCIPAL, $id_empresa, $rut)
{
    $total_medallas = TotalMedalasPorRutEmpresa($rut, $id_empresa);
    $PRINCIPAL      = str_replace("{MEDALLASGANADOS}", $total_medallas[0]->total_medallas, $PRINCIPAL);
    $total_Niveles  = NivelesFinalizadosSinMalla($rut, $id_empresa);
    $PRINCIPAL      = str_replace("{SELLOSGANADOS}", count($total_Niveles), $PRINCIPAL);
    return ($PRINCIPAL);
}
function MuestraComentariosPorPostReply($id_mp, $limit, $numero, $id_post)
{
    $id_empresa        = $_SESSION["id_empresa"];
    $rut               = $_SESSION["user_"];
    $total_comentarios = ComentariosPorPostTotalReply($id_mp, $id_post);
    $comentarios       = ComentariosPorPostReply($id_mp, $limit, $numero, $id_post);
    foreach ($comentarios as $comen) {
        $row_comentarios .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_comentario_mp_persona_listado_reply.html");
        $row_comentarios = str_replace("{RUT}", $rut, $row_comentarios);
        $row_comentarios = str_replace("{HUINCHA_INTERACCIONES_REPLY}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones_reply.html"), $row_comentarios);
        $row_comentarios = ColocaMegustaNomegustaPorReply($row_comentarios, $comen->id, $rut, $id_mp);
        $row_comentarios = str_replace("{TIPO}", "post", $row_comentarios);
        $row_comentarios = str_replace("{ID_MP}", $id_mp, $row_comentarios);
        $row_comentarios = str_replace("{ID_POST}", $comen->id, $row_comentarios);
        $row_comentarios = str_replace("{ID_POST_PRINCIPAL}", $id_post, $row_comentarios);
        $row_comentarios = str_replace("{ID_REPLY}", $comen->id, $row_comentarios);
        $row_comentarios = str_replace("{NOMBRE_AUTOR_REPLY}", $comen->nombre, $row_comentarios);
        $row_comentarios = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($comen->rut), $row_comentarios);
        $row_comentarios = str_replace("{FECHA_REPLY}", ($comen->fecha), $row_comentarios);
        $row_comentarios = str_replace("{COMENTARIO}", utf8_encode($comen->comentario), $row_comentarios);
        //Veo si el reply tiene reply
        $reply_por_reply = COMUNIDAD_ReplyPorReply($id_mp, $comen->id);
        $row_comentarios = str_replace("{NUMCOMENTARIOSREALES_PORPOST_REPLY}", count($reply_por_reply), $row_comentarios);
        if ($reply_por_reply) {
            $row_comentarios = str_replace("{BLOQUE_COMENTARIOS_POR_REPLY}", MuestraReplyPorReply($id_mp, $comen->id), $row_comentarios);
        } else {
            $row_comentarios = str_replace("{BLOQUE_COMENTARIOS_POR_REPLY}", "", $row_comentarios);
        }
    }
    return ($row_comentarios);
}
function ColocaMegustaFavoritosPorPost($PRINCIPAL, $id_empresa, $id_mp, $rut, $id_post)
{
    $tiene_megusta = COMUNIDAD_TieneInteraccionPorRutPorPost($id_empresa, $id_mp, "MEGUSTA_POST", $rut, $id_post);
    if ($tiene_megusta) {
        $PRINCIPAL = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta_post.html"), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta_post.html"), $PRINCIPAL);
    }
    $PRINCIPAL = ColocaCantidadDeMegustaPorPost($PRINCIPAL, $id_mp, $id_empresa, $id_post);
    return ($PRINCIPAL);
}
function ColocaMegustaFavoritos($PRINCIPAL, $id_empresa, $id_mp, $rut)
{
    $tiene_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $id_mp, "MEGUSTA", $rut);
    if ($tiene_megusta) {
        $PRINCIPAL = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta.html"), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta.html"), $PRINCIPAL);
    }
    $PRINCIPAL      = ColocaCantidadDeMegusta($PRINCIPAL, $id_mp, $id_empresa);
    $tiene_favorito = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $id_mp, "FAVORITA", $rut);
    if ($tiene_favorito) {
        $PRINCIPAL = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_favorito.html"), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_favorito.html"), $PRINCIPAL);
    }
    return ($PRINCIPAL);
}
function colocaVideosPorObjeto($id_objeto, $rut, $id_empresa, $pagina, $id_malla)
{
    //echo "$id_objeto, $id_empresa, $pagina, $id_malla)";
    $imagenes = VideosPorObjetoPorMalla($id_objeto, $id_empresa, $pagina, $id_malla);
    $j        = 1;
    foreach ($imagenes as $img) {
        if ($j == 1) {
            $row_html .= "<div class=''>";
        }
        $row_html .= file_get_contents("views/cursos/objetos/subirVideos/" . $id_empresa . "_lista_archivos.html");
        if ($j == 3) {
            $row_html .= "</div>";
            $j = 1;
        } else {
            $j++;
        }
        $figura   = '<a href="galeria/' . $img->archivo . '" title="' . $img->descripcion . '" onclick="vista_galeria(' . $img->id . ')"  data-gallery><img src="img/objetos/' . $img->archivo . '""></a>';
        $row_html = str_replace("{BLOQUE_PARA_VIDEO}", file_get_contents("videosCap/index_galeria_videos.php"), $row_html);
        $row_html = str_replace("{FIGURA}", $figura, $row_html);
        $row_html = str_replace("{URL_IMAGEN_ARCHIVO}", "img/objetos/" . $img->archivo . "", $row_html);
        $row_html = str_replace("{NOMBRE_VIDEO_MP4}", "img/objetos/" . $img->archivo . "", $row_html);
        $row_html = str_replace("{DESCRIPCION}", utf8_encode($img->nombre_completo), $row_html);
        $row_html = str_replace("{NOMBRE_PERSONA}", utf8_encode($img->nombre_completo), $row_html);
        $row_html = str_replace("{COMENTARIO}", utf8_encode($img->comentarios), $row_html);
        $row_html = str_replace("{URL_IMAGEN_PERSONA}", VerificaFotoPersonal($img->rut_autor), $row_html);
        $row_html = str_replace("{TITULO_VIDEO}", ($img->titulo_video), $row_html);
        $row_html = str_replace("{DESCRIPCION_VIDEO}", ($img->descripcion_video), $row_html);
        $row_html = str_replace("{IDVIDEO}", ($img->id), $row_html);
        if ($img->rut_autor == $rut) {
            $row_html = str_replace("{MEGUSTA}", ColocaMeGusta($img->id, "id_imagen_galeria", $id_empresa, $rut, "autor"), $row_html);
            $row_html = str_replace("{DELETE}", file_get_contents("views/cursos/objetos/subirVideos/" . $id_empresa . "_delete_imagen.html"), $row_html);
            $row_html = str_replace("{ID_IMAGEN_ENCODEADA}", Encodear3($img->id), $row_html);
        } else {
            $row_html = str_replace("{MEGUSTA}", ColocaMeGusta($img->id, "id_imagen_galeria", $id_empresa, $rut), $row_html);
            $row_html = str_replace("{DELETE}", "", $row_html);
        }
        $row_html = str_replace("{VISITAS}", 0, $row_html);
    }
    if ($j == 2 or $j == 3) {
        $row_html .= "</div>";
    }
    return ($row_html);
}
function ColocaBloqueMasMeGustaVideos($PRINCIPAL, $id_objeto, $id_malla)
{
    //obtengo comentarios dado id_objeto
    //$total_galerias=ObtenerFotosMasMegusta($id_objeto, $_SESSION["id_empresa"]);
    $total_galerias = ObtenerVideosMasMegusta($_SESSION["id_empresa"]);
    if ($total_galerias) {
        foreach ($total_galerias as $arch) {
            $row_html .= file_get_contents("views/cursos/objetos/subirVideos/lista_archivos_bloque.html");
            $row_html = str_replace("{URL_IMAGEN_ARCHIVO}", $arch->archivo, $row_html);
            $row_html = str_replace("{URL_IMAGEN_PERSONA}", VerificaFotoPersonal($arch->rut_autor), $row_html);
            $row_html = str_replace("{DESCRIPCION}", ($arch->nombre_completo), $row_html);
            $row_html = str_replace("{NOMBRE_PERSONA}", ($arch->nombre_completo), $row_html);
            $row_html = str_replace("{TITULO_VIDEO}", ($arch->titulo_video), $row_html);
            $row_html = str_replace("{DESCRIPCION_VIDEO}", ($arch->descripcion_video), $row_html);
            $row_html = str_replace("{IDVIDEO}", ($arch->id), $row_html);
            $row_html = str_replace("{MEGUSTA}", ColocaMeGusta($arch->id, "id_imagen_galeria", $_SESSION["id_empresa"], $arch->rut_autor, "autor", $id_objeto), $row_html);
        }
        $PRINCIPAL = str_replace("{BLOQUEVIDEOSPOPULARES}", utf8_encode($row_html), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUEVIDEOSPOPULARES}", "", $PRINCIPAL);
    }
    return ($PRINCIPAL);
}
function XSendMailpPhpMailer($to, $nombrefrom, $from, $subject, $message)
{
    $mail = new PHPMailer();
    if ($nombrefrom != "" && $from != "")
        $mail->SetFrom($from, $nombrefrom);
    else
        $mail->SetFrom('soporte@gop.cl', 'Soporte');
    $mail->FromName = $nombrefrom;
    $mail->Subject  = $subject;
    $mail->Helo     = 'gop.cl';
    $mail->IsSMTP();
    $mail->SMTPSecure = "ssl";
    $mail->Host       = 'smtp-relay.gmail.com';
    $mail->Port       = 465;
    $mail->SMTPAuth   = false;
    $mail->Body       = $message;
    $mail->AltBody    = "";
    $mail->IsHTML(true);
    if (strpos($to, ",") === false) {
        //$mail->AddAddress($to);
        //$mail->AddCC('Maria.rosso@tanner.cl');
        //$mail->AddCC('Claudia.duarte@tanner.cl');
        //$mail->AddCC('Ingrid.tejada@tanner.cl');
        /*
        Maria.rosso@tanner.cl
        Claudia.duarte@tanner.cl
        Ingrid.tejada@tanner.cl
        */
    } else {
        $tos = explode(",", $to);
        for ($i = 0; $i < count($tos); $i++)
            $mail->AddAddress($tos[$i]);
    }
    if (!$mail->Send()) {
        $error_message = "Mailer Error: " . $mail->ErrorInfo;
        echo $error_message;
    } else {
        $error_message = "Successfully sent!";
    }
    //if(!$mail->Send())
    //            return -1;
    // Clear all addresses and attachments for next loop
    $mail->ClearAddresses();
    $mail->ClearAttachments();
}
function ColocaImagenPost($url_imagen)
{
    if ($url_imagen <> '') {
        $template_imagen = file_get_contents("views/comunidad_mp/com_imagen.html");
        $template_imagen = str_replace("{URL_IMAGEN_FONDO}", $url_imagen, $template_imagen);
    } else {
        $template_imagen = "";
    }
    return ($template_imagen);
}
function colocaVideoYoutube($link_video_youtube, $id_mp)
{
    //echo $link_video_youtube;echo "<br>";
    $primeras_palabra     = $link_video_youtube[0] . $link_video_youtube[1] . $link_video_youtube[2] . $link_video_youtube[3] . $link_video_youtube[4] . $link_video_youtube[5] . $link_video_youtube[6];
    $primeras_palabra_ngd = $link_video_youtube[0] . $link_video_youtube[1] . $link_video_youtube[2] . $link_video_youtube[3] . $link_video_youtube[4] . $link_video_youtube[5] . $link_video_youtube[6] . $link_video_youtube[7] . $link_video_youtube[8] . $link_video_youtube[9] . $link_video_youtube[10] . $link_video_youtube[11] . $link_video_youtube[12] . $link_video_youtube[13] . $link_video_youtube[14];
    //echo "primeras_palabra_ngd $primeras_palabra_ngd";

//echo " <br>$primeras_palabra_ngd == https://ngd.cl/";
    //if($primeras_palabra=="<iframe"){
    if ($primeras_palabra == "<div cl") {
        $template_video_youtube = $link_video_youtube;
       //echo "A";

    } elseif ($primeras_palabra_ngd == "https://www.ngd" or $primeras_palabra_ngd == "https://ngd.cl/" ) {
        $template_video_youtube = file_get_contents("views/comunidad_mp/com_video.html");
        $template_video_youtube = str_replace("{URL_VIDEO_YOUTUBE_EMBED}", $link_video_youtube, $template_video_youtube);
        $template_video_youtube = str_replace("{URL_VIDEO_YOUTUBE_EMBED_ENCODEADO}", Encodear3($link_video_youtube), $template_video_youtube);
        $template_video_youtube = str_replace("{ID_MP_VIDEO}", $id_mp, $template_video_youtube);
        //echo "B";

    } elseif ($primeras_palabra_ngd == "https://drive.g" ) {
        $template_video_drive = $link_video_youtube;
        $template_video_drive_preview = str_replace('/view', '/preview', $template_video_drive);
        $template_video_youtube = file_get_contents("views/comunidad_mp/com_video_drive.html");
        $template_video_youtube = str_replace("{URL_VIDEO_DRIVE_EMBED}", $template_video_drive_preview, $template_video_youtube);
        $template_video_youtube = str_replace("{URL_VIDEO_YOUTUBE_EMBED_ENCODEADO}", Encodear3($link_video_youtube), $template_video_youtube);
        $template_video_youtube = str_replace("{ID_MP_VIDEO}", $id_mp, $template_video_youtube);
        //echo "C";

    } else {
        $link_video_youtube     = str_replace("watch?v=", "embed/", $link_video_youtube);
        $template_video_youtube = file_get_contents("views/comunidad_mp/com_youtube.html");
        $template_video_youtube = str_replace("{URL_VIDEO_YOUTUBE_EMBED}", $link_video_youtube, $template_video_youtube);
        //echo "D";

    }

    //exit();
    return ($template_video_youtube);
}


function ellipsis($str, $len = 50)
{
    return strlen($str) > $len ? substr($str, 0, $len) . '...' : $str;
}

function ClaseParaDrofAndDrop()
{
    abstract class SlimStatus
    {
        const FAILURE = 'failure';
        const SUCCESS = 'success';
    }
    class Slim
    {
        public static function getImages($inputName = 'slim')
        {
            $values = Slim::getPostData($inputName);
            // test for errors
            if ($values === false) {
                return false;
            }
            // determine if contains multiple input values, if is singular, put in array
            $data = array();
            if (!is_array($values)) {
                $values = array(
                    $values
                );
            }
            // handle all posted fields
            foreach ($values as $value) {
                $inputValue = Slim::parseInput($value);
                if ($inputValue) {
                    array_push($data, $inputValue);
                }
            }
            // return the data collected from the fields
            return $data;
        }
        // $value should be in JSON format
        private static function parseInput($value)
        {
            // if no json received, exit, don't handle empty input values.
            if (empty($value)) {
                return null;
            }
            // The data is posted as a JSON String so to be used it needs to be deserialized first
            $data    = json_decode($value);
            // shortcut
            $input   = null;
            $actions = null;
            $output  = null;
            $meta    = null;
            if (isset($data->input)) {
                $inputData = null;
                if (isset($data->input->image)) {
                    $inputData = Slim::getBase64Data($data->input->image);
                } else if (isset($data->input->field)) {
                    $filename = $_FILES[$data->input->field]['tmp_name'];
                    if ($filename) {
                        $inputData = file_get_contents($filename);
                    }
                }
                $input = array(
                    'data' => $inputData,
                    'name' => $data->input->name,
                    'type' => $data->input->type,
                    'size' => $data->input->size,
                    'width' => $data->input->width,
                    'height' => $data->input->height
                );
            }
            if (isset($data->output)) {
                $outputDate = null;
                if (isset($data->output->image)) {
                    $outputData = Slim::getBase64Data($data->output->image);
                } else if (isset($data->output->field)) {
                    $filename = $_FILES[$data->output->field]['tmp_name'];
                    if ($filename) {
                        $outputData = file_get_contents($filename);
                    }
                }
                $output = array(
                    'data' => $outputData,
                    'name' => $data->output->name,
                    'type' => $data->output->type,
                    'width' => $data->output->width,
                    'height' => $data->output->height
                );
            }
            if (isset($data->actions)) {
                $actions = array(
                    'crop' => $data->actions->crop ? array(
                        'x' => $data->actions->crop->x,
                        'y' => $data->actions->crop->y,
                        'width' => $data->actions->crop->width,
                        'height' => $data->actions->crop->height,
                        'type' => $data->actions->crop->type
                    ) : null,
                    'size' => $data->actions->size ? array(
                        'width' => $data->actions->size->width,
                        'height' => $data->actions->size->height
                    ) : null,
                    'rotation' => $data->actions->rotation,
                    'filters' => $data->actions->filters ? array(
                        'sharpen' => $data->actions->filters->sharpen
                    ) : null
                );
            }
            if (isset($data->meta)) {
                $meta = $data->meta;
            }
            // We've sanitized the base64data and will now return the clean file object
            return array(
                'input' => $input,
                'output' => $output,
                'actions' => $actions,
                'meta' => $meta
            );
        }
        // $path should have trailing slash
        public static function saveFile($data, $name, $path = 'tmp/', $uid = true)
        {
            // Add trailing slash if omitted
            if (substr($path, -1) !== '/') {
                $path .= '/';
            }
            // Test if directory already exists
            if (!is_dir($path)) {
                mkdir($path, 0755, true);
            }
            // Sanitize characters in file name
            $name = Slim::sanitizeFileName($name);
            // Let's put a unique id in front of the filename so we don't accidentally overwrite other files
            if ($uid) {
                $name = uniqid() . '_' . $name;
            }
            // Add name to path, we need the full path including the name to save the file
            $path = $path . $name;
            // store the file
            Slim::save($data, $path);
            // return the files new name and location
            return array(
                'name' => $name,
                'path' => $path
            );
        }
        /**
         * Get data from remote URL
         * @param $url
         * @return string
         */
        public static function fetchURL($url, $maxFileSize)
        {
            if (!ini_get('allow_url_fopen')) {
                return null;
            }
            $content = null;
            try {
                $content = @file_get_contents($url, false, null, 0, $maxFileSize);
            }
            catch (Exception $e) {
                return false;
            }
            return $content;
        }
        public static function outputJSON($data)
        {
            header('Content-Type: application/json');
            echo json_encode($data);
        }
        /**
         * http://stackoverflow.com/a/2021729
         * Remove anything which isn't a word, whitespace, number
         * or any of the following characters -_~,;[]().
         * If you don't need to handle multi-byte characters
         * you can use preg_replace rather than mb_ereg_replace
         * @param $str
         * @return string
         */
        public static function sanitizeFileName($str)
        {
            // Basic clean up
            $str = mb_ereg_replace("([^\w\s\d\-_~,;\[\]\(\).])", '', $str);
            // Remove any runs of periods
            $str = mb_ereg_replace("([\.]{2,})", '', $str);
            return $str;
        }
        /**
         * Gets the posted data from the POST or FILES object. If was using Slim to upload it will be in POST (as posted with hidden field) if not enhanced with Slim it'll be in FILES.
         * @param $inputName
         * @return array|bool
         */
        private static function getPostData($inputName)
        {
            $values = array();
            if (isset($_POST[$inputName])) {
                $values = $_POST[$inputName];
            } else if (isset($_FILES[$inputName])) {
                // Slim was not used to upload this file
                return false;
            }
            return $values;
        }
        /**
         * Saves the data to a given location
         * @param $data
         * @param $path
         * @return bool
         */
        private static function save($data, $path)
        {
            if (!file_put_contents($path, $data)) {
                return false;
            }
            return true;
        }
        /**
         * Strips the "data:image..." part of the base64 data string so PHP can save the string as a file
         * @param $data
         * @return string
         */
        private static function getBase64Data($data)
        {
            return base64_decode(preg_replace('#^data:image/\w+;base64,#i', '', $data));
        }
    }
    /***** FIN SLIM.PHP */
    // Get posted data
    $images = Slim::getImages();
    // No image found under the supplied input name
    if ($images == false) {
        // inject your own auto crop or fallback script here
        echo '<p>Slim was not used to upload these images.</p>';
    } else {
        // Could be multiple slim croppers
        foreach ($images as $image) {
            $files = array();
            // save output data if set
            if (isset($image['output']['data'])) {
                // Save the file
                $name   = $image['output']['name'];
                // We'll use the output crop data
                $data   = $image['output']['data'];
                // If you want to store the file in another directory pass the directory name as the third parameter.
                // $file = Slim::saveFile($data, $name, 'my-directory/');
                // If you want to prevent Slim from adding a unique id to the file name add false as the fourth parameter.
                // $file = Slim::saveFile($data, $name, 'tmp/', false);
                $output = Slim::saveFile($data, $name);
                array_push($files, $output);
            }
            // save input data if set
            if (isset($image['input']['data'])) {
                // Save the file
                $name  = $image['input']['name'];
                // We'll use the output crop data
                $data  = $image['input']['data'];
                // If you want to store the file in another directory pass the directory name as the third parameter.
                // $file = Slim::saveFile($data, $name, 'my-directory/');
                // If you want to prevent Slim from adding a unique id to the file name add false as the fourth parameter.
                // $file = Slim::saveFile($data, $name, 'tmp/', false);
                $input = Slim::saveFile($data, $name);
                array_push($files, $input);
            }
            $filenames = join(', ', array_map(function($file)
            {
                return ellipsis($file['name'], 100);
            }, $files));
            $images = array_map(function($file)
            {
                return '<img src="' . $file['path'] . '" alt=""/>';
            }, $files);
            echo '
    <h1>You uploaded "' . $filenames . '"</h1>
    ' . join('<br>', $images) . '
    <div class="table-wrapper">
    <table>
        <thead>
            <tr>
                <th>Property</th>
                <th>Value</th>
            </tr>
        </thead>
        ';
            if (isset($image['input']['data'])) {
                echo '
            <tbody>
                <tr>
                    <th colspan="2">Input</th>
                </tr>
                <tr>
                    <th>Name</th>
                    <td>' . ellipsis($image['input']['name'], 100) . '</td>
                </tr>
                <tr>
                    <th>Type</th>
                    <td>' . $image['input']['type'] . '</td>
                </tr>
                <tr>
                    <th>Size</th>
                    <td>' . $image['input']['size'] . '</td>
                </tr>
                <tr>
                    <th>Width</th>
                    <td>' . $image['input']['width'] . '</td>
                </tr>
                <tr>
                    <th>Height</th>
                    <td>' . $image['input']['height'] . '</td>
                </tr>
                    <tr>
                        <th>Data</th>
                        ' . (isset($image['input']['data']) ? '<td class="bytes">' . ellipsis(base64_encode($image['output']['data']), 50) . '</td>' : '<td>Input data was not sent, add the "input" value to the <code>data-post</code> property to send it along.</td>') . '
                    </tr>
            </tbody>
            ';
            }
            if (isset($image['output']['data'])) {
                echo '
                <tbody>
                    <tr>
                        <th colspan="2">Output</th>
                    </tr>
                    <tr>
                        <th>Name</th>
                        <td>' . $image['output']['name'] . '</td>
                    </tr>
                    <tr>
                        <th>Type</th>
                        <td>' . $image['output']['type'] . '</td>
                    </tr>
                    <tr>
                        <th>Width</th>
                        <td>' . $image['output']['width'] . '</td>
                    </tr>
                    <tr>
                        <th>Height</th>
                        <td>' . $image['output']['height'] . '</td>
                    </tr>
                    <tr>
                        <th>Data</th>
                        ' . (isset($image['output']['data']) ? '<td class="bytes">' . ellipsis(base64_encode($image['output']['data']), 50) . '</td>' : '<td>Output data was not sent, add the "output" value to the <code>data-post</code> property to send it along.</td>') . '
                    </tr>
                </tbody>
            ';
            }
            if (isset($image['actions'])) {
                echo '
                <tbody>
                <tr>
                    <th colspan="2">Crop</th>
                </tr>
                <tr>
                    <th>Type</th>
                    <td>' . $image['actions']['crop']['type'] . '</td>
                </tr>
                <tr>
                    <th>X</th>
                    <td>' . $image['actions']['crop']['x'] . '</td>
                </tr>
                <tr>
                    <th>Y</th>
                    <td>' . $image['actions']['crop']['y'] . '</td>
                </tr>
                <tr>
                    <th>Width</th>
                    <td>' . $image['actions']['crop']['width'] . '</td>
                </tr>
                <tr>
                    <th>Height</th>
                    <td>' . $image['actions']['crop']['height'] . '</td>
                </tr>
            </tbody>
            <tbody>
                <tr>
                    <th colspan="2">Size</th>
                </tr>
                <tr>
                    <th>Width</th>
                    <td>' . $image['actions']['size']['width'] . '</td>
                </tr>
                <tr>
                    <th>Height</th>
                    <td>' . $image['actions']['size']['height'] . '</td>
                </tr>
            </tbody>
            ';
            }
            echo '
        <tbody>
            <tr>
                <th colspan="2">Meta</th>
            </tr>
            <tr>
                <th>Data</th>
                <td>' . ($image['meta'] ? json_encode($image['meta']) : 'No meta data received') . '</td>
            </tr>
        </tbody>
    </table>
    </div>';
        }
    }
    function ellipsis($str, $len = 50)
    {
        return strlen($str) > $len ? substr($str, 0, $len) . '...' : $str;
    }
}
function BloqueBloqueBannerDinamicoIdMalla($id_empresa, $id_malla, $rut)
{
    $vio_banner = VioBannerMalla($rut, $id_empresa, $id_malla);
    return $vio_banner;
}
function ColocaOpcionesDeMetrica($id_empresa, $id_dimension)
{
    $metricas_por_dimension = totalMetricasObjetivosPorEmpresaDimension($id_empresa, $id_dimension);
    foreach ($metricas_por_dimension as $metrica) {
        $option .= "<option value='" . $metrica->id_metrica . "'>" . $metrica->metrica . "</option>";
    }
    return (utf8_encode($option));
}
function ColocaObjetivoEmpresaGerencia($PRINCIPAL, $rut, $id_empresa)
{
    //primero traigo los objetivos de la empresa
    $objetivos_empresa = TrarObjetivosEmpresa($id_empresa);
    $html_empresa      = file_get_contents("views/sgd/objetivos/dimensiones/formulario_76_lectura_empresa.html");
    foreach ($objetivos_empresa as $obj) {
        $row_empresa .= file_get_contents("views/sgd/objetivos/dimensiones/row_formulario_76_lectura_empresa.html");
        $row_empresa = str_replace("{CATEGORY}", $obj->dimension, $row_empresa);
        $row_empresa = str_replace("{KPI}", $obj->kpi, $row_empresa);
        $row_empresa = str_replace("{UNIT}", $obj->metrica, $row_empresa);
        $row_empresa = str_replace("{TARGET}", $obj->descripcion_objetivo, $row_empresa);
        $row_empresa = str_replace("{WEIGHT}", $obj->ponderacion, $row_empresa);
        $row_empresa = str_replace("{KPI_POINTS}", $obj->puntos_kpi, $row_empresa);
        $row_empresa = str_replace("{PAYOUT_RATIO}", $obj->pago, $row_empresa);
    }
    $html_empresa       = str_replace("{ROW_INGRESADOS}", $row_empresa, $html_empresa);
    $datos_usuario      = UsuarioEnBasePersonas($rut);
    $objetivos_gerencia = TrarObjetivosPorGerencia($id_empresa, $datos_usuario[0]->gerencia);
    $html_gerencia      = file_get_contents("views/sgd/objetivos/dimensiones/formulario_76_lectura_gerencia.html");
    $html_gerencia      = str_replace("{NOMBRE_GERENCIA}", $datos_usuario[0]->gerencia, $html_gerencia);
    foreach ($objetivos_gerencia as $obj_gere) {
        $row_gerencia .= file_get_contents("views/sgd/objetivos/dimensiones/row_formulario_76_lectura_gerencia.html");
        $row_gerencia = str_replace("{KPI}", $obj_gere->kpi, $row_gerencia);
        $row_gerencia = str_replace("{UNIT}", $obj_gere->metrica, $row_gerencia);
        $row_gerencia = str_replace("{TARGET}", $obj_gere->descripcion_objetivo, $row_gerencia);
        $row_gerencia = str_replace("{WEIGHT}", $obj_gere->ponderacion, $row_gerencia);
        $row_gerencia = str_replace("{KPI_POR}", $obj_gere->kpi_por, $row_gerencia);
    }
    $html_gerencia = str_replace("{ROW_INGRESADOS}", $row_gerencia, $html_gerencia);
    $PRINCIPAL     = str_replace("{BLOQUE_FORMULARIOS_POR_DIMENSIONES}", utf8_encode($html_empresa . "<br>" . $html_gerencia), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaResumenPorEquipo($PRINCIPAL, $rut, $id_empresa, $id_proceso)
{
    $evaluados              = TraeRelacionesSinAeConDatos($rut, $id_proceso);
    $row_nombre_colaborares = "";
    foreach ($evaluados as $eva) {
        $row_nombre_colaborares .= "<td class='borde_azul_bottom2'>" . $eva->nombre_completo . "</td>";
    }
    //Primero traigo todas las dimeniones
    $dimsiones = DimensionesObjetivosPorEmpresa($id_empresa);
    foreach ($dimsiones as $dimen) {
        //Por cada dimension hago un select distinct del campo descripcion objetivo, mientras sea vacio
        $row_html_ponderaciones .= "<tr><td class='borde_azul_bottom2'><b>" . $dimen->nombre . "</b></td>
        <td class='borde_azul_bottom2' colspan='" . count($evaluados) . "'>&nbsp;</td></tr>";
        $descripcion_objetivos = DistinctCampoDescripcionObjetivosPorDimensionEmpresa($id_empresa, $dimen->id);
        foreach ($descripcion_objetivos as $descr_ob) {
            //luego pro cada descripcion de objetivo, veo si lo tiene cada colaborador, si lo tiene, coloco la ponderacion
            $row_html_ponderaciones .= "<tr>";
            $row_html_ponderaciones .= "<td class='borde_azul_bottom2'>" . $descr_ob->descripcion_objetivo . "</td>";
            foreach ($evaluados as $eva) {
                $tiene_objetivo = ColaboradorTieneObjetivoDadodimensionDescripcionRutIdempresa($id_empresa, $eva->evaluado, $descr_ob->descripcion_objetivo, $dimen->id);
                if ($tiene_objetivo[0]->ponderacion) {
                    $row_html_ponderaciones .= "<td class='borde_azul_bottom2'>" . $tiene_objetivo[0]->ponderacion . "%</td>";
                } else {
                    $row_html_ponderaciones .= "<td class='borde_azul_bottom2'></td>";
                }
            }
            $row_html_ponderaciones .= "</tr>";
        }
    }
    $PRINCIPAL = str_replace("{ROW_POR_COLABORADOR_PONDERACIONES}", utf8_encode($row_html_ponderaciones), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_TABLA_COLABORADORES}", utf8_encode($row_nombre_colaborares), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaCantidadDeFavorito($html, $id_mp, $id_empresa)
{
    //veo si este usuario para esta mp y para esta empresa, ya tiene un Me Gusta
    $total_interaccioneS_por_mp = COMUNIDAD_TieneInteraccion($id_empresa, $id_mp, "FAVORITA");
    $html                       = str_replace("{CANTIDAD_FAVORITOS}", count($total_interaccioneS_por_mp), $html);
    return ($html);
    }
function ColocaCantidadDeMegustaPorPost($html, $id_mp, $id_empresa, $id_post)
{
    //veo si este usuario para esta mp y para esta empresa, ya tiene un Me Gusta
    $total_interaccioneS_por_mp = COMUNIDAD_TieneInteraccionPorPost($id_empresa, $id_mp, "MEGUSTA_POST", $id_post);
    $html                       = str_replace("{CANTIDAD_MEGUSTA}", count($total_interaccioneS_por_mp), $html);
    $html                       = str_replace("{NUMMEGUSTA}", count($total_interaccioneS_por_mp), $html);
    return ($html);
}
function ColocaCantidadDeMegusta($html, $id_mp, $id_empresa)
{
    //veo si este usuario para esta mp y para esta empresa, ya tiene un Me Gusta
    $total_interaccioneS_por_mp = COMUNIDAD_TieneInteraccion($id_empresa, $id_mp, "MEGUSTA");
    $html                       = str_replace("{CANTIDAD_MEGUSTA}", count($total_interaccioneS_por_mp), $html);
    $html                       = str_replace("{NUMMEGUSTA}", count($total_interaccioneS_por_mp), $html);
    return ($html);
}
function ColocaCantidadDeNoMegusta($html, $id_mp, $id_empresa)
{
    //veo si este usuario para esta mp y para esta empresa, ya tiene un Me Gusta
    $total_interaccioneS_por_mp = COMUNIDAD_TieneInteraccion($id_empresa, $id_mp, "NOMEGUSTA");
    $html                       = str_replace("{CANTIDAD_MEGUSTA}", count($total_interaccioneS_por_mp), $html);
    $html                       = str_replace("{NUMNOMEGUSTA}", count($total_interaccioneS_por_mp), $html);
    return ($html);
}
function MuestraComentariosPorPost($id_mp, $limit, $numero)
{
    //echo  "<br><br><br><br><br>$id_mp, $limit, $numero";
    $id_empresa        = $_SESSION["id_empresa"];
    $rut               = $_SESSION["user_"];
    $total_comentarios = ComentariosPorPostTotal($id_mp);
    $comentarios       = ComentariosPorPost($id_mp, "150", $numero);
    //print_r($comentarios);
    foreach ($comentarios as $comen) {
        $row_comentarios .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_comentario_mp_persona_listado.html");
        $row_comentarios      = str_replace("{FOTO_USUARIO_LOGUEADO}", VerificaFotoPersonal($_SESSION["user_"]), $row_comentarios);
        //echo $comen->rut;
        $datos_usuario_perfil = UsuarioEnBasePersonas($comen->rut);
        $row_comentarios      = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones_post.html"), $row_comentarios);
        $row_comentarios      = ColocaMegustaFavoritosPorPost($row_comentarios, $id_empresa, $id_mp, $rut, $comen->id);
        $row_comentarios      = str_replace("{RUT}", $rut, $row_comentarios);
        $row_comentarios      = str_replace("{NOMBRE_AUTOR}", utf8_encode($datos_usuario_perfil[0]->nombre_completo), $row_comentarios);
        $row_comentarios      = str_replace("{TIPO}", "post", $row_comentarios);
        $row_comentarios      = str_replace("{ID_MP}", $id_mp, $row_comentarios);
        $row_comentarios      = str_replace("{ID_POST}", $comen->id, $row_comentarios);
        $tiempo               = date("Y-m-d H:i:s");
        $tiempo               = str_replace(" ", "", $tiempo);
        $tiempo               = str_replace(":", "", $tiempo);
        $tiempo               = str_replace("-", "", $tiempo);
        $row_comentarios      = str_replace("{ID_POST_DIV}", $comen->id . $tiempo, $row_comentarios);
        $fecha_completa       = $comen->fecha . " " . $comen->hora;
        $row_comentarios      = str_replace("{FECHA}", formatearFechaSmall($fecha_completa), $row_comentarios);
        $row_comentarios      = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($comen->rut), $row_comentarios);
        $row_comentarios      = str_replace("{COMENTARIO}", utf8_encode($comen->comentario), $row_comentarios);
        $row_comentarios      = str_replace("{RUT_ENVIADO}", $datos_usuario_perfil[0]->rut, $row_comentarios);


        //Por cada comentario veo si tiene reply
        $comentarios_por_post = ComentariosPorPostTotalReply($id_mp, $comen->id);
        if ($comentarios_por_post) {
            $row_comentarios = str_replace("{BLOQUE_COMENTARIOS_POR_POST}", MuestraComentariosPorPostReply($id_mp, 100, 1, $comen->id), $row_comentarios);
        } else {
            $row_comentarios = str_replace("{BLOQUE_COMENTARIOS_POR_POST}", "", $row_comentarios);
        }
        $row_comentarios = str_replace("{NUMCOMENTARIOSREALES_PORPOST}", count($comentarios_por_post), $row_comentarios);
    }
    $cuantos_van_quedando = count($total_comentarios) - count($comentarios);
    if ($cuantos_van_quedando > 1) {
        //    $numero_nuevo=$numero+1;
        //    $BKrow_comentarios.="
        //    <span id='BloqueComentarios".$numero_nuevo."'><input type='button' value='Cargar Mas Comentarios' class='btn btn-info' onclick=\"Comenta('".$numero_nuevo."');\"></span>
        //    ";
        //    $row_comentarios.=file_get_contents("views/comunidad_mp/row_boton_mas_comentarios.html");
        //    $row_comentarios= str_replace("{NUMERO_NUEVO}",$numero_nuevo,$row_comentarios);
    }
    return ($row_comentarios);
}
function MuestraComentariosPorPostGeneral($id_mp, $limit, $numero)
{
    //echo  "<br><br><br><br><br>$id_mp, $limit, $numero";
    $id_empresa        = $_SESSION["id_empresa"];
    $rut               = $_SESSION["user_"];
    $total_comentarios = ComentariosPorPostTotal($id_mp);
    $comentarios       = ComentariosPorPost($id_mp, "150", $numero);
    //print_r($comentarios);
    foreach ($comentarios as $comen) {
        $row_comentarios .= file_get_contents("views/playbook/" . $id_empresa . "_comentario.html");
        $row_comentarios      = str_replace("{FOTO_USUARIO_LOGUEADO}", VerificaFotoPersonal($_SESSION["user_"]), $row_comentarios);
        //echo $comen->rut;
        $datos_usuario_perfil = UsuarioEnBasePersonas($comen->rut);
        $row_comentarios      = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones_post.html"), $row_comentarios);
        $row_comentarios      = ColocaMegustaFavoritosPorPost($row_comentarios, $id_empresa, $id_mp, $rut, $comen->id);
        $row_comentarios      = str_replace("{RUT}", $rut, $row_comentarios);
        $row_comentarios      = str_replace("{NOMBRE_AUTOR}", utf8_encode($datos_usuario_perfil[0]->nombre_completo), $row_comentarios);
        $row_comentarios      = str_replace("{TIPO}", "post", $row_comentarios);
        $row_comentarios      = str_replace("{ID_MP}", $id_mp, $row_comentarios);
        $row_comentarios      = str_replace("{ID_PAGINA_ENCODEADO}", Encodear3($id_mp), $row_comentarios);
        $row_comentarios      = str_replace("{ID_POST}", $comen->id, $row_comentarios);
        $row_comentarios      = str_replace("{ID_POST_ENCODEADO}", Encodear3($comen->id), $row_comentarios);
        $tiempo               = date("Y-m-d H:i:s");
        $tiempo               = str_replace(" ", "", $tiempo);
        $tiempo               = str_replace(":", "", $tiempo);
        $tiempo               = str_replace("-", "", $tiempo);
        $row_comentarios      = str_replace("{ID_POST_DIV}", $comen->id . $tiempo, $row_comentarios);
        $fecha_completa       = $comen->fecha . " " . $comen->hora;
        $row_comentarios      = str_replace("{FECHA}", formatearFechaSmall($fecha_completa), $row_comentarios);
        $row_comentarios      = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($comen->rut), $row_comentarios);
        $row_comentarios      = str_replace("{COMENTARIO}", utf8_encode($comen->comentario), $row_comentarios);
        $row_comentarios      = str_replace("{RUT_ENVIADO}", $datos_usuario_perfil[0]->rut, $row_comentarios);


        //Por cada comentario veo si tiene reply
        $comentarios_por_post = ComentariosPorPostTotalReply($id_mp, $comen->id);
        if ($comentarios_por_post) {
            $row_comentarios = str_replace("{BLOQUE_COMENTARIOS_POR_POST}", MuestraComentariosPorPostReply($id_mp, 100, 1, $comen->id), $row_comentarios);
        } else {
            $row_comentarios = str_replace("{BLOQUE_COMENTARIOS_POR_POST}", "", $row_comentarios);
        }
        $row_comentarios = str_replace("{NUMCOMENTARIOSREALES_PORPOST}", count($comentarios_por_post), $row_comentarios);
    }
    $cuantos_van_quedando = count($total_comentarios) - count($comentarios);
    if ($cuantos_van_quedando > 1) {
        //    $numero_nuevo=$numero+1;
        //    $BKrow_comentarios.="
        //    <span id='BloqueComentarios".$numero_nuevo."'><input type='button' value='Cargar Mas Comentarios' class='btn btn-info' onclick=\"Comenta('".$numero_nuevo."');\"></span>
        //    ";
        //    $row_comentarios.=file_get_contents("views/comunidad_mp/row_boton_mas_comentarios.html");
        //    $row_comentarios= str_replace("{NUMERO_NUEVO}",$numero_nuevo,$row_comentarios);
    }
    return ($row_comentarios);
}
function ColocaIndicadoresGlobales($PRINCIPAL, $id_empresa)
{
    //Primero traigo indicador Global
    $datos_globales    = IndicadorglobalPorFechaDescendente($id_empresa);
    $resultado_general = $datos_globales[0]->resultado;
    $PRINCIPAL         = str_replace("{RESULTADO_INDICADOR_GLOBAL}", $resultado_general, $PRINCIPAL);
    //Resumen Superior
    $dimensiones       = IndicadoresPromedioPordimension($id_empresa, $datos_globales[0]->id_indicador);
    foreach ($dimensiones as $dimen) {
        $row_dimen_gen .= file_get_contents("views/indicadores/" . $id_empresa . "_row_dimensiones_barra.html");
        $row_dimen_gen = str_replace("{NOMBRE_DIMENSION}", $dimen->nombre, $row_dimen_gen);
        $row_dimen_gen = str_replace("{VALOR_DIMENSION}", $dimen->valor, $row_dimen_gen);
    }
    $PRINCIPAL   = str_replace("{ROW_DIMENSIONES_GENERALES}", $row_dimen_gen, $PRINCIPAL);
    $dimensiones = IndicadoresDimensionesDadoIndicadorGlobal($id_empresa, $datos_globales[0]->id_indicador);
    if ($dimensiones) {
        foreach ($dimensiones as $dim) {
            $row_dimen .= file_get_contents("views/indicadores/" . $id_empresa . "_entorno_tabla_datos.html");
            $row_dimen         = str_replace("{TIPO}", $dim->nombre_dimension, $row_dimen);
            $row_dimen         = str_replace("{ID_DIMENSION}", $dim->codigo_dimension, $row_dimen);
            //Por cada dimension traigo todos los datos
            $detalle_dimension = IndicadoresDetalleDimensionPorIndicadorGlobalYDimension($id_empresa, $datos_globales[0]->id_indicador, $dim->codigo_dimension);
            foreach ($detalle_dimension as $det_dimen) {
                $arreglo_fecha = explode("-", $det_dimen->date);
                $row_dimen     = str_replace("{" . $arreglo_fecha[1] . "}", $det_dimen->dato, $row_dimen);
            }
            for ($i = 1; $i <= 12; $i++) {
                if ($i < 10) {
                    $valor = "0" . $i;
                } else {
                    $valor = $i;
                }
                $row_dimen = str_replace("{" . $valor . "}", "", $row_dimen);
            }
            //Por cada dimension, traigo los criterios
            $criterios_por_dimension = IndicadoresCriteriosPorDimension($id_empresa, $dim->codigo_dimension);
            $row_dimen_gen           = "";
            foreach ($criterios_por_dimension as $criterio) {
                //Por cada criterio, traigo los datos
                $row_dimen_gen .= file_get_contents("views/indicadores/" . $id_empresa . "_row_tabla_datos.html");
                $row_dimen_gen    = str_replace("{NOMBRE_CRITERIO}", $criterio->nombre_criterio, $row_dimen_gen);
                $detalle_criterio = IndicadoresCriteriosPorDimensionDetallePorCriterio($id_empresa, $dim->codigo_dimension, $criterio->id_criterio);
                foreach ($detalle_criterio as $det_cri) {
                    $arreglo_fecha_detalle_criterio = explode("-", $det_cri->date);
                    $row_dimen_gen                  = str_replace("{DATO_" . $arreglo_fecha_detalle_criterio[1] . "}", $det_cri->dato, $row_dimen_gen);
                }
                for ($i = 1; $i <= 12; $i++) {
                    if ($i < 10) {
                        $valor = "0" . $i;
                    } else {
                        $valor = $i;
                    }
                    $row_dimen_gen = str_replace("{DATO_" . $valor . "}", "", $row_dimen_gen);
                }
            }
            $row_dimen = str_replace("{ROW_CRITERIOS_POR_DIMENSION}", $row_dimen_gen, $row_dimen);
        }
        $PRINCIPAL = str_replace("{ROW_LISTA_INDICADORES_GESTION}", $row_dimen, $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{ROW_LISTA_INDICADORES_GESTION}", "", $PRINCIPAL);
    }
    return ($PRINCIPAL);
}
function VerificaRelacionEvaluadoEvaluadorDadoRelMallaPersona($rut, $rut, $id_empresa)
{
    //traigo la relacion de rel_lms_malla_persona
    $rel_lms_malla_persona = LS_TraeMallaConPerfilSGD($rut, $id_empresa);
    $id_perfil             = $rel_lms_malla_persona[0]->id_malla;
    //ahora veo si tiene este perfil en la tabla tbl_Sgd_relaciones
    $tiene_Relacion        = LMS_TraeRelacionAE($rut, $rut, $id_empresa, $id_perfil);
    if (count($tiene_Relacion) == 0) {
        //Inserto registro en la tabla relaciones sgd
        LMS_InsertaRelacionEvaluadoEvaluador($rut, $rut, $id_empresa, $id_perfil);
    }
}
function MuestraInformeIndividualDesdeVistaJefe($rut, $id_objeto)
{
    $datos_objeto = DatosObjeto($id_objeto);
    if ($datos_objeto[0]->preguntas_aleatorias > 0) {
        $datos_preguntas = PreguntasDadoIdObjetoaleatorio($id_objeto, $rut);
    } else {
        $datos_preguntas = PreguntasDadoIdObjeto($id_objeto);
    }
    $total_preguntas = "";
    $i               = 1;
    $correctas       = 0;
    foreach ($datos_preguntas as $preg) {
        $total_preguntas .= file_get_contents("views/integracion/" . $_SESSION["id_empresa"] . "_row_preguntas_respuestas.html");
        $total_preguntas   = str_replace("{N}", $i, $total_preguntas);
        $total_preguntas   = str_replace("{PREGUNTA}", $preg->pregunta, $total_preguntas);
        //Verifico si la respuesta que ingreso el usuario para eta pregunta es correcta o no
        $respuesta_usuario = ObtenerRespuestaDeUsuario($preg->id, $rut);
        //print_r($respuesta_usuario);
        $total_preguntas   = str_replace("{TURESPUESTA}", $respuesta_usuario[0]->alternativa, $total_preguntas);
        if ($respuesta_usuario[0]->correcta == "1") {
            $total_preguntas = str_replace("{COLOR_FONDO}", "color_aprobado_text", $total_preguntas);
            $total_preguntas = str_replace("{ICONO_INFORME_PREGUNTAS}", "fas fa-check-square", $total_preguntas);
            $total_preguntas = str_replace("{RESPUESTA_CORRECTA}", "", $total_preguntas);
            $correctas++;
        } else {
            $total_preguntas = str_replace("{COLOR_FONDO}", "color_reprobado_text", $total_preguntas);
            $total_preguntas = str_replace("{ICONO_INFORME_PREGUNTAS}", "far fa-times-circle", $total_preguntas);
            if ($_SESSION["id_empresa"] <> 57) {
                if (file_exists("views/cursos/informe/" . $_SESSION["id_empresa"] . "_row_respuesta_correcta.html")) {
                    $total_preguntas = str_replace("{RESPUESTA_CORRECTA}", file_get_contents("views/cursos/informe/" . $_SESSION["id_empresa"] . "_row_respuesta_correcta.html"), $total_preguntas);
                } else {
                    $total_preguntas = str_replace("{RESPUESTA_CORRECTA}", file_get_contents("views/cursos/informe/row_respuesta_correcta.html"), $total_preguntas);
                }
            } else {
                $total_preguntas = str_replace("{RESPUESTA_CORRECTA}", "", $total_preguntas);
            }
            $total_preguntas   = str_replace("{CORRECTA}", $respuesta_usuario[0]->alternativa_correcta, $total_preguntas);
            $total_preguntas   = str_replace("{PUNTOS}", round($respuesta_usuario[0]->puntaje), $total_preguntas);
            $total_suma_puntos = $total_suma_puntos + round($respuesta_usuario[0]->puntaje);
        }
        $i++;
    }
    return ($total_preguntas);
}
function MuestraMetassucursales($PRINCIPAL, $evaluado, $id_empresa, $id_proceso, $tipo)
{
    //Trae indicadores
    $cumplimiento_final = METAS_CumplimientoNotaFinal($evaluado);
    $html .= '<div class="TituloSGDDimensiones">
    Resultado  Final&nbsp;&nbsp;|&nbsp;&nbsp; <small>Ponderaci?n:</small> <b>' . $cumplimiento_final[0]->nota . '%</b>
</div>';
    $indicadores = METAS_Indicadores($evaluado, $id_empresa);
    if ($tipo == "pdf") {
        $html .= file_get_contents("views/sgd/objetivos/dimensiones/pdf_row_formulario_indicadores_61.html");
    } else {
        $html .= file_get_contents("views/sgd/objetivos/dimensiones/row_formulario_indicadores_61.html");
    }
    $html  = str_replace("{VARIABLE_NEGOCIO}", $indicadores[0]->variable_negocio, $html);
    $html  = str_replace("{VARIABLE_CONTROL}", $indicadores[0]->variable_control, $html);
    $html  = str_replace("{VARIABLE_SERVICIO}", $indicadores[0]->variable_servicio, $html);
    $html  = str_replace("{PANEL_CONTROL}", $indicadores[0]->panel_control, $html);
    $html  = str_replace("{CUMPLIMIENTO}", $indicadores[0]->cumplimiento, $html);
    //Resultados Clima
    $clima = METAS_CLIMA($evaluado, $id_empresa);
    if ($tipo == "pdf") {
        $html .= file_get_contents("views/sgd/objetivos/dimensiones/pdf_row_formulario_clima_61.html");
    } else {
        $html .= file_get_contents("views/sgd/objetivos/dimensiones/row_formulario_clima_61.html");
    }
    $html      = str_replace("{VA}", $clima[0]->va, $html);
    $html      = str_replace("{VC}", $clima[0]->vc, $html);
    $html      = str_replace("{TI}", $clima[0]->ti, $html);
    $html      = str_replace("{CUMPLIMIENTO}", $clima[0]->cumplimiento, $html);
    //DEsempe?o Laboral
    $desempeno = METAS_DESEMPENO($evaluado, $id_empresa);
    if ($tipo == "pdf") {
        $html .= file_get_contents("views/sgd/objetivos/dimensiones/pdf_row_formulario_desempeno_61.html");
    } else {
        $html .= file_get_contents("views/sgd/objetivos/dimensiones/row_formulario_desempeno_61.html");
    }
    $html      = str_replace("{PUNTAJE_FINAL}", $desempeno[0]->puntaje_final, $html);
    $html      = str_replace("{NOTA_FINAL}", $desempeno[0]->nota_final, $html);
    $html      = str_replace("{CUMPLIMIENTO}", $desempeno[0]->cumplimiento, $html);
    //Auditoria
    $auditoria = METAS_AUDITORIA($evaluado, $id_empresa);
    if ($tipo == "pdf") {
        $html .= file_get_contents("views/sgd/objetivos/dimensiones/pdf_row_formulario_auditoria_61.html");
    } else {
        $html .= file_get_contents("views/sgd/objetivos/dimensiones/row_formulario_auditoria_61.html");
    }
    $html           = str_replace("{AUDITORIA}", $auditoria[0]->auditoria2016, $html);
    $html           = str_replace("{TABLA_CLASIFICACION}", $auditoria[0]->tabla_clasificacion, $html);
    $html           = str_replace("{CUMPLIMIENTO}", $auditoria[0]->cumplimiento, $html);
    $datos_evaluado = UsuarioEnBasePersonasConEvaluadorValidador($evaluado);
    $PRINCIPAL      = str_replace("{RUT_COMPLETO}", utf8_encode($datos_evaluado[0]->rut_completo), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{NOMBRE}", utf8_encode($datos_evaluado[0]->nombre_completo), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{PERFIL_COMPETENCIAS}", utf8_encode($datos_evaluado[0]->perfil_competencia), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{FECHA_INGRESO}", formatearFechaCompleta($datos_evaluado[0]->fecha_ingreso), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{JEFE}", utf8_encode($datos_evaluado[0]->nombre_evaluador), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{JEFE_DEL_JEFE}", utf8_encode($datos_evaluado[0]->nombre_validador), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{CARGO}", utf8_encode($datos_evaluado[0]->cargo), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{GERENCIA}", utf8_encode($datos_evaluado[0]->gerencia), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{DEPARTAMENTO}", utf8_encode($datos_evaluado[0]->departamento), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{GRUPO_COMPETENCIAS}", utf8_encode($datos_evaluado[0]->perfil_competencia), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{URL_PERSONA}", VerificaFotoPersonal($rut_evaluado), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{BLOQUE_METAS_SUCURSALES_CENCO}", $html, $PRINCIPAL);
    $PRINCIPAL      = str_replace("{BLOQUE_FORMULARIOS_POR_DIMENSIONES}", $html, $PRINCIPAL);
    $arreglo[1]     = $PRINCIPAL;
    return ($arreglo);
}
function ConectaLDAPUltramar($user, $pass)
{
    $ldaprdn  = $user; // ldap rdn or dn
    $ldappass = $pass; // associated password
    session_start();
    $arreglo_user           = explode("@", $user);
    $datos_usuario          = UsuarioEnBasePersonaPorEmpresaCodigoSAP($arreglo_user[0]);
    $_SESSION["user_"]      = $datos_usuario[0]->rut;
    $_SESSION["id_empresa"] = $datos_usuario[0]->id_empresa;
    ValidarSesion("visitas", $_SESSION["id_empresa"]);
    $datos_proceso_anual           = ObtengoDatosProcesoAnualActivo($_SESSION["id_empresa"]);
    $_SESSION["id_proceso_anual"]  = $datos_proceso_anual[0]->id;
    $_SESSION["ano_proceso_anual"] = $datos_proceso_anual[0]->ano;
    $datos_empresa                 = DatosEmpresa($existe_base[0]->id_empresa);
    //      echo "LDAP bind successful...";
    ini_set("session.cookie_lifetime", "36000");
    ini_set("session.gc_maxlifetime", "36000");
    setcookie('user_', $datos_usuario[0]->rut, time() + 4800);
    setcookie('id_empresa', $datos_usuario[0]->id_empresa, time() + 4800);
    //echo "    <script>         location.href='?sw=home_ultramar_new';     </script>";
    echo "    <script>         location.href='?sw=com_mp_home';     </script>"; exit;
    $ldaprdn = $ldaprdn . "@holding.net";
    $ldapconn = ldap_connect("198.41.39.47") or die("Could not connect to LDAP server.");
    if ($ldapconn) {
        //echo "no hay conexion con servidor establecida, falta autenticaci?n con credenciales...<br><br>";
        // realizando la autenticaciÃ³n
        $ldapbind = ldap_bind($ldapconn, $ldaprdn, utf8_decode($ldappass));
        // verificaciÃ³n del enlace
        if ($ldapbind) {
            //echo "conexion Exitosa";
            //exit;
            session_start();
            $arreglo_user           = explode("@", $user);
            $datos_usuario          = UsuarioEnBasePersonaPorEmpresaCodigoSAP($arreglo_user[0]);
            $_SESSION["user_"]      = $datos_usuario[0]->rut;
            $_SESSION["id_empresa"] = $datos_usuario[0]->id_empresa;
            ValidarSesion("visitas", $_SESSION["id_empresa"]);
            $datos_proceso_anual           = ObtengoDatosProcesoAnualActivo($_SESSION["id_empresa"]);
            $_SESSION["id_proceso_anual"]  = $datos_proceso_anual[0]->id;
            $_SESSION["ano_proceso_anual"] = $datos_proceso_anual[0]->ano;
            $datos_empresa                 = DatosEmpresa($existe_base[0]->id_empresa);
            if ($_POST["rel"] == "1") {
                $_SESSION["rol"] = "relator";
            }
            //echo "    <script>         location.href='?sw=listMejIVPH&r=".$datos_usuario[0]->rut."';     </script>";
            //      echo "LDAP bind successful...";
            ini_set("session.cookie_lifetime", "36000");
            ini_set("session.gc_maxlifetime", "36000");
            setcookie('user_', $datos_usuario[0]->rut, time() + 4800);
            setcookie('id_empresa', $datos_usuario[0]->id_empresa, time() + 4800);
            //echo "    <script>         location.href='?sw=home_ultramar_new';     </script>";
            echo "    <script>         location.href='?sw=com_mp_home';     </script>";
            //echo "    <script>         location.href='?sw=com_mp_personal';     </script>";
            exit;
            //return("si");
        } else {
            //echo "LDAP bind failed...";
            exit;
            echo "    <script>         location.href='?sw=logultramarv2';     </script>";
            exit;
            //return("no");
        }
    } else {
    }
}
function ColocaBotonCompromisosPorcolaborador($id_empresa)
{
    $boton .= file_get_contents("views/mi_equipo_lider/" . $id_empresa . "_boton_compromisos.html");
    return ($boton);
}
function com_mp_tag($PRINCIPAL, $id_empresa, $rut, $limit)
{
    $tags = com_mp_tag_data($id_empresa, $rut, $limit);
    foreach ($tags as $tag) {
        //echo "<br>".utf8_encode($tag->tag);
        $total_tag .= file_get_contents("views/comunidad_mp/row_com_mp_tag.html");
        $total_tag = str_replace("{TAG}", utf8_encode($tag->tag), $total_tag);
    }
    return ($total_tag);
    $PRINCIPAL = str_replace("{TAG_CLOUD}", utf8_encode($total_tag), $PRINCIPAL);
    return ($PRINCIPAL);
}
function com_mp_personal_tag($PRINCIPAL, $id_empresa, $rut, $ord_by, $filt_by, $filt_cat, $vp)
{
    $arreglo_tag           = com_mp_tag_interes($rut, $id_empresa);
    //print_r($arreglo_tag);
    $posteos_recents       = com_mp_post_recents($rut, $id_empresa);
    $total_posteos_recents = "";
    //    print_r($posteos_recents);
    foreach ($posteos_recents as $post_recent) {
        //$total_posteos_recents.=file_get_contents("views/comunidad_mp/row_com_mp_mini.html");
        $total_posteos_recents .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_mini.html");
        $total_posteos_recents = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($post_recent->rut), $total_posteos_recents);
        $total_posteos_recents = str_replace("{RUT_ENVIADO}", ($post_recent->rut), $total_posteos_recents);
        $total_posteos_recents = str_replace("{NOMBRE}", ($post_recent->nombre), $total_posteos_recents);
        $total_posteos_recents = str_replace("{CONTENIDO}", ($post_recent->contenido), $total_posteos_recents);
        $total_posteos_recents = str_replace("{ID_MP}", ($post_recent->id_mp), $total_posteos_recents);
        $total_posteos_recents = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_posteos_recents);
        if ($com_mp_mi_publicacionseguida->rut == $rut) {
            $total_posteos_recents = str_replace("{EDITAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_editar_mp.html"), $total_posteos_recents);
            $total_posteos_recents = str_replace("{ELIMINAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_borrar_mp.html"), $total_posteos_recents);
        } else {
            $total_posteos_recents = str_replace("{EDITAR_MP}", "", $total_posteos_recents);
            $total_posteos_recents = str_replace("{ELIMINAR_MP}", "", $total_posteos_recents);
        }
        $tiene_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $com_mp_mi_publicacionseguida->id_mp, "MEGUSTA", $rut);
        if ($tiene_megusta) {
            $total_posteos_recents = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta.html"), $total_posteos_recents);
        } else {
            $total_posteos_recents = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta.html"), $total_posteos_recents);
        }
        $tiene_no_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $com_mp_mi_publicacionseguida->id_mp, "NOMEGUSTA", $rut);
        if ($tiene_no_megusta) {
            $total_posteos_recents = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_nomegusta.html"), $total_posteos_recents);
        } else {
            $total_posteos_recents = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_nomegusta.html"), $total_posteos_recents);
        }
        $total_posteos_recents = ColocaCantidadDeMegusta($total_posteos_recents, $com_mp_mi_publicacionseguida->id_mp, $id_empresa);
        $tiene_favorito        = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $com_mp_mi_publicacionseguida->id_mp, "FAVORITA", $rut);
        if ($tiene_favorito) {
            $total_posteos_recents = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_favorito.html"), $total_posteos_recents);
        } else {
            $total_posteos_recents = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_favorito.html"), $total_posteos_recents);
        }
        $total_posteos_recents = str_replace("{FECHA}", formatearFechaSmall($com_mp_mi_publicacion->fecha), $total_posteos_recents);
        $total_posteos_recents = str_replace("{NUMVISITAS}", round($unico->numvisitas), $total_posteos_recents);
        $total_posteos_recents = str_replace("{NUMCOMENTARIOSREALES}", ($unico->numcomentariosreales), $total_posteos_recents);
        $total_posteos_recents = str_replace("{NUMCOMPARTIDA}", ($unico->numcompartido), $total_posteos_recents);
    }
    //$posteos_recents=com_mp_post_recents_4($rut,$id_empresa);
    //$total_posteos_recents="";
    //    print_r($posteos_recents);
    $posteos_recents_mini4 = com_mp_post_recents_mini4($rut, $id_empresa);
    foreach ($posteos_recents_mini4 as $post_recent) {
        $total_posteos_recents_4 .= file_get_contents("views/comunidad_mp/row_com_mp_mini_4.html");
        $total_posteos_recents_4 = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($post_recent->rut), $total_posteos_recents_4);
        $total_posteos_recents_4 = str_replace("{RUT_ENVIADO}", ($post_recent->rut), $total_posteos_recents_4);
        $total_posteos_recents_4 = str_replace("{NOMBRE}", ($post_recent->nombre), $total_posteos_recents_4);
        $total_posteos_recents_4 = str_replace("{CONTENIDO}", substr($post_recent->contenido, 0, 140), $total_posteos_recents_4);
        $total_posteos_recents_4 = str_replace("{ID_MP}", ($post_recent->id_mp), $total_posteos_recents_4);
        $total_posteos_recents_4 = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_posteos_recents_4);
        if ($com_mp_mi_publicacionseguida->rut == $rut) {
            $total_posteos_recents_4 = str_replace("{EDITAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_editar_mp.html"), $total_posteos_recents_4);
            $total_posteos_recents_4 = str_replace("{ELIMINAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_borrar_mp.html"), $total_posteos_recents_4);
        } else {
            $total_posteos_recents_4 = str_replace("{EDITAR_MP}", "", $total_posteos_recents_4);
            $total_posteos_recents_4 = str_replace("{ELIMINAR_MP}", "", $total_posteos_recents_4);
        }
        $tiene_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $com_mp_mi_publicacionseguida->id_mp, "MEGUSTA", $rut);
        if ($tiene_megusta) {
            $total_posteos_recents_4 = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta.html"), $total_posteos_recents_4);
        } else {
            $total_posteos_recents_4 = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta.html"), $total_posteos_recents_4);
        }
        $tiene_no_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $com_mp_mi_publicacionseguida->id_mp, "NOMEGUSTA", $rut);
        if ($tiene_no_megusta) {
            $total_posteos_recents_4 = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_nomegusta.html"), $total_posteos_recents_4);
        } else {
            $total_posteos_recents_4 = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_nomegusta.html"), $total_posteos_recents_4);
        }
        $total_posteos_recents_4 = ColocaCantidadDeMegusta($total_posteos_recents_4, $com_mp_mi_publicacionseguida->id_mp, $id_empresa);
        $tiene_favorito          = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $com_mp_mi_publicacionseguida->id_mp, "FAVORITA", $rut);
        if ($tiene_favorito) {
            $total_posteos_recents_4 = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_favorito.html"), $total_posteos_recents_4);
        } else {
            $total_posteos_recents_4 = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_favorito.html"), $total_posteos_recents_4);
        }
        $total_posteos_recents_4 = str_replace("{FECHA}", formatearFechaSmall($com_mp_mi_publicacion->fecha), $total_posteos_recents_4);
        $total_posteos_recents_4 = str_replace("{NUMVISITAS}", round($unico->numvisitas), $total_posteos_recents_4);
        $total_posteos_recents_4 = str_replace("{NUMCOMENTARIOSREALES}", ($unico->numcomentariosreales), $total_posteos_recents_4);
        $total_posteos_recents_4 = str_replace("{NUMCOMPARTIDA}", ($unico->numcompartido), $total_posteos_recents_4);
    }
    $limit                   = 14;
    ///echo "tag";
    $total_listado_tags      = com_mp_tag_data($id_empresa, $rut, $limit);
    $total_listado_tag_cloud = "";
    //print_r($total_listado_tags);
    // "chau tag";
    foreach ($total_listado_tags as $total_listado_tag_unico) {
        $total_listado_tag_cloud .= file_get_contents("views/comunidad_mp/row_com_mp_tag.html");
        $total_listado_tag_cloud = str_replace("{TAG}", $total_listado_tag_unico->tag, $total_listado_tag_cloud);
        $total_listado_tag_cloud = str_replace("{NUM}", $total_listado_tag_unico->cuenta, $total_listado_tag_cloud);
        $link                    = "?sw=com_mp_personal&tag=" . $total_listado_tag_unico->tag . "";
        $total_listado_tag_cloud = str_replace("{LINK}", $link, $total_listado_tag_cloud);
    }
    $PRINCIPAL = str_replace("{NUM_FAV}", MPbuscaFav($rut, $id_empresa), $PRINCIPAL);
    $PRINCIPAL = str_replace("{NUM_MISPR}", MPbuscaMp($rut, $id_empresa), $PRINCIPAL);
    $PRINCIPAL = str_replace("{INSIGNIA}", "", $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_LISTADO_TIMELINE_PERSONAL}", utf8_encode($total_listado), $PRINCIPAL);
    //$PRINCIPAL = str_replace("{ROW_LISTADO_TIMELINE_PERSONAL_PART2}",utf8_encode($total_listado),$PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_POST_RECENTS}", utf8_encode($total_posteos_recents), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_POST_RECENTS_4}", utf8_encode($total_posteos_recents_4), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_PEOPLE_INTERESTING}", utf8_encode($total_people_interesting), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_FOTO_TIMELINE_PERSONAL}", VerificaFotoPersonal($post_recent->rut), $PRINCIPAL);
    $PRINCIPAL = str_replace("{AGRUPACION_CATEGORIAS}", utf8_encode($total_agrup_categoria), $PRINCIPAL);
    $PRINCIPAL = str_replace("{AGRUPACION_AMBITOS}", utf8_encode($total_agrup_ambito), $PRINCIPAL);
    $PRINCIPAL = str_replace("{MAS_PROPOSITIVOS}", utf8_encode($total_listado_mas_propositivo), $PRINCIPAL);
    $PRINCIPAL = str_replace("{MAS_COLABORADORES}", utf8_encode($total_listado_mas_colaborador), $PRINCIPAL);
    $PRINCIPAL = str_replace("{MAS_APOYADORES}", utf8_encode($total_listado_mas_apoyador), $PRINCIPAL);
    $PRINCIPAL = str_replace("{MAS_PARTICIPATIVOS}", utf8_encode($total_listado_mas_participativo), $PRINCIPAL);
    $PRINCIPAL = str_replace("{MAS_MASTER}", utf8_encode($total_listado_mas_master), $PRINCIPAL);
    $PRINCIPAL = str_replace("{TAG_CLOUD}", utf8_encode($total_listado_tag_cloud), $PRINCIPAL);
    return ($PRINCIPAL);
}


function rutemailaarroba($rut, $id_empresa){

    //echo "$rut, $id_empresa";

        $email  = TraeEmailUsuario($rut, $id_empresa);
        $arr_email= explode("@", $email);
        $nombre_email=$arr_email[0];
        $nombre="@".$nombre_email;

        return $nombre;

    }


function com_mp_vota_yaboto_limite($id_empresa, $rut)
{
    $voto = com_mp_vota_yaboto_limite_data($id_empresa, $rut);
    print_r($voto);
    return $voto;
}
function com_vota_reconoce_home($PRINCIPAL, $id_empresa, $rut, $ord_by, $filt_by, $filt_cat, $vp, $tag, $rut_enviado, $id_categoria)
{
    //BUSCADATOSPERSONALES CANJES
    $puntos_usuario  = premios_buscadatos($rut, $id_empresa);
    //print_r($puntos_usuario);
    $PRINCIPAL       = str_replace("{TOTAL_PUNTOS_RECIBIDOS}", ($puntos_usuario[0]->puntosrecibidos), $PRINCIPAL);
    $PRINCIPAL       = str_replace("{TOTAL_MEDALLAS_RECIBIDAS}", ($puntos_usuario[0]->puntosrecibidos), $PRINCIPAL);

    $PRINCIPAL       = str_replace("{TOTAL_PUNTOS_CANJEADOS}", ($puntos_usuario[0]->puntoscanjeados), $PRINCIPAL);
    $PRINCIPAL       = str_replace("{TOTAL_PUNTOS_SALDOS}", ($puntos_usuario[0]->puntossaldo), $PRINCIPAL);
    //    echo " $id_empresa, $rut, $ord_by, $filt_by,$filt_cat, $vp, $tag, $rut_enviado, $id_categoria";
    //$todas=com_mp_vota_reconoce($id_empresa, $rut, $ord_by, $filt_by, $filt_cat, $vp,$arreglo_tag, $tag, $rut_enviado);
    $voto            = com_mp_vota_yaboto_limite_data($id_empresa, $rut);
    // print_r($voto);
    $candidato_form  = "";
    $candidato_datos = "";
    //$listado_mas=MPObtengoMasInteracciones($id_empresa, "ROW_CANDIDATO_FORM", $limit);
    if ($rut_enviado == "") {
        $candidato_form = file_get_contents("views/reconoce_vota/" . $id_empresa . "_row_buscacandidato.html");
    }
    $limit = 3;
    //$listado_mas=MPObtengoMasInteracciones($id_empresa, "ROW_CANDIDATO_DATOS", $limit);
    //$total_listado_mas_master="";
    if ($rut_enviado <> "") {
        $array_Reco_Gracias = BuscaDatosReconocimientoAgradecimientos($rut_enviado, $id_empresa);
        if ($array_Reco_Gracias[0]->num_gracias > 0) {
            $num_gracias = $array_Reco_Gracias[0]->num_gracias;
        } else {
            $num_gracias = 0;
        }
        if ($array_Reco_Gracias[0]->num_reconocimientos > 0) {
            $num_reconocimientos = $array_Reco_Gracias[0]->num_reconocimientos;
        } else {
            $num_reconocimientos = 0;
        }
        $candidato_datos .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_row_candidato.html");
        $datos_usuario   = UsuarioEnBasePersonas($rut_enviado);
        $candidato_datos = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($rut_enviado), $candidato_datos);
        $candidato_datos = str_replace("{NOMBRE_AUTOR}", ($datos_usuario[0]->nombre_completo), $candidato_datos);
        $candidato_datos = str_replace("{CARGO_AUTOR}", ($datos_usuario[0]->cargo), $candidato_datos);
        $candidato_datos = str_replace("{NUM_GRACIAS}", ($num_gracias), $candidato_datos);
        $candidato_datos = str_replace("{NUM_RECONOCIMIENTO}", ($num_reconocimientos), $candidato_datos);
    }
    $listado_mas                  = Vota_Reconocimiento_Interacciones($id_empresa, "REC_MAS_AGRACIADOS", $limit);
    $total_listado_mas_agraciados = "";
    foreach ($listado_mas as $listado_mas_unico) {
        $total_listado_mas_agraciados .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_row_participantes_mas.html");
        $datos_usuario                = UsuarioEnBasePersonas($listado_mas_unico->rut);
        $total_listado_mas_agraciados = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($listado_mas_unico->rut), $total_listado_mas_agraciados);
        $total_listado_mas_agraciados = str_replace("{NOMBRE}", ($datos_usuario[0]->nombre_completo), $total_listado_mas_agraciados);
        $total_listado_mas_agraciados = str_replace("{NUM}", ($listado_mas_unico->cuenta), $total_listado_mas_agraciados);
        $total_listado_mas_agraciados = str_replace("{NUMTEXT}", " Pr&aacute;cticas Publicadas", $total_listado_mas_agraciados);
        $total_listado_mas_agraciados = str_replace("{TEXTO}", "<br>" . $listado_mas_unico->cuenta, $total_listado_mas_agraciados);
        $total_listado_mas_agraciados = str_replace("{RECONOCIMIENTO}", " <i class='-plaindivcenter nobottommargin far fa-heart'></i> ", $total_listado_mas_agraciados);
        $link                         = "?sw=listMejPrac&filt_by=" . $datos_usuario[0]->rut . "&vp=1#lista";
        $total_listado_mas_agraciados = str_replace("{LINK}", $link, $total_listado_mas_agraciados);
    }
    $listado_mas                  = Vota_Reconocimiento_Interacciones($id_empresa, "REC_MR_MRS_GRACIAS", $limit);
    $total_listado_mas_mr_gracias = "";
    foreach ($listado_mas as $listado_mas_unico) {
        $total_listado_mas_mr_gracias .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_row_participantes_mas.html");
        $datos_usuario                = UsuarioEnBasePersonas($listado_mas_unico->rut);
        $total_listado_mas_mr_gracias = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($listado_mas_unico->rut), $total_listado_mas_mr_gracias);
        $total_listado_mas_mr_gracias = str_replace("{NOMBRE}", ($datos_usuario[0]->nombre_completo), $total_listado_mas_mr_gracias);
        $total_listado_mas_mr_gracias = str_replace("{NUM}", ($listado_mas_unico->cuenta), $total_listado_mas_mr_gracias);
        $total_listado_mas_mr_gracias = str_replace("{NUMTEXT}", " Pr&aacute;cticas Publicadas", $total_listado_mas_mr_gracias);
        $total_listado_mas_mr_gracias = str_replace("{TEXTO}", "<br>" . $listado_mas_unico->cuenta, $total_listado_mas_mr_gracias);
        $total_listado_mas_mr_gracias = str_replace("{RECONOCIMIENTO}", " <i class='-plaindivcenter nobottommargin far fa-heart'></i> ", $total_listado_mas_mr_gracias);
        $link                         = "?sw=listMejPrac&filt_by=" . $datos_usuario[0]->rut . "&vp=1#lista";
        $total_listado_mas_mr_gracias = str_replace("{LINK}", $link, $total_listado_mas_mr_gracias);
    }
    $listado_mas                     = Vota_Reconocimiento_Interacciones($id_empresa, "REC_MAS_RECONOCEDORES", $limit);
    //print_r($listado_mas);
    $total_listado_mas_reconocedores = "";
    foreach ($listado_mas as $listado_mas_unico) {
        $total_listado_mas_reconocedores .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_row_participantes_mas.html");
        $datos_usuario                   = UsuarioEnBasePersonas($listado_mas_unico->rut);
        $total_listado_mas_reconocedores = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($listado_mas_unico->rut), $total_listado_mas_reconocedores);
        $total_listado_mas_reconocedores = str_replace("{NOMBRE}", ($datos_usuario[0]->nombre_completo), $total_listado_mas_reconocedores);
        $total_listado_mas_reconocedores = str_replace("{NUM}", ($listado_mas_unico->cuenta), $total_listado_mas_reconocedores);
        $total_listado_mas_reconocedores = str_replace("{NUMTEXT}", " Pr&aacute;cticas Publicadas", $total_listado_mas_reconocedores);
        $total_listado_mas_reconocedores = str_replace("{TEXTO}", "<br>" . $listado_mas_unico->cuenta, $total_listado_mas_reconocedores);
        $total_listado_mas_reconocedores = str_replace("{RECONOCIMIENTO}", " <i class='-plaindivcenter nobottommargin far fa-heart'></i> ", $total_listado_mas_reconocedores);
        $link                            = "?sw=listMejPrac&filt_by=" . $datos_usuario[0]->rut . "&vp=1#lista";
        $total_listado_mas_reconocedores = str_replace("{LINK}", $link, $total_listado_mas_reconocedores);
    }
    $listado_recientes       = Vota_Reconocimiento_Interacciones($id_empresa, "REC_RECIENTES", $limit);
    $total_listado_recientes = "";
    foreach ($listado_recientes as $listado_recientes_unico) {
        $total_listado_recientes .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_row_participantes_rec.html");
        $datos_usuario           = UsuarioEnBasePersonas($listado_recientes_unico->rut);
        $total_listado_recientes = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($listado_recientes_unico->rut), $total_listado_recientes);
        $total_listado_recientes = str_replace("{NOMBRE}", ($datos_usuario[0]->nombre_completo), $total_listado_recientes);
        $total_listado_recientes = str_replace("{NUM}", ($listado_recientes_unico->cuenta), $total_listado_recientes);
        $total_listado_recientes = str_replace("{NUMTEXT}", " Pr&aacute;cticas Publicadas", $total_listado_recientes);
        $total_listado_recientes = str_replace("{TEXTO}", " fue reconocido por ", $total_listado_recientes);
        $total_listado_recientes = str_replace("{RECONOCIMIENTO}", "Compromiso", $total_listado_recientes);
        $link                    = "?sw=listMejPrac&filt_by=" . $datos_usuario[0]->rut . "&vp=1#lista";
        $total_listado_recientes = str_replace("{LINK}", $link, $total_listado_recientes);
    }
    $listado_valores       = Vota_Reconocimiento_Interacciones($id_empresa, "REC_VALORES", $limit);
    $total_listado_valores = "";
    foreach ($listado_valores as $listado_valores_unico) {
        $total_listado_valores .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_row_vista_valores.html");
        $total_listado_valores = str_replace("{NUMERO}", $listado_valores_unico->cuenta, $total_listado_valores);
        $total_listado_valores = str_replace("{VALOR}", utf8_encode($listado_valores_unico->categoria), $total_listado_valores);
        $total_listado_valores = str_replace("{PORCENTAJE}", ($listado_valores_unico->porcentaje), $total_listado_valores);
    }
    $PRINCIPAL              = str_replace("{NUM_FAV}", MPbuscaFav($rut, $id_empresa), $PRINCIPAL);
    $PRINCIPAL              = str_replace("{NUM_MISPR}", MPbuscaMp($rut, $id_empresa), $PRINCIPAL);
    $PRINCIPAL              = str_replace("{INSIGNIA}", "", $PRINCIPAL);
    $PRINCIPAL              = str_replace("{ROW_LISTADO_TIMELINE_PERSONAL}", utf8_encode($total_listado), $PRINCIPAL);
    $PRINCIPAL              = str_replace("{ROW_POST_RECENTS}", utf8_encode($total_posteos_recents), $PRINCIPAL);
    $PRINCIPAL              = str_replace("{ROW_PEOPLE_INTERESTING}", utf8_encode($total_people_interesting), $PRINCIPAL);
    $PRINCIPAL              = str_replace("{AGRUPACION_CATEGORIAS}", utf8_encode($total_agrup_categoria), $PRINCIPAL);
    $PRINCIPAL              = str_replace("{AGRUPACION_AMBITOS}", utf8_encode($total_agrup_ambito), $PRINCIPAL);
    $PRINCIPAL              = str_replace("{REC_RECIENTES}", utf8_encode($total_listado_recientes), $PRINCIPAL);
    $PRINCIPAL              = str_replace("{REC_MAS_AGRACIADOS}", utf8_encode($total_listado_mas_agraciados), $PRINCIPAL);
    $PRINCIPAL              = str_replace("{REC_MR_MRS_GRACIAS}", utf8_encode($total_listado_mas_mr_gracias), $PRINCIPAL);
    $PRINCIPAL              = str_replace("{REC_MAS_RECONOCEDORES}", utf8_encode($total_listado_mas_reconocedores), $PRINCIPAL);
    $PRINCIPAL              = str_replace("{REC_VALORES}", utf8_encode($total_listado_valores), $PRINCIPAL);
    $limit                  = 10;
    //MIS ULTIMOS CANJES
    $data_premios_canjes    = premios_ultimos_canjes($id_empresa, $rut, $limit);
    $listado_ultimos_canjes = "";
    //print_r($data_premios_canjes);
    foreach ($data_premios_canjes as $data_premio_canje) {
        $listado_ultimos_canjes .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_row_premios_ultimos_canjes.html");
        if ($data_premio_canje->estadovalidacion == '2') {
            $alerta = "<div class='alert alert-warning' role='alert'>  <strong>Canje Pendiente!</strong> Tu jefe aun no valida el Canje.</div>";
        } elseif ($data_premio_canje->estadovalidacion == '1') {
            $alerta = "";
        }
        $listado_ultimos_canjes = str_replace("{NOMBRE_PREMIO}", ($data_premio_canje->nombre_premio), $listado_ultimos_canjes);
        $listado_ultimos_canjes = str_replace("{FECHA_CANJE}", ($data_premio_canje->fecha_texto), $listado_ultimos_canjes);
        $listado_ultimos_canjes = str_replace("{HORA_INICIO}", ($data_premio_canje->hora_inicio), $listado_ultimos_canjes);
        $listado_ultimos_canjes = str_replace("{HORA_TERMINO}", ($data_premio_canje->hora_termino), $listado_ultimos_canjes);
        $listado_ultimos_canjes = str_replace("{PUNTOS_CANJEADOS}", ($data_premio_canje->puntos), $listado_ultimos_canjes);
        $listado_ultimos_canjes = str_replace("{ALERTA_PENDIENTE}", ($alerta), $listado_ultimos_canjes);
    }
    $PRINCIPAL                = str_replace("{ULTIMOSCANJES}", utf8_encode($listado_ultimos_canjes), $PRINCIPAL);
    //MIS ULTIMOS PUNTOS RECIBIDOS
    $data_puntos_recibidos    = premios_ultimos_puntos_recibidos($id_empresa, $rut, $limit);
    $listado_puntos_recibidos = "";
    //print_r($data_premios_canjes);
    foreach ($data_puntos_recibidos as $data_punto_recibido) {
        $listado_puntos_recibidos .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_row_puntos_ultimos_recibidos.html");
        $listado_puntos_recibidos = str_replace("{FECHA_RECIBIDO}", ($data_punto_recibido->fecha), $listado_puntos_recibidos);
        $listado_puntos_recibidos = str_replace("{PUNTOS_RECIBIDOS}", ($data_punto_recibido->puntos), $listado_puntos_recibidos);
    }
    $PRINCIPAL               = str_replace("{PUNTOSRECIBIDOS}", utf8_encode($listado_puntos_recibidos), $PRINCIPAL);
    //MIS RANKING PREMIOS GLOBALES
    $data_ranking_premios    = premios_ranking_canjes($id_empresa, $limit);
    $listado_ranking_premios = "";
    foreach ($data_ranking_premios as $data_ranking_premio) {
        $listado_ranking_premios .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_row_premios_ranking.html");
        $listado_ranking_premios = str_replace("{NOMBRE_PREMIO}", ($data_ranking_premio->nombre_premio), $listado_ranking_premios);
        $listado_ranking_premios = str_replace("{NUMERO_VECES_CANJEADO}", ($data_ranking_premio->cuenta), $listado_ranking_premios);
    }
    $PRINCIPAL                       = str_replace("{RANKINGCANJESGLOBALES}", utf8_encode($listado_ranking_premios), $PRINCIPAL);
    //MIS ULTIMOS CANJES GLOBALES PREMIOS GLOBALES
    $data_ultimos_canjes_globales    = premios_ultimos_canjes_globales($id_empresa, $limit);
    //print_r($data_ultimos_canjes_globales);
    $listado_ultimos_canjes_globales = "";
    foreach ($data_ultimos_canjes_globales as $data_ultimo_canjes_global) {
        $listado_ultimos_canjes_globales .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_row_premios_ultimos_canjes_globales.html");
        $listado_ultimos_canjes_globales = str_replace("{NOMBRE_PREMIO}", ($data_ultimo_canjes_global->nombre_premio), $listado_ultimos_canjes_globales);
        $listado_ultimos_canjes_globales = str_replace("{FECHA_CANJE}", ($data_ultimo_canjes_global->fecha), $listado_ultimos_canjes_globales);
    }
    $PRINCIPAL = str_replace("{ULTIMOSCANJESGLOBALES}", utf8_encode($listado_ultimos_canjes_globales), $PRINCIPAL);
    $PRINCIPAL = str_replace("{HIDDER_CANDIDATO}", $rut_enviado, $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_CANDIDATO_DATOS}", utf8_encode($candidato_datos), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_CANDIDATO_FORM}", utf8_encode($candidato_form), $PRINCIPAL);
    return ($PRINCIPAL);
}
function arrayUnique($array, $preserveKeys = false)
{
    // Unique Array for return
    $arrayRewrite = array();
    // Array with the md5 hashes
    $arrayHashes  = array();
    foreach ($array as $key => $item) {
        // Serialize the current element and create a md5 hash
        $hash = md5(serialize($item));
        // If the md5 didn't come up yet, add the element to
        // to arrayRewrite, otherwise drop it
        if (!isset($arrayHashes[$hash])) {
            // Save the current element hash
            $arrayHashes[$hash] = $hash;
            // Add element to the unique Array
            if ($preserveKeys) {
                $arrayRewrite[$key] = $item;
            } else {
                $arrayRewrite[] = $item;
            }
        }
    }
    return $arrayRewrite;
}



function com_mp_personal_lista_BK_2018_s1($PRINCIPAL, $id_empresa, $rut, $ord_by, $filt_by, $filt_cat, $vp, $tag, $rut_enviado, $tipo_query, $ambiente, $start_limit, $subcategoria, $idamb, $template)
{



    //echo "<br><br><br>4146 function com_mp_personal_lista template $template";
    if ($rut_enviado <> '') {
        $Rut_Perfil = $rut_enviado;
    } else {
        $Rut_Perfil = $rut;
    }

    $start = round(microtime(true) * 1000);

    if ($vp == 1 or $vp == 2 or $vp == 3) { //echo "VP";
        $datos_usuario_perfil           = UsuarioEnBasePersonas($Rut_Perfil);
        $datos_usuario_biografia_perfil = TraeDatosBiografiaProfesionalUnico($Rut_Perfil);
        $datos_interacciones            = TraeDatosInteraccionComRut($Rut_Perfil, $id_empresa);
        $vista_mejoramiento             = "display:none";
        if ($Rut_Perfil == $rut) {
            $vista_mejoramiento = "display:block;";
        }
        $datos_interaccion_personal = TraeBuscaInteraccionPersonal($Rut_Perfil, $id_empresa);
        $sesiguepersona             = count(VerificandompaSeguidores($rut, $Rut_Perfil, $id_empresa));
        if ($sesiguepersona > 0) {
            $boton_seguir = "<center>    <div class='badge_small badge-verde blanco mgtop5'>    <i class='icon-check icons'></i> Siguiendo </div><a href='?sw=com_mp_personal&rut_enviado={RUT_ENVIADO}&vp=1&sg=2' class='badge_small bg-white_borderBlue negro'>
    <i class='icon-user-following icons'></i> Dejar de seguir (-)</a></center>";
        } else {
            $boton_seguir = "<br><center><a href='?sw=com_mp_personal&rut_enviado={RUT_ENVIADO}&vp=1&sg=1' class='badge_small bg-amarillos_seguir negro'>
        <i class='icon-user-following icons'></i> Seguir (+)</a></center>";
        }
        if ($rut == $Rut_Perfil) {
            $boton_seguir = "";
        }
        if ($datos_interaccion_personal[0]->numbcicoins == "") {
            $num_coins = 0;
        } else {
            $num_coins = $datos_interaccion_personal[0]->numbcicoins;
        }
        if ($datos_interaccion_personal[0]->numseguidores == "") {
            $num_seguidores = 0;
        } else {
            $num_seguidores = $datos_interaccion_personal[0]->numseguidores;
        }
        if ($datos_interaccion_personal[0]->numseguidos == "") {
            $num_seguidos = 0;
        } else {
            $num_seguidos = $datos_interaccion_personal[0]->numseguidos;
        }
        if ($datos_interaccion_personal[0]->numpublicaciones == "") {
            $num_publicaciones = 0;
        } else {
            $num_publicaciones = $datos_interaccion_personal[0]->numpublicaciones;
        }
        if ($datos_interaccion_personal[0]->numaptitudesvalidadas == "") {
            $num_aptitudesvalidadas = 0;
        } else {
            $num_aptitudesvalidadas = $datos_interaccion_personal[0]->numaptitudesvalidadas;
        }
        if ($vp == 1) {
            $perfil_personal .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_perfil.html");
        } elseif ($vp == 2) {
            $perfil_personal .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_perfil_interacciones.html");
        } elseif ($vp == 3) {
            $perfil_personal .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_perfil_puntos.html");
        }
        // Mis Notificaciones
        $com_mp_mis_notificaciones    = mp_interacciones_notificaciones($Rut_Perfil, $id_empresa, "");
        //print_r($com_mp_mis_notificaciones); echo "3614";
        $cuenta_notificaciones        = 0;
        $cuenta_notificaciones_sinver = 0;
        $total_notificaciones         = "";
        foreach ($com_mp_mis_notificaciones as $com_mp_mi_notificacion) {
            $cuenta_notificaciones++;
            if ($com_mp_mi_notificacion->visto <> 1) {
                $cuenta_notificaciones_sinver++;
            }
            $ico   = "";
            $texto = "";
            if ($com_mp_mi_notificacion->tipo == "COMENTARIO") {
                $ico = '<i class="icon-speech icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small>';
                if ($com_mp_mi_notificacion->rutAutor == $Rut_Perfil) {
                    $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut_remitente . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreRemitente . '</strong>
                    </a> coment&oacute;:
                    <em>' . $com_mp_mi_notificacion->mensaje . '</em> en tu publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
                } else {
                    $texto = 'Comentaste:
                    <em>' . $com_mp_mi_notificacion->mensaje . '</em> en la publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '">
                    <strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> de
                    <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rutAutor . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreAutor . '</strong>
                    </a> ';
                }
            }
            if ($com_mp_mi_notificacion->tipo == "SEGUIDO" and $Rut_Perfil <> $com_mp_mi_notificacion->rut_remitente) {
                $ico = '<i class="icon-user icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
                if ($com_mp_mi_notificacion->rut_remitenteAutor == $Rut_Perfil) {
                    $texto = 'Seguiste a <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a>';
                } else {
                    if ($com_mp_mi_notificacion->rut_remitente <> $Rut_Perfil) {
                        $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut_remitente . '=1&mp=1">
                            <strong>' . $com_mp_mi_notificacion->NombreRemitente . '</strong> te sigue ';
                    }
                }
            }
            if ($com_mp_mi_notificacion->tipo == "MEGUSTA") {
                $ico = '<i class="icon-thumbs-up icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
                if ($com_mp_mi_notificacion->rut == $Rut_Perfil) {
                    $texto = 'Te gusta la publicaci&oacute;n <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '">
                    <strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> de
                    <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rutAutor . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreAutor . '</strong>
                    </a>';
                } else {
                    $texto = 'A <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a> le Gusta tu publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
                }
            }
            if ($com_mp_mi_notificacion->tipo == "GRUPOSEGUIDO") {
                $ico = '<i class="icon-people icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
                if ($com_mp_mi_notificacion->rut == $Rut_Perfil) {
                    $texto = 'Seguiste el Grupo de Inter&eacute;s
                    <a href="?sw=com_mp_personal&amb=mp_cat&idcat=' . $com_mp_mi_notificacion->contenido . '&cat=' . $com_mp_mi_notificacion->NombreCategoria . '">
                    <strong>' . $com_mp_mi_notificacion->NombreCategoria . '</strong></a>
                    ';
                }
            }
            if ($com_mp_mi_notificacion->tipo == "COMPARTIDOCONMIGO") {
                $ico = '<i class="icon-share icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
                if ($com_mp_mi_notificacion->rut <> $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente <> $Rut_Perfil and $com_mp_mi_notificacion->rut == $com_mp_mi_notificacion->rut_remitente) {
                    $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a> guard&oacute; tu publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
                } elseif ($com_mp_mi_notificacion->rut == $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente == $Rut_Perfil) {
                    $texto = 'Guardaste la publicaci&oacute;n <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '">
                    <strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> de
                    <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rutAutor . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreAutor . '</strong>
                    </a>';
                } elseif ($com_mp_mi_notificacion->rut == $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente <> $Rut_Perfil) {
                    $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreRemitente . '</strong>
                    </a> comparti&oacute; contigo la publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a>
                    de
                    <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rutAutor . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreAutor . '</strong>
                    ';
                } elseif ($com_mp_mi_notificacion->rut <> $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente == $Rut_Perfil) {
                    $texto = 'Compartiste con <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a> la publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a>
                    de
                    <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rutAutor . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreAutor . '</strong>
                    ';
                }
            }
            $total_notificaciones .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_perfil_mis_notificaciones.html");
            $total_notificaciones = str_replace("{ICO}", ($ico), $total_notificaciones);
            $total_notificaciones = str_replace("{TEXTO}", ($texto), $total_notificaciones);
        }

        $perfil_personal       = str_replace("{BOTON_SEGUIR}", $boton_seguir, $perfil_personal);
        $perfil_personal       = str_replace("{PERFIL_COMUNIDAD_FOTO}", VerificaFotoPersonal($Rut_Perfil), $perfil_personal);
        $perfil_personal       = str_replace("{PERFIL_COMUNIDAD_NOMBRE}", $datos_usuario_perfil[0]->nombre_completo, $perfil_personal);
        $perfil_personal       = str_replace("{PERFIL_COMUNIDAD_NOMBRE_EMAIL}", $datos_usuario_perfil[0]->email, $perfil_personal);
        $perfil_personal       = str_replace("{PERFIL_COMUNIDAD_CARGO}", $datos_usuario_perfil[0]->cargo, $perfil_personal);
        $perfil_personal       = str_replace("{PERFIL_COMUNIDAD_GERENCIA}", $datos_usuario_perfil[0]->gerencia, $perfil_personal);
        $perfil_personal       = str_replace("{PERFIL_COMUNIDAD_BIOGRAFIA}", $datos_usuario_biografia_perfil[0]->motivacion, $perfil_personal);
        $perfil_personal       = str_replace("{PERFIL_COMUNIDAD_QUIENSOY}", $datos_usuario_biografia_perfil[0]->estudios, $perfil_personal);
        $perfil_personal       = str_replace("{PERFIL_COMUNIDAD_CANTIDAD_POSTS}", $cantidad_post, $perfil_personal);
        $perfil_personal       = str_replace("{PERFIL_COMUNIDAD_VISITAS_POST}", $suma_visitas_interaccion, $perfil_personal);
        $perfil_personal       = str_replace("{PERFIL_COMUNIDAD_TAGS}", $tags_publicados, $perfil_personal);
        $perfil_personal       = str_replace("{PERFIL_COMUNIDAD_INTERESES}", $tags_misintereses, $perfil_personal);
        $perfil_personal       = str_replace("{PERFIL_COMUNIDAD_MIS_ULTIMAS_PUBLICACIONES}", $titulo_publicaciones, $perfil_personal);
        $datos_mi_perfil       = TraeDatosMiPerfil($Rut_Perfil, $id_empresa);

        $perfil_personal       = str_replace("{BIOGRAFIA}", $datos_mi_perfil[0]->biografia, $perfil_personal);
        $perfil_personal       = str_replace("{NUM_BCICOINS}", $num_coins, $perfil_personal);
        $perfil_personal       = str_replace("{NUM_SEGUIDORES}", $num_seguidores, $perfil_personal);
        $perfil_personal       = str_replace("{NUM_SEGUIDOS}", $num_seguidos, $perfil_personal);
        $perfil_personal       = str_replace("{NUM_PUBLICACIONES}", $num_publicaciones, $perfil_personal);
        $perfil_personal       = str_replace("{NUM_MEGUSTA_FAVORITAS}", $datos_interaccion_personal[0]->nummegustafavorita, $perfil_personal);
        $perfil_personal       = str_replace("{NUM_VISITAS}", $datos_interaccion_personal[0]->numvisitas, $perfil_personal);
        $perfil_personal       = str_replace("{NUM_COMENTARIOS}", $datos_interaccion_personal[0]->numcomentarios, $perfil_personal);
        $perfil_personal       = str_replace("{NUM_APTITUDESVALIDADAS}", $num_aptitudesvalidadas, $perfil_personal);
        $perfil_personal       = str_replace("{NUM_PUBLICACIONESSEGUIDAS}", $datos_interaccion_personal[0]->publicacionesseguidas, $perfil_personal);
        $perfil_personal       = str_replace("{NUM_INTERACCIONES}", $datos_interaccion_personal[0]->numinteracciones, $perfil_personal);
        $perfil_personal       = str_replace("{NUM_NOTIFICACIONES}", $cuenta_notificaciones, $perfil_personal);
        $perfil_personal       = str_replace("{NUM_NOTIFICACIONES_SINVER}", $cuenta_notificaciones_sinver, $perfil_personal);
        // Mis Seguidores
        $com_mp_mis_seguidores = com_mp_busca_interaccion($id_empresa, $Rut_Perfil, "", "SEGUIDO", "10");
        foreach ($com_mp_mis_seguidores as $com_mp_mi_seguidor) {
            $total_listado_mis_seguidores .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_perfil_mis_seguidores.html");
            $total_listado_mis_seguidores = str_replace("{NOMBRE_SEGUIDOR}", ($com_mp_mi_seguidor->nombreR), $total_listado_mis_seguidores);
            $total_listado_mis_seguidores = str_replace("{CARGO_SEGUIDOR}", ($com_mp_mi_seguidor->cargoR), $total_listado_mis_seguidores);
            $total_listado_mis_seguidores = str_replace("{GERENCIA_SEGUIDOR}", ($com_mp_mi_seguidor->gerenciaR), $total_listado_mis_seguidores);
            $total_listado_mis_seguidores = str_replace("{FOTO_SEGUIDOR}", VerificaFotoPersonal($com_mp_mi_seguidor->rut_remitente), $total_listado_mis_seguidores);
            $total_listado_mis_seguidores = str_replace("{RUT_ENVIADO}", ($com_mp_mi_seguidor->rut_remitente), $total_listado_mis_seguidores);
        }
        $perfil_personal     = str_replace("{ROW_COMP_MP_MIS_SEGUIDORES}", ($total_listado_mis_seguidores), $perfil_personal);
        $perfil_personal     = str_replace("{ROW_COMP_MP_MIS_NOTIFICACIONES}", ($total_notificaciones), $perfil_personal);
        // Mis Seguidos
        $com_mp_mis_seguidos = com_mp_busca_interaccion($id_empresa, "", $Rut_Perfil, "SEGUIDO", "10");
        foreach ($com_mp_mis_seguidos as $com_mp_mi_seguido) {
            $total_listado_mis_seguidos .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_perfil_mis_seguidores.html");
            $total_listado_mis_seguidos = str_replace("{NOMBRE_SEGUIDOR}", ($com_mp_mi_seguido->nombre), $total_listado_mis_seguidos);
            $total_listado_mis_seguidos = str_replace("{CARGO_SEGUIDOR}", ($com_mp_mi_seguido->cargo), $total_listado_mis_seguidos);
            $total_listado_mis_seguidos = str_replace("{GERENCIA_SEGUIDOR}", ($com_mp_mi_seguido->gerencia), $total_listado_mis_seguidos);
            $total_listado_mis_seguidos = str_replace("{FOTO_SEGUIDOR}", VerificaFotoPersonal($com_mp_mi_seguido->rut), $total_listado_mis_seguidos);
            $total_listado_mis_seguidos = str_replace("{RUT_ENVIADO}", ($com_mp_mi_seguido->rut), $total_listado_mis_seguidos);
        }
        $perfil_personal      = str_replace("{ROW_COMP_MP_MIS_SEGUIDOS}", ($total_listado_mis_seguidos), $perfil_personal);
        // MIS APTITUDES
        $com_mp_mis_aptitudes = com_mp_busca_categorias_comunidad_e_interaccion($Rut_Perfil, "APTITUD", $id_empresa);
        //PRINT_R($com_mp_mis_aptitudes);
        foreach ($com_mp_mis_aptitudes as $com_mp_mis_aptitud) {
            //print_r($com_mp_mis_aptitud);
            $total_listado_mis_aptitudes .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_perfil_mis_aptitudes.html");
            $chequado = "";
            $checked  = "  ";
            if ($com_mp_mis_aptitud->cuenta > 0) {
                $chequado = "Mi Expertise";
                $checked  = " checked ";
            }
            $total_listado_mis_aptitudes = str_replace("{CATEGORIA}", ($com_mp_mis_aptitud->categoria), $total_listado_mis_aptitudes);
            $total_listado_mis_aptitudes = str_replace("{CHECKED}", utf8_decode($checked), $total_listado_mis_aptitudes);
            $total_listado_mis_aptitudes = str_replace("{CHEQUEADO}", utf8_decode($chequeado), $total_listado_mis_aptitudes);
            $total_listado_mis_aptitudes = str_replace("{ID_CATEGORIA}", utf8_decode($com_mp_mis_aptitud->id_categoria), $total_listado_mis_aptitudes);
        }
        $perfil_personal              = str_replace("{ROW_COMP_MP_CATEGORIAS_MIS_APTITUDES_CHECKBOXS}", ($total_listado_mis_aptitudes), $perfil_personal);
        $datos                        = TraeDatosBiografiaProfesionalPorEmpresa($Rut_Perfil, $id_empresa);
        $perfil_personal              = str_replace("{INFO_BIOGRAFIA}", ($datos[0]->estudios), $perfil_personal);
        // VALIDACION APTITUDES
        $com_mp_mis_validar_aptitudes = com_mp_busca_validacion_aptitudes($Rut_Perfil, "", "APTITUD_VALIDADA", $id_empresa);
        //PRINT_R($com_mp_mis_aptitudes);
        $cuenta_validacion            = 0;
        foreach ($com_mp_mis_validar_aptitudes as $com_mp_mis_validar_aptitud) {
            //    print_r($com_mp_mis_validar_aptitud);
            $total_listado_validar_aptitudes .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_perfil_validar_aptitudes.html");
            //Aca veo si el usuario de sesion, ya hizo me gusta a esta aptitud para esta categoria y para este usuarios
            //$tiene_megusta=UsuarioHizoMegustaEnAptitud($Rut_Perfil, $com_mp_mis_validar_aptitud->rut_receptor, $com_mp_mis_validar_aptitud->idcategoria, "APTITUD_VALIDADA", $id_empresa);
            $tiene_megusta = UsuarioHizoMegustaEnAptitud($Rut_Perfil, $_SESSION["user_"], $com_mp_mis_validar_aptitud->idcategoria, "APTITUD_VALIDADA", $id_empresa);
            if ($tiene_megusta) {
                $total_listado_validar_aptitudes = str_replace("{BLOQUE_PARA_MEGUSTA_APTITUDES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_yamegusta_aptitudes.html"), $total_listado_validar_aptitudes);
            } else {
                $total_listado_validar_aptitudes = str_replace("{BLOQUE_PARA_MEGUSTA_APTITUDES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_megusta_aptitudes.html"), $total_listado_validar_aptitudes);
            }
            $total_listado_validar_aptitudes = str_replace("{ID_CATEGORIA}", ($com_mp_mis_validar_aptitud->idcategoria), $total_listado_validar_aptitudes);
            $total_listado_validar_aptitudes = str_replace("{RUT_RECEPTOR}", ($com_mp_mis_validar_aptitud->rut_receptor), $total_listado_validar_aptitudes);
            //echo "$com_mp_mis_validar_aptitud->vecesvalidada";
            if ($com_mp_mis_validar_aptitud->vecesvalidada > 0) {
                //$estrellas_com_mp=0;
                $estrellas_com_mp          = "";
                $estrellas_com_mp_promedio = "";
                //    for ($i = 1; $i <= $com_mp_mis_validar_aptitud->vecesvalidada; $i++) {
                //            $estrellas_com_mp_promedio.="<span class='badge badge-pill badge-success'><span class='blanco'><i class='icon-star icons'></i></span></span>";
                //    }
                $estrellas_com_mp          = $com_mp_mis_validar_aptitud->vecesvalidada;
                $transforma100             = (25 * $estrellas_com_mp - 25);
                if ($transforma100 < 10) {
                    $transforma100 = 10;
                }
                if ($transforma100 > 100) {
                    $transforma100 = 100;
                }
                //$transforma101=33;
                //$transforma102=44;
                //echo
                $estrellas_com_mp_promedio         = "<ul class='skills'>
                            <li data-percent='" . $transforma100 . "'>
                                <div class='progress skills-animated' style='width: " . $transforma100 . "%;'>
                                    <div class='progress-percent'><div class='counter counter-inherit counter-instant'><span data-from='0' data-to='" . $estrellas_com_mp . "' data-refresh-interval='30' data-speed='1100'>" . $transforma100 . "</span></div></div>
                                </div>
                            </li>
                </ul>";
                //$total_listado_validar_aptitudes = str_replace("{ESTRELLAsS_ACTUALES}",$com_mp_mis_validar_aptitud->vecesvalidada." ".$estrellas_com_mp,$total_listado_validar_aptitudes);
                $total_listado_validar_aptitudes   = str_replace("{ESTRELLAS_ACTUALES}", $estrellas_com_mp_promedio, $total_listado_validar_aptitudes);
                $datos_estrellas_aptitudes_usuario = busca_Estrellas_Aptitud($com_mp_mis_validar_aptitud->idcategoria, $rut_autor, $rut_receptor, $id_empresa);
                for ($k = 1; $k <= $datos_estrellas_aptitudes_usuario[0]->mensaje; $k++) {
                    $estrellas_com_mp_usuario .= "<span class='badge badge-pill badge-success'><span class='blanco'><i class='icon-star icons'></i></span></span>";
                }
                $total_listado_validar_aptitudes = str_replace("{ESTRELLAS}", $estrellas_com_mp_usuario, $total_listado_validar_aptitudes);
            } else {
                $total_listado_validar_aptitudes = str_replace("{ESTRELLAS_ACTUALES}", "<span class='badge badge-pill badge-default'>S&eacute; el primero en valorar la aptitud</span>", $total_listado_validar_aptitudes);
            }
            $total_listado_validar_aptitudes = str_replace("{CATEGORIA}", ($com_mp_mis_validar_aptitud->categoria), $total_listado_validar_aptitudes);
            $total_listado_validar_aptitudes = str_replace("{CHECKED}", utf8_encode($checked), $total_listado_validar_aptitudes);
            $total_listado_validar_aptitudes = str_replace("{CHEQUEADO}", utf8_encode($chequeado), $total_listado_validar_aptitudes);
            $perfil_personal                 = str_replace("{TITULO_COMP_MP_CATEGORIAS_VALIDAR_APTITUDES_CHECKBOXS}", "
                Validas las aptitudes de " . $datos_usuario_perfil[0]->nombre_completo . "<BR><BR>
    <div class='row'>
        <div class='col-xs-3 col-sm-3 col-lg-3  col-md-3'><strong><small>Aptitud</small></strong></div>
        <div class='col-xs-6 col-sm-6 col-lg-6  col-md-6'><strong><small>Valoraci&oacute;n</div>
        <div class='col-xs-3 col-sm-3 col-lg-3  col-md-3'></div>
    </div>
                ", $perfil_personal);
            $cuenta_validacion++;
        }
        if ($cuenta_validacion == 0) {
            $perfil_personal                 = str_replace("{TITULO_COMP_MP_CATEGORIAS_VALIDAR_APTITUDES_CHECKBOXS}", "", $perfil_personal);
            $total_listado_validar_aptitudes = $datos_usuario_perfil[0]->nombre_completo . " no ha ingresado Aptitudes";
        }
        $perfil_personal          = str_replace("{ROW_COMP_MP_CATEGORIAS_VALIDAR_APTITUDES_CHECKBOXS}", ($total_listado_validar_aptitudes), $perfil_personal);
        // Mis Interacciones
        $com_mp_mis_interacciones = com_mp_mis_interacciones_perfil($Rut_Perfil, $id_empresa, "50");
        //print_r($com_mp_mis_interacciones);
        foreach ($com_mp_mis_interacciones as $com_mp_mi_interaccion) {
            $total_listado_mis_interacciones .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_perfil_mis_interacciones.html");
            $total_listado_mis_interacciones = str_replace("{FECHA}", utf8_encode(formatearFechaSmall($com_mp_mi_interaccion->fecha)), $total_listado_mis_interacciones);
            $total_listado_mis_interacciones = str_replace("{TIPO}", utf8_encode($com_mp_mi_interaccion->tipo), $total_listado_mis_interacciones);
            if ($com_mp_mi_interaccion->mensaje <> '') {
                $postM = "<em><strong>" . $com_mp_mi_interaccion->mensaje . "</strong></em><br>";
            } else {
                $postM = "";
            }
            if ($com_mp_mi_interaccion->post <> '') {
                $postR = "Publicaci&oacute;n: <a href='?sw=com_mp_full&id_mp=" . $com_mp_mi_interaccion->id_mp . "'><strong>" . $com_mp_mi_interaccion->post . "</strong></a><br>";
            } else {
                $postR = "";
            }
            if ($com_mp_mi_interaccion->categoria <> '') {
                $postC = "<a href='?sw=com_mp_personal&amb=mp_cat&idcat=" . $com_mp_mi_interaccion->contenido . "&cat=General'>" . $com_mp_mi_interaccion->categoria . "</a><br>";
            } else {
                $postC = "";
            }
            if ($com_mp_mi_interaccion->remitente <> '') {
                $postRe = "Realizado por <a href='?sw=com_mp_personal&rut_enviado=" . $com_mp_mi_interaccion->rut_remitente . "&vp=1&mp=1'>" . $com_mp_mi_interaccion->remitente . "</a><br>";
            } else {
                $postRe = "";
            }
            //if($com_mp_mi_interaccion->autor<>''){$postA="<a href='?sw=com_mp_personal&rut_enviado=".$com_mp_mi_interaccion->rutautor."&vp=1&mp=1'>".$com_mp_mi_interaccion->autor."</a>";} else { $postA="";}
            $sujeto                          = $postM . $postR . $postC . $postRe . $postA;
            $total_listado_mis_interacciones = str_replace("{SUJETO}", ($sujeto), $total_listado_mis_interacciones);
        }
        $perfil_personal          = str_replace("{ROW_COMP_ACTIVIDADES_INTERES_CHECKBOXS_VALIDAR}", ($total_listado_mis_interacciones), $perfil_personal);
        //MIS publicaciones
        $com_mp_mis_publicaciones = com_mp_mis_publicaciones($id_empresa, $Rut_Perfil, "mis_publicaciones", "25");
        foreach ($com_mp_mis_publicaciones as $com_mp_mi_publicacion) {
            $total_listado_mis_publicaciones .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_persona_listado_tipoA1R.html");
            if ($unico->rut_mentor <> '') {
                $nombre_mentor = UsuarioEnBasePersonaPorEmpresa($unico->rut_mentor, $id_empresa);
                $mentor        = "<a href='?sw=com_mp_personal&rut_enviado=" . $nombre_mentor[0]->rut . "&vp=1'><div class='badge_small badge-verde blanco mgtop5'>    <i class='icon-check icons'></i> Respondido por " . $nombre_mentor[0]->nombre_completo . "</div></a>";
            } else {
                $mentor = "";
            }
            $total_listado_mis_publicaciones = str_replace("{NOMBRE_MENTOR}", ($mentor), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_listado_mis_publicaciones);
            if ($com_mp_mi_publicacion->rut == $rut) {
                $total_listado_mis_publicaciones = str_replace("{EDITAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_editar_mp.html"), $total_listado_mis_publicaciones);
                $total_listado_mis_publicaciones = str_replace("{ELIMINAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_borrar_mp.html"), $total_listado_mis_publicaciones);
            } else {
                $total_listado_mis_publicaciones = str_replace("{EDITAR_MP}", "", $total_listado_mis_publicaciones);
                $total_listado_mis_publicaciones = str_replace("{ELIMINAR_MP}", "", $total_listado_mis_publicaciones);
            }
            $tiene_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $com_mp_mi_publicacion->id_mp, "MEGUSTA", $rut);
            if ($tiene_megusta) {
                $total_listado_mis_publicaciones = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta.html"), $total_listado_mis_publicaciones);
            } else {
                $total_listado_mis_publicaciones = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta.html"), $total_listado_mis_publicaciones);
            }
            $tiene_no_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $com_mp_mi_publicacion->id_mp, "NOMEGUSTA", $rut);
            if ($tiene_no_megusta) {
                $total_listado_mis_publicaciones = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_nomegusta.html"), $total_listado_mis_publicaciones);
            } else {
                $total_listado_mis_publicaciones = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_nomegusta.html"), $total_listado_mis_publicaciones);
            }
            $total_listado_mis_publicaciones = ColocaCantidadDeMegusta($total_listado_mis_publicaciones, $com_mp_mi_publicacion->id_mp, $id_empresa);
            $tiene_favorito                  = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $com_mp_mi_publicacion->id_mp, "FAVORITA", $rut);
            if ($tiene_favorito) {
                $total_listado_mis_publicaciones = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_favorito.html"), $total_listado_mis_publicaciones);
            } else {
                $total_listado_mis_publicaciones = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_favorito.html"), $total_listado_mis_publicaciones);
            }
            $post_categoria = '<a href="?sw=com_mp_personal&amb=mp_cat&idcat=' . $com_mp_mi_publicacion->id_categoria . '&cat=' . $com_mp_mi_publicacion->categoria . '"><span class="badge_small badge-azul"><span class="blanco"><i class="icon-people icons"></i> ' . $com_mp_mi_publicacion->categoria . '</span></span></a>';
            if ($com_mp_mi_publicacion->tipo == "MejorPractica") {
                $ico = "img/bci_mp_practica_icon.png";
            }
            if ($com_mp_mi_publicacion->tipo == "Papers") {
                $ico = "img/bci_mp_paper_icon.png";
            }
            if ($com_mp_mi_publicacion->tipo == "Publicacion") {
                $ico = "img/bci_mp_publicacion.png";
            }
            if ($com_mp_mi_publicacion->tipo == "Video" or $com_mp_mi_publicacion->tipo == "VideoInterno") {
                $ico = "img/bci_mp_practica_video.png";
            }
            if ($com_mp_mi_publicacion->tipo == "Links" or $com_mp_mi_publicacion->tipo == "LinkExterno") {
                $ico = "img/bci_mp_link_icon.png";
            }
            if ($com_mp_mi_publicacion->tipo == "Experiencias") {
                $ico = "img/bci_mp_experiencias_icon.png";
            }
            if ($com_mp_mi_publicacion->tipo == "Experto") {
                $ico = "img/bci_mp_experto_icon.png";
            }
            if ($com_mp_mi_publicacion->tipo == "OportunidadMejora") {
                $ico = "img/bci_mp_oportunidadmejora_icon.png";
            }
            if ($com_mp_mi_publicacion->tipo == "Udnolohaga") {
                $ico = "img/bci_mp_udnolohaga_icon.png";
            }
            if ($com_mp_mi_publicacion->tipo == "RRPP") {
                $ico = "img/bci_mp_rrpp_icon.png";
            }
            if ($com_mp_mi_publicacion->tipo == "Pregunta") {
                $ico = "img/bci_mp_pregunta_icon.png";
            }
            if ($com_mp_mi_publicacion->tipo == "Respuesta") {
                $ico = "img/bci_mp_pregunta_icon.png";
            }
            $total_listado_mis_publicaciones = str_replace("{ICONO}", $ico, $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{ICONO_DESC}", $ico, $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = ColocaCantidadDeFavorito($total_listado_mis_publicaciones, $com_mp_mi_publicacion->id_mp, $id_empresa);
            $total_listado_mis_publicaciones = str_replace("{ID_MP}", $com_mp_mi_publicacion->id_mp, $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{ID_MP_ENCODEADO}", Encodear3($com_mp_mi_publicacion->id_mp), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{TIPO}", "A", $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{LINK}", $link_MP, $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{CATEGORIA_MP}", $post_categoria, $total_listado_mis_publicaciones);
            $post_ambito                     = '<a href="?sw=com_mp_personal&amb=mp_amb&idamb=' . $com_mp_mi_publicacion->id_ambito . '&ambito=' . $com_mp_mi_publicacion->ambito . '">
<span class="badge_small badge-azul"><span class="blanco"><i class="icon-people icons"></i> ' . $com_mp_mi_publicacion->ambito . '</span></span></a>';
            $total_listado_mis_publicaciones = str_replace("{AMBITO_MP}", $post_ambito, $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($com_mp_mi_publicacion->descripcion_categoria), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{NOMBRE}", ($com_mp_mi_publicacion->nombre), $total_listado_mis_publicaciones);
            if ($com_mp_mi_publicacion->contenido == "") {
                $resumen = ($com_mp_mi_publicacion->resumen);
            } else {
                $resumen = limit_text($com_mp_mi_publicacion->contenido, 35);
            }
            $total_listado_mis_publicaciones = str_replace("{CONTENIDO}", $resumen, $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{FECHA}", formatearFechaSmall($com_mp_mi_publicacion->fecha), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{ESTADO}", ($com_mp_mi_publicacion->estado), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{DESCRIPCION_ESTADO}", ($com_mp_mi_publicacion->descripcion_estado), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{RUT_AUTOR}", ($com_mp_mi_publicacion->rut), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{RUT}", ($rut), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{NOMBRE_AUTOR}", ($com_mp_mi_publicacion->nombre_autor), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{NOMBRE_AUTOR}", ($com_mp_mi_publicacion->nombre_autor), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($com_mp_mi_publicacion->rut), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{NUMVISITAS}", round($com_mp_mi_publicacion->numvisitas), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{NUMMEGUSTA}", ($com_mp_mi_publicacion->nummegusta), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{NUMCOMPARTIDA}", ($com_mp_mi_publicacion->numcompartido), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{NUMCOMENTARIO}", ($com_mp_mi_publicacion->numcomentarios), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{NUMCOMENTARIOSREALES}", ($com_mp_mi_publicacion->numcomentariosreales), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{NUMFAVORITA}", ($com_mp_mi_publicacion->numfavorita), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{ESTILOESTADO}", ($com_mp_mi_publicacion->estilo), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{ICONOESTADO}", ($com_mp_mi_publicacion->icono_estado), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{ESTILOCATEGORIA}", ($com_mp_mi_publicacion->style), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{ICONOCATEGORIA}", ($com_mp_mi_publicacion->icono), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{CATEGORIA_MP}", ($com_mp_mi_publicacion->categoria), $total_listado_mis_publicaciones);
            if ($com_mp_mi_publicacion->tipo_multimedia == "imagen" and $com_mp_mi_publicacion->imagen_fondo <> '') {
                $imagen = "../../front/multimedia/" . $com_mp_mi_publicacion->multimedia;
            } else {
                $imagen = "";
            }
            if ($com_mp_mi_publicacion->tipo_multimedia == "video") {
                $video = "../../front/multimedia/" . $com_mp_mi_publicacion->multimedia;
            } else {
                $video = "";
            }
            $total_listado_mis_publicaciones = str_replace("{IMAGEN_POST}", "multimedia/" . $com_mp_mi_publicacion->imagenfondo, $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{VIDEO}", ($video), $total_listado_mis_publicaciones);
            $total_listado_mis_publicaciones = str_replace("{TIPOMULTIMEDIA}", ($com_mp_mi_publicacion->tipo_multimedia), $total_listado_mis_publicaciones);
            $listado_comentarios             = MuestraComentariosPorPost($com_mp_mi_publicacion->id_mp);
            $total_listado_mis_publicaciones = str_replace("{BLOQUE_COMENTARIOS}", $listado_comentarios, $total_listado_mis_publicaciones);
            if ($com_mp_mi_publicacion->url_documento) {
                $total_listado_mis_publicaciones = str_replace("{BLOQUE_URL_DOCUMENTO}", file_get_contents("views/comunidad_mp/row_com_mp_url_documento.html"), $total_listado_mis_publicaciones);
                $total_listado_mis_publicaciones = str_replace("{URL_DOCUMENTO}", ($com_mp_mi_publicacion->url_documento), $total_listado_mis_publicaciones);
            } else {
                $total_listado_mis_publicaciones = str_replace("{BLOQUE_URL_DOCUMENTO}", "", $total_listado_mis_publicaciones);
            }
            if ($com_mp_mi_publicacion->video) {
                $video_youtube                   = ColocaVideoYoutube($com_mp_mi_publicacion->video,  $com_mp_mi_publicacion->id_mp);
                $total_listado_mis_publicaciones = str_replace("{VIDEO_IMAGEN}", $video_youtube, $total_listado_mis_publicaciones);
            } else {
                $bloque_imagen_fondo             = ColocaImagenPost($com_mp_mi_publicacion->imagenfondo);
                $total_listado_mis_publicaciones = str_replace("{VIDEO_IMAGEN}", $bloque_imagen_fondo, $total_listado_mis_publicaciones);
            }
            $TagsPorPosts = TagsPorMPEmpresa($com_mp_mi_publicacion->id_mp, $id_empresa);
            $tag_por_post = "";
            foreach ($TagsPorPosts as $TagsPorPost) {
                $tag_por_post .= '<a href="?sw=com_mp_personal&amb=mp_tag&tag=' . $TagsPorPost->tag . '"><span class="badge_small badge-white"><span class="negro">#' . $TagsPorPost->tag . '</span></span></a> ';
            }
            $total_listado_mis_publicaciones = str_replace("{TAGS_POR_POST}", ($tag_por_post), $total_listado_mis_publicaciones);
        }
        $perfil_personal                   = str_replace("{MIS_PUBLICACIONES_MIPERFIL}", ($total_listado_mis_publicaciones), $perfil_personal);
        //MIS publicaciones SEGUIDAS
        $com_mp_mis_publicaciones_seguidas = com_mp_mis_publicaciones($id_empresa, $Rut_Perfil, "mis_publicaciones_seguidas", "25");
        foreach ($com_mp_mis_publicaciones_seguidas as $com_mp_mi_publicacionseguida) {
            $total_listado_mis_publicaciones_seguidas .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_persona_listado_tipoA1R.html");
            if ($unico->rut_mentor <> '') {
                $nombre_mentor = UsuarioEnBasePersonaPorEmpresa($unico->rut_mentor, $id_empresa);
                $mentor        = "<a href='?sw=com_mp_personal&rut_enviado=" . $nombre_mentor[0]->rut . "&vp=1'><div class='badge_small badge-verde blanco mgtop5'>    <i class='icon-check icons'></i> Respondido por " . $nombre_mentor[0]->nombre_completo . "</div></a>";
            } else {
                $mentor = "";
            }
            $total_listado_mis_publicaciones_seguidas = str_replace("{NOMBRE_MENTOR}", ($mentor), $total_listado_mis_publicaciones_seguidas);
            if ($com_mp_mi_publicacionseguida->tipo == "MejorPractica") {
                $ico = "img/bci_mp_practica_icon.png";
            }
            if ($com_mp_mi_publicacionseguida->tipo == "Papers") {
                $ico = "img/bci_mp_paper_icon.png";
            }
            if ($com_mp_mi_publicacionseguida->tipo == "Publicacion") {
                $ico = "img/bci_mp_publicacion.png";
            }
            if ($com_mp_mi_publicacionseguida->tipo == "Video" or $com_mp_mi_publicacionseguida->tipo == "VideoInterno") {
                $ico = "img/bci_mp_practica_video.png";
            }
            if ($com_mp_mi_publicacionseguida->tipo == "Links" or $com_mp_mi_publicacionseguida->tipo == "LinkExterno") {
                $ico = "img/bci_mp_link_icon.png";
            }
            if ($com_mp_mi_publicacionseguida->tipo == "Experiencias") {
                $ico = "img/bci_mp_experiencias_icon.png";
            }
            if ($com_mp_mi_publicacionseguida->tipo == "Experto") {
                $ico = "img/bci_mp_experto_icon.png";
            }
            if ($com_mp_mi_publicacionseguida->tipo == "OportunidadMejora") {
                $ico = "img/bci_mp_oportunidadmejora_icon.png";
            }
            if ($com_mp_mi_publicacionseguida->tipo == "Udnolohaga") {
                $ico = "img/bci_mp_udnolohaga_icon.png";
            }
            if ($com_mp_mi_publicacionseguida->tipo == "RRPP") {
                $ico = "img/bci_mp_rrpp_icon.png";
            }
            if ($com_mp_mi_publicacionseguida->tipo == "Pregunta") {
                $ico = "img/bci_mp_pregunta_icon.png";
            }
            if ($com_mp_mi_publicacionseguida->tipo == "Respuesta") {
                $ico = "img/bci_mp_pregunta_icon.png";
            }
            $total_listado_mis_publicaciones_seguidas = str_replace("{ICONO}", $ico, $total_listado_mis_publicaciones_seguidas);
            $total_listado_mis_publicaciones_seguidas = str_replace("{ICONO_DESC}", $com_mp_mi_publicacionseguida->tipo, $total_listado_mis_publicaciones_seguidas);
            $total_listado_mis_publicaciones_seguidas = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_listado_mis_publicaciones_seguidas);
            if ($com_mp_mi_publicacionseguida->rut == $rut) {
                $total_listado_mis_publicaciones_seguidas = str_replace("{EDITAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_editar_mp.html"), $total_listado_mis_publicaciones_seguidas);
                $total_listado_mis_publicaciones_seguidas = str_replace("{ELIMINAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_borrar_mp.html"), $total_listado_mis_publicaciones_seguidas);
            } else {
                $total_listado_mis_publicaciones_seguidas = str_replace("{EDITAR_MP}", "", $total_listado_mis_publicaciones_seguidas);
                $total_listado_mis_publicaciones_seguidas = str_replace("{ELIMINAR_MP}", "", $total_listado_mis_publicaciones_seguidas);
            }
            $tiene_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $com_mp_mi_publicacionseguida->id_mp, "MEGUSTA", $rut);
            if ($tiene_megusta) {
                $total_listado_mis_publicaciones_seguidas = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta.html"), $total_listado_mis_publicaciones_seguidas);
            } else {
                $total_listado_mis_publicaciones_seguidas = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta.html"), $total_listado_mis_publicaciones_seguidas);
            }
            $tiene_no_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $com_mp_mi_publicacionseguida->id_mp, "NOMEGUSTA", $rut);
            if ($tiene_no_megusta) {
                $total_listado_mis_publicaciones_seguidas = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_nomegusta.html"), $total_listado_mis_publicaciones_seguidas);
            } else {
                $total_listado_mis_publicaciones_seguidas = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_nomegusta.html"), $total_listado_mis_publicaciones_seguidas);
            }
            $total_listado_mis_publicaciones_seguidas = ColocaCantidadDeMegusta($total_listado_mis_publicaciones_seguidas, $com_mp_mi_publicacionseguida->id_mp, $id_empresa);
            $tiene_favorito                           = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $com_mp_mi_publicacionseguida->id_mp, "FAVORITA", $rut);
            if ($tiene_favorito) {
                $total_listado_mis_publicaciones_seguidas = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_favorito.html"), $total_listado_mis_publicaciones_seguidas);
            } else {
                $total_listado_mis_publicaciones_seguidas = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_favorito.html"), $total_listado_mis_publicaciones_seguidas);
            }
            $post_categoria                           = '<a href="?sw=com_mp_personal&amb=mp_cat&idcat=' . $com_mp_mi_publicacionseguida->id_categoria . '&cat=' . $com_mp_mi_publicacionseguida->categoria . '"><span class="badge_small badge-azul"><span class="blanco"><i class="icon-people icons"></i> ' . $com_mp_mi_publicacionseguida->categoria . '</span></span></a>';
            $total_listado_mis_publicaciones_seguidas = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_listado_mis_publicaciones_seguidas);
            $total_listado_mis_publicaciones_seguidas = ColocaCantidadDeFavorito($total_listado_mis_publicaciones_seguidas, $com_mp_mi_publicacionseguida->id_mp, $id_empresa);
            $total_listado_mis_publicaciones_seguidas = str_replace("{ID_MP}", $com_mp_mi_publicacionseguida->id_mp, $total_listado_mis_publicaciones_seguidas);
            $total_listado_mis_publicaciones_seguidas = str_replace("{ID_MP_ENCODEADO}", Encodear3($com_mp_mi_publicacionseguida->id_mp), $total_listado_mis_publicaciones_seguidas);
            $total_listado_mis_publicaciones_seguidas = str_replace("{TIPO}", "A", $total_listado_mis_publicaciones_seguidas);
            $total_listado_mis_publicaciones_seguidas = str_replace("{LINK}", $link_MP, $total_listado_mis_publicaciones_seguidas);
            $total_listado_mis_publicaciones_seguidas = str_replace("{CATEGORIA_MP}", $post_categoria, $total_listado_mis_publicaciones_seguidas);
            $post_ambito                              = '<a href="?sw=com_mp_personal&amb=mp_amb&idamb=' . $com_mp_mi_publicacionseguida->id_ambito . '&ambito=' . $com_mp_mi_publicacionseguida->ambito . '">
<span class="badge_small badge-azul"><span class="blanco"><i class="icon-people icons"></i> ' . $com_mp_mi_publicacionseguida->ambito . '</span></span></a>';
            $total_listado_mis_publicaciones_seguidas = str_replace("{AMBITO_MP}", $post_ambito, $total_listado_mis_publicaciones_seguidas);
            $total_listado_mis_publicaciones_seguidas = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($com_mp_mi_publicacionseguida->descripcion_categoria), $total_listado_mis_publicaciones_seguidas);
            $total_listado_mis_publicaciones_seguidas = str_replace("{NOMBRE}", ($com_mp_mi_publicacionseguida->nombre), $total_listado_mis_publicaciones_seguidas);
            if ($com_mp_mi_publicacionseguida->contenido == "") {
                $resumen = ($com_mp_mi_publicacionseguida->resumen);
            } else {
                $resumen = limit_text($com_mp_mi_publicacionseguida->contenido, 35);
            }
            $total_listado_mis_publicaciones_seguidas = str_replace("{CONTENIDO}", $resumen, $total_listado_mis_publicaciones_seguidas);
            $total_listado_mis_publicaciones_seguidas = str_replace("{FECHA}", formatearFechaSmall($com_mp_mi_publicacionseguida->fecha), $total_listado_mis_publicaciones_seguidas);
            $total_listado_mis_publicaciones_seguidas = str_replace("{ESTADO}", ($com_mp_mi_publicacionseguida->estado), $total_listado_mis_publicaciones_seguidas);
            $total_listado_mis_publicaciones_seguidas = str_replace("{DESCRIPCION_ESTADO}", ($com_mp_mi_publicacionseguida->descripcion_estado), $total_listado_mis_publicaciones_seguidas);
            $total_listado_mis_publicaciones_seguidas = str_replace("{RUT_AUTOR}", ($com_mp_mi_publicacionseguida->rut), $total_listado_mis_publicaciones_seguidas);
            $total_listado_mis_publicaciones_seguidas = str_replace("{RUT}", ($rut), $total_listado_mis_publicaciones_seguidas);
            $total_listado_mis_publicaciones_seguidas = str_replace("{NOMBRE_AUTOR}", ($com_mp_mi_publicacionseguida->nombre_autor), $total_listado_mis_publicaciones_seguidas);
            $total_listado_mis_publicaciones_seguidas = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($com_mp_mi_publicacionseguida->rut), $total_listado_mis_publicaciones_seguidas);
            $total_listado_mis_publicaciones_seguidas = str_replace("{NUMVISITAS}", round($com_mp_mi_publicacionseguida->numvisitas), $total_listado_mis_publicaciones_seguidas);
            $total_listado_mis_publicaciones_seguidas = str_replace("{NUMMEGUSTA}", ($com_mp_mi_publicacionseguida->nummegusta), $total_listado_mis_publicaciones_seguidas);
            $total_listado_mis_publicaciones_seguidas = str_replace("{NUMCOMPARTIDA}", ($com_mp_mi_publicacionseguida->numcompartido), $total_listado_mis_publicaciones_seguidas);
            $total_listado_mis_publicaciones_seguidas = str_replace("{NUMCOMENTARIO}", ($com_mp_mi_publicacionseguida->numcomentarios), $total_listado_mis_publicaciones_seguidas);
            $total_listado_mis_publicaciones_seguidas = str_replace("{NUMCOMENTARIOSREALES}", ($com_mp_mi_publicacionseguida->numcomentariosreales), $total_listado_mis_publicaciones_seguidas);
            $total_listado_mis_publicaciones_seguidas = str_replace("{NUMFAVORITA}", ($com_mp_mi_publicacionseguida->numfavorita), $total_listado_mis_publicaciones_seguidas);
            $total_listado_mis_publicaciones_seguidas = str_replace("{ESTILOESTADO}", ($com_mp_mi_publicacionseguida->estilo), $total_listado_mis_publicaciones_seguidas);
            $total_listado_mis_publicaciones_seguidas = str_replace("{ICONOESTADO}", ($com_mp_mi_publicacionseguida->icono_estado), $total_listado_mis_publicaciones_seguidas);
            $total_listado_mis_publicaciones_seguidas = str_replace("{ESTILOCATEGORIA}", ($com_mp_mi_publicacionseguida->style), $total_listado_mis_publicaciones_seguidas);
            $total_listado_mis_publicaciones_seguidas = str_replace("{ICONOCATEGORIA}", ($com_mp_mi_publicacionseguida->icono), $total_listado_mis_publicaciones_seguidas);
            $total_listado_mis_publicaciones_seguidas = str_replace("{CATEGORIA_MP}", ($com_mp_mi_publicacionseguida->categoria), $total_listado_mis_publicaciones_seguidas);
            if ($com_mp_mi_publicacionseguida->tipo_multimedia == "imagen" and $com_mp_mi_publicacionseguida->imagen_fondo <> '') {
                $imagen = "../../front/multimedia/" . $com_mp_mi_publicacionseguida->multimedia;
            } else {
                $imagen = "";
            }
            if ($com_mp_mi_publicacionseguida->tipo_multimedia == "video") {
                $video = "../../front/multimedia/" . $com_mp_mi_publicacionseguida->multimedia;
            } else {
                $video = "";
            }
            $total_listado_mis_publicaciones_seguidas = str_replace("{IMAGEN_POST}", "multimedia/" . $com_mp_mi_publicacionseguida->imagenfondo, $total_listado_mis_publicaciones_seguidas);
            $total_listado_mis_publicaciones_seguidas = str_replace("{VIDEO}", ($video), $total_listado_mis_publicaciones_seguidas);
            $total_listado_mis_publicaciones_seguidas = str_replace("{TIPOMULTIMEDIA}", ($com_mp_mi_publicacionseguida->tipo_multimedia), $total_listado_mis_publicaciones_seguidas);
            $listado_comentarios                      = MuestraComentariosPorPost($com_mp_mi_publicacionseguida->id_mp);
            $total_listado_mis_publicaciones_seguidas = str_replace("{BLOQUE_COMENTARIOS}", $listado_comentarios, $total_listado_mis_publicaciones_seguidas);
            if ($com_mp_mi_publicacionseguida->url_documento) {
                $total_listado_mis_publicaciones_seguidas = str_replace("{BLOQUE_URL_DOCUMENTO}", file_get_contents("views/comunidad_mp/row_com_mp_url_documento.html"), $total_listado_mis_publicaciones_seguidas);
                $total_listado_mis_publicaciones_seguidas = str_replace("{URL_DOCUMENTO}", ($com_mp_mi_publicacionseguida->url_documento), $total_listado_mis_publicaciones_seguidas);
            } else {
                $total_listado_mis_publicaciones_seguidas = str_replace("{BLOQUE_URL_DOCUMENTO}", "", $total_listado_mis_publicaciones_seguidas);
            }


            //echo "HOLA $com_mp_mi_publicacionseguida->video";

            if ($com_mp_mi_publicacionseguida->video) {
                $video_youtube                            = ColocaVideoYoutube($com_mp_mi_publicacionseguida->video, $com_mp_mi_publicacionseguida->id_mp);
                $total_listado_mis_publicaciones_seguidas = str_replace("{VIDEO_IMAGEN}", $video_youtube, $total_listado_mis_publicaciones_seguidas);
            } else {
                $bloque_imagen_fondo                      = ColocaImagenPost($com_mp_mi_publicacionseguida->imagenfondo);
                $total_listado_mis_publicaciones_seguidas = str_replace("{VIDEO_IMAGEN}", $bloque_imagen_fondo, $total_listado_mis_publicaciones_seguidas);
            }
            $TagsPorPosts = TagsPorMPEmpresa($com_mp_mi_publicacionseguida->id_mp, $id_empresa);
            $tag_por_post = "";
            foreach ($TagsPorPosts as $TagsPorPost) {
                $tag_por_post .= '<a href="?sw=com_mp_personal&amb=mp_tag&tag=' . $TagsPorPost->tag . '"><span class="badge_small badge-white"><span class="negro">#' . $TagsPorPost->tag . '</span></span></a> ';
            }
            $total_listado_mis_publicaciones_seguidas = str_replace("{TAGS_POR_POST}", ($tag_por_post), $total_listado_mis_publicaciones_seguidas);
        }
        $perfil_personal = str_replace("{MIS_PUBLICACIONES_SEGUIDAS_MIPERFIL}", ($total_listado_mis_publicaciones_seguidas), $perfil_personal);
        $perfil_personal = str_replace("{MP_VISUALIZA_MEJORAMIENTO}", ($vista_mejoramiento), $perfil_personal);
    } else {
        $perfil_personal = "";
    }


    /*$
    $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>VP : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/

    //TITULO RESULTADOS
    if ($idamb <> '') {
        $nombre_ambito = nombre_ambitoMP($idamb, $id_empresa);
    }
    $titulo_R_resultados = "";
    $titulo_E_resultados = "";
    if ($vp == "" and $ambiente <> "") {
        if ($ambiente == 'mp_resultados') {
            $tituloR = "Resultados de B?squeda";
        }
        if ($ambiente == 'mp_rec') {
            $tituloR = "Recientes";
        }
        if ($ambiente == 'mp_interes') {
            $tituloR = "Publicaciones de Inter?s";
        }
        if ($ambiente == 'mp_populares') {
            $tituloR = "Publicaciones Populares";
        }
        if ($ambiente == 'mp_tag') {
            $tituloR = "Tag: <strong>$tag</strong>";
        }
        if ($ambiente == 'mp_cat') {
            $tituloR = "Grupo de Inter?s: <strong>$tag</strong>";
        }
        if ($ambiente == 'mp_amb') {
            $tituloR = "Temas: <strong>" . utf8_encode($nombre_ambito[0]->ambito) . "</strong>";
        }
        if ($ambiente == 'mp_rec') {
            $tituloR = "Recientes";
        }
        if ($ambiente == 'mp_mp') {
            $tituloR = "Mis Publicaciones";
        }
        if ($ambiente == 'mp_mf') {
            $tituloR = "Publicaciones Guardadas";
        }
        if ($ambiente == 'mp_cc') {
            $tituloR = "Compartidas conmigo";
        }
        if ($ambiente == 'mp_tipo') {
            $tituloR = "Tipo de Publicaci?n: <strong>$tag</strong>";
        }
        $titulo_R_resultados .= file_get_contents("views/comunidad_mp/row_com_mp_persona_titulo_tipoR.html");
        $titulo_R_resultados = str_replace("{TITULO_R}", $tituloR, $titulo_R_resultados);
        $titulo_E_resultados .= file_get_contents("views/comunidad_mp/row_com_mp_persona_titulo_tipoE.html");
        $titulo_E_resultados = str_replace("{TITULO_E}", $tituloR, $titulo_E_resultados);
    }
    if ($tipo_query <> '') {
        $tituloR = "Resultados de B?squeda: <strong>$tipo_query</strong>";
        $titulo_R_resultados .= file_get_contents("views/comunidad_mp/row_com_mp_persona_titulo_tipoR.html");
        $titulo_R_resultados = str_replace("{TITULO_R}", $tituloR, $titulo_R_resultados);
    }
    //COMUNIDAD AMBIENTE INICIAL PRINCIPAL
    //echo "ambiente $ambiente";
    $com_limit = "20";
    $com_start = "0";


    /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>VR : $time_elapsed<br><br>"; */



    if ($ambiente == "" or $ambiente == "mp_cat" or $ambiente == "mp_amb" or $ambiente == "mp_tag" or $ambiente == "mp_mp" or $ambiente == "mp_mf" or $ambiente == "mp_cc" or $ambiente == "mp_tipo") {
        $todas                        = com_mp_lista_personal($id_empresa, $Rut_Perfil, $ord_by, $filt_by, $filt_cat, $vp, $arreglo_tag, utf8_decode($tag), $rut_enviado, $ambiente, $com_limit, $com_start, $start_limit, $subcategoria, $idamb);


        //print_r($todas);
        $total_listado_post_recientes = "";

        /*$start = round(microtime(true) * 1000);    */

        foreach ($todas as $unico) {


        $start = round(microtime(true) * 1000);

        $Usuario=TraeDatosBiografiayUsuario($unico->rut, $id_empresa);


            if ($_GET["sw"] == "com_mp_home") {
                $total_listado_post_recientes .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_persona_listado_tipoA1R_home.html");
            } else {
                $total_listado_post_recientes .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_persona_listado_tipoA1R.html");
            }
            //print_r($unico);
            //echo "views/comunidad_mp/".$template.$id_empresa."_row_com_mp_persona_listado_tipoA1R.html";
            if ($unico->rut_mentor <> '') {
                $nombre_mentor = UsuarioEnBasePersonaPorEmpresa($unico->rut_mentor, $id_empresa);
                $mentor        = "<a href='?sw=com_mp_personal&rut_enviado=" . $nombre_mentor[0]->rut . "&vp=1'><div class='badge_small badge-verde blanco mgtop5'>    <i class='icon-check icons'></i> Respondido por " . $nombre_mentor[0]->nombre_completo . "</div></a>";
            } else {
                $mentor = "";
            }
            $total_listado_post_recientes = str_replace("{NOMBRE_MENTOR}", ($mentor), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_listado_post_recientes);
            //echo "<br>".$unico->rut."==".$rut;
            if ($unico->rut == $rut) {
                $total_listado_post_recientes = str_replace("{EDITAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_editar_mp.html"), $total_listado_post_recientes);
                $total_listado_post_recientes = str_replace("{ELIMINAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_borrar_mp.html"), $total_listado_post_recientes);
            } else {
                $total_listado_post_recientes = str_replace("{EDITAR_MP}", "", $total_listado_post_recientes);
                $total_listado_post_recientes = str_replace("{ELIMINAR_MP}", "", $total_listado_post_recientes);
            }

    /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>foreach 1 : $time_elapsed<br><br>";
    $start = round(microtime(true) * 1000);        */

            $tiene_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $unico->id_mp, "MEGUSTA", $rut);
            if ($tiene_megusta) {
                $total_listado_post_recientes = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta.html"), $total_listado_post_recientes);
            } else {
                $total_listado_post_recientes = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta.html"), $total_listado_post_recientes);
            }
            //$tiene_no_megusta=COMUNIDAD_TieneInteraccionPorRut($id_empresa, $unico->id_mp, "NOMEGUSTA", $rut);
            //if($tiene_no_megusta){
            //    $total_listado_post_recientes = str_replace("{BLOQUE_NOMEGUSTA_POST}",file_get_contents("views/comunidad_mp/".$template.$id_empresa."_bloque_ya_nomegusta.html"),$total_listado_post_recientes);
            //}else{
            //    $total_listado_post_recientes = str_replace("{BLOQUE_NOMEGUSTA_POST}",file_get_contents("views/comunidad_mp/".$template.$id_empresa."_bloque_nomegusta.html"),$total_listado_post_recientes);
            //    }
            ///$total_listado_post_recientes =ColocaCantidadDeMegusta($total_listado_post_recientes , $unico->id_mp, $id_empresa);
            ///$tiene_favorito=COMUNIDAD_TieneInteraccionPorRut($id_empresa, $unico->id_mp, "FAVORITA", $rut);
            //if($tiene_favorito){        $total_listado_post_recientes = str_replace("{BLOQUE_FAVORITO_POR_POST}",file_get_contents("views/comunidad_mp/".$template.$id_empresa."_bloque_ya_favorito.html"),$total_listado_post_recientes);
            //}else{        $total_listado_post_recientes = str_replace("{BLOQUE_FAVORITO_POR_POST}",file_get_contents("views/comunidad_mp/".$template.$id_empresa."_bloque_favorito.html"),$total_listado_post_recientes);
            //}


             /* $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>foreach 2 : $time_elapsed<br><br>";
    $start = round(microtime(true) * 1000);    */


         $post_categoria               = '<a href="?sw=com_mp_personal&amb=mp_cat&idcat=' . $unico->id_categoria . '&cat=' . $unico->categoria . '"><span class="badge_small badge-azul"><span class="blanco"><i class="icon-people icons"></i> ' . $unico->categoria . '</span></span></a>';
            $total_listado_post_recientes = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_listado_post_recientes);
            //$total_listado_post_recientes =ColocaCantidadDeFavorito($total_listado_post_recientes, $unico->id_mp, $id_empresa);
            $total_listado_post_recientes = str_replace("{ID_MP}", $unico->id_mp, $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{ID_MP_ENCODEADO}", Encodear3($unico->id_mp), $total_listado_post_recientes);
            if ($id_empresa == '62') {
                $url_mp_comparte = "https://www.compartebci.cl/front/?sw=login_ext%26ambiente=com_mp_full%26id_mp=" . $unico->id_mp . "";
            }
            $total_listado_post_recientes = str_replace("{URL_MP_COMPARTE}", ($url_mp_comparte), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{TIPO}", "A", $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{LINK}", $link_MP, $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{CATEGORIA_MP}", $post_categoria, $total_listado_post_recientes);
            $post_ambito                  = '<a href="?sw=com_mp_personal&amb=mp_amb&idamb=' . $unico->id_ambito . '&ambito=' . $unico->ambito . '">
<span class="badge_small badge-azul"><span class="blanco"><i class="icon-people icons"></i> ' . $unico->ambito . '</span></span></a>';
            $total_listado_post_recientes = str_replace("{AMBITO_MP}", $post_ambito, $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($unico->descripcion_categoria), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{NOMBRE}", ($unico->nombre), $total_listado_post_recientes);

          /*    $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>foreach 3 : $time_elapsed<br><br>";
    $start = round(microtime(true) * 1000);    */

          if ($unico->resumen == "" and $unico->contenido == "") {
                $resumen = ($unico->resumen);
            } elseif ($unico->resumen <> "" and $unico->contenido == "") {
                $resumen = ($unico->resumen);
            } elseif ($unico->resumen == "" and $unico->contenido <> "") {
                $resumen = limit_text($unico->contenido, 35);
            } elseif ($unico->resumen <> "" and $unico->contenido <> "") {
                $resumen = ($unico->resumen);
            } else {
                $resumen = "";
            }
            if ($unico->tipo == "MejorPractica") {
                $ico = "img/bci_mp_practica_icon.png";
            }
            if ($unico->tipo == "Papers") {
                $ico = "img/bci_mp_paper_icon.png";
            }
            if ($unico->tipo == "Publicacion") {
                $ico = "img/bci_mp_publicacion.png";
            }
            if ($unico->tipo == "Video" or $unico->tipo == "VideoInterno") {
                $ico = "img/bci_mp_practica_video.png";
            }
            if ($unico->tipo == "Links" or $unico->tipo == "LinkExterno") {
                $ico = "img/bci_mp_link_icon.png";
            }
            if ($unico->tipo == "Experiencias") {
                $ico = "img/bci_mp_experiencias_icon.png";
            }
            if ($unico->tipo == "Experto") {
                $ico = "img/bci_mp_experto_icon.png";
            }
            if ($unico->tipo == "OportunidadMejora") {
                $ico = "img/bci_mp_oportunidadmejora_icon.png";
            }
            if ($unico->tipo == "Udnolohaga") {
                $ico = "img/bci_mp_udnolohaga_icon.png";
            }
            if ($unico->tipo == "RRPP") {
                $ico = "img/bci_mp_rrpp_icon.png";
            }
            if ($unico->tipo == "Pregunta") {
                $ico = "img/bci_mp_pregunta_icon.png";
            }
            if ($unico->tipo == "Respuesta") {
                $ico = "img/bci_mp_pregunta_icon.png";
            }

        /*       $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>foreach 4 : $time_elapsed<br><br>";
    $start = round(microtime(true) * 1000);    */

           $total_listado_post_recientes = str_replace("{ICONO}", $ico, $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{DESC_ICONO}", $unico->tipo, $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{CONTENIDO}", $resumen, $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{FECHA}", formatearFechaSmall($unico->fecha), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{ESTADO}", ($unico->estado), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{DESCRIPCION_ESTADO}", ($unico->descripcion_estado), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{RUT_AUTOR}", ($unico->rut), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{RUT}", ($rut), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{NOMBRE_AUTOR}", ($Usuario[0]->nombre_completo), $total_listado_post_recientes);


    /* $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>foreach 5 : $time_elapsed<br><br>";
    $start = round(microtime(true) * 1000);    */


            $nombre_arroba=rutemailaarroba($unico->rut, $id_empresa);
            $total_listado_post_recientes = str_replace("{NOMBRE_AUTOR_ARROBA}", ($nombre_arroba), $total_listado_post_recientes);
           $total_listado_post_recientes = str_replace("{RUT_ENVIADO}", ($unico->rut), $total_listado_post_recientes);

    /*        $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>foreach 6 : $time_elapsed<br><br>";
    $start = round(microtime(true) * 1000);    */

            $total_listado_post_recientes = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($unico->rut), $total_listado_post_recientes);

            $total_listado_post_recientes = str_replace("{NUMVISITAS}", round($unico->numvisitas), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{NUMMEGUSTA}", ($unico->nummegusta), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{NUMNOMEGUSTA}", ($unico->numnomegusta), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{NUMCOMPARTIDA}", ($unico->numcompartido), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{NUMCOMENTARIO}", ($unico->numcomentarios), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{NUMCOMENTARIOSREALES}", ($unico->numcomentariosreales), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{NUMFAVORITA}", ($unico->numfavorita), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{ESTILOESTADO}", ($unico->estilo), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{ICONOESTADO}", ($unico->icono_estado), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{ESTILOCATEGORIA}", ($unico->style), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{ICONOCATEGORIA}", ($unico->icono), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{CATEGORIA_MP}", ($unico->categoria), $total_listado_post_recientes);

            if ($unico->tipo_multimedia == "imagen" and $unico->imagen_fondo <> '') {
                $imagen = "../../front/multimedia/" . $unico->multimedia;
            } else {
                $imagen = "";
            }
            if ($unico->tipo_multimedia == "video") {
                $video = "../../front/multimedia/" . $unico->multimedia;
            } else {
                $video = "";
            }

    /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>foreach 7 : $time_elapsed<br><br>";
    $start = round(microtime(true) * 1000);    */
            //echo "video $video";
            //echo $unico->video;

            $total_listado_post_recientes = str_replace("{IMAGEN_POST}", "multimedia/" . $unico->imagenfondo, $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{VIDEO}", ($video), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{TIPOMULTIMEDIA}", ($unico->tipo_multimedia), $total_listado_post_recientes);
            ///$listado_comentarios=MuestraComentariosPorPost($unico->id_mp);
            $total_listado_post_recientes = str_replace("{BLOQUE_COMENTARIOS}", $listado_comentarios, $total_listado_post_recientes);
           if ($unico->url_documento<>'' and $unico->url_documento<>'{LINK_DOCUMENTO}') {
                $total_listado_post_recientes = str_replace("{BLOQUE_URL_DOCUMENTO}", file_get_contents("views/comunidad_mp/row_com_mp_url_documento.html"), $total_listado_post_recientes);
                $total_listado_post_recientes = str_replace("{URL_DOCUMENTO}", ($unico->url_documento), $total_listado_post_recientes);
            } else {
                $total_listado_post_recientes = str_replace("{BLOQUE_URL_DOCUMENTO}", "", $total_listado_post_recientes);
            }
            if ($unico->video<>'' and $unico->video<>'{LINK_YOUTUBE}') {
                $video_youtube                = ColocaVideoYoutube($unico->video, $unico->id_mp);
                $total_listado_post_recientes = str_replace("{VIDEO_IMAGEN}", $video_youtube, $total_listado_post_recientes);
            } else {

$bloque_imagen_fondo          = ColocaImagenPost($unico->imagenfondo);
                $total_listado_post_recientes = str_replace("{VIDEO_IMAGEN}", $bloque_imagen_fondo, $total_listado_post_recientes);
            }
            //tags por post
            $TagsPorPosts = TagsPorMPEmpresa($unico->id_mp, $id_empresa);
            $tag_por_post = "";
            foreach ($TagsPorPosts as $TagsPorPost) {
                $tag_por_post .= '<a href="?sw=com_mp_personal&amb=mp_tag&tag=' . $TagsPorPost->tag . '"><span class="badge_small badge-white"><span class="negro">#' . $TagsPorPost->tag . '</span></span></a> ';
            }
            $total_listado_post_recientes = str_replace("{TAGS_POR_POST}", ($tag_por_post), $total_listado_post_recientes);
        }

    /*
    $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>foreach 8 : $time_elapsed<br><br>";
    $start = round(microtime(true) * 1000);    */




    }
    //echo "<br><br><br><br><br><br><br><br>ambiente $ambiente $tipo_query";//TIMELINE BUSCADOR INTELIGENTE



/*
    $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Ambiente : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/


 if ($tipo_query <> '') {
        $todas                                  = com_mp_resultados_inteligentes($id_empresa, $tipo_query, "", $ambiente, $subcategoria);
        $total_listado_post_personas_resultados = "";
        foreach ($todas as $unico) {
            $tpi++;
            //  echo  "<br><br><br><br>";print_r($unico);
            //    echo "<br>3475 tipopost ".$unico->tipopost." tipo ".$unico->tipo;
            //    echo "<br>".$unico->id_estado;
            //echo "subc $subcategoria, id_subcategoria ".$unico->id_subcategoria;
            if ($subcategoria <> '' and $subcategoria <> $unico->id_subcategoria) {
                // continue;
            }
            if ($subcategoria == '' and $unico->id_subcategoria <> '' and $unico->impacto <> 'PUBLICO') {
                continue;
            }
            if (in_array($unico->codigo, $guardo_codigo)) {
                continue;
            }
            $guardo_codigo[$tpi] = $unico->codigo;
            $post_categoria      = '<a href="?sw=com_mp_personal&amb=mp_cat&idcat=' . $unico->id_categoria . '&cat=' . $unico->categoria_mp . '"><span class="badge_small badge-azul"><span class="blanco"><i class="icon-people icons"></i> ' . $unico->categoria_mp . '</span></span></a>';
            if ($unico->tipoVista <> 'expertos' and $unico->tipoVista <> 'vistaexperto' and $unico->tipoVista <> 'Links' and $unico->id_estado >= 5) {
                $total_listado_post_personas_resultados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_persona_listado_tipoA1R.html");
                $total_listado_post_personas_resultados = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_listado_post_personas_resultados);
            }
            // vista personas en comunidad
            elseif ($unico->tipoVista == 'expertos') {
                $total_listado_post_personas_resultados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_persona_listado_tipoE.html");
                $total_listado_post_personas_resultados = str_replace("{HUINCHA_INTERACCIONES}", "", $total_listado_post_personas_resultados);
                $datos_interaccion_personal             = TraeBuscaInteraccionPersonal($unico->codigo, $id_empresa);
                $array_Reco_Gracias                     = BuscaDatosReconocimientoAgradecimientos($unico->codigo, $id_empresa);
                if ($array_Reco_Gracias[0]->num_gracias > 0) {
                    $num_gracias = $array_Reco_Gracias[0]->num_gracias;
                } else {
                    $num_gracias = 0;
                }
                if ($array_Reco_Gracias[0]->num_reconocimientos > 0) {
                    $num_reconocimientos = $array_Reco_Gracias[0]->num_reconocimientos;
                } else {
                    $num_reconocimientos = 0;
                }
                $total_listado_post_personas_resultados = str_replace("{NUM_RECONOCIMIENTOS}", $num_reconocimientos, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_GRACIAS}", $num_gracias, $total_listado_post_personas_resultados);
                if ($datos_interaccion_personal[0]->numbcicoins == "") {
                    $num_coins = 0;
                } else {
                    $num_coins = $datos_interaccion_personal[0]->numbcicoins;
                }
                if ($datos_interaccion_personal[0]->numaptitudesvalidadas == "") {
                    $num_aptitudes = 0;
                } else {
                    $num_aptitudes = $datos_interaccion_personal[0]->numaptitudesvalidadas;
                }
                if ($datos_interaccion_personal[0]->numpublicaciones == "") {
                    $num_publicaciones = 0;
                } else {
                    $num_publicaciones = $datos_interaccion_personal[0]->numpublicaciones;
                }
                if ($datos_interaccion_personal[0]->numseguidores == "") {
                    $num_seguidores = 0;
                } else {
                    $num_seguidores = $datos_interaccion_personal[0]->numseguidores;
                }
                $total_listado_post_personas_resultados = str_replace("{NUM_BCICOINS}", $num_coins, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_SEGUIDORES}", $num_seguidores, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_SEGUIDOS}", $datos_interaccion_personal[0]->numseguidos, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_PUBLICACIONES}", $num_publicaciones, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_MEGUSTA_FAVORITAS}", $datos_interaccion_personal[0]->nummegustafavorita, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_VISITAS}", $datos_interaccion_personal[0]->numvisitas, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_COMENTARIOS}", $datos_interaccion_personal[0]->numcomentarios, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_APTITUDESVALIDADAS}", $num_aptitudes, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_PUBLICACIONESSEGUIDAS}", $datos_interaccion_personal[0]->publicacionesseguidas, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_INTERACCIONES}", $datos_interaccion_personal[0]->numinteracciones, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{RUTEXPERTO}", $unico->codigo, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{CARGO_EXPERTO}", $unico->cargo_experto, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NOMBRE_EXPERTO}", $unico->nombre_experto, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($unico->codigo), $total_listado_post_personas_resultados);
            } elseif ($unico->tipoVista == 'vistaexperto') {
                $total_listado_post_personas_resultados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_persona_listado_tipoEX.html");
                $total_listado_post_personas_resultados = str_replace("{HUINCHA_INTERACCIONES}", "", $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NOMBRE_EXPERTO}", $unico->nombre_experto, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{GRUPOINTERES}", $unico->categoria_mp, $total_listado_post_personas_resultados);
                $datos_interaccion_personal             = TraeBuscaInteraccionPersonal($unico->codigo, $id_empresa);
                if ($datos_interaccion_personal[0]->numbcicoins == "") {
                    $num_coins = 0;
                } else {
                    $num_coins = $datos_interaccion_personal[0]->numbcicoins;
                }
                if ($datos_interaccion_personal[0]->numaptitudesvalidadas == "") {
                    $num_aptitudes = 0;
                } else {
                    $num_aptitudes = $datos_interaccion_personal[0]->numaptitudesvalidadas;
                }
                if ($datos_interaccion_personal[0]->numpublicaciones == "") {
                    $num_publicaciones = 0;
                } else {
                    $num_publicaciones = $datos_interaccion_personal[0]->numpublicaciones;
                }
                if ($datos_interaccion_personal[0]->numseguidores == "") {
                    $num_seguidores = 0;
                } else {
                    $num_seguidores = $datos_interaccion_personal[0]->numseguidores;
                }
                $total_listado_post_personas_resultados = str_replace("{NUM_BCICOINS}", $num_coins, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_SEGUIDORES}", $num_seguidores, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_SEGUIDOS}", $datos_interaccion_personal[0]->numseguidos, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_PUBLICACIONES}", $num_publicaciones, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_MEGUSTA_FAVORITAS}", $datos_interaccion_personal[0]->nummegustafavorita, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_VISITAS}", $datos_interaccion_personal[0]->numvisitas, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_COMENTARIOS}", $datos_interaccion_personal[0]->numcomentarios, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_APTITUDESVALIDADAS}", $num_aptitudes, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_PUBLICACIONESSEGUIDAS}", $datos_interaccion_personal[0]->publicacionesseguidas, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{NUM_INTERACCIONES}", $datos_interaccion_personal[0]->numinteracciones, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{RUTEXPERTO}", $unico->codigo, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{CARGO_EXPERTO}", $unico->cargo_experto, $total_listado_post_personas_resultados);
            } elseif ($unico->tipoVista == 'Links' and $unico->id_estado >= 5) {
                $total_listado_post_personas_resultados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_persona_listado_tipoL.html");
                $total_listado_post_personas_resultados = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{LINK_IDMP}", $unico->url_documento, $total_listado_post_personas_resultados);
            } else {
            }
            if ($unico->rut == $rut) {
                $total_listado_post_personas_resultados = str_replace("{EDITAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_editar_mp.html"), $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{ELIMINAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_borrar_mp.html"), $total_listado_post_personas_resultados);
            } else {
                $total_listado_post_personas_resultados = str_replace("{EDITAR_MP}", "", $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{ELIMINAR_MP}", "", $total_listado_post_personas_resultados);
            }
            //echo "<br>hola post tipo".$unico->tipo;
            if ($unico->tipo == "MejorPractica") {
                $ico = "img/bci_mp_practica_icon.png";
            }
            if ($unico->tipo == "Papers") {
                $ico = "img/bci_mp_paper_icon.png";
            }
            if ($unico->tipo == "Publicacion") {
                $ico = "img/bci_mp_publicacion.png";
            }
            if ($unico->tipo == "Video" or $unico->tipo == "VideoInterno") {
                $ico = "img/bci_mp_practica_video.png";
            }
            if ($unico->tipo == "Links" or $unico->tipo == "Linkexterno") {
                $ico = "img/bci_mp_link_icon.png";
            }
            if ($unico->tipo == "Experiencias") {
                $ico = "img/bci_mp_experiencias_icon.png";
            }
            if ($unico->tipopost == "expertos") {
                $ico = "img/bci_mp_experto_icon.png";
            }
            if ($unico->tipo == "OportunidadMejora") {
                $ico = "img/bci_mp_oportunidadmejora_icon.png";
            }
            if ($unico->tipo == "Udnolohaga") {
                $ico = "img/bci_mp_udnolohaga_icon.png";
            }
            if ($unico->tipo == "RRPP") {
                $ico = "img/bci_mp_rrpp_icon.png";
            }
            if ($unico->tipo == "Pregunta") {
                $ico = "img/bci_mp_pregunta_icon.png";
            }
            if ($unico->tipo == "Respuesta") {
                $ico = "img/bci_mp_pregunta_icon.png";
            }
            if ($unico->rut_mentor <> '') {
                $nombre_mentor = UsuarioEnBasePersonaPorEmpresa($unico->rut_mentor, $id_empresa);
                $mentor        = "<a href='?sw=com_mp_personal&rut_enviado=" . $nombre_mentor[0]->rut . "&vp=1'><div class='badge_small badge-verde blanco mgtop5'>    <i class='icon-check icons'></i> Respondido por " . $nombre_mentor[0]->nombre_completo . "</div></a>";
            } else {
                $mentor = "";
            }
            $total_listado_post_personas_resultados = str_replace("{NOMBRE_MENTOR}", ($mentor), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{ICONO}", $ico, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{DESC_ICONO}", $unico->tipo, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = ColocaCantidadDeFavorito($total_listado_post_personas_resultados, $unico->id_mp, $id_empresa);
            $total_listado_post_personas_resultados = str_replace("{ID_MP}", $unico->codigo, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{LINK}", $link_MP, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($unico->descripcion_categoria), $total_listado_post_personas_resultados);
            if ($unico->resumen == "" and $unico->contenido == "") {
                $resumen = ($unico->resumen);
            } elseif ($unico->resumen <> "" and $unico->contenido == "") {
                $resumen = ($unico->resumen);
            } elseif ($unico->resumen == "" and $unico->contenido <> "") {
                $resumen = limit_text($unico->contenido, 35);
            } elseif ($unico->resumen <> "" and $unico->contenido <> "") {
                $resumen = ($unico->resumen);
            } else {
                $resumen = "";
            }
            if ($unico->tipopost <> 'expertos') {
                $total_listado_post_personas_resultados = str_replace("{NOMBRE}", ($unico->nombre), $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{CATEGORIA_MP}", $post_categoria, $total_listado_post_personas_resultados);
                $post_ambito                            = '<a href="?sw=com_mp_personal&amb=mp_amb&idamb=' . $unico->id_ambito . '&ambito=' . $unico->ambito . '">
<span class="badge_small badge-azul"><span class="blanco"><i class="icon-people icons"></i> ' . $unico->ambito . '</span></span></a>';
                $total_listado_post_personas_resultados = str_replace("{AMBITO_MP}", $post_ambito, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{RUT_AUTOR}", ($unico->rut), $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($unico->rut), $total_listado_post_personas_resultados);
                $link                                   = "?sw=com_mp_full&id_mp=" . $unico->codigo . "";
            } else {
                $total_listado_post_personas_resultados = str_replace("{NOMBRE}", ("$resumen"), $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{CATEGORIA_MP}", $post_categoria, $total_listado_post_personas_resultados);
                $post_ambito                            = '<a href="?sw=com_mp_personal&amb=mp_amb&idamb=' . $unico->id_ambito . '&ambito=' . $unico->ambito . '">
<span class="badge_small badge-azul"><span class="blanco"><i class="icon-people icons"></i> ' . $unico->ambito . '</span></span></a>';
                $total_listado_post_personas_resultados = str_replace("{AMBITO_MP}", $post_ambito, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{RUT_AUTOR}", ($unico->contenido), $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($unico->codigo), $total_listado_post_personas_resultados);
                $link                                   = "?sw=com_mp_personal&rut_enviado=" . $unico->codigo . "&vp=1&mp=1";
            }
            $tiene_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $unico->codigo, "MEGUSTA", $rut);
            if ($tiene_megusta) {
                $total_listado_post_personas_resultados = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta.html"), $total_listado_post_personas_resultados);
            } else {
                $total_listado_post_personas_resultados = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta.html"), $total_listado_post_personas_resultados);
            }
            $total_listado_post_personas_resultados = ColocaCantidadDeMegusta($total_listado_post_personas_resultados, $unico->codigo, $id_empresa);
            //$total_listado_post_personas_resultados =ColocaCantidadDeNoMegusta($total_listado_post_personas_resultados , $unico->codigo, $id_empresa);
            $total_listado_post_personas_resultados = str_replace("{TIPO}", "A", $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{ID_MP}", ($unico->codigo), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{CONTENIDO}", $resumen, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{FECHA}", formatearFechaSmall($unico->fecha), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{ESTADO}", ($unico->estado), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{DESCRIPCION_ESTADO}", ($unico->descripcion_estado), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{RUT}", ($rut), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NOMBRE_AUTOR}", ($unico->nombre_autor), $total_listado_post_personas_resultados);
                        $nombre_arroba=rutemailaarroba($unico->rut, $id_empresa);
            $total_listado_post_personas_resultados = str_replace("{NOMBRE_AUTOR_ARROBA}", ($nombre_arroba), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{RUT_ENVIADO}", ($unico->rut), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUMVISITAS}", round($unico->numvisitas), $total_listado_post_personas_resultados);
            //$total_listado_post_personas_resultados = str_replace("{NUMMEGUSTA}",($unico->nummegusta),$total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUMNOMEGUSTA}", ($unico->numnomegusta), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUMCOMPARTIDA}", ($unico->numcompartido), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUMCOMENTARIO}", ($unico->numcomentarios), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUMCOMENTARIOSREALES}", ($unico->numcomentariosreales), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUMFAVORITA}", ($unico->numfavorita), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{ESTILOESTADO}", ($unico->estilo), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{ICONOESTADO}", ($unico->icono_estado), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{ESTILOCATEGORIA}", ($unico->style), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{ICONOCATEGORIA}", ($unico->icono), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{CATEGORIA_MP}", ($unico->categoria), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{LINK}", ($link), $total_listado_post_personas_resultados);
            if ($unico->tipo_multimedia == "imagen") {
                $imagen = "../../front/multimedia/" . $unico->multimedia;
            } else {
                $imagen = "";
            }
            if ($unico->tipo_multimedia == "video") {
                $video = "../../front/multimedia/" . $unico->multimedia;
            } else {
                $video = "";
            }
            $total_listado_post_personas_resultados = str_replace("{IMAGEN_POST}", "multimedia/" . $unico->imagenfondo, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{VIDEO}", ($video), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{TIPOMULTIMEDIA}", ($unico->tipo_multimedia), $total_listado_post_personas_resultados);
            $listado_comentarios                    = MuestraComentariosPorPost($unico->id_mp);
            $total_listado_post_personas_resultados = str_replace("{BLOQUE_COMENTARIOS}", $listado_comentarios, $total_listado_post_personas_resultados);
            if ($unico->url_documento) {
                $total_listado_post_personas_resultados = str_replace("{BLOQUE_URL_DOCUMENTO}", file_get_contents("views/comunidad_mp/row_com_mp_url_documento.html"), $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{URL_DOCUMENTO}", ($unico->url_documento), $total_listado_post_personas_resultados);
            } else {
                $total_listado_post_personas_resultados = str_replace("{BLOQUE_URL_DOCUMENTO}", "", $total_listado_post_personas_resultados);
            }
            //echo "<br> video".$unico->video." imagen".$unico->imagenfondo;
            if ($unico->video) {
                $video_youtube                          = ColocaVideoYoutube($unico->video, $unico->id_mp);
                $total_listado_post_personas_resultados = str_replace("{VIDEO_IMAGEN}", $video_youtube, $total_listado_post_personas_resultados);
            } elseif ($unico->imagenfondo) {
                $bloque_imagen_fondo                    = ColocaImagenPost($unico->imagenfondo);
                $total_listado_post_personas_resultados = str_replace("{VIDEO_IMAGEN}", $bloque_imagen_fondo, $total_listado_post_personas_resultados);
            } else {
                $total_listado_post_personas_resultados = str_replace("{VIDEO_IMAGEN}", "", $total_listado_post_personas_resultados);
            }
            $total_listado_post_personas_resultados = str_replace("{TITULO_R}", $tituloR, $total_listado_post_personas_resultados);
            //tags por post
            $TagsPorPosts                           = TagsPorMPEmpresa($unico->codigo, $id_empresa);
            $tag_por_post                           = "";
            foreach ($TagsPorPosts as $TagsPorPost) {
                $tag_por_post .= '<a href="?sw=com_mp_personal&amb=mp_tag&tag=' . $TagsPorPost->tag . '"><span class="badge_small badge-white"><span class="negro">#' . $TagsPorPost->tag . '</span></span></a> ';
            }
            $total_listado_post_personas_resultados = str_replace("{TAGS_POR_POST}", ($tag_por_post), $total_listado_post_personas_resultados);
        }
        // no encontraste resultados?
        $mp_hacerpregunta .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_hacer_pregunta.html");
        $mp_hacerpregunta = str_replace("{PREGUNTA}", $tipo_query, $mp_hacerpregunta);
    }

    /* $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>REsultados : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000); */

    $mas_grupo_interes1            = com_mp_post_rank_categorias($id_empresa, "1");
    $mas_post_rut_grupo_interes1   = com_mp_post_rank_mas_publicador_categoria($mas_grupo_interes1[0]->id_categoria, $id_empresa, $subcategoria);
    $mas_post_grupo_interes1       = com_mp_post_rank_rut_mas_publicador_categoria($mas_post_rut_grupo_interes1[0]->rut, $mas_grupo_interes1[0]->id_categoria, $id_empresa);
    $total_mas_post_grupo_interes1 = "";
    foreach ($mas_post_grupo_interes1 as $mas_post_g1) {
        $seguidores1 = $mas_post_g1->seguidores . " seguidores";
        $total_mas_post_grupo_interes1 .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_people_mini.html");
        $total_mas_post_grupo_interes1 = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($mas_post_g1->rut), $total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1 = str_replace("{ID_MP}", $mas_post_g1->id_mp, $total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1 = str_replace("{CATEGORIA_MP}", ($mas_post_g1->categoria), $total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1 = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($mas_post_g1->descripcion_categoria), $total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1 = str_replace("{NOMBRE}", ($mas_post_g1->nombre_autor), $total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1 = str_replace("{CONTENIDO}", limit_text($mas_post_g1->contenido, 35), $total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1 = str_replace("{SEGUIDORES}", $seguidores1, $total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1 = str_replace("{PUNTOS}", "", $total_mas_post_grupo_interes1);
        /*
        $total_mas_post_grupo_interes1= str_replace("{FECHA}",formatearFechaSmall($mas_post_g1->fecha),$total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1= str_replace("{ESTADO}",($mas_post_g1->estado),$total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1= str_replace("{DESCRIPCION_ESTADO}",($mas_post_g1->descripcion_estado),$total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1= str_replace("{RUT_AUTOR}",($mas_post_g1->rut),$total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1= str_replace("{RUT}",($rut),$total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1= str_replace("{NOMBRE_AUTOR}",($mas_post_g1->nombre_autor),$total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1= str_replace("{FOTO_AUTOR}",VerificaFotoPersonal($mas_post_g1->rut),$total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1= str_replace("{ESTILOESTADO}",($mas_post_g1->estilo),$total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1= str_replace("{ICONOESTADO}",($mas_post_g1->icono_estado),$total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1= str_replace("{ESTILOCATEGORIA}",($mas_post_g1->style),$total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1= str_replace("{ICONOCATEGORIA}",($mas_post_g1->icono),$total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1= str_replace("{CATEGORIA_MP}",($mas_post_g1->categoria),$total_mas_post_grupo_interes1);
        * */
        $total_mas_post_grupo_interes1 = str_replace("{NOMBRE}", ($mas_post_g1->nombre), $total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1 = str_replace("{RUT_ENVIADO}", ($mas_post_g1->rut), $total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1 = str_replace("{ID_MP}", ($mas_post_g1->id_mp), $total_mas_post_grupo_interes1);
        // BOTON SEGUIR
        $sesiguepersona                = count(VerificandompaSeguidores($rut, $mas_post_g1->rut, $id_empresa));
        if ($sesiguepersona > 0) {
            $boton_seguir = "
<center style='display: inline;'>
    <div class='badge_small badge-verde blanco mgtop5'>
        <i class='icon-check icons'></i> Siguiendo
    </div>
    <a href='?sw=com_mp_personal&rut_enviado=" . $mas_post_g1->rut . "&vp=1&sg=2' class='badge_small bg-white_borderBlue negro'> <i class='icon-user-following icons'></i> Dejar de seguir (-)</a>
</center>
";
        } else {
            $boton_seguir = "
<center style='display: inline;'>
    <a href='?sw=com_mp_personal&rut_enviado=" . $mas_post_g1->rut . "&vp=1&sg=1'
    class='badge_small bg-amarillos negro'> <i class='icon-user-following icons'></i> Seguir (+)</a>
</center>";
        }
        $total_mas_post_grupo_interes1 = str_replace("{BOTON_SEGUIR}", ($boton_seguir), $total_mas_post_grupo_interes1);
    }
    // mas publicadores grupo interes 2
    $mas_grupo_interes2          = com_mp_post_rank_categorias($id_empresa, "2");
    $mas_post_rut_grupo_interes2 = com_mp_post_rank_mas_publicador_categoria($mas_grupo_interes2[0]->id_categoria, $id_empresa, $subcategoria);
    $mas_post_grupo_interes2     = com_mp_post_rank_rut_mas_publicador_categoria($mas_post_rut_grupo_interes2[0]->rut, $mas_grupo_interes2[0]->id_categoria, $id_empresa);
    foreach ($mas_post_grupo_interes2 as $mas_post_g2) {
        $seguidores2 = $mas_post_g2->seguidores . " seguidores";
        $total_mas_post_grupo_interes2 .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_people_mini.html");
        $total_mas_post_grupo_interes2 = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($mas_post_g2->rut), $total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2 = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2 = str_replace("{ID_MP}", $mas_post_g2->id_mp, $total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2 = str_replace("{CATEGORIA_MP}", ($mas_post_g2->categoria), $total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2 = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($mas_post_g2->descripcion_categoria), $total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2 = str_replace("{NOMBRE}", ($mas_post_g2->nombre_autor), $total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2 = str_replace("{CONTENIDO}", limit_text($mas_post_g2->contenido, 35), $total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2 = str_replace("{SEGUIDORES}", $seguidores2, $total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2 = str_replace("{PUNTOS}", "", $total_mas_post_grupo_interes2);
        /*
        $total_mas_post_grupo_interes2= str_replace("{CONTENIDO}",limit_text($mas_post_g2->contenido,35),$total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2= str_replace("{FECHA}",formatearFechaSmall($mas_post_g2->fecha),$total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2= str_replace("{ESTADO}",($mas_post_g2->estado),$total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2= str_replace("{DESCRIPCION_ESTADO}",($mas_post_g2->descripcion_estado),$total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2= str_replace("{RUT_AUTOR}",($mas_post_g2->rut),$total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2= str_replace("{RUT}",($rut),$total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2= str_replace("{NOMBRE_AUTOR}",($mas_post_g2->nombre_autor),$total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2= str_replace("{FOTO_AUTOR}",VerificaFotoPersonal($mas_post_g2->rut),$total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2= str_replace("{ESTILOESTADO}",($mas_post_g2->estilo),$total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2= str_replace("{ICONOESTADO}",($mas_post_g2->icono_estado),$total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2= str_replace("{ESTILOCATEGORIA}",($mas_post_g2->style),$total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2= str_replace("{ICONOCATEGORIA}",($mas_post_g2->icono),$total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2= str_replace("{CATEGORIA_MP}",($mas_post_g2->categoria),$total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2= str_replace("{NOMBRE}",($mas_post_g2->nombre),$total_mas_post_grupo_interes2);
        */
        $total_mas_post_grupo_interes2 = str_replace("{RUT_ENVIADO}", ($mas_post_g2->rut), $total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2 = str_replace("{ID_MP}", ($mas_post_g2->id_mp), $total_mas_post_grupo_interes2);
        // BOTON SEGUIR
        $sesiguepersona                = count(VerificandompaSeguidores($rut, $mas_post_g2->rut, $id_empresa));
        if ($sesiguepersona > 0) {
            $boton_seguir = "
<center style='display: inline;'>
    <div class='badge_small badge-verde blanco mgtop5'>
        <i class='icon-check icons'></i> Siguiendo
    </div>
    <a href='?sw=com_mp_personal&rut_enviado=" . $mas_post_g2->rut . "&vp=1&sg=2' class='badge_small bg-white_borderBlue negro'> <i class='icon-user-following icons'></i> Dejar de seguir (-)</a>
</center>
";
        } else {
            $boton_seguir = "
<center style='display: inline;'>
    <a href='?sw=com_mp_personal&rut_enviado=" . $mas_post_g2->rut . "&vp=1&sg=1'
    class='badge_small bg-amarillos negro'> <i class='icon-user-following icons'></i> Seguir (+)</a>
</center>";
        }
        $total_mas_post_grupo_interes2 = str_replace("{BOTON_SEGUIR}", ($boton_seguir), $total_mas_post_grupo_interes2);
    }
    // mas publicadores grupo interes 3
    $mas_grupo_interes3          = com_mp_post_rank_categorias($id_empresa, "3");
    $mas_post_rut_grupo_interes3 = com_mp_post_rank_mas_publicador_categoria($mas_grupo_interes3[0]->id_categoria, $id_empresa, $subcategoria);
    $mas_post_grupo_interes3     = com_mp_post_rank_rut_mas_publicador_categoria($mas_post_rut_grupo_interes3[0]->rut, $mas_grupo_interes3[0]->id_categoria, $id_empresa);
    foreach ($mas_post_grupo_interes3 as $mas_post_g3) {
        $seguidores3 = $mas_post_g3->seguidores . " seguidores";
        $total_mas_post_grupo_interes3 .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_people_mini.html");
        $total_mas_post_grupo_interes3 = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($mas_post_g3->rut), $total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3 = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3 = str_replace("{ID_MP}", $mas_post_g3->id_mp, $total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3 = str_replace("{CATEGORIA_MP}", ($mas_post_g3->categoria), $total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3 = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($mas_post_g3->descripcion_categoria), $total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3 = str_replace("{NOMBRE}", ($mas_post_g3->nombre_autor), $total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3 = str_replace("{SEGUIDORES}", $seguidores3, $total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3 = str_replace("{PUNTOS}", "", $total_mas_post_grupo_interes3);
        /*
        $total_mas_post_grupo_interes3= str_replace("{CONTENIDO}",limit_text($mas_post_g3->contenido,35),$total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3= str_replace("{FECHA}",formatearFechaSmall($mas_post_g3->fecha),$total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3= str_replace("{ESTADO}",($mas_post_g3->estado),$total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3= str_replace("{DESCRIPCION_ESTADO}",($mas_post_g3->descripcion_estado),$total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3= str_replace("{RUT_AUTOR}",($mas_post_g3->rut),$total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3= str_replace("{RUT}",($rut),$total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3= str_replace("{NOMBRE_AUTOR}",($mas_post_g3->nombre_autor),$total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3= str_replace("{FOTO_AUTOR}",VerificaFotoPersonal($mas_post_g3->rut),$total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3= str_replace("{ESTILOESTADO}",($mas_post_g3->estilo),$total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3= str_replace("{ICONOESTADO}",($mas_post_g3->icono_estado),$total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3= str_replace("{ESTILOCATEGORIA}",($mas_post_g3->style),$total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3= str_replace("{ICONOCATEGORIA}",($mas_post_g3->icono),$total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3= str_replace("{CATEGORIA_MP}",($mas_post_g3->categoria),$total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3= str_replace("{NOMBRE}",($mas_post_g3->nombre),$total_mas_post_grupo_interes3);
        * */
        $total_mas_post_grupo_interes3 = str_replace("{RUT_ENVIADO}", ($mas_post_g3->rut), $total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3 = str_replace("{ID_MP}", ($mas_post_g3->id_mp), $total_mas_post_grupo_interes3);
        // BOTON SEGUIR
        $sesiguepersona                = count(VerificandompaSeguidores($rut, $mas_post_g3->rut, $id_empresa));
        if ($sesiguepersona > 0) {
            $boton_seguir = "
<center style=display: inline;'>
    <div class='badge_small badge-verde blanco mgtop5'>
        <i class='icon-check icons'></i> Siguiendo
    </div>
    <a href='?sw=com_mp_personal&rut_enviado=" . $mas_post_g3->rut . "&vp=1&sg=2' class='badge_small bg-white_borderBlue negro'> <i class='icon-user-following icons'></i> Dejar de seguir (-)</a>
</center>
";
        } else {
            $boton_seguir = "
<center style='display: inline;'>
    <a href='?sw=com_mp_personal&rut_enviado=" . $mas_post_g3->rut . "&vp=1&sg=1'
    class='badge_small bg-amarillos negro'> <i class='icon-user-following icons'></i> Seguir (+)</a>
</center>";
        }
        $total_mas_post_grupo_interes3 = str_replace("{BOTON_SEGUIR}", ($boton_seguir), $total_mas_post_grupo_interes3);
    }

    /* $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>INteres : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/



    $ultimos_posteos_publicados       = com_mp_preguntas_ultimos_recientes($rut, $id_empresa, $subcategoria);
    $total_ultimos_posteos_publicados = "";
    //print_r($ultimos_posteos_publicados);
    foreach ($ultimos_posteos_publicados as $post_reciente) {
        $total_ultimos_posteos_publicados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_mini.html");
        $total_ultimos_posteos_publicados = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($post_reciente->rut), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{ID_MP}", $post_reciente->id_mp, $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{LINK}", $link_MP, $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{TIPO}", "F", $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{CATEGORIA_MP}", ($post_reciente->categoria), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($post_reciente->descripcion_categoria), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{NOMBRE}", ($post_reciente->nombre), $total_ultimos_posteos_publicados);
        /*    $total_ultimos_posteos_publicados= str_replace("{CONTENIDO}",limit_text($post_reciente->contenido,35),$total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados= str_replace("{FECHA}",formatearFechaSmall($post_reciente->fecha),$total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados= str_replace("{ESTADO}",($post_reciente->estado),$total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados= str_replace("{DESCRIPCION_ESTADO}",($post_reciente->descripcion_estado),$total_ultimos_posteos_publicados);
        */
        $total_ultimos_posteos_publicados = str_replace("{RUT_AUTOR}", ($post_reciente->rut), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{RUT}", ($rut), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{NOMBRE_AUTOR}", ($post_reciente->nombre_autor), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($post_reciente->rut), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{ESTILOESTADO}", ($post_reciente->estilo), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{ICONOESTADO}", ($post_reciente->icono_estado), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{ESTILOCATEGORIA}", ($post_reciente->style), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{ICONOCATEGORIA}", ($post_reciente->icono), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{CATEGORIA_MP}", ($post_reciente->categoria), $total_ultimos_posteos_publicados);
        /*
        $total_ultimos_posteos_publicados= str_replace("{IMAGEN_POST}","multimedia/".$post_reciente->imagenfondo,$total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados= str_replace("{VIDEO}",($video),$total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados= str_replace("{TIPOMULTIMEDIA}",($post_reciente->tipo_multimedia),$total_ultimos_posteos_publicados);
        */
        $total_ultimos_posteos_publicados = str_replace("{NOMBRE}", ($post_reci_reciente->nombre), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{RUT_ENVIADO}", ($post_reciente->rut), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{ID_MP}", ($post_reciente->id_mp), $total_ultimos_posteos_publicados);
    }
    $ultimos_preguntas_publicadas_sinresponder = com_mp_preguntas_ultimos_recientes($rut, $id_empresa, $array_MP_template[0]->template);
    //print_r($ultimos_preguntas_publicadas_sinresponder);
    $total_preguntas_sin_responder             = "";
    foreach ($ultimos_preguntas_publicadas_sinresponder as $pregunta_experto) {
        if ($subcategoria <> '' and $subcategoria <> $pregunta_experto->id_subcategoria) {
            continue;
        }
        if ($subcategoria == '' and $pregunta_experto->id_subcategoria <> '') {
            continue;
        }
        $total_preguntas_sin_responder .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_persona_listado_tipoPRG.html");
        $post_categoria                = '<a href="?sw=com_mp_personal&amb=mp_cat&idcat=' . $pregunta_experto->id_categoria . '&cat=' . $pregunta_experto->categoria . '"><span class="badge_small badge-azul"><span class="blanco"><i class="icon-people icons"></i> ' . $pregunta_experto->categoria . '</span></span></a>';
        $ico                           = "img/bci_mp_pregunta_icon.png";
        $post_ambito                   = '<a href="?sw=com_mp_personal&amb=mp_amb&idamb=' . $pregunta_experto->id_ambito . '&ambito=' . $pregunta_experto->ambito . '"><span class="badge_small badge-azul"><span class="blanco"><i class="icon-people icons"></i> ' . $pregunta_experto->ambito . '</span></span></a>';
        $ico                           = "img/bci_mp_pregunta_icon.png";
        //echo "post ambito $post_ambito";
        $total_preguntas_sin_responder = str_replace("{ICONO}", $ico, $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{DESC_ICONO}", $pregunta_experto->tipo, $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($pregunta_experto->descripcion_categoria), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($pregunta_experto->rut), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{ID_MP}", $pregunta_experto->id_mp, $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{LINK}", $link_MP, $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{TIPO}", "F", $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($pregunta_experto->descripcion_categoria), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{NOMBRE}", ($pregunta_experto->nombre), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{RUT_AUTOR}", ($pregunta_experto->rut), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{RUT}", ($rut), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{NOMBRE_AUTOR}", ($pregunta_experto->nombre_autor), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($pregunta_experto->rut), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{ESTILOESTADO}", ($pregunta_experto->estilo), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{ICONOESTADO}", ($pregunta_experto->icono_estado), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{ESTILOCATEGORIA}", ($pregunta_experto->style), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{ICONOCATEGORIA}", ($pregunta_experto->icono), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{CATEGORIA_MP}", ($post_categoria), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{AMBITO_MP}", ($post_ambito), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{NOMBRE}", ($pregunta_experto->nombre), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{RUT_ENVIADO}", ($pregunta_experto->rut), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{ID_MP}", ($pregunta_experto->id_mp), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{TIPO}", "A", $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{ID_MP}", ($pregunta_experto->codigo), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{ID_MP_ENCODEADO}", Encodear3($pregunta_experto->id_mp), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{CONTENIDO}", $pregunta_experto->resumen, $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{FECHA}", formatearFechaSmall($pregunta_experto->fecha), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{ESTADO}", ($pregunta_experto->estado), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{RUT}", ($rut), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{NOMBRE_AUTOR}", ($pregunta_experto->nombre_autor), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{NUMVISITAS}", round($pregunta_experto->numvisitas), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{EDITAR_RESPONDER_PREGUNTA_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_responder_mp.html"), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{ID_MP_ENCODEADO}", Encodear3($pregunta_experto->id_mp), $total_preguntas_sin_responder);
    }
    $mp_com_frases_comunidad = com_mp_frases($id_empresa);
    //print_r($mp_com_frases);
    $total_mp_com_frases     = "";
    foreach ($mp_com_frases_comunidad as $mp_com_frase_comunidad) {
        $total_mp_com_frases .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_frases.html");
        $total_mp_com_frases = str_replace("{FRASE}", ($mp_com_frase_comunidad->frase), $total_mp_com_frases);
        $total_mp_com_frases = str_replace("{AUTOR}", ($mp_com_frase_comunidad->autor), $total_mp_com_frases);
    }
    $mp_com_grupos_interes_subcategorias_comunidad = com_mp_grupos_interes_subcategorias($rut, $id_empresa);
    //echo "<br><br><br><br>".count($mp_com_grupos_interes_subcategorias_comunidad);
    //echo "<br><br><br><br>function 5439 hola";
    //print_r($mp_com_grupos_interes_subcategorias_comunidad);
    if (count($mp_com_grupos_interes_subcategorias_comunidad) > 0) {
        $tit_mp_com_grupos_interes_subcategorias_comunidad = "
        <div class='widget clearfix hidden-xs'>
<h4><i class='fab fa-slideshare'></i> Tus Grupos Privados</h4>
<div class='panel-body' style='display: block'>


        ";

    /*     <div class='acctitle'>
&nbsp;<i class='icon-bookmark icons'></i><small> Grupos Cerrados a los que perteneces</small>
</div> */

    } else {
        $tit_mp_com_grupos_interes_subcategorias_comunidad = "";
    }

//eventos

 $array_eventos=Lista_eventos_postulables_mp_com_general_data($id_empresa);
  //print_r($array_eventos);
  if (count($array_eventos) > 0) {
          foreach($array_eventos as $unico ){// print_r($unico);
         //echo "cupos ".$unico->cupos."<".$unico->cuenta."";
         $cuposinscritos=0;
                   if($unico->cupos<=$unico->cuenta){$cuposinscritos=1;}
                   //echo "<br> cuposinscritos $cuposinscritos";
        $lista_eventos_postulables_mp_com_general .= file_get_contents("views/comunidad_mp/".  $id_empresa . "_com_mp_row_eventos.html");
        $lista_eventos_postulables_mp_com_general = str_replace("{ID_EVENTO_ENCODEADO}", Encodear3($unico->codigo), $lista_eventos_postulables_mp_com_general);
        $lista_eventos_postulables_mp_com_general = str_replace("{NOMBRE_EVENTO}", ($unico->nombre), $lista_eventos_postulables_mp_com_general);
        $lista_eventos_postulables_mp_com_general = str_replace("{DESCRIPCION_EVENTO}", ($unico->descripcion), $lista_eventos_postulables_mp_com_general);
        $lista_eventos_postulables_mp_com_general = str_replace("{IMAGEN_EVENTO}", ($unico->imagen), $lista_eventos_postulables_mp_com_general);

        $array_inscripcion_evento=Lista_eventos_postulables_mp_com_generalRut_data($id_empresa, $rut, $unico->codigo);
        $suma_inscritos=Lista_eventos_postulables_mp_com_generalSUma_data($id_empresa,  $unico->codigo);

        if($array_inscripcion_evento[0]->id>0) {
              $boton_postulacion_ya_inscrito= "<span class='badge bg-verde'><span class='blanco'><i class='icon-check icons'></i> Ya inscrito</span></span> <br><small>Junto contigo ya hay ".$suma_inscritos." inscritos.</small>";
        }
         elseif($cuposinscritos>0) {
            $boton_postulacion_ya_inscrito=   "
            <small>Los cupos ya est?n completos ".$suma_inscritos." inscritos.</small>";

        }  else {
            $boton_postulacion_ya_inscrito=   "<a href='?sw=save_inscripcion_evento&amp;idc=".Encodear3($unico->codigo)."' class='btn btn-warning btn btn-block' data-original-title='' title=''><span class='blanco'>Inscr&iacute;bete aqu&iacute;</span></a>
            <br><small>Sumate a los ".$suma_inscritos." inscritos.</small>";

        }

//        print_r($array_inscripcion_evento);
         // $boton_postulacion_ya_inscrito=
        $lista_eventos_postulables_mp_com_general = str_replace("{POSTULACION_EVENTOS_MP}", ($boton_postulacion_ya_inscrito), $lista_eventos_postulables_mp_com_general);

          }
     }else {

$lista_eventos_postulables_mp_com_general="Sin Eventos";
     }


    $total_mp_com_grupos_interes_subcat = "";
    foreach ($mp_com_grupos_interes_subcategorias_comunidad as $mp_com_grupo_int_subc_com) {
        //print_r($mp_com_grupo_int_subc_com);
        //echo "<br>template $template";
        $total_mp_com_grupos_intereses_subcat .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_grupos_interes_subcategoria.html");
        $link_id_subcatg                      = "?sw=com_mp_personal&sess=" . Encodear3($mp_com_grupo_int_subc_com->id_subcategoria);
        $link_id_subcatg_pasivo               = "?sw=com_mp_personal";
        $total_mp_com_grupos_intereses_subcat = str_replace("{LINK_GRUPO}", ($link_id_subcatg), $total_mp_com_grupos_intereses_subcat);
        $total_mp_com_grupos_intereses_subcat = str_replace("{TITULO_GRUPO}", ($mp_com_grupo_int_subc_com->nombre), $total_mp_com_grupos_intereses_subcat);
        $total_mp_com_grupos_intereses_subcat = str_replace("{ICONO_GRUPO}", ($mp_com_grupo_int_subc_com->icon), $total_mp_com_grupos_intereses_subcat);
    }


    /* $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_01 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000); */

    // MP MAS VALORADOS
    $posteos_mas_valorados       = com_mp_post_mas_valorados($rut, $id_empresa, $subcategoria);
    $total_posteos_mas_valorados = "";
    //print_r($posteos_mas_valorados);
    foreach ($posteos_mas_valorados as $post_recent) {
        if ($subcategoria <> '' and $subcategoria <> $post_recent->id_subcategoria) {
            continue;
        }
        if ($subcategoria == '' and $post_recent->id_subcategoria <> '') {
            continue;
        }
        $total_posteos_mas_valorados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_mini.html");
        $total_posteos_mas_valorados = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($post_recent->rut), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{ID_MP}", $post_recent->id_mp, $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{LINK}", $link_MP, $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{TIPO}", "F", $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{CATEGORIA_MP}", ($post_recent->categoria), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($post_recent->descripcion_categoria), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{NOMBRE}", ($post_recent->nombre), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{CONTENIDO}", ($post_recent->contenido), $total_posteos_mas_valorados);

        /*
        $total_posteos_mas_valorados = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_posteos_mas_valorados);
        if ($post_recent->rut == $rut) {
            $total_posteos_mas_valorados = str_replace("{EDITAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_editar_mp.html"), $total_posteos_mas_valorados);
            $total_posteos_mas_valorados = str_replace("{ELIMINAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_borrar_mp.html"), $total_posteos_mas_valorados);
        } else {
            $total_posteos_mas_valorados = str_replace("{EDITAR_MP}", "", $total_posteos_mas_valorados);
            $total_posteos_mas_valorados = str_replace("{ELIMINAR_MP}", "", $total_posteos_mas_valorados);
        }
       // $tiene_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "MEGUSTA", $rut);
        if ($tiene_megusta) {
            $total_posteos_mas_valorados = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta.html"), $total_posteos_mas_valorados);
        } else {
            $total_posteos_mas_valorados = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta.html"), $total_posteos_mas_valorados);
        }
       // $tiene_no_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "NOMEGUSTA", $rut);
        if ($tiene_no_megusta) {
            $total_posteos_mas_valorados = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_nomegusta.html"), $total_posteos_mas_valorados);
        } else {
            $total_posteos_mas_valorados = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_nomegusta.html"), $total_posteos_mas_valorados);
        }
        //$total_posteos_mas_valorados = ColocaCantidadDeMegusta($total_posteos_mas_valorados, $post_recent->id_mp, $id_empresa);
       // $tiene_favorito              = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "FAVORITA", $rut);
        if ($tiene_favorito) {
            $total_posteos_mas_valorados = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_favorito.html"), $total_posteos_mas_valorados);
        } else {
            $total_posteos_mas_valorados = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_favorito.html"), $total_posteos_mas_valorados);
        }
        */
        $total_posteos_mas_valorados = str_replace("{ESTADO}", ($post_recent->estado), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{DESCRIPCION_ESTADO}", ($post_recent->descripcion_estado), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{RUT_AUTOR}", ($post_recent->rut), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{RUT}", ($rut), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{NOMBRE_AUTOR}", ($post_recent->nombre_autor), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($post_recent->rut), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{ESTILOESTADO}", ($post_recent->estilo), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{ICONOESTADO}", ($post_recent->icono_estado), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{ESTILOCATEGORIA}", ($post_recent->style), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{ICONOCATEGORIA}", ($post_recent->icono), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{CATEGORIA_MP}", ($post_recent->categoria), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{NOMBRE}", ($post_recent->nombre), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{RUT_ENVIADO}", ($post_recent->rut), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{ID_MP}", ($post_recent->id_mp), $total_posteos_mas_valorados);
    }

    /* $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_02 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/


    // MP NOVEDADES
    $posteos_mas_novedades   = com_mp_post_portipo("Novedades", $id_empresa, $subcategoria);
    $total_posteos_novedades = "";
    foreach ($posteos_mas_novedades as $post_recent) {
        $total_posteos_novedades .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_mini_banner.html");
        $total_posteos_novedades = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($post_recent->rut), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{ID_MP}", $post_recent->id_mp, $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{LINK}", $link_MP, $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{TIPO}", "F", $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{CATEGORIA_MP}", ($post_recent->categoria), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($post_recent->descripcion_categoria), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{NOMBRE}", ($post_recent->nombre), $total_posteos_novedades);
        if ($id_empresa == 53) {
            $total_posteos_novedades = str_replace("{CONTENIDO}", substr($post_recent->contenido, 0, 150), $total_posteos_novedades);
        } else {
            $total_posteos_novedades = str_replace("{CONTENIDO}", ($post_recent->contenido), $total_posteos_novedades);
        }
        $total_posteos_novedades = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_posteos_novedades);
        if ($post_recent->rut == $rut) {
            $total_posteos_novedades = str_replace("{EDITAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_editar_mp.html"), $total_posteos_novedades);
            $total_posteos_novedades = str_replace("{ELIMINAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_borrar_mp.html"), $total_posteos_novedades);
        } else {
            $total_posteos_novedades = str_replace("{EDITAR_MP}", "", $total_posteos_novedades);
            $total_posteos_novedades = str_replace("{ELIMINAR_MP}", "", $total_posteos_novedades);
        }
        $tiene_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "MEGUSTA", $rut);
        if ($tiene_megusta) {
            $total_posteos_novedades = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta.html"), $total_posteos_novedades);
        } else {
            $total_posteos_novedades = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta.html"), $total_posteos_novedades);
        }
        $tiene_no_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "NOMEGUSTA", $rut);
        if ($tiene_no_megusta) {
            $total_posteos_novedades = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_nomegusta.html"), $total_posteos_novedades);
        } else {
            $total_posteos_novedades = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_nomegusta.html"), $total_posteos_novedades);
        }
        $total_posteos_novedades = ColocaCantidadDeMegusta($total_posteos_novedades, $post_recent->id_mp, $id_empresa);
        $tiene_favorito          = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "FAVORITA", $rut);
        if ($tiene_favorito) {
            $total_posteos_novedades = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_favorito.html"), $total_posteos_novedades);
        } else {
            $total_posteos_novedades = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_favorito.html"), $total_posteos_novedades);
        }
        $total_posteos_novedades = str_replace("{ESTADO}", ($post_recent->estado), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{DESCRIPCION_ESTADO}", ($post_recent->descripcion_estado), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{RUT_AUTOR}", ($post_recent->rut), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{RUT}", ($rut), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{NOMBRE_AUTOR}", ($post_recent->nombre_autor), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($post_recent->rut), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{ESTILOESTADO}", ($post_recent->estilo), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{ICONOESTADO}", ($post_recent->icono_estado), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{ESTILOCATEGORIA}", ($post_recent->style), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{ICONOCATEGORIA}", ($post_recent->icono), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{CATEGORIA_MP}", ($post_recent->categoria), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{IMAGEN_POST}", "multimedia/" . $post_recent->imagenfondo, $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{VIDEO}", ($video), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{TIPOMULTIMEDIA}", ($post_recent->tipo_multimedia), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{NOMBRE}", ($post_recent->nombre), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{RUT_ENVIADO}", ($post_recent->rut), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{ID_MP}", ($post_recent->id_mp), $total_posteos_novedades);
    }

    /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_03 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);    */

    // MP FOTOS
    $posteos_mas_fotos   = com_mp_post_portipo("Foto", $id_empresa, $subcategoria);
    $total_posteos_fotos = "";
    foreach ($posteos_mas_fotos as $post_recent) {
        $total_posteos_fotos .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_mini_banner.html");
        $total_posteos_fotos = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($post_recent->rut), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{ID_MP}", $post_recent->id_mp, $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{LINK}", $link_MP, $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{TIPO}", "F", $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{CATEGORIA_MP}", ($post_recent->categoria), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($post_recent->descripcion_categoria), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{NOMBRE}", ($post_recent->nombre), $total_posteos_fotos);
        if ($id_empresa == 53) {
            $total_posteos_fotos = str_replace("{CONTENIDO}", substr($post_recent->contenido, 0, 150), $total_posteos_fotos);
        } else {
            $total_posteos_fotos = str_replace("{CONTENIDO}", ($post_recent->contenido), $total_posteos_fotos);
        }
        $total_posteos_fotos = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_posteos_fotos);
        if ($post_recent->rut == $rut) {
            $total_posteos_fotos = str_replace("{EDITAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_editar_mp.html"), $total_posteos_fotos);
            $total_posteos_fotos = str_replace("{ELIMINAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_borrar_mp.html"), $total_posteos_fotos);
        } else {
            $total_posteos_fotos = str_replace("{EDITAR_MP}", "", $total_posteos_fotos);
            $total_posteos_fotos = str_replace("{ELIMINAR_MP}", "", $total_posteos_fotos);
        }
        $tiene_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "MEGUSTA", $rut);
        if ($tiene_megusta) {
            $total_posteos_fotos = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta.html"), $total_posteos_fotos);
        } else {
            $total_posteos_fotos = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta.html"), $total_posteos_fotos);
        }
        $tiene_no_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "NOMEGUSTA", $rut);
        if ($tiene_no_megusta) {
            $total_posteos_fotos = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_nomegusta.html"), $total_posteos_fotos);
        } else {
            $total_posteos_fotos = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_nomegusta.html"), $total_posteos_fotos);
        }
        $total_posteos_fotos = ColocaCantidadDeMegusta($total_posteos_fotos, $post_recent->id_mp, $id_empresa);
        $tiene_favorito      = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "FAVORITA", $rut);
        if ($tiene_favorito) {
            $total_posteos_fotos = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_favorito.html"), $total_posteos_fotos);
        } else {
            $total_posteos_fotos = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_favorito.html"), $total_posteos_fotos);
        }
        $total_posteos_fotos = str_replace("{ESTADO}", ($post_recent->estado), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{DESCRIPCION_ESTADO}", ($post_recent->descripcion_estado), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{RUT_AUTOR}", ($post_recent->rut), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{RUT}", ($rut), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{NOMBRE_AUTOR}", ($post_recent->nombre_autor), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($post_recent->rut), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{ESTILOESTADO}", ($post_recent->estilo), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{ICONOESTADO}", ($post_recent->icono_estado), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{ESTILOCATEGORIA}", ($post_recent->style), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{ICONOCATEGORIA}", ($post_recent->icono), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{CATEGORIA_MP}", ($post_recent->categoria), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{IMAGEN_POST}", "multimedia/" . $post_recent->imagenfondo, $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{VIDEO}", ($video), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{TIPOMULTIMEDIA}", ($post_recent->tipo_multimedia), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{NOMBRE}", ($post_recent->nombre), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{RUT_ENVIADO}", ($post_recent->rut), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{ID_MP}", ($post_recent->id_mp), $total_posteos_fotos);
    }


    /* $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_04 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/
    // MP CAPACITACIONES
    $posteos_mas_capacitaciones   = com_mp_post_portipo("Capacitaciones", $id_empresa, $subcategoria);
    $total_posteos_capacitaciones = "";
    //print_r($posteos_mas_capacitaciones);
    foreach ($posteos_mas_capacitaciones as $post_recent) {
        $total_posteos_capacitaciones .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_mini_banner.html");
        $total_posteos_capacitaciones = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($post_recent->rut), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{ID_MP}", $post_recent->id_mp, $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{LINK}", $link_MP, $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{TIPO}", "F", $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{CATEGORIA_MP}", ($post_recent->categoria), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($post_recent->descripcion_categoria), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{NOMBRE}", ($post_recent->nombre), $total_posteos_capacitaciones);
        if ($id_empresa == 53) {
            $total_posteos_capacitaciones = str_replace("{CONTENIDO}", substr($post_recent->contenido, 0, 150), $total_posteos_capacitaciones);
        } else {
            $total_posteos_capacitaciones = str_replace("{CONTENIDO}", ($post_recent->contenido), $total_posteos_capacitaciones);
        }
        $total_posteos_capacitaciones = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_posteos_capacitaciones);
        if ($post_recent->rut == $rut) {
            $total_posteos_capacitaciones = str_replace("{EDITAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_editar_mp.html"), $total_posteos_capacitaciones);
            $total_posteos_capacitaciones = str_replace("{ELIMINAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_borrar_mp.html"), $total_posteos_capacitaciones);
        } else {
            $total_posteos_capacitaciones = str_replace("{EDITAR_MP}", "", $total_posteos_capacitaciones);
            $total_posteos_capacitaciones = str_replace("{ELIMINAR_MP}", "", $total_posteos_capacitaciones);
        }
        $tiene_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "MEGUSTA", $rut);
        if ($tiene_megusta) {
            $total_posteos_capacitaciones = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta.html"), $total_posteos_capacitaciones);
        } else {
            $total_posteos_capacitaciones = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta.html"), $total_posteos_capacitaciones);
        }
        $tiene_no_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "NOMEGUSTA", $rut);
        if ($tiene_no_megusta) {
            $total_posteos_capacitaciones = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_nomegusta.html"), $total_posteos_capacitaciones);
        } else {
            $total_posteos_capacitaciones = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_nomegusta.html"), $total_posteos_capacitaciones);
        }
        $total_posteos_capacitaciones = ColocaCantidadDeMegusta($total_posteos_capacitaciones, $post_recent->id_mp, $id_empresa);
        $tiene_favorito               = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "FAVORITA", $rut);
        if ($tiene_favorito) {
            $total_posteos_capacitaciones = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_favorito.html"), $total_posteos_capacitaciones);
        } else {
            $total_posteos_capacitaciones = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_favorito.html"), $total_posteos_capacitaciones);
        }
        $total_posteos_capacitaciones = str_replace("{ESTADO}", ($post_recent->estado), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{DESCRIPCION_ESTADO}", ($post_recent->descripcion_estado), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{RUT_AUTOR}", ($post_recent->rut), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{RUT}", ($rut), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{NOMBRE_AUTOR}", ($post_recent->nombre_autor), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($post_recent->rut), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{ESTILOESTADO}", ($post_recent->estilo), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{ICONOESTADO}", ($post_recent->icono_estado), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{ESTILOCATEGORIA}", ($post_recent->style), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{ICONOCATEGORIA}", ($post_recent->icono), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{CATEGORIA_MP}", ($post_recent->categoria), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{IMAGEN_POST}", "multimedia/" . $post_recent->imagenfondo, $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{VIDEO}", ($video), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{TIPOMULTIMEDIA}", ($post_recent->tipo_multimedia), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{NOMBRE}", ($post_recent->nombre), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{RUT_ENVIADO}", ($post_recent->rut), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{ID_MP}", ($post_recent->id_mp), $total_posteos_capacitaciones);
    }

    /* $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_05 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000); */

    $peoples_mas_seguida      = com_mp_people_mas_seguida($rut, $id_empresa, $subcategoria);
    $total_people_mas_seguida = "";
    //print_r($peoples_mas_seguida);
    foreach ($peoples_mas_seguida as $people_maseguidA) {
        $total_people_mas_seguida .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_people_mini.html");
        $total_people_mas_seguida = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($people_maseguidA->rut), $total_people_mas_seguida);
        $total_people_mas_seguida = str_replace("{NOMBRE}", ($people_maseguidA->nombre), $total_people_mas_seguida);
        $total_people_mas_seguida = str_replace("{RUT_ENVIADO}", ($people_maseguidA->rut), $total_people_mas_seguida);
        $total_people_mas_seguida = str_replace("{SEGUIDORES}", ($people_maseguidA->seguidores . " seguidores"), $total_people_mas_seguida);
        $total_people_mas_seguida = str_replace("{PUNTOS}", "", $total_people_mas_seguida);
        // BOTON SEGUIR
        $sesiguepersona           = count(VerificandompaSeguidores($rut, $people_maseguidA->rut, $id_empresa));
        if ($sesiguepersona > 0) {
            $boton_seguir = "<center style='display: inline;'>    <div class='badge_small badge-verde blanco mgtop5'>    <i class='icon-check icons'></i> Siguiendo </div>
        <a href='?sw=com_mp_personal&rut_enviado=" . $people_maseguidA->rut . "&vp=1&sg=2' class='badge_small bg-white_borderBlue negro'>
        <i class='icon-user-following icons'></i> Dejar de seguir (-)</a></center>";
        } else {
            $boton_seguir = "<center style='display: inline;'><a href='?sw=com_mp_personal&rut_enviado=" . $people_maseguidA->rut . "&vp=1&sg=1'
         class='badge_small bg-amarillos negro'>
        <i class='icon-user-following icons'></i> Seguir (+)</a></center>";
        }
        $total_people_mas_seguida = str_replace("{BOTON_SEGUIR}", ($boton_seguir), $total_people_mas_seguida);
    }



    /* $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_06 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000); */

    $peoples_mas_puntos      = com_mp_people_mas_puntos($rut, $id_empresa, $subcategoria);
    $total_people_mas_puntos = "";
    //print_r($peoples_mas_puntos);
    //exit();
    foreach ($peoples_mas_puntos as $peoples_ma_punto) {
        $total_people_mas_puntos .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_people_mini.html");
        $total_people_mas_puntos = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($peoples_ma_punto->rut), $total_people_mas_puntos);
        $total_people_mas_puntos = str_replace("{NOMBRE}", ($peoples_ma_punto->nombre), $total_people_mas_puntos);
        $total_people_mas_puntos = str_replace("{RUT_ENVIADO}", ($peoples_ma_punto->rut), $total_people_mas_puntos);
        $total_people_mas_puntos = str_replace("{SEGUIDORES}", "", $total_people_mas_puntos);
        $total_people_mas_puntos = str_replace("{PUNTOS}", $peoples_ma_punto->puntos . " Bci Coins", $total_people_mas_puntos);
        // BOTON SEGUIR
        $sesiguepersona          = count(VerificandompaSeguidores($rut, $peoples_ma_punto->rut, $id_empresa));
        if ($sesiguepersona > 0) {
            $boton_seguir = "<center>    <div class='badge_small badge-verde blanco mgtop5'>    <i class='icon-check icons'></i> Siguiendo </div>
        <a href='?sw=com_mp_personal&rut_enviado=" . $peoples_ma_punto->rut . "&vp=1&sg=2'
        class='badge_small bg-amarillos negro'>
        <i class='icon-user-following icons'></i> Dejar de seguir (-)</a></center>";
        } else {
            $boton_seguir = "<center><a href='?sw=com_mp_personal&rut_enviado=" . $peoples_ma_punto->rut . "&vp=1&sg=1' class='badge_small bg-amarillos negro'>        <i class='icon-user-following icons'></i> Seguir (+)</a></center>";
        }
        $total_people_mas_puntos = str_replace("{BOTON_SEGUIR}", ($boton_seguir), $total_people_mas_puntos);
    }

    /*
    $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_07 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/

    $peoples_mas_interacciones = com_mp_people_mas_interacciones($rut, $id_empresa, $subcategoria);
    $total_people_mas_interacc = "";
    //print_r($peoples_mas_interacciones);
    foreach ($peoples_mas_interacciones as $people_mas_interacc) {
        $total_people_mas_interacc .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_people_mini.html");
        $total_people_mas_interacc = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($people_mas_interacc->rut), $total_people_mas_interacc);
        $total_people_mas_interacc = str_replace("{NOMBRE}", ($people_mas_interacc->nombre), $total_people_mas_interacc);
        $total_people_mas_interacc = str_replace("{RUT_ENVIADO}", ($people_mas_interacc->rut), $total_people_mas_interacc);
        $total_people_mas_interacc = str_replace("{SEGUIDORES}", ($people_mas_interacc->seguidores . " seguidores"), $total_people_mas_interacc);
        $total_people_mas_interacc = str_replace("{PUNTOS}", "", $total_people_mas_interacc);
        // BOTON SEGUIR
        $sesiguepersona            = count(VerificandompaSeguidores($rut, $people_mas_interacc->rut, $id_empresa));
        if ($sesiguepersona > 0) {
            $boton_seguir = "<center>    <div class='badge_small badge-verde blanco mgtop5'>    <i class='icon-check icons'></i> Siguiendo </div>
        <a href='?sw=com_mp_personal&rut_enviado=" . $people_mas_interacc->rut . "&vp=1&sg=2'
        class='badge_small bg-amarillos negro'>
        <i class='icon-user-following icons'></i> Dejar de seguir (-)</a></center>";
        } else {
            $boton_seguir = "<center><a href='?sw=com_mp_personal&rut_enviado=" . $people_mas_interacc->rut . "&vp=1&sg=1' class='badge_small bg-amarillos negro'>        <i class='icon-user-following icons'></i> Seguir (+)</a></center>";
        }
        $total_people_mas_interacc = str_replace("{BOTON_SEGUIR}", ($boton_seguir), $total_people_mas_interacc);
    }


    /* $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_08 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/

    $peoples_quesigos     = com_mp_people_quesigo($rut, $id_empresa);
    $total_people_quesigo = "";
    foreach ($peoples_quesigos as $people_quesigo) {
        $total_people_quesigo .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_people_mini.html");
        $datos                = $people_quesigo->cuenta . " seguidores";
        $total_people_quesigo = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($people_quesigo->rut), $total_people_quesigo);
        $total_people_quesigo = str_replace("{NOMBRE}", ($people_quesigo->nombrecompleto), $total_people_quesigo);
        $total_people_quesigo = str_replace("{RUT_ENVIADO}", ($people_quesigo->rut), $total_people_quesigo);
        $total_people_quesigo = str_replace("{DATOS}", ($datos), $total_people_quesigo);
        $total_people_quesigo = str_replace("{SEGUIDORES}", ($people_mas_interacc->seguidores . " seguidores"), $total_people_quesigo);
        $total_people_quesigo = str_replace("{PUNTOS}", "", $total_people_quesigo);
        // BOTON SEGUIR
        $sesiguepersona       = count(VerificandompaSeguidores($rut, $people_quesigo->rut, $id_empresa));
        if ($sesiguepersona > 0) {
            $boton_seguir = "<center>    <div class='badge_small badge-verde blanco mgtop5'>    <i class='icon-check icons'></i> Siguiendo </div>
        <a href='?sw=com_mp_personal&rut_enviado=" . $people_quesigo->rut . "&vp=1&sg=2'
        class='badge_small bg-amarillos negro'>
        <i class='icon-user-following icons'></i> Dejar de seguir (-)</a></center>";
        } else {
            $boton_seguir = "<center><a href='?sw=com_mp_personal&rut_enviado=" . $people_quesigo->rut . "&vp=1&sg=1' class='badge_small bg-white_borderBlue negro'>        <i class='icon-user-following icons'></i> Seguir (+)</a></center>";
        }
        $total_people_quesigo = str_replace("{BOTON_SEGUIR}", ($boton_seguir), $total_people_quesigo);
    }

    /*    $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_09 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/

    $limit                   = 9;
    $total_listado_tags      = com_mp_tag_data($id_empresa, $rut, $limit);
    $total_listado_tag_cloud = "";
    foreach ($total_listado_tags as $total_listado_tag_unico) {
        $total_listado_tag_cloud .= file_get_contents("views/comunidad_mp/com_mp_row_tag_cloud_search.html");
        $total_listado_tag_cloud = str_replace("{TAG}", $total_listado_tag_unico->tag, $total_listado_tag_cloud);
        $total_listado_tag_cloud = str_replace("{NUM}", $total_listado_tag_unico->cuenta, $total_listado_tag_cloud);
        $link                    = "?sw=com_mp_personal&amb=mp_tag&tag=" . $total_listado_tag_unico->tag . "";
        $total_listado_tag_cloud = str_replace("{LINK}", $link, $total_listado_tag_cloud);
    }


    /*    $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_10 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/

    $agrup_categorias      = MPObtengoCategoriasNumero($id_empresa);
    $total_agrup_categoria = "";
    foreach ($agrup_categorias as $agrup_categoria) {
        //revisa si usuario esta registrado en algun grupo
        $cuenta_seguido = com_mp_revisa_grupo_seguido($agrup_categoria->id_categoria, "GRUPOSEGUIDO", $id_empresa, $rut);
        //echo $cuenta_seguido[0]->cuenta;
        if ($cuenta_seguido[0]->cuenta == 0) {
            $var_gruposeguir       = "<a href='?sw=com_mp_personal&amb=mp_cat&idcat=" . $agrup_categoria->id_categoria . "&cat=" . $agrup_categoria->categoria . "&groupseguir=1'
            class='negro'> Seguir (+)</a>";
            $var_groupseguir_class = "azul";
        } else {
            $var_gruposeguir       = "<a href='?sw=com_mp_personal&amb=mp_cat&idcat=" . $agrup_categoria->id_categoria . "&cat=" . $agrup_categoria->categoria . "&groupseguir=2'
            class='negro'> Dejar de seguir (-)</a>";
            $var_groupseguir_class = "verde";
        }
        $var_gruposeguir       = "<a href='?sw=com_mp_personal&amb=mp_cat&idcat=" . $agrup_categoria->id_categoria . "&cat=" . $agrup_categoria->categoria . "&groupseguir=1'
            class='negro'> </a>";
        $var_groupseguir_class = "azul";
        $total_agrup_categoria .= file_get_contents("views/comunidad_mp/row_com_mp_grupo_interes.html");
        $total_agrup_categoria = str_replace("{ITEM}", ($agrup_categoria->categoria), $total_agrup_categoria);
        $total_agrup_categoria = str_replace("{NUM}", ($agrup_categoria->cuenta), $total_agrup_categoria);
        $link_cat_amb          = "?sw=com_mp_personal&amb=mp_cat&idcat=" . $agrup_categoria->id_categoria . "&cat=" . $agrup_categoria->categoria . "";
        $total_agrup_categoria = str_replace("{LINK}", $link_cat_amb, $total_agrup_categoria);
        $total_agrup_categoria = str_replace("{GRUPO_SEGUIR_SEGUIDO_BOTON}", $var_gruposeguir, $total_agrup_categoria);
        $total_agrup_categoria = str_replace("{GRUPO_SEGUIR_SEGUIDO_CLASS}", $var_groupseguir_class, $total_agrup_categoria);
        //    echo $agrup_categoria->categoria;
    }


    /*    $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_11 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/

    $agrup_ambitos       = MPObtengoAmbitosNumero($id_empresa, $array_MP_template[0]->template);
    $total_agrup_ambitos = "";
    foreach ($agrup_ambitos as $agrup_ambito) {
        //revisa si usuario esta registrado en algun grupo
        $cuenta_seguido        = com_mp_revisa_grupo_seguido($agrup_ambito->id_ambito, "GRUPOSEGUIDO", $id_empresa, $rut);
        //echo $cuenta_seguido[0]->cuenta;
        $var_gruposeguir       = "<a href='?sw=com_mp_personal&amb=mp_amb&idamb=" . $agrup_ambito->id_ambito . "&cat=" . $agrup_ambito->ambito . "&groupseguir=1'
            class='negro'> </a>";
        $var_groupseguir_class = "azul";
        $total_agrup_ambitos .= file_get_contents("views/comunidad_mp/row_com_mp_grupo_ambito.html");
        $total_agrup_ambitos = str_replace("{ITEM}", ($agrup_ambito->ambito), $total_agrup_ambitos);
        $total_agrup_ambitos = str_replace("{NUM}", ($agrup_ambito->cuenta), $total_agrup_ambitos);
        $link_cat_amb        = "?sw=com_mp_personal&amb=mp_amb&idamb=" . $agrup_ambito->id_ambito . "&ambito=" . $agrup_ambito->ambito . "";
        $total_agrup_ambitos = str_replace("{LINK}", $link_cat_amb, $total_agrup_ambitos);
        $total_agrup_ambitos = str_replace("{GRUPO_SEGUIR_SEGUIDO_BOTON}", $var_gruposeguir, $total_agrup_ambitos);
        $total_agrup_ambitos = str_replace("{GRUPO_SEGUIR_SEGUIDO_CLASS}", $var_groupseguir_class, $total_agrup_ambitos);
        //    echo $agrup_categoria->categoria;
    }



    /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_12 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000); */
    //categorias expertos
    $agrup_categoria_expertos_expertos = MPObtengoCategoriasNumero($id_empresa);
    $total_agrup_categoria_expertos    = "";
    foreach ($agrup_categoria_expertos_expertos as $agrup_categoria_experto) {
       // $cuenta_num = MP_numero_expertos_categoria($agrup_categoria_experto->id_categoria, $id_empresa);
        //if ($cuenta_num > 0) {
            $total_agrup_categoria_expertos .= file_get_contents("views/comunidad_mp/row_com_mp_grupo_interes_expertos.html");
            $total_agrup_categoria_expertos = str_replace("{ITEM}", ($agrup_categoria_experto->categoria), $total_agrup_categoria_expertos);
            $total_agrup_categoria_expertos = str_replace("{NUM}", ($cuenta_num), $total_agrup_categoria_expertos);
            $link_cat_amb                   = "?sw=com_mp_personal&=mp_cat&soloexpertos=1&q=" . $agrup_categoria_experto->categoria . "";
            $total_agrup_categoria_expertos = str_replace("{LINK}", $link_cat_amb, $total_agrup_categoria_expertos);
            $total_agrup_categoria_expertos = str_replace("{GRUPO_SEGUIR_SEGUIDO_BOTON}", $var_gruposeguir, $total_agrup_categoria_expertos);
            $total_agrup_categoria_expertos = str_replace("{GRUPO_SEGUIR_SEGUIDO_CLASS}", $var_groupseguir_class, $total_agrup_categoria_expertos);
        //}
    }


    /* $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_13 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/
    //filtro por tipo
    $agrup_tiposPub    = MPObtengoTiposPubNumero($id_empresa); //print_r($agrup_tiposPub);
    $total_agrup_tipos = "";
    foreach ($agrup_tiposPub as $agrup_tipoPub) {
        $total_agrup_tipos .= file_get_contents("views/comunidad_mp/row_com_mp_grupo_tipos.html");
        $total_agrup_tipos = str_replace("{ITEM}", ($agrup_tipoPub->tipo), $total_agrup_tipos);
        //$total_agrup_tipos = str_replace("{NUM}",($agrup_categoria->cuenta),$total_agrup_tipos);
        $link_cat_amb      = "?sw=com_mp_personal&amb=mp_tipo&idcat=" . $agrup_tipoPub->tipo . "&cat=" . $agrup_tipoPub->tipo . "";
        $total_agrup_tipos = str_replace("{LINK}", $link_cat_amb, $total_agrup_tipos);
        //$total_agrup_tipos = str_replace("{GRUPO_SEGUIR_SEGUIDO_BOTON}",$var_gruposeguir,$total_agrup_tipos);
        //$total_agrup_tipos = str_replace("{GRUPO_SEGUIR_SEGUIDO_CLASS}",$var_groupseguir_class,$total_agrup_tipos);
        //echo $agrup_categoria->categoria;
    }


    /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_14 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/

    $PRINCIPAL = str_replace("{NUM_FAV}", MPbuscaFav($rut, $id_empresa), $PRINCIPAL);
    $PRINCIPAL = str_replace("{NUM_MISPR}", MPbuscaMp($rut, $id_empresa), $PRINCIPAL);
    $PRINCIPAL = str_replace("{INSIGNIA}", "", $PRINCIPAL);
    $PRINCIPAL = str_replace("{RUT_USUARIO}", $rut, $PRINCIPAL);
    $PRINCIPAL = str_replace("{MIRUT}", $rut, $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_LISTADO_POST_VIDEOS}", utf8_encode($total_listado_post_tipo_new_videos), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_LISTADO_POST_NEWS_BIG}", utf8_encode($total_listado_post_tipo_news_big), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_LISTADO_POST_NEWS_3POST}", utf8_encode($total_listado_post_tipo_news_3post), $PRINCIPAL);
    //echo "4096 <br><br><br><br>ambiente $ambiente";


    /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_15 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/

    if ($ambiente <> '') {
        $PRINCIPAL = str_replace("{IMAGEN_CONCURSO_HOME}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{POST_RESULTADOS_COMUNIDAD_MP}", utf8_encode($total_listado_post_personas_resultados), $PRINCIPAL);
        $PRINCIPAL = str_replace("{POST_RESULTADOS_EXPERTOS_MP}", utf8_encode($total_listado_post_expertos_resultados), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ROW_TITULO_R_RESULTADOS}", ($titulo_R_resultados), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ROW_TITULO_E_RESULTADOS}", ($titulo_E_resultados), $PRINCIPAL);
        $PRINCIPAL = str_replace("{MP_HACERPREGUNTA}", utf8_encode($mp_hacerpregunta), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{IMAGEN_CONCURSO_HOME}", "<div class='row'><div class='col-xs-12'><a href='?sw=com_mp_concurso'><img src='img/comunidadmpa_banner_central_VF_rod.gif' border='0'></a>
    </div></div>", $PRINCIPAL);
        $PRINCIPAL = str_replace("{POST_RESULTADOS_COMUNIDAD_MP}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{POST_RESULTADOS_EXPERTOS_MP}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ROW_TITULO_R_RESULTADOS}", ($titulo_R_resultados), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ROW_TITULO_E_RESULTADOS}", ($titulo_E_resultados), $PRINCIPAL);
        $PRINCIPAL = str_replace("{MP_HACERPREGUNTA}", utf8_encode($mp_hacerpregunta), $PRINCIPAL);
    }
    $PRINCIPAL = str_replace("{PERFIL_PERSONAL_COMUNIDAD_MP}", utf8_encode($perfil_personal), $PRINCIPAL);
    $PRINCIPAL = str_replace("{POST_FIJOS_COMUNIDAD_MP}", utf8_encode($post_fijo_personal), $PRINCIPAL);
    $PRINCIPAL = str_replace("{POST_ESTADISTICAS_COMUNIDAD_MP}", utf8_encode($post_fijo_estadisticas), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_LISTADO_POST_RECIENTES_FACEBOOK}", utf8_encode($total_listado_post_tipo_facebook), $PRINCIPAL);
    //echo "<br><br><br><br><br><br><br><br>vp $vp, amb $ambiente";
    if ($vp == "" and ($ambiente == "" or $ambiente == "mp_cat" or $ambiente == "mp_tag" or $ambiente == "mp_mp" or $ambiente == "mp_mf" or $ambiente == "mp_cc" or $ambiente == "mp_tipo")) {
        //echo "uno";
        //$total_listado_post_recientes.=file_get_contents("views/comunidad_mp/".$template.$id_empresa."_boton_carga_mas_post.html");
        //$total_listado_post_recientes = str_replace("{NUMERO_COMENTARIOS}","1",$total_listado_post_recientes);
        $PRINCIPAL = str_replace("{ROW_LISTADO_POST_RECIENTES}", utf8_encode($total_listado_post_recientes), $PRINCIPAL);
        //<div class='com_mp_title_featured fc-container__inner '><a href='?sw=com_mp_personal&amb=mp_rec'><span class='blanco'> Lo ?ltimo en la Comunidad <i class='icon-arrow-right icons'></i></span></a></div>
        $PRINCIPAL = str_replace("{TITULO_LISTADO_POST_RECIENTES}", "", $PRINCIPAL);
    } else {
        //echo "dos";
        $PRINCIPAL = str_replace("{ROW_LISTADO_POST_RECIENTES}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{TITULO_LISTADO_POST_RECIENTES}", "", $PRINCIPAL);
    }


    /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_16 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/

    $PRINCIPAL  = str_replace("{ROW_LISTADO_TIMELINE_PERSONAL}", utf8_encode($total_listado_post_timeline), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{ROW_LISTADO_TIMELINE_POST_POPULARES}", utf8_encode($total_listado_post_populares), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{ROW_LISTADO_TIMELINE_PERSONAS_INTERES}", utf8_encode($total_listado_post_personas_interes), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{ROW_LISTADO_TIMELINE_PERSONAL}", utf8_encode($total_listado), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{TITULO_LISTADO_TIMELINE_TAG1}", utf8_encode($Top_Tag[0]->tag), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{TITULO_LISTADO_TIMELINE_TAG2}", utf8_encode($Top_Tag[1]->tag), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{TITULO_LISTADO_TIMELINE_TAG3}", utf8_encode($Top_Tag[2]->tag), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{ROW_LISTADO_TIMELINE_TAG1}", utf8_encode($total_listado_post_tag1), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{ROW_LISTADO_TIMELINE_TAG2}", utf8_encode($total_listado_post_tag2), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{ROW_LISTADO_TIMELINE_TAG3}", utf8_encode($total_listado_post_tag3), $PRINCIPAL);
    //    }
    //preguntas
    $PRINCIPAL  = str_replace("{ROW_ULTIMOS_PREGUNTAS_PUBLICO}", utf8_encode($total_ultimos_posteos_publicados), $PRINCIPAL);
    //soy experto??


    /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_17 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/

    $soyexperto = mp_verificaquesoy_experto($rut, $id_empresa, $subcategoria);
    if ($soyexperto[0]->cuenta >= 1) {
        $mp_num_preg_sin_contestar = mp_num_preguntas_sincontestar($rut, $id_empresa, $subcategoria);
        if ($mp_num_preg_sin_contestar[0]->cuenta == 1) {
            $alerta_experto_preguntas = "
    <div class='alert alert-danger' role='alert'>
          <strong>Existen " . $mp_num_preg_sin_contestar[0]->cuenta . " pregunta sin contestar</strong><br>Has click en el boton Responder, para contestar.<br> Tu respuesta quedara publicada en la Comunidad.
    </div>";
        } elseif ($mp_num_preg_sin_contestar[0]->cuenta > 1) {
            $alerta_experto_preguntas = "
    <div class='alert alert-danger' role='alert'>
          <strong>Existen " . $mp_num_preg_sin_contestar[0]->cuenta . " preguntas sin contestar</strong><br>Has click en el boton Responder, para contestar.<br> Tu respuesta quedara publicada en la Comunidad.
    </div>";
            ;
        } else {
            $alerta_experto_preguntas = "";
        }
        $PRINCIPAL = str_replace("{PREGUNTAS_COMUNIDAD_PARA_RESPONDER}", utf8_encode($total_preguntas_sin_responder), $PRINCIPAL);
        $PRINCIPAL = str_replace("{TITULO_PREGUNTAS_COMUNIDAD_PARA_RESPONDER}", utf8_encode($alerta_experto_preguntas), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{PREGUNTAS_COMUNIDAD_PARA_RESPONDER}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{TITULO_PREGUNTAS_COMUNIDAD_PARA_RESPONDER}", "", $PRINCIPAL);
    }


    /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_18 : $time_elapsed<br><br>"; */

    $start = round(microtime(true) * 1000);

    $PRINCIPAL                      = str_replace("{GRUPO_INTERES_1}", utf8_encode($mas_grupo_interes1[0]->categoria), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{GRUPO_INTERES_2}", utf8_encode($mas_grupo_interes2[0]->categoria), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{GRUPO_INTERES_3}", utf8_encode($mas_grupo_interes3[0]->categoria), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_MAS_PUBLICADOR_GRUPO_INTERES_1}", utf8_encode($total_mas_post_grupo_interes1), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_MAS_PUBLICADOR_GRUPO_INTERES_2}", utf8_encode($total_mas_post_grupo_interes2), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_MAS_PUBLICADOR_GRUPO_INTERES_3}", utf8_encode($total_mas_post_grupo_interes3), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{COM_MP_FRASES}", utf8_encode($total_mp_com_frases), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{TITULO_BOTONS_GRUPO_INTERES}", utf8_encode($tit_mp_com_grupos_interes_subcategorias_comunidad), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{LISTA_EVENTOS_POSTULABLES_MP}", utf8_encode($lista_eventos_postulables_mp_com_general), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{BOTONS_GRUPOS_INTERES}", utf8_encode($total_mp_com_grupos_intereses_subcat), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_POST_VALORADOS}", utf8_encode($total_posteos_mas_valorados), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{MP_NOVEDADES}", utf8_encode($total_posteos_novedades), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{MP_FOTOS}", utf8_encode($total_posteos_fotos), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{MIS_CAPACITACIONES_novedades}", utf8_encode($total_posteos_capacitaciones), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_PEOPLE_INTERACCIONES}", utf8_encode($total_people_mas_interacc), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_PEOPLE_MAS_SEGUIDOS}", utf8_encode($total_people_mas_seguida), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_PEOPLE_MAS_PUNTOS}", utf8_encode($total_people_mas_puntos), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{AGRUPACION_CATEGORIAS}", utf8_encode($total_agrup_categoria), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_PEOPLE_EXPERTOS}", utf8_encode($total_agrup_categoria_expertos), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_PEOPLE_QUESIGO}", utf8_encode($total_people_quesigo), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_TIPO_PUBLICACION}", utf8_encode($total_agrup_tipos), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{AGRUPACION_AMBITOS}", utf8_encode($total_agrup_ambitos), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{TAG_CLOUD}", utf8_encode($total_listado_tag_cloud), $PRINCIPAL);


    /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_19 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/
    //        $start = microtime(true);


    //Mini encuesta
    $total_mini_encuestas           = com_mp_mini_encuesta($id_empresa, $rut);
    $total_mini_encuesta_titulo     = "";
    $total_mini_encuesta_opciones   = "";
    $total_mini_encuesta_resultados = "";
    foreach ($total_mini_encuestas as $total_mini_encuesta) {
        //print_r($total_mini_encuesta);
        $total_mini_encuesta_titulo .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_titulo.html");
        $total_mini_encuesta_titulo = str_replace("{MINI_ENCUESTA_PREGUNTA}", ($total_mini_encuesta->pregunta), $total_mini_encuesta_titulo);
        if ($total_mini_encuesta->respuesta == 0) {
            //muestra  opciones
            if ($total_mini_encuesta->opcion1 <> '') {
                $total_mini_encuesta_opciones .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_opciones.html");
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION}", ($total_mini_encuesta->opcion1), $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION_ID}", "opcion1", $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_ID}", $total_mini_encuesta->id, $total_mini_encuesta_opciones);
            }
            if ($total_mini_encuesta->opcion2 <> '') {
                $total_mini_encuesta_opciones .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_opciones.html");
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION}", ($total_mini_encuesta->opcion2), $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION_ID}", "opcion2", $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_ID}", $total_mini_encuesta->id, $total_mini_encuesta_opciones);
            }
            if ($total_mini_encuesta->opcion3 <> '') {
                $total_mini_encuesta_opciones .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_opciones.html");
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION}", ($total_mini_encuesta->opcion3), $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION_ID}", "opcion3", $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_ID}", $total_mini_encuesta->id, $total_mini_encuesta_opciones);
            }
            if ($total_mini_encuesta->opcion4 <> '') {
                $total_mini_encuesta_opciones .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_opciones.html");
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION}", ($total_mini_encuesta->opcion4), $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION_ID}", "opcion4", $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_ID}", $total_mini_encuesta->id, $total_mini_encuesta_opciones);
            }
        } else {
            //muestra  respuesta
            if ($total_mini_encuesta->opcion1 <> '') {
                $total_mini_encuesta_resultados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_resultados.html");
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_PORCENTAJE}", $total_mini_encuesta->porcop1 . "%", $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_TEXTO}", $total_mini_encuesta->opcion1, $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_NUMERO}", $total_mini_encuesta->porcop1, $total_mini_encuesta_resultados);
            }
            if ($total_mini_encuesta->opcion2 <> '') {
                $total_mini_encuesta_resultados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_resultados.html");
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_PORCENTAJE}", $total_mini_encuesta->porcop2 . "%", $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_TEXTO}", $total_mini_encuesta->opcion2, $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_NUMERO}", $total_mini_encuesta->porcop2, $total_mini_encuesta_resultados);
            }
            if ($total_mini_encuesta->opcion3 <> '') {
                $total_mini_encuesta_resultados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_resultados.html");
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_PORCENTAJE}", $total_mini_encuesta->porcop3 . "%", $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_TEXTO}", $total_mini_encuesta->opcion3, $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_NUMERO}", $total_mini_encuesta->porcop3, $total_mini_encuesta_resultados);
            }
            if ($total_mini_encuesta->opcion4 <> '') {
                $total_mini_encuesta_resultados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_resultados.html");
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_PORCENTAJE}", $total_mini_encuesta->porcop4 . "%", $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_TEXTO}", $total_mini_encuesta->opcion4, $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_NUMERO}", $total_mini_encuesta->porcop4, $total_mini_encuesta_resultados);
            }
        }
    }

    /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_20 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);*/

    $PRINCIPAL = str_replace("{ENCUESTA_MINI_TITULO_PREGUNTA}", utf8_encode($total_mini_encuesta_titulo), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ENCUESTA_MINI_OPCIONES}", utf8_encode($total_mini_encuesta_opciones), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ENCUESTA_MINI_RESULTADOS}", utf8_encode($total_mini_encuesta_resultados), $PRINCIPAL);
    if ($tipo_query == "" and $ambiente == "" AND $rut_enviado == "") {
        //echo "<br><br><br><br><br><br>hola";
        $PRINCIPAL = str_replace("{ROW_CARGAS_MAS}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_personal_solo_post_cargar.html"), $PRINCIPAL);
    } else {
        //echo "<br><br><br><br><br><br>chao";
        // $PRINCIPAL = str_replace("{ROW_CARGAS_MAS}","",$PRINCIPAL);
        $PRINCIPAL = str_replace("{ROW_CARGAS_MAS}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_personal_solo_post_cargar.html"), $PRINCIPAL);
    }
    $arreglo_get               = $_GET;
    $array_para_enviar_via_url = serialize($arreglo_get);
    $array_para_enviar_via_url = urlencode($array_para_enviar_via_url);
    $PRINCIPAL                 = str_replace("{VARIABLES_GET_ENCODEADAS}", $array_para_enviar_via_url, $PRINCIPAL);
    //    $mp_comp_estadistica=MPO_Compestadistica($id_empresa);
    $categorias_mp             = TraeCategoriasMejoresPracticas($id_empresa);
    $options_categorias        = "";
    foreach ($categorias_mp as $cat) {
        $options_categorias .= "<option value='" . $cat->id_categoria . "'>" . $cat->categoria . "</option>";
    }
    $PRINCIPAL                    = str_replace("{CATEGORIAS_FORM}", utf8_encode($options_categorias), $PRINCIPAL);

    /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_21 : $time_elapsed<br><br>"; */




//$time_elapsed_secs = microtime(true) - $start;
//$time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
//echo "<br>VP encuesta : $time_elapsed<br><br>";


    //$start = microtime(true);

    // notificaciones sin ver
    // Mis Notificaciones

    /*$com_mp_mis_notificaciones    = mp_interacciones_notificaciones_home($rut, $id_empresa, "");
    //print_r($com_mp_mis_notificaciones); echo "5613";
    $cuenta_notificaciones        = 0;
    $cuenta_notificaciones_sinver = 0;
    $total_notificaciones         = "";
    foreach ($com_mp_mis_notificaciones as $com_mp_mi_notificacion) {
        $muestra = 0;
        $cuenta_notificaciones++;
        $ico   = "";
        $texto = "";
        if ($com_mp_mi_notificacion->tipo == "COMENTARIO") {
            $ico = '<i class="icon-speech icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small>';
            if ($com_mp_mi_notificacion->rutAutor == $Rut_Perfil) {
                $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut_remitente . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreRemitente . '</strong>
                    </a> coment&oacute;:
                     tu publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
                if ($com_mp_mi_notificacion->visto_autor === null or $com_mp_mi_notificacion->visto_autor <> 1) {
                    $cuenta_notificaciones_sinver++;
                    $muestra = 1;
                }
            } else {
                $texto = 'Comentaste la publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '">
                    <strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a>  ';
            }
        }
        if ($com_mp_mi_notificacion->tipo == "SEGUIDO" and $Rut_Perfil <> $com_mp_mi_notificacion->rut_remitente) {
            $ico = '<i class="icon-user icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
            if ($com_mp_mi_notificacion->rut_remitenteAutor == $Rut_Perfil) {
                $texto = 'Seguiste a <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a>';
            } else {
                $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut_remitente . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreRemitente . '</strong> te sigue';
                if ($com_mp_mi_notificacion->visto === null or $com_mp_mi_notificacion->visto <> 1 and $com_mp_mi_notificacion->rut_remitente <> $Rut_Perfil) {
                    $cuenta_notificaciones_sinver++;
                    $muestra = 1;
                }
            }
        }
        //publicaciones sin ver
        //echo "<br> rut $Rut_Perfil==".$com_mp_mi_notificacion->rut_remitente;
        if ($com_mp_mi_notificacion->tipo == "PUBLICACION_SEGUIDO" and $Rut_Perfil == $com_mp_mi_notificacion->rut_remitente) {
            if ($com_mp_mi_notificacion->rut_remitenteAutor <> $Rut_Perfil) {
                $ico   = '<i class="icon-user icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
                //echo "<br> sigues a que publico ".$com_mp_mi_notificacion->rut_autor;
                //exit();
                $texto = $com_mp_mi_notificacion->NombreAutor . ' ha publicado
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '">
                    <strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a>  ';
                //echo "$com_mp_mi_notificacion->visto_remitente===null or $com_mp_mi_notificacion->visto_remitente<>1 and $com_mp_mi_notificacion->rut_remitente==$Rut_Perfil";
                if ($com_mp_mi_notificacion->visto_remitente === null or $com_mp_mi_notificacion->visto_remitente <> 1 and $com_mp_mi_notificacion->rut_remitente == $Rut_Perfil) {
                    $cuenta_notificaciones_sinver++;
                    $muestra = 1;
                }
            }
        }
        if ($com_mp_mi_notificacion->tipo == "MEGUSTA") {
            $ico = '<i class="icon-thumbs-up icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
            if ($com_mp_mi_notificacion->rut == $Rut_Perfil) {
                $texto = 'Te gusta la publicaci&oacute;n <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '">
                    <strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
            } else {
                $texto = 'A <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a> le Gusta tu publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
                if ($com_mp_mi_notificacion->visto_autor === null or $com_mp_mi_notificacion->visto_autor <> 1) {
                    $cuenta_notificaciones_sinver++;
                    $muestra = 1;
                }
            }
        }
        if ($com_mp_mi_notificacion->tipo == "GRUPOSEGUIDO") {
            $ico = '<i class="icon-people icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
            if ($com_mp_mi_notificacion->rut == $Rut_Perfil) {
                $texto = 'Seguiste el Grupo de Inter&eacute;s
                    <a href="?sw=com_mp_personal&amb=mp_cat&idcat=' . $com_mp_mi_notificacion->contenido . '&cat=' . $com_mp_mi_notificacion->NombreCategoria . '">
                    <strong>' . $com_mp_mi_notificacion->NombreCategoria . '</strong></a>
                    ';
            }
        }
        if ($com_mp_mi_notificacion->tipo == "COMPARTIDOCONMIGO") {
            $ico = '<i class="icon-share icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
            if ($com_mp_mi_notificacion->rut <> $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente <> $Rut_Perfil and $com_mp_mi_notificacion->rut == $com_mp_mi_notificacion->rut_remitente) {
                $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a> guard&oacute; tu publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
                if ($com_mp_mi_notificacion->visto_autor === null or $com_mp_mi_notificacion->visto_autor <> 1) {
                    $cuenta_notificaciones_sinver++;
                    $muestra = 1;
                }
            } elseif ($com_mp_mi_notificacion->rut == $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente == $Rut_Perfil) {
                $texto = 'Guardaste la publicaci&oacute;n <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '">
                    <strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
            } elseif ($com_mp_mi_notificacion->rut == $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente <> $Rut_Perfil) {
                $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreRemitente . '</strong>
                    </a> comparti&oacute; contigo la publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a>';
                if ($com_mp_mi_notificacion->visto === null or $com_mp_mi_notificacion->visto <> 1) {
                    $cuenta_notificaciones_sinver++;
                    $muestra = 1;
                }
            } elseif ($com_mp_mi_notificacion->rut <> $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente == $Rut_Perfil) {
                $texto = 'Compartiste con <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a> la publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a>
                    ';
            }
        }
        if ($muestra == 1 and $cuenta_notificaciones_sinver <= 10) {
            $total_notificaciones .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_perfil_mis_notificaciones_mini.html");
            $total_notificaciones = str_replace("{ICO}", ($ico), $total_notificaciones);
            $total_notificaciones = str_replace("{TEXTO}", ($texto), $total_notificaciones);
        }
    }
    $PRINCIPAL = str_replace("{MI_RUT}", $rut, $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_COMP_MP_MIS_NOTIFICACIONES_SIN_VER}", utf8_encode($total_notificaciones), $PRINCIPAL);
    if ($cuenta_notificaciones_sinver > 0) {
        $PRINCIPAL = str_replace("{NUM_NOTIFICACIONES_SINVER_GLOBO}", "<span class='badge_bell badge-default-bell'>" . $cuenta_notificaciones_sinver . " </span> ", $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{NUM_NOTIFICACIONES_SINVER_GLOBO}", "", $PRINCIPAL);
    }
    */


     $PRINCIPAL = str_replace("{NUM_NOTIFICACIONES_SINVER_GLOBO}", "", $PRINCIPAL);

    /*
$time_elapsed_secs = microtime(true) - $start;
$time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
echo "<br>VP Final : $time_elapsed<br><br>";*/

    $PRINCIPAL = str_replace("{COMP_MP_PUBLICACIONES_TOTALES}", $mp_comp_estadistica[0]->CuentaPublicaciones, $PRINCIPAL);
    $PRINCIPAL = str_replace("{COMP_MP_PUBLICACIONES_TOTALES}", $mp_comp_estadistica[0]->CuentaPublicaciones, $PRINCIPAL);
    $PRINCIPAL = str_replace("{COMP_MP_VISTAS_TOTALES}", $mp_comp_estadistica[0]->CuentaVisitas, $PRINCIPAL);
    $PRINCIPAL = str_replace("{COMP_MP_FAVORITAS_TOTALES}", $mp_comp_estadistica[0]->CuentaFavoritas, $PRINCIPAL);
    $PRINCIPAL = str_replace("{COMP_MP_MEGUSTA_TOTALES}", $mp_comp_estadistica[0]->CuentaMeGusta, $PRINCIPAL);
    return ($PRINCIPAL);
}


function com_mp_stories_lista($PRINCIPAL, $id_empresa, $rut, $ord_by, $filt_by, $filt_cat, $vp, $tag, $rut_enviado, $tipo_query, $ambiente, $start_limit, $subcategoria, $idamb, $template, $tipo_stories)
{
    // echo "tipo_stories $tipo_stories";
    $com_limit = "20";
    $com_start = "0";
    $todas = com_mp_lista_stories($id_empresa, $Rut_Perfil, $ord_by, $filt_by, $filt_cat, $vp, $arreglo_tag, utf8_decode($tag) , $rut_enviado, $ambiente, $com_limit, $com_start, $start_limit, $subcategoria, $idamb, $tipo_stories);
    // print_r($todas);
    $total_listado_post_recientes = "";
    foreach($todas as $unico) {
        if ($tipo_stories == "stories_360") {
            $total_listado_stories.= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_carrusel_360_lista.html");
            $arr_persona = TraeDatosBiografiayUsuario($unico->rut, $id_empresa);
            if ($unico->imagen <> '') {
                $contenido = "<img src='" . $unico->imagen . "' class='img_stories'>";
            }
            else {
                $contenido = utf8_encode($unico->stories);
            }
            // echo $contenido;
        }
        if ($tipo_stories == "stories_twit") {
            if ($unico->imagen <> '') {
                $total_listado_stories.= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_carrusel_twit_foto_lista.html");
            }
            else {
                $total_listado_stories.= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_carrusel_twit_lista.html");
            }
            if ($unico->imagen <> '') {
                $contenido = "<img src='multimedia/" . $unico->imagen . "' class='img_stories'>";
            }
            else {
                $contenido = utf8_encode($unico->stories);
            }
        }
        $arr_persona = TraeDatosBiografiayUsuario($unico->rut, $id_empresa);
        $total_listado_stories = str_replace("{IMAGEN_USER_STORIES}", VerificaFotoPersonal($unico->rut) , $total_listado_stories);
        $total_listado_stories = str_replace("{CONTENIDO_STORIES}", $contenido, $total_listado_stories);
        $total_listado_stories = str_replace("{TWIT}", (utf8_encode($unico->stories)) , $total_listado_stories);
        $user_name = explode("@", $arr_persona[0]->email);
        $user_name_email = "@" . $user_name[0];
        $total_listado_stories = str_replace("{NOMBRE_USER_STORIES}", $user_name_email, $total_listado_stories);
        $total_listado_stories = str_replace("{CARGO_USER_STORIES}", $arr_persona[0]->cargo, $total_listado_stories);
        $total_listado_stories = str_replace("{ID_STORIES}", $unico->id_st, $total_listado_stories);
    }
    // echo $total_listado_stories;
    if ($tipo_stories == "stories_360") {
        $txt = "<i class='fab fa-slack-hash'></i> Videos360 Convenci?n 2018 ";
        $crea_tu_twit_mp = "";
    }
    if ($tipo_stories == "stories_twit") {
        $txt = "<i class='fab fa-slack-hash'></i> Minuto a Minuto #Convenci?nBci2018 ";
        $crea_tu_twit_mp = "<a href='?sw=com_mp_stories_createpost' class='btn btn-info btn-sm'><span class='blanco'><i class='fab fa-slack-hash'></i> Crea tu #minutoaminuto aqu?</span></a>";
    }
    $PRINCIPAL = str_replace("{TITULO_STORIES}", $txt, $PRINCIPAL);
    $PRINCIPAL = str_replace("{BOTON_CREAR_TWIT}", $crea_tu_twit_mp, $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_LISTADO_STORIES}", $total_listado_stories, $PRINCIPAL);
    return ($PRINCIPAL);
}

 function com_mp_foto_GPTW_listaTop10($PRINCIPAL, $id_empresa, $rut, $ord_by, $filt_by, $filt_cat, $vp, $tag, $rut_enviado, $tipo_query, $ambiente, $start_limit, $subcategoria, $idamb, $template, $tipo_stories)
{
    // echo "tipo_stories $tipo_stories";
    $com_limit = "20";
    $com_start = "0";
    $todas = com_mp_lista_fotoGPTW_Top10_data($id_empresa, $Rut_Perfil, $ord_by, $filt_by, $filt_cat, $vp, $arreglo_tag, utf8_decode($tag) , $rut_enviado, $ambiente, $com_limit, $com_start, $start_limit, $subcategoria, $idamb, $tipo_stories);
   // print_r($todas);
    $total_listado_post_recientes = "";
    foreach($todas as $unico) {
       // print_r($unico);
        $row.= file_get_contents("views/comunidad_mp/" . $id_empresa . "_row_com_carrusel_fotoGPTW_lista.html");
       // echo "views/comunidad_mp/" . $id_empresa . "_row_com_carrusel_fotoGPTW_lista.html";
        $arr_persona = TraeDatosBiografiayUsuario($unico->rut, $id_empresa);
        $foto = "<img src='multimedia/" . $unico->foto . "' class='img_fotos' width='100%'>";
        $row = str_replace("{ID_FOTOS}", ($unico->id) , $row);
        $row = str_replace("{FOTOS}", $foto, $row);
        $row = str_replace("{MENSAJE_FOTOS}", utf8_encode($unico->mensaje) , $row);
        $user_name = explode("@", $unico->email);
        $user_name_email = "@" . $user_name[0];
        $row = str_replace("{NOMBRE_FOTOS}", $user_name_email, $row);
        $row = str_replace("{IMAGEN_FOTOS}", VerificaFotoPersonal($unico->rut) , $row);
        $row = str_replace("{NOMBRE_COMPLETO}", utf8_encode($arr_persona[0]->nombre_completo), $row);
        //Por cada vuelta, veo si existe o no el megusta de esta interaccion
        $row = str_replace("{HUINCHA_SOLO_MEGUSTA}", ColocaMegustaGPW($unico->id, $id_empresa, $rut) , $row);



    }

        $crea_tu_twit_mp = "";

    $PRINCIPAL = str_replace("{TITULO_STORIES}", $txt, $PRINCIPAL);
    $PRINCIPAL = str_replace("{BOTON_CREAR_TWIT}", $crea_tu_twit_mp, $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_LISTADO_FOTO_GPTW_TOP10}", $row, $PRINCIPAL);
    return ($PRINCIPAL);
}

 function com_mp_foto_GPTW_lista($PRINCIPAL, $id_empresa, $rut, $ord_by, $filt_by, $filt_cat, $vp, $tag, $rut_enviado, $tipo_query, $ambiente, $start_limit, $subcategoria, $idamb, $template, $tipo_stories)
{
    // echo "tipo_stories $tipo_stories";
    $com_limit = "20";
    $com_start = "0";
    $todas = com_mp_lista_fotoGPTW_data($id_empresa, $Rut_Perfil, $ord_by, $filt_by, $filt_cat, $vp, $arreglo_tag, utf8_decode($tag) , $rut_enviado, $ambiente, $com_limit, $com_start, $start_limit, $subcategoria, $idamb, $tipo_stories);
    //print_r($todas);
    $total_listado_post_recientes = "";
    foreach($todas as $unico) {

       // print_r($unico);
        $row.= file_get_contents("views/comunidad_mp/" . $id_empresa . "_row_com_carrusel_fotoGPTW_lista.html");
      // echo "views/comunidad_mp/" . $id_empresa . "_row_com_carrusel_fotoGPTW_lista.html";
        $arr_persona = TraeDatosBiografiayUsuario($unico->rut, $id_empresa);
        $foto = "<img src='multimedia/" . $unico->foto . "' class='img_fotos' width='100%'>";
        $row = str_replace("{ID_FOTOS}", ($unico->id) , $row);
        $row = str_replace("{FOTOS}", $foto, $row);
        $row = str_replace("{MENSAJE_FOTOS}", utf8_encode($unico->mensaje) , $row);
        $user_name = explode("@", $unico->email);
        $user_name_email = "@" . $user_name[0];
        $row = str_replace("{NOMBRE_FOTOS}", $user_name_email, $row);
        $row = str_replace("{NOMBRE_COMPLETO}", utf8_encode($arr_persona[0]->nombre_completo), $row);
        $row = str_replace("{IMAGEN_FOTOS}", VerificaFotoPersonal($unico->rut) , $row);
        //Por cada vuelta, veo si existe o no el megusta de esta interaccion
        $row = str_replace("{HUINCHA_SOLO_MEGUSTA}", ColocaMegustaGPW($unico->id, $id_empresa, $rut) , $row);

    }

        $crea_tu_twit_mp = "";

    $PRINCIPAL = str_replace("{TITULO_STORIES}", $txt, $PRINCIPAL);
    $PRINCIPAL = str_replace("{BOTON_CREAR_TWIT}", $crea_tu_twit_mp, $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_LISTADO_FOTO_GPTW}", $row, $PRINCIPAL);
    return ($PRINCIPAL);
}

 function com_mp_foto_grupo_lista($PRINCIPAL, $id_empresa, $rut, $grupo, $ord_by, $filt_by, $filt_cat, $vp, $tag, $rut_enviado, $tipo_query, $ambiente, $start_limit, $subcategoria, $idamb, $template, $tipo_stories)
{
    // echo "tipo_stories $tipo_stories";
    $com_limit = "20";
    $com_start = "0";
    $todas = com_mp_lista_grupo_data($id_empresa, $Rut_Perfil, $grupo, $ord_by, $filt_by, $filt_cat, $vp, $arreglo_tag, utf8_decode($tag) , $rut_enviado, $ambiente, $com_limit, $com_start, $start_limit, $subcategoria, $idamb, $tipo_stories);
    //print_r($todas);
    $total_listado_post_recientes = "";
    foreach($todas as $unico) {

       // print_r($unico);
        $row.= file_get_contents("views/comunidad_mp/" . $id_empresa . "_row_com_carrusel_fotoGPTW_lista.html");
      // echo "views/comunidad_mp/" . $id_empresa . "_row_com_carrusel_fotoGPTW_lista.html";
        $arr_persona = TraeDatosBiografiayUsuario($unico->rut, $id_empresa);
        $foto = "<img src='multimedia/" . $unico->foto . "' class='img_fotos' width='100%'>";
        $row = str_replace("{ID_FOTOS}", ($unico->id) , $row);
        $row = str_replace("{FOTOS}", $foto, $row);
        $row = str_replace("{MENSAJE_FOTOS}", utf8_encode($unico->mensaje) , $row);
        $user_name = explode("@", $unico->email);
        $user_name_email = "@" . $user_name[0];
        $row = str_replace("{NOMBRE_FOTOS}", $user_name_email, $row);
        $row = str_replace("{NOMBRE_COMPLETO}", utf8_encode($arr_persona[0]->nombre_completo), $row);
        $row = str_replace("{IMAGEN_FOTOS}", VerificaFotoPersonal($unico->rut) , $row);
        //Por cada vuelta, veo si existe o no el megusta de esta interaccion
        $row = str_replace("{HUINCHA_SOLO_MEGUSTA}", ColocaMegustaGPW($unico->id, $id_empresa, $rut) , $row);

    }

        $crea_tu_twit_mp = "";

    $PRINCIPAL = str_replace("{TITULO_STORIES}", $txt, $PRINCIPAL);
    $PRINCIPAL = str_replace("{BOTON_CREAR_TWIT}", $crea_tu_twit_mp, $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_LISTADO_FOTO_GPTW}", $row, $PRINCIPAL);
    return ($PRINCIPAL);
}
function Reconocer_personal_lista($PRINCIPAL, $id_empresa, $rut, $ord_by, $filt_by, $filt_cat, $vp, $tag, $rut_enviado, $tipo_query, $ambiente, $start_limit, $subcategoria)
{
    if ($rut_enviado <> '') {
        $Rut_Perfil = $rut_enviado;
    } else {
        $Rut_Perfil = $rut;
    }
    $array_MP_template = MP_BuscaTemplate($rut, $id_empresa);
    if ($array_MP_template[0]->template <> '') {
        $template = $array_MP_template[0]->template . "/";
    } else {
        $template = "";
    }
    if ($tipo_query <> '') {
        $todas                                  = com_mp_resultados_inteligentes($id_empresa, $tipo_query, "", $ambiente, $subcategoria);
        $total_listado_post_personas_resultados = "";
        foreach ($todas as $unico) {
            $tpi++;
            //print_r($unico);
            $guardo_codigo[$tpi] = $unico->codigo;
            $total_listado_post_personas_resultados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_persona_listado_tipoE_Reconoce.html");
            $total_listado_post_personas_resultados = str_replace("{HUINCHA_INTERACCIONES}", "", $total_listado_post_personas_resultados);
            $datos_interaccion_personal             = TraeBuscaInteraccionPersonal($unico->codigo, $id_empresa);
            if ($datos_interaccion_personal[0]->numbcicoins == "") {
                $num_coins = 0;
            } else {
                $num_coins = $datos_interaccion_personal[0]->numbcicoins;
            }
            if ($datos_interaccion_personal[0]->numaptitudesvalidadas == "") {
                $num_aptitudes = 0;
            } else {
                $num_aptitudes = $datos_interaccion_personal[0]->numaptitudesvalidadas;
            }
            if ($datos_interaccion_personal[0]->numpublicaciones == "") {
                $num_publicaciones = 0;
            } else {
                $num_publicaciones = $datos_interaccion_personal[0]->numpublicaciones;
            }
            if ($datos_interaccion_personal[0]->numseguidores == "") {
                $num_seguidores = 0;
            } else {
                $num_seguidores = $datos_interaccion_personal[0]->numseguidores;
            }
            $total_listado_post_personas_resultados = str_replace("{NUM_BCICOINS}", $num_coins, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUM_SEGUIDORES}", $num_seguidores, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUM_SEGUIDOS}", $datos_interaccion_personal[0]->numseguidos, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUM_PUBLICACIONES}", $num_publicaciones, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUM_MEGUSTA_FAVORITAS}", $datos_interaccion_personal[0]->nummegustafavorita, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUM_VISITAS}", $datos_interaccion_personal[0]->numvisitas, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUM_COMENTARIOS}", $datos_interaccion_personal[0]->numcomentarios, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUM_APTITUDESVALIDADAS}", $num_aptitudes, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUM_PUBLICACIONESSEGUIDAS}", $datos_interaccion_personal[0]->publicacionesseguidas, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUM_INTERACCIONES}", $datos_interaccion_personal[0]->numinteracciones, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{RUTEXPERTO}", $unico->codigo, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{CARGO_EXPERTO}", $unico->cargo_experto, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NOMBRE_EXPERTO}", $unico->nombre_experto, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($unico->codigo), $total_listado_post_personas_resultados);
            if ($unico->tipo == "MejorPractica") {
                $ico = "img/bci_mp_practica_icon.png";
            }
            if ($unico->tipo == "Papers") {
                $ico = "img/bci_mp_paper_icon.png";
            }
            if ($unico->tipo == "Publicacion") {
                $ico = "img/bci_mp_publicacion.png";
            }
            if ($unico->tipo == "Video" or $unico->tipo == "VideoInterno") {
                $ico = "img/bci_mp_practica_video.png";
            }
            if ($unico->tipo == "Links" or $unico->tipo == "LinkExterno") {
                $ico = "img/bci_mp_link_icon.png";
            }
            if ($unico->tipo == "Experiencias") {
                $ico = "img/bci_mp_experiencias_icon.png";
            }
            if ($unico->tipopost == "expertos") {
                $ico = "img/bci_mp_experto_icon.png";
            }
            if ($unico->tipo == "OportunidadMejora") {
                $ico = "img/bci_mp_oportunidadmejora_icon.png";
            }
            if ($unico->tipo == "Udnolohaga") {
                $ico = "img/bci_mp_udnolohaga_icon.png";
            }
            if ($unico->tipo == "RRPP") {
                $ico = "img/bci_mp_rrpp_icon.png";
            }
            if ($unico->tipo == "Pregunta") {
                $ico = "img/bci_mp_pregunta_icon.png";
            }
            if ($unico->tipo == "Respuesta") {
                $ico = "img/bci_mp_pregunta_icon.png";
            }
            $array_Reco_Gracias = BuscaDatosReconocimientoAgradecimientos($unico->codigo, $id_empresa);
            if ($array_Reco_Gracias[0]->num_gracias > 0) {
                $num_gracias = $array_Reco_Gracias[0]->num_gracias;
            } else {
                $num_gracias = 0;
            }
            if ($array_Reco_Gracias[0]->num_reconocimientos > 0) {
                $num_reconocimientos = $array_Reco_Gracias[0]->num_reconocimientos;
            } else {
                $num_reconocimientos = 0;
            }
            $total_listado_post_personas_resultados = str_replace("{NUM_GRACIAS}", ($num_gracias), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUM_RECONOCIMIENTOS}", ($num_reconocimientos), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NOMBRE_MENTOR}", ($mentor), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{ICONO}", $ico, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{DESC_ICONO}", $unico->tipo, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = ColocaCantidadDeFavorito($total_listado_post_personas_resultados, $unico->id_mp, $id_empresa);
            $total_listado_post_personas_resultados = str_replace("{ID_MP}", $unico->codigo, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{LINK}", $link_MP, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($unico->descripcion_categoria), $total_listado_post_personas_resultados);
            if ($unico->resumen == "" and $unico->contenido == "") {
                $resumen = ($unico->resumen);
            } elseif ($unico->resumen <> "" and $unico->contenido == "") {
                $resumen = ($unico->resumen);
            } elseif ($unico->resumen == "" and $unico->contenido <> "") {
                $resumen = limit_text($unico->contenido, 35);
            } elseif ($unico->resumen <> "" and $unico->contenido <> "") {
                $resumen = ($unico->resumen);
            } else {
                $resumen = "";
            }
            if ($unico->tipopost <> 'expertos') {
                $total_listado_post_personas_resultados = str_replace("{NOMBRE}", ($unico->nombre), $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{CATEGORIA_MP}", $post_categoria, $total_listado_post_personas_resultados);
                $post_ambito                            = '<a href="?sw=com_mp_personal&amb=mp_amb&idamb=' . $unico->id_ambito . '&ambito=' . $unico->ambito . '">
<span class="badge_small badge-azul"><span class="blanco"><i class="icon-people icons"></i> ' . $unico->ambito . '</span></span></a>';
                $total_listado_post_personas_resultados = str_replace("{AMBITO_MP}", $post_ambito, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{RUT_AUTOR}", ($unico->rut), $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($unico->rut), $total_listado_post_personas_resultados);
                $link                                   = "?sw=com_mp_full&id_mp=" . $unico->codigo . "";
            } else {
                $total_listado_post_personas_resultados = str_replace("{NOMBRE}", ("$resumen"), $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{CATEGORIA_MP}", $post_categoria, $total_listado_post_personas_resultados);
                $post_ambito                            = '<a href="?sw=com_mp_personal&amb=mp_amb&idamb=' . $unico->id_ambito . '&ambito=' . $unico->ambito . '">
<span class="badge_small badge-azul"><span class="blanco"><i class="icon-people icons"></i> ' . $unico->ambito . '</span></span></a>';
                $total_listado_post_personas_resultados = str_replace("{AMBITO_MP}", $post_ambito, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{RUT_AUTOR}", ($unico->contenido), $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($unico->codigo), $total_listado_post_personas_resultados);
                $link                                   = "?sw=com_mp_personal&rut_enviado=" . $unico->codigo . "&vp=1&mp=1";
            }
            $tiene_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $unico->codigo, "MEGUSTA", $rut);
            if ($tiene_megusta) {
                $total_listado_post_personas_resultados = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta.html"), $total_listado_post_personas_resultados);
            } else {
                $total_listado_post_personas_resultados = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta.html"), $total_listado_post_personas_resultados);
            }
            $total_listado_post_personas_resultados = ColocaCantidadDeMegusta($total_listado_post_personas_resultados, $unico->codigo, $id_empresa);
            //$total_listado_post_personas_resultados =ColocaCantidadDeNoMegusta($total_listado_post_personas_resultados , $unico->codigo, $id_empresa);
            $total_listado_post_personas_resultados = str_replace("{TIPO}", "A", $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{ID_MP}", ($unico->codigo), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{CONTENIDO}", $resumen, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{FECHA}", formatearFechaSmall($unico->fecha), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{ESTADO}", ($unico->estado), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{DESCRIPCION_ESTADO}", ($unico->descripcion_estado), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{RUT}", ($rut), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NOMBRE_AUTOR}", ($unico->nombre_autor), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUMVISITAS}", round($unico->numvisitas), $total_listado_post_personas_resultados);
            //$total_listado_post_personas_resultados = str_replace("{NUMMEGUSTA}",($unico->nummegusta),$total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUMNOMEGUSTA}", ($unico->numnomegusta), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUMCOMPARTIDA}", ($unico->numcompartido), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUMCOMENTARIO}", ($unico->numcomentarios), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUMCOMENTARIOSREALES}", ($unico->numcomentariosreales), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUMFAVORITA}", ($unico->numfavorita), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{ESTILOESTADO}", ($unico->estilo), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{ICONOESTADO}", ($unico->icono_estado), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{ESTILOCATEGORIA}", ($unico->style), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{ICONOCATEGORIA}", ($unico->icono), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{CATEGORIA_MP}", ($unico->categoria), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{LINK}", ($link), $total_listado_post_personas_resultados);
            if ($unico->tipo_multimedia == "imagen") {
                $imagen = "../../front/multimedia/" . $unico->multimedia;
            } else {
                $imagen = "";
            }
            if ($unico->tipo_multimedia == "video") {
                $video = "../../front/multimedia/" . $unico->multimedia;
            } else {
                $video = "";
            }
            $total_listado_post_personas_resultados = str_replace("{IMAGEN_POST}", "multimedia/" . $unico->imagenfondo, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{VIDEO}", ($video), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{TIPOMULTIMEDIA}", ($unico->tipo_multimedia), $total_listado_post_personas_resultados);
            $listado_comentarios                    = MuestraComentariosPorPost($unico->id_mp);
            $total_listado_post_personas_resultados = str_replace("{BLOQUE_COMENTARIOS}", $listado_comentarios, $total_listado_post_personas_resultados);
            if ($unico->url_documento) {
                $total_listado_post_personas_resultados = str_replace("{BLOQUE_URL_DOCUMENTO}", file_get_contents("views/comunidad_mp/row_com_mp_url_documento.html"), $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{URL_DOCUMENTO}", ($unico->url_documento), $total_listado_post_personas_resultados);
            } else {
                $total_listado_post_personas_resultados = str_replace("{BLOQUE_URL_DOCUMENTO}", "", $total_listado_post_personas_resultados);
            }
            //echo "<br> video".$unico->video." imagen".$unico->imagenfondo;
            if ($unico->video) {
                $video_youtube                          = ColocaVideoYoutube($unico->video, $unico->id_mp);
                $total_listado_post_personas_resultados = str_replace("{VIDEO_IMAGEN}", $video_youtube, $total_listado_post_personas_resultados);
            } elseif ($unico->imagenfondo) {
                $bloque_imagen_fondo                    = ColocaImagenPost($unico->imagenfondo);
                $total_listado_post_personas_resultados = str_replace("{VIDEO_IMAGEN}", $bloque_imagen_fondo, $total_listado_post_personas_resultados);
            } else {
                $total_listado_post_personas_resultados = str_replace("{VIDEO_IMAGEN}", "", $total_listado_post_personas_resultados);
            }
            $total_listado_post_personas_resultados = str_replace("{TITULO_R}", $tituloR, $total_listado_post_personas_resultados);
            //tags por post
            $TagsPorPosts                           = TagsPorMPEmpresa($unico->codigo, $id_empresa);
            $tag_por_post                           = "";
            foreach ($TagsPorPosts as $TagsPorPost) {
                $tag_por_post .= '<a href="?sw=com_mp_personal&amb=mp_tag&tag=' . $TagsPorPost->tag . '"><span class="badge_small badge-white"><span class="negro">#' . $TagsPorPost->tag . '</span></span></a> ';
            }
            $total_listado_post_personas_resultados = str_replace("{TAGS_POR_POST}", ($tag_por_post), $total_listado_post_personas_resultados);
        }
        // no encontraste resultados?
        $mp_hacerpregunta .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_hacer_pregunta.html");
        $mp_hacerpregunta = str_replace("{PREGUNTA}", $tipo_query, $mp_hacerpregunta);
    }



   //filtro por tipo
    $agrup_tiposPub    = MPObtengoTiposPubNumero($id_empresa); //print_r($agrup_tiposPub);
    $total_agrup_tipos = "";
    foreach ($agrup_tiposPub as $agrup_tipoPub) {
        $total_agrup_tipos .= file_get_contents("views/comunidad_mp/row_com_mp_grupo_tipos.html");
        $total_agrup_tipos = str_replace("{ITEM}", ($agrup_tipoPub->tipo), $total_agrup_tipos);
        //$total_agrup_tipos = str_replace("{NUM}",($agrup_categoria->cuenta),$total_agrup_tipos);
        $link_cat_amb      = "?sw=com_mp_personal&amb=mp_tipo&idcat=" . $agrup_tipoPub->tipo . "&cat=" . $agrup_tipoPub->tipo . "";
        $total_agrup_tipos = str_replace("{LINK}", $link_cat_amb, $total_agrup_tipos);
        //$total_agrup_tipos = str_replace("{GRUPO_SEGUIR_SEGUIDO_BOTON}",$var_gruposeguir,$total_agrup_tipos);
        //$total_agrup_tipos = str_replace("{GRUPO_SEGUIR_SEGUIDO_CLASS}",$var_groupseguir_class,$total_agrup_tipos);
        //echo $agrup_categoria->categoria;
    }
    $PRINCIPAL = str_replace("{NUM_FAV}", MPbuscaFav($rut, $id_empresa), $PRINCIPAL);
    $PRINCIPAL = str_replace("{NUM_MISPR}", MPbuscaMp($rut, $id_empresa), $PRINCIPAL);
    $PRINCIPAL = str_replace("{INSIGNIA}", "", $PRINCIPAL);
    $PRINCIPAL = str_replace("{RUT_USUARIO}", $rut, $PRINCIPAL);
    $PRINCIPAL = str_replace("{MIRUT}", $rut, $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_LISTADO_POST_VIDEOS}", utf8_encode($total_listado_post_tipo_new_videos), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_LISTADO_POST_NEWS_BIG}", utf8_encode($total_listado_post_tipo_news_big), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_LISTADO_POST_NEWS_3POST}", utf8_encode($total_listado_post_tipo_news_3post), $PRINCIPAL);
    //echo "4096 <br><br><br><br>ambiente $ambiente";
    if ($ambiente <> '') {
        $PRINCIPAL = str_replace("{IMAGEN_CONCURSO_HOME}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{POST_RESULTADOS_COMUNIDAD_MP}", utf8_encode($total_listado_post_personas_resultados), $PRINCIPAL);
        $PRINCIPAL = str_replace("{POST_RESULTADOS_EXPERTOS_MP}", utf8_encode($total_listado_post_expertos_resultados), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ROW_TITULO_R_RESULTADOS}", ($titulo_R_resultados), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ROW_TITULO_E_RESULTADOS}", ($titulo_E_resultados), $PRINCIPAL);
        $PRINCIPAL = str_replace("{MP_HACERPREGUNTA}", utf8_encode($mp_hacerpregunta), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{IMAGEN_CONCURSO_HOME}", "<div class='row'><div class='col-xs-12'><a href='?sw=com_mp_concurso'><img src='img/comunidadmpa_banner_central_VF_rod.gif' border='0'></a>
    </div></div>", $PRINCIPAL);
        $PRINCIPAL = str_replace("{POST_RESULTADOS_COMUNIDAD_MP}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{POST_RESULTADOS_EXPERTOS_MP}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ROW_TITULO_R_RESULTADOS}", ($titulo_R_resultados), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ROW_TITULO_E_RESULTADOS}", ($titulo_E_resultados), $PRINCIPAL);
        $PRINCIPAL = str_replace("{MP_HACERPREGUNTA}", utf8_encode($mp_hacerpregunta), $PRINCIPAL);
    }
    $PRINCIPAL = str_replace("{PERFIL_PERSONAL_COMUNIDAD_MP}", utf8_encode($perfil_personal), $PRINCIPAL);
    $PRINCIPAL = str_replace("{POST_FIJOS_COMUNIDAD_MP}", utf8_encode($post_fijo_personal), $PRINCIPAL);
    $PRINCIPAL = str_replace("{POST_ESTADISTICAS_COMUNIDAD_MP}", utf8_encode($post_fijo_estadisticas), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_LISTADO_POST_RECIENTES_FACEBOOK}", utf8_encode($total_listado_post_tipo_facebook), $PRINCIPAL);
    //echo "<br><br><br><br><br><br><br><br>vp $vp, amb $ambiente";
    if ($vp == "" and ($ambiente == "" or $ambiente == "mp_cat" or $ambiente == "mp_tag" or $ambiente == "mp_mp" or $ambiente == "mp_mf" or $ambiente == "mp_cc" or $ambiente == "mp_tipo")) {
        //echo "uno";
        //$total_listado_post_recientes.=file_get_contents("views/comunidad_mp/".$template.$id_empresa."_boton_carga_mas_post.html");
        //$total_listado_post_recientes = str_replace("{NUMERO_COMENTARIOS}","1",$total_listado_post_recientes);
        $PRINCIPAL = str_replace("{ROW_LISTADO_POST_RECIENTES}", utf8_encode($total_listado_post_recientes), $PRINCIPAL);
        //<div class='com_mp_title_featured fc-container__inner '><a href='?sw=com_mp_personal&amb=mp_rec'><span class='blanco'> Lo ?ltimo en la Comunidad <i class='icon-arrow-right icons'></i></span></a></div>
        $PRINCIPAL = str_replace("{TITULO_LISTADO_POST_RECIENTES}", "", $PRINCIPAL);
    } else {
        //echo "dos";
        $PRINCIPAL = str_replace("{ROW_LISTADO_POST_RECIENTES}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{TITULO_LISTADO_POST_RECIENTES}", "", $PRINCIPAL);
    }
    $PRINCIPAL  = str_replace("{ROW_LISTADO_TIMELINE_PERSONAL}", utf8_encode($total_listado_post_timeline), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{ROW_LISTADO_TIMELINE_POST_POPULARES}", utf8_encode($total_listado_post_populares), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{ROW_LISTADO_TIMELINE_PERSONAS_INTERES}", utf8_encode($total_listado_post_personas_interes), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{ROW_LISTADO_TIMELINE_PERSONAL}", utf8_encode($total_listado), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{TITULO_LISTADO_TIMELINE_TAG1}", utf8_encode($Top_Tag[0]->tag), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{TITULO_LISTADO_TIMELINE_TAG2}", utf8_encode($Top_Tag[1]->tag), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{TITULO_LISTADO_TIMELINE_TAG3}", utf8_encode($Top_Tag[2]->tag), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{ROW_LISTADO_TIMELINE_TAG1}", utf8_encode($total_listado_post_tag1), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{ROW_LISTADO_TIMELINE_TAG2}", utf8_encode($total_listado_post_tag2), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{ROW_LISTADO_TIMELINE_TAG3}", utf8_encode($total_listado_post_tag3), $PRINCIPAL);
    //    }
    //preguntas
    $PRINCIPAL  = str_replace("{ROW_ULTIMOS_PREGUNTAS_PUBLICO}", utf8_encode($total_ultimos_posteos_publicados), $PRINCIPAL);
    //soy experto??
    $soyexperto = mp_verificaquesoy_experto($rut, $id_empresa, $subcategoria);
    if ($soyexperto[0]->cuenta >= 1) {
        $mp_num_preg_sin_contestar = mp_num_preguntas_sincontestar($rut, $id_empresa, $subcategoria);
        if ($mp_num_preg_sin_contestar[0]->cuenta == 1) {
            $alerta_experto_preguntas = "
    <div class='alert alert-danger' role='alert'>
          <strong>Existen " . $mp_num_preg_sin_contestar[0]->cuenta . " pregunta sin contestar</strong><br>Has click en el boton Responder, para contestar.<br> Tu respuesta quedara publicada en la Comunidad.
    </div>";
        } elseif ($mp_num_preg_sin_contestar[0]->cuenta > 1) {
            $alerta_experto_preguntas = "
    <div class='alert alert-danger' role='alert'>
          <strong>Existen " . $mp_num_preg_sin_contestar[0]->cuenta . " preguntas sin contestar</strong><br>Has click en el boton Responder, para contestar.<br> Tu respuesta quedara publicada en la Comunidad.
    </div>";
        } else {
            $alerta_experto_preguntas = "";
        }
        $PRINCIPAL = str_replace("{PREGUNTAS_COMUNIDAD_PARA_RESPONDER}", utf8_encode($total_preguntas_sin_responder), $PRINCIPAL);
        $PRINCIPAL = str_replace("{TITULO_PREGUNTAS_COMUNIDAD_PARA_RESPONDER}", utf8_encode($alerta_experto_preguntas), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{PREGUNTAS_COMUNIDAD_PARA_RESPONDER}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{TITULO_PREGUNTAS_COMUNIDAD_PARA_RESPONDER}", "", $PRINCIPAL);
    }
    $PRINCIPAL                      = str_replace("{GRUPO_INTERES_1}", utf8_encode($mas_grupo_interes1[0]->categoria), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{GRUPO_INTERES_2}", utf8_encode($mas_grupo_interes2[0]->categoria), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{GRUPO_INTERES_3}", utf8_encode($mas_grupo_interes3[0]->categoria), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_MAS_PUBLICADOR_GRUPO_INTERES_1}", utf8_encode($total_mas_post_grupo_interes1), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_MAS_PUBLICADOR_GRUPO_INTERES_2}", utf8_encode($total_mas_post_grupo_interes2), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_MAS_PUBLICADOR_GRUPO_INTERES_3}", utf8_encode($total_mas_post_grupo_interes3), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{COM_MP_FRASES}", utf8_encode($total_mp_com_frases), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_POST_VALORADOS}", utf8_encode($total_posteos_mas_valorados), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{MP_NOVEDADES}", utf8_encode($total_posteos_novedades), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{MP_FOTOS}", utf8_encode($total_posteos_fotos), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{MIS_CAPACITACIONES_novedades}", utf8_encode($total_posteos_capacitaciones), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_PEOPLE_INTERACCIONES}", utf8_encode($total_people_mas_interacc), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_PEOPLE_MAS_SEGUIDOS}", utf8_encode($total_people_mas_seguida), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_PEOPLE_MAS_PUNTOS}", utf8_encode($total_people_mas_puntos), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{AGRUPACION_CATEGORIAS}", utf8_encode($total_agrup_categoria), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_PEOPLE_EXPERTOS}", utf8_encode($total_agrup_categoria_expertos), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_PEOPLE_QUESIGO}", utf8_encode($total_people_quesigo), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_TIPO_PUBLICACION}", utf8_encode($total_agrup_tipos), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{AGRUPACION_AMBITOS}", utf8_encode($total_agrup_ambitos), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{TAG_CLOUD}", utf8_encode($total_listado_tag_cloud), $PRINCIPAL);
    //Mini encuesta
    $total_mini_encuestas           = com_mp_mini_encuesta($id_empresa, $rut);
    $total_mini_encuesta_titulo     = "";
    $total_mini_encuesta_opciones   = "";
    $total_mini_encuesta_resultados = "";
    foreach ($total_mini_encuestas as $total_mini_encuesta) {
        //print_r($total_mini_encuesta);
        $total_mini_encuesta_titulo .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_titulo.html");
        $total_mini_encuesta_titulo = str_replace("{MINI_ENCUESTA_PREGUNTA}", ($total_mini_encuesta->pregunta), $total_mini_encuesta_titulo);
        if ($total_mini_encuesta->respuesta == 0) {
            //muestra  opciones
            if ($total_mini_encuesta->opcion1 <> '') {
                $total_mini_encuesta_opciones .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_opciones.html");
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION}", ($total_mini_encuesta->opcion1), $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION_ID}", "opcion1", $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_ID}", $total_mini_encuesta->id, $total_mini_encuesta_opciones);
            }
            if ($total_mini_encuesta->opcion2 <> '') {
                $total_mini_encuesta_opciones .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_opciones.html");
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION}", ($total_mini_encuesta->opcion2), $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION_ID}", "opcion2", $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_ID}", $total_mini_encuesta->id, $total_mini_encuesta_opciones);
            }
            if ($total_mini_encuesta->opcion3 <> '') {
                $total_mini_encuesta_opciones .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_opciones.html");
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION}", ($total_mini_encuesta->opcion3), $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION_ID}", "opcion3", $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_ID}", $total_mini_encuesta->id, $total_mini_encuesta_opciones);
            }
            if ($total_mini_encuesta->opcion4 <> '') {
                $total_mini_encuesta_opciones .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_opciones.html");
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION}", ($total_mini_encuesta->opcion4), $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION_ID}", "opcion4", $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_ID}", $total_mini_encuesta->id, $total_mini_encuesta_opciones);
            }
        } else {
            //muestra  respuesta
            if ($total_mini_encuesta->opcion1 <> '') {
                $total_mini_encuesta_resultados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_resultados.html");
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_PORCENTAJE}", $total_mini_encuesta->porcop1 . "%", $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_TEXTO}", $total_mini_encuesta->opcion1, $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_NUMERO}", $total_mini_encuesta->porcop1, $total_mini_encuesta_resultados);
            }
            if ($total_mini_encuesta->opcion2 <> '') {
                $total_mini_encuesta_resultados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_resultados.html");
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_PORCENTAJE}", $total_mini_encuesta->porcop2 . "%", $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_TEXTO}", $total_mini_encuesta->opcion2, $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_NUMERO}", $total_mini_encuesta->porcop2, $total_mini_encuesta_resultados);
            }
            if ($total_mini_encuesta->opcion3 <> '') {
                $total_mini_encuesta_resultados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_resultados.html");
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_PORCENTAJE}", $total_mini_encuesta->porcop3 . "%", $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_TEXTO}", $total_mini_encuesta->opcion3, $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_NUMERO}", $total_mini_encuesta->porcop3, $total_mini_encuesta_resultados);
            }
            if ($total_mini_encuesta->opcion4 <> '') {
                $total_mini_encuesta_resultados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_resultados.html");
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_PORCENTAJE}", $total_mini_encuesta->porcop4 . "%", $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_TEXTO}", $total_mini_encuesta->opcion4, $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_NUMERO}", $total_mini_encuesta->porcop4, $total_mini_encuesta_resultados);
            }
        }
    }
    $PRINCIPAL = str_replace("{ENCUESTA_MINI_TITULO_PREGUNTA}", utf8_encode($total_mini_encuesta_titulo), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ENCUESTA_MINI_OPCIONES}", utf8_encode($total_mini_encuesta_opciones), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ENCUESTA_MINI_RESULTADOS}", utf8_encode($total_mini_encuesta_resultados), $PRINCIPAL);
    if ($tipo_query == "" and $ambiente == "" AND $rut_enviado == "") {
        //echo "<br><br><br><br><br><br>hola";
        $PRINCIPAL = str_replace("{ROW_CARGAS_MAS}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_personal_solo_post_cargar.html"), $PRINCIPAL);
    } else {
        //echo "<br><br><br><br><br><br>chao";
        // $PRINCIPAL = str_replace("{ROW_CARGAS_MAS}","",$PRINCIPAL);
        $PRINCIPAL = str_replace("{ROW_CARGAS_MAS}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_personal_solo_post_cargar.html"), $PRINCIPAL);
    }
    $arreglo_get               = $_GET;
    $array_para_enviar_via_url = serialize($arreglo_get);
    $array_para_enviar_via_url = urlencode($array_para_enviar_via_url);
    $PRINCIPAL                 = str_replace("{VARIABLES_GET_ENCODEADAS}", $array_para_enviar_via_url, $PRINCIPAL);
    //    $mp_comp_estadistica=MPO_Compestadistica($id_empresa);
    $categorias_mp             = TraeCategoriasMejoresPracticas($id_empresa);
    $options_categorias        = "";
    foreach ($categorias_mp as $cat) {
        $options_categorias .= "<option value='" . $cat->id_categoria . "'>" . $cat->categoria . "</option>";
    }
    $PRINCIPAL                    = str_replace("{CATEGORIAS_FORM}", utf8_encode($options_categorias), $PRINCIPAL);
    // notificaciones sin ver
    // Mis Notificaciones
    $com_mp_mis_notificaciones    = mp_interacciones_notificaciones_home($rut, $id_empresa, "");
    //print_r($com_mp_mis_notificaciones); echo "5613";
    $cuenta_notificaciones        = 0;
    $cuenta_notificaciones_sinver = 0;
    $total_notificaciones         = "";
    foreach ($com_mp_mis_notificaciones as $com_mp_mi_notificacion) {
        $muestra = 0;
        $cuenta_notificaciones++;
        $ico   = "";
        $texto = "";
        if ($com_mp_mi_notificacion->tipo == "COMENTARIO") {
            $ico = '<i class="icon-speech icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small>';
            if ($com_mp_mi_notificacion->rutAutor == $Rut_Perfil) {
                $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut_remitente . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreRemitente . '</strong>
                    </a> coment&oacute;:
                     tu publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
                if ($com_mp_mi_notificacion->visto_autor === null or $com_mp_mi_notificacion->visto_autor <> 1) {
                    $cuenta_notificaciones_sinver++;
                    $muestra = 1;
                }
            } else {
                $texto = 'Comentaste la publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '">
                    <strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a>  ';
            }
        }
        if ($com_mp_mi_notificacion->tipo == "SEGUIDO" and $Rut_Perfil <> $com_mp_mi_notificacion->rut_remitente) {
            $ico = '<i class="icon-user icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
            if ($com_mp_mi_notificacion->rut_remitenteAutor == $Rut_Perfil) {
                $texto = 'Seguiste a <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a>';
            } else {
                $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut_remitente . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreRemitente . '</strong> te sigue';
                if ($com_mp_mi_notificacion->visto === null or $com_mp_mi_notificacion->visto <> 1 and $com_mp_mi_notificacion->rut_remitente <> $Rut_Perfil) {
                    $cuenta_notificaciones_sinver++;
                    $muestra = 1;
                }
            }
        }
        //publicaciones sin ver
        //echo "<br> rut $Rut_Perfil==".$com_mp_mi_notificacion->rut_remitente;
        if ($com_mp_mi_notificacion->tipo == "PUBLICACION_SEGUIDO" and $Rut_Perfil == $com_mp_mi_notificacion->rut_remitente) {
            if ($com_mp_mi_notificacion->rut_remitenteAutor <> $Rut_Perfil) {
                $ico   = '<i class="icon-user icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
                //echo "<br> sigues a que publico ".$com_mp_mi_notificacion->rut_autor;
                //exit();
                $texto = $com_mp_mi_notificacion->NombreAutor . ' ha publicado
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '">
                    <strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a>  ';
                //echo "$com_mp_mi_notificacion->visto_remitente===null or $com_mp_mi_notificacion->visto_remitente<>1 and $com_mp_mi_notificacion->rut_remitente==$Rut_Perfil";
                if ($com_mp_mi_notificacion->visto_remitente === null or $com_mp_mi_notificacion->visto_remitente <> 1 and $com_mp_mi_notificacion->rut_remitente == $Rut_Perfil) {
                    $cuenta_notificaciones_sinver++;
                    $muestra = 1;
                }
            }
        }
        if ($com_mp_mi_notificacion->tipo == "MEGUSTA") {
            $ico = '<i class="icon-thumbs-up icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
            if ($com_mp_mi_notificacion->rut == $Rut_Perfil) {
                $texto = 'Te gusta la publicaci&oacute;n <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '">
                    <strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
            } else {
                $texto = 'A <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a> le Gusta tu publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
                if ($com_mp_mi_notificacion->visto_autor === null or $com_mp_mi_notificacion->visto_autor <> 1) {
                    $cuenta_notificaciones_sinver++;
                    $muestra = 1;
                }
            }
        }
        if ($com_mp_mi_notificacion->tipo == "GRUPOSEGUIDO") {
            $ico = '<i class="icon-people icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
            if ($com_mp_mi_notificacion->rut == $Rut_Perfil) {
                $texto = 'Seguiste el Grupo de Inter&eacute;s
                    <a href="?sw=com_mp_personal&amb=mp_cat&idcat=' . $com_mp_mi_notificacion->contenido . '&cat=' . $com_mp_mi_notificacion->NombreCategoria . '">
                    <strong>' . $com_mp_mi_notificacion->NombreCategoria . '</strong></a>
                    ';
            }
        }
        if ($com_mp_mi_notificacion->tipo == "COMPARTIDOCONMIGO") {
            $ico = '<i class="icon-share icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
            if ($com_mp_mi_notificacion->rut <> $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente <> $Rut_Perfil and $com_mp_mi_notificacion->rut == $com_mp_mi_notificacion->rut_remitente) {
                $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a> guard&oacute; tu publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
                if ($com_mp_mi_notificacion->visto_autor === null or $com_mp_mi_notificacion->visto_autor <> 1) {
                    $cuenta_notificaciones_sinver++;
                    $muestra = 1;
                }
            } elseif ($com_mp_mi_notificacion->rut == $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente == $Rut_Perfil) {
                $texto = 'Guardaste la publicaci&oacute;n <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '">
                    <strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
            } elseif ($com_mp_mi_notificacion->rut == $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente <> $Rut_Perfil) {
                $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreRemitente . '</strong>
                    </a> comparti&oacute; contigo la publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a>';
                if ($com_mp_mi_notificacion->visto === null or $com_mp_mi_notificacion->visto <> 1) {
                    $cuenta_notificaciones_sinver++;
                    $muestra = 1;
                }
            } elseif ($com_mp_mi_notificacion->rut <> $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente == $Rut_Perfil) {
                $texto = 'Compartiste con <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a> la publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a>
                    ';
            }
        }
        if ($muestra == 1 and $cuenta_notificaciones_sinver <= 10) {
            $total_notificaciones .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_perfil_mis_notificaciones_mini.html");
            $total_notificaciones = str_replace("{ICO}", ($ico), $total_notificaciones);
            $total_notificaciones = str_replace("{TEXTO}", ($texto), $total_notificaciones);
        }
    }
    $PRINCIPAL = str_replace("{MI_RUT}", $rut, $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_COMP_MP_MIS_NOTIFICACIONES_SIN_VER}", utf8_encode($total_notificaciones), $PRINCIPAL);
    if ($cuenta_notificaciones_sinver > 0) {
        $PRINCIPAL = str_replace("{NUM_NOTIFICACIONES_SINVER_GLOBO}", "<span class='badge_bell badge-default-bell'>" . $cuenta_notificaciones_sinver . " </span> ", $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{NUM_NOTIFICACIONES_SINVER_GLOBO}", "", $PRINCIPAL);
    }
    $PRINCIPAL = str_replace("{COMP_MP_PUBLICACIONES_TOTALES}", $mp_comp_estadistica[0]->CuentaPublicaciones, $PRINCIPAL);
    $PRINCIPAL = str_replace("{COMP_MP_PUBLICACIONES_TOTALES}", $mp_comp_estadistica[0]->CuentaPublicaciones, $PRINCIPAL);
    $PRINCIPAL = str_replace("{COMP_MP_VISTAS_TOTALES}", $mp_comp_estadistica[0]->CuentaVisitas, $PRINCIPAL);
    $PRINCIPAL = str_replace("{COMP_MP_FAVORITAS_TOTALES}", $mp_comp_estadistica[0]->CuentaFavoritas, $PRINCIPAL);
    $PRINCIPAL = str_replace("{COMP_MP_MEGUSTA_TOTALES}", $mp_comp_estadistica[0]->CuentaMeGusta, $PRINCIPAL);
    return ($PRINCIPAL);
}


function Agradecer_personal_lista($PRINCIPAL, $id_empresa, $rut, $ord_by, $filt_by, $filt_cat, $vp, $tag, $rut_enviado, $tipo_query, $ambiente, $start_limit, $subcategoria)
{
    if ($rut_enviado <> '') {
        $Rut_Perfil = $rut_enviado;
    } else {
        $Rut_Perfil = $rut;
    }
    $array_MP_template = MP_BuscaTemplate($rut, $id_empresa);
    if ($array_MP_template[0]->template <> '') {
        $template = $array_MP_template[0]->template . "/";
    } else {
        $template = "";
    }
    if ($tipo_query <> '') {
        $todas                                  = com_mp_resultados_inteligentes($id_empresa, $tipo_query, "", $ambiente, $subcategoria);
        $total_listado_post_personas_resultados = "";
        foreach ($todas as $unico) {
            $tpi++;
            $guardo_codigo[$tpi] = $unico->codigo;
            $total_listado_post_personas_resultados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_persona_listado_tipoE_Agradecer.html");
            $total_listado_post_personas_resultados = str_replace("{HUINCHA_INTERACCIONES}", "", $total_listado_post_personas_resultados);
            $datos_interaccion_personal             = TraeBuscaInteraccionPersonal($unico->codigo, $id_empresa);
            if ($datos_interaccion_personal[0]->numbcicoins == "") {
                $num_coins = 0;
            } else {
                $num_coins = $datos_interaccion_personal[0]->numbcicoins;
            }
            if ($datos_interaccion_personal[0]->numaptitudesvalidadas == "") {
                $num_aptitudes = 0;
            } else {
                $num_aptitudes = $datos_interaccion_personal[0]->numaptitudesvalidadas;
            }
            if ($datos_interaccion_personal[0]->numpublicaciones == "") {
                $num_publicaciones = 0;
            } else {
                $num_publicaciones = $datos_interaccion_personal[0]->numpublicaciones;
            }
            if ($datos_interaccion_personal[0]->numseguidores == "") {
                $num_seguidores = 0;
            } else {
                $num_seguidores = $datos_interaccion_personal[0]->numseguidores;
            }
            $total_listado_post_personas_resultados = str_replace("{NUM_BCICOINS}", $num_coins, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUM_SEGUIDORES}", $num_seguidores, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUM_SEGUIDOS}", $datos_interaccion_personal[0]->numseguidos, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUM_PUBLICACIONES}", $num_publicaciones, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUM_MEGUSTA_FAVORITAS}", $datos_interaccion_personal[0]->nummegustafavorita, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUM_VISITAS}", $datos_interaccion_personal[0]->numvisitas, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUM_COMENTARIOS}", $datos_interaccion_personal[0]->numcomentarios, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUM_APTITUDESVALIDADAS}", $num_aptitudes, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUM_PUBLICACIONESSEGUIDAS}", $datos_interaccion_personal[0]->publicacionesseguidas, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUM_INTERACCIONES}", $datos_interaccion_personal[0]->numinteracciones, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{RUTEXPERTO}", $unico->codigo, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{CARGO_EXPERTO}", $unico->cargo_experto, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NOMBRE_EXPERTO}", $unico->nombre_experto, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($unico->codigo), $total_listado_post_personas_resultados);
            $array_Reco_Gracias                     = BuscaDatosReconocimientoAgradecimientos($unico->codigo, $id_empresa);
            if ($array_Reco_Gracias[0]->num_gracias > 0) {
                $num_gracias = $array_Reco_Gracias[0]->num_gracias;
            } else {
                $num_gracias = 0;
            }
            if ($array_Reco_Gracias[0]->num_reconocimientos > 0) {
                $num_reconocimientos = $array_Reco_Gracias[0]->num_reconocimientos;
            } else {
                $num_reconocimientos = 0;
            }
            //echo $array_Reco_Gracias->num_reconocimientos;
            $total_listado_post_personas_resultados = str_replace("{NUM_GRACIAS}", ($num_gracias), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUM_RECONOCIMIENTOS}", ($num_reconocimientos), $total_listado_post_personas_resultados);
            if ($unico->tipo == "MejorPractica") {
                $ico = "img/bci_mp_practica_icon.png";
            }
            if ($unico->tipo == "Papers") {
                $ico = "img/bci_mp_paper_icon.png";
            }
            if ($unico->tipo == "Publicacion") {
                $ico = "img/bci_mp_publicacion.png";
            }
            if ($unico->tipo == "Video" or $unico->tipo == "VideoInterno") {
                $ico = "img/bci_mp_practica_video.png";
            }
            if ($unico->tipo == "Links" or $unico->tipo == "LinkExterno") {
                $ico = "img/bci_mp_link_icon.png";
            }
            if ($unico->tipo == "Experiencias") {
                $ico = "img/bci_mp_experiencias_icon.png";
            }
            if ($unico->tipopost == "expertos") {
                $ico = "img/bci_mp_experto_icon.png";
            }
            if ($unico->tipo == "OportunidadMejora") {
                $ico = "img/bci_mp_oportunidadmejora_icon.png";
            }
            if ($unico->tipo == "Udnolohaga") {
                $ico = "img/bci_mp_udnolohaga_icon.png";
            }
            if ($unico->tipo == "RRPP") {
                $ico = "img/bci_mp_rrpp_icon.png";
            }
            if ($unico->tipo == "Pregunta") {
                $ico = "img/bci_mp_pregunta_icon.png";
            }
            if ($unico->tipo == "Respuesta") {
                $ico = "img/bci_mp_pregunta_icon.png";
            }
            $total_listado_post_personas_resultados = str_replace("{NOMBRE_MENTOR}", ($mentor), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{ICONO}", $ico, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{DESC_ICONO}", $unico->tipo, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = ColocaCantidadDeFavorito($total_listado_post_personas_resultados, $unico->id_mp, $id_empresa);
            $total_listado_post_personas_resultados = str_replace("{ID_MP}", $unico->codigo, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{LINK}", $link_MP, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($unico->descripcion_categoria), $total_listado_post_personas_resultados);
            if ($unico->resumen == "" and $unico->contenido == "") {
                $resumen = ($unico->resumen);
            } elseif ($unico->resumen <> "" and $unico->contenido == "") {
                $resumen = ($unico->resumen);
            } elseif ($unico->resumen == "" and $unico->contenido <> "") {
                $resumen = limit_text($unico->contenido, 35);
            } elseif ($unico->resumen <> "" and $unico->contenido <> "") {
                $resumen = ($unico->resumen);
            } else {
                $resumen = "";
            }
            if ($unico->tipopost <> 'expertos') {
                $total_listado_post_personas_resultados = str_replace("{NOMBRE}", ($unico->nombre), $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{CATEGORIA_MP}", $post_categoria, $total_listado_post_personas_resultados);
                $post_ambito                            = '<a href="?sw=com_mp_personal&amb=mp_amb&idamb=' . $unico->id_ambito . '&ambito=' . $unico->ambito . '">
<span class="badge_small badge-azul"><span class="blanco"><i class="icon-people icons"></i> ' . $unico->ambito . '</span></span></a>';
                $total_listado_post_personas_resultados = str_replace("{AMBITO_MP}", $post_ambito, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{RUT_AUTOR}", ($unico->rut), $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($unico->rut), $total_listado_post_personas_resultados);
                $link                                   = "?sw=com_mp_full&id_mp=" . $unico->codigo . "";
            } else {
                $total_listado_post_personas_resultados = str_replace("{NOMBRE}", ("$resumen"), $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{CATEGORIA_MP}", $post_categoria, $total_listado_post_personas_resultados);
                $post_ambito                            = '<a href="?sw=com_mp_personal&amb=mp_amb&idamb=' . $unico->id_ambito . '&ambito=' . $unico->ambito . '">
<span class="badge_small badge-azul"><span class="blanco"><i class="icon-people icons"></i> ' . $unico->ambito . '</span></span></a>';
                $total_listado_post_personas_resultados = str_replace("{AMBITO_MP}", $post_ambito, $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{RUT_AUTOR}", ($unico->contenido), $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($unico->codigo), $total_listado_post_personas_resultados);
                $link                                   = "?sw=com_mp_personal&rut_enviado=" . $unico->codigo . "&vp=1&mp=1";
            }
            $tiene_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $unico->codigo, "MEGUSTA", $rut);
            if ($tiene_megusta) {
                $total_listado_post_personas_resultados = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta.html"), $total_listado_post_personas_resultados);
            } else {
                $total_listado_post_personas_resultados = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta.html"), $total_listado_post_personas_resultados);
            }
            $total_listado_post_personas_resultados = ColocaCantidadDeMegusta($total_listado_post_personas_resultados, $unico->codigo, $id_empresa);
            //$total_listado_post_personas_resultados =ColocaCantidadDeNoMegusta($total_listado_post_personas_resultados , $unico->codigo, $id_empresa);
            $total_listado_post_personas_resultados = str_replace("{TIPO}", "A", $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{ID_MP}", ($unico->codigo), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{CONTENIDO}", $resumen, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{FECHA}", formatearFechaSmall($unico->fecha), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{ESTADO}", ($unico->estado), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{DESCRIPCION_ESTADO}", ($unico->descripcion_estado), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{RUT}", ($rut), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NOMBRE_AUTOR}", ($unico->nombre_autor), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUMVISITAS}", round($unico->numvisitas), $total_listado_post_personas_resultados);
            //$total_listado_post_personas_resultados = str_replace("{NUMMEGUSTA}",($unico->nummegusta),$total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUMNOMEGUSTA}", ($unico->numnomegusta), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUMCOMPARTIDA}", ($unico->numcompartido), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUMCOMENTARIO}", ($unico->numcomentarios), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUMCOMENTARIOSREALES}", ($unico->numcomentariosreales), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{NUMFAVORITA}", ($unico->numfavorita), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{ESTILOESTADO}", ($unico->estilo), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{ICONOESTADO}", ($unico->icono_estado), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{ESTILOCATEGORIA}", ($unico->style), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{ICONOCATEGORIA}", ($unico->icono), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{CATEGORIA_MP}", ($unico->categoria), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{LINK}", ($link), $total_listado_post_personas_resultados);
            if ($unico->tipo_multimedia == "imagen") {
                $imagen = "../../front/multimedia/" . $unico->multimedia;
            } else {
                $imagen = "";
            }
            if ($unico->tipo_multimedia == "video") {
                $video = "../../front/multimedia/" . $unico->multimedia;
            } else {
                $video = "";
            }
            $total_listado_post_personas_resultados = str_replace("{IMAGEN_POST}", "multimedia/" . $unico->imagenfondo, $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{VIDEO}", ($video), $total_listado_post_personas_resultados);
            $total_listado_post_personas_resultados = str_replace("{TIPOMULTIMEDIA}", ($unico->tipo_multimedia), $total_listado_post_personas_resultados);
            $listado_comentarios                    = MuestraComentariosPorPost($unico->id_mp);
            $total_listado_post_personas_resultados = str_replace("{BLOQUE_COMENTARIOS}", $listado_comentarios, $total_listado_post_personas_resultados);
            if ($unico->url_documento) {
                $total_listado_post_personas_resultados = str_replace("{BLOQUE_URL_DOCUMENTO}", file_get_contents("views/comunidad_mp/row_com_mp_url_documento.html"), $total_listado_post_personas_resultados);
                $total_listado_post_personas_resultados = str_replace("{URL_DOCUMENTO}", ($unico->url_documento), $total_listado_post_personas_resultados);
            } else {
                $total_listado_post_personas_resultados = str_replace("{BLOQUE_URL_DOCUMENTO}", "", $total_listado_post_personas_resultados);
            }
            //echo "<br> video".$unico->video." imagen".$unico->imagenfondo;
            if ($unico->video) {
                $video_youtube                          = ColocaVideoYoutube($unico->video, $unico->id_mp);
                $total_listado_post_personas_resultados = str_replace("{VIDEO_IMAGEN}", $video_youtube, $total_listado_post_personas_resultados);
            } elseif ($unico->imagenfondo) {
                $bloque_imagen_fondo                    = ColocaImagenPost($unico->imagenfondo);
                $total_listado_post_personas_resultados = str_replace("{VIDEO_IMAGEN}", $bloque_imagen_fondo, $total_listado_post_personas_resultados);
            } else {
                $total_listado_post_personas_resultados = str_replace("{VIDEO_IMAGEN}", "", $total_listado_post_personas_resultados);
            }
            $total_listado_post_personas_resultados = str_replace("{TITULO_R}", $tituloR, $total_listado_post_personas_resultados);
            //tags por post
            $TagsPorPosts                           = TagsPorMPEmpresa($unico->codigo, $id_empresa);
            $tag_por_post                           = "";
            foreach ($TagsPorPosts as $TagsPorPost) {
                $tag_por_post .= '<a href="?sw=com_mp_personal&amb=mp_tag&tag=' . $TagsPorPost->tag . '"><span class="badge_small badge-white"><span class="negro">#' . $TagsPorPost->tag . '</span></span></a> ';
            }
            $total_listado_post_personas_resultados = str_replace("{TAGS_POR_POST}", ($tag_por_post), $total_listado_post_personas_resultados);
        }
        // no encontraste resultados?
        $mp_hacerpregunta .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_hacer_pregunta.html");
        $mp_hacerpregunta = str_replace("{PREGUNTA}", $tipo_query, $mp_hacerpregunta);
    }
    //AMBIENTE VIDEOS
    //if($ambiente=="videos"){
    if ($id_empresa == 53) {
        //TIMELINE TIPO VIDEOS
        $todas                              = com_mp_lista_personal($id_empresa, $Rut_Perfil, $ord_by, $filt_by, $filt_cat, $vp, $arreglo_tag, $tag, $rut_enviado, "recientes", "6");
        $total_listado_post_tipo_new_videos = "";
        foreach ($todas as $unico) {
            if ($unico->id == 297)
                continue;
            //echo "id ".$unico->video." or ".$unico->imagenfondo." ";
            if ($unico->video <> '') {
                //echo "tipoA_1";
                $total_listado_post_tipo_new_videos .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_persona_listado_tipoV.html");
            } else {
                continue;
            }
            $tiene_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $unico->id_mp, "MEGUSTA", $rut);
            if ($tiene_megusta) {
                $total_listado_post_tipo_new_videos = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta.html"), $total_listado_post_tipo_new_videos);
            } else {
                $total_listado_post_tipo_new_videos = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta.html"), $total_listado_post_tipo_new_videos);
            }
            $total_listado_post_tipo_new_videos = ColocaCantidadDeMegusta($total_listado_post_tipo_new_videos, $unico->id_mp, $id_empresa);
            $tiene_favorito                     = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $unico->id_mp, "FAVORITA", $rut);
            if ($tiene_favorito) {
                $total_listado_post_tipo_new_videos = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_favorito.html"), $total_listado_post_tipo_new_videos);
            } else {
                $total_listado_post_tipo_new_videos = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_favorito.html"), $total_listado_post_tipo_new_videos);
            }
            $total_listado_post_tipo_new_videos = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_listado_post_tipo_new_videos);
            $total_listado_post_tipo_new_videos = ColocaCantidadDeFavorito($total_listado_post_tipo_new_videos, $unico->id_mp, $id_empresa);
            $total_listado_post_tipo_new_videos = str_replace("{ID_MP}", $unico->id_mp, $total_listado_post_tipo_new_videos);
            $total_listado_post_tipo_new_videos = str_replace("{LINK}", $link_MP, $total_listado_post_tipo_new_videos);
            $total_listado_post_tipo_new_videos = str_replace("{CATEGORIA_MP}", ($unico->categoria), $total_listado_post_tipo_new_videos);
            $total_listado_post_tipo_new_videos = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($unico->descripcion_categoria), $total_listado_post_tipo_new_videos);
            $total_listado_post_tipo_new_videos = str_replace("{NOMBRE}", ($unico->nombre), $total_listado_post_tipo_new_videos);
            $total_listado_post_tipo_new_videos = str_replace("{CONTENIDO}", limit_text($unico->contenido, 35), $total_listado_post_tipo_new_videos);
            $total_listado_post_tipo_new_videos = str_replace("{FECHA}", formatearFechaSmall($unico->fecha), $total_listado_post_tipo_new_videos);
            $total_listado_post_tipo_new_videos = str_replace("{ESTADO}", ($unico->estado), $total_listado_post_tipo_new_videos);
            $total_listado_post_tipo_new_videos = str_replace("{DESCRIPCION_ESTADO}", ($unico->descripcion_estado), $total_listado_post_tipo_new_videos);
            $total_listado_post_tipo_new_videos = str_replace("{RUT_AUTOR}", ($unico->rut), $total_listado_post_tipo_new_videos);
            $total_listado_post_tipo_new_videos = str_replace("{RUT}", ($rut), $total_listado_post_tipo_new_videos);
            $total_listado_post_tipo_new_videos = str_replace("{NOMBRE_AUTOR}", ($unico->nombre_autor), $total_listado_post_tipo_new_videos);
            $total_listado_post_tipo_new_videos = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($unico->rut), $total_listado_post_tipo_new_videos);
            $total_listado_post_tipo_new_videos = str_replace("{NUMVISITAS}", round($unico->numvisitas), $total_listado_post_tipo_new_videos);
            $total_listado_post_tipo_new_videos = str_replace("{NUMMEGUSTA}", ($unico->nummegusta), $total_listado_post_tipo_new_videos);
            $total_listado_post_tipo_new_videos = str_replace("{NUMCOMPARTIDA}", ($unico->numcompartido), $total_listado_post_tipo_new_videos);
            $total_listado_post_tipo_new_videos = str_replace("{NUMCOMENTARIO}", ($unico->numcomentarios), $total_listado_post_tipo_new_videos);
            $total_listado_post_tipo_new_videos = str_replace("{NUMCOMENTARIOSREALES}", ($unico->numcomentariosreales), $total_listado_post_tipo_new_videos);
            $total_listado_post_tipo_new_videos = str_replace("{NUMFAVORITA}", ($unico->numfavorita), $total_listado_post_tipo_new_videos);
            $total_listado_post_tipo_new_videos = str_replace("{ESTILOESTADO}", ($unico->estilo), $total_listado_post_tipo_new_videos);
            $total_listado_post_tipo_new_videos = str_replace("{ICONOESTADO}", ($unico->icono_estado), $total_listado_post_tipo_new_videos);
            $total_listado_post_tipo_new_videos = str_replace("{ESTILOCATEGORIA}", ($unico->style), $total_listado_post_tipo_new_videos);
            $total_listado_post_tipo_new_videos = str_replace("{ICONOCATEGORIA}", ($unico->icono), $total_listado_post_tipo_new_videos);
            $total_listado_post_tipo_new_videos = str_replace("{CATEGORIA_MP}", ($unico->categoria), $total_listado_post_tipo_new_videos);
            if ($unico->tipo_multimedia == "imagen" and $unico->imagen_fondo <> '') {
                $imagen = "../../front/multimedia/" . $unico->multimedia;
            } else {
                $imagen = "";
            }
            if ($unico->tipo_multimedia == "video") {
                $video = "../../front/multimedia/" . $unico->multimedia;
            } else {
                $video = "";
            }
            $total_listado_post_tipo_new_videos = str_replace("{IMAGEN_POST}", "multimedia/" . $unico->imagenfondo, $total_listado_post_tipo_new_videos);
            $total_listado_post_tipo_new_videos = str_replace("{VIDEO}", ($video), $total_listado_post_tipo_new_videos);
            $total_listado_post_tipo_new_videos = str_replace("{TIPOMULTIMEDIA}", ($unico->tipo_multimedia), $total_listado_post_tipo_new_videos);
            $listado_comentarios                = MuestraComentariosPorPost($unico->id_mp);
            $total_listado_post_tipo_new_videos = str_replace("{BLOQUE_COMENTARIOS}", $listado_comentarios, $total_listado_post_tipo_new_videos);
            if ($unico->url_documento) {
                $total_listado_post_tipo_new_videos = str_replace("{BLOQUE_URL_DOCUMENTO}", file_get_contents("views/comunidad_mp/row_com_mp_url_documento.html"), $total_listado_post_tipo_new_videos);
                $total_listado_post_tipo_new_videos = str_replace("{URL_DOCUMENTO}", ($unico->url_documento), $total_listado_post_tipo_new_videos);
            } else {
                $total_listado_post_tipo_new_videos = str_replace("{BLOQUE_URL_DOCUMENTO}", "", $total_listado_post_tipo_new_videos);
            }
            if ($unico->video) {
                $video_youtube                      = ColocaVideoYoutube($unico->video, $unico->id_mp);
                $total_listado_post_tipo_new_videos = str_replace("{VIDEO_IMAGEN}", $video_youtube, $total_listado_post_tipo_new_videos);
            } else {
                $bloque_imagen_fondo                = ColocaImagenPost($unico->imagenfondo);
                $total_listado_post_tipo_new_videos = str_replace("{VIDEO_IMAGEN}", $bloque_imagen_fondo, $total_listado_post_tipo_new_videos);
            }
        }
    }
    //AMBIENTE BIG
    //if($ambiente=="big"){
    //exit;
    //TIMELINE TIPO NEW BIG
    if ($id_empresa == 53) {
        //echo "<br><br>";
        //$todas=com_mp_lista_personal($id_empresa, $Rut_Perfil, $ord_by, $filt_by, $filt_cat, $vp,$arreglo_tag, $tag, $rut_enviado, "recientes","1","1","1");
        $todas = NoticiaBig();
    }
    $total_listado_post_tipo_news_big = "";
    foreach ($todas as $unico) {
        //echo "id ".$unico->video." or ".$unico->imagenfondo." ";
        if ($unico->video <> '' or $unico->imagenfondo <> '') {
            //echo "tipoA_1";
            $total_listado_post_tipo_news_big .= file_get_contents("views/comunidad_mp/row_com_mp_persona_listado_tipoN.html");
        } else {
            //echo "tipoA";
            $total_listado_post_tipo_news_big .= file_get_contents("views/comunidad_mp/row_com_mp_persona_listado_tipoN.html");
        }
        $tiene_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $unico->id_mp, "MEGUSTA", $rut);
        if ($tiene_megusta) {
            $total_listado_post_tipo_news_big = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta.html"), $total_listado_post_tipo_news_big);
        } else {
            $total_listado_post_tipo_news_big = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta.html"), $total_listado_post_tipo_news_big);
        }
        $total_listado_post_tipo_news_big = ColocaCantidadDeMegusta($total_listado_post_tipo_news_big, $unico->id_mp, $id_empresa);
        $tiene_favorito                   = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $unico->id_mp, "FAVORITA", $rut);
        if ($tiene_favorito) {
            $total_listado_post_tipo_news_big = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_favorito.html"), $total_listado_post_tipo_news_big);
        } else {
            $total_listado_post_tipo_news_big = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_favorito.html"), $total_listado_post_tipo_news_big);
        }
        $total_listado_post_tipo_news_big = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_listado_post_tipo_news_big);
        $total_listado_post_tipo_news_big = ColocaCantidadDeFavorito($total_listado_post_tipo_news_big, $unico->id_mp, $id_empresa);
        $total_listado_post_tipo_news_big = str_replace("{ID_MP}", $unico->id_mp, $total_listado_post_tipo_news_big);
        $total_listado_post_tipo_news_big = str_replace("{LINK}", $link_MP, $total_listado_post_tipo_news_big);
        $total_listado_post_tipo_news_big = str_replace("{CATEGORIA_MP}", ($unico->categoria), $total_listado_post_tipo_news_big);
        $total_listado_post_tipo_news_big = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($unico->descripcion_categoria), $total_listado_post_tipo_news_big);
        $total_listado_post_tipo_news_big = str_replace("{NOMBRE}", ($unico->nombre), $total_listado_post_tipo_news_big);
        $total_listado_post_tipo_news_big = str_replace("{CONTENIDO}", limit_text($unico->contenido, 35), $total_listado_post_tipo_news_big);
        $total_listado_post_tipo_news_big = str_replace("{FECHA}", formatearFechaSmall($unico->fecha), $total_listado_post_tipo_news_big);
        $total_listado_post_tipo_news_big = str_replace("{ESTADO}", ($unico->estado), $total_listado_post_tipo_news_big);
        $total_listado_post_tipo_news_big = str_replace("{DESCRIPCION_ESTADO}", ($unico->descripcion_estado), $total_listado_post_tipo_news_big);
        $total_listado_post_tipo_news_big = str_replace("{RUT_AUTOR}", ($unico->rut), $total_listado_post_tipo_news_big);
        $total_listado_post_tipo_news_big = str_replace("{RUT}", ($rut), $total_listado_post_tipo_news_big);
        $total_listado_post_tipo_news_big = str_replace("{NOMBRE_AUTOR}", ($unico->nombre_autor), $total_listado_post_tipo_news_big);
        $total_listado_post_tipo_news_big = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($unico->rut), $total_listado_post_tipo_news_big);
        $total_listado_post_tipo_news_big = str_replace("{NUMVISITAS}", round($unico->numvisitas), $total_listado_post_tipo_news_big);
        $total_listado_post_tipo_news_big = str_replace("{NUMMEGUSTA}", ($unico->nummegusta), $total_listado_post_tipo_news_big);
        $total_listado_post_tipo_news_big = str_replace("{NUMCOMPARTIDA}", ($unico->numcompartido), $total_listado_post_tipo_news_big);
        $total_listado_post_tipo_news_big = str_replace("{NUMCOMENTARIO}", ($unico->numcomentarios), $total_listado_post_tipo_news_big);
        $total_listado_post_tipo_news_big = str_replace("{NUMCOMENTARIOSREALES}", ($unico->numcomentariosreales), $total_listado_post_tipo_news_big);
        $total_listado_post_tipo_news_big = str_replace("{NUMFAVORITA}", ($unico->numfavorita), $total_listado_post_tipo_news_big);
        $total_listado_post_tipo_news_big = str_replace("{ESTILOESTADO}", ($unico->estilo), $total_listado_post_tipo_news_big);
        $total_listado_post_tipo_news_big = str_replace("{ICONOESTADO}", ($unico->icono_estado), $total_listado_post_tipo_news_big);
        $total_listado_post_tipo_news_big = str_replace("{ESTILOCATEGORIA}", ($unico->style), $total_listado_post_tipo_news_big);
        $total_listado_post_tipo_news_big = str_replace("{ICONOCATEGORIA}", ($unico->icono), $total_listado_post_tipo_news_big);
        $total_listado_post_tipo_news_big = str_replace("{CATEGORIA_MP}", ($unico->categoria), $total_listado_post_tipo_news_big);
        if ($unico->tipo_multimedia == "imagen" and $unico->imagen_fondo <> '') {
            $imagen = "../../front/multimedia/" . $unico->multimedia;
        } else {
            $imagen = "";
        }
        if ($unico->tipo_multimedia == "video") {
            $video = "../../front/multimedia/" . $unico->multimedia;
        } else {
            $video = "";
        }
        $total_listado_post_tipo_news_big = str_replace("{IMAGEN_POST}", "multimedia/" . $unico->imagenfondo, $total_listado_post_tipo_news_big);
        $total_listado_post_tipo_news_big = str_replace("{VIDEO}", ($video), $total_listado_post_tipo_news_big);
        $total_listado_post_tipo_news_big = str_replace("{TIPOMULTIMEDIA}", ($unico->tipo_multimedia), $total_listado_post_tipo_news_big);
        $listado_comentarios              = MuestraComentariosPorPost($unico->id_mp);
        $total_listado_post_tipo_news_big = str_replace("{BLOQUE_COMENTARIOS}", $listado_comentarios, $total_listado_post_tipo_news_big);
        if ($unico->url_documento) {
            $total_listado_post_tipo_news_big = str_replace("{BLOQUE_URL_DOCUMENTO}", file_get_contents("views/comunidad_mp/row_com_mp_url_documento.html"), $total_listado_post_tipo_news_big);
            $total_listado_post_tipo_news_big = str_replace("{URL_DOCUMENTO}", ($unico->url_documento), $total_listado_post_tipo_news_big);
        } else {
            $total_listado_post_tipo_news_big = str_replace("{BLOQUE_URL_DOCUMENTO}", "", $total_listado_post_tipo_news_big);
        }
        if ($unico->video) {
            $video_youtube                    = ColocaVideoYoutube($unico->video, $unico->id_mp);
            $total_listado_post_tipo_news_big = str_replace("{VIDEO_IMAGEN}", $video_youtube, $total_listado_post_tipo_news_big);
        } else {
            $bloque_imagen_fondo              = ColocaImagenPost($unico->imagenfondo);
            $total_listado_post_tipo_news_big = str_replace("{VIDEO_IMAGEN}", $bloque_imagen_fondo, $total_listado_post_tipo_news_big);
        }
        $TagsPorPosts = TagsPorMPEmpresa($unico->id_mp, $id_empresa);
        $tag_por_post = "";
        foreach ($TagsPorPosts as $TagsPorPost) {
            $tag_por_post .= '<a href="?sw=com_mp_personal&amb=mp_tag&tag=' . $TagsPorPost->tag . '"><span class="badge_small badge-white"><span class="negro">#' . $TagsPorPost->tag . '</span></span></a> ';
        }
        $total_listado_post_tipo_news_big = str_replace("{TAGS_POR_POST}", ($tag_por_post), $total_listado_post_tipo_news_big);
    }
    //}
    //AMBIENTE 3 POST
    //if($ambiente=="3post"){
    if ($id_empresa == 53) {
        //$todas=com_mp_lista_personal($id_empresa, $Rut_Perfil, $ord_by, $filt_by, $filt_cat, $vp,$arreglo_tag, $tag, $rut_enviado, "recientes","2", "3", "1");
        $todos                              = NoticiaBig2();
        $total_listado_post_tipo_news_3post = "";
        foreach ($todos as $unico) {
            //echo "id ".$unico->video." or ".$unico->imagenfondo." ";
            if ($unico->video <> '' or $unico->imagenfondo <> '') {
                //echo "tipoA_1";
                $total_listado_post_tipo_news_3post .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_persona_listado_tipoN1.html");
            } else {
                //echo "tipoA";
                $total_listado_post_tipo_news_3post .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_persona_listado_tipoN1.html");
            }
            $tiene_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $unico->id_mp, "MEGUSTA", $rut);
            if ($tiene_megusta) {
                $total_listado_post_tipo_news_3post = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta.html"), $total_listado_post_tipo_news_3post);
            } else {
                $total_listado_post_tipo_news_3post = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta.html"), $total_listado_post_tipo_news_3post);
            }
            $total_listado_post_tipo_news_3post = ColocaCantidadDeMegusta($total_listado_post_tipo_news_3post, $unico->id_mp, $id_empresa);
            $tiene_favorito                     = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $unico->id_mp, "FAVORITA", $rut);
            if ($tiene_favorito) {
                $total_listado_post_tipo_news_3post = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_favorito.html"), $total_listado_post_tipo_news_3post);
            } else {
                $total_listado_post_tipo_news_3post = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_favorito.html"), $total_listado_post_tipo_news_3post);
            }
            $total_listado_post_tipo_news_3post = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_listado_post_tipo_news_3post);
            $total_listado_post_tipo_news_3post = ColocaCantidadDeFavorito($total_listado_post_tipo_news_3post, $unico->id_mp, $id_empresa);
            $total_listado_post_tipo_news_3post = str_replace("{ID_MP}", $unico->id_mp, $total_listado_post_tipo_news_3post);
            $total_listado_post_tipo_news_3post = str_replace("{LINK}", $link_MP, $total_listado_post_tipo_news_3post);
            $total_listado_post_tipo_news_3post = str_replace("{CATEGORIA_MP}", ($unico->categoria), $total_listado_post_tipo_news_3post);
            $total_listado_post_tipo_news_3post = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($unico->descripcion_categoria), $total_listado_post_tipo_news_3post);
            $total_listado_post_tipo_news_3post = str_replace("{NOMBRE}", ($unico->nombre), $total_listado_post_tipo_news_3post);
            $total_listado_post_tipo_news_3post = str_replace("{CONTENIDO}", limit_text($unico->contenido, 35), $total_listado_post_tipo_news_3post);
            $total_listado_post_tipo_news_3post = str_replace("{FECHA}", formatearFechaSmall($unico->fecha), $total_listado_post_tipo_news_3post);
            $total_listado_post_tipo_news_3post = str_replace("{ESTADO}", ($unico->estado), $total_listado_post_tipo_news_3post);
            $total_listado_post_tipo_news_3post = str_replace("{DESCRIPCION_ESTADO}", ($unico->descripcion_estado), $total_listado_post_tipo_news_3post);
            $total_listado_post_tipo_news_3post = str_replace("{RUT_AUTOR}", ($unico->rut), $total_listado_post_tipo_news_3post);
            $total_listado_post_tipo_news_3post = str_replace("{RUT}", ($rut), $total_listado_post_tipo_news_3post);
            $total_listado_post_tipo_news_3post = str_replace("{NOMBRE_AUTOR}", ($unico->nombre_autor), $total_listado_post_tipo_news_3post);
            $total_listado_post_tipo_news_3post = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($unico->rut), $total_listado_post_tipo_news_3post);
            $total_listado_post_tipo_news_3post = str_replace("{NUMVISITAS}", round($unico->numvisitas), $total_listado_post_tipo_news_3post);
            $total_listado_post_tipo_news_3post = str_replace("{NUMMEGUSTA}", ($unico->nummegusta), $total_listado_post_tipo_news_3post);
            $total_listado_post_tipo_news_3post = str_replace("{NUMCOMPARTIDA}", ($unico->numcompartido), $total_listado_post_tipo_news_3post);
            $total_listado_post_tipo_news_3post = str_replace("{NUMCOMENTARIO}", ($unico->numcomentarios), $total_listado_post_tipo_news_3post);
            $total_listado_post_tipo_news_3post = str_replace("{NUMCOMENTARIOSREALES}", ($unico->numcomentariosreales), $total_listado_post_tipo_news_3post);
            $total_listado_post_tipo_news_3post = str_replace("{NUMFAVORITA}", ($unico->numfavorita), $total_listado_post_tipo_news_3post);
            $total_listado_post_tipo_news_3post = str_replace("{ESTILOESTADO}", ($unico->estilo), $total_listado_post_tipo_news_3post);
            $total_listado_post_tipo_news_3post = str_replace("{ICONOESTADO}", ($unico->icono_estado), $total_listado_post_tipo_news_3post);
            $total_listado_post_tipo_news_3post = str_replace("{ESTILOCATEGORIA}", ($unico->style), $total_listado_post_tipo_news_3post);
            $total_listado_post_tipo_news_3post = str_replace("{ICONOCATEGORIA}", ($unico->icono), $total_listado_post_tipo_news_3post);
            $total_listado_post_tipo_news_3post = str_replace("{CATEGORIA_MP}", ($unico->categoria), $total_listado_post_tipo_news_3post);
            if ($unico->tipo_multimedia == "imagen" and $unico->imagen_fondo <> '') {
                $imagen = "../../front/multimedia/" . $unico->multimedia;
            } else {
                $imagen = "";
            }
            if ($unico->tipo_multimedia == "video") {
                $video = "../../front/multimedia/" . $unico->multimedia;
            } else {
                $video = "";
            }
            $total_listado_post_tipo_news_3post = str_replace("{IMAGEN_POST}", "multimedia/" . $unico->imagenfondo, $total_listado_post_tipo_news_3post);
            $total_listado_post_tipo_news_3post = str_replace("{VIDEO}", ($video), $total_listado_post_tipo_news_3post);
            $total_listado_post_tipo_news_3post = str_replace("{TIPOMULTIMEDIA}", ($unico->tipo_multimedia), $total_listado_post_tipo_news_3post);
            $listado_comentarios                = MuestraComentariosPorPost($unico->id_mp);
            $total_listado_post_tipo_news_3post = str_replace("{BLOQUE_COMENTARIOS}", $listado_comentarios, $total_listado_post_tipo_news_3post);
            if ($unico->url_documento) {
                $total_listado_post_tipo_news_3post = str_replace("{BLOQUE_URL_DOCUMENTO}", file_get_contents("views/comunidad_mp/row_com_mp_url_documento.html"), $total_listado_post_tipo_news_3post);
                $total_listado_post_tipo_news_3post = str_replace("{URL_DOCUMENTO}", ($unico->url_documento), $total_listado_post_tipo_news_3post);
            } else {
                $total_listado_post_tipo_news_3post = str_replace("{BLOQUE_URL_DOCUMENTO}", "", $total_listado_post_tipo_news_3post);
            }
            if ($unico->video) {
                $video_youtube                      = ColocaVideoYoutube($unico->video, $unico->id_mp);
                $total_listado_post_tipo_news_3post = str_replace("{VIDEO_IMAGEN}", $video_youtube, $total_listado_post_tipo_news_3post);
            } else {
                $bloque_imagen_fondo                = ColocaImagenPost($unico->imagenfondo);
                $total_listado_post_tipo_news_3post = str_replace("{VIDEO_IMAGEN}", $bloque_imagen_fondo, $total_listado_post_tipo_news_3post);
            }
        }
    }
    // FRASE
    // mas publicadores grupo interes 1
    $mas_grupo_interes1            = com_mp_post_rank_categorias($id_empresa, "1");
    $mas_post_rut_grupo_interes1   = com_mp_post_rank_mas_publicador_categoria($mas_grupo_interes1[0]->id_categoria, $id_empresa, $subcategoria);
    $mas_post_grupo_interes1       = com_mp_post_rank_rut_mas_publicador_categoria($mas_post_rut_grupo_interes1[0]->rut, $mas_grupo_interes1[0]->id_categoria, $id_empresa);
    $total_mas_post_grupo_interes1 = "";
    foreach ($mas_post_grupo_interes1 as $mas_post_g1) {
        $seguidores1 = $mas_post_g1->seguidores . " seguidores";
        $total_mas_post_grupo_interes1 .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_people_mini.html");
        $total_mas_post_grupo_interes1 = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($mas_post_g1->rut), $total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1 = str_replace("{ID_MP}", $mas_post_g1->id_mp, $total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1 = str_replace("{CATEGORIA_MP}", ($mas_post_g1->categoria), $total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1 = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($mas_post_g1->descripcion_categoria), $total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1 = str_replace("{NOMBRE}", ($mas_post_g1->nombre_autor), $total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1 = str_replace("{CONTENIDO}", limit_text($mas_post_g1->contenido, 35), $total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1 = str_replace("{SEGUIDORES}", $seguidores1, $total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1 = str_replace("{PUNTOS}", "", $total_mas_post_grupo_interes1);
        /*
        $total_mas_post_grupo_interes1= str_replace("{FECHA}",formatearFechaSmall($mas_post_g1->fecha),$total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1= str_replace("{ESTADO}",($mas_post_g1->estado),$total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1= str_replace("{DESCRIPCION_ESTADO}",($mas_post_g1->descripcion_estado),$total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1= str_replace("{RUT_AUTOR}",($mas_post_g1->rut),$total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1= str_replace("{RUT}",($rut),$total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1= str_replace("{NOMBRE_AUTOR}",($mas_post_g1->nombre_autor),$total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1= str_replace("{FOTO_AUTOR}",VerificaFotoPersonal($mas_post_g1->rut),$total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1= str_replace("{ESTILOESTADO}",($mas_post_g1->estilo),$total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1= str_replace("{ICONOESTADO}",($mas_post_g1->icono_estado),$total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1= str_replace("{ESTILOCATEGORIA}",($mas_post_g1->style),$total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1= str_replace("{ICONOCATEGORIA}",($mas_post_g1->icono),$total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1= str_replace("{CATEGORIA_MP}",($mas_post_g1->categoria),$total_mas_post_grupo_interes1);
        * */
        $total_mas_post_grupo_interes1 = str_replace("{NOMBRE}", ($mas_post_g1->nombre), $total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1 = str_replace("{RUT_ENVIADO}", ($mas_post_g1->rut), $total_mas_post_grupo_interes1);
        $total_mas_post_grupo_interes1 = str_replace("{ID_MP}", ($mas_post_g1->id_mp), $total_mas_post_grupo_interes1);
        // BOTON SEGUIR
        $sesiguepersona                = count(VerificandompaSeguidores($rut, $mas_post_g1->rut, $id_empresa));
        if ($sesiguepersona > 0) {
            $boton_seguir = "
<center>
    <div class='badge_small badge-verde blanco mgtop5'>
        <i class='icon-check icons'></i> Siguiendo
    </div>
    <a href='?sw=com_mp_personal&rut_enviado=" . $mas_post_g1->rut . "&vp=1&sg=2' class='badge_small bg-white_borderBlue negro'> <i class='icon-user-following icons'></i> Dejar de seguir (-)</a>
</center>
";
        } else {
            $boton_seguir = "
<center>
    <a href='?sw=com_mp_personal&rut_enviado=" . $mas_post_g1->rut . "&vp=1&sg=1'
    class='badge_small bg-amarillos negro'> <i class='icon-user-following icons'></i> Seguir (+)</a>
</center>";
        }
        $total_mas_post_grupo_interes1 = str_replace("{BOTON_SEGUIR}", ($boton_seguir), $total_mas_post_grupo_interes1);
    }
    // mas publicadores grupo interes 2
    $mas_grupo_interes2          = com_mp_post_rank_categorias($id_empresa, "2");
    $mas_post_rut_grupo_interes2 = com_mp_post_rank_mas_publicador_categoria($mas_grupo_interes2[0]->id_categoria, $id_empresa, $subcategoria);
    $mas_post_grupo_interes2     = com_mp_post_rank_rut_mas_publicador_categoria($mas_post_rut_grupo_interes2[0]->rut, $mas_grupo_interes2[0]->id_categoria, $id_empresa);
    foreach ($mas_post_grupo_interes2 as $mas_post_g2) {
        $seguidores2 = $mas_post_g2->seguidores . " seguidores";
        $total_mas_post_grupo_interes2 .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_people_mini.html");
        $total_mas_post_grupo_interes2 = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($mas_post_g2->rut), $total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2 = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2 = str_replace("{ID_MP}", $mas_post_g2->id_mp, $total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2 = str_replace("{CATEGORIA_MP}", ($mas_post_g2->categoria), $total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2 = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($mas_post_g2->descripcion_categoria), $total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2 = str_replace("{NOMBRE}", ($mas_post_g2->nombre_autor), $total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2 = str_replace("{CONTENIDO}", limit_text($mas_post_g2->contenido, 35), $total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2 = str_replace("{SEGUIDORES}", $seguidores2, $total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2 = str_replace("{PUNTOS}", "", $total_mas_post_grupo_interes2);
        /*
        $total_mas_post_grupo_interes2= str_replace("{CONTENIDO}",limit_text($mas_post_g2->contenido,35),$total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2= str_replace("{FECHA}",formatearFechaSmall($mas_post_g2->fecha),$total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2= str_replace("{ESTADO}",($mas_post_g2->estado),$total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2= str_replace("{DESCRIPCION_ESTADO}",($mas_post_g2->descripcion_estado),$total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2= str_replace("{RUT_AUTOR}",($mas_post_g2->rut),$total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2= str_replace("{RUT}",($rut),$total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2= str_replace("{NOMBRE_AUTOR}",($mas_post_g2->nombre_autor),$total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2= str_replace("{FOTO_AUTOR}",VerificaFotoPersonal($mas_post_g2->rut),$total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2= str_replace("{ESTILOESTADO}",($mas_post_g2->estilo),$total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2= str_replace("{ICONOESTADO}",($mas_post_g2->icono_estado),$total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2= str_replace("{ESTILOCATEGORIA}",($mas_post_g2->style),$total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2= str_replace("{ICONOCATEGORIA}",($mas_post_g2->icono),$total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2= str_replace("{CATEGORIA_MP}",($mas_post_g2->categoria),$total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2= str_replace("{NOMBRE}",($mas_post_g2->nombre),$total_mas_post_grupo_interes2);
        */
        $total_mas_post_grupo_interes2 = str_replace("{RUT_ENVIADO}", ($mas_post_g2->rut), $total_mas_post_grupo_interes2);
        $total_mas_post_grupo_interes2 = str_replace("{ID_MP}", ($mas_post_g2->id_mp), $total_mas_post_grupo_interes2);
        // BOTON SEGUIR
        $sesiguepersona                = count(VerificandompaSeguidores($rut, $mas_post_g2->rut, $id_empresa));
        if ($sesiguepersona > 0) {
            $boton_seguir = "
<center>
    <div class='badge_small badge-verde blanco mgtop5'>
        <i class='icon-check icons'></i> Siguiendo
    </div>
    <a href='?sw=com_mp_personal&rut_enviado=" . $mas_post_g2->rut . "&vp=1&sg=2' class='badge_small bg-white_borderBlue negro'> <i class='icon-user-following icons'></i> Dejar de seguir (-)</a>
</center>
";
        } else {
            $boton_seguir = "
<center>
    <a href='?sw=com_mp_personal&rut_enviado=" . $mas_post_g2->rut . "&vp=1&sg=1'
    class='badge_small bg-amarillos negro'> <i class='icon-user-following icons'></i> Seguir (+)</a>
</center>";
        }
        $total_mas_post_grupo_interes2 = str_replace("{BOTON_SEGUIR}", ($boton_seguir), $total_mas_post_grupo_interes2);
    }
    // mas publicadores grupo interes 3
    $mas_grupo_interes3          = com_mp_post_rank_categorias($id_empresa, "3");
    $mas_post_rut_grupo_interes3 = com_mp_post_rank_mas_publicador_categoria($mas_grupo_interes3[0]->id_categoria, $id_empresa, $subcategoria);
    $mas_post_grupo_interes3     = com_mp_post_rank_rut_mas_publicador_categoria($mas_post_rut_grupo_interes3[0]->rut, $mas_grupo_interes3[0]->id_categoria, $id_empresa);
    foreach ($mas_post_grupo_interes3 as $mas_post_g3) {
        $seguidores3 = $mas_post_g3->seguidores . " seguidores";
        $total_mas_post_grupo_interes3 .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_people_mini.html");
        $total_mas_post_grupo_interes3 = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($mas_post_g3->rut), $total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3 = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3 = str_replace("{ID_MP}", $mas_post_g3->id_mp, $total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3 = str_replace("{CATEGORIA_MP}", ($mas_post_g3->categoria), $total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3 = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($mas_post_g3->descripcion_categoria), $total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3 = str_replace("{NOMBRE}", ($mas_post_g3->nombre_autor), $total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3 = str_replace("{SEGUIDORES}", $seguidores3, $total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3 = str_replace("{PUNTOS}", "", $total_mas_post_grupo_interes3);
        /*
        $total_mas_post_grupo_interes3= str_replace("{CONTENIDO}",limit_text($mas_post_g3->contenido,35),$total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3= str_replace("{FECHA}",formatearFechaSmall($mas_post_g3->fecha),$total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3= str_replace("{ESTADO}",($mas_post_g3->estado),$total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3= str_replace("{DESCRIPCION_ESTADO}",($mas_post_g3->descripcion_estado),$total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3= str_replace("{RUT_AUTOR}",($mas_post_g3->rut),$total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3= str_replace("{RUT}",($rut),$total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3= str_replace("{NOMBRE_AUTOR}",($mas_post_g3->nombre_autor),$total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3= str_replace("{FOTO_AUTOR}",VerificaFotoPersonal($mas_post_g3->rut),$total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3= str_replace("{ESTILOESTADO}",($mas_post_g3->estilo),$total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3= str_replace("{ICONOESTADO}",($mas_post_g3->icono_estado),$total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3= str_replace("{ESTILOCATEGORIA}",($mas_post_g3->style),$total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3= str_replace("{ICONOCATEGORIA}",($mas_post_g3->icono),$total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3= str_replace("{CATEGORIA_MP}",($mas_post_g3->categoria),$total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3= str_replace("{NOMBRE}",($mas_post_g3->nombre),$total_mas_post_grupo_interes3);
        * */
        $total_mas_post_grupo_interes3 = str_replace("{RUT_ENVIADO}", ($mas_post_g3->rut), $total_mas_post_grupo_interes3);
        $total_mas_post_grupo_interes3 = str_replace("{ID_MP}", ($mas_post_g3->id_mp), $total_mas_post_grupo_interes3);
        // BOTON SEGUIR
        $sesiguepersona                = count(VerificandompaSeguidores($rut, $mas_post_g3->rut, $id_empresa));
        if ($sesiguepersona > 0) {
            $boton_seguir = "
<center>
    <div class='badge_small badge-verde blanco mgtop5'>
        <i class='icon-check icons'></i> Siguiendo
    </div>
    <a href='?sw=com_mp_personal&rut_enviado=" . $mas_post_g3->rut . "&vp=1&sg=2' class='badge_small bg-white_borderBlue negro'> <i class='icon-user-following icons'></i> Dejar de seguir (-)</a>
</center>
";
        } else {
            $boton_seguir = "
<center>
    <a href='?sw=com_mp_personal&rut_enviado=" . $mas_post_g3->rut . "&vp=1&sg=1'
    class='badge_small bg-amarillos negro'> <i class='icon-user-following icons'></i> Seguir (+)</a>
</center>";
        }
        $total_mas_post_grupo_interes3 = str_replace("{BOTON_SEGUIR}", ($boton_seguir), $total_mas_post_grupo_interes3);
    }
    $ultimos_posteos_publicados       = com_mp_preguntas_ultimos_recientes($rut, $id_empresa, $subcategoria);
    $total_ultimos_posteos_publicados = "";
    //print_r($ultimos_posteos_publicados);
    foreach ($ultimos_posteos_publicados as $post_reciente) {
        $total_ultimos_posteos_publicados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_mini.html");
        $total_ultimos_posteos_publicados = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($post_reciente->rut), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{ID_MP}", $post_reciente->id_mp, $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{LINK}", $link_MP, $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{TIPO}", "F", $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{CATEGORIA_MP}", ($post_reciente->categoria), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($post_reciente->descripcion_categoria), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{NOMBRE}", ($post_reciente->nombre), $total_ultimos_posteos_publicados);
        /*    $total_ultimos_posteos_publicados= str_replace("{CONTENIDO}",limit_text($post_reciente->contenido,35),$total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados= str_replace("{FECHA}",formatearFechaSmall($post_reciente->fecha),$total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados= str_replace("{ESTADO}",($post_reciente->estado),$total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados= str_replace("{DESCRIPCION_ESTADO}",($post_reciente->descripcion_estado),$total_ultimos_posteos_publicados);
        */
        $total_ultimos_posteos_publicados = str_replace("{RUT_AUTOR}", ($post_reciente->rut), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{RUT}", ($rut), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{NOMBRE_AUTOR}", ($post_reciente->nombre_autor), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($post_reciente->rut), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{ESTILOESTADO}", ($post_reciente->estilo), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{ICONOESTADO}", ($post_reciente->icono_estado), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{ESTILOCATEGORIA}", ($post_reciente->style), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{ICONOCATEGORIA}", ($post_reciente->icono), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{CATEGORIA_MP}", ($post_reciente->categoria), $total_ultimos_posteos_publicados);
        /*
        $total_ultimos_posteos_publicados= str_replace("{IMAGEN_POST}","multimedia/".$post_reciente->imagenfondo,$total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados= str_replace("{VIDEO}",($video),$total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados= str_replace("{TIPOMULTIMEDIA}",($post_reciente->tipo_multimedia),$total_ultimos_posteos_publicados);
        */
        $total_ultimos_posteos_publicados = str_replace("{NOMBRE}", ($post_reciente->nombre), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{RUT_ENVIADO}", ($post_reciente->rut), $total_ultimos_posteos_publicados);
        $total_ultimos_posteos_publicados = str_replace("{ID_MP}", ($post_reciente->id_mp), $total_ultimos_posteos_publicados);
    }
    //ultimas preguntas para responder
    $ultimos_preguntas_publicadas_sinresponder = com_mp_preguntas_ultimos_recientes($rut, $id_empresa);
    $total_preguntas_sin_responder             = "";
    foreach ($ultimos_preguntas_publicadas_sinresponder as $pregunta_experto) {
        if ($subcategoria <> '' and $subcategoria <> $pregunta_experto->id_subcategoria) {
            continue;
        }
        if ($subcategoria == '' and $pregunta_experto->id_subcategoria <> '') {
            continue;
        }
        $total_preguntas_sin_responder .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_persona_listado_tipoPRG.html");
        $post_categoria                = '<a href="?sw=com_mp_personal&amb=mp_cat&idcat=' . $pregunta_experto->id_categoria . '&cat=' . $pregunta_experto->categoria . '"><span class="badge_small badge-azul"><span class="blanco"><i class="icon-people icons"></i> ' . $pregunta_experto->categoria . '</span></span></a>';
        $ico                           = "img/bci_mp_pregunta_icon.png";
        $total_preguntas_sin_responder = str_replace("{ICONO}", $ico, $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{DESC_ICONO}", $pregunta_experto->tipo, $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($pregunta_experto->descripcion_categoria), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($pregunta_experto->rut), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{ID_MP}", $pregunta_experto->id_mp, $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{LINK}", $link_MP, $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{TIPO}", "F", $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($pregunta_experto->descripcion_categoria), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{NOMBRE}", ($pregunta_experto->nombre), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{RUT_AUTOR}", ($pregunta_experto->rut), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{RUT}", ($rut), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{NOMBRE_AUTOR}", ($pregunta_experto->nombre_autor), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($pregunta_experto->rut), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{ESTILOESTADO}", ($pregunta_experto->estilo), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{ICONOESTADO}", ($pregunta_experto->icono_estado), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{ESTILOCATEGORIA}", ($pregunta_experto->style), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{ICONOCATEGORIA}", ($pregunta_experto->icono), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{CATEGORIA_MP}", ($post_categoria), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{NOMBRE}", ($pregunta_experto->nombre), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{RUT_ENVIADO}", ($pregunta_experto->rut), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{ID_MP}", ($pregunta_experto->id_mp), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{TIPO}", "A", $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{ID_MP}", ($pregunta_experto->codigo), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{ID_MP_ENCODEADO}", Encodear3($pregunta_experto->id_mp), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{CONTENIDO}", $pregunta_experto->resumen, $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{FECHA}", formatearFechaSmall($pregunta_experto->fecha), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{ESTADO}", ($pregunta_experto->estado), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{RUT}", ($rut), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{NOMBRE_AUTOR}", ($pregunta_experto->nombre_autor), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{NUMVISITAS}", round($pregunta_experto->numvisitas), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{EDITAR_RESPONDER_PREGUNTA_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_responder_mp.html"), $total_preguntas_sin_responder);
        $total_preguntas_sin_responder = str_replace("{ID_MP_ENCODEADO}", Encodear3($pregunta_experto->id_mp), $total_preguntas_sin_responder);
    }
    $mp_com_frases_comunidad = com_mp_frases($id_empresa);
    //print_r($mp_com_frases);
    $total_mp_com_frases     = "";
    foreach ($mp_com_frases_comunidad as $mp_com_frase_comunidad) {
        $total_mp_com_frases .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_frases.html");
        $total_mp_com_frases = str_replace("{FRASE}", ($mp_com_frase_comunidad->frase), $total_mp_com_frases);
        $total_mp_com_frases = str_replace("{AUTOR}", ($mp_com_frase_comunidad->autor), $total_mp_com_frases);
    }
    // MP MAS VALORADOS
    $posteos_mas_valorados       = com_mp_post_mas_valorados($rut, $id_empresa, $subcategoria);
    $total_posteos_mas_valorados = "";
    //print_r($posteos_mas_valorados);
    foreach ($posteos_mas_valorados as $post_recent) {
        if ($subcategoria <> '' and $subcategoria <> $post_recent->id_subcategoria) {
            continue;
        }
        if ($subcategoria == '' and $post_recent->id_subcategoria <> '') {
            continue;
        }
        $total_posteos_mas_valorados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_mini.html");
        $total_posteos_mas_valorados = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($post_recent->rut), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{ID_MP}", $post_recent->id_mp, $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{LINK}", $link_MP, $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{TIPO}", "F", $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{CATEGORIA_MP}", ($post_recent->categoria), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($post_recent->descripcion_categoria), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{NOMBRE}", ($post_recent->nombre), $total_posteos_mas_valorados);
        if ($id_empresa == 53) {
            $total_posteos_mas_valorados = str_replace("{CONTENIDO}", substr($post_recent->contenido, 0, 150), $total_posteos_mas_valorados);
        } else {
            $total_posteos_mas_valorados = str_replace("{CONTENIDO}", ($post_recent->contenido), $total_posteos_mas_valorados);
        }
        $total_posteos_mas_valorados = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_posteos_mas_valorados);
        if ($post_recent->rut == $rut) {
            $total_posteos_mas_valorados = str_replace("{EDITAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_editar_mp.html"), $total_posteos_mas_valorados);
            $total_posteos_mas_valorados = str_replace("{ELIMINAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_borrar_mp.html"), $total_posteos_mas_valorados);
        } else {
            $total_posteos_mas_valorados = str_replace("{EDITAR_MP}", "", $total_posteos_mas_valorados);
            $total_posteos_mas_valorados = str_replace("{ELIMINAR_MP}", "", $total_posteos_mas_valorados);
        }
        $tiene_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "MEGUSTA", $rut);
        if ($tiene_megusta) {
            $total_posteos_mas_valorados = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta.html"), $total_posteos_mas_valorados);
        } else {
            $total_posteos_mas_valorados = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta.html"), $total_posteos_mas_valorados);
        }
        $tiene_no_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "NOMEGUSTA", $rut);
        if ($tiene_no_megusta) {
            $total_posteos_mas_valorados = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_nomegusta.html"), $total_posteos_mas_valorados);
        } else {
            $total_posteos_mas_valorados = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_nomegusta.html"), $total_posteos_mas_valorados);
        }
        $total_posteos_mas_valorados = ColocaCantidadDeMegusta($total_posteos_mas_valorados, $post_recent->id_mp, $id_empresa);
        $tiene_favorito              = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "FAVORITA", $rut);
        if ($tiene_favorito) {
            $total_posteos_mas_valorados = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_favorito.html"), $total_posteos_mas_valorados);
        } else {
            $total_posteos_mas_valorados = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_favorito.html"), $total_posteos_mas_valorados);
        }
        $total_posteos_mas_valorados = str_replace("{ESTADO}", ($post_recent->estado), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{DESCRIPCION_ESTADO}", ($post_recent->descripcion_estado), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{RUT_AUTOR}", ($post_recent->rut), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{RUT}", ($rut), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{NOMBRE_AUTOR}", ($post_recent->nombre_autor), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($post_recent->rut), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{ESTILOESTADO}", ($post_recent->estilo), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{ICONOESTADO}", ($post_recent->icono_estado), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{ESTILOCATEGORIA}", ($post_recent->style), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{ICONOCATEGORIA}", ($post_recent->icono), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{CATEGORIA_MP}", ($post_recent->categoria), $total_posteos_mas_valorados);
        /*
        $total_posteos_mas_valorados = str_replace("{IMAGEN_POST}","multimedia/".$post_recent->imagenfondo,$total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{VIDEO}",($video),$total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{TIPOMULTIMEDIA}",($post_recent->tipo_multimedia),$total_posteos_mas_valorados);
        * */
        $total_posteos_mas_valorados = str_replace("{NOMBRE}", ($post_recent->nombre), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{RUT_ENVIADO}", ($post_recent->rut), $total_posteos_mas_valorados);
        $total_posteos_mas_valorados = str_replace("{ID_MP}", ($post_recent->id_mp), $total_posteos_mas_valorados);
    }
    // MP NOVEDADES
    $posteos_mas_novedades   = com_mp_post_portipo("Novedades", $id_empresa, $subcategoria);
    $total_posteos_novedades = "";
    foreach ($posteos_mas_novedades as $post_recent) {
        $total_posteos_novedades .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_mini_banner.html");
        $total_posteos_novedades = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($post_recent->rut), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{ID_MP}", $post_recent->id_mp, $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{LINK}", $link_MP, $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{TIPO}", "F", $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{CATEGORIA_MP}", ($post_recent->categoria), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($post_recent->descripcion_categoria), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{NOMBRE}", ($post_recent->nombre), $total_posteos_novedades);
        if ($id_empresa == 53) {
            $total_posteos_novedades = str_replace("{CONTENIDO}", substr($post_recent->contenido, 0, 150), $total_posteos_novedades);
        } else {
            $total_posteos_novedades = str_replace("{CONTENIDO}", ($post_recent->contenido), $total_posteos_novedades);
        }
        $total_posteos_novedades = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_posteos_novedades);
        if ($post_recent->rut == $rut) {
            $total_posteos_novedades = str_replace("{EDITAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_editar_mp.html"), $total_posteos_novedades);
            $total_posteos_novedades = str_replace("{ELIMINAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_borrar_mp.html"), $total_posteos_novedades);
        } else {
            $total_posteos_novedades = str_replace("{EDITAR_MP}", "", $total_posteos_novedades);
            $total_posteos_novedades = str_replace("{ELIMINAR_MP}", "", $total_posteos_novedades);
        }
        $tiene_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "MEGUSTA", $rut);
        if ($tiene_megusta) {
            $total_posteos_novedades = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta.html"), $total_posteos_novedades);
        } else {
            $total_posteos_novedades = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta.html"), $total_posteos_novedades);
        }
        $tiene_no_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "NOMEGUSTA", $rut);
        if ($tiene_no_megusta) {
            $total_posteos_novedades = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_nomegusta.html"), $total_posteos_novedades);
        } else {
            $total_posteos_novedades = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_nomegusta.html"), $total_posteos_novedades);
        }
        $total_posteos_novedades = ColocaCantidadDeMegusta($total_posteos_novedades, $post_recent->id_mp, $id_empresa);
        $tiene_favorito          = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "FAVORITA", $rut);
        if ($tiene_favorito) {
            $total_posteos_novedades = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_favorito.html"), $total_posteos_novedades);
        } else {
            $total_posteos_novedades = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_favorito.html"), $total_posteos_novedades);
        }
        $total_posteos_novedades = str_replace("{ESTADO}", ($post_recent->estado), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{DESCRIPCION_ESTADO}", ($post_recent->descripcion_estado), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{RUT_AUTOR}", ($post_recent->rut), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{RUT}", ($rut), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{NOMBRE_AUTOR}", ($post_recent->nombre_autor), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($post_recent->rut), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{ESTILOESTADO}", ($post_recent->estilo), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{ICONOESTADO}", ($post_recent->icono_estado), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{ESTILOCATEGORIA}", ($post_recent->style), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{ICONOCATEGORIA}", ($post_recent->icono), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{CATEGORIA_MP}", ($post_recent->categoria), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{IMAGEN_POST}", "multimedia/" . $post_recent->imagenfondo, $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{VIDEO}", ($video), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{TIPOMULTIMEDIA}", ($post_recent->tipo_multimedia), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{NOMBRE}", ($post_recent->nombre), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{RUT_ENVIADO}", ($post_recent->rut), $total_posteos_novedades);
        $total_posteos_novedades = str_replace("{ID_MP}", ($post_recent->id_mp), $total_posteos_novedades);
    }
    // MP FOTOS
    $posteos_mas_fotos   = com_mp_post_portipo("Foto", $id_empresa, $subcategoria);
    $total_posteos_fotos = "";
    foreach ($posteos_mas_fotos as $post_recent) {
        $total_posteos_fotos .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_mini_banner.html");
        $total_posteos_fotos = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($post_recent->rut), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{ID_MP}", $post_recent->id_mp, $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{LINK}", $link_MP, $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{TIPO}", "F", $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{CATEGORIA_MP}", ($post_recent->categoria), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($post_recent->descripcion_categoria), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{NOMBRE}", ($post_recent->nombre), $total_posteos_fotos);
        if ($id_empresa == 53) {
            $total_posteos_fotos = str_replace("{CONTENIDO}", substr($post_recent->contenido, 0, 150), $total_posteos_fotos);
        } else {
            $total_posteos_fotos = str_replace("{CONTENIDO}", ($post_recent->contenido), $total_posteos_fotos);
        }
        $total_posteos_fotos = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_posteos_fotos);
        if ($post_recent->rut == $rut) {
            $total_posteos_fotos = str_replace("{EDITAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_editar_mp.html"), $total_posteos_fotos);
            $total_posteos_fotos = str_replace("{ELIMINAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_borrar_mp.html"), $total_posteos_fotos);
        } else {
            $total_posteos_fotos = str_replace("{EDITAR_MP}", "", $total_posteos_fotos);
            $total_posteos_fotos = str_replace("{ELIMINAR_MP}", "", $total_posteos_fotos);
        }
        $tiene_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "MEGUSTA", $rut);
        if ($tiene_megusta) {
            $total_posteos_fotos = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta.html"), $total_posteos_fotos);
        } else {
            $total_posteos_fotos = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta.html"), $total_posteos_fotos);
        }
        $tiene_no_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "NOMEGUSTA", $rut);
        if ($tiene_no_megusta) {
            $total_posteos_fotos = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_nomegusta.html"), $total_posteos_fotos);
        } else {
            $total_posteos_fotos = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_nomegusta.html"), $total_posteos_fotos);
        }
        $total_posteos_fotos = ColocaCantidadDeMegusta($total_posteos_fotos, $post_recent->id_mp, $id_empresa);
        $tiene_favorito      = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "FAVORITA", $rut);
        if ($tiene_favorito) {
            $total_posteos_fotos = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_favorito.html"), $total_posteos_fotos);
        } else {
            $total_posteos_fotos = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_favorito.html"), $total_posteos_fotos);
        }
        $total_posteos_fotos = str_replace("{ESTADO}", ($post_recent->estado), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{DESCRIPCION_ESTADO}", ($post_recent->descripcion_estado), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{RUT_AUTOR}", ($post_recent->rut), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{RUT}", ($rut), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{NOMBRE_AUTOR}", ($post_recent->nombre_autor), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($post_recent->rut), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{ESTILOESTADO}", ($post_recent->estilo), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{ICONOESTADO}", ($post_recent->icono_estado), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{ESTILOCATEGORIA}", ($post_recent->style), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{ICONOCATEGORIA}", ($post_recent->icono), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{CATEGORIA_MP}", ($post_recent->categoria), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{IMAGEN_POST}", "multimedia/" . $post_recent->imagenfondo, $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{VIDEO}", ($video), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{TIPOMULTIMEDIA}", ($post_recent->tipo_multimedia), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{NOMBRE}", ($post_recent->nombre), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{RUT_ENVIADO}", ($post_recent->rut), $total_posteos_fotos);
        $total_posteos_fotos = str_replace("{ID_MP}", ($post_recent->id_mp), $total_posteos_fotos);
    }
    // MP CAPACITACIONES
    $posteos_mas_capacitaciones   = com_mp_post_portipo("Capacitaciones", $id_empresa, $subcategoria);
    $total_posteos_capacitaciones = "";
    //print_r($posteos_mas_capacitaciones);
    foreach ($posteos_mas_capacitaciones as $post_recent) {
        $total_posteos_capacitaciones .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_mini_banner.html");
        $total_posteos_capacitaciones = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($post_recent->rut), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{ID_MP}", $post_recent->id_mp, $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{LINK}", $link_MP, $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{TIPO}", "F", $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{CATEGORIA_MP}", ($post_recent->categoria), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($post_recent->descripcion_categoria), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{NOMBRE}", ($post_recent->nombre), $total_posteos_capacitaciones);
        if ($id_empresa == 53) {
            $total_posteos_capacitaciones = str_replace("{CONTENIDO}", substr($post_recent->contenido, 0, 150), $total_posteos_capacitaciones);
        } else {
            $total_posteos_capacitaciones = str_replace("{CONTENIDO}", ($post_recent->contenido), $total_posteos_capacitaciones);
        }
        $total_posteos_capacitaciones = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_posteos_capacitaciones);
        if ($post_recent->rut == $rut) {
            $total_posteos_capacitaciones = str_replace("{EDITAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_editar_mp.html"), $total_posteos_capacitaciones);
            $total_posteos_capacitaciones = str_replace("{ELIMINAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_borrar_mp.html"), $total_posteos_capacitaciones);
        } else {
            $total_posteos_capacitaciones = str_replace("{EDITAR_MP}", "", $total_posteos_capacitaciones);
            $total_posteos_capacitaciones = str_replace("{ELIMINAR_MP}", "", $total_posteos_capacitaciones);
        }
        $tiene_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "MEGUSTA", $rut);
        if ($tiene_megusta) {
            $total_posteos_capacitaciones = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta.html"), $total_posteos_capacitaciones);
        } else {
            $total_posteos_capacitaciones = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta.html"), $total_posteos_capacitaciones);
        }
        $tiene_no_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "NOMEGUSTA", $rut);
        if ($tiene_no_megusta) {
            $total_posteos_capacitaciones = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_nomegusta.html"), $total_posteos_capacitaciones);
        } else {
            $total_posteos_capacitaciones = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_nomegusta.html"), $total_posteos_capacitaciones);
        }
        $total_posteos_capacitaciones = ColocaCantidadDeMegusta($total_posteos_capacitaciones, $post_recent->id_mp, $id_empresa);
        $tiene_favorito               = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $post_recent->id_mp, "FAVORITA", $rut);
        if ($tiene_favorito) {
            $total_posteos_capacitaciones = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_favorito.html"), $total_posteos_capacitaciones);
        } else {
            $total_posteos_capacitaciones = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_favorito.html"), $total_posteos_capacitaciones);
        }
        $total_posteos_capacitaciones = str_replace("{ESTADO}", ($post_recent->estado), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{DESCRIPCION_ESTADO}", ($post_recent->descripcion_estado), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{RUT_AUTOR}", ($post_recent->rut), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{RUT}", ($rut), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{NOMBRE_AUTOR}", ($post_recent->nombre_autor), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($post_recent->rut), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{ESTILOESTADO}", ($post_recent->estilo), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{ICONOESTADO}", ($post_recent->icono_estado), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{ESTILOCATEGORIA}", ($post_recent->style), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{ICONOCATEGORIA}", ($post_recent->icono), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{CATEGORIA_MP}", ($post_recent->categoria), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{IMAGEN_POST}", "multimedia/" . $post_recent->imagenfondo, $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{VIDEO}", ($video), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{TIPOMULTIMEDIA}", ($post_recent->tipo_multimedia), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{NOMBRE}", ($post_recent->nombre), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{RUT_ENVIADO}", ($post_recent->rut), $total_posteos_capacitaciones);
        $total_posteos_capacitaciones = str_replace("{ID_MP}", ($post_recent->id_mp), $total_posteos_capacitaciones);
    }
    $peoples_mas_seguida      = com_mp_people_mas_seguida($rut, $id_empresa, $subcategoria);
    $total_people_mas_seguida = "";
    //print_r($peoples_mas_seguida);
    foreach ($peoples_mas_seguida as $people_maseguidA) {
        $total_people_mas_seguida .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_people_mini.html");
        $total_people_mas_seguida = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($people_maseguidA->rut), $total_people_mas_seguida);
        $total_people_mas_seguida = str_replace("{NOMBRE}", ($people_maseguidA->nombre), $total_people_mas_seguida);
        $total_people_mas_seguida = str_replace("{RUT_ENVIADO}", ($people_maseguidA->rut), $total_people_mas_seguida);
        $total_people_mas_seguida = str_replace("{SEGUIDORES}", ($people_maseguidA->seguidores . " seguidores"), $total_people_mas_seguida);
        $total_people_mas_seguida = str_replace("{PUNTOS}", "", $total_people_mas_seguida);
        // BOTON SEGUIR
        $sesiguepersona           = count(VerificandompaSeguidores($rut, $people_maseguidA->rut, $id_empresa));
        if ($sesiguepersona > 0) {
            $boton_seguir = "<center>    <div class='badge_small badge-verde blanco mgtop5'>    <i class='icon-check icons'></i> Siguiendo </div>
        <a href='?sw=com_mp_personal&rut_enviado=" . $people_maseguidA->rut . "&vp=1&sg=2' class='badge_small bg-white_borderBlue negro'>
        <i class='icon-user-following icons'></i> Dejar de seguir (-)</a></center>";
        } else {
            $boton_seguir = "<center><a href='?sw=com_mp_personal&rut_enviado=" . $people_maseguidA->rut . "&vp=1&sg=1'
         class='badge_small bg-amarillos negro'>
        <i class='icon-user-following icons'></i> Seguir (+)</a></center>";
        }
        $total_people_mas_seguida = str_replace("{BOTON_SEGUIR}", ($boton_seguir), $total_people_mas_seguida);
    }
    $peoples_mas_puntos      = com_mp_people_mas_puntos($rut, $id_empresa, $subcategoria);
    $total_people_mas_puntos = "";
    //print_r($peoples_mas_puntos);
    //exit();
    foreach ($peoples_mas_puntos as $peoples_ma_punto) {
        $total_people_mas_puntos .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_people_mini.html");
        $total_people_mas_puntos = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($peoples_ma_punto->rut), $total_people_mas_puntos);
        $total_people_mas_puntos = str_replace("{NOMBRE}", ($peoples_ma_punto->nombre), $total_people_mas_puntos);
        $total_people_mas_puntos = str_replace("{RUT_ENVIADO}", ($peoples_ma_punto->rut), $total_people_mas_puntos);
        $total_people_mas_puntos = str_replace("{SEGUIDORES}", "", $total_people_mas_puntos);
        $total_people_mas_puntos = str_replace("{PUNTOS}", $peoples_ma_punto->puntos . " Bci Coins", $total_people_mas_puntos);
        // BOTON SEGUIR
        $sesiguepersona          = count(VerificandompaSeguidores($rut, $peoples_ma_punto->rut, $id_empresa));
        if ($sesiguepersona > 0) {
            $boton_seguir = "<center>    <div class='badge_small badge-verde blanco mgtop5'>    <i class='icon-check icons'></i> Siguiendo </div>
        <a href='?sw=com_mp_personal&rut_enviado=" . $peoples_ma_punto->rut . "&vp=1&sg=2'
        class='badge_small bg-amarillos negro'>
        <i class='icon-user-following icons'></i> Dejar de seguir (-)</a></center>";
        } else {
            $boton_seguir = "<center><a href='?sw=com_mp_personal&rut_enviado=" . $peoples_ma_punto->rut . "&vp=1&sg=1' class='badge_small bg-amarillos negro'>        <i class='icon-user-following icons'></i> Seguir (+)</a></center>";
        }
        $total_people_mas_puntos = str_replace("{BOTON_SEGUIR}", ($boton_seguir), $total_people_mas_puntos);
    }
    $peoples_mas_interacciones = com_mp_people_mas_interacciones($rut, $id_empresa, $subcategoria);
    $total_people_mas_interacc = "";
    //print_r($peoples_mas_interacciones);
    foreach ($peoples_mas_interacciones as $people_mas_interacc) {
        $total_people_mas_interacc .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_people_mini.html");
        $total_people_mas_interacc = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($people_mas_interacc->rut), $total_people_mas_interacc);
        $total_people_mas_interacc = str_replace("{NOMBRE}", ($people_mas_interacc->nombre), $total_people_mas_interacc);
        $total_people_mas_interacc = str_replace("{RUT_ENVIADO}", ($people_mas_interacc->rut), $total_people_mas_interacc);
        $total_people_mas_interacc = str_replace("{SEGUIDORES}", ($people_mas_interacc->seguidores . " seguidores"), $total_people_mas_interacc);
        $total_people_mas_interacc = str_replace("{PUNTOS}", "", $total_people_mas_interacc);
        // BOTON SEGUIR
        $sesiguepersona            = count(VerificandompaSeguidores($rut, $people_mas_interacc->rut, $id_empresa));
        if ($sesiguepersona > 0) {
            $boton_seguir = "<center>    <div class='badge_small badge-verde blanco mgtop5'>    <i class='icon-check icons'></i> Siguiendo </div>
        <a href='?sw=com_mp_personal&rut_enviado=" . $people_mas_interacc->rut . "&vp=1&sg=2'
        class='badge_small bg-amarillos negro'>
        <i class='icon-user-following icons'></i> Dejar de seguir (-)</a></center>";
        } else {
            $boton_seguir = "<center><a href='?sw=com_mp_personal&rut_enviado=" . $people_mas_interacc->rut . "&vp=1&sg=1' class='badge_small bg-amarillos negro'>        <i class='icon-user-following icons'></i> Seguir (+)</a></center>";
        }
        $total_people_mas_interacc = str_replace("{BOTON_SEGUIR}", ($boton_seguir), $total_people_mas_interacc);
    }
    $peoples_quesigos     = com_mp_people_quesigo($rut, $id_empresa);
    $total_people_quesigo = "";
    foreach ($peoples_quesigos as $people_quesigo) {
        $total_people_quesigo .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_people_mini.html");
        $datos                = $people_quesigo->cuenta . " seguidores";
        $total_people_quesigo = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($people_quesigo->rut), $total_people_quesigo);
        $total_people_quesigo = str_replace("{NOMBRE}", ($people_quesigo->nombrecompleto), $total_people_quesigo);
        $total_people_quesigo = str_replace("{RUT_ENVIADO}", ($people_quesigo->rut), $total_people_quesigo);
        $total_people_quesigo = str_replace("{DATOS}", ($datos), $total_people_quesigo);
        $total_people_quesigo = str_replace("{SEGUIDORES}", ($people_mas_interacc->seguidores . " seguidores"), $total_people_quesigo);
        $total_people_quesigo = str_replace("{PUNTOS}", "", $total_people_quesigo);
        // BOTON SEGUIR
        $sesiguepersona       = count(VerificandompaSeguidores($rut, $people_quesigo->rut, $id_empresa));
        if ($sesiguepersona > 0) {
            $boton_seguir = "<center>    <div class='badge_small badge-verde blanco mgtop5'>    <i class='icon-check icons'></i> Siguiendo </div>
        <a href='?sw=com_mp_personal&rut_enviado=" . $people_quesigo->rut . "&vp=1&sg=2'
        class='badge_small bg-amarillos negro'>
        <i class='icon-user-following icons'></i> Dejar de seguir (-)</a></center>";
        } else {
            $boton_seguir = "<center><a href='?sw=com_mp_personal&rut_enviado=" . $people_quesigo->rut . "&vp=1&sg=1' class='badge_small bg-white_borderBlue negro'>        <i class='icon-user-following icons'></i> Seguir (+)</a></center>";
        }
        $total_people_quesigo = str_replace("{BOTON_SEGUIR}", ($boton_seguir), $total_people_quesigo);
    }
    $limit                   = 9;
    $total_listado_tags      = com_mp_tag_data($id_empresa, $rut, $limit);
    $total_listado_tag_cloud = "";
    foreach ($total_listado_tags as $total_listado_tag_unico) {
        $total_listado_tag_cloud .= file_get_contents("views/comunidad_mp/com_mp_row_tag_cloud_search.html");
        $total_listado_tag_cloud = str_replace("{TAG}", $total_listado_tag_unico->tag, $total_listado_tag_cloud);
        $total_listado_tag_cloud = str_replace("{NUM}", $total_listado_tag_unico->cuenta, $total_listado_tag_cloud);
        $link                    = "?sw=com_mp_personal&amb=mp_tag&tag=" . $total_listado_tag_unico->tag . "";
        $total_listado_tag_cloud = str_replace("{LINK}", $link, $total_listado_tag_cloud);
    }
    $agrup_categorias      = MPObtengoCategoriasNumero($id_empresa);
    $total_agrup_categoria = "";
    foreach ($agrup_categorias as $agrup_categoria) {
        //revisa si usuario esta registrado en algun grupo
        $cuenta_seguido = com_mp_revisa_grupo_seguido($agrup_categoria->id_categoria, "GRUPOSEGUIDO", $id_empresa, $rut);
        //echo $cuenta_seguido[0]->cuenta;
        if ($cuenta_seguido[0]->cuenta == 0) {
            $var_gruposeguir       = "<a href='?sw=com_mp_personal&amb=mp_cat&idcat=" . $agrup_categoria->id_categoria . "&cat=" . $agrup_categoria->categoria . "&groupseguir=1'
            class='negro'> Seguir (+)</a>";
            $var_groupseguir_class = "azul";
        } else {
            $var_gruposeguir       = "<a href='?sw=com_mp_personal&amb=mp_cat&idcat=" . $agrup_categoria->id_categoria . "&cat=" . $agrup_categoria->categoria . "&groupseguir=2'
            class='negro'> Dejar de seguir (-)</a>";
            $var_groupseguir_class = "verde";
        }
        $var_gruposeguir       = "<a href='?sw=com_mp_personal&amb=mp_cat&idcat=" . $agrup_categoria->id_categoria . "&cat=" . $agrup_categoria->categoria . "&groupseguir=1'
            class='negro'> </a>";
        $var_groupseguir_class = "azul";
        $total_agrup_categoria .= file_get_contents("views/comunidad_mp/row_com_mp_grupo_interes.html");
        $total_agrup_categoria = str_replace("{ITEM}", ($agrup_categoria->categoria), $total_agrup_categoria);
        $total_agrup_categoria = str_replace("{NUM}", ($agrup_categoria->cuenta), $total_agrup_categoria);
        $link_cat_amb          = "?sw=com_mp_personal&amb=mp_cat&idcat=" . $agrup_categoria->id_categoria . "&cat=" . $agrup_categoria->categoria . "";
        $total_agrup_categoria = str_replace("{LINK}", $link_cat_amb, $total_agrup_categoria);
        $total_agrup_categoria = str_replace("{GRUPO_SEGUIR_SEGUIDO_BOTON}", $var_gruposeguir, $total_agrup_categoria);
        $total_agrup_categoria = str_replace("{GRUPO_SEGUIR_SEGUIDO_CLASS}", $var_groupseguir_class, $total_agrup_categoria);
        //    echo $agrup_categoria->categoria;
    }
    $agrup_ambitos       = MPObtengoAmbitosNumero($id_empresa, $array_MP_template[0]->template);
    $total_agrup_ambitos = "";
    foreach ($agrup_ambitos as $agrup_ambito) {
        //revisa si usuario esta registrado en algun grupo
        $cuenta_seguido        = com_mp_revisa_grupo_seguido($agrup_ambito->id_ambito, "GRUPOSEGUIDO", $id_empresa, $rut);
        //echo $cuenta_seguido[0]->cuenta;
        $var_gruposeguir       = "<a href='?sw=com_mp_personal&amb=mp_amb&idamb=" . $agrup_ambito->id_ambito . "&cat=" . $agrup_ambito->ambito . "&groupseguir=1'
            class='negro'> </a>";
        $var_groupseguir_class = "azul";
        $total_agrup_ambitos .= file_get_contents("views/comunidad_mp/row_com_mp_grupo_ambito.html");
        $total_agrup_ambitos = str_replace("{ITEM}", ($agrup_ambito->ambito), $total_agrup_ambitos);
        $total_agrup_ambitos = str_replace("{NUM}", ($agrup_ambito->cuenta), $total_agrup_ambitos);
        $link_cat_amb        = "?sw=com_mp_personal&amb=mp_amb&idamb=" . $agrup_ambito->id_ambito . "&ambito=" . $agrup_ambito->ambito . "";
        $total_agrup_ambitos = str_replace("{LINK}", $link_cat_amb, $total_agrup_ambitos);
        $total_agrup_ambitos = str_replace("{GRUPO_SEGUIR_SEGUIDO_BOTON}", $var_gruposeguir, $total_agrup_ambitos);
        $total_agrup_ambitos = str_replace("{GRUPO_SEGUIR_SEGUIDO_CLASS}", $var_groupseguir_class, $total_agrup_ambitos);
        //    echo $agrup_categoria->categoria;
    }
    //categorias expertos
    $agrup_categoria_expertos_expertos = MPObtengoCategoriasNumero($id_empresa);
    $total_agrup_categoria_expertos    = "";
    foreach ($agrup_categoria_expertos_expertos as $agrup_categoria_experto) {
        $cuenta_num = MP_numero_expertos_categoria($agrup_categoria_experto->id_categoria, $id_empresa);
        if ($cuenta_num > 0) {
            $total_agrup_categoria_expertos .= file_get_contents("views/comunidad_mp/row_com_mp_grupo_interes_expertos.html");
            $total_agrup_categoria_expertos = str_replace("{ITEM}", ($agrup_categoria_experto->categoria), $total_agrup_categoria_expertos);
            $total_agrup_categoria_expertos = str_replace("{NUM}", ($cuenta_num), $total_agrup_categoria_expertos);
            $link_cat_amb                   = "?sw=com_mp_personal&=mp_cat&soloexpertos=1&q=" . $agrup_categoria_experto->categoria . "";
            $total_agrup_categoria_expertos = str_replace("{LINK}", $link_cat_amb, $total_agrup_categoria_expertos);
            $total_agrup_categoria_expertos = str_replace("{GRUPO_SEGUIR_SEGUIDO_BOTON}", $var_gruposeguir, $total_agrup_categoria_expertos);
            $total_agrup_categoria_expertos = str_replace("{GRUPO_SEGUIR_SEGUIDO_CLASS}", $var_groupseguir_class, $total_agrup_categoria_expertos);
        }
    }
    //filtro por tipo
    $agrup_tiposPub    = MPObtengoTiposPubNumero($id_empresa); //print_r($agrup_tiposPub);
    $total_agrup_tipos = "";
    foreach ($agrup_tiposPub as $agrup_tipoPub) {
        $total_agrup_tipos .= file_get_contents("views/comunidad_mp/row_com_mp_grupo_tipos.html");
        $total_agrup_tipos = str_replace("{ITEM}", ($agrup_tipoPub->tipo), $total_agrup_tipos);
        //$total_agrup_tipos = str_replace("{NUM}",($agrup_categoria->cuenta),$total_agrup_tipos);
        $link_cat_amb      = "?sw=com_mp_personal&amb=mp_tipo&idcat=" . $agrup_tipoPub->tipo . "&cat=" . $agrup_tipoPub->tipo . "";
        $total_agrup_tipos = str_replace("{LINK}", $link_cat_amb, $total_agrup_tipos);
        //$total_agrup_tipos = str_replace("{GRUPO_SEGUIR_SEGUIDO_BOTON}",$var_gruposeguir,$total_agrup_tipos);
        //$total_agrup_tipos = str_replace("{GRUPO_SEGUIR_SEGUIDO_CLASS}",$var_groupseguir_class,$total_agrup_tipos);
        //echo $agrup_categoria->categoria;
    }
    $PRINCIPAL = str_replace("{NUM_FAV}", MPbuscaFav($rut, $id_empresa), $PRINCIPAL);
    $PRINCIPAL = str_replace("{NUM_MISPR}", MPbuscaMp($rut, $id_empresa), $PRINCIPAL);
    $PRINCIPAL = str_replace("{INSIGNIA}", "", $PRINCIPAL);
    $PRINCIPAL = str_replace("{RUT_USUARIO}", $rut, $PRINCIPAL);
    $PRINCIPAL = str_replace("{MIRUT}", $rut, $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_LISTADO_POST_VIDEOS}", utf8_encode($total_listado_post_tipo_new_videos), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_LISTADO_POST_NEWS_BIG}", utf8_encode($total_listado_post_tipo_news_big), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_LISTADO_POST_NEWS_3POST}", utf8_encode($total_listado_post_tipo_news_3post), $PRINCIPAL);
    //echo "4096 <br><br><br><br>ambiente $ambiente";
    if ($ambiente <> '') {
        $PRINCIPAL = str_replace("{IMAGEN_CONCURSO_HOME}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{POST_RESULTADOS_COMUNIDAD_MP}", utf8_encode($total_listado_post_personas_resultados), $PRINCIPAL);
        $PRINCIPAL = str_replace("{POST_RESULTADOS_EXPERTOS_MP}", utf8_encode($total_listado_post_expertos_resultados), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ROW_TITULO_R_RESULTADOS}", ($titulo_R_resultados), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ROW_TITULO_E_RESULTADOS}", ($titulo_E_resultados), $PRINCIPAL);
        $PRINCIPAL = str_replace("{MP_HACERPREGUNTA}", utf8_encode($mp_hacerpregunta), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{IMAGEN_CONCURSO_HOME}", "<div class='row'><div class='col-xs-12'><a href='?sw=com_mp_concurso'><img src='img/comunidadmpa_banner_central_VF_rod.gif' border='0'></a>
    </div></div>", $PRINCIPAL);
        $PRINCIPAL = str_replace("{POST_RESULTADOS_COMUNIDAD_MP}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{POST_RESULTADOS_EXPERTOS_MP}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ROW_TITULO_R_RESULTADOS}", ($titulo_R_resultados), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ROW_TITULO_E_RESULTADOS}", ($titulo_E_resultados), $PRINCIPAL);
        $PRINCIPAL = str_replace("{MP_HACERPREGUNTA}", utf8_encode($mp_hacerpregunta), $PRINCIPAL);
    }
    $PRINCIPAL = str_replace("{PERFIL_PERSONAL_COMUNIDAD_MP}", utf8_encode($perfil_personal), $PRINCIPAL);
    $PRINCIPAL = str_replace("{POST_FIJOS_COMUNIDAD_MP}", utf8_encode($post_fijo_personal), $PRINCIPAL);
    $PRINCIPAL = str_replace("{POST_ESTADISTICAS_COMUNIDAD_MP}", utf8_encode($post_fijo_estadisticas), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_LISTADO_POST_RECIENTES_FACEBOOK}", utf8_encode($total_listado_post_tipo_facebook), $PRINCIPAL);
    //echo "<br><br><br><br><br><br><br><br>vp $vp, amb $ambiente";
    if ($vp == "" and ($ambiente == "" or $ambiente == "mp_cat" or $ambiente == "mp_tag" or $ambiente == "mp_mp" or $ambiente == "mp_mf" or $ambiente == "mp_cc" or $ambiente == "mp_tipo")) {
        //echo "uno";
        //$total_listado_post_recientes.=file_get_contents("views/comunidad_mp/".$template.$id_empresa."_boton_carga_mas_post.html");
        //$total_listado_post_recientes = str_replace("{NUMERO_COMENTARIOS}","1",$total_listado_post_recientes);
        $PRINCIPAL = str_replace("{ROW_LISTADO_POST_RECIENTES}", utf8_encode($total_listado_post_recientes), $PRINCIPAL);
        //<div class='com_mp_title_featured fc-container__inner '><a href='?sw=com_mp_personal&amb=mp_rec'><span class='blanco'> Lo ?ltimo en la Comunidad <i class='icon-arrow-right icons'></i></span></a></div>
        $PRINCIPAL = str_replace("{TITULO_LISTADO_POST_RECIENTES}", "", $PRINCIPAL);
    } else {
        //echo "dos";
        $PRINCIPAL = str_replace("{ROW_LISTADO_POST_RECIENTES}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{TITULO_LISTADO_POST_RECIENTES}", "", $PRINCIPAL);
    }
    $PRINCIPAL  = str_replace("{ROW_LISTADO_TIMELINE_PERSONAL}", utf8_encode($total_listado_post_timeline), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{ROW_LISTADO_TIMELINE_POST_POPULARES}", utf8_encode($total_listado_post_populares), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{ROW_LISTADO_TIMELINE_PERSONAS_INTERES}", utf8_encode($total_listado_post_personas_interes), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{ROW_LISTADO_TIMELINE_PERSONAL}", utf8_encode($total_listado), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{TITULO_LISTADO_TIMELINE_TAG1}", utf8_encode($Top_Tag[0]->tag), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{TITULO_LISTADO_TIMELINE_TAG2}", utf8_encode($Top_Tag[1]->tag), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{TITULO_LISTADO_TIMELINE_TAG3}", utf8_encode($Top_Tag[2]->tag), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{ROW_LISTADO_TIMELINE_TAG1}", utf8_encode($total_listado_post_tag1), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{ROW_LISTADO_TIMELINE_TAG2}", utf8_encode($total_listado_post_tag2), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{ROW_LISTADO_TIMELINE_TAG3}", utf8_encode($total_listado_post_tag3), $PRINCIPAL);
    //    }
    //preguntas
    $PRINCIPAL  = str_replace("{ROW_ULTIMOS_PREGUNTAS_PUBLICO}", utf8_encode($total_ultimos_posteos_publicados), $PRINCIPAL);
    //soy experto??
    $soyexperto = mp_verificaquesoy_experto($rut, $id_empresa, $subcategoria);
    if ($soyexperto[0]->cuenta >= 1) {
        $mp_num_preg_sin_contestar = mp_num_preguntas_sincontestar($rut, $id_empresa, $subcategoria);
        if ($mp_num_preg_sin_contestar[0]->cuenta == 1) {
            $alerta_experto_preguntas = "
    <div class='alert alert-danger' role='alert'>
          <strong>Existen " . $mp_num_preg_sin_contestar[0]->cuenta . " pregunta sin contestar</strong><br>Has click en el boton Responder, para contestar.<br> Tu respuesta quedara publicada en la Comunidad.
    </div>";
        } elseif ($mp_num_preg_sin_contestar[0]->cuenta > 1) {
            $alerta_experto_preguntas = "
    <div class='alert alert-danger' role='alert'>
          <strong>Existen " . $mp_num_preg_sin_contestar[0]->cuenta . " preguntas sin contestar</strong><br>Has click en el boton Responder, para contestar.<br> Tu respuesta quedara publicada en la Comunidad.
    </div>";
        } else {
            $alerta_experto_preguntas = "";
        }
        $PRINCIPAL = str_replace("{PREGUNTAS_COMUNIDAD_PARA_RESPONDER}", utf8_encode($total_preguntas_sin_responder), $PRINCIPAL);
        $PRINCIPAL = str_replace("{TITULO_PREGUNTAS_COMUNIDAD_PARA_RESPONDER}", utf8_encode($alerta_experto_preguntas), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{PREGUNTAS_COMUNIDAD_PARA_RESPONDER}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{TITULO_PREGUNTAS_COMUNIDAD_PARA_RESPONDER}", "", $PRINCIPAL);
    }
    $PRINCIPAL                      = str_replace("{GRUPO_INTERES_1}", utf8_encode($mas_grupo_interes1[0]->categoria), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{GRUPO_INTERES_2}", utf8_encode($mas_grupo_interes2[0]->categoria), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{GRUPO_INTERES_3}", utf8_encode($mas_grupo_interes3[0]->categoria), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_MAS_PUBLICADOR_GRUPO_INTERES_1}", utf8_encode($total_mas_post_grupo_interes1), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_MAS_PUBLICADOR_GRUPO_INTERES_2}", utf8_encode($total_mas_post_grupo_interes2), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_MAS_PUBLICADOR_GRUPO_INTERES_3}", utf8_encode($total_mas_post_grupo_interes3), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{COM_MP_FRASES}", utf8_encode($total_mp_com_frases), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_POST_VALORADOS}", utf8_encode($total_posteos_mas_valorados), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{MP_NOVEDADES}", utf8_encode($total_posteos_novedades), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{MP_FOTOS}", utf8_encode($total_posteos_fotos), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{MIS_CAPACITACIONES_novedades}", utf8_encode($total_posteos_capacitaciones), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_PEOPLE_INTERACCIONES}", utf8_encode($total_people_mas_interacc), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_PEOPLE_MAS_SEGUIDOS}", utf8_encode($total_people_mas_seguida), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_PEOPLE_MAS_PUNTOS}", utf8_encode($total_people_mas_puntos), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{AGRUPACION_CATEGORIAS}", utf8_encode($total_agrup_categoria), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_PEOPLE_EXPERTOS}", utf8_encode($total_agrup_categoria_expertos), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_PEOPLE_QUESIGO}", utf8_encode($total_people_quesigo), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{ROW_TIPO_PUBLICACION}", utf8_encode($total_agrup_tipos), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{AGRUPACION_AMBITOS}", utf8_encode($total_agrup_ambitos), $PRINCIPAL);
    $PRINCIPAL                      = str_replace("{TAG_CLOUD}", utf8_encode($total_listado_tag_cloud), $PRINCIPAL);
    //Mini encuesta
    $total_mini_encuestas           = com_mp_mini_encuesta($id_empresa, $rut);
    $total_mini_encuesta_titulo     = "";
    $total_mini_encuesta_opciones   = "";
    $total_mini_encuesta_resultados = "";
    foreach ($total_mini_encuestas as $total_mini_encuesta) {
        //print_r($total_mini_encuesta);
        $total_mini_encuesta_titulo .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_titulo.html");
        $total_mini_encuesta_titulo = str_replace("{MINI_ENCUESTA_PREGUNTA}", ($total_mini_encuesta->pregunta), $total_mini_encuesta_titulo);
        if ($total_mini_encuesta->respuesta == 0) {
            //muestra  opciones
            if ($total_mini_encuesta->opcion1 <> '') {
                $total_mini_encuesta_opciones .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_opciones.html");
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION}", ($total_mini_encuesta->opcion1), $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION_ID}", "opcion1", $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_ID}", $total_mini_encuesta->id, $total_mini_encuesta_opciones);
            }
            if ($total_mini_encuesta->opcion2 <> '') {
                $total_mini_encuesta_opciones .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_opciones.html");
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION}", ($total_mini_encuesta->opcion2), $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION_ID}", "opcion2", $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_ID}", $total_mini_encuesta->id, $total_mini_encuesta_opciones);
            }
            if ($total_mini_encuesta->opcion3 <> '') {
                $total_mini_encuesta_opciones .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_opciones.html");
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION}", ($total_mini_encuesta->opcion3), $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION_ID}", "opcion3", $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_ID}", $total_mini_encuesta->id, $total_mini_encuesta_opciones);
            }
            if ($total_mini_encuesta->opcion4 <> '') {
                $total_mini_encuesta_opciones .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_opciones.html");
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION}", ($total_mini_encuesta->opcion4), $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_OPCION_ID}", "opcion4", $total_mini_encuesta_opciones);
                $total_mini_encuesta_opciones = str_replace("{MINI_ENCUESTA_ID}", $total_mini_encuesta->id, $total_mini_encuesta_opciones);
            }
        } else {
            //muestra  respuesta
            if ($total_mini_encuesta->opcion1 <> '') {
                $total_mini_encuesta_resultados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_resultados.html");
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_PORCENTAJE}", $total_mini_encuesta->porcop1 . "%", $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_TEXTO}", $total_mini_encuesta->opcion1, $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_NUMERO}", $total_mini_encuesta->porcop1, $total_mini_encuesta_resultados);
            }
            if ($total_mini_encuesta->opcion2 <> '') {
                $total_mini_encuesta_resultados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_resultados.html");
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_PORCENTAJE}", $total_mini_encuesta->porcop2 . "%", $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_TEXTO}", $total_mini_encuesta->opcion2, $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_NUMERO}", $total_mini_encuesta->porcop2, $total_mini_encuesta_resultados);
            }
            if ($total_mini_encuesta->opcion3 <> '') {
                $total_mini_encuesta_resultados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_resultados.html");
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_PORCENTAJE}", $total_mini_encuesta->porcop3 . "%", $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_TEXTO}", $total_mini_encuesta->opcion3, $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_NUMERO}", $total_mini_encuesta->porcop3, $total_mini_encuesta_resultados);
            }
            if ($total_mini_encuesta->opcion4 <> '') {
                $total_mini_encuesta_resultados .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_encuesta_mini_resultados.html");
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_PORCENTAJE}", $total_mini_encuesta->porcop4 . "%", $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_TEXTO}", $total_mini_encuesta->opcion4, $total_mini_encuesta_resultados);
                $total_mini_encuesta_resultados = str_replace("{MINI_ENCUESTA_OPCION_NUMERO}", $total_mini_encuesta->porcop4, $total_mini_encuesta_resultados);
            }
        }
    }
    $PRINCIPAL = str_replace("{ENCUESTA_MINI_TITULO_PREGUNTA}", utf8_encode($total_mini_encuesta_titulo), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ENCUESTA_MINI_OPCIONES}", utf8_encode($total_mini_encuesta_opciones), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ENCUESTA_MINI_RESULTADOS}", utf8_encode($total_mini_encuesta_resultados), $PRINCIPAL);
    if ($tipo_query == "" and $ambiente == "" AND $rut_enviado == "") {
        //echo "<br><br><br><br><br><br>hola";
        $PRINCIPAL = str_replace("{ROW_CARGAS_MAS}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_personal_solo_post_cargar.html"), $PRINCIPAL);
    } else {
        //echo "<br><br><br><br><br><br>chao";
        // $PRINCIPAL = str_replace("{ROW_CARGAS_MAS}","",$PRINCIPAL);
        $PRINCIPAL = str_replace("{ROW_CARGAS_MAS}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_personal_solo_post_cargar.html"), $PRINCIPAL);
    }
    $arreglo_get               = $_GET;
    $array_para_enviar_via_url = serialize($arreglo_get);
    $array_para_enviar_via_url = urlencode($array_para_enviar_via_url);
    $PRINCIPAL                 = str_replace("{VARIABLES_GET_ENCODEADAS}", $array_para_enviar_via_url, $PRINCIPAL);
    //    $mp_comp_estadistica=MPO_Compestadistica($id_empresa);
    $categorias_mp             = TraeCategoriasMejoresPracticas($id_empresa);
    $options_categorias        = "";
    foreach ($categorias_mp as $cat) {
        $options_categorias .= "<option value='" . $cat->id_categoria . "'>" . $cat->categoria . "</option>";
    }
    $PRINCIPAL                    = str_replace("{CATEGORIAS_FORM}", utf8_encode($options_categorias), $PRINCIPAL);
    // notificaciones sin ver
    // Mis Notificaciones
    $com_mp_mis_notificaciones    = mp_interacciones_notificaciones_home($rut, $id_empresa, "");
    //print_r($com_mp_mis_notificaciones); echo "5613";
    $cuenta_notificaciones        = 0;
    $cuenta_notificaciones_sinver = 0;
    $total_notificaciones         = "";
    foreach ($com_mp_mis_notificaciones as $com_mp_mi_notificacion) {
        $muestra = 0;
        $cuenta_notificaciones++;
        $ico   = "";
        $texto = "";
        if ($com_mp_mi_notificacion->tipo == "COMENTARIO") {
            $ico = '<i class="icon-speech icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small>';
            if ($com_mp_mi_notificacion->rutAutor == $Rut_Perfil) {
                $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut_remitente . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreRemitente . '</strong>
                    </a> coment&oacute;:
                     tu publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
                if ($com_mp_mi_notificacion->visto_autor === null or $com_mp_mi_notificacion->visto_autor <> 1) {
                    $cuenta_notificaciones_sinver++;
                    $muestra = 1;
                }
            } else {
                $texto = 'Comentaste la publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '">
                    <strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a>  ';
            }
        }
        if ($com_mp_mi_notificacion->tipo == "SEGUIDO" and $Rut_Perfil <> $com_mp_mi_notificacion->rut_remitente) {
            $ico = '<i class="icon-user icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
            if ($com_mp_mi_notificacion->rut_remitenteAutor == $Rut_Perfil) {
                $texto = 'Seguiste a <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a>';
            } else {
                $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut_remitente . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreRemitente . '</strong> te sigue';
                if ($com_mp_mi_notificacion->visto === null or $com_mp_mi_notificacion->visto <> 1 and $com_mp_mi_notificacion->rut_remitente <> $Rut_Perfil) {
                    $cuenta_notificaciones_sinver++;
                    $muestra = 1;
                }
            }
        }
        //publicaciones sin ver
        //echo "<br> rut $Rut_Perfil==".$com_mp_mi_notificacion->rut_remitente;
        if ($com_mp_mi_notificacion->tipo == "PUBLICACION_SEGUIDO" and $Rut_Perfil == $com_mp_mi_notificacion->rut_remitente) {
            if ($com_mp_mi_notificacion->rut_remitenteAutor <> $Rut_Perfil) {
                $ico   = '<i class="icon-user icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
                //echo "<br> sigues a que publico ".$com_mp_mi_notificacion->rut_autor;
                //exit();
                $texto = $com_mp_mi_notificacion->NombreAutor . ' ha publicado
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '">
                    <strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a>  ';
                //echo "$com_mp_mi_notificacion->visto_remitente===null or $com_mp_mi_notificacion->visto_remitente<>1 and $com_mp_mi_notificacion->rut_remitente==$Rut_Perfil";
                if ($com_mp_mi_notificacion->visto_remitente === null or $com_mp_mi_notificacion->visto_remitente <> 1 and $com_mp_mi_notificacion->rut_remitente == $Rut_Perfil) {
                    $cuenta_notificaciones_sinver++;
                    $muestra = 1;
                }
            }
        }
        if ($com_mp_mi_notificacion->tipo == "MEGUSTA") {
            $ico = '<i class="icon-thumbs-up icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
            if ($com_mp_mi_notificacion->rut == $Rut_Perfil) {
                $texto = 'Te gusta la publicaci&oacute;n <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '">
                    <strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
            } else {
                $texto = 'A <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a> le Gusta tu publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
                if ($com_mp_mi_notificacion->visto_autor === null or $com_mp_mi_notificacion->visto_autor <> 1) {
                    $cuenta_notificaciones_sinver++;
                    $muestra = 1;
                }
            }
        }
        if ($com_mp_mi_notificacion->tipo == "GRUPOSEGUIDO") {
            $ico = '<i class="icon-people icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
            if ($com_mp_mi_notificacion->rut == $Rut_Perfil) {
                $texto = 'Seguiste el Grupo de Inter&eacute;s
                    <a href="?sw=com_mp_personal&amb=mp_cat&idcat=' . $com_mp_mi_notificacion->contenido . '&cat=' . $com_mp_mi_notificacion->NombreCategoria . '">
                    <strong>' . $com_mp_mi_notificacion->NombreCategoria . '</strong></a>
                    ';
            }
        }
        if ($com_mp_mi_notificacion->tipo == "COMPARTIDOCONMIGO") {
            $ico = '<i class="icon-share icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
            if ($com_mp_mi_notificacion->rut <> $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente <> $Rut_Perfil and $com_mp_mi_notificacion->rut == $com_mp_mi_notificacion->rut_remitente) {
                $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a> guard&oacute; tu publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
                if ($com_mp_mi_notificacion->visto_autor === null or $com_mp_mi_notificacion->visto_autor <> 1) {
                    $cuenta_notificaciones_sinver++;
                    $muestra = 1;
                }
            } elseif ($com_mp_mi_notificacion->rut == $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente == $Rut_Perfil) {
                $texto = 'Guardaste la publicaci&oacute;n <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '">
                    <strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
            } elseif ($com_mp_mi_notificacion->rut == $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente <> $Rut_Perfil) {
                $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreRemitente . '</strong>
                    </a> comparti&oacute; contigo la publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a>';
                if ($com_mp_mi_notificacion->visto === null or $com_mp_mi_notificacion->visto <> 1) {
                    $cuenta_notificaciones_sinver++;
                    $muestra = 1;
                }
            } elseif ($com_mp_mi_notificacion->rut <> $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente == $Rut_Perfil) {
                $texto = 'Compartiste con <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a> la publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a>
                    ';
            }
        }
        if ($muestra == 1 and $cuenta_notificaciones_sinver <= 10) {
            $total_notificaciones .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_perfil_mis_notificaciones_mini.html");
            $total_notificaciones = str_replace("{ICO}", ($ico), $total_notificaciones);
            $total_notificaciones = str_replace("{TEXTO}", ($texto), $total_notificaciones);
        }
    }
    $PRINCIPAL = str_replace("{MI_RUT}", $rut, $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_COMP_MP_MIS_NOTIFICACIONES_SIN_VER}", utf8_encode($total_notificaciones), $PRINCIPAL);
    if ($cuenta_notificaciones_sinver > 0) {
        $PRINCIPAL = str_replace("{NUM_NOTIFICACIONES_SINVER_GLOBO}", "<span class='badge_bell badge-default-bell'>" . $cuenta_notificaciones_sinver . " </span> ", $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{NUM_NOTIFICACIONES_SINVER_GLOBO}", "", $PRINCIPAL);
    }
    $PRINCIPAL = str_replace("{COMP_MP_PUBLICACIONES_TOTALES}", $mp_comp_estadistica[0]->CuentaPublicaciones, $PRINCIPAL);
    $PRINCIPAL = str_replace("{COMP_MP_PUBLICACIONES_TOTALES}", $mp_comp_estadistica[0]->CuentaPublicaciones, $PRINCIPAL);
    $PRINCIPAL = str_replace("{COMP_MP_VISTAS_TOTALES}", $mp_comp_estadistica[0]->CuentaVisitas, $PRINCIPAL);
    $PRINCIPAL = str_replace("{COMP_MP_FAVORITAS_TOTALES}", $mp_comp_estadistica[0]->CuentaFavoritas, $PRINCIPAL);
    $PRINCIPAL = str_replace("{COMP_MP_MEGUSTA_TOTALES}", $mp_comp_estadistica[0]->CuentaMeGusta, $PRINCIPAL);
    return ($PRINCIPAL);
}
function com_mp_full($PRINCIPAL, $id_empresa, $id_mp)
{
    $unico = com_mp_full_data($id_empresa, $id_mp);
    //print_r($unico);
    $rut   = $_SESSION["user_"];
    if ($_GET["c"] == 1) {
        $PRINCIPAL = str_replace("{DISPLAY_BLOQUE_COMPARTIR}", "block", $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{DISPLAY_BLOQUE_COMPARTIR}", "none", $PRINCIPAL);
    }
    $PRINCIPAL        = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones_full.html"), $PRINCIPAL);
    $tiene_no_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $id_mp, "NOMEGUSTA", $rut);
    if ($tiene_no_megusta) {
        $PRINCIPAL = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_nomegusta.html"), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_nomegusta.html"), $PRINCIPAL);
    }
    $PRINCIPAL                    = ColocaCantidadDeNoMegusta($PRINCIPAL, $id_mp, $id_empresa);
    $Rut_Perfil                   = $rut;
    // Mis Notificaciones
    $com_mp_mis_notificaciones    = mp_interacciones_notificaciones($Rut_Perfil, $id_empresa, "");
    //print_r($com_mp_mis_notificaciones); echo "5773";
    $cuenta_notificaciones        = 0;
    $cuenta_notificaciones_sinver = 0;
    $total_notificaciones         = "";
    foreach ($com_mp_mis_notificaciones as $com_mp_mi_notificacion) {
        $cuenta_notificaciones++;
        if ($com_mp_mi_notificacion->visto <> 1) {
            $cuenta_notificaciones_sinver++;
        }
        $ico   = "";
        $texto = "";
        if ($com_mp_mi_notificacion->tipo == "COMENTARIO") {
            $ico = '<i class="icon-speech icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small>';
            if ($com_mp_mi_notificacion->rutAutor == $Rut_Perfil) {
                $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut_remitente . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreRemitente . '</strong>
                    </a> coment&oacute;:
                    <em>' . $com_mp_mi_notificacion->mensaje . '</em> en tu publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
            } else {
                $texto = 'Comentaste:
                    <em>' . $com_mp_mi_notificacion->mensaje . '</em> en la publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '">
                    <strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> de
                    <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rutAutor . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreAutor . '</strong>
                    </a> ';
            }
        }
        if ($com_mp_mi_notificacion->tipo == "SEGUIDO") {
            $ico = '<i class="icon-user icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
            if ($com_mp_mi_notificacion->rut_remitenteAutor == $Rut_Perfil) {
                $texto = 'Seguiste a <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a>';
            } else {
                $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut_remitente . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreRemitente . '</strong> te sigue ';
            }
        }
        if ($com_mp_mi_notificacion->tipo == "MEGUSTA") {
            $ico = '<i class="icon-thumbs-up icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
            if ($com_mp_mi_notificacion->rut == $Rut_Perfil) {
                $texto = 'Te gusta la publicaci&oacute;n <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '">
                    <strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> de
                    <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rutAutor . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreAutor . '</strong>
                    </a>';
            } else {
                $texto = 'A <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a> le Gusta tu publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
            }
        }
        if ($com_mp_mi_notificacion->tipo == "GRUPOSEGUIDO") {
            $ico = '<i class="icon-people icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
            if ($com_mp_mi_notificacion->rut == $Rut_Perfil) {
                $texto = 'Seguiste el Grupo de Inter&eacute;s
                    <a href="?sw=com_mp_personal&amb=mp_cat&idcat=' . $com_mp_mi_notificacion->contenido . '&cat=' . $com_mp_mi_notificacion->NombreCategoria . '">
                    <strong>' . $com_mp_mi_notificacion->NombreCategoria . '</strong></a>
                    ';
            }
        }
        if ($com_mp_mi_notificacion->tipo == "COMPARTIDOCONMIGO") {
            $ico = '<i class="icon-share icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
            if ($com_mp_mi_notificacion->rut <> $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente <> $Rut_Perfil and $com_mp_mi_notificacion->rut == $com_mp_mi_notificacion->rut_remitente) {
                $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a> guard&oacute; tu publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
            } elseif ($com_mp_mi_notificacion->rut == $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente == $Rut_Perfil) {
                $texto = 'Guardaste la publicaci&oacute;n <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '">
                    <strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> de
                    <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rutAutor . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreAutor . '</strong>
                    </a>';
            } elseif ($com_mp_mi_notificacion->rut == $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente <> $Rut_Perfil) {
                $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreRemitente . '</strong>
                    </a> comparti&oacute; contigo la publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a>
                    de
                    <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rutAutor . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreAutor . '</strong>
                    ';
            } elseif ($com_mp_mi_notificacion->rut <> $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente == $Rut_Perfil) {
                $texto = 'Compartiste con <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a> la publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a>
                    de
                    <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rutAutor . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreAutor . '</strong>
                    ';
            }
        }
        $total_notificaciones .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_perfil_mis_notificaciones.html");
        $total_notificaciones = str_replace("{ICO}", ($ico), $total_notificaciones);
        $total_notificaciones = str_replace("{TEXTO}", ($texto), $total_notificaciones);
    }
    $PRINCIPAL            = ColocaMegustaFavoritos($PRINCIPAL, $id_empresa, $id_mp, $_SESSION["user_"]);
    $datos_usuario_perfil = UsuarioEnBasePersonas($unico[0]->rut);
    if ($unico[0]->rut == $rut) {
        $PRINCIPAL = str_replace("{EDITAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_editar_mp.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ELIMINAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_borrar_mp.html"), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{EDITAR_MP}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ELIMINAR_MP}", "", $PRINCIPAL);
    }
    //$cuentaComentarios=CuentaComentarioPost($id_empresa, $id_mp);
    $PRINCIPAL = str_replace("{NOMBRE_MP}", utf8_encode($unico[0]->nombre), $PRINCIPAL);
    $PRINCIPAL = str_replace("{NUMEROCOMENTARIOS}", $unico[0]->numcomentarios, $PRINCIPAL);
    $PRINCIPAL = str_replace("{RUT_ENVIADO}", utf8_encode($unico[0]->rut), $PRINCIPAL);
    if ($id_empresa == '62') {
        $url_mp_comparte = "https://www.compartebci.cl/front/?sw=login_ext%26ambiente=com_mp_full%26id_mp=" . $id_mp . "";
    }
    $PRINCIPAL = str_replace("{URL_MP_COMPARTE}", ($url_mp_comparte), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ID_MP}", $id_mp, $PRINCIPAL);
    $PRINCIPAL = str_replace("{RUT}", $_SESSION["user_"], $PRINCIPAL);
    $PRINCIPAL = str_replace("{TIPO}", "A", $PRINCIPAL);
    if ($unico[0]->imagenfondo) {
        $PRINCIPAL = str_replace("{BLOQUE_PARA_IMAGEN}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_imagen.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{IMAGEN_POST_SUPERIOR}", $unico[0]->imagenfondo, $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_PARA_IMAGEN}", "", $PRINCIPAL);
    }
    if ($unico[0]->video) {
        $video_youtube = ColocaVideoYoutube($unico[0]->video, $unico[0]->id_mp);
        $PRINCIPAL     = str_replace("{BLOQUE_VIDEO}", $video_youtube, $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_VIDEO}", "", $PRINCIPAL);
    }
    $PRINCIPAL      = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($unico[0]->rut), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{NOMBRE_AUTOR}", utf8_encode($datos_usuario_perfil[0]->nombre_completo), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{CONTENIDO_FULL_MP}", utf8_encode($unico[0]->contenido), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{RESUMEN_FULL_MP}", utf8_encode($unico[0]->resumen), $PRINCIPAL);
    $post_categoria = '<a href="?sw=com_mp_personal&amb=mp_cat&idcat=' . $unico[0]->id_categoria . '&cat=' . $unico[0]->categoria . '"><span class="badge_small badge-azul"><span class="blanco">
            <i class="icon-people icons"></i> ' . utf8_encode($unico[0]->categoria) . '</span></span></a>';
    $PRINCIPAL      = str_replace("{NUMVISITAS}", round($unico->numvisitas), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{NUMMEGUSTA}", ($unico->nummegusta), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{NUMCOMPARTIDA}", ($unico->numcompartido), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{NUMCOMENTARIO}", ("hola"), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{NUMCOMENTARIOSREALES}", ($unico->numcomentariosreales), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{NUMFAVORITA}", ($unico->numfavorita), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{ESTILOESTADO}", ($unico->estilo), $PRINCIPAL);
    if ($unico[0]->tipo == "MejorPractica") {
        $ico = "img/bci_mp_practica_icon.png";
    }
    if ($unico[0]->tipo == "Papers") {
        $ico = "img/bci_mp_paper_icon.png";
    }
    if ($unico[0]->tipo == "Publicacion") {
        $ico = "img/bci_mp_publicacion.png";
    }
    if ($unico[0]->tipo == "Video" or $unico[0]->tipo == "VideoInterno") {
        $ico = "img/bci_mp_practica_video.png";
    }
    if ($unico[0]->tipo == "Links" or $unico[0]->tipo == "LinkExterno") {
        $ico = "img/bci_mp_link_icon.png";
    }
    if ($unico[0]->tipo == "Experiencias") {
        $ico = "img/bci_mp_experiencias_icon.png";
    }
    if ($unico[0]->tipo == "Experto") {
        $ico = "img/bci_mp_experto_icon.png";
    }
    if ($unico[0]->tipo == "OportunidadMejora") {
        $ico = "img/bci_mp_oportunidadmejora_icon.png";
    }
    if ($unico[0]->tipo == "Udnolohaga") {
        $ico = "img/bci_mp_udnolohaga_icon.png";
    }
    if ($unico[0]->tipo == "RRPP") {
        $ico = "img/bci_mp_rrpp_icon.png";
    }
    if ($unico[0]->tipo == "Pregunta") {
        $ico = "img/bci_mp_pregunta_icon.png";
    }
    if ($unico[0]->tipo == "Respuesta") {
        $ico = "img/bci_mp_pregunta_icon.png";
    }
    //echo "ico $ico tipo ".$unico->tipo." tipo sub 0 ".$unico->tipo[0];
    $PRINCIPAL = str_replace("{FECHA}", formatearFechaSmall($unico[0]->fecha), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ICONOESTADO}", ($unico->icono_estado), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ICONO}", ($ico), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ICONO_DESC}", ($unico[0]->tipo), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ESTILOCATEGORIA}", ($unico->style), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ICONOCATEGORIA}", ($unico->icono), $PRINCIPAL);
    $PRINCIPAL = str_replace("{CATEGORIA_MP}", ($post_categoria), $PRINCIPAL);
    if ($unico->tipo_multimedia == "imagen") {
        $imagen = "../../front/multimedia/" . $unico->multimedia;
    } else {
        $imagen = "";
    }
    if ($unico->tipo_multimedia == "video") {
        $video = "../../front/multimedia/" . $unico->multimedia;
    } else {
        $video = "";
    }
    $PRINCIPAL           = str_replace("{IMAGEN_POST}", "multimedia/" . $unico->imagenfondo, $PRINCIPAL);
    $PRINCIPAL           = str_replace("{VIDEO}", ($video), $PRINCIPAL);
    $PRINCIPAL           = str_replace("{TIPOMULTIMEDIA}", ($unico->tipo_multimedia), $PRINCIPAL);
    $listado_comentarios = MuestraComentariosPorPost($unico[0]->id_mp);
    $PRINCIPAL           = str_replace("{BLOQUE_COMENTARIOS}", $listado_comentarios, $PRINCIPAL);
    if ($unico[0]->url_documento) {
        $PRINCIPAL = str_replace("{BLOQUE_URL_DOCUMENTO}", file_get_contents("views/comunidad_mp/row_com_mp_url_documento.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{URL_DOCUMENTO}", ($unico[0]->url_documento), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_URL_DOCUMENTO}", "", $PRINCIPAL);
    }
    $video_youtube       = ColocaVideoYoutube($unico->video, $unico->id_mp);
    $bloque_imagen_fondo = ColocaImagenPost($unico->imagenfondo);
    //echo $imagen;
    if ($unico->video) {
        $PRINCIPAL = str_replace("{VIDEO_IMAGEN}", $video_youtube, $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{VIDEO_IMAGEN}", $bloque_imagen_fondo, $PRINCIPAL);
    }
    //tags por post
    $TagsPorPosts = TagsPorMPEmpresa($id_mp, $id_empresa);
    $tag_por_post = "";
    foreach ($TagsPorPosts as $TagsPorPost) {
        $aitag++;
        if ($aitag == 1) {
            $tag1 = $TagsPorPost->tag;
        }
        if ($aitag == 2) {
            $tag2 = $TagsPorPost->tag;
        }
        $tag_por_post .= '<a href="?sw=com_mp_personal&amb=mp_tag&tag=' . $TagsPorPost->tag . '"><span class="badge_small badge-white"><span class="negro">#' . $TagsPorPost->tag . '</span></span></a> ';
    }
    $PRINCIPAL               = str_replace("{TAGS_POR_POST}", (utf8_encode($tag_por_post)), $PRINCIPAL);
    $limit                   = 9;
    $total_listado_tags      = com_mp_tag_data($id_empresa, $rut, $limit);
    $total_listado_tag_cloud = "";
    foreach ($total_listado_tags as $total_listado_tag_unico) {
        $total_listado_tag_cloud .= file_get_contents("views/comunidad_mp/com_mp_row_tag_cloud_search.html");
        $total_listado_tag_cloud = str_replace("{TAG}", $total_listado_tag_unico->tag, $total_listado_tag_cloud);
        $total_listado_tag_cloud = str_replace("{NUM}", $total_listado_tag_unico->cuenta, $total_listado_tag_cloud);
        $link                    = "?sw=com_mp_personal&amb=mp_tag&tag=" . $total_listado_tag_unico->tag . "";
        $total_listado_tag_cloud = str_replace("{LINK}", $link, $total_listado_tag_cloud);
    }
    $categorias_mp      = TraeCategoriasMejoresPracticas($id_empresa);
    $options_categorias = "";
    foreach ($categorias_mp as $cat) {
        $options_categorias .= "<option value='" . $cat->id_categoria . "'>" . $cat->categoria . "</option>";
    }
    $PRINCIPAL                    = str_replace("{CATEGORIAS_FORM}", utf8_encode($options_categorias), $PRINCIPAL);




    //TIMELINE SIMILARES
    $todas                        = com_mp_similares_data($id_empresa, $id_mp, $unico[0]->id_categoria);
    $total_listado_post_recientes = "";
    foreach ($todas as $unico) {
        //echo "id ".$unico->video." or ".$unico->imagenfondo." ";
        $total_listado_post_recientes .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_persona_listado_tipoST.html");
        //echo "views/comunidad_mp/".$template.$id_empresa."_row_com_mp_persona_listado_tipoST.html";
        $total_listado_post_recientes = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_listado_post_recientes);
        $tiene_megusta                = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $unico->id_mp, "MEGUSTA", $rut);
        if ($tiene_megusta) {
            $total_listado_post_recientes = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta.html"), $total_listado_post_recientes);
        } else {
            $total_listado_post_recientes = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta.html"), $total_listado_post_recientes);
        }
        $total_listado_post_recientes = ColocaCantidadDeMegusta($total_listado_post_recientes, $unico->id_mp, $id_empresa);
        $tiene_favorito               = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $unico->id_mp, "FAVORITA", $rut);
        if ($tiene_favorito) {
            $total_listado_post_recientes = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_favorito.html"), $total_listado_post_recientes);
        } else {
            $total_listado_post_recientes = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_favorito.html"), $total_listado_post_recientes);
        }
        $total_listado_post_recientes = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_listado_post_recientes);
        $total_listado_post_recientes = ColocaCantidadDeFavorito($total_listado_post_recientes, $unico->id_mp, $id_empresa);
        $total_listado_post_recientes = str_replace("{ID_MP}", $unico->id_mp, $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{TIPO}", "A", $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{LINK}", $link_MP, $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{CATEGORIA_MP}", ($unico->categoria), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($unico->descripcion_categoria), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{NOMBRE}", ($unico->nombre), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{CONTENIDO}", limit_text($unico->contenido, 35), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{FECHA}", formatearFechaSmall($unico->fecha), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{ESTADO}", ($unico->estado), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{DESCRIPCION_ESTADO}", ($unico->descripcion_estado), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{RUT_AUTOR}", ($unico->rut), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{RUT}", ($rut), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{NOMBRE_AUTOR}", ($unico->nombre_autor), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($unico->rut), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{NUMVISITAS}", round($unico->numvisitas), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{NUMMEGUSTA}", ($unico->nummegusta), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{NUMCOMPARTIDA}", ($unico->numcompartido), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{NUMCOMENTARIO}", ($unico->numcomentarios), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{NUMCOMENTARIOSREALES}", ($unico->numcomentariosreales), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{NUMFAVORITA}", ($unico->numfavorita), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{ESTILOESTADO}", ($unico->estilo), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{ICONOESTADO}", ($unico->icono_estado), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{ESTILOCATEGORIA}", ($unico->style), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{ICONOCATEGORIA}", ($unico->icono), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{CATEGORIA_MP}", ($unico->categoria), $total_listado_post_recientes);
        if ($unico->tipo_multimedia == "imagen" and $unico->imagen_fondo <> '') {
            $imagen = "../../front/multimedia/" . $unico->multimedia;
        } else {
            $imagen = "";
        }
        if ($unico->tipo_multimedia == "video") {
            $video = "../../front/multimedia/" . $unico->multimedia;
        } else {
            $video = "";
        }

        //echo "video $video";
        $total_listado_post_recientes = str_replace("{IMAGEN_POST}", "multimedia/" . $unico->imagenfondo, $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{VIDEO}", ($video), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{TIPOMULTIMEDIA}", ($unico->tipo_multimedia), $total_listado_post_recientes);
       // $listado_comentarios          = MuestraComentariosPorPost($unico->id_mp);
       $total_listado_post_recientes = str_replace("{BLOQUE_COMENTARIOS}", $listado_comentarios, $total_listado_post_recientes);
        if ($unico->url_documento<>'' and $unico->url_documento<>'{LINK_DOCUMENTO}') {
            $total_listado_post_recientes = str_replace("{BLOQUE_URL_DOCUMENTO}", file_get_contents("views/comunidad_mp/row_com_mp_url_documento.html"), $total_listado_post_recientes);
            $total_listado_post_recientes = str_replace("{URL_DOCUMENTO}", ($unico->url_documento), $total_listado_post_recientes);
        } else {
            $total_listado_post_recientes = str_replace("{BLOQUE_URL_DOCUMENTO}", "", $total_listado_post_recientes);
        }
        if ($unico->video<>'' and $unico->video<>'{LINK_YOUTUBE}') {
            $video_youtube                = ColocaVideoYoutube($unico->video, $unico->id_mp);
            $total_listado_post_recientes = str_replace("{VIDEO_IMAGEN}", $video_youtube, $total_listado_post_recientes);
        } else {
            $bloque_imagen_fondo          = ColocaImagenPost($unico->imagenfondo);
            $total_listado_post_recientes = str_replace("{VIDEO_IMAGEN}", $bloque_imagen_fondo, $total_listado_post_recientes);
        }
        //tags por post
        $TagsPorPosts = TagsPorMPEmpresa($unico->id_mp, $id_empresa);
        $tag_por_post = "";
        foreach ($TagsPorPosts as $TagsPorPost) {
            $tag_por_post .= '<a href="?sw=com_mp_personal&amb=mp_tag&tag=' . $TagsPorPost->tag . '"><span class="badge_small badge-white"><span class="negro">#' . $TagsPorPost->tag . '</span></span></a> ';
        }
        $total_listado_post_recientes = str_replace("{TAGS_POR_POST}", ($tag_por_post), $total_listado_post_recientes);
    }
    $PRINCIPAL          = str_replace("{NUM_FAV}", MPbuscaFav($rut, $id_empresa), $PRINCIPAL);
    $PRINCIPAL          = str_replace("{NUM_MISPR}", MPbuscaMp($rut, $id_empresa), $PRINCIPAL);
    $PRINCIPAL          = str_replace("{INSIGNIA}", "", $PRINCIPAL);
    $PRINCIPAL          = str_replace("{RUT_USUARIO}", $rut, $PRINCIPAL);
    $PRINCIPAL          = str_replace("{ROW_LISTADO_TIMELINE_PERSONAL}", utf8_encode($total_listado), $PRINCIPAL);
    $PRINCIPAL          = str_replace("{ROW_LISTADO_TIMELINE_PERSONAL_PART2}", utf8_encode($total_listado_1row), $PRINCIPAL);
    $PRINCIPAL          = str_replace("{PERFIL_PERSONAL_COMUNIDAD_MP}", utf8_encode($perfil_personal), $PRINCIPAL);
    $PRINCIPAL          = str_replace("{POST_FIJOS_COMUNIDAD_MP}", utf8_encode($post_fijo_personal), $PRINCIPAL);
    $PRINCIPAL          = str_replace("{POST_ESTADISTICAS_COMUNIDAD_MP}", utf8_encode($post_fijo_estadisticas), $PRINCIPAL);
    $PRINCIPAL          = str_replace("{MIRUT}", $rut, $PRINCIPAL);
    $PRINCIPAL          = str_replace("{ROW_PUBLICACIONES_MISMO_TAG}", utf8_encode($total_listado_post_recientes), $PRINCIPAL);
    $categorias_mp      = TraeCategoriasMejoresPracticas($id_empresa);
    $options_categorias = "";
    foreach ($categorias_mp as $cat) {
        $options_categorias .= "<option value='" . $cat->id_categoria . "'>" . $cat->categoria . "</option>";
    }
    $PRINCIPAL = str_replace("{CATEGORIAS}", utf8_encode($options_categorias), $PRINCIPAL);
    $PRINCIPAL = str_replace("{RUT_ENCODEADO}", Encodear3($_SESSION["user_"]), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ID_MP_ENCODEADO}", Encodear3($id_mp), $PRINCIPAL);
    $PRINCIPAL = str_replace("{MI_RUT}", $rut, $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_COMP_MP_MIS_NOTIFICACIONES_SIN_VER}", utf8_encode($total_notificaciones), $PRINCIPAL);
    if ($cuenta_notificaciones_sinver > 0) {
        $PRINCIPAL = str_replace("{NUM_NOTIFICACIONES_SINVER_GLOBO}", "<span class='badge_bell badge-default-bell'>" . $cuenta_notificaciones_sinver . " </span> ", $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{NUM_NOTIFICACIONES_SINVER_GLOBO}", "", $PRINCIPAL);
    }
    return ($PRINCIPAL);
}



function com_mp_full_stories($PRINCIPAL, $id_empresa, $id_mp)
{
    $unico = com_mp_full_Stories_data($id_empresa, $id_mp);
   // print_r($unico);
    $rut   = $_SESSION["user_"];
    if ($_GET["c"] == 1) {
        $PRINCIPAL = str_replace("{DISPLAY_BLOQUE_COMPARTIR}", "block", $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{DISPLAY_BLOQUE_COMPARTIR}", "none", $PRINCIPAL);
    }
    $PRINCIPAL        = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones_full.html"), $PRINCIPAL);
    $tiene_no_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $id_mp, "NOMEGUSTA", $rut);
    if ($tiene_no_megusta) {
        $PRINCIPAL = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_nomegusta.html"), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_nomegusta.html"), $PRINCIPAL);
    }
    $PRINCIPAL                    = ColocaCantidadDeNoMegusta($PRINCIPAL, $id_mp, $id_empresa);
    $Rut_Perfil                   = $rut;
    // Mis Notificaciones
    $com_mp_mis_notificaciones    = mp_interacciones_notificaciones($Rut_Perfil, $id_empresa, "");
    //print_r($com_mp_mis_notificaciones); echo "5773";
    $cuenta_notificaciones        = 0;
    $cuenta_notificaciones_sinver = 0;
    $total_notificaciones         = "";
    foreach ($com_mp_mis_notificaciones as $com_mp_mi_notificacion) {
        $cuenta_notificaciones++;
        if ($com_mp_mi_notificacion->visto <> 1) {
            $cuenta_notificaciones_sinver++;
        }
        $ico   = "";
        $texto = "";
        if ($com_mp_mi_notificacion->tipo == "COMENTARIO") {
            $ico = '<i class="icon-speech icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small>';
            if ($com_mp_mi_notificacion->rutAutor == $Rut_Perfil) {
                $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut_remitente . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreRemitente . '</strong>
                    </a> coment&oacute;:
                    <em>' . $com_mp_mi_notificacion->mensaje . '</em> en tu publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
            } else {
                $texto = 'Comentaste:
                    <em>' . $com_mp_mi_notificacion->mensaje . '</em> en la publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '">
                    <strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> de
                    <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rutAutor . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreAutor . '</strong>
                    </a> ';
            }
        }
        if ($com_mp_mi_notificacion->tipo == "SEGUIDO") {
            $ico = '<i class="icon-user icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
            if ($com_mp_mi_notificacion->rut_remitenteAutor == $Rut_Perfil) {
                $texto = 'Seguiste a <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a>';
            } else {
                $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut_remitente . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreRemitente . '</strong> te sigue ';
            }
        }
        if ($com_mp_mi_notificacion->tipo == "MEGUSTA") {
            $ico = '<i class="icon-thumbs-up icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
            if ($com_mp_mi_notificacion->rut == $Rut_Perfil) {
                $texto = 'Te gusta la publicaci&oacute;n <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '">
                    <strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> de
                    <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rutAutor . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreAutor . '</strong>
                    </a>';
            } else {
                $texto = 'A <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a> le Gusta tu publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
            }
        }
        if ($com_mp_mi_notificacion->tipo == "GRUPOSEGUIDO") {
            $ico = '<i class="icon-people icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
            if ($com_mp_mi_notificacion->rut == $Rut_Perfil) {
                $texto = 'Seguiste el Grupo de Inter&eacute;s
                    <a href="?sw=com_mp_personal&amb=mp_cat&idcat=' . $com_mp_mi_notificacion->contenido . '&cat=' . $com_mp_mi_notificacion->NombreCategoria . '">
                    <strong>' . $com_mp_mi_notificacion->NombreCategoria . '</strong></a>
                    ';
            }
        }
        if ($com_mp_mi_notificacion->tipo == "COMPARTIDOCONMIGO") {
            $ico = '<i class="icon-share icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
            if ($com_mp_mi_notificacion->rut <> $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente <> $Rut_Perfil and $com_mp_mi_notificacion->rut == $com_mp_mi_notificacion->rut_remitente) {
                $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a> guard&oacute; tu publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
            } elseif ($com_mp_mi_notificacion->rut == $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente == $Rut_Perfil) {
                $texto = 'Guardaste la publicaci&oacute;n <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '">
                    <strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> de
                    <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rutAutor . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreAutor . '</strong>
                    </a>';
            } elseif ($com_mp_mi_notificacion->rut == $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente <> $Rut_Perfil) {
                $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreRemitente . '</strong>
                    </a> comparti&oacute; contigo la publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a>
                    de
                    <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rutAutor . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreAutor . '</strong>
                    ';
            } elseif ($com_mp_mi_notificacion->rut <> $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente == $Rut_Perfil) {
                $texto = 'Compartiste con <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a> la publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a>
                    de
                    <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rutAutor . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreAutor . '</strong>
                    ';
            }
        }
        $total_notificaciones .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_perfil_mis_notificaciones.html");
        $total_notificaciones = str_replace("{ICO}", ($ico), $total_notificaciones);
        $total_notificaciones = str_replace("{TEXTO}", ($texto), $total_notificaciones);
    }
    $PRINCIPAL            = ColocaMegustaFavoritos($PRINCIPAL, $id_empresa, $id_mp, $_SESSION["user_"]);
    $datos_usuario_perfil = UsuarioEnBasePersonas($unico[0]->rut);

    $unico[0]->imagenfondo=$unico[0]->imagen;

    if ($unico[0]->rut == $rut) {
        $PRINCIPAL = str_replace("{EDITAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_editar_mp.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ELIMINAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_borrar_mp.html"), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{EDITAR_MP}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ELIMINAR_MP}", "", $PRINCIPAL);
    }
    //$cuentaComentarios=CuentaComentarioPost($id_empresa, $id_mp);
    $PRINCIPAL = str_replace("{NOMBRE_MP}", utf8_encode($unico[0]->nombre), $PRINCIPAL);
    $PRINCIPAL = str_replace("{NUMEROCOMENTARIOS}", $unico[0]->numcomentarios, $PRINCIPAL);
    $PRINCIPAL = str_replace("{RUT_ENVIADO}", utf8_encode($unico[0]->rut), $PRINCIPAL);
    if ($id_empresa == '62') {
        $url_mp_comparte = "https://www.compartebci.cl/front/?sw=login_ext%26ambiente=com_mp_full%26id_mp=" . $id_mp . "";
    }
    $PRINCIPAL = str_replace("{URL_MP_COMPARTE}", ($url_mp_comparte), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ID_MP}", $id_mp, $PRINCIPAL);
    $PRINCIPAL = str_replace("{RUT}", $_SESSION["user_"], $PRINCIPAL);
    $PRINCIPAL = str_replace("{TIPO}", "A", $PRINCIPAL);

    //print_r($unico);
    if ($unico[0]->imagen and $unico[0]->video=='') {
        $PRINCIPAL = str_replace("{BLOQUE_PARA_IMAGEN}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_imagen.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{IMAGEN_POST_SUPERIOR}", $unico[0]->imagenfondo, $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_PARA_IMAGEN}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{IMAGEN_POST_SUPERIOR}", "", $PRINCIPAL);
    }
    if ($unico[0]->video) {
        $video_youtube = ColocaVideoYoutube($unico[0]->video, $unico[0]->id_mp);
        $PRINCIPAL     = str_replace("{BLOQUE_VIDEO}", $video_youtube, $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_VIDEO}", "", $PRINCIPAL);
    }
    $PRINCIPAL      = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($unico[0]->rut), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{NOMBRE_AUTOR}", utf8_encode($datos_usuario_perfil[0]->nombre_completo), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{CONTENIDO_FULL_MP}", utf8_encode($unico[0]->contenido), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{RESUMEN_FULL_MP}", utf8_encode($unico[0]->resumen), $PRINCIPAL);
    $post_categoria = '<a href="?sw=com_mp_personal&amb=mp_cat&idcat=' . $unico[0]->id_categoria . '&cat=' . $unico[0]->categoria . '"><span class="badge_small badge-azul"><span class="blanco">
            <i class="icon-people icons"></i> ' . utf8_encode($unico[0]->categoria) . '</span></span></a>';
    $PRINCIPAL      = str_replace("{NUMVISITAS}", round($unico->numvisitas), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{NUMMEGUSTA}", ($unico->nummegusta), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{NUMCOMPARTIDA}", ($unico->numcompartido), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{NUMCOMENTARIO}", ("hola"), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{NUMCOMENTARIOSREALES}", ($unico->numcomentariosreales), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{NUMFAVORITA}", ($unico->numfavorita), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{ESTILOESTADO}", ($unico->estilo), $PRINCIPAL);
    if ($unico[0]->tipo == "MejorPractica") {
        $ico = "img/bci_mp_practica_icon.png";
    }
    if ($unico[0]->tipo == "Papers") {
        $ico = "img/bci_mp_paper_icon.png";
    }
    if ($unico[0]->tipo == "Publicacion") {
        $ico = "img/bci_mp_publicacion.png";
    }
    if ($unico[0]->tipo == "Video" or $unico[0]->tipo == "VideoInterno") {
        $ico = "img/bci_mp_practica_video.png";
    }
    if ($unico[0]->tipo == "Links" or $unico[0]->tipo == "LinkExterno") {
        $ico = "img/bci_mp_link_icon.png";
    }
    if ($unico[0]->tipo == "Experiencias") {
        $ico = "img/bci_mp_experiencias_icon.png";
    }
    if ($unico[0]->tipo == "Experto") {
        $ico = "img/bci_mp_experto_icon.png";
    }
    if ($unico[0]->tipo == "OportunidadMejora") {
        $ico = "img/bci_mp_oportunidadmejora_icon.png";
    }
    if ($unico[0]->tipo == "Udnolohaga") {
        $ico = "img/bci_mp_udnolohaga_icon.png";
    }
    if ($unico[0]->tipo == "RRPP") {
        $ico = "img/bci_mp_rrpp_icon.png";
    }
    if ($unico[0]->tipo == "Pregunta") {
        $ico = "img/bci_mp_pregunta_icon.png";
    }
    if ($unico[0]->tipo == "Respuesta") {
        $ico = "img/bci_mp_pregunta_icon.png";
    }
    //echo "ico $ico tipo ".$unico->tipo." tipo sub 0 ".$unico->tipo[0];
    $PRINCIPAL = str_replace("{FECHA}", formatearFechaSmall($unico[0]->fecha), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ICONOESTADO}", ($unico->icono_estado), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ICONO}", ($ico), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ICONO_DESC}", ($unico[0]->tipo), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ESTILOCATEGORIA}", ($unico->style), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ICONOCATEGORIA}", ($unico->icono), $PRINCIPAL);
    $PRINCIPAL = str_replace("{CATEGORIA_MP}", ($post_categoria), $PRINCIPAL);
    if ($unico->tipo_multimedia == "imagen") {
        $imagen = "../../front/multimedia/" . $unico->multimedia;
    } else {
        $imagen = "";
    }
    if ($unico->tipo_multimedia == "video") {
        $video = "../../front/multimedia/" . $unico->multimedia;
    } else {
        $video = "";
    }


    if (file_exists("multimedia/" . $unico->imagenfondo)) {

        $PRINCIPAL           = str_replace("{IMAGEN_POST}", "multimedia/" . $unico->imagenfondo, $PRINCIPAL);
} else {
        $PRINCIPAL           = str_replace("{IMAGEN_POST}", "", $PRINCIPAL);;
}

    $PRINCIPAL           = str_replace("{VIDEO}", ($video), $PRINCIPAL);
    $PRINCIPAL           = str_replace("{TIPOMULTIMEDIA}", ($unico->tipo_multimedia), $PRINCIPAL);
    $listado_comentarios = MuestraComentariosPorPost($unico[0]->id_mp);
    $PRINCIPAL           = str_replace("{BLOQUE_COMENTARIOS}", $listado_comentarios, $PRINCIPAL);
    if ($unico[0]->url_documento) {
        $PRINCIPAL = str_replace("{BLOQUE_URL_DOCUMENTO}", file_get_contents("views/comunidad_mp/row_com_mp_url_documento.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{URL_DOCUMENTO}", ($unico[0]->url_documento), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_URL_DOCUMENTO}", "", $PRINCIPAL);
    }
    $video_youtube       = ColocaVideoYoutube($unico->video, $unico->id_mp);
    $bloque_imagen_fondo = ColocaImagenPost($unico->imagenfondo);
    //echo $imagen;
    if ($unico->video) {
        $PRINCIPAL = str_replace("{VIDEO_IMAGEN}", $video_youtube, $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{VIDEO_IMAGEN}", $bloque_imagen_fondo, $PRINCIPAL);
    }
    //tags por post
    $TagsPorPosts = TagsPorMPEmpresa($id_mp, $id_empresa);
    $tag_por_post = "";
    foreach ($TagsPorPosts as $TagsPorPost) {
        $aitag++;
        if ($aitag == 1) {
            $tag1 = $TagsPorPost->tag;
        }
        if ($aitag == 2) {
            $tag2 = $TagsPorPost->tag;
        }
        $tag_por_post .= '<a href="?sw=com_mp_personal&amb=mp_tag&tag=' . $TagsPorPost->tag . '"><span class="badge_small badge-white"><span class="negro">#' . $TagsPorPost->tag . '</span></span></a> ';
    }
    $PRINCIPAL               = str_replace("{TAGS_POR_POST}", (utf8_encode($tag_por_post)), $PRINCIPAL);
    $limit                   = 9;
    $total_listado_tags      = com_mp_tag_data($id_empresa, $rut, $limit);
    $total_listado_tag_cloud = "";
    foreach ($total_listado_tags as $total_listado_tag_unico) {
        $total_listado_tag_cloud .= file_get_contents("views/comunidad_mp/com_mp_row_tag_cloud_search.html");
        $total_listado_tag_cloud = str_replace("{TAG}", $total_listado_tag_unico->tag, $total_listado_tag_cloud);
        $total_listado_tag_cloud = str_replace("{NUM}", $total_listado_tag_unico->cuenta, $total_listado_tag_cloud);
        $link                    = "?sw=com_mp_personal&amb=mp_tag&tag=" . $total_listado_tag_unico->tag . "";
        $total_listado_tag_cloud = str_replace("{LINK}", $link, $total_listado_tag_cloud);
    }
    $categorias_mp      = TraeCategoriasMejoresPracticas($id_empresa);
    $options_categorias = "";
    foreach ($categorias_mp as $cat) {
        $options_categorias .= "<option value='" . $cat->id_categoria . "'>" . $cat->categoria . "</option>";
    }
    $PRINCIPAL                    = str_replace("{CATEGORIAS_FORM}", utf8_encode($options_categorias), $PRINCIPAL);
    //TIMELINE SIMILARES
    $todas                        = com_mp_similares_data($id_empresa, $id_mp, $unico[0]->id_categoria);
    $total_listado_post_recientes = "";
    foreach ($todas as $unico) {
        //echo "id ".$unico->video." or ".$unico->imagenfondo." ";
        $total_listado_post_recientes .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_persona_listado_tipoST.html");
        //echo "views/comunidad_mp/".$template.$id_empresa."_row_com_mp_persona_listado_tipoST.html";
        $total_listado_post_recientes = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_listado_post_recientes);
        $tiene_megusta                = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $unico->id_mp, "MEGUSTA", $rut);
        if ($tiene_megusta) {
            $total_listado_post_recientes = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta.html"), $total_listado_post_recientes);
        } else {
            $total_listado_post_recientes = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta.html"), $total_listado_post_recientes);
        }
        $total_listado_post_recientes = ColocaCantidadDeMegusta($total_listado_post_recientes, $unico->id_mp, $id_empresa);
        $tiene_favorito               = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $unico->id_mp, "FAVORITA", $rut);
        if ($tiene_favorito) {
            $total_listado_post_recientes = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_favorito.html"), $total_listado_post_recientes);
        } else {
            $total_listado_post_recientes = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_favorito.html"), $total_listado_post_recientes);
        }
        $total_listado_post_recientes = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_listado_post_recientes);
        $total_listado_post_recientes = ColocaCantidadDeFavorito($total_listado_post_recientes, $unico->id_mp, $id_empresa);
        $total_listado_post_recientes = str_replace("{ID_MP}", $unico->id_mp, $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{TIPO}", "A", $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{LINK}", $link_MP, $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{CATEGORIA_MP}", ($unico->categoria), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($unico->descripcion_categoria), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{NOMBRE}", ($unico->nombre), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{CONTENIDO}", limit_text($unico->contenido, 35), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{FECHA}", formatearFechaSmall($unico->fecha), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{ESTADO}", ($unico->estado), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{DESCRIPCION_ESTADO}", ($unico->descripcion_estado), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{RUT_AUTOR}", ($unico->rut), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{RUT}", ($rut), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{NOMBRE_AUTOR}", ($unico->nombre_autor), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($unico->rut), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{NUMVISITAS}", round($unico->numvisitas), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{NUMMEGUSTA}", ($unico->nummegusta), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{NUMCOMPARTIDA}", ($unico->numcompartido), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{NUMCOMENTARIO}", ($unico->numcomentarios), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{NUMCOMENTARIOSREALES}", ($unico->numcomentariosreales), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{NUMFAVORITA}", ($unico->numfavorita), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{ESTILOESTADO}", ($unico->estilo), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{ICONOESTADO}", ($unico->icono_estado), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{ESTILOCATEGORIA}", ($unico->style), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{ICONOCATEGORIA}", ($unico->icono), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{CATEGORIA_MP}", ($unico->categoria), $total_listado_post_recientes);
        if ($unico->tipo_multimedia == "imagen" and $unico->imagen_fondo <> '') {
            $imagen = "../../front/multimedia/" . $unico->multimedia;
        } else {
            $imagen = "";
        }
        if ($unico->tipo_multimedia == "video") {
            $video = "../../front/multimedia/" . $unico->multimedia;
        } else {
            $video = "";
        }
        $total_listado_post_recientes = str_replace("{IMAGEN_POST}", "multimedia/" . $unico->imagenfondo, $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{VIDEO}", ($video), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{TIPOMULTIMEDIA}", ($unico->tipo_multimedia), $total_listado_post_recientes);
       // $listado_comentarios          = MuestraComentariosPorPost($unico->id_mp);
       $total_listado_post_recientes = str_replace("{BLOQUE_COMENTARIOS}", $listado_comentarios, $total_listado_post_recientes);
 if ($unico->url_documento<>'' and $unico->url_documento<>'{LINK_DOCUMENTO}') {

            $total_listado_post_recientes = str_replace("{URL_DOCUMENTO}", ($unico->url_documento), $total_listado_post_recientes);
        } else {
            $total_listado_post_recientes = str_replace("{BLOQUE_URL_DOCUMENTO}", "", $total_listado_post_recientes);
        }
            if ($unico->video<>'' and $unico->video<>'{LINK_YOUTUBE}') {
            $video_youtube                = ColocaVideoYoutube($unico->video, $unico->id_mp);
            $total_listado_post_recientes = str_replace("{VIDEO_IMAGEN}", $video_youtube, $total_listado_post_recientes);
        } else {
            $bloque_imagen_fondo          = ColocaImagenPost($unico->imagenfondo);
            $total_listado_post_recientes = str_replace("{VIDEO_IMAGEN}", $bloque_imagen_fondo, $total_listado_post_recientes);
        }
        //tags por post
        $TagsPorPosts = TagsPorMPEmpresa($unico->id_mp, $id_empresa);
        $tag_por_post = "";
        foreach ($TagsPorPosts as $TagsPorPost) {
            $tag_por_post .= '<a href="?sw=com_mp_personal&amb=mp_tag&tag=' . $TagsPorPost->tag . '"><span class="badge_small badge-white"><span class="negro">#' . $TagsPorPost->tag . '</span></span></a> ';
        }
        $total_listado_post_recientes = str_replace("{TAGS_POR_POST}", ($tag_por_post), $total_listado_post_recientes);
    }
    $PRINCIPAL          = str_replace("{NUM_FAV}", MPbuscaFav($rut, $id_empresa), $PRINCIPAL);
    $PRINCIPAL          = str_replace("{NUM_MISPR}", MPbuscaMp($rut, $id_empresa), $PRINCIPAL);
    $PRINCIPAL          = str_replace("{INSIGNIA}", "", $PRINCIPAL);
    $PRINCIPAL          = str_replace("{RUT_USUARIO}", $rut, $PRINCIPAL);
    $PRINCIPAL          = str_replace("{ROW_LISTADO_TIMELINE_PERSONAL}", utf8_encode($total_listado), $PRINCIPAL);
    $PRINCIPAL          = str_replace("{ROW_LISTADO_TIMELINE_PERSONAL_PART2}", utf8_encode($total_listado_1row), $PRINCIPAL);
    $PRINCIPAL          = str_replace("{PERFIL_PERSONAL_COMUNIDAD_MP}", utf8_encode($perfil_personal), $PRINCIPAL);
    $PRINCIPAL          = str_replace("{POST_FIJOS_COMUNIDAD_MP}", utf8_encode($post_fijo_personal), $PRINCIPAL);
    $PRINCIPAL          = str_replace("{POST_ESTADISTICAS_COMUNIDAD_MP}", utf8_encode($post_fijo_estadisticas), $PRINCIPAL);
    $PRINCIPAL          = str_replace("{MIRUT}", $rut, $PRINCIPAL);
    $PRINCIPAL          = str_replace("{ROW_PUBLICACIONES_MISMO_TAG}", utf8_encode($total_listado_post_recientes), $PRINCIPAL);
    $categorias_mp      = TraeCategoriasMejoresPracticas($id_empresa);
    $options_categorias = "";
    foreach ($categorias_mp as $cat) {
        $options_categorias .= "<option value='" . $cat->id_categoria . "'>" . $cat->categoria . "</option>";
    }
    $PRINCIPAL = str_replace("{CATEGORIAS}", utf8_encode($options_categorias), $PRINCIPAL);
    $PRINCIPAL = str_replace("{RUT_ENCODEADO}", Encodear3($_SESSION["user_"]), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ID_MP_ENCODEADO}", Encodear3($id_mp), $PRINCIPAL);
    $PRINCIPAL = str_replace("{MI_RUT}", $rut, $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_COMP_MP_MIS_NOTIFICACIONES_SIN_VER}", utf8_encode($total_notificaciones), $PRINCIPAL);
    if ($cuenta_notificaciones_sinver > 0) {
        $PRINCIPAL = str_replace("{NUM_NOTIFICACIONES_SINVER_GLOBO}", "<span class='badge_bell badge-default-bell'>" . $cuenta_notificaciones_sinver . " </span> ", $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{NUM_NOTIFICACIONES_SINVER_GLOBO}", "", $PRINCIPAL);
    }
    return ($PRINCIPAL);
}

function com_mp_full_GPTW($PRINCIPAL, $id_empresa, $id_mp)
{
    $unico = com_mp_full_GPTW_data($id_empresa, $id_mp);
    //print_r($unico);
    $rut   = $_SESSION["user_"];
    if ($_GET["c"] == 1) {
        $PRINCIPAL = str_replace("{DISPLAY_BLOQUE_COMPARTIR}", "block", $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{DISPLAY_BLOQUE_COMPARTIR}", "none", $PRINCIPAL);
    }
    $PRINCIPAL        = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones_full.html"), $PRINCIPAL);
    $tiene_no_megusta = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $id_mp, "NOMEGUSTA", $rut);
    if ($tiene_no_megusta) {
        $PRINCIPAL = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_nomegusta.html"), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_NOMEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_nomegusta.html"), $PRINCIPAL);
    }
    $PRINCIPAL                    = ColocaCantidadDeNoMegusta($PRINCIPAL, $id_mp, $id_empresa);
    $Rut_Perfil                   = $rut;
    // Mis Notificaciones
    $com_mp_mis_notificaciones    = mp_interacciones_notificaciones($Rut_Perfil, $id_empresa, "");
    //print_r($com_mp_mis_notificaciones); echo "5773";
    $cuenta_notificaciones        = 0;
    $cuenta_notificaciones_sinver = 0;
    $total_notificaciones         = "";
    foreach ($com_mp_mis_notificaciones as $com_mp_mi_notificacion) {
        $cuenta_notificaciones++;
        if ($com_mp_mi_notificacion->visto <> 1) {
            $cuenta_notificaciones_sinver++;
        }
        $ico   = "";
        $texto = "";
        if ($com_mp_mi_notificacion->tipo == "COMENTARIO") {
            $ico = '<i class="icon-speech icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small>';
            if ($com_mp_mi_notificacion->rutAutor == $Rut_Perfil) {
                $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut_remitente . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreRemitente . '</strong>
                    </a> coment&oacute;:
                    <em>' . $com_mp_mi_notificacion->mensaje . '</em> en tu publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
            } else {
                $texto = 'Comentaste:
                    <em>' . $com_mp_mi_notificacion->mensaje . '</em> en la publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '">
                    <strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> de
                    <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rutAutor . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreAutor . '</strong>
                    </a> ';
            }
        }
        if ($com_mp_mi_notificacion->tipo == "SEGUIDO") {
            $ico = '<i class="icon-user icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
            if ($com_mp_mi_notificacion->rut_remitenteAutor == $Rut_Perfil) {
                $texto = 'Seguiste a <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a>';
            } else {
                $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut_remitente . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreRemitente . '</strong> te sigue ';
            }
        }
        if ($com_mp_mi_notificacion->tipo == "MEGUSTA") {
            $ico = '<i class="icon-thumbs-up icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
            if ($com_mp_mi_notificacion->rut == $Rut_Perfil) {
                $texto = 'Te gusta la publicaci&oacute;n <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '">
                    <strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> de
                    <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rutAutor . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreAutor . '</strong>
                    </a>';
            } else {
                $texto = 'A <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a> le Gusta tu publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
            }
        }
        if ($com_mp_mi_notificacion->tipo == "GRUPOSEGUIDO") {
            $ico = '<i class="icon-people icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
            if ($com_mp_mi_notificacion->rut == $Rut_Perfil) {
                $texto = 'Seguiste el Grupo de Inter&eacute;s
                    <a href="?sw=com_mp_personal&amb=mp_cat&idcat=' . $com_mp_mi_notificacion->contenido . '&cat=' . $com_mp_mi_notificacion->NombreCategoria . '">
                    <strong>' . $com_mp_mi_notificacion->NombreCategoria . '</strong></a>
                    ';
            }
        }
        if ($com_mp_mi_notificacion->tipo == "COMPARTIDOCONMIGO") {
            $ico = '<i class="icon-share icons"></i> <br><small><small>[' . $com_mp_mi_notificacion->fecha . ']</small></small> ';
            if ($com_mp_mi_notificacion->rut <> $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente <> $Rut_Perfil and $com_mp_mi_notificacion->rut == $com_mp_mi_notificacion->rut_remitente) {
                $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a> guard&oacute; tu publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> ';
            } elseif ($com_mp_mi_notificacion->rut == $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente == $Rut_Perfil) {
                $texto = 'Guardaste la publicaci&oacute;n <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '">
                    <strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a> de
                    <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rutAutor . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreAutor . '</strong>
                    </a>';
            } elseif ($com_mp_mi_notificacion->rut == $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente <> $Rut_Perfil) {
                $texto = '<a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreRemitente . '</strong>
                    </a> comparti&oacute; contigo la publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a>
                    de
                    <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rutAutor . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreAutor . '</strong>
                    ';
            } elseif ($com_mp_mi_notificacion->rut <> $Rut_Perfil and $com_mp_mi_notificacion->rut_remitente == $Rut_Perfil) {
                $texto = 'Compartiste con <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rut . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreDestinatario . '</strong>
                    </a> la publicaci&oacute;n
                    <a href="?sw=com_mp_full&id_mp=' . $com_mp_mi_notificacion->id_mp . '"><strong>' . $com_mp_mi_notificacion->Publicacion . '</strong></a>
                    de
                    <a href="?sw=com_mp_personal&rut_enviado=' . $com_mp_mi_notificacion->rutAutor . '=1&mp=1">
                    <strong>' . $com_mp_mi_notificacion->NombreAutor . '</strong>
                    ';
            }
        }
        $total_notificaciones .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_perfil_mis_notificaciones.html");
        $total_notificaciones = str_replace("{ICO}", ($ico), $total_notificaciones);
        $total_notificaciones = str_replace("{TEXTO}", ($texto), $total_notificaciones);
    }
    $PRINCIPAL            = ColocaMegustaFavoritos($PRINCIPAL, $id_empresa, $id_mp, $_SESSION["user_"]);
    $datos_usuario_perfil = UsuarioEnBasePersonas($unico[0]->rut);

    $unico[0]->imagenfondo=$unico[0]->imagen;

    if ($unico[0]->rut == $rut) {
        $PRINCIPAL = str_replace("{EDITAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_editar_mp.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ELIMINAR_MP}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_borrar_mp.html"), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{EDITAR_MP}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ELIMINAR_MP}", "", $PRINCIPAL);
    }
    //$cuentaComentarios=CuentaComentarioPost($id_empresa, $id_mp);
    $PRINCIPAL = str_replace("{NOMBRE_MP}", utf8_encode($unico[0]->nombre), $PRINCIPAL);
    $PRINCIPAL = str_replace("{NUMEROCOMENTARIOS}", $unico[0]->numcomentarios, $PRINCIPAL);
    $PRINCIPAL = str_replace("{RUT_ENVIADO}", utf8_encode($unico[0]->rut), $PRINCIPAL);
    if ($id_empresa == '62') {
        $url_mp_comparte = "https://www.compartebci.cl/front/?sw=login_ext%26ambiente=com_mp_full%26id_mp=" . $id_mp . "";
    }
    $PRINCIPAL = str_replace("{URL_MP_COMPARTE}", ($url_mp_comparte), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ID_MP}", $id_mp, $PRINCIPAL);
    $PRINCIPAL = str_replace("{RUT}", $_SESSION["user_"], $PRINCIPAL);
    $PRINCIPAL = str_replace("{TIPO}", "A", $PRINCIPAL);

    //print_r($unico);
    if ($unico[0]->foto and $unico[0]->video=='') {
        $PRINCIPAL = str_replace("{BLOQUE_PARA_IMAGEN}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_imagen.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{IMAGEN_POST_SUPERIOR}", $unico[0]->foto, $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_PARA_IMAGEN}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{IMAGEN_POST_SUPERIOR}", "", $PRINCIPAL);
    }
    if ($unico[0]->video) {
        $video_youtube = ColocaVideoYoutube($unico[0]->video, $unico[0]->id_mp);
        $PRINCIPAL     = str_replace("{BLOQUE_VIDEO}", $video_youtube, $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_VIDEO}", "", $PRINCIPAL);
    }
            $PRINCIPAL = str_replace("{MENSAJE}", utf8_encode($unico[0]->mensaje), $PRINCIPAL);

    $PRINCIPAL      = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($unico[0]->rut), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{NOMBRE_AUTOR}", utf8_encode($datos_usuario_perfil[0]->nombre_completo), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{CONTENIDO_FULL_MP}", utf8_encode($unico[0]->contenido), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{RESUMEN_FULL_MP}", utf8_encode($unico[0]->resumen), $PRINCIPAL);
    $post_categoria = '<a href="?sw=com_mp_personal&amb=mp_cat&idcat=' . $unico[0]->id_categoria . '&cat=' . $unico[0]->categoria . '"><span class="badge_small badge-azul"><span class="blanco">
            <i class="icon-people icons"></i> ' . utf8_encode($unico[0]->categoria) . '</span></span></a>';
    $PRINCIPAL      = str_replace("{NUMVISITAS}", round($unico->numvisitas), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{NUMMEGUSTA}", ($unico->nummegusta), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{NUMCOMPARTIDA}", ($unico->numcompartido), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{NUMCOMENTARIO}", ("hola"), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{NUMCOMENTARIOSREALES}", ($unico->numcomentariosreales), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{NUMFAVORITA}", ($unico->numfavorita), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{ESTILOESTADO}", ($unico->estilo), $PRINCIPAL);
    if ($unico[0]->tipo == "MejorPractica") {
        $ico = "img/bci_mp_practica_icon.png";
    }
    if ($unico[0]->tipo == "Papers") {
        $ico = "img/bci_mp_paper_icon.png";
    }
    if ($unico[0]->tipo == "Publicacion") {
        $ico = "img/bci_mp_publicacion.png";
    }
    if ($unico[0]->tipo == "Video" or $unico[0]->tipo == "VideoInterno") {
        $ico = "img/bci_mp_practica_video.png";
    }
    if ($unico[0]->tipo == "Links" or $unico[0]->tipo == "LinkExterno") {
        $ico = "img/bci_mp_link_icon.png";
    }
    if ($unico[0]->tipo == "Experiencias") {
        $ico = "img/bci_mp_experiencias_icon.png";
    }
    if ($unico[0]->tipo == "Experto") {
        $ico = "img/bci_mp_experto_icon.png";
    }
    if ($unico[0]->tipo == "OportunidadMejora") {
        $ico = "img/bci_mp_oportunidadmejora_icon.png";
    }
    if ($unico[0]->tipo == "Udnolohaga") {
        $ico = "img/bci_mp_udnolohaga_icon.png";
    }
    if ($unico[0]->tipo == "RRPP") {
        $ico = "img/bci_mp_rrpp_icon.png";
    }
    if ($unico[0]->tipo == "Pregunta") {
        $ico = "img/bci_mp_pregunta_icon.png";
    }
    if ($unico[0]->tipo == "Respuesta") {
        $ico = "img/bci_mp_pregunta_icon.png";
    }
    //echo "ico $ico tipo ".$unico->tipo." tipo sub 0 ".$unico->tipo[0];
    $PRINCIPAL = str_replace("{FECHA}", formatearFechaSmall($unico[0]->fecha), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ICONOESTADO}", ($unico->icono_estado), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ICONO}", ($ico), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ICONO_DESC}", ($unico[0]->tipo), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ESTILOCATEGORIA}", ($unico->style), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ICONOCATEGORIA}", ($unico->icono), $PRINCIPAL);
    $PRINCIPAL = str_replace("{CATEGORIA_MP}", ($post_categoria), $PRINCIPAL);
    if ($unico->tipo_multimedia == "imagen") {
        $imagen = "../../front/multimedia/" . $unico->multimedia;
    } else {
        $imagen = "";
    }
    if ($unico->tipo_multimedia == "video") {
        $video = "../../front/multimedia/" . $unico->multimedia;
    } else {
        $video = "";
    }


    if (file_exists("multimedia/" . $unico->imagenfondo)) {

        $PRINCIPAL           = str_replace("{IMAGEN_POST}", "multimedia/" . $unico->imagenfondo, $PRINCIPAL);
} else {
        $PRINCIPAL           = str_replace("{IMAGEN_POST}", "", $PRINCIPAL);;
}

    $PRINCIPAL           = str_replace("{VIDEO}", ($video), $PRINCIPAL);
    $PRINCIPAL           = str_replace("{TIPOMULTIMEDIA}", ($unico->tipo_multimedia), $PRINCIPAL);
    $listado_comentarios = MuestraComentariosPorPost($unico[0]->id_mp);
    $PRINCIPAL           = str_replace("{BLOQUE_COMENTARIOS}", $listado_comentarios, $PRINCIPAL);
    if ($unico[0]->url_documento) {
        $PRINCIPAL = str_replace("{BLOQUE_URL_DOCUMENTO}", file_get_contents("views/comunidad_mp/row_com_mp_url_documento.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{URL_DOCUMENTO}", ($unico[0]->url_documento), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_URL_DOCUMENTO}", "", $PRINCIPAL);
    }
    $video_youtube       = ColocaVideoYoutube($unico->video, $unico->id_mp);
    $bloque_imagen_fondo = ColocaImagenPost($unico->imagenfondo);
    //echo $imagen;
    if ($unico->video) {
        $PRINCIPAL = str_replace("{VIDEO_IMAGEN}", $video_youtube, $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{VIDEO_IMAGEN}", $bloque_imagen_fondo, $PRINCIPAL);
    }
    //tags por post
    $TagsPorPosts = TagsPorMPEmpresa($id_mp, $id_empresa);
    $tag_por_post = "";
    foreach ($TagsPorPosts as $TagsPorPost) {
        $aitag++;
        if ($aitag == 1) {
            $tag1 = $TagsPorPost->tag;
        }
        if ($aitag == 2) {
            $tag2 = $TagsPorPost->tag;
        }
        $tag_por_post .= '<a href="?sw=com_mp_personal&amb=mp_tag&tag=' . $TagsPorPost->tag . '"><span class="badge_small badge-white"><span class="negro">#' . $TagsPorPost->tag . '</span></span></a> ';
    }
    $PRINCIPAL               = str_replace("{TAGS_POR_POST}", (utf8_encode($tag_por_post)), $PRINCIPAL);
    $limit                   = 9;
    $total_listado_tags      = com_mp_tag_data($id_empresa, $rut, $limit);
    $total_listado_tag_cloud = "";
    foreach ($total_listado_tags as $total_listado_tag_unico) {
        $total_listado_tag_cloud .= file_get_contents("views/comunidad_mp/com_mp_row_tag_cloud_search.html");
        $total_listado_tag_cloud = str_replace("{TAG}", $total_listado_tag_unico->tag, $total_listado_tag_cloud);
        $total_listado_tag_cloud = str_replace("{NUM}", $total_listado_tag_unico->cuenta, $total_listado_tag_cloud);
        $link                    = "?sw=com_mp_personal&amb=mp_tag&tag=" . $total_listado_tag_unico->tag . "";
        $total_listado_tag_cloud = str_replace("{LINK}", $link, $total_listado_tag_cloud);
    }
    $categorias_mp      = TraeCategoriasMejoresPracticas($id_empresa);
    $options_categorias = "";
    foreach ($categorias_mp as $cat) {
        $options_categorias .= "<option value='" . $cat->id_categoria . "'>" . $cat->categoria . "</option>";
    }
    $PRINCIPAL                    = str_replace("{CATEGORIAS_FORM}", utf8_encode($options_categorias), $PRINCIPAL);
    //TIMELINE SIMILARES
    $todas                        = com_mp_similares_data($id_empresa, $id_mp, $unico[0]->id_categoria);
    $total_listado_post_recientes = "";
    foreach ($todas as $unico) {
        //echo "id ".$unico->video." or ".$unico->imagenfondo." ";
        $total_listado_post_recientes .= file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_row_com_mp_persona_listado_tipoST.html");
        //echo "views/comunidad_mp/".$template.$id_empresa."_row_com_mp_persona_listado_tipoST.html";
        $total_listado_post_recientes = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_listado_post_recientes);
        $tiene_megusta                = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $unico->id_mp, "MEGUSTA", $rut);
        if ($tiene_megusta) {
            $total_listado_post_recientes = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_megusta.html"), $total_listado_post_recientes);
        } else {
            $total_listado_post_recientes = str_replace("{BLOQUE_MEGUSTA_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_megusta.html"), $total_listado_post_recientes);
        }
        $total_listado_post_recientes = ColocaCantidadDeMegusta($total_listado_post_recientes, $unico->id_mp, $id_empresa);
        $tiene_favorito               = COMUNIDAD_TieneInteraccionPorRut($id_empresa, $unico->id_mp, "FAVORITA", $rut);
        if ($tiene_favorito) {
            $total_listado_post_recientes = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_ya_favorito.html"), $total_listado_post_recientes);
        } else {
            $total_listado_post_recientes = str_replace("{BLOQUE_FAVORITO_POR_POST}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_bloque_favorito.html"), $total_listado_post_recientes);
        }
        $total_listado_post_recientes = str_replace("{HUINCHA_INTERACCIONES}", file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_huincha_interacciones.html"), $total_listado_post_recientes);
        $total_listado_post_recientes = ColocaCantidadDeFavorito($total_listado_post_recientes, $unico->id_mp, $id_empresa);
        $total_listado_post_recientes = str_replace("{ID_MP}", $unico->id_mp, $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{TIPO}", "A", $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{LINK}", $link_MP, $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{CATEGORIA_MP}", ($unico->categoria), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($unico->descripcion_categoria), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{NOMBRE}", ($unico->nombre), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{CONTENIDO}", limit_text($unico->contenido, 35), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{FECHA}", formatearFechaSmall($unico->fecha), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{ESTADO}", ($unico->estado), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{DESCRIPCION_ESTADO}", ($unico->descripcion_estado), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{RUT_AUTOR}", ($unico->rut), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{RUT}", ($rut), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{NOMBRE_AUTOR}", ($unico->nombre_autor), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($unico->rut), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{NUMVISITAS}", round($unico->numvisitas), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{NUMMEGUSTA}", ($unico->nummegusta), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{NUMCOMPARTIDA}", ($unico->numcompartido), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{NUMCOMENTARIO}", ($unico->numcomentarios), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{NUMCOMENTARIOSREALES}", ($unico->numcomentariosreales), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{NUMFAVORITA}", ($unico->numfavorita), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{ESTILOESTADO}", ($unico->estilo), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{ICONOESTADO}", ($unico->icono_estado), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{ESTILOCATEGORIA}", ($unico->style), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{ICONOCATEGORIA}", ($unico->icono), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{CATEGORIA_MP}", ($unico->categoria), $total_listado_post_recientes);
        if ($unico->tipo_multimedia == "imagen" and $unico->imagen_fondo <> '') {
            $imagen = "../../front/multimedia/" . $unico->multimedia;
        } else {
            $imagen = "";
        }
        if ($unico->tipo_multimedia == "video") {
            $video = "../../front/multimedia/" . $unico->multimedia;
        } else {
            $video = "";
        }
        $total_listado_post_recientes = str_replace("{IMAGEN_POST}", "multimedia/" . $unico->imagenfondo, $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{VIDEO}", ($video), $total_listado_post_recientes);
        $total_listado_post_recientes = str_replace("{TIPOMULTIMEDIA}", ($unico->tipo_multimedia), $total_listado_post_recientes);
       // $listado_comentarios          = MuestraComentariosPorPost($unico->id_mp);
       $total_listado_post_recientes = str_replace("{BLOQUE_COMENTARIOS}", $listado_comentarios, $total_listado_post_recientes);
 if ($unico->url_documento<>'' and $unico->url_documento<>'{LINK_DOCUMENTO}') {

            $total_listado_post_recientes = str_replace("{URL_DOCUMENTO}", ($unico->url_documento), $total_listado_post_recientes);
        } else {
            $total_listado_post_recientes = str_replace("{BLOQUE_URL_DOCUMENTO}", "", $total_listado_post_recientes);
        }
            if ($unico->video<>'' and $unico->video<>'{LINK_YOUTUBE}') {
            $video_youtube                = ColocaVideoYoutube($unico->video, $unico->id_mp);
            $total_listado_post_recientes = str_replace("{VIDEO_IMAGEN}", $video_youtube, $total_listado_post_recientes);
        } else {
            $bloque_imagen_fondo          = ColocaImagenPost($unico->imagenfondo);
            $total_listado_post_recientes = str_replace("{VIDEO_IMAGEN}", $bloque_imagen_fondo, $total_listado_post_recientes);
        }
        //tags por post
        $TagsPorPosts = TagsPorMPEmpresa($unico->id_mp, $id_empresa);
        $tag_por_post = "";
        foreach ($TagsPorPosts as $TagsPorPost) {
            $tag_por_post .= '<a href="?sw=com_mp_personal&amb=mp_tag&tag=' . $TagsPorPost->tag . '"><span class="badge_small badge-white"><span class="negro">#' . $TagsPorPost->tag . '</span></span></a> ';
        }
        $total_listado_post_recientes = str_replace("{TAGS_POR_POST}", ($tag_por_post), $total_listado_post_recientes);
    }
    $PRINCIPAL          = str_replace("{NUM_FAV}", MPbuscaFav($rut, $id_empresa), $PRINCIPAL);
    $PRINCIPAL          = str_replace("{NUM_MISPR}", MPbuscaMp($rut, $id_empresa), $PRINCIPAL);
    $PRINCIPAL          = str_replace("{INSIGNIA}", "", $PRINCIPAL);
    $PRINCIPAL          = str_replace("{RUT_USUARIO}", $rut, $PRINCIPAL);
    $PRINCIPAL          = str_replace("{ROW_LISTADO_TIMELINE_PERSONAL}", utf8_encode($total_listado), $PRINCIPAL);
    $PRINCIPAL          = str_replace("{ROW_LISTADO_TIMELINE_PERSONAL_PART2}", utf8_encode($total_listado_1row), $PRINCIPAL);
    $PRINCIPAL          = str_replace("{PERFIL_PERSONAL_COMUNIDAD_MP}", utf8_encode($perfil_personal), $PRINCIPAL);
    $PRINCIPAL          = str_replace("{POST_FIJOS_COMUNIDAD_MP}", utf8_encode($post_fijo_personal), $PRINCIPAL);
    $PRINCIPAL          = str_replace("{POST_ESTADISTICAS_COMUNIDAD_MP}", utf8_encode($post_fijo_estadisticas), $PRINCIPAL);
    $PRINCIPAL          = str_replace("{MIRUT}", $rut, $PRINCIPAL);
    $PRINCIPAL          = str_replace("{ROW_PUBLICACIONES_MISMO_TAG}", utf8_encode($total_listado_post_recientes), $PRINCIPAL);
    $categorias_mp      = TraeCategoriasMejoresPracticas($id_empresa);
    $options_categorias = "";
    foreach ($categorias_mp as $cat) {
        $options_categorias .= "<option value='" . $cat->id_categoria . "'>" . $cat->categoria . "</option>";
    }
    $PRINCIPAL = str_replace("{CATEGORIAS}", utf8_encode($options_categorias), $PRINCIPAL);
    $PRINCIPAL = str_replace("{RUT_ENCODEADO}", Encodear3($_SESSION["user_"]), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ID_MP_ENCODEADO}", Encodear3($id_mp), $PRINCIPAL);
    $PRINCIPAL = str_replace("{MI_RUT}", $rut, $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_COMP_MP_MIS_NOTIFICACIONES_SIN_VER}", utf8_encode($total_notificaciones), $PRINCIPAL);
    if ($cuenta_notificaciones_sinver > 0) {
        $PRINCIPAL = str_replace("{NUM_NOTIFICACIONES_SINVER_GLOBO}", "<span class='badge_bell badge-default-bell'>" . $cuenta_notificaciones_sinver . " </span> ", $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{NUM_NOTIFICACIONES_SINVER_GLOBO}", "", $PRINCIPAL);
    }
    return ($PRINCIPAL);
}

function ColocarBloqueCompetencias($PRINCIPAL, $id_empresa, $evaluado, $evaluador, $id_proceso)
{
    $competencias = TraeDatosEvaluadoEvaluadorPorEmpresaProceso($evaluado, $evaluador, $id_empresa, $id_proceso);
    $tabla        = "<table border='1' width='100%'>
    <tr>
        <td class='col-md-1 tituloSeccionSGDtexttit'>&nbsp;</td>
        <td class='col-md-4 tituloSeccionSGDtexttit'>Competencia</td>
        <td class='col-md-7 tituloSeccionSGDtexttit'>Descripci&oacute;n</td>
    </tr>";
    $i            = 1;
    foreach ($competencias as $comp) {
        //Por cada competencia trigo las preguntas
        $tabla .= "<tr>
        <td class='panel-heading colortxt Border_titulo_sgd'><span class='sgdnumeracion'>$i</span></td>
        <td class='panel-heading colortxt'>" . $comp->nombre_competencia . "</td>
        <td class='panel-heading colortxt'>" . $comp->descripcion_competencia . "</td>
        </tr>";
        $i++;
        //Por cada competencia, traigo las preguntas
        $tabla .= '<tr>
                    <td class="texto-title3" colspan="5"></td>
                </tr>';
    }
    $tabla .= "</table>";
    $PRINCIPAL = str_replace("{BLOQUE_COMPETENCIAS_POR_PERFIL}", utf8_encode($tabla), $PRINCIPAL);
    return ($PRINCIPAL);
}
function TraeNotificacionesInteraccionSinLeerPersonal($PRINCIPAL, $rut, $tipo, $id_empresa)
{
    $notificaciones_seguidor_array = TraeNotificacionesInteraccionesNuevoSeguidorData($rut, $id_empresa);
    $not_seguidor                  = "";
    foreach ($notificaciones_seguidor_array as $notificacion_seguidor) {
        $not_seguidor .= $notificacion_seguidor->nombre_completo . " te comenz? a seguir";
    }
    if ($not_seguidor <> "") {
        $template_notificaciones_seguidor = file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_notificaciones_desktop_seguidor.html");
        $template_notificaciones_seguidor = str_replace("{TITULO_NOTIFICACIONES}", "Tienes nuevos seguidores!", $template_notificaciones_seguidor);
        $template_notificaciones_seguidor = str_replace("{TEXTO_NOTIFICACIONES}", $not_seguidor, $template_notificaciones_seguidor);
        $template_notificaciones_seguidor = str_replace("{RUT_REMITENTE}", $notificacion_seguidor->rut_remitente, $template_notificaciones_seguidor);
        $PRINCIPAL                        = str_replace("{NOTIFICACIONES_DESKTOP_SEGUIDOR}", $template_notificaciones_seguidor, $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{NOTIFICACIONES_DESKTOP_SEGUIDOR}", "", $PRINCIPAL);
    }
    $notificaciones_compartidos_array = TraeNotificacionesInteraccionesNuevoCompartidoData($rut, $id_empresa);
    $not_compartido                   = "";
    foreach ($notificaciones_compartidos_array as $notificacio_compartido_array) {
        $not_compartido .= $notificacio_compartido_array->nombre_completo . "  te compartio una publicaci?n";
        //$not_compartido.=$notificacio_compartido_array->titulo_post." ";
        $id_compartida = $notificacio_compartido_array->id_mp;
    }
    if ($not_compartido <> "") {
        $template_notificaciones_compartido = file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_notificaciones_desktop_compartido.html");
        $template_notificaciones_compartido = str_replace("{TEXTO_NOTIFICACIONES}", utf8_encode($notificacio_compartido_array->titulo_post), $template_notificaciones_compartido);
        $template_notificaciones_compartido = str_replace("{TITULO_NOTIFICACIONES}", $not_compartido, $template_notificaciones_compartido);
        $template_notificaciones_compartido = str_replace("{ID_MP}", $id_compartida, $template_notificaciones_compartido);
        $PRINCIPAL                          = str_replace("{NOTIFICACIONES_DESKTOP_COMPARTIDO}", $template_notificaciones_compartido, $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{NOTIFICACIONES_DESKTOP_COMPARTIDO}", "", $PRINCIPAL);
    }
    $notificaciones_array = TraeNotificacionesInteraccionSinLeerPersonalData($rut, $tipo, $id_empresa);
    foreach ($notificaciones_array as $notificacion) {
        $not_tipo                = $notificacion->tipo;
        $not_cuenta              = $notificacion->cuenta;
        $not_seguidor            = $notificacion->seguidores;
        $cantidad_not_megusta    = 0;
        $cantidad_not_comentario = 0;
        $cantidad_not_nomegusta  = 0;
        $cantidad_not_seguidores = 0;
        if ($not_tipo == "MEGUSTA") {
            $cantidad_not_megusta = $not_cuenta;
        }
        if ($not_tipo == "COMENTARIO") {
            $cantidad_not_comentario = $not_cuenta;
        }
        if ($not_tipo == "NOMEGUSTA") {
            $cantidad_not_nomegusta = $not_cuenta;
        }
    }
    //echo "$cantidad_not_megusta>0 or $cantidad_not_comentario>0 or $cantidad_not_nomegusta>0 or $cantidad_not_seguidores>0";
    if ($cantidad_not_megusta > 0 or $cantidad_not_comentario > 0 or $cantidad_not_nomegusta > 0 or $cantidad_not_seguidores > 0) {
        //echo     "hola";
        $textoInicio = "Tienes ";
        if ($cantidad_not_megusta > 0) {
            $textoMEGUSTA = "" . $cantidad_not_megusta . " nuevos Me Gusta ";
        }
        if ($cantidad_not_nomegusta > 0) {
            $textoNOMEGUSTA = "" . $cantidad_not_nomegusta . " nuevos No Me Gusta";
        }
        if ($cantidad_not_comentario > 0) {
            $textoCOMENTARIOS = "" . $cantidad_not_comentario . " nuevos Comentarios";
        }
        $textoNotificaciones     = $textoInicio . $textoMEGUSTA . $textoNOMEGUSTA . $textoCOMENTARIOS;
        $tituloNotificaciones    = "Interacciones en ComparteBci";
        //echo "views/comunidad_mp/".$template.$id_empresa."_com_mp_notificaciones_desktop.html";
        $template_notificaciones = file_get_contents("views/comunidad_mp/" . $template . $id_empresa . "_com_mp_notificaciones_desktop.html");
        //echo $textoNotificaciones;
        $template_notificaciones = str_replace("{TITULO_NOTIFICACIONES}", $textoNotificaciones, $template_notificaciones);
        $template_notificaciones = str_replace("{TEXTO_NOTIFICACIONES}", $tituloNotificaciones, $template_notificaciones);
        $PRINCIPAL               = str_replace("{NOTIFICACIONES_DESKTOP}", $template_notificaciones, $PRINCIPAL);
        $PRINCIPAL               = str_replace("{NOTIFICACIONES_DESKTOP_COMPARTIDO}", $template_notificaciones, $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{NOTIFICACIONES_DESKTOP}", "", $PRINCIPAL);
    }
    return $PRINCIPAL;
}
function ActualizaTablatblLmsReportePorRut($rut)
{
    CRON_INDIVIDUAL_BorraTblLmsReporte($rut);
    $usuarios        = CRON_INDIVIDUAL_UsuariosPorEmpresaCapacitacion_sinSinEmpresa($arreglo_post, "", "", $rut);
    $start           = microtime(true);
    $id_empresaArray = CRON_INDIVIDUAL_ObtenerEmpresaDadoRutSinEmpresa($rut);
    foreach ($usuarios as $usu) {
        $id_empresa = $usuarios[0]->id_empresa;
        $datamalla  = CRON_INDIVIDUAL_ObtenerDatosRelMallaUsuarioDadoRutSinEmpresa($rut);
        $cursos     = CRON_INDIVIDUAL_LMS_REPORTE_TraeCursosInscripcionUsuario($rut, $id_empresa);
        foreach ($cursos as $curso) {
            //print_r($curso);
            //echo "<br><br>";
            //echo "<br>curso id ".$curso->id_curso." rut ".$usu->rut." malla ".$curso->id_malla;
            $i++;
            //$arreglo_post[curso]=$curso->id;
            $arreglo_post[curso]            = $curso->id_curso;
            //echo $curso->id_curso."<br>";
            $datos_relacion_rel_malla_curso = RON_INDIVIDUAL_LMS_REPORTE_TraeMallaCurso($curso->id_curso, $curso->id_malla, $id_empresa);
            //print_r($datos_relacion_rel_malla_curso);
            //echo "<br><br>";
            $id_programa_bbddhost           = CRON_INDIVIDUAL_LMS_Buscabbddhost($datos_relacion_rel_malla_curso[0]->id_programa, $id_empresa);
            //print_r($id_programa_bbddhost);
            if ($id_programa_bbddhost[0]->bbdd_host) {
                //echo $id_programa_bbddhost[0]->bbdd_host." PROGRAMA HOST <br>";
                $hostname = $id_programa_bbddhost[0]->bbdd_host;
                $database = $id_programa_bbddhost[0]->bbdd_database;
                $username = $id_programa_bbddhost[0]->bbdd_username;
                $password = $id_programa_bbddhost[0]->bbdd_password;
                $conexion = new mysqli($hostname, $username, $password, $database);
                //$sql="select * from tbl_usuario where rut='".$usu->rut."'";
                //Traigo datos desde la tabla lms_reporte
                $sql      = "
                        select *
                            from tbl_lms_reportes
                            where rut='" . $usu->rut . "' and
                                id_malla='" . $datos_relacion_rel_malla_curso[0]->id_malla . "' and
                                id_clasificacion='" . $datos_relacion_rel_malla_curso[0]->id_clasificacion . "' and
                                id_curso='" . $curso->id_curso . "' and
                                id_empresa='" . $id_programa_bbddhost[0]->id_empresa_programa . "'
                                ";
                //echo $sql;
                //echo "<br>";
                $query    = $conexion->query($sql);
                if ($query->num_rows > 0) {
                    while ($r = $query->fetch_array()) {
                        //print_r($r);
                        //echo "<br><br>";
                        //echo $r["nombre"];
                        //echo "<br>";
                        $nombre                      = $r["nombre"];
                        $cargo                       = $r["cargo"];
                        $email                       = $r["email"];
                        $datos_calculos_malla[2][3]  = $r["c1"];
                        $datos_calculos_malla[2][4]  = $r["c2"];
                        $datos_calculos_malla[2][4]  = $r["c3"];
                        $c3                          = $r["id_malla"];
                        $id_clasificacion            = $r["id_clasificacion"];
                        $datos_calculos_malla[1]     = $r["avance"];
                        $puntos                      = $r["puntos"];
                        $resultado                   = $r["resultado"];
                        $datos_calculos_malla[2][7]  = $r["medallas"];
                        $fecha                       = $r["fecha"];
                        $hora                        = $r["hora"];
                        $id_empresa_externo          = $r["id_empresa"];
                        $datos_calculos_malla[2][0]  = $r["rut_completo"];
                        $datos_calculos_malla2       = ColocaDatosMallaCapacitacion($rows, $usu->rut, $id_empresa, "", "admin", $arreglo_post, "", $tipo_de_reporte);
                        $datos_calculos_malla[2][3]  = $datos_calculos_malla2[2][3];
                        $datos_calculos_malla[2][4]  = $datos_calculos_malla2[2][4];
                        $datos_calculos_malla[2][5]  = $datos_calculos_malla2[2][5];
                        $datos_calculos_malla[2][10] = $datos_calculos_malla2[2][10];
                    }
                } else {
                    //    echo "No hay resultados";
                }
            } else {
                $datos_calculos_malla = ColocaDatosMallaCapacitacion($rows, $usu->rut, $id_empresa, "", "admin", $arreglo_post, "", $tipo_de_reporte);
                //print_r($datos_calculos_malla);
            }
            $fecha_inicial       = CRON_INDIVIDUAL_LMS_REPORTE_VerificaObjetoFinalizadoDadoObjetoPrimero($curso->id_curso, $usu->rut);
            $fecha_final         = CRON_INDIVIDUAL_LMS_REPORTE_VerificaObjetoFinalizadoDadoObjetoUltima($curso->id_curso, $usu->rut);
            $fecha_final_guardar = "";
            if ($fecha_inicial[0]->fecha <> $fecha_final[0]->fecha and $fecha_inicial[0]->hora <> $fecha_final[0]->hora) {
                $fecha_final_guardar = $fecha_final[0]->fecha;
            }
            $rows = str_replace("{RUT_COMPLETO_EVALUADO}", $datos_calculos_malla[2][0], $rows);
            $rows = str_replace("{NOMBRE_COMPLETO}", $datos_calculos_malla[2][1], $rows);
            $rows = str_replace("{CARGO}", $datos_calculos_malla[2][2], $rows);
            $rows = str_replace("{CAMPO1}", $datos_calculos_malla[2][3], $rows);
            $rows = str_replace("{CAMPO2}", $datos_calculos_malla[2][4], $rows);
            $rows = str_replace("{CAMPO3}", $datos_calculos_malla[2][5], $rows);
            $rows = str_replace("{EMAIL}", $datos_calculos_malla[2][9], $rows);
            $rows = str_replace("{MALLA}", $arreglo_post["malla"], $rows);
            $rows = str_replace("{NUM}", $i, $rows);
            $rows = str_replace("{CURSO}", utf8_encode($curso->nombre), $rows);
            $rows = str_replace("{NUMERO_AVANCE}", CRON_INDIVIDUAL_ColocarColoresConPorcentajeProgressBar($datos_calculos_malla[1]), $rows);
            //$resultado=GAMIFICACIONResultadosPorSoloCurso($usu->rut, $curso->id_curso, $id_empresa);
            //$puntos=GAMIFICACIONResultadosPorSoloCursoPuntos($usu->rut, $curso->id, $id_empresa);
            if ($id_programa_bbddhost[0]->bbdd_host) {
            } else {
                $resultado = GAMIFICACIONResultadosPorSoloCurso($usu->rut, $curso->id_curso, $id_empresa);
                $puntos    = CRON_INDIVIDUAL_GAMIFICACIONResultadosPorSoloCursoPuntos($usu->rut, $curso->id_curso, $id_empresa);
            }
            $rows = str_replace("{PUNTOS}", round($puntos), $rows);
            $rows = str_replace("{RESULTADO}", round($resultado), $rows);
            $rows = str_replace("{MEDALLAS}", $datos_calculos_malla[2][7], $rows);
            //echo "sin insertar";
            CRON_INDIVIDUAL_Inserta_tbl_lms_reportes_sinempresa($usu->rut, $usu->nombre_completo, $usu->cargo, $usu->email, utf8_decode($datos_calculos_malla[2][3]), utf8_decode($datos_calculos_malla[2][4]), utf8_decode($datos_calculos_malla[2][5]), utf8_encode($datos_relacion_rel_malla_curso[0]->id_malla), utf8_encode($datos_relacion_rel_malla_curso[0]->id_clasificacion), utf8_encode($datos_relacion_rel_malla_curso[0]->id_curso), $datos_calculos_malla[1], $puntos, $resultado, $datos_calculos_malla[2][7], $id_empresa, $datos_calculos_malla[2][0], utf8_encode($datos_relacion_rel_malla_curso[0]->id_foco), utf8_encode($datos_relacion_rel_malla_curso[0]->id_programa), $fecha_inicial[0]->fecha, $fecha_final_guardar, utf8_decode($datos_calculos_malla[2][10]), ($datos_relacion_rel_malla_curso[0]->opcional));
        }
    }
    $end = (microtime(true) - $start);
    //echo "elapsed time: $end";
}
function MuestraNotaConvertidaPorEmpresa($id_empresa, $nota)
{

    //echo "<br>$nota";

    $datos_empresa   = DatosEmpresa($id_empresa);
    $nota_convertida = "-";
    if ($datos_empresa[0]->tokem_validacion_externo = "nota1a7trivia") {
        $nota_convertida = ColocaNotaConvertidaTrivia($nota);
    } else {
        $nota_convertida = $nota;
    }
    return ($nota_convertida);
}
function VerificaEstadoDimensionesObjetivosIngresados($evaluado, $id_dimension, $id_empresa)
{
    $objetivos = TraeObjetivosIndividualesDadoRut($evaluado);
    if ($objetivos) {
        $arreglo[0] = '<span class="etiquetaPrograma etiquetaPrograma-aprobado pull-left"><i class="fas fa-check-square"></i>&nbsp;&nbsp;Ingresado</span>';
        $arreglo[1] = 1;
    } else {
        //Veo si tiene 1 objetivo ingresado
        $objetivo_por_dimension = ObjetivosPodDimensionEmpresaUsuario($evaluado, $id_empresa, $id_dimension);
        if (count($objetivo_por_dimension) > 0) {
            $arreglo[0] = '<span class="etiquetaPrograma etiquetaPrograma-pendiente pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;Pendiente</span>';
            $arreglo[1] = 2;
        } else {
            $arreglo[0] = '<span class="etiquetaPrograma etiquetaPrograma-pendiente pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;Pendiente</span>';
            $arreglo[1] = 0;
        }
    }
    return ($arreglo);
}
function ColocaNotaConvertidaTrivia($nota)
{
    $Nota1a7 = 1;
    $Nota1a7 = 0.06 * $nota + 1;
    $Nota1a7 = round($Nota1a7, 1);
    if ($nota === 0) {
        $Nota1a7 = 1;
    }
    ;
    if ($nota === 100) {
        $Nota1a7 = 7;
    }
    ;
    //if(!$nota){$Nota1a7="";};
    //Si es 0 la nota es 1,
    //Si es 100, la nota es 7
    //echo "nota $nota,".$Nota1a7;
    return ($Nota1a7);
}
function ObtnieneNotaObjetosPonderados($id_empresa, $id_curso, $rut)
{
    $notas      = NotasPonderacionPorObjetoRut($rut, $id_curso, $id_empresa);
    $acumulador = 0;
    foreach ($notas as $not) {
        $acumulador = $acumulador + (($not->nota * $not->ponderacion) / 100);
    }
    return ($acumulador);
}
function ColocaBloqueTextoDesafio($id_desafio, $rut, $id_objeto, $id_curso, $id_desafio, $id_empresa)
{
    $preguntas          = TraigoBloqueTextoPorDesafio($id_desafio, $rut, $id_objeto, $id_curso, $id_desafio, $id_empresa);
    $total_preguntas    = "";
    $usuario_finalizado = TieneAccionesPEndientes($rut, $id_empresa, $id_curso, $id_objeto);
    $titulo_dimension   = "";
    $datos_desafio      = TraeDatosDesafioDadoId($id_desafio);
    $i                  = 1;
    foreach ($preguntas as $preg) {
        $total_preguntas .= file_get_contents("views/cursos/objetos/desafio/row_bloque_texto.html");
        if ($preg->tabla_select) {
            $datos_select = SelectAsterisco($preg->tabla_select);
            $options      = "";
            foreach ($datos_select as $sel) {
                if ($preg->respuesta == $sel->valor) {
                    $options .= "<option selected='selected' value='" . ($sel->valor) . "'>" . ($sel->valor) . "</option>";
                } else {
                    $options .= "<option value='" . ($sel->valor) . "'>" . ($sel->valor) . "</option>";
                }
            }
        }
        $total_preguntas = str_replace("{OPTIONS_SELECT_DINAMICO}", $options, $total_preguntas);
        $total_preguntas = str_replace("{NUMERO}", $i, $total_preguntas);
        $i++;
        $total_preguntas = str_replace("{ID}", $preg->id, $total_preguntas);
        if ($preg->muestra_pregunta == 1) {
            $total_preguntas = str_replace("{PREGUNTA}", "&nbsp;", $total_preguntas);
        } else {
            $total_preguntas = str_replace("{PREGUNTA}", $preg->pregunta, $total_preguntas);
        }
        $total_preguntas = str_replace("{VALUE}", $preg->respuesta, $total_preguntas);
        if ($preg->obligatorio == "no") {
            $total_preguntas = str_replace("{REQUIRED}", "", $total_preguntas);
        } else {
            $total_preguntas = str_replace("{REQUIRED}", 'required="required"', $total_preguntas);
        }
        if ($preg->respuesta) {
            $total_preguntas = str_replace("{BLOQUE_VER_DOCUMENTO}", file_get_contents("views/cursos/objetos/desafio/row_bloque_file_ve.html"), $total_preguntas);
        } else {
            $total_preguntas = str_replace("{BLOQUE_VER_DOCUMENTO}", "", $total_preguntas);
        }
        $total_preguntas = str_replace("{URL_ARCHIVO}", "objetos/" . $id_curso . "/" . $id_objeto . "/" . $preg->respuesta, $total_preguntas);
        if ($datos_desafio[0]->colspan) {
            $total_preguntas = str_replace("{ROW1}", "0", $total_preguntas);
            $total_preguntas = str_replace("{ROW2}", $datos_desafio[0]->colspan, $total_preguntas);
        } else {
            $total_preguntas = str_replace("{ROW1}", "1", $total_preguntas);
            $total_preguntas = str_replace("{ROW2}", "10", $total_preguntas);
        }
    }
    return (utf8_encode($total_preguntas));
}
function ColocaFechaCreacionDesafio($id_objeto, $rut, $rut_colaborador_desde_vista_jefe)
{
    if ($rut_colaborador_desde_vista_jefe) {
        //Vista Jefe
        $datos_objeto_finalizado = ObjetoFinalizadoDadoIdYRut($rut_colaborador_desde_vista_jefe, $id_objeto);
    } else {
        //Vista colaborador
        $datos_objeto_finalizado = ObjetoFinalizadoDadoIdYRut($rut, $id_objeto);
    }
    if ((formatearFechaCompleta($datos_objeto_finalizado[0]->fecha)) == "31 de Diciembre de 1969") {
        return ("-");
    } else {
        return (formatearFechaCompleta($datos_objeto_finalizado[0]->fecha));
    }
}
function ColocaNotificacionesBannerJefe($rut, $id_empresa, $rut_colaborador, $id_objeto, $tipo_objeto)
{
    //aca verifico si hay not
    if ($tipo_objeto == "listadoObjetos") {
        $total_acciones_pendientes_por_jefe = ObtenerAccionesPendientesPorJefeYEmpresaPorObjeto($rut, $id_empresa, $rut_colaborador, $id_objeto);
    } else {
        $total_acciones_pendientes_por_jefe = ObtenerAccionesPendientesPorJefeYEmpresa($rut, $id_empresa, $rut_colaborador, $id_objeto);
    }
    /*
    if($total_acciones_pendientes_por_jefe){
    if($vista==""){
    $tiene_notificacion++;
    }
    $notificacion_colaborador=file_get_contents("views/mi_equipo_lms/".$id_empresa."_mensaje_global_home_jefe.html");
    $notificacion_colaborador= str_replace("{FECHA}",date("Y-m-d"),$notificacion_colaborador);
    $notificacion_colaborador= str_replace("{NUMERO_DESAFIOS}",count($total_acciones_pendientes_por_jefe),$notificacion_colaborador);
    }
    */
    $total = 0;
    foreach ($total_acciones_pendientes_por_jefe as $tot) {
        $total++;
        //voy por cada desafio que ya fue enviado a validar
        //Traigo el ultimo comentario realizado por el jefe
        $ultimo_comentario_realizado_por_jefe = TraeUltimoComentarioObjeto($rut, $tot->id_objeto);
        if (!$ultimo_comentario_realizado_por_jefe) {
            $tiene_notificacion++;
            continue;
        } else {
            if ($tot->rut_colaborador == "bci15") {
                //    print_r($tot);
                //    echo "<br>";
            }
            if ($tot->rut_colaborador == "bci15") {
                //    print_r($ultimo_comentario_realizado_por_jefe);
                //    echo "<br>";
            }
            //Si tiene comentario, obtengo la fecha
            $fecha_comentario             = $ultimo_comentario_realizado_por_jefe[0]->fecha;
            $hora_comentario              = $ultimo_comentario_realizado_por_jefe[0]->hora;
            //Veo la ultima actualizacion en la tabla de respuestas log de los desafios
            $ultima_respuesta_colaborador = TraeUltimaRespuestaLogDesafios($tot->rut_colaborador, $tot->id_desafio, $tot->id_objeto, $id_empresa);
            if ($tot->rut_colaborador == "bci15") {
                //    print_r($ultima_respuesta_colaborador);
                //    echo "<br>";
            }
            $fecha_ultima_actualizacion = $ultima_respuesta_colaborador[0]->fecha;
            $hora_ultima_actualizacion  = $ultima_respuesta_colaborador[0]->hora;
            //echo "$fecha_comentario>$fecha_ultima_actualizacion ".$tot->rut_colaborador." ".$tot->id_objeto."<br>";
            if ($fecha_comentario > $fecha_ultima_actualizacion) {
                //No esta pendiente, porque la fecha de la ultima actualizacion del colaborador, es menor a la fecha del ultimo comentario del jefe
            } else {
                if ($fecha_ultima_actualizacion > $fecha_comentario) {
                    //Esta pendiente, porque no esta validado este desafio, y la ultima actualizacion por parte del evaluado, su fecha es mayor a la de la ultima recomendacion del jefe
                    $tiene_notificacion++;
                } else if ($fecha_ultima_actualizacion == $fecha_comentario) {
                    //echo "aca";
                    //echo "$hora_ultima_actualizacion > $hora_comentario<br>";
                    $hora_jefe        = strtotime($hora_comentario);
                    $hora_colaborador = strtotime($hora_ultima_actualizacion);
                    //if($hora_colaborador>$hora_jefe){
                    if ($hora_ultima_actualizacion > $hora_comentario)
                    //echo "$hora_ultima_actualizacion==$hora_comentario <br>";

                    //echo "$fecha_comentario>$fecha_ultima_actualizacion ".$tot->rut_colaborador." ".$tot->id_objeto."<br>";

                    //echo "<br>";
                        $tiene_notificacion++;
                } else {
                    //echo "$hora_ultima_actualizacion else $hora_comentario<br>";
                }
            }
        }
    }
    if ($tiene_notificacion > 0) {
        $notificacion_colaborador = file_get_contents("views/mi_equipo_lms/" . $id_empresa . "_mensaje_global_home_jefe.html");
        $notificacion_colaborador = str_replace("{FECHA}", date("Y-m-d"), $notificacion_colaborador);
        $notificacion_colaborador = str_replace("{NUMERO_DESAFIOS}", $tiene_notificacion, $notificacion_colaborador);
        $notitituloficacion_colaborador .= file_get_contents("views/mi_equipo_lms/" . $id_empresa . "_titulo_notificaciones.html");
        $bloque_notificaciones = $notitituloficacion_colaborador . utf8_encode($notificacion_colaborador);
    }
    //return(($bloque_notificaciones));
    return ($bloque_notificaciones);
}
function ColocaNotificacionesBanner($rut, $id_empresa, $vista, $id_curso, $id_objeto)
{
    //Verifico si este usuario tiene desafios pendientes, y con comentarios.
    $desafios_pendientes = ObtenerAccionesPendientesPorColaboradorYEmpresa($rut, $id_empresa, $id_curso);
    foreach ($desafios_pendientes as $desa_pend) {
        //if($desa_pend->total_comentarios_jefe>0){
        if ($desa_pend->ultimo_comentarios_jefe) {
            if ($vista == "vista_curso") {
                $notificacion_colaborador .= file_get_contents("views/mi_equipo_lms/" . $id_empresa . "_mensaje_colaborador_vista_cursos.html");
                $tiene_notificacion++;
            } else {
                $notificacion_colaborador .= file_get_contents("views/mi_equipo_lms/" . $id_empresa . "_mensaje_home_colaborador.html");
            }
            if ($vista == "") {
                $tiene_notificacion++;
            }
            $notificacion_colaborador = str_replace("{FECHA}", $desa_pend->fecha_ultimo_comentarios_jefe, $notificacion_colaborador);
            $notificacion_colaborador = str_replace("{CURSO}", $desa_pend->nombre_curso, $notificacion_colaborador);
            $notificacion_colaborador = str_replace("{DESAFIO}", $desa_pend->nombre_desafio, $notificacion_colaborador);
            $notificacion_colaborador = str_replace("{TEXTO}", $desa_pend->ultimo_comentarios_jefe, $notificacion_colaborador);
            $notificacion_colaborador = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($desa_pend->id_objeto), $notificacion_colaborador);
        }
    }
    //Verifico si el jefe valido un desafio.
    if ($vista <> "vista_curso") {
        $trae_los_validados = TraeDesafiosValidados($rut, $id_empresa);
        foreach ($trae_los_validados as $validado) {
            $notificacion_colaborador .= file_get_contents("views/mi_equipo_lms/" . $id_empresa . "_mensaje_home_colaborador_validado.html");
            $notificacion_colaborador = str_replace("{FECHA}", $validado->fecha, $notificacion_colaborador);
            $notificacion_colaborador = str_replace("{CURSO}", $validado->nombre_curso, $notificacion_colaborador);
            $notificacion_colaborador = str_replace("{DESAFIO}", $validado->nombre_desafio, $notificacion_colaborador);
            $notificacion_colaborador = str_replace("{TEXTO}", $validado->ultimo_comentarios_jefe, $notificacion_colaborador);
            $notificacion_colaborador = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($validado->id_objeto), $notificacion_colaborador);
            if ($vista == "") {
                $tiene_notificacion++;
            }
        }
    }
    if ($tiene_notificacion > 0) {
        if ($vista == "") {
            $notitituloficacion_colaborador = file_get_contents("views/mi_equipo_lms/" . $id_empresa . "_titulo_notificaciones.html");
        }
        $notitituloficacion_colaborador = str_replace("{TEXTO}", $desa_pend->ultimo_comentarios_jefe, $notitituloficacion_colaborador);
        $bloque_notificaciones          = $notitituloficacion_colaborador . utf8_encode($notificacion_colaborador);
    }
    return (($bloque_notificaciones));
}
function ColocaListadoParticipantesPorinscripcionCheckin($PRINCIPAL, $id_inscripcion, $id_empresa)
{
    //$listadp_participantes=ListadoParticipantesDadoCursiEmpresa($id_curso, $id_empresa);
    //$listadp_participantes=ListadoParticipantesDadoCursiEmpresaSinRelator($id_curso, $id_empresa);
    //echo "<br>$id_inscripcion, $id_empresa";
    //$listadp_participantes=ListadoParticipantesDadoInscripcionEmpresaSinRelator($id_inscripcion, $id_empresa);
    $listadp_participantes = ListadoParticipantesDadoInscripcionEmpresaSinRelatorCheckin($id_inscripcion, $id_empresa);
    $datos_usuario         = UsuarioEnBasePersonas($_SESSION["user_"]);
    $PRINCIPAL             = str_replace("{NOMBRE_USUARIO}", utf8_encode($datos_usuario[0]->nombre_completo), $PRINCIPAL);
    foreach ($listadp_participantes as $unico) {
        $row .= file_get_contents("views/cursos/objetos/check/row_listado_participantes.html");
        $row = str_replace("{NOMBRE}", $unico->nombre_completo, $row);
        $row = str_replace("{CARGO}", $unico->cargo, $row);
        $row = str_replace("{URL_MIPERFIL}", VerificaFotoPersonal($unico->rut), $row);
    }
    $PRINCIPAL = str_replace("{LISTADO_USUARIOS}", utf8_encode($row), $PRINCIPAL);
    $PRINCIPAL = str_replace("{CODIGO_CURSO_ENCODEADO}", Encodear3($id_curso), $PRINCIPAL);
    return ($PRINCIPAL);
}
function INTEGRACION_VerificaUsuarioEnOtraBase($rut, $host, $base, $user, $pass, $id_malla, $id_empresa_programa)
{
    $link_exte = mysql_connect($host, $user, $pass);
    //echo 'Conexion Exitosa <br>';
    mysql_select_db($base);
    $query = 'SELECT * from tbl_usuario where rut="' . $rut . '"';
    $resultado = mysql_query($query) or die('Consulta fallida: ' . mysql_error());
    $existe_usuario = 0;
    while ($fila = mysql_fetch_array($resultado, MYSQL_ASSOC)) {
        $existe_usuario++;
    }
    //echo $existe_usuario;
    if ($existe_usuario == 0) {
        //Traigo los datos del usuario de esta base
        $datos_usuario = UsuarioEnBasePersonas($rut);
        $link_exte     = mysql_connect($host, $user, $pass);
        mysql_select_db($base);
        $query_inserta_usuario = 'INSERT INTO tbl_usuario(rut, nombre, id_empresa)  VALUES ("' . $rut . '", "nombre", "' . $id_empresa_programa . '")';
        $resultado_inserta_tabla_usuario = mysql_query($query_inserta_usuario) or die('Consulta fallida: ' . mysql_error());
        //Inserto registro en la tabla claves
        $link_exte = mysql_connect($host, $user, $pass);
        mysql_select_db($base);
        $query_inserta_clave = 'INSERT INTO tbl_clave(rut, clave, cambiado, id_empresa)  VALUES ("' . $rut . '", "' . substr($rut, 0, 4) . '", "1", "' . $id_empresa_programa . '")';
        $resultado_inserta_clave_usuario = mysql_query($query_inserta_clave) or die('Consulta fallida: ' . mysql_error());
        $link_exte = mysql_connect($host, $user, $pass);
        mysql_select_db($base);
        $query_inserta_malla_persona = 'INSERT INTO rel_lms_malla_persona(id_malla, rut, id_empresa)  VALUES ( "' . $id_malla . '", "' . $rut . '", "' . $id_empresa_programa . '")';
        $resultado_inserta_rel_malla_usuario = mysql_query($query_inserta_malla_persona) or die('Consulta fallida: ' . mysql_error());
    }
}
function ColocaPestanasFocosHome($rut, $id_empresa)
{
    $focos = ObtenerFocosPorRut($rut, $id_empresa);
    foreach ($focos as $foc) {
        $html_foco .= file_get_contents("views/home/focos_home/row_pestanas_focos.html");
        $html_foco = str_replace("{CODIGO_FOCO}", $foc->id_foco, $html_foco);
        $html_foco = str_replace("{NOMBRE_FOCO}", $foc->nombre_foco, $html_foco);
    }
    return ($html_foco);
}
function ReparaInconsistenciasObjetoCursoMallaAvance($rut, $id_empresa)
{
    //objetos con id curso vacio
    $objetosInconsistencias = ReparaInconsistenciasObjetoCursoMallaAvanceData($rut);
    foreach ($objetosInconsistencias as $objetoInconsistencia) {
        $id_cursoReparar = ReparaInconsistenciasBuscaCursoDadoObjetos($objetoInconsistencia->id_objeto, $id_empresa);
        //print_r($id_cursoReparar);
        ReparaInconsistenciasActualizaObjetoFinalizadoDadoObjetos($rut, $objetoInconsistencia->id_objeto, $id_cursoReparar[0]->id_curso, $id_empresa);
    }
    $objetosInconsistentesErroneos = ReparaInconsistenciasObjetoCursoIncorrectoData($rut);
    foreach ($objetosInconsistentesErroneos as $objetoInconsistenteErroneo) {
        $id_cursoReparar = ReparaInconsistenciasBuscaCursoDadoObjetos($objetoInconsistenteErroneo->id_objeto, $id_empresa);
        ReparaInconsistenciasActualizaObjetoFinalizadoDadoObjetos($rut, $objetoInconsistenteErroneo->id_objeto, $id_cursoReparar[0]->id_curso, $id_empresa);
    }
}
function ReparaInconsistenciasAvanceCurso($rut, $id_curso, $id_empresa)
{





    //$start = microtime(true);

    //echo "hola";
    $AvanceDetalle = ReparaInconsistenciasBuscaObjetoFinalizadosCurso($id_curso, $id_empresa, $rut);
    $nota          = GAMIFICACIONTraeDatosObjetosPorCurso($rut, $id_curso);
    $nota          = $nota[0]->promedio_por_curso;
    //echo "<br>diferencia $id_curso propuesto ";
    //echo $AvanceDetalle[0]->AvancePropuesto;
    //echo "escrito ";
    //    echo $AvanceDetalle[0]->AvanceEscrito;
    if ($AvanceDetalle[0]->AvancePropuesto >= 100) {
        $avance = 100;$estado = 1;
    }
    if ($AvanceDetalle[0]->AvancePropuesto <= 100) {
        $avance = $AvanceDetalle[0]->AvancePropuesto;$estado = 3;
    }
    $datos_objeto = TraigoObjetoCertificacionDadoCurso($id_curso, $id_empresa);
    //print_r($datos_objeto);
    //exit;
    if ($avance == 100) {
        if ($datos_objeto[0]->nota_aprobacion <> '' and $nota < $datos_objeto[0]->nota_aprobacion) {
            //REPROBADO
            //$estado=0;
            $estado             = 1;
            $estado_descripcion = "REPROBADO";
        } else {
            //APROBADO
            $estado             = 1;
            $estado_descripcion = "APROBADO";
        }
        //}
    }
    //echo $avance;exit;
    ReparaInconsistenciasActualizaIncripcionCierre($avance, $estado, $rut, $id_curso, $id_empresa, $nota, $estado_descripcion);
    //print_r($AvancePropuesto);
    //$CuentaObjetos
    //$avacePropuesta
    //$avanceEscrito
    //$Actualiza

    // $time_elapsed_secs = microtime(true) - $start;
    // $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
//echo "<br>Tiempo: $time_elapsed_secs";

}


function ColocaPaginacionDeComentarios($pagina, $id_objeto, $rut, $id_malla, $cantidad_comentarios)
{
    //$imagenes=FotosPorObjeto($id_objeto, $_SESSION["id_empresa"], "no");
    //echo "$pagina, $id_objeto, $rut, idmalla $id_malla";
    $imagenes    = FotosPorObjeto($id_objeto, $_SESSION["id_empresa"], "no", $id_malla);
    //traigo el total de comentarios por objeto
    $comentarios = ComentariosPorObjeto($id_objeto);
    //print_r($comentarios);
    if (!$pagina) {
        $pagina = 1;
    }
    $total_comentarios = count($comentarios);
    $paginacion        = file_get_contents("views/cursos/objetos/foro/entorno_paginacion.html");
    $total_paginas     = ceil($total_comentarios / $cantidad_comentarios);
    //echo "$imagenes_por_pagina, $total_imagenes, $total_paginas";
    for ($i = 1; $i <= $total_paginas; $i++) {
        $row .= file_get_contents("views/cursos/objetos/foro/row_paginacion.html");
        $row = str_replace("{NUMERO_PAGINA}", $i, $row);
        $row = str_replace("{PAGINA}", $i, $row);
        if ($pagina == $i) {
            $row = str_replace("{CLASE_ACTIVO}", "class='active'", $row);
        } else {
            $row = str_replace("{CLASE_ACTIVO}", "", $row);
        }
    }
    $paginacion = str_replace("{ROW_PAGINACION}", $row, $paginacion);
    return ($paginacion);
}
function ColocaBloqueTweets($PRINCIPAL, $rut)
{
    $tweets = TwwetsPorUsuario($rut);
    foreach ($tweets as $Tw) {
        $linea .= file_get_contents("views/mejorespracticas/53_mp_row_tweets.html");
        $linea = str_replace("{TEXTO_TWEET}", $Tw->tweet, $linea);
        $linea = str_replace("{FECHA_TWEET}", $Tw->fecha, $linea);
    }
    $PRINCIPAL = str_replace("{ROW_TWEETS}", $linea, $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaComentariosCoach($id_ivph)
{
    //traigo los comentarios de los coach del ivph
    $comentarios = ComentariosCoahPorIVPH($id_ivph);
    if ($comentarios) {
        $listado .= "<div class='row'>
        <div class='col-xs-3 badge badge-info'>Comentarios Coach</div>
        <div class='col-xs-8 badge badge-info'></div>
        <div class='col-xs-1'>&nbsp;</div>
        </div>";
    }
    foreach ($comentarios as $comen) {
        if ($comen->tipo == "Privado") {
            if ($comen->rut_autor == $_SESSION["user_"] or $comen->rut_coach == $_SESSION["user_"]) {
                $listado .= "<div class='row'>
                <div class='col-xs-1'>&nbsp;</div>
                <div class='col-xs-6'>" . $comen->comentario . "</div>
                <div class='col-xs-2'>" . $comen->fecha . "</div>
                <div class='col-xs-2'>" . $comen->hora . "</div>
                <div class='col-xs-1'>&nbsp;</div>
            </div>";
            }
        } else {
            $listado .= "<div class='row'>
                <div class='col-xs-1'>&nbsp;</div>
                <div class='col-xs-6'>" . $comen->comentario . "</div>
                <div class='col-xs-2'>" . $comen->fecha . "</div>
                <div class='col-xs-2'>" . $comen->hora . "</div>
                <div class='col-xs-1'>&nbsp;</div>
            </div>";
        }
    }
    return ($listado);
}
function SubirEvidencia2($FILES, $extension_doc, $prefijo, $ruta, $numero)
{
    //echo "$extension_archivo, $prefijo, $ruta";exit;
    //$ruta_con_archivo=$ruta."/".$prefijo."_BK.".$extension_archivo;
    $ruta_con_archivo = $ruta . "/" . $prefijo . "." . $extension_doc;
    copy($FILES['evidencia2']['tmp_name'], $ruta_con_archivo);
    $nombre_imagen_video = $prefijo . "." . $extension_doc;
    //RedimensionarImagenSlider($ruta_con_archivo, $nombre_imagen_slider);
    //Devuelvol un arreglo, con datos del archivo subido
    $arreglo[0]          = $ruta_con_archivo; //Ruta Completa
    $arreglo[1]          = $prefijo . "." . $extension_doc; //Nombre del Archivo
    $arreglo[2]          = $ruta . "/" . $prefijo; //Ruta del Objeto sin el index
    return ($arreglo);
}
function SubirEvidencia1($FILES, $extension_doc, $prefijo, $ruta, $numero)
{
    //echo "$extension_archivo, $prefijo, $ruta";exit;
    //$ruta_con_archivo=$ruta."/".$prefijo."_BK.".$extension_archivo;
    $ruta_con_archivo = $ruta . "/" . $prefijo . "." . $extension_doc;
    copy($FILES['evidencia1']['tmp_name'], $ruta_con_archivo);
    $nombre_imagen_video = $prefijo . "." . $extension_doc;
    //RedimensionarImagenSlider($ruta_con_archivo, $nombre_imagen_slider);
    //Devuelvol un arreglo, con datos del archivo subido
    $arreglo[0]          = $ruta_con_archivo; //Ruta Completa
    $arreglo[1]          = $prefijo . "." . $extension_doc; //Nombre del Archivo
    $arreglo[2]          = $ruta . "/" . $prefijo; //Ruta del Objeto sin el index
    return ($arreglo);
}
function ColocaBloqueCoach($PRINCIPAL, $rut)
{
    //verifico si es coach el usuario
    $mp = ListadoPlanesPorCoach($rut, $_SESSION["id_empresa"]);
    if ($mp) {
        $PRINCIPAL = str_replace("{BLOQUE_COACH}", file_get_contents("views/mejorespracticas/53_mp_entorno_coach.html"), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_COACH}", "", $PRINCIPAL);
    }
    return ($PRINCIPAL);
}
function BloquefijacionObjetivosPlanes($evaluado, $evaluador, $id_empresa, $id_proceso)
{
    $html      = file_get_contents("views/sgd/informe/" . $id_empresa . "_entorno_fijacion_objetivos_planes.html");
    //Traigo los objetivos de este evaluado
    $objetivos = TraigoObjetivoFijacionTodos($evaluado, $evaluador, $id_proceso, "objetivo", "objetivo");
    $i         = 1;
    foreach ($objetivos as $obj) {
        $total_objetivos .= file_get_contents("views/sgd/informe/" . $id_empresa . "_row_fijacion_objetivos_planes.html");
        $total_objetivos = str_replace("{NUMERO}", utf8_encode($i), $total_objetivos);
        $i++;
        $total_objetivos = str_replace("{VALOR1}", ($obj->objetivo), $total_objetivos);
        $total_objetivos = str_replace("{VALOR2}", ($obj->medicion_cumplimiento), $total_objetivos);
    }
    $html           = str_replace("{ROW_FIJACION_OBJETIVOS}", utf8_encode($total_objetivos), $html);
    $listado_planes = TraigoObjetivoFijacionTodos($evaluado, $evaluador, $id_proceso, "plan", "areas_desarrollo");
    $i              = 1;
    foreach ($listado_planes as $plan) {
        $total_planes .= file_get_contents("views/sgd/informe/" . $id_empresa . "_row_fijacion_objetivos_planes.html");
        $total_planes = str_replace("{NUMERO}", utf8_encode($i), $total_planes);
        $i++;
        $total_planes = str_replace("{VALOR1}", ($plan->areas_desarrollo), $total_planes);
        $total_planes = str_replace("{VALOR2}", ($plan->acciones_requeridas), $total_planes);
    }
    $html = str_replace("{ROW_FIJACION_PLANES}", utf8_encode($total_planes), $html);
    return ($html);
}
function BloqueInteresesDesarrollo($evaluado, $evaluador, $id_empresa, $id_proceso)
{
    $html         = file_get_contents("views/sgd/informe/" . $id_empresa . "_entorno_intereses_desarrollo.html");
    $intereses_ae = InteresesDesarrolloEvaluadoEvaluador($evaluado, $evaluado, $id_proceso, $id_empresa);
    foreach ($intereses_ae as $interes) {
        $total_intereses_ae .= $interes->nombre_interes . "<br>";
    }
    $intereses_desc = InteresesDesarrolloEvaluadoEvaluador($evaluado, $evaluador, $id_proceso, $id_empresa);
    foreach ($intereses_desc as $interes) {
        $total_intereses_desc .= $interes->nombre_interes . "<br>";
    }
    $html    = str_replace("{LISTADO_INTERESES_AE}", utf8_encode($total_intereses_ae), $html);
    $html    = str_replace("{LISTADO_INTERESES_DESC}", utf8_encode($total_intereses_desc), $html);
    $sucesor = TieneComentariosFinalesSGD($evaluado, $evaluado, $id_proceso);
    $html    = str_replace("{SUCESOR}", utf8_encode($sucesor[0]->sucesor), $html);
    return ($html);
}
function BloqueUltimaPReguntaForm($rut, $id_empresa)
{
    $template       = file_get_contents("views/mensajeria/mensajeria_ultima_pregunta.html");
    //Traigo ultima pregunta realizada
    $ultimo_mensaje = UltimoMensajeMensajeria($rut, $id_empresa);
    return ($template);
}
function ColocaFormularioContactate($PRINCIPAL, $id_empresa, $rut)
{
    $PRINCIPAL = str_replace("{RUT_ENCODEADO}", Encodear3($rut), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ListadoIVPH($PRINCIPAL, $id_empresa, $rut, $ord_by, $filt_by, $filt_cat, $vp, $tipo_listado)
{
    if ($tipo_listado == "MisPlanes") {
        $todas = ListadoIvphPorRutEmpresaPlanes($rut, $id_empresa);
    } else if ($tipo_listado == "MisInteracc") {
        ////$todas=ListadoIvphPorRutEmpresa($rut, $id_empresa);
        $todas = ListadoIvphPorRutEmpresaInteracciones($rut, $id_empresa, $_GET["id_mp"]);
    } else if ($tipo_listado == "coachIvph") {
        ////$todas=ListadoIvphPorRutEmpresa($rut, $id_empresa);
        $todas = ListadoPlanesPorCoach($rut, $id_empresa);
    } else if ($tipo_listado == "VeIVPH") {
        $todas = ListadoIvphPorID($_GET["id_mp"], $id_empresa);
    } else {
        $todas = ListadoIvphPorRutEmpresa($rut, $id_empresa);
    }
    $total_listado = "";
    $i             = 1;
    foreach ($todas as $unico) {
        $total_listado .= file_get_contents("views/mejorespracticas/53_mp_row_listado.html");
        if ($unico->rut == $_SESSION["user_"]) {
            if ($unico->id_estado == 2 or $unico->id_estado == 3) {
                $total_listado = str_replace("{BLOQUE_CIERRE}", "<img src='img/green.png' width='15'>", $total_listado);
            } else {
                $total_listado = str_replace("{BLOQUE_CIERRE}", file_get_contents("views/mejorespracticas/53_mp_row_listado_estado.html"), $total_listado);
            }
        } else {
            $total_listado = str_replace("{BLOQUE_CIERRE}", "", $total_listado);
        }
        $total_listado = str_replace("{ID_MP}", $unico->id_mp, $total_listado);
        $total_listado = str_replace("{LINK}", $link_MP, $total_listado);
        if ($unico->coach == $_SESSION["user_"]) {
            if ($unico->id_estado == 2) {
                $total_listado = str_replace("{BLOQUE_VALIDA_COACH}", file_get_contents("views/mejorespracticas/53_mp_coach_valida.html"), $total_listado);
            } else {
                $total_listado = str_replace("{BLOQUE_VALIDA_COACH}", "", $total_listado);
            }
        } else {
            $total_listado = str_replace("{BLOQUE_VALIDA_COACH}", "", $total_listado);
        }
        $total_listado         = str_replace("{CATEGORIA_MP}", ($unico->categoria), $total_listado);
        $total_listado         = str_replace("{NUMERO}", ($i), $total_listado);
        //$total_listado = str_replace("{PORC}",round($unico->promedio_avances_plan),$total_listado);
        $total_planes          = TotalPlanesPorMp($unico->id_mp, $_SESSION["id_empresa"]);
        $total_planes_cerrados = TotalPlanesPorMpCerrados($unico->id_mp, $_SESSION["id_empresa"]);
        $porcentaje            = (count($total_planes_cerrados) * 100) / count($total_planes);
        $total_listado         = str_replace("{PORC}", round($porcentaje), $total_listado);
        //echo "<b>".round($porcentaje)."%</b>";
        $total_listado         = str_replace("{PROBLEMATICA}", ($unico->problema), $total_listado);
        $total_listado         = str_replace("{NOMBRE}", ($unico->nombre), $total_listado);
        $total_listado         = str_replace("{COACH}", ($unico->nombre_coach), $total_listado);
        $total_listado         = str_replace("{KPI}", ($unico->kpi_afectado), $total_listado);
        $total_listado         = str_replace("{CUANTIFICACION}", ($unico->cuantificacion), $total_listado);
        $total_listado         = str_replace("{CANTIDAD_EQUIPO}", ($unico->total_equipo), $total_listado);
        $total_listado         = str_replace("{CANTIDAD_PLANES}", ($unico->total_planes), $total_listado);
        $total_listado         = str_replace("{DOCUMENTO}", ($unico->archivo), $total_listado);
        $total_listado         = str_replace("{DOCUMENTO2}", ($unico->archivo2), $total_listado);
        $total_listado         = str_replace("{EVIDENCIA1}", ($unico->evidencia1), $total_listado);
        $total_listado         = str_replace("{EVIDENCIA2}", ($unico->evidencia2), $total_listado);
        $total_listado         = str_replace("{BLOQUE_LISTADO_COLABORADORES}", utf8_decode(ColocaBloqueEquipoMP($unico->id_mp, $id_empresa)), $total_listado);
        $total_listado         = str_replace("{BLOQUE_LISTADO_PLANES}", utf8_decode(BloquecomentariosPorMP($unico->id_mp, $id_empresa)), $total_listado);
        $total_listado         = str_replace("{BLOQUE_COMENTARIOS_COACH}", (ColocaComentariosCoach($unico->id_mp)), $total_listado);
        //trae los tags por MP
        $total_tags            = TagsPorMPEmpresa($unico->id_mp, $id_empresa);
        $total_tag             = "";
        foreach ($total_tags as $tag) {
            $total_tag .= "<span class='badge2 badge-info'>" . $tag->tag . "</span>&nbsp;&nbsp;&nbsp;";
        }
        $i++;
        $total_listado = str_replace("{TAGS}", $total_tag, $total_listado);
        $total_listado = str_replace("{CONTENIDO}", limit_text($unico->contenido, 25), $total_listado);
        $total_listado = str_replace("{FECHA}", formatearFechaSmall($unico->fecha), $total_listado);
        $total_listado = str_replace("{ESTADO}", ($unico->estado), $total_listado);
        $total_listado = str_replace("{DESCRIPCION_ESTADO}", ($unico->descripcion_estado), $total_listado);
        $total_listado = str_replace("{RUT_AUTOR}", ($unico->rut), $total_listado);
        $total_listado = str_replace("{NOMBRE_AUTOR}", ($unico->nombre_autor), $total_listado);
        $total_listado = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($unico->rut), $total_listado);
        $total_listado = str_replace("{NUMVISITAS}", round($unico->numvisitas), $total_listado);
        $total_listado = str_replace("{NUMMEGUSTA}", ($unico->nummegusta), $total_listado);
        $total_listado = str_replace("{NUMCOMPARTIDA}", ($unico->numcompartido), $total_listado);
        $total_listado = str_replace("{NUMCOMENTARIO}", ($unico->numcomentarios), $total_listado);
        $total_listado = str_replace("{ESTILOESTADO}", ($unico->estilo), $total_listado);
        $total_listado = str_replace("{ICONOESTADO}", ($unico->icono_estado), $total_listado);
        $total_listado = str_replace("{ESTILOCATEGORIA}", ($unico->style), $total_listado);
        $total_listado = str_replace("{ICONOCATEGORIA}", ($unico->icono), $total_listado);
        $total_listado = str_replace("{CATEGORIA_MP}", ($unico->categoria), $total_listado);
        $total_listado = str_replace("{ID_MP}", $unico->id_mp, $total_listado);
    }
    $PRINCIPAL = str_replace("{NUM_FAV}", MPbuscaFav($rut, $id_empresa), $PRINCIPAL);
    $PRINCIPAL = str_replace("{NUM_MISPR}", MPbuscaMp($rut, $id_empresa), $PRINCIPAL);
    $PRINCIPAL = str_replace("{INSIGNIA}", "", $PRINCIPAL);
    //$PRINCIPAL = str_replace("{ROW_LISTADO_RECIENTES}",utf8_encode($total_listado),$PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_LISTADO_IVPH}", utf8_encode($total_listado), $PRINCIPAL);
    $PRINCIPAL = str_replace("{AGRUPACION_CATEGORIAS}", utf8_encode($total_agrup_categoria), $PRINCIPAL);
    $PRINCIPAL = str_replace("{AGRUPACION_AMBITOS}", utf8_encode($total_agrup_ambito), $PRINCIPAL);
    $PRINCIPAL = str_replace("{MAS_PROPOSITIVOS}", utf8_encode($total_listado_mas_propositivo), $PRINCIPAL);
    $PRINCIPAL = str_replace("{MAS_COLABORADORES}", utf8_encode($total_listado_mas_colaborador), $PRINCIPAL);
    $PRINCIPAL = str_replace("{MAS_APOYADORES}", utf8_encode($total_listado_mas_apoyador), $PRINCIPAL);
    $PRINCIPAL = str_replace("{MAS_PARTICIPATIVOS}", utf8_encode($total_listado_mas_participativo), $PRINCIPAL);
    $PRINCIPAL = str_replace("{MAS_MASTER}", utf8_encode($total_listado_mas_master), $PRINCIPAL);
    $PRINCIPAL = str_replace("{TAG_CLOUD}", utf8_encode($total_listado_tag_cloud), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocarDatosHomeFinanciero($PRINCIPAL, $rut, $id_empresa)
{
    //Obtengo datos de la malla
    $datos_curso     = TotalcursosPorUsuaroEmpresa($rut, $id_empresa);
    //cuento el total de aprobados
    $total_aprobados = 0;
    foreach ($datos_curso as $cur) {
        if ($cur->estado == 1) {
            $total_aprobados++;
        }
    }
    $cuadro1 = "";
    $cuadro2 = "";
    $cuadro3 = "";
    $cuadro4 = "";
    $cuadro5 = "";
    $cuadro6 = "";
    $cuadro7 = "";
    $cuadro8 = "";
    if ($total_aprobados == 0) {
        $imagen_fondo = "bci_edu_fin_gameboard0.png";
        $cuadro1      = '{
                            "id" : "rect-biblioteca",
                            "type" : "rect",
                            "x" : 26.5,
                            "y" : 7,
                            "width" : 11,
                            "height" : 15.6,
                            "actions" : {
                                "click" : "follow-link",
                                "link" : "?sw=detalle_cursoCap&idc_senc=bci_ed_nivel1",
                                "open_link_in_new_window" : 0
                            },
                            "default_style" : {
                                "border_radius" : 10,
                                "background_color" : "#ffff00",
                                "background_opacity" : 0.05,
                                "border_width" : 4,
                                "border_style" : "dashed",
                                "border_color" : "#1e78af",
                                "border_opacity" : 0.40601503759398494
                            },
                            "mouseover_style" : {
                                "border_radius" : 10,
                                "background_color" : "#ffff00",
                                "border_style" : "dashed",
                                "border_color" : "#1e78af",
                                "background_opacity" : 0.15560385338345864
                            },
                            "tooltip_style" : {
                                "background_color" : "#00589b"
                            },
                            "tooltip_content" : {
                                "plain_text" : "Endeudamiento Responsable: En este nivel aprender?s a manejar tu nivel de Endeudamiento! (desde function)"
                            }}, ';
    } else if ($total_aprobados == 1) {
        $imagen_fondo = "bci_edu_fin_gameboard1.png";
        $cuadro1      = '{
                            "id" : "cuadro1",
                            "type" : "rect",
                            "x" : 26.5,
                            "y" : 7,
                            "width" : 11,
                            "height" : 15.6,
                            "actions" : {
                                "click" : "follow-link",
                                "link" : "?sw=detalle_cursoCap&idc_senc=bci_ed_nivel1",
                                "open_link_in_new_window" : 0
                            },
                            "default_style" : {
                                "border_radius" : 10,
                                "background_color" : "#ffff00",
                                "background_opacity" : 0.05,
                                "border_width" : 4,
                                "border_style" : "dashed",
                                "border_color" : "#1e78af",
                                "border_opacity" : 0.40601503759398494
                            },
                            "mouseover_style" : {
                                "border_radius" : 10,
                                "background_color" : "#ffff00",
                                "border_style" : "dashed",
                                "border_color" : "#1e78af",
                                "background_opacity" : 0.15560385338345864
                            },
                            "tooltip_style" : {
                                "background_color" : "#00589b"
                            },
                            "tooltip_content" : {
                                "plain_text" : "Endeudamiento Responsable: En este nivel aprender?s a manejar tu nivel de Endeudamiento! (desde function)"
                            }}, ';
        $cuadro2      = '
                            {"id" : "rect-cuadro2",
                            "type" : "rect",
                            "x" : 47,
                            "y" : 1,
                            "width" : 22,
                            "height" : 30,
                            "actions" : {
                                "click" : "follow-link",
                                "link" : "?sw=detalle_cursoCap&idc_senc=bci_ed_nivel2",
                                "open_link_in_new_window" : 0
                            },
                            "default_style" : {
                                "border_radius" : 10,
                                "background_color" : "#ffff00",
                                "background_opacity" : 0.05,
                                "border_width" : 5,
                                "border_style" : "dashed",
                                "border_color" : "#1e78af",
                                "border_opacity" : 0.7
                            },
                            "mouseover_style" : {
                                "border_radius" : 10,
                                "background_color" : "#ffff00",
                                "border_style" : "dashed",
                                "border_color" : "#1e78af",
                                "background_opacity" : 0.15560385338345864
                            },
                            "tooltip_style" : {
                                "background_color" : "#F6303E"
                            },
                            "tooltip_content" : {
                                "plain_text" : "Cuenta Vista / Cuenta Prima: En este nivel aprender?s qu? son las cuentas Vista y Prima, y sus caracter?sticas"
                            }}, ';
    } else if ($total_aprobados == 2) {
        $imagen_fondo = "bci_edu_fin_gameboard2.png";
    } else if ($total_aprobados == 3) {
        $imagen_fondo = "bci_edu_fin_gameboard3.png";
    } else if ($total_aprobados == 4) {
        $imagen_fondo = "bci_edu_fin_gameboard4.png";
    } else if ($total_aprobados == 5) {
        $imagen_fondo = "bci_edu_fin_gameboard5.png";
    } else if ($total_aprobados == 6) {
        $imagen_fondo = "bci_edu_fin_gameboard6.png";
    } else if ($total_aprobados == 7) {
        $imagen_fondo = "bci_edu_fin_gameboard7.png";
    } else if ($total_aprobados == 8) {
        $imagen_fondo = "bci_edu_fin_gameboard8.png";
    }
    //echo $imagen_fondo;
    $PRINCIPAL = str_replace("{IMAGEN_FONDO}", $imagen_fondo, $PRINCIPAL);
    $PRINCIPAL = str_replace("{CUADRO1}", $cuadro1, $PRINCIPAL);
    $PRINCIPAL = str_replace("{CUADRO2}", $cuadro2, $PRINCIPAL);
    $PRINCIPAL = str_replace("{CUADRO3}", $cuadro3, $PRINCIPAL);
    $PRINCIPAL = str_replace("{CUADRO4}", $cuadro4, $PRINCIPAL);
    return ($PRINCIPAL);
}
function EnviaCorreoGmailInscripciones($nombre_destinatario, $nombre_remitente, $id_empresa, $asunto, $template)
{
    $datos_destinatario = UsuarioEnBasePersonaPorEmpresa($destinatario, $id_empresa);
    $remitente          = UsuarioEnBasePersonaPorEmpresa($remitente, $id_empresa);
    $template           = str_replace("{NOMBRE_JEFE}", utf8_encode($nombre_destinatario), $template);
    $template           = str_replace("{NOMBRE_COLABORADOR}", utf8_encode($nombre_remitente), $template);
    $mail               = new PHPMailer;
    $mail->isSMTP(); //Enable SMTP debugging
    $mail->SMTPDebug   = 1;
    $mail->Debugoutput = 'error_log';
    $mail->Host        = "mail.ngd.cl";
    $mail->Port        = 25;
    $mail->SMTPAuth    = true;
    $mail->Username    = "soporte@ngd.cl";
    $mail->Password    = "N+N5TMTuS3=p";
    $mail->setFrom("soporte@ngd.cl", "CapacitacionBci");
    //$mail->addAddress($datos_destinatario[0]->email, $datos_destinatario[0]->nombre_completo);
    //$mail->addAddress("rod@gop.cl", $nombre_destinatario);
    $mail->addAddress("soporte@gop.cl", $nombre_destinatario);
    $mail->addAddress("daniel@gop.cl", $nombre_destinatario);
    //$mail->addAddress("rod@gop.cl", $datos_destinatario[0]->nombre_completo);
    //$mail->AddBCC("rod@gop.cl","BCC: ".$datos_destinatario[0]->nombre_completo);
    $mail->Subject = $asunto;
    $mail->msgHTML($template, dirname(__FILE__));
    $mail->AltBody = 'Si no puedes visualizar este correo ....';
    //send the message, check for errors
    if (!$mail->send()) {
        //echo "Mailer Error: " . $mail->ErrorInfo;
    } else {
        echo "Notificaci?n Enviada a " . $datos_destinatario[0]->email;
    }
}
function practicascompartidos($rut, $id_empresa)
{
    $arreglo_tips = Obtenerpracticascompartidos($rut, $id_empresa);
    //print_r($arreglo_tips);
    foreach ($arreglo_tips as $arreglo_tip) {
        $lista_tips .= "<div><blockquote><p>" . utf8_encode($arreglo_tip->tip) . "</p>
    <p>" . utf8_encode($arreglo_tip->masinfo) . "</p></blockquote></div><hr>";
    }
    return ($lista_tips);
}
function ColocaDatosEnPerfilV2($row, $rut, $id_empressa)
{
    $datos_mallapersona = buscamalla($rut, $id_empresa);
    $datos_mallapersona[0]->id_malla;
    $datos_malla        = DatosMalla($datos_mallapersona[0]->id_malla);
    //print_r($datos_malla);
    $datos_consolidados = TienePuntosConsolidadosPorMalla($rut, $id_empresa, $datos_mallapersona[0]->id_malla);
    $row                = str_replace("{PUNTOS}", $datos_consolidados[0]->puntos, $row);
    $promedio_trivias   = PromedioTrivias($rut, $id_empresa);
    if (!$promedio_trivias[0]->promedio_trivias) {
        $row = str_replace("{PROMEDIO}", "0", $row);
    } else {
        $row = str_replace("{PROMEDIO}", round($promedio_trivias[0]->promedio_trivias), $row);
    }
    if ($promedio_trivias[0]->promedio_trivias > 0) {
        $row = str_replace("{PODERES}", "<img src='img/61_rf_badges_5.png' width='20'>", $row);
    } else {
        $row = str_replace("{PODERES}", "", $row);
    }
    $medallas = "";
    for ($k = 1; $k <= $datos_consolidados[0]->medallas; $k++) {
        $medallas .= "<img src='img/rf_medal.png'> ";
    }
    //$row = str_replace("{MEDALLAS}",$datos_consolidados[0]->medallas,$row);
    $row = str_replace("{MEDALLAS}", $medallas, $row);
    return ($row);
}
function BloquecomentariosPorMP($id_mp, $id_empresa, $tipo)
{
    //Traigo el listado de planes por id mp
    $planes     = TotalPlanesPorMp($id_mp, $id_empresa);
    $i          = 1;
    $datos_ivph = TraeDatosMP2($id_mp, $id_empresa);
    foreach ($planes as $plan) {
        if ($tipo == "formulario") {
            $listado .= file_get_contents("views/mejorespracticas/" . $id_empresa . "_mp_row_plan.html");
        } else {
            if ($plan->evaluado == $_SESSION["user_"]) {
                if ($datos_ivph[0]->id_estado == 1) {
                    $listado .= file_get_contents("views/mejorespracticas/" . $id_empresa . "_mp_row_plan_seguimiento.html");
                } else {
                    $listado .= file_get_contents("views/mejorespracticas/" . $id_empresa . "_mp_row_plan_seguimiento_lectura.html");
                }
            } else {
                $listado .= file_get_contents("views/mejorespracticas/" . $id_empresa . "_mp_row_plan_seguimiento_lectura.html");
            }
            /*
             * elseif($plan->evaluado==$_SESSION["user_"]){
             $listado.=file_get_contents("views/mejorespracticas/".$id_empresa."_mp_row_plan_seguimiento_dueno_ivph.html");
             }else{
             $listado.=file_get_contents("views/mejorespracticas/".$id_empresa."_mp_row_plan_seguimiento_lectura.html");
             }
             *
             * */
        }
        $listado = str_replace("{NUMERO}", $i, $listado);
        if ($plan->seguimiento_grado_cumplimiento) {
            if ($plan->validado) {
                $listado = str_replace("{VALIDA}", file_get_contents("views/mejorespracticas/53_mp_row_plan_valida_dueno_ivph_validado.html"), $listado);
            } else {
                $listado = str_replace("{VALIDA}", file_get_contents("views/mejorespracticas/53_mp_row_plan_valida_dueno_ivph.html"), $listado);
            }
        } else {
            $listado = str_replace("{VALIDA}", "<center><img src='img/alert.png' alt='Pendiente' width='15'></center>", $listado);
        }
        $listado = str_replace("{CAUSA_RAIZ}", $plan->causa_raiz, $listado);
        $listado = str_replace("{PLAN}", $plan->plan, $listado);
        $listado = str_replace("{ID_PLAN}", $plan->id, $listado);
        $listado = str_replace("{ID_MP}", $id_mp, $listado);
        //$listado= str_replace("{RESPONSABLE}",$plan->responsable,$listado);
        $listado = str_replace("{RESPONSABLE}", utf8_encode($plan->nombre_completo), $listado);
        $listado = str_replace("{FECHA}", $plan->fecha, $listado);
        //$listado= str_replace("{ESTADO_SEGUIMIENTO}",$plan->seguimiento_grado_cumplimiento,$listado);
        if ($plan->seguimiento_grado_cumplimiento == "Abierto") {
            $estado_plan = '<span class="badgeAbierto badge-info">' . $plan->seguimiento_grado_cumplimiento . '</span>';
        } else if ($plan->seguimiento_grado_cumplimiento == "Cerrado") {
            $estado_plan = '<span class="badgeCerrado badge-info">' . $plan->seguimiento_grado_cumplimiento . '</span>';
        } else if ($plan->seguimiento_grado_cumplimiento == "Cancelado") {
            $estado_plan = '<span class="badgeCancelado badge-info">' . $plan->seguimiento_grado_cumplimiento . '</span>';
        } else if ($plan->seguimiento_grado_cumplimiento == "Stand By") {
            $estado_plan = '<span class="badgeStandBy badge-info">' . $plan->seguimiento_grado_cumplimiento . '</span>';
        }
        $listado = str_replace("{ESTADO_SEGUIMIENTO}", $estado_plan, $listado);
        $listado = str_replace("{SELECT_" . $plan->seguimiento_grado_cumplimiento . "}", "selected='selected'", $listado);
        $listado = str_replace("{SELECT_Abierto}", "", $listado);
        $listado = str_replace("{SELECT_Cerrado}", "", $listado);
        $listado = str_replace("{SELECT_Cancelado}", "", $listado);
        $listado = str_replace("{SELECT_Stand}", "", $listado);
        $i++;
    }
    return ($listado);
}
function ColocaBloqueEquipoMP($id_mp, $id_empresa)
{
    //Traigo el total de equipo por mp
    $equipo   = TotalEquipoPorMp($id_mp, $id_empresa);
    $i        = 1;
    $datos_mp = TraeDatosMP2($id_mp, $id_empresa);
    foreach ($equipo as $equ) {
        if ($datos_mp[0]->rut == $_SESSION["user_"]) {
            $listado .= file_get_contents("views/mejorespracticas/" . $id_empresa . "_mp_row_equipo.html");
        } else {
            $listado .= file_get_contents("views/mejorespracticas/" . $id_empresa . "_mp_row_equipo_lectura.html");
        }
        $listado = str_replace("{ID}", $equ->id, $listado);
        $listado = str_replace("{ID_MP}", $equ->id_mp, $listado);
        $listado = str_replace("{NUMERO}", $i, $listado);
        $listado = str_replace("{NOMBRE_COLABORADOR}", utf8_encode($equ->nombre_completo), $listado);
        $i++;
    }
    return ($listado);
}
function ColocaBloquePreguntaPorObjetoUnicaRadio($id_objeto, $rut, $tipo)
{
    $pregunta        = PreguntaDadoIdObjeto($id_objeto, $tipo);
    $tipo            = $pregunta[0]->tipo;
    $bloque_archivos = "";
    $tiene_respuesta = VerificaRespuestaPorPreguntaObjetoUsuario($id_objeto, $pregunta[0]->id, $rut);
    //si tiene respuesta
    if ($tiene_respuesta) {
        if ($tipo == 1) {
            $bloque_archivos = MuestraResultadosPreguntaPorObjeto($id_objeto, $pregunta[0]->id, $rut);
        } else if ($tipo == 2) {
            $bloque_archivos = MuestraResultadosPreguntaPorObjetoCheck($id_objeto, $pregunta[0]->id, $rut);
        } else if ($tipo == 3) {
            $bloque_archivos = MuestraResultadosPreguntaPorObjetoCheck($id_objeto, $pregunta[0]->id, $rut);
            //}else if($tipo==4){
        } else {
            $bloque_archivos = MuestraResultadosPreguntaPorObjeto4($id_objeto, $pregunta[0]->id, $rut);
        }
    } else {
        $bloque_archivos = file_get_contents("views/cursos/contenidos/entorno_bloque_pregunta" . $tipo . ".html");
        $bloque_archivos = str_replace("{PREGUNTA}", utf8_encode($pregunta[0]->pregunta), $bloque_archivos);
        $bloque_archivos = str_replace("{ID_PREGUNTA_ENCODEADA}", utf8_encode($pregunta[0]->id), $bloque_archivos);
        //Coloco las alternativas
        //$alternativas=AlternativasDadoGupoId($pregunta[0]->id_alternativas);
        $alternativas    = AlternativasDadoGupoId(1);
        foreach ($alternativas as $alt) {
            $alternativas_html .= file_get_contents("views/cursos/contenidos/row_alternativa_pregunta_objeto_radio.html");
            $alternativas_html = str_replace("{ALTERNATIVA}", $alt->alternativa, $alternativas_html);
            $alternativas_html = str_replace("{VALUE_CHECK}", $alt->id, $alternativas_html);
            $alternativas_html = str_replace("{NAME}", $pregunta[0]->id, $alternativas_html);
        }
        $bloque_archivos = str_replace("{TOTAL_ALTERNATIVAS}", count($alternativas), $bloque_archivos);
        $bloque_archivos = str_replace("{OPCIONES}", $alternativas_html, $bloque_archivos);
    }
    return ($bloque_archivos);
}
function EnviaCorreoGmail($destinatario, $remitente, $id_empresa, $asunto, $template)
{
    $datos_destinatario = UsuarioEnBasePersonaPorEmpresa($destinatario, $id_empresa);
    $remitente          = UsuarioEnBasePersonaPorEmpresa($remitente, $id_empresa);
    $template           = str_replace("{NOMBRE_JEFE}", utf8_encode($datos_destinatario[0]->nombre_completo), $template);
    $template           = str_replace("{NOMBRE_COLABORADOR}", utf8_encode($remitente[0]->nombre_completo), $template);
    $mail               = new PHPMailer;
    $mail->isSMTP(); //Enable SMTP debugging
    $mail->SMTPDebug   = 1;
    $mail->Debugoutput = 'error_log';
    $mail->Host        = "mail.ngd.cl";
    $mail->Port        = 25;
    $mail->SMTPAuth    = true;
    $mail->Username    = "soporte@ngd.cl";
    $mail->Password    = "N+N5TMTuS3=p";
    $mail->setFrom("soporte@ngd.cl", "CapacitacionBci");
    $mail->addAddress($datos_destinatario[0]->email, $datos_destinatario[0]->nombre_completo);
    //$mail->addAddress("rod@gop.cl", $datos_destinatario[0]->nombre_completo);
    $mail->AddBCC("rod@gop.cl", "BCC: " . $datos_destinatario[0]->nombre_completo);
    $mail->Subject = $asunto;
    $mail->msgHTML($template, dirname(__FILE__));
    $mail->AltBody = 'Si no puedes visualizar este correo ....';
    //send the message, check for errors
    if (!$mail->send()) {
        //echo "Mailer Error: " . $mail->ErrorInfo;
    } else {
        echo "Notificaci?n Enviada a " . $datos_destinatario[0]->email;
    }
}
function ColocaFijacion($PRINCIPAL, $evaluado, $evaluador, $id_proceso, $id_empresa)
{
    $cantidad                       = 6;
    $cantidad_obligatorio_objetivos = 3;
    for ($i = 1; $i <= $cantidad; $i++) {
        $tiene = TraigoObjetivoFijacion($evaluado, $evaluador, $id_proceso, $i, "objetivo");
        $total_objetivos .= file_get_contents("views/sgd/fijacion/" . $id_empresa . "_row_objetivos.html");
        $total_objetivos = str_replace("{NUM}", $i, $total_objetivos);
        $total_objetivos = str_replace("{VALUE_OBJETIVOS}", utf8_encode($tiene[0]->objetivo), $total_objetivos);
        $total_objetivos = str_replace("{VALUE_MEDICION_CUMPLIMIENTO}", utf8_encode($tiene[0]->medicion_cumplimiento), $total_objetivos);
        if ($i <= $cantidad_obligatorio_objetivos) {
            $total_objetivos = str_replace("{REQUIRED_OBLIGATORIO}", "required='required'", $total_objetivos);
        } else {
            $total_objetivos = str_replace("{REQUIRED_OBLIGATORIO}", "", $total_objetivos);
        }
    }
    $PRINCIPAL                 = str_replace("{ROW_INGRESO_OBJETIVOS}", $total_objetivos, $PRINCIPAL);
    $cantidad                  = 3;
    $cantidad_obligatorio_plan = 1;
    for ($i = 1; $i <= $cantidad; $i++) {
        $tiene = TraigoObjetivoFijacion($evaluado, $evaluador, $id_proceso, $i, "plan");
        $total_planes .= file_get_contents("views/sgd/fijacion/" . $id_empresa . "_row_plan.html");
        $total_planes = str_replace("{NUM}", $i, $total_planes);
        $total_planes = str_replace("{VALUE_AREA_DESARROLLO}", utf8_encode($tiene[0]->areas_desarrollo), $total_planes);
        $total_planes = str_replace("{VALUE_ACCIONES_REQUERIDAS}", utf8_encode($tiene[0]->acciones_requeridas), $total_planes);
        if ($i <= $cantidad_obligatorio_plan) {
            $total_planes = str_replace("{REQUIRED_OBLIGATORIO}", "required='required'", $total_planes);
        } else {
            $total_planes = str_replace("{REQUIRED_OBLIGATORIO}", "", $total_planes);
        }
    }
    $PRINCIPAL = str_replace("{ROW_INGRESO_PLANES}", $total_planes, $PRINCIPAL);
    $PRINCIPAL = str_replace("{EVALUADO_ENCODEADO}", Encodear3($evaluado), $PRINCIPAL);
    $PRINCIPAL = str_replace("{NUMERO_ENCODEADO}", Encodear3($cantidad), $PRINCIPAL);
    $PRINCIPAL = str_replace("{EVALUADOR_ENCODEADO}", Encodear3($evaluador), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ListadoColaboradoresFijacion($html, $evaluador, $rut_evaluado, $id_proceso)
{
    $id_empresa    = $_SESSION["id_empresa"];
    //$evaluados=EvaluadosDadoEvaluador($evaluador);
    $evaluados     = EvaluadosDadoEvaluadorPorProcesoSinAeParaFijacion($evaluador, $id_proceso);
    //Se muestran los objetivos individuales.
    $total_html    = file_get_contents("views/sgd/fijacion/" . $id_empresa . "_entorno_bloque_principal.html");
    $template_row  = file_get_contents("views/sgd/fijacion/" . $id_empresa . "_row_colaboradores.html");
    //Primero veo si es que hay registro en la tabla de sesion
    $row           = "";
    $ok_finalizado = 0;
    foreach ($evaluados as $evaluado) {
        $row .= $template_row;
        //$row=FormularioIngresaObjetivos($row, $evaluado->evaluado, $evaluador);
        $row = ColocaDatosUsuario($row, $evaluado->evaluado, "sinmensaje");
        //$valores_objetivos=ListadoObjetivosAValidar($evaluado->evaluado, $evaluador, $id_objetivo, "jefe");
        $row = str_replace("{RUT_ENCODEADO}", Encodear3($evaluado->evaluado), $row);
        $row = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($evaluado->evaluado), $row);
        $row = str_replace("{NUM_OBJETIVOS}", ($evaluado->total_objetivos), $row);
        $row = str_replace("{NUM_PLAN}", ($evaluado->total_planes), $row);
        if ($evaluado->finalizado_proceso) {
            $row = str_replace("{ICON_FINALIZADO}", "text-success_icon fas fa-check-square", $row);
        } else {
            $row = str_replace("{ICON_FINALIZADO}", "text-alert_icon icon-circle", $row);
        }
        //$total_planes=TraeDatosPorPlanes($evaluado->evaluado);
        $total_planes = TraeDatosPorPlanesPorProcesoPlan($evaluado->evaluado, $id_proceso_plan);
        //ACA veo si es que tiene comentarios de rechazo
    }
    $total_html = str_replace("{LISTADO_COLABORADORES}", ($row), $total_html);
    $html       = str_replace("{ENTORNO_LISTADO_COLABORADORES}", ($total_html), $html);
    return ($html);
}
function ColocaDesarrolloCarrera($PRINCIPAL, $evaluado, $id_proceso, $evaluador, $id_empresa, $equipo)
{
    //Traigo el listado de los intereses de desarrollo
    $intereses = totalInteresesDesarrollo($id_empresa);
    if ($equipo == "equipo") {
        $total_evaluados = TraeEvaluadosDadoEvaluadorPorProcesoSinAe($evaluador, $id_proceso);
        foreach ($total_evaluados as $eva) {
            //$check.="Evaluado ".$eva->nombre_completo."<br>";
            $check .= "<hr>";
            $check .= file_get_contents("views/sgd/informe/" . $id_empresa . "_tabla_superior_informe.html");
            $check  = ColocaDatosUsuarioSGD($check, $eva->rut, "", $evaluador, $id_proceso);
            $check  = str_replace("{TABLA_RESUMEN1}", "", $check);
            $titulo = "";
            foreach ($intereses as $int) {
                if ($int->agrupacion <> $titulo) {
                    $check .= "<br><b>" . $int->agrupacion . "</b><br><br>";
                }
                $titulo    = $int->agrupacion;
                $chequeado = 'checked="checked"';
                //Veo si este desarrollo de carrera esta o no esta para este evaluado evaluador proceso empresa id_Desarrollo_carrera
                $tiene     = TienedesarrolloCarrera($eva->rut, $evaluador, $id_proceso, $id_empresa, $int->id);
                if ($tiene) {
                    $check .= "<input type='checkbox' checked='checked'  name='" . $int->nombre . "_" . $eva->rut . "'>&nbsp;" . $int->interes . "<br>";
                } else {
                    $check .= "<input type='checkbox'  name='" . $int->nombre . "_" . $eva->rut . "'>&nbsp;" . $int->interes . "<br>";
                }
            }
            $check .= "<br><br>";
        }
        $PRINCIPAL = str_replace("{LISTADO_DESARROLLO_CARRERA}", utf8_encode($check), $PRINCIPAL);
        $PRINCIPAL = str_replace("{VALUE_EQUIPO}", "1", $PRINCIPAL);
    } else {
        $titulo = "";
        foreach ($intereses as $int) {
            if ($int->agrupacion <> $titulo) {
                $check .= "<br><b>" . $int->agrupacion . "</b><br><br>";
                //$check.=file_get_contents("views/sgd/evaluacion/66_entorno_interes_desarrollo.html");
                //$check= str_replace("{NOMBRE_AGRUPACION}",$int->agrupacion,$check);
                //$check_row="";
            }
            $titulo    = $int->agrupacion;
            $chequeado = 'checked="checked"';
            //Veo si este desarrollo de carrera esta o no esta para este evaluado evaluador proceso empresa id_Desarrollo_carrera
            $tiene     = TienedesarrolloCarrera($evaluado, $evaluador, $id_proceso, $id_empresa, $int->id);
            if ($tiene) {
                $check .= "<input type='checkbox' checked='checked'  name='" . $int->nombre . "'>&nbsp;" . $int->interes . "<br>";
            } else {
                $check .= "<input type='checkbox'  name='" . $int->nombre . "'>&nbsp;" . $int->interes . "<br>";
            }
            //$check_row.="<input type='checkbox'  name='".$int->nombre."'>&nbsp;".$int->interes."<br>";
            //$check= str_replace("{LISTADO_INTERESES_POR_AGRUPACION}",utf8_encode($check_row),$check);
        }
        $PRINCIPAL = str_replace("{LISTADO_DESARROLLO_CARRERA}", utf8_encode($check), $PRINCIPAL);
        $PRINCIPAL = str_replace("{VALUE_EQUIPO}", "0", $PRINCIPAL);
    }
    return ($PRINCIPAL);
}
function colocaGraficoPromedioPorDeterminantes($PRINCIPAL, $evaluador, $id_proceso, $evaluado)
{
    //$PRINCIPAL= str_replace("{ARREGLO_NOMBRE_DETERMINANTES}","'PUEDE','QUIERE','SABE'",$PRINCIPAL);
    //$PRINCIPAL = str_replace("{ARREGLO_VALORES_DETERMINANTES}","2.5,3,3.25",$PRINCIPAL);
    if ($evaluado && $evaluador) {
        $resultadosPorDeterminantes = ResultadosPromedioPorDeterminantes($evaluador, $id_proceso, $evaluado);
    } else {
        $resultadosPorDeterminantes = ResultadosPromedioPorDeterminantes($evaluador, $id_proceso);
    }
    foreach ($resultadosPorDeterminantes as $res) {
        $row_dete .= file_get_contents("views/sgd/informe/row_informe_determinante.html");
        $row_dete                = str_replace("{NOMBRE}", utf8_encode($res->sigla), $row_dete);
        $criterios_determinantes = ObtenerCriterioPuntajeMatrizNotaFinal($res->promedio_por_determinante, $evaluado, "", "comp", $evaluador, $id_proceso);
        $row_dete                = str_replace("{ESTILO_ETIQUETA}", $criterios_determinantes[2], $row_dete);
        $row_dete                = str_replace("{ICONO}", $criterios_determinantes[3], $row_dete);
        $row_dete                = str_replace("{CRITERIO}", $criterios_determinantes[0], $row_dete);
        $row_dete                = str_replace("{NOTA}", ColocaDecimalesNotasFinales(2, $res->promedio_por_determinante, $tipo) . "", $row_dete);
        $row_dete                = str_replace("{NOMBRE_AE}", utf8_encode($res->sigla), $row_dete);
        $criterios_determinantes = ObtenerCriterioPuntajeMatrizNotaFinal($res->nota_ae, $evaluado, "", "comp", $evaluador, $id_proceso);
        $row_dete                = str_replace("{ESTILO_ETIQUETA_AE}", $criterios_determinantes[2], $row_dete);
        $row_dete                = str_replace("{ICONO_AE}", $criterios_determinantes[3], $row_dete);
        $row_dete                = str_replace("{CRITERIO_AE}", $criterios_determinantes[0], $row_dete);
        $row_dete                = str_replace("{NOTA_AE}", ColocaDecimalesNotasFinales(2, $res->nota_ae, $tipo) . "", $row_dete);
        $arreglo_datos .= $res->promedio_por_determinante;
        $arreglo_siglas .= '"' . $res->sigla . '"';
        if ($i < count($resultadosPorDeterminantes)) {
            $arreglo_datos .= ", ";
            $arreglo_siglas .= ", ";
        }
        $i++;
    }
    $PRINCIPAL = str_replace("{ARREGLO_NOMBRE_DETERMINANTES}", $arreglo_siglas, $PRINCIPAL);
    $PRINCIPAL = str_replace("{ARREGLO_VALORES_DETERMINANTES}", $arreglo_datos, $PRINCIPAL);
    $PRINCIPAL = str_replace("{LISTADO_DETERMINANTES}", utf8_encode($row_dete), $PRINCIPAL);
    return ($PRINCIPAL);
}
function colocaGraficoPorPromediocompetencias($PRINCIPAL, $evaluador, $id_proceso)
{
    $promediocompetenciasPorEvaluador = ResultadosPromedioCompetenciasSGD($evaluador, $id_proceso);
    $i                                = 1;
    foreach ($promediocompetenciasPorEvaluador as $prom) {
        $arreglo_datos .= $prom->promedio_competencia;
        $arreglo_siglas .= '"' . $prom->sigla . '"';
        if ($i < count($promediocompetenciasPorEvaluador)) {
            $arreglo_datos .= ", ";
            $arreglo_siglas .= ", ";
        }
        $i++;
    }
    $PRINCIPAL = str_replace("{ETIQUETAS_GRAFICO_COMPETENCIAS}", $arreglo_siglas, $PRINCIPAL);
    $PRINCIPAL = str_replace("{ARREGLO_DATOS_GRAFICO_COMPETENCIAS}", $arreglo_datos, $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaBotonera3($PRINCIPAL, $id_proceso, $rut)
{
    $id_empresa                = $_SESSION["id_empresa"];
    $datos_usuario_sesion      = UsuarioEnBasePersonaPorEmpresa($rut, $id_empresa);
    //Veo si realizo su AUtevaluacion
    $finalizada_AE             = FinalizadoEvaluadoEvaluadorProProceso($rut, $rut, $id_proceso);
    //Veo si este usuario para este proceso, tiene evaluados, si es asi,
    $tiene_evaluados           = TraeRelacionesSinAe($rut, $id_proceso);
    $todos_los_evaluados_sinAE = TraeRelacionesSinAeTODOS($rut, $id_proceso);
    $tiene_evaluadosDO         = TraeRelacionesSinAeDO($rut, $id_proceso);
    $total_finalizados_sin_ae  = FinalizadoEvaluadorPorProcesoSinAe($rut, $id_proceso);
    if (count($tiene_evaluados) == 0 && count($tiene_evaluadosDO) > 0) {
        $PRINCIPAL = str_replace("{BOTONERA3}", file_get_contents("views/sgd/botonera3/" . $id_empresa . "_botonera3_evaluaequipoDO.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{URL_EVALUACION_EQUIPO}", "?sw={ENVIRONMENT_EQUIPO}&ip={ID_PROCESO_ENCODEADO}", $PRINCIPAL);
    } else {
        if ($datos_usuario_sesion[0]->perfil_evaluacion == "DO") {
            if (count($tiene_evaluados) > 0) {
                $PRINCIPAL = str_replace("{BOTONERA3}", file_get_contents("views/sgd/botonera3/" . $id_empresa . "_botonera3_evaluaequipo.html"), $PRINCIPAL);
            } else {
                $PRINCIPAL = str_replace("{BOTONERA3}", file_get_contents("views/sgd/botonera3/" . $id_empresa . "_botonera3_DO.html"), $PRINCIPAL);
            }
        } else {
            if ($tiene_evaluados) {
                //$PRINCIPAL= str_replace("{BOTONERA3}",file_get_contents("views/sgd/botonera3/".$id_empresa."_botonera3.html"),$PRINCIPAL);
                $datos_evaluador = UsuarioEnBasePersonaPorEmpresa($rut, $id_empresa);
                if ($datos_evaluador[0]->perfil_evaluacion == "SoloEvaluaEquipo") {
                    $PRINCIPAL = str_replace("{BOTONERA3}", file_get_contents("views/sgd/botonera3/" . $id_empresa . "_botonera3_evaluaequipo.html"), $PRINCIPAL);
                    $PRINCIPAL = str_replace("{URL_EVALUACION_EQUIPO}", "?sw={ENVIRONMENT_EQUIPO}&ip={ID_PROCESO_ENCODEADO}", $PRINCIPAL);
                } else {
                    $PRINCIPAL = str_replace("{BOTONERA3}", file_get_contents("views/sgd/botonera3/" . $id_empresa . "_botonera3.html"), $PRINCIPAL);
                }
            } else {
                $PRINCIPAL = str_replace("{BOTONERA3}", file_get_contents("views/sgd/botonera3/" . $id_empresa . "_botonera3_ae.html"), $PRINCIPAL);
            }
        }
    }
    if ($finalizada_AE) {
        $PRINCIPAL = str_replace("{URL_EVALUACION_EQUIPO}", "?sw={ENVIRONMENT_EQUIPO}&ip={ID_PROCESO_ENCODEADO}", $PRINCIPAL);
        $PRINCIPAL = str_replace("{CLASE_AE}", "button-green", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ICONO_AE}", "fas fa-check-square", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ICONO_EV_DESC}", "icon-chevron-sign-right", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ENVIRONMENT_AE}", "inf", $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{URL_EVALUACION_EQUIPO}", "?sw={ENVIRONMENT_EQUIPO}&ip={ID_PROCESO_ENCODEADO}", $PRINCIPAL);
        //$PRINCIPAL= str_replace("{URL_EVALUACION_EQUIPO}","#",$PRINCIPAL);
        $PRINCIPAL = str_replace("{CLASE_AE}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ICONO_AE}", "icon-chevron-sign-right", $PRINCIPAL);
        $tiene_ae  = SGD_ExisteAe($evaluado, $id_proceso, $id_empresa);
        if ($tiene_ae) {
            $PRINCIPAL = str_replace("{CLASE_EVAL_DESC}", "button-leaf", $PRINCIPAL);
        }
        $PRINCIPAL = str_replace("{ICONO_EV_DESC}", "icon-minus", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ENVIRONMENT_AE}", "evind", $PRINCIPAL);
    }
    if (count($tiene_evaluados) == count($total_finalizados_sin_ae)) {
        $PRINCIPAL                       = str_replace("{CLASE_EVAL_DESC}", "button-green", $PRINCIPAL);
        $PRINCIPAL                       = str_replace("{ENVIRONMENT_EQUIPO}", "sgd2", $PRINCIPAL);
        //aca verifico cuantos finalizados tiene el evaluador
        $total_finalizados_por_evaluador = FinalizadoFijacionEvaluador($rut, $id_proceso);
        //echo count($total_finalizados_por_evaluador);echo "<br>";
        //echo count($todos_los_evaluados_sinAE);
        //if(count($total_finalizados_por_evaluador)==count($tiene_evaluados)){
        if (count($total_finalizados_por_evaluador) == count($todos_los_evaluados_sinAE)) {
            $PRINCIPAL = str_replace("{ESTILO_FIJACION}", "button-green", $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{ESTILO_FIJACION}", "", $PRINCIPAL);
        }
    } else {
        //$PRINCIPAL= str_replace("{ENVIRONMENT_EQUIPO}","ev",$PRINCIPAL);
        $PRINCIPAL = str_replace("{ENVIRONMENT_EQUIPO}", "sgd2", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ESTILO_FIJACION}", "rounded button-leaf", $PRINCIPAL);
        //exit("1");
        $PRINCIPAL = str_replace("{BON_INFORME_FINAL}", file_get_contents("views/sgd/botonera3/" . $id_empresa . "_boton_ve_informe_final_desactivado.html"), $PRINCIPAL);
    }
    //Aca verifico para el Boton Informe final
    $finalizado_full = COMPASS_VerificoParaInformeFinal($rut, $id_proceso, $id_empresa);
    if ($datos_usuario_sesion[0]->perfil_evaluacion == "DO") {
        if (count($finalizada_AE) >= 0 && $finalizado_full[0]->total_fijacion_objetivos >= 1 && $finalizado_full[0]->total_fijacion_planes >= 1) {
            //echo ".";
            $PRINCIPAL = str_replace("{BON_INFORME_FINAL}", file_get_contents("views/sgd/botonera3/" . $id_empresa . "_boton_ve_informe_final.html"), $PRINCIPAL);
        } else {
            //echo "..";
            $PRINCIPAL = str_replace("{BON_INFORME_FINAL}", file_get_contents("views/sgd/botonera3/" . $id_empresa . "_boton_ve_informe_final_desactivado.html"), $PRINCIPAL);
        }
    } else {
        //echo count($finalizada_AE)." ".$finalizado_full[0]->fecha." ".$finalizado_full[0]->total_fijacion_objetivos." ".$finalizado_full[0]->total_fijacion_planes;
        if (count($finalizada_AE) >= 0 && $finalizado_full[0]->fecha && $finalizado_full[0]->total_fijacion_objetivos >= 1 && $finalizado_full[0]->total_fijacion_planes >= 1) {
            //echo "...";
            $PRINCIPAL = str_replace("{BON_INFORME_FINAL}", file_get_contents("views/sgd/botonera3/" . $id_empresa . "_boton_ve_informe_final.html"), $PRINCIPAL);
        } else {
            //echo "....";
            //exit("1");
            $PRINCIPAL = str_replace("{BON_INFORME_FINAL}", file_get_contents("views/sgd/botonera3/" . $id_empresa . "_boton_ve_informe_final_desactivado.html"), $PRINCIPAL);
        }
    }
    $PRINCIPAL = str_replace("{ID_PROCESO_ENCODEADO}", Encodear3($id_proceso), $PRINCIPAL);
    $PRINCIPAL = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($rut), $PRINCIPAL);
    $PRINCIPAL = str_replace("{RUT_EVALUADOR_ENCODEADO}", Encodear3($rut), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ID_EMPRESA_ENCODEADO}", Encodear3($id_empresa), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocarRankingPorCampos($PRINCIPAL, $id_empresa, $rut, $c1, $c2, $c3)
{
    $datos_empresa          = DatosEmpresa($id_empresa);
    //Campo1
    $datos_usuario_campo123 = UsuarioEnBaseDePersonasInnerEmpresa($rut);
    if ($c1) {
        $datos = Datos_tbl_lms_ranking($id_empresa, "c1");
        if ($datos) {
            $i = 1;
            $total .= file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_ranking_grupal_titulo.html");
            $total = str_replace("{NOMBRE_CRITERIO}", $datos_empresa[0]->campo1, $total);
            foreach ($datos as $uni) {
                $total .= file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_ranking_grupal.html");
                $total = str_replace("{RANK}", $i, $total);
                if ($datos_usuario_campo123[0]->{$datos_usuario_campo123[0]->campo1} == $uni->valor_campo) {
                    $total = str_replace("{CLASE_COMOVOY}", "lms_miranking", $total);
                } else {
                    $total = str_replace("{CLASE_COMOVOY}", "", $total);
                }
                $total = str_replace("{NOMBRE}", $uni->criterio, $total);
                $total = str_replace("{PUNTOS}", $uni->suma_puntos, $total);
                $total = str_replace("{MEDALLAS}", $uni->medallas, $total);
                $total = str_replace("{AVANCE}", number_format($uni->avance, 1, ",", "."), $total);
                $i++;
            }
        }
    }
    //Traigo los datos por C1
    //$datos=GAMIFICACION_TodosLosConsolidadosPorCampoEmpresa($id_empresa, $datos_empresa[0]->campo3);
    if ($c2) {
        $datos = Datos_tbl_lms_ranking($id_empresa, "c2");
        if ($datos) {
            $i = 1;
            $total .= file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_ranking_grupal_titulo.html");
            $total = str_replace("{NOMBRE_CRITERIO}", $datos_empresa[0]->campo2, $total);
            foreach ($datos as $uni) {
                $total .= file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_ranking_grupal.html");
                $total = str_replace("{RANK}", $i, $total);
                if ($datos_usuario_campo123[0]->{$datos_usuario_campo123[0]->campo2} == $uni->valor_campo) {
                    $total = str_replace("{CLASE_COMOVOY}", "lms_miranking", $total);
                } else {
                    $total = str_replace("{CLASE_COMOVOY}", "", $total);
                }
                $total = str_replace("{NOMBRE}", $uni->criterio, $total);
                $total = str_replace("{PUNTOS}", $uni->suma_puntos, $total);
                $total = str_replace("{MEDALLAS}", $uni->medallas, $total);
                $total = str_replace("{AVANCE}", number_format($uni->avance, 1, ",", "."), $total);
                $i++;
            }
        }
    }
    if ($c3) {
        $datos = Datos_tbl_lms_ranking($id_empresa, "c3");
        if ($datos) {
            $i = 1;
            $total .= file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_ranking_grupal_titulo.html");
            $total = str_replace("{NOMBRE_CRITERIO}", $datos_empresa[0]->campo3, $total);
            foreach ($datos as $uni) {
                $total .= file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_ranking_grupal.html");
                $total = str_replace("{RANK}", $i, $total);
                if ($datos_usuario_campo123[0]->{$datos_usuario_campo123[0]->campo3} == $uni->valor_campo) {
                    $total = str_replace("{CLASE_COMOVOY}", "lms_miranking", $total);
                } else {
                    $total = str_replace("{CLASE_COMOVOY}", "", $total);
                }
                $total = str_replace("{NOMBRE}", $uni->criterio, $total);
                $total = str_replace("{PUNTOS}", $uni->suma_puntos, $total);
                $total = str_replace("{MEDALLAS}", $uni->medallas, $total);
                $total = str_replace("{AVANCE}", number_format($uni->avance, 1, ",", "."), $total);
                $i++;
            }
        }
    }
    $PRINCIPAL = str_replace("{ROW_RANKING}", utf8_encode($total), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaPreguntasorDesafio($id_desafio, $rut, $id_objeto, $id_curso, $id_desafio, $id_empresa)
{
    $preguntas          = TraigoPreguntasPorDesafio($id_desafio, $rut, $id_objeto, $id_curso, $id_desafio, $id_empresa);
    $total_preguntas    = "";
    $usuario_finalizado = TieneAccionesPEndientes($rut, $id_empresa, $id_curso, $id_objeto);
    $titulo_dimension   = "";
    $datos_desafio      = TraeDatosDesafioDadoId($id_desafio);
    $contador_colspan   = 0;
    foreach ($preguntas as $preg) {
        if ($titulo_dimension <> $preg->dimension) {
            if ($preg->tipo_dimension == 1) {
                if ($datos_desafio[0]->colspan) {
                    $contador_colspan = $contador_colspan + $datos_desafio[0]->colspan;
                }
                $total_preguntas .= file_get_contents("views/cursos/objetos/desafio/row_titulo_dimension_1.html");
            } else {
                $total_preguntas .= file_get_contents("views/cursos/objetos/desafio/row_titulo_dimension.html");
            }
            $total_preguntas  = str_replace("{NOMBRE_DIMENSION}", $preg->dimension, $total_preguntas);
            $titulo_dimension = $preg->dimension;
        } else {
            $titulo_dimension = $preg->dimension;
        }
        if ($usuario_finalizado) {
            if ($_GET["edidesa"] == 1) {
                if ($preg->solo_lectura == 1) {
                    if ($datos_desafio[0]->colspan) {
                        $contador_colspan = $contador_colspan + $datos_desafio[0]->colspan;
                        $total_preguntas .= file_get_contents("views/cursos/objetos/desafio/" . $preg->template . "_lectura.html");
                        //echo "1";
                    } else {
                        $total_preguntas .= file_get_contents("views/cursos/objetos/desafio/" . $preg->template . "_lectura_estatico.html");
                        //echo "2";
                    }
                } else {
                    if ($datos_desafio[0]->colspan) {
                        $contador_colspan = $contador_colspan + $datos_desafio[0]->colspan;
                        $total_preguntas .= file_get_contents("views/cursos/objetos/desafio/" . $preg->template . ".html");
                        //echo "3";
                    } else {
                        $total_preguntas .= file_get_contents("views/cursos/objetos/desafio/" . $preg->template . "_estatico.html");
                        //echo "4";
                    }
                }
            } else {
                if ($datos_desafio[0]->colspan) {
                    $contador_colspan = $contador_colspan + $datos_desafio[0]->colspan;
                    $total_preguntas .= file_get_contents("views/cursos/objetos/desafio/" . $preg->template . "_lectura.html");
                    //echo "5";
                } else {
                    if ($datos_desafio[0]->id_objeto) {
                        //echo "views/cursos/objetos/desafio/".$preg->template."_lectura_estatico_".$datos_desafio[0]->id_objeto.".html";
                        $total_preguntas .= file_get_contents("views/cursos/objetos/desafio/" . $preg->template . "_lectura_estatico_" . $datos_desafio[0]->id_objeto . ".html");
                    } else {
                        $total_preguntas .= file_get_contents("views/cursos/objetos/desafio/" . $preg->template . "_lectura_estatico.html");
                    }
                    //echo "6";
                }
            }
        } else {
            if ($preg->solo_lectura == 1) {
                if ($datos_desafio[0]->colspan) {
                    $contador_colspan = $contador_colspan + $datos_desafio[0]->colspan;
                    //echo "7";
                    $total_preguntas .= file_get_contents("views/cursos/objetos/desafio/" . $preg->template . "_lectura.html");
                } else {
                    //echo "8";
                    $total_preguntas .= file_get_contents("views/cursos/objetos/desafio/" . $preg->template . "_lectura_estatico.html");
                }
            } else {
                if ($datos_desafio[0]->colspan) {
                    $contador_colspan = $contador_colspan + $datos_desafio[0]->colspan;
                    $total_preguntas .= file_get_contents("views/cursos/objetos/desafio/" . $preg->template . ".html");
                    //echo "9";
                } else {
                    //echo "10";
                    $total_preguntas .= file_get_contents("views/cursos/objetos/desafio/" . $preg->template . "_estatico.html");
                }
            }
        }
        if ($preg->tabla_select) {
            $datos_select = SelectAsterisco($preg->tabla_select);
            $options      = "";
            if ($preg->tabla_select == "tbl_usuario") {
                foreach ($datos_select as $sel) {
                    if ($preg->respuesta == $sel->rut) {
                        $options .= "<option selected='selected' value='" . ($sel->rut) . "'>" . ($sel->nombre_completo) . "</option>";
                    } else {
                        $options .= "<option value='" . ($sel->rut) . "'>" . ($sel->nombre_completo) . "</option>";
                    }
                }
            } else {
                foreach ($datos_select as $sel) {
                    if ($preg->respuesta == $sel->valor) {
                        $options .= "<option selected='selected' value='" . ($sel->valor) . "'>" . ($sel->valor) . "</option>";
                    } else {
                        $options .= "<option value='" . ($sel->valor) . "'>" . ($sel->valor) . "</option>";
                    }
                }
            }
        }
        $total_preguntas = str_replace("{OPTIONS_SELECT_DINAMICO}", $options, $total_preguntas);
        $total_preguntas = str_replace("{ID}", $preg->id, $total_preguntas);
        //$total_preguntas = str_replace("{ID_CHECKBOX}",$preg->nombre_checkbox,$total_preguntas);
        if ($preg->muestra_pregunta == 1) {
            $total_preguntas = str_replace("{PREGUNTA}", "&nbsp;", $total_preguntas);
        } else {
            $total_preguntas = str_replace("{PREGUNTA}", $preg->pregunta, $total_preguntas);
        }
        if ($preg->id_pregunta_asociada) {
            //Traigo la respuesta de este usuario de esta pregunta asociada
            $respuestas_preguntas_asociadas = VerificoPReguntaDesafio($rut, $preg->id_pregunta_asociada, $preg->id_objeto_asociado, $preg->id_curso_asociado, $id_empresa, $preg->id_desafio_asociado);
            $total_preguntas                = str_replace("{VALUE}", $respuestas_preguntas_asociadas[0]->respuesta, $total_preguntas);
        } else {
            $total_preguntas = str_replace("{VALUE}", $preg->respuesta, $total_preguntas);
        }
        //$total_preguntas = str_replace("{VALUE_CHECKBOX}",$preg->id,$total_preguntas);
        if ($preg->respuesta) {
            $total_preguntas = str_replace("{CHEQUEADO}", 'checked="checked"', $total_preguntas);
        } else {
            $total_preguntas = str_replace("{CHEQUEADO}", "", $total_preguntas);
        }
        if ($preg->obligatorio == "no") {
            $total_preguntas = str_replace("{REQUIRED}", "", $total_preguntas);
        } else {
            $total_preguntas = str_replace("{REQUIRED}", 'required="required"', $total_preguntas);
        }
        if ($preg->respuesta) {
            $total_preguntas = str_replace("{BLOQUE_VER_DOCUMENTO}", file_get_contents("views/cursos/objetos/desafio/row_bloque_file_ve.html"), $total_preguntas);
        } else {
            $total_preguntas = str_replace("{BLOQUE_VER_DOCUMENTO}", "", $total_preguntas);
        }
        $total_preguntas = str_replace("{URL_ARCHIVO}", "objetos/" . $id_curso . "/" . $id_objeto . "/" . $preg->respuesta, $total_preguntas);
        if ($datos_desafio[0]->colspan) {
            $total_preguntas = str_replace("{ROW1}", "0", $total_preguntas);
            $total_preguntas = str_replace("{ROW2}", $datos_desafio[0]->colspan, $total_preguntas);
        } else {
            $total_preguntas = str_replace("{ROW1}", "1", $total_preguntas);
            $total_preguntas = str_replace("{ROW2}", "10", $total_preguntas);
        }
        $total_preguntas = str_replace("{VALUE_DESDE_BASE}", $preg->respuesta_desde_base, $total_preguntas);
        if ($contador_colspan == 12) {
            $total_preguntas .= "<br>";
            $contador_colspan = 0;
        }
    }
    return (utf8_encode($total_preguntas));
}
function ColocaPreguntasorDesafioBK($id_desafio, $rut, $id_objeto, $id_curso, $id_desafio, $id_empresa)
{
    $preguntas          = TraigoPreguntasPorDesafio($id_desafio, $rut, $id_objeto, $id_curso, $id_desafio, $id_empresa);
    $total_preguntas    = "";
    $usuario_finalizado = TieneAccionesPEndientes($rut, $id_empresa, $id_curso, $id_objeto);
    $titulo_dimension   = "";
    $datos_desafio      = TraeDatosDesafioDadoId($id_desafio);
    foreach ($preguntas as $preg) {
        if ($titulo_dimension <> $preg->dimension) {
            $total_preguntas .= file_get_contents("views/cursos/objetos/desafio/row_titulo_dimension.html");
            $total_preguntas  = str_replace("{NOMBRE_DIMENSION}", $preg->dimension, $total_preguntas);
            $titulo_dimension = $preg->dimension;
        } else {
            $titulo_dimension = $preg->dimension;
        }
        if ($usuario_finalizado) {
            $total_preguntas .= file_get_contents("views/cursos/objetos/desafio/" . $preg->template . "_lectura.html");
        } else {
            $total_preguntas .= file_get_contents("views/cursos/objetos/desafio/" . $preg->template . ".html");
        }
        if ($preg->tabla_select) {
            $datos_select = SelectAsterisco($preg->tabla_select);
            $options      = "";
            foreach ($datos_select as $sel) {
                if ($preg->respuesta == $sel->valor) {
                    $options .= "<option selected='selected' value='" . ($sel->valor) . "'>" . ($sel->valor) . "</option>";
                } else {
                    $options .= "<option value='" . ($sel->valor) . "'>" . ($sel->valor) . "</option>";
                }
            }
        }
        $total_preguntas = str_replace("{OPTIONS_SELECT_DINAMICO}", $options, $total_preguntas);
        $total_preguntas = str_replace("{ID}", $preg->id, $total_preguntas);
        $total_preguntas = str_replace("{PREGUNTA}", $preg->pregunta, $total_preguntas);
        $total_preguntas = str_replace("{VALUE}", $preg->respuesta, $total_preguntas);
        if ($preg->obligatorio == "no") {
            $total_preguntas = str_replace("{REQUIRED}", "", $total_preguntas);
        } else {
            $total_preguntas = str_replace("{REQUIRED}", 'required="required"', $total_preguntas);
        }
        if ($preg->respuesta) {
            $total_preguntas = str_replace("{BLOQUE_VER_DOCUMENTO}", file_get_contents("views/cursos/objetos/desafio/row_bloque_file_ve.html"), $total_preguntas);
        } else {
            $total_preguntas = str_replace("{BLOQUE_VER_DOCUMENTO}", "", $total_preguntas);
        }
        $total_preguntas = str_replace("{URL_ARCHIVO}", "objetos/" . $id_curso . "/" . $id_objeto . "/" . $preg->respuesta, $total_preguntas);
        if ($datos_desafio[0]->colspan) {
            $total_preguntas = str_replace("{ROW1}", "0", $total_preguntas);
            $total_preguntas = str_replace("{ROW2}", $datos_desafio[0]->colspan, $total_preguntas);
        } else {
            $total_preguntas = str_replace("{ROW1}", "1", $total_preguntas);
            $total_preguntas = str_replace("{ROW2}", "10", $total_preguntas);
        }
    }
    return (utf8_encode($total_preguntas));
}
function ColocarRankingPorCamposBK($PRINCIPAL, $id_empresa, $rut)
{
    $datos_empresa          = DatosEmpresa($id_empresa);
    //Campo1
    $datos_usuario_campo123 = UsuarioEnBaseDePersonasInnerEmpresa($rut);
    $datos                  = GAMIFICACION_TodosLosConsolidadosPorCampoEmpresa($id_empresa, $datos_empresa[0]->campo1);
    if ($datos) {
        $i     = 1;
        $total = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_ranking_grupal_titulo.html");
        $total = str_replace("{NOMBRE_CRITERIO}", $datos_empresa[0]->campo1, $total);
        foreach ($datos as $uni) {
            $total .= file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_ranking_grupal.html");
            $total = str_replace("{RANK}", $i, $total);
            if ($datos_usuario_campo123[0]->{$datos_usuario_campo123[0]->campo1} == $uni->valor_campo) {
                $total = str_replace("{CLASE_COMOVOY}", "lms_miranking", $total);
            } else {
                $total = str_replace("{CLASE_COMOVOY}", "", $total);
            }
            $total = str_replace("{NOMBRE}", $uni->valor_campo, $total);
            $total = str_replace("{PUNTOS}", $uni->suma_puntos, $total);
            $total = str_replace("{MEDALLAS}", $uni->suma_medallas, $total);
            $i++;
        }
    }
    $datos = GAMIFICACION_TodosLosConsolidadosPorCampoEmpresa($id_empresa, $datos_empresa[0]->campo2);
    if ($datos) {
        $i = 1;
        $total .= file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_ranking_grupal_titulo.html");
        $total = str_replace("{NOMBRE_CRITERIO}", $datos_empresa[0]->campo2, $total);
        foreach ($datos as $uni) {
            $total .= file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_ranking_grupal.html");
            $total = str_replace("{RANK}", $i, $total);
            if ($datos_usuario_campo123[0]->{$datos_usuario_campo123[0]->campo2} == $uni->valor_campo) {
                $total = str_replace("{CLASE_COMOVOY}", "lms_miranking", $total);
            } else {
                $total = str_replace("{CLASE_COMOVOY}", "", $total);
            }
            $total = str_replace("{NOMBRE}", $uni->valor_campo, $total);
            $total = str_replace("{PUNTOS}", $uni->suma_puntos, $total);
            $total = str_replace("{MEDALLAS}", $uni->suma_medallas, $total);
            $i++;
        }
    }
    $datos = GAMIFICACION_TodosLosConsolidadosPorCampoEmpresa($id_empresa, $datos_empresa[0]->campo3);
    if ($datos) {
        $i = 1;
        $total .= file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_ranking_grupal_titulo.html");
        $total = str_replace("{NOMBRE_CRITERIO}", $datos_empresa[0]->campo3, $total);
        foreach ($datos as $uni) {
            $total .= file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_ranking_grupal.html");
            $total = str_replace("{RANK}", $i, $total);
            if ($datos_usuario_campo123[0]->{$datos_usuario_campo123[0]->campo3} == $uni->valor_campo) {
                $total = str_replace("{CLASE_COMOVOY}", "lms_miranking", $total);
            } else {
                $total = str_replace("{CLASE_COMOVOY}", "", $total);
            }
            $total = str_replace("{NOMBRE}", $uni->valor_campo, $total);
            $total = str_replace("{PUNTOS}", $uni->suma_puntos, $total);
            $total = str_replace("{MEDALLAS}", $uni->suma_medallas, $total);
            $i++;
        }
    }
    $PRINCIPAL = str_replace("{ROW_RANKING}", utf8_encode($total), $PRINCIPAL);
    return ($PRINCIPAL);
}
function EnviaCorreoMovilidadInterna($mensaje)
{
    //print_r($datos_destinatario);exit;
    $mail = new PHPMailer;
    //Tell PHPMailer to use SMTP
    $mail->isSMTP(); //Enable SMTP debugging
    // 0 = off (for production use)
    // 1 = client messages
    // 2 = client and server messages
    $mail->SMTPDebug   = 1;
    //Ask for HTML-friendly debug output
    $mail->Debugoutput = 'error_log';
    //Set the hostname of the mail server
    //$mail->Host = $datos_empresa[0]->server;
    $mail->Host        = "10.44.160.8";
    //Set the SMTP port number - likely to be 25, 465 or 587
    $mail->Port        = 25;
    //Whether to use SMTP authentication
    $mail->SMTPAuth    = true;
    //Username to use for SMTP authentication
    //$mail->Username = $datos_empresa[0]->envio_correos;
    $mail->Username    = "info-intranet@tntchile.cl";
    //Password to use for SMTP authentication
    //$mail->Password = $datos_empresa[0]->envio_correos_pass;
    $mail->Password    = "1ntr4n3t.tnt";
    //Set who the message is to be sent from
    //$mail->setFrom($datos_empresa[0]->envio_correos, $datos_empresa[0]->envio_correos);
    $mail->setFrom("info-intranet@tntchile.cl", "TNT Informaciones");
    //Set an alternative reply-to address
    //$mail->addReplyTo('replyto@example.com', 'First Last');
    //Set who the message is to be sent to
    //$mail->addAddress($datos_destinatario[0]->email, $datos_destinatario[0]->nombre_completo);
    $mail->addAddress("daniel@gop.cl", $datos_destinatario[0]->nombre_completo);
    $mail->addAddress("paula.brino@tntlit.cl", $datos_destinatario[0]->nombre_completo);
    //$mail->addAddress("rod@gop.cl", $datos_destinatario[0]->nombre_completo);
    $mail->AddBCC("backup@sgd.cl", "BCC: " . $datos_destinatario[0]->nombre_completo);
    //Set the subject line
    $mail->Subject = "Nueva Postulaci?n Movimiento Interno Plataforma TNT";
    //Read an HTML message body from an external file, convert referenced images to embedded,
    //convert HTML into a basic plain-text alternative body
    $mail->msgHTML($mensaje, dirname(__FILE__));
    //Replace the plain text body with one created manually
    $mail->AltBody = 'Si no puedes visualizar este correo ....';
    //Attach an image file
    //$mail->addAttachment('images/phpmailer_mini.png');
    //send the message, check for errors
    if (!$mail->send()) {
        //echo "Mailer Error: " . $mail->ErrorInfo;
    } else {
        //echo "Message sent!";
    }
    //exit;
}
function ColocaDatosAccionesClaves($id_objeto, $id_curso, $id_empresa, $rut, $PRINCIPAL)
{
    $datos_acciones_pendientes = TieneAccionesPEndientes($rut, $id_empresa, $id_curso, $id_objeto);
    $PRINCIPAL                 = str_replace("{COMENTARIO_TAREA}", utf8_encode($datos_acciones_pendientes[0]->comentario), $PRINCIPAL);
    $PRINCIPAL                 = str_replace("{LINK_DESCARGA_TAREA}", "objetos/$id_curso/$id_objeto/tareas/" . $datos_acciones_pendientes[0]->nombre_documento, $PRINCIPAL);
    return ($PRINCIPAL);
}
function LMS_ConsultaRutSegunEmail($email, $id_empresa)
{
    $arrayKey = LMS_ConsultaRutSegunEmail_data($email, $id_empresa);
    //print_r($arrayKey);
    $key      = $arrayKey[0]->rut;
    //echo "<br><br>key $key";
    //exit();
    return $key;
}
function ConsultaWebServiceDatosUsuario($correo_consulta, $nombre, $apellido, $imagenUrl, $id_empresa)
{
    $link_webservice  = "https://script.google.com/macros/s/AKfycbxhJ-9Roy2hZ934WLg-KcgkKMagUrvNxAsaOfi8oUHUFyxByVY/exec?action=getinfo&email=" . $correo_consulta . "";
    //$link_webservice="https://script.google.com/macros/s/AKfycbxhJ-9Roy2hZ934WLg-KcgkKMagUrvNxAsaOfi8oUHUFyxByVY/exec?action=getinfo&email=karen.montesinos@bci.cl";
    $JsonSource       = $link_webservice;
    $json             = json_decode(file_get_contents($JsonSource));
    $rut              = $json->customSchemas->datosbci->RUT;
    $cargo            = $json->customSchemas->datosbci->Cargo;
    $gerenciaR2       = $json->customSchemas->datosbci->Banca;
    $gerenciaR3       = $json->customSchemas->datosbci->Unidad;
    $gerencia         = $json->customSchemas->datosbci->Gerencias;
    $ola              = $json->customSchemas->datosbci->OLA;
    $jefe             = $json->customSchemas->datosbci->RUT_jefe;
    $email            = $correo_consulta;
    //ACTUALIZA BASE DE PERSONAS
    $WS_existeusuario = WS_existeusuariodata($rut, $id_empresa);
    if (count($WS_existeusuario) >= 1) {
        WS_actualizadatos($rut, $nombre, $apellido, $imagenUrl, $cargo, $gerenciaR2, $gerenciaR3, $gerencia, $ola, $jefe, $email, $id_empresa, "actualiza");
    } else {
        WS_actualizadatos($rut, $nombre, $apellido, $imagenUrl, $cargo, $gerenciaR2, $gerenciaR3, $gerencia, $ola, $jefe, $email, $id_empresa, "inserta");
    }
    //ACTUALIZA MALLA SEGUN OLA //SOLO BCI EMPRESA 59 GOOGLE
    //echo "ola $ola";
    if ($ola == "OLA 0") {
        $id_malla_actualizada = bcirev_ola5;
        WS_actualizamalla($rut, $id_malla_actualizada, $id_empresa);
    }
    if ($ola == "OLA 1") {
        $id_malla_actualizada = bcirev_m1;
        WS_actualizamalla($rut, $id_malla_actualizada, $id_empresa);
    }
    if ($ola == "OLA 2") {
        $id_malla_actualizada = bcirev_ola2;
        WS_actualizamalla($rut, $id_malla_actualizada, $id_empresa);
    }
    if ($ola == "OLA 3") {
        $id_malla_actualizada = bcirev_ola3;
        WS_actualizamalla($rut, $id_malla_actualizada, $id_empresa);
    }
    if ($ola == "OLA 3_1") {
        $id_malla_actualizada = bcirev_ola4;
        WS_actualizamalla($rut, $id_malla_actualizada, $id_empresa);
    }
    if (!$ola) {
        $id_malla_actualizada = bcirev_ola3;
        WS_actualizamalla($rut, $id_malla_actualizada, $id_empresa);
    }
    $arreglo_rut = $arreglo_archivo = explode("-", $rut);
    $key         = $arreglo_rut[0];
    return $key;
}
function ConsultaWebServiceDatosUsuarioSoloEmailGoogle($correo_consulta, $nombre, $apellido, $imagenUrl, $id_empresa)
{
    $rut              = $correo_consulta;
    //ACTUALIZA BASE DE PERSONAS
    $WS_existeusuario = WS_existeusuariodata($rut, $id_empresa);
    if (count($WS_existeusuario) >= 1) {
        WS_actualizadatos($rut, $nombre, $apellido, $imagenUrl, $cargo, $gerenciaR2, $gerenciaR3, $gerencia, $ola, $jefe, $email, $id_empresa, "actualiza");
    } else {
        WS_actualizadatos($rut, $nombre, $apellido, $imagenUrl, $cargo, $gerenciaR2, $gerenciaR3, $gerencia, $ola, $jefe, $email, $id_empresa, "inserta");
    }
    $arreglo_rut = $arreglo_archivo = explode("-", $rut);
    $key         = $arreglo_rut[0];
    return $key;
}
function colocarComentariosFinalesMedioCiclo($PRINCIPAL, $evaluado, $rut_session, $id_empresa, $id_proceso)
{
    //Verifico si el evaluado finalizo el proceso
    $esta_finalizado_Etapa1 = EstaFinalizadoEpata1($evaluado, $id_proceso, $id_empresa);
    if ($esta_finalizado_Etapa1) {
        if ($evaluado == $rut_session) {
            //bloque evaluado
            if ($esta_finalizado_Etapa1[0]->comentario_evaluado) {
                $PRINCIPAL = str_replace("{BLOQUE_COMENTARIOS_FINALES}", file_get_contents("views/sgd/objetivos/dimensiones/bloque_comentario_final_evaluado_texto.html"), $PRINCIPAL);
                $PRINCIPAL = str_replace("{COMENTARIO}", utf8_encode($esta_finalizado_Etapa1[0]->comentario_evaluado), $PRINCIPAL);
                $PRINCIPAL = str_replace("{COMENTARIO_EVALUADO}", utf8_encode($esta_finalizado_Etapa1[0]->comentario_evaluado), $PRINCIPAL);
                $PRINCIPAL = str_replace("{ROL}", "Colaborador", $PRINCIPAL);
            } else {
                $PRINCIPAL = str_replace("{BLOQUE_COMENTARIOS_FINALES}", file_get_contents("views/sgd/objetivos/dimensiones/bloque_comentario_final_evaluado.html"), $PRINCIPAL);
                $PRINCIPAL = str_replace("{COMENTARIO_EVALUADO}", utf8_encode($esta_finalizado_Etapa1[0]->comentario_evaluado), $PRINCIPAL);
            }
        } else {
            //bloque evaluador
            if ($esta_finalizado_Etapa1[0]->comentario_evaluador) {
                $PRINCIPAL = str_replace("{BLOQUE_COMENTARIOS_FINALES}", file_get_contents("views/sgd/objetivos/dimensiones/bloque_comentario_final_evaluado_texto.html"), $PRINCIPAL);
                $PRINCIPAL = str_replace("{COMENTARIO}", utf8_encode($esta_finalizado_Etapa1[0]->comentario_evaluador), $PRINCIPAL);
                $PRINCIPAL = str_replace("{ROL}", "Jefatura", $PRINCIPAL);
            } else {
                $PRINCIPAL = str_replace("{BLOQUE_COMENTARIOS_FINALES}", file_get_contents("views/sgd/objetivos/dimensiones/bloque_comentario_final_evaluador.html"), $PRINCIPAL);
            }
        }
        $PRINCIPAL = str_replace("{ID_PROCESO_ENCODEADO}", Encodear3($id_proceso), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_EMPRESA_ENCODEADO}", Encodear3($id_empresa), $PRINCIPAL);
        $PRINCIPAL = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($evaluado), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_COMENTARIOS_FINALES}", "", $PRINCIPAL);
    }
    return ($PRINCIPAL);
}
function ColocaColaboradoresResumenObjetivosMedioCiclo($PRINCIPAL, $rut_fijador, $id_empresa, $rut_validador, $id_proceso)
{
    if ($id_proceso) {
        //$evaluados=TraeRelacionesSinAe($rut_fijador, $id_proceso);
        $evaluados = TraeRelacionesSinAeConDatos($rut_fijador, $id_proceso);
    } else {
        $evaluados = TraeRelacionesSinAeSinProceso($rut_fijador);
    }
    $datos_fijador                = UsuarioEnBasePersonas($rut_fijador);
    $PRINCIPAL                    = str_replace("{NOMBRE_FIJADOR}", utf8_encode($datos_fijador[0]->nombre_completo), $PRINCIPAL);
    $dimensiones_por_empresa      = DimensionesObjetivosPorEmpresa($id_empresa);
    $total_dimensiones            = 0;
    $total_fijaciones_finalizadas = 0;
    $total_validadas              = 0;
    if ($rut_validador) {
        $row_html = file_get_contents("views/sgd/objetivos/row_colaboradores_lista_resumen_validador.html");
    } else {
        $row_html = file_get_contents("views/sgd/objetivos/row_colaboradores_lista_resumen_mediociclo.html");
    }
    //Bloque Mi PERFIL
    $evaluados_miperfil = TraeRelacionesSoloAeConDatos($_SESSION["user_"], $id_proceso);
    foreach ($evaluados_miperfil as $eva) {
        $PRINCIPAL = str_replace("{MI_PERFIL}", file_get_contents("views/sgd/objetivos/row_colaboradores_lista_resumen_mediociclo.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{NOMBRE}", utf8_encode($eva->nombre_completo), $PRINCIPAL);
        $PRINCIPAL = str_replace("{PERFIL_COMPETENCIAS}", utf8_encode($eva->perfil_competencia), $PRINCIPAL);
        $PRINCIPAL = str_replace("{JEFE}", utf8_encode($eva->nombre_evaluador), $PRINCIPAL);
        $PRINCIPAL = str_replace("{JEFE_DEL_JEFE}", $eva->nombre_validador, $PRINCIPAL);
        $PRINCIPAL = str_replace("{CARGO}", utf8_encode($eva->cargo_evaluado), $PRINCIPAL);
        $PRINCIPAL = str_replace("{FECHA_INGRESO}", $eva->fecha_ingreso_evaluado, $PRINCIPAL);
        $PRINCIPAL = str_replace("{RUT_EVALUADO}", $eva->evaluado, $PRINCIPAL);
        $PRINCIPAL = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($eva->evaluado), $PRINCIPAL);
        $PRINCIPAL = str_replace("{URL_PERSONA}", VerificaFotoPersonal($eva->evaluado), $PRINCIPAL);
        foreach ($dimensiones_por_empresa as $dimen) {
            if ($dimen->id == 24) {
                continue;
            }
            $row_dimensiones .= file_get_contents("views/sgd/objetivos/row_resumen_por_dimension_evaluado.html");
            $row_dimensiones = str_replace("{NOMBRE_DIMENSION}", $dimen->nombre, $row_dimensiones);
            //Verifico si est? finalizada esta dimension para este evaluado
            $finalizado      = EstaFinalizadoEpata1($eva->evaluado, $id_proceso, $id_empresa);
            if ($finalizado) {
                $row_dimensiones = str_replace("{ESTADO}", '<span class="etiquetaPrograma etiquetaPrograma-aprobado pull-left"><i class="fas fa-check-square"></i>&nbsp;&nbsp;Finalizado</span>', $row_dimensiones);
            } else {
                $row_dimensiones = str_replace("{ESTADO}", '<span class="etiquetaPrograma etiquetaPrograma-noiniciado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;Pendiente</span>', $row_dimensiones);
            }
            if ($finalizado[0]->comentario_evaluado && $finalizado[0]->comentario_evaluador) {
                $row_dimensiones = str_replace("{ESTADO_VALIDACION}", '<span class="etiquetaPrograma etiquetaPrograma-aprobado pull-left"><i class="fas fa-check-square"></i>&nbsp;&nbsp;Finalizado</span>', $row_dimensiones);
            } else {
                $row_dimensiones = str_replace("{ESTADO_VALIDACION}", '<span class="etiquetaPrograma etiquetaPrograma-noiniciado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;Pendiente</span>', $row_dimensiones);
            }
        }
        $PRINCIPAL = str_replace("{ROW_RESUMEN_POR_EVALUADO}", utf8_encode($row_dimensiones), $PRINCIPAL);
    }
    foreach ($evaluados as $eva) {
        //$dimensiones_por_empresa=DimensionesObjetivosPorEmpresaCruceFinalizados($id_empresa, $eva->evaluado);
        $row .= $row_html;
        //ACA Verifico si es que est? o no validado
        $objetivos_validados = VerificaSiObjetivosEstanValidadosDadoEvaluadorIdProcesoEvaluado($rut_fijador, $id_proceso, $eva->evaluado);
        if ($objetivos_validados or $eva->objetivos_masivos == 1) {
            if ($rut_validador) {
                $row = str_replace("{BOTON_VE_INFORME}", file_get_contents("views/sgd/objetivos/boton_descarga_informe_desde_validador.html"), $row);
            } else {
                //$row = str_replace("{BOTON_VE_INFORME}",file_get_contents("views/sgd/objetivos/boton_descarga_informe.html"),$row);
                if ($eva->objetivos_masivos == 1) {
                    $row = str_replace("{BOTON_VE_INFORME}", file_get_contents("views/sgd/objetivos/boton_descarga_informe_solo_texto.html"), $row);
                } else {
                    $row = str_replace("{BOTON_VE_INFORME}", file_get_contents("views/sgd/objetivos/boton_descarga_informe.html"), $row);
                }
            }
            //Veo si esta descargado este informe, si es asi, coloco texto finalizado
            $esta_finalizado_proceso = OBJETIVOS_InformesDescargadosPorEvaluadorProcesoEmpresaEvaluado($eva->evaluado, $eva->evaluador, $id_proceso, $id_empresa);
            if ($esta_finalizado_proceso) {
                //$texto_a_mostrar=file_get_contents("views/sgd/objetivos/texto_proceso_finalizado.html");
                $texto_a_mostrar = "";
            } else {
                $texto_a_mostrar = "";
            }
            if ($eva->objetivos_masivos == 1) {
                $texto_a_mostrar .= file_get_contents("views/sgd/objetivos/texto_carga_masiva.html");
            }
            $row = str_replace("{TEXTO_PROCESO_FINALIZADO}", $texto_a_mostrar, $row);
            $row = str_replace("{BOTON_VER_DETALLE}", "", $row);
        } else {
            $row = str_replace("{BOTON_VE_INFORME}", "", $row);
            if ($rut_validador) {
                $row = str_replace("{BOTON_VER_DETALLE}", file_get_contents("views/sgd/objetivos/boton_ver_detalle_evaluado.html"), $row);
            } else {
                $row = str_replace("{BOTON_VER_DETALLE}", file_get_contents("views/sgd/objetivos/boton_ver_detalle_evaluado_desde_evaluador.html"), $row);
            }
        }
        $row             = str_replace("{NOMBRE}", $eva->nombre_completo, $row);
        $row             = str_replace("{PERFIL_COMPETENCIAS}", $eva->perfil_competencia, $row);
        $row             = str_replace("{JEFE}", $eva->nombre_evaluador, $row);
        $row             = str_replace("{JEFE_DEL_JEFE}", $eva->nombre_validador, $row);
        $row             = str_replace("{CARGO}", $eva->cargo_evaluado, $row);
        $row             = str_replace("{FECHA_INGRESO}", $eva->fecha_ingreso_evaluado, $row);
        $row             = str_replace("{RUT_EVALUADO}", $eva->evaluado, $row);
        $row             = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($eva->evaluado), $row);
        $row             = str_replace("{URL_PERSONA}", VerificaFotoPersonal($eva->evaluado), $row);
        //Por cada colaborador, armo el menu de resumen
        $row_dimensiones = "";
        foreach ($dimensiones_por_empresa as $dimen) {
            if ($dimen->id == 24) {
                continue;
            }
            $row_dimensiones .= file_get_contents("views/sgd/objetivos/row_resumen_por_dimension_evaluado.html");
            $row_dimensiones = str_replace("{NOMBRE_DIMENSION}", $dimen->nombre, $row_dimensiones);
            //Verifico para esta dimension, para este evaluado, si est? o no finalizado.
            $finalizado      = EstaFinalizadoEpata1($eva->evaluado, $id_proceso, $id_empresa);
            if ($finalizado) {
                $row_dimensiones = str_replace("{ESTADO}", '<span class="etiquetaPrograma etiquetaPrograma-aprobado pull-left"><i class="fas fa-check-square"></i>&nbsp;&nbsp;Finalizado</span>', $row_dimensiones);
            } else {
                $row_dimensiones = str_replace("{ESTADO}", '<span class="etiquetaPrograma etiquetaPrograma-noiniciado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;Pendiente</span>', $row_dimensiones);
            }
            //verifico para esta dimension, para este evaluado, si esta ok la etapa de cierre
            if ($finalizado[0]->comentario_evaluado && $finalizado[0]->comentario_evaluador) {
                $row_dimensiones = str_replace("{ESTADO_VALIDACION}", '<span class="etiquetaPrograma etiquetaPrograma-aprobado pull-left"><i class="fas fa-check-square"></i>&nbsp;&nbsp;Finalizado</span>', $row_dimensiones);
            } else {
                $row_dimensiones = str_replace("{ESTADO_VALIDACION}", '<span class="etiquetaPrograma etiquetaPrograma-noiniciado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;Pendiente</span>', $row_dimensiones);
            }
            $total_dimensiones++;
            $matris_datos_generales[$dimen->id]["total"]++;
            //Esto implica si esta finalizado o no.
            if ($estado_dimension[1] == 1) {
                $total_fijaciones_finalizadas++;
                $matris_datos_generales[$dimen->id]["finalizado"]++;
            }
        }
        $row = str_replace("{ROW_RESUMEN_POR_EVALUADO}", $row_dimensiones, $row);
    }
    $PRINCIPAL = str_replace("{LISTADO_COLABORADORES}", utf8_encode($row), $PRINCIPAL);
    $PRINCIPAL = str_replace("{AVANCE_EVALUADOS}", EntregaPorcentaje($total_dimensiones, $total_fijaciones_finalizadas), $PRINCIPAL);
    foreach ($dimensiones_por_empresa as $dimen) {
        $row_dimensiones_gen .= file_get_contents("views/sgd/objetivos/row_resumen_por_dimension.html");
        $row_dimensiones_gen = str_replace("{NOMBRE_DIMENSION}", $dimen->nombre, $row_dimensiones_gen);
        $row_dimensiones_gen = str_replace("{AVANCE_DIMENSION}", EntregaPorcentaje($matris_datos_generales[$dimen->id]["total"], $matris_datos_generales[$dimen->id]["finalizado"]), $row_dimensiones_gen);
        $row_dimensiones_gen = str_replace("{AVANCE_DIMENSION_VALIDACION}", EntregaPorcentaje($matris_datos_generales[$dimen->id]["total"], $matriz_total_validadas[$dimen->id]["validadas"]), $row_dimensiones_gen);
    }
    $PRINCIPAL = str_replace("{ROW_LISTADO_RESUMEN}", utf8_encode($row_dimensiones_gen), $PRINCIPAL);
    return ($PRINCIPAL);
}
function FormularioMedioCiclo($PRINCIPAL, $rut_fijador, $rut_evaluado, $id_empresa, $id_proceso, $id_objetivo, $rut_validador)
{
    //$datos_evaluado=UsuarioEnBasePersonas($rut_evaluado);
    $datos_evaluado          = UsuarioEnBasePersonasConEvaluadorValidador($rut_evaluado);
    $dimensiones_por_empresa = DimensionesObjetivosPorEmpresa($id_empresa);
    $PRINCIPAL               = str_replace("{BLOQUE_RESUMEN_COLABORADOR}", file_get_contents("views/sgd/objetivos/row_colaboradores_lista_resumen_superior.html"), $PRINCIPAL);
    $PRINCIPAL               = str_replace("{NOMBRE}", utf8_encode($datos_evaluado[0]->nombre_completo), $PRINCIPAL);
    $PRINCIPAL               = str_replace("{PERFIL_COMPETENCIAS}", utf8_encode($datos_evaluado[0]->perfil_competencia), $PRINCIPAL);
    $PRINCIPAL               = str_replace("{JEFE}", utf8_encode($datos_evaluado[0]->nombre_evaluador), $PRINCIPAL);
    $PRINCIPAL               = str_replace("{JEFE_DEL_JEFE}", utf8_encode($datos_evaluado[0]->nombre_validador), $PRINCIPAL);
    $PRINCIPAL               = str_replace("{CARGO}", utf8_encode($datos_evaluado[0]->cargo), $PRINCIPAL);
    $PRINCIPAL               = str_replace("{FECHA_INGRESO}", utf8_encode($datos_evaluado[0]->fecha_ingreso), $PRINCIPAL);
    $PRINCIPAL               = str_replace("{URL_PERSONA}", VerificaFotoPersonal($rut_evaluado), $PRINCIPAL);
    $row_dimensiones         = "";
    foreach ($dimensiones_por_empresa as $dimen) {
        if ($dimen->id == 24)
            continue;
        $row_dimensiones .= file_get_contents("views/sgd/objetivos/row_resumen_por_dimension_evaluado.html");
        $row_dimensiones = str_replace("{NOMBRE_DIMENSION}", $dimen->nombre, $row_dimensiones);
        $finalizado      = EstaFinalizadoEpata1($rut_evaluado, $id_proceso, $id_empresa);
        if ($finalizado) {
            $row_dimensiones = str_replace("{ESTADO}", '<span class="etiquetaPrograma etiquetaPrograma-aprobado pull-left"><i class="fas fa-check-square"></i>&nbsp;&nbsp;Finalizado</span>', $row_dimensiones);
        } else {
            $row_dimensiones = str_replace("{ESTADO}", '<span class="etiquetaPrograma etiquetaPrograma-noiniciado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;Pendiente</span>', $row_dimensiones);
        }
        //verifico para esta dimension, para este evaluado, si esta ok la etapa de cierre
        if ($finalizado[0]->comentario_evaluado && $finalizado[0]->comentario_evaluador) {
            $row_dimensiones = str_replace("{ESTADO_VALIDACION}", '<span class="etiquetaPrograma etiquetaPrograma-aprobado pull-left"><i class="fas fa-check-square"></i>&nbsp;&nbsp;Finalizado</span>', $row_dimensiones);
        } else {
            $row_dimensiones = str_replace("{ESTADO_VALIDACION}", '<span class="etiquetaPrograma etiquetaPrograma-noiniciado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;Pendiente</span>', $row_dimensiones);
        }
    }
    $PRINCIPAL = str_replace("{ROW_RESUMEN_POR_EVALUADO}", utf8_encode($row_dimensiones), $PRINCIPAL);
    //Por cada dimension, armo el formulario
    foreach ($dimensiones_por_empresa as $dimen) {
        //$estado_dimension=VerificaEstadoDimensionesObjetivos($rut_evaluado, $dimen->id, $id_empresa);
        //$estado_dimension=VerificaEstadoDimensionesObjetivosParaValidacion($rut_evaluado, $dimen->id, $id_empresa);
        $esta_finalizado_Etapa1 = EstaFinalizadoEpata1($rut_evaluado, $id_proceso, $id_empresa);
        //if($estado_dimension[1]<>3){
        if ($esta_finalizado_Etapa1) {
            $formularios .= file_get_contents("views/sgd/objetivos/dimensiones/" . $dimen->template_lectura);
            $row_html                 = file_get_contents("views/sgd/objetivos/dimensiones/" . $dimen->row_lectura_medio_ciclo);
            $comentario_por_dimension = TieneComentariosObjetivosPorDimension($dimen->id, $rut_evaluado);
            if ($comentario_por_dimension) {
                $formularios .= file_get_contents("views/sgd/objetivos/dimensiones/bloque_comentario_por_dimension.html");
                $formularios = str_replace("{VALUE_COMENTARIO_DIMEN}", utf8_encode($comentario_por_dimension[0]->comentario), $formularios);
            }
            $dimensiones_finalizadas++;
        } else {
            if ($_SESSION["user_"] == $rut_evaluado) {
                $formularios .= file_get_contents("views/sgd/objetivos/dimensiones/" . $dimen->template_lectura . "");
            } else {
                $formularios .= file_get_contents("views/sgd/objetivos/dimensiones/" . $dimen->template_medio_ciclo);
            }
            $formularios              = str_replace("{ID_DIMENSION}", $dimen->id, $formularios);
            $formularios              = str_replace("{RUT_EVALUADO}", $rut_evaluado, $formularios);
            $comentario_por_dimension = TieneComentariosObjetivosPorDimension($dimen->id, $rut_evaluado);
            $formularios              = str_replace("{VALUE_COMENTARIO_DIMEN}", utf8_encode($comentario_por_dimension[0]->comentario), $formularios);
            if ($comentario_por_dimension[0]->comentario) {
                $total_comentarios_ingresados++;
            }
            if ($_SESSION["user_"] == $rut_evaluado) {
                $row_html = file_get_contents("views/sgd/objetivos/dimensiones/" . $dimen->medio_ciclo_ae);
            } else {
                $row_html = file_get_contents("views/sgd/objetivos/dimensiones/" . $dimen->row_medio_ciclo);
            }
        }
        //$formularios.=file_get_contents("views/sgd/objetivos/dimensiones/".$dimen->template);
        //$row_html=file_get_contents("views/sgd/objetivos/dimensiones/".$dimen->row);
        //Aca veo si hay comentarios de esta dimension o no
        $tiene_comentarios = VerificaComentariosPorDimension($rut_fijador, $rut_evaluado, $dimen->id, $id_empresa);
        if ($tiene_comentarios) {
            $formularios = str_replace("{VALUE_ACCIONES_REALIZADAS}", utf8_encode($tiene_comentarios[0]->acciones_realizadas), $formularios);
            $formularios = str_replace("{VALUE_IMPACTO}", utf8_encode($tiene_comentarios[0]->impacto), $formularios);
            $formularios = str_replace("{CASE_FORM_COMEN_DIMENSION}", "updComDim", $formularios);
        } else {
            $formularios = str_replace("{VALUE_ACCIONES_REALIZADAS}", "", $formularios);
            $formularios = str_replace("{VALUE_IMPACTO}", "", $formularios);
            $formularios = str_replace("{CASE_FORM_COMEN_DIMENSION}", "saveComDim", $formularios);
        }
        $formularios               = str_replace("{NUMERO}", $dimen->orden, $formularios);
        $formularios               = str_replace("{NOMBRE_DIMENSION}", utf8_encode($dimen->nombre), $formularios);
        //$formularios = str_replace("{CASE_FORM}",$dimen->case."&val=1",$formularios);
        $formularios               = str_replace("{CASE_FORM}", "saveobjv23Jefe&val=1", $formularios);
        //$formularios = str_replace("{BOTON1}",file_get_contents("views/sgd/objetivos/BotonJefeJefeValida.html"),$formularios);
        $formularios               = str_replace("{BOTON1}", "", $formularios);
        $formularios               = str_replace("{ID_DIMENSION_ENCODEADO}", $dimen->id, $formularios);
        $formularios               = str_replace("{OPTIONS_PONDERACIONES}", PondObjetivos2(""), $formularios);
        $formularios               = str_replace("{OPTIONS_COMPETENCIAS}", utf8_encode(ComboBoxCompetenciasPorPerfil($datos_evaluado[0]->id_perfil_competencia, "")), $formularios);
        //Por cada formulario, veo si existen objetivos ingresados en esta dimension
        //$objetivos_ingresados=ObjetivosPodDimensionEmpresaUsuario($rut_evaluado, $id_empresa, $dimen->id);
        //Por cada formulario, veo si existen objetivos ingresados en esta dimension
        $objetivos_ingresados      = ObjetivosPodDimensionEmpresaUsuario($rut_evaluado, $id_empresa, $dimen->id, $datos_evaluado[0]->id_perfil_competencia);
        $suma_objetivos_ingresados = ObjetivosPodDimensionEmpresaUsuarioSumaPonderacion($rut_evaluado, $id_empresa, $dimen->id);
        if ($dimen->tiene_ponderacion == 1) {
            if (count($objetivos_ingresados) >= $dimen->minimo && count($objetivos_ingresados) <= $dimen->maximo && $suma_objetivos_ingresados[0]->suma_ponderaciones == 100) {
                $muestra_boton_envia_a_jefe++;
            }
        } else {
            if (count($objetivos_ingresados) >= $dimen->minimo && count($objetivos_ingresados) <= $dimen->maximo) {
                $muestra_boton_envia_a_jefe++;
            }
        }
        if ($objetivos_ingresados) {
            $formularios                = str_replace("{BLOQUE_LISTADO_OBJETIVOS_INGRESADOS}", file_get_contents("views/sgd/objetivos/dimensiones/" . $dimen->entornoLecturaForm), $formularios);
            $total_objetivos_ingresados = "";
            $k                          = 0;
            $suma_ponderacion           = 0;
            foreach ($objetivos_ingresados as $obj_ing) {
                $k++;
                //$total_objetivos_ingresados.=file_get_contents("views/sgd/objetivos/dimensiones/".$dimen->row);
                if ($id_objetivo == $obj_ing->id) {
                    $total_objetivos_ingresados .= file_get_contents("views/sgd/objetivos/dimensiones/edita_" . $dimen->row);
                } else {
                    $total_objetivos_ingresados .= $row_html;
                }
                //$total_objetivos_ingresados.=$row_html;
                $total_objetivos_ingresados = str_replace("{NUMERO}", $k, $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{ID_DIMENSION}", $dimen->id, $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{ID_DIMENSION_ENCODEADA}", Encodear3($dimen->id), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{PARAMETROS_VAL}", "&rval=" . $rut_validador, $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{OBJETIVO}", utf8_encode($obj_ing->descripcion_objetivo), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{RUT_EVALUADO}", utf8_encode($rut_evaluado), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{RUT}", ($rut_evaluado), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{ID_OBJETIVO_ENCODEADO}", Encodear3($obj_ing->id), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{ID_OBJETIVO}", ($obj_ing->id), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{ACCION}", utf8_encode($obj_ing->accion_clave), $total_objetivos_ingresados);
                //$total_objetivos_ingresados = str_replace("{CONDUCTA_CRITICA}",utf8_encode($obj_ing->conducta_critica),$total_objetivos_ingresados);
                //$total_objetivos_ingresados = str_replace("{CONDUCTA_CRITICA}",utf8_encode($obj_ing->nombre_competencia),$total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{CONDUCTA_CRITICA}", utf8_encode($obj_ing->nombre_conducta), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{COMPETENCIA}", utf8_encode($obj_ing->nombre_competencia), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{COMENTARIO_MEDIO_CICLO}", utf8_encode($obj_ing->comentario_medio_ciclo), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{NOTA_MEDIO_CICLO_JEFE}", utf8_encode($obj_ing->nota_medio_ciclo_jefe), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{NOTA_MEDIO_CICLO_AE}", utf8_encode($obj_ing->nota_medio_ciclo_ae), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{COMENTARIO}", utf8_encode($obj_ing->comentarios), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{ACCION_DESARROLLO}", utf8_encode($obj_ing->acciones_desarrollo), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{RESPONSABLE}", utf8_encode($obj_ing->responsable), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{FECHA}", utf8_encode($obj_ing->fecha_limite), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{ENV_EDITAR}", "updobjetivoV2Val", $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{PONDERACION}", utf8_encode($obj_ing->ponderacion) . "%", $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{OPTIONS_PONDERACIONES_INGRESADO}", PondObjetivos2($obj_ing->ponderacion) . "%", $total_objetivos_ingresados);
                //$total_objetivos_ingresados  = str_replace("{OPTIONS_COMPETENCIAS_INGRESADO}",utf8_encode(ComboBoxCompetenciasPorPerfil($datos_evaluado[0]->id_perfil_competencia, $obj_ing->conducta_critica)),$total_objetivos_ingresados );
                $total_objetivos_ingresados = str_replace("{OPTIONS_COMPETENCIAS_INGRESADO}", utf8_encode(ComboBoxCompetenciasPorPerfil($datos_evaluado[0]->id_perfil_competencia, $obj_ing->competencia)), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{OPTIONS_CONDUCTAS_CRITICAS}", utf8_encode(ComboBoxConductasCriticasDadoPerfilYCompetencias($datos_evaluado[0]->id_perfil_competencia, $obj_ing->competencia, $obj_ing->conducta_critica)), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{ACCIONES_REALIZADAS}", utf8_encode($obj_ing->acciones_realizadas), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{IMPACTO}", utf8_encode($obj_ing->impacto), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{TIPO_ACCION}", utf8_encode($obj_ing->tipo_accion), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{SELECTED_" . utf8_encode($obj_ing->tipo_accion) . "}", "selected", $total_objetivos_ingresados);
                $suma_ponderacion           = $suma_ponderacion + $obj_ing->ponderacion;
            }
            $formularios = str_replace("{ROW_INGRESADOS}", $total_objetivos_ingresados, $formularios);
            $formularios = str_replace("{TOTAL_PONDERACION}", $suma_ponderacion . "%", $formularios);
            $formularios = str_replace("{ID_PERFIL_COMPETENCIAS}", $datos_evaluado[0]->id_perfil_competencia, $formularios);
            if ($suma_ponderacion == 100) {
                $formularios = str_replace("{CLASE_PONDERACION}", "pond_correcto", $formularios);
            } else {
                $formularios = str_replace("{CLASE_PONDERACION}", "pond_alerta", $formularios);
            }
        } else {
            $formularios = str_replace("{ROW_INGRESADOS}", "NO", $formularios);
        }
    }
    //$PRINCIPAL = str_replace("{BOTON_ENVIA_A_VALIDAR_OBJETIVOS}",file_get_contents("views/sgd/objetivos/BotonJefeJefeValida.html"),$PRINCIPAL);
    if ($total_comentarios_ingresados == 2) {
        //$PRINCIPAL = str_replace("{BOTON_JEFE_FINALIZA__MEDIO_CICLO}",file_get_contents("views/sgd/objetivos/BotonJefeFinaliza1MedioCiclo.html"),$PRINCIPAL);
    } else {
        //$PRINCIPAL = str_replace("{BOTON_JEFE_FINALIZA__MEDIO_CICLO}","",$PRINCIPAL);
    }
    if ($_SESSION["user_"] == $rut_evaluado) {
        $PRINCIPAL = str_replace("{BOTON_JEFE_FINALIZA__MEDIO_CICLO}", "", $PRINCIPAL);
    } else {
        $esta_finalizado_Etapa1 = EstaFinalizadoEpata1($rut_evaluado, $id_proceso, $id_empresa);
        if ($esta_finalizado_Etapa1) {
            $PRINCIPAL = str_replace("{BOTON_JEFE_FINALIZA__MEDIO_CICLO}", "", $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{BOTON_JEFE_FINALIZA__MEDIO_CICLO}", file_get_contents("views/sgd/objetivos/BotonJefeFinaliza1MedioCiclo.html"), $PRINCIPAL);
        }
    }
    $PRINCIPAL = str_replace("{NUMERO_PASO}", count($dimensiones_por_empresa) + 1, $PRINCIPAL);
    $PRINCIPAL = str_replace("{BLOQUE_FORMULARIOS_POR_DIMENSIONES}", $formularios, $PRINCIPAL);
    $PRINCIPAL = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($rut_evaluado), $PRINCIPAL);
    $PRINCIPAL = str_replace("{RUT_EVALUADO}", ($rut_evaluado), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ID_PROCESO}", ($id_proceso), $PRINCIPAL);
    return ($PRINCIPAL);
}
function SubidaCVMovimientoInternos($FILES, $extension_doc, $prefijo, $ruta, $numero)
{
    //echo "$extension_archivo, $prefijo, $ruta";exit;
    //$ruta_con_archivo=$ruta."/".$prefijo."_BK.".$extension_archivo;
    $ruta_con_archivo = $ruta . "/" . $prefijo . "." . $extension_doc;
    copy($FILES['archivo']['tmp_name'], $ruta_con_archivo);
    $nombre_imagen_video = $prefijo . "." . $extension_doc;
    //RedimensionarImagenSlider($ruta_con_archivo, $nombre_imagen_slider);
    //Devuelvol un arreglo, con datos del archivo subido
    $arreglo[0]          = $ruta_con_archivo; //Ruta Completa
    $arreglo[1]          = $prefijo . "." . $extension_doc; //Nombre del Archivo
    $arreglo[2]          = $ruta . "/" . $prefijo; //Ruta del Objeto sin el index
    return ($arreglo);
}
function FormularioPostula($PRINCIPAL, $rut, $id_oferta)
{
    $detalle_postulacion = DetalleMovimientoInterno($id_oferta);
    $PRINCIPAL           = str_replace("{NOMBRE_CARGO}", utf8_encode($detalle_postulacion[0]->cargo), $PRINCIPAL);
    $PRINCIPAL           = str_replace("{OBJETIVO_CARGO}", utf8_encode($detalle_postulacion[0]->objetivo_cargo), $PRINCIPAL);
    $PRINCIPAL           = str_replace("{REQUISITOS_CARGO}", utf8_encode($detalle_postulacion[0]->requisito_cargo), $PRINCIPAL);
    $PRINCIPAL           = str_replace("{ID_PUBLICACION}", Encodear3($id_oferta), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaListadoMovimientosInternos($PRINCIPAL, $id_empresa, $rut)
{
    //Traigo total de los movimientos internos
    $listado = ListadoMovimientosInternos($id_empresa, $rut);
    foreach ($listado as $list) {
        $row .= file_get_contents("views/movimientos_internos/row_MovimientosInternos.html");
        $row = str_replace("{NOMBRE_CARGO}", $list->cargo, $row);
        $row = str_replace("{FECHA_PUBLICACION}", $list->fecha_publicacion, $row);
        $row = str_replace("{FECHA_EXPIRACION}", $list->fecha_expiracion, $row);
        if ($list->fecha_postulacion) {
            $row = str_replace("{ACCION}", "<span  class='btn btn-info'>Ya Postulaste</span>", $row);
        } else {
            $row = str_replace("{ACCION}", "<a class='btn btn-info' href='?sw=postulaMovInt&i=" . Encodear3($list->id) . "'>Postula</a>", $row);
        }
    }
    $PRINCIPAL = str_replace("{LISTADO_MOVIMIENTOS_INTERNOS}", utf8_encode($row), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaDatosBiografiaProfesional($id_objeto, $rut, $PRINCIPAL)
{
    $datos_objeto = DatosObjeto($id_objeto);
    $datos        = TraeDatosBiografiaProfesional($rut, $id_objeto);
    $PRINCIPAL    = str_replace("{pareja}", utf8_encode($datos[0]->pareja), $PRINCIPAL);
    $PRINCIPAL    = str_replace("{emfermedades_importantes}", utf8_encode($datos[0]->emfermedades_importantes), $PRINCIPAL);
    $PRINCIPAL    = str_replace("{nombre_contacto_emergencia}", utf8_encode($datos[0]->nombre_contacto_emergencia), $PRINCIPAL);
    $PRINCIPAL    = str_replace("{telefono_contacto_emergencia}", utf8_encode($datos[0]->telefono_contacto_emergencia), $PRINCIPAL);
    $PRINCIPAL    = str_replace("{estudios}", utf8_encode($datos[0]->estudios), $PRINCIPAL);
    $PRINCIPAL    = str_replace("{profesion}", utf8_encode($datos[0]->profesion), $PRINCIPAL);
    $PRINCIPAL    = str_replace("{cantidad_hijos}", utf8_encode($datos[0]->cantidad_hijos), $PRINCIPAL);
    $PRINCIPAL    = str_replace("{edad_hijos}", utf8_encode($datos[0]->edad_hijos), $PRINCIPAL);
    $PRINCIPAL    = str_replace("{sexo_hijos}", utf8_encode($datos[0]->sexo_hijos), $PRINCIPAL);
    $PRINCIPAL    = str_replace("{ultima_empresa}", utf8_encode($datos[0]->ultima_empresa), $PRINCIPAL);
    $PRINCIPAL    = str_replace("{cargo_ultima_empresa}", utf8_encode($datos[0]->cargo_ultima_empresa), $PRINCIPAL);
    $PRINCIPAL    = str_replace("{tiempo_ultima_empresa}", utf8_encode($datos[0]->tiempo_ultima_empresa), $PRINCIPAL);
    $PRINCIPAL    = str_replace("{motivacion}", utf8_encode($datos[0]->motivacion), $PRINCIPAL);
    $PRINCIPAL    = str_replace("{que_esperas_jefatura}", utf8_encode($datos[0]->que_esperas_jefatura), $PRINCIPAL);
    $PRINCIPAL    = str_replace("{que_esperas_cargo}", utf8_encode($datos[0]->que_esperas_cargo), $PRINCIPAL);
    $PRINCIPAL    = str_replace("{metas}", utf8_encode($datos[0]->metas), $PRINCIPAL);
    $PRINCIPAL    = str_replace("{capacitacion}", utf8_encode($datos[0]->capacitacion), $PRINCIPAL);
    $PRINCIPAL    = str_replace("{talla_camisa}", utf8_encode($datos[0]->talla_camisa), $PRINCIPAL);
    $PRINCIPAL    = str_replace("{talla_pantalon}", utf8_encode($datos[0]->talla_pantalon), $PRINCIPAL);
    $PRINCIPAL    = str_replace("{talla_chaqueta}", utf8_encode($datos[0]->talla_chaqueta), $PRINCIPAL);
    $PRINCIPAL    = str_replace("{talla_falda}", utf8_encode($datos[0]->talla_falda), $PRINCIPAL);
    $PRINCIPAL    = str_replace("{titulo_principal}", utf8_encode($datos_objeto[0]->titulo_principal), $PRINCIPAL);
    $PRINCIPAL    = str_replace("{pregunta_principal}", utf8_encode($datos_objeto[0]->pregunta_principal), $PRINCIPAL);
    $PRINCIPAL    = str_replace("{bajada_principal}", utf8_encode($datos_objeto[0]->bajada_principal), $PRINCIPAL);
    $PRINCIPAL    = str_replace("{titulo_secundario}", utf8_encode($datos_objeto[0]->titulo_secundario), $PRINCIPAL);
    $PRINCIPAL    = str_replace("{bajada_secundario}", utf8_encode($datos_objeto[0]->bajada_secundario), $PRINCIPAL);
    $PRINCIPAL    = str_replace("{subtitulo_principal}", utf8_encode($datos_objeto[0]->subtitulo_principal), $PRINCIPAL);
    $PRINCIPAL    = str_replace("{bajada_subtitulo_principal}", utf8_encode($datos_objeto[0]->bajada_subtitulo_principal), $PRINCIPAL);
    if ($_GET["idvideo"]) {
        //Obtengo el Video con el id
        $datos_video = DatosArchivoImagenCruceObjeto($_GET["idvideo"]);
        $PRINCIPAL   = str_replace("{BLOQUE_REPRODUCTOR_VIDEO}", file_get_contents("views/cursos/objetos/subirVideos/reproductor_video.html"), $PRINCIPAL);
        $PRINCIPAL   = str_replace("{URL_VIDEO}", "img/objetos/" . $datos_video[0]->archivo, $PRINCIPAL);
        $PRINCIPAL   = str_replace("{TITULO_VIDEO}", $datos_video[0]->titulo_video, $PRINCIPAL);
        $PRINCIPAL   = str_replace("{DESCRIPCION_VIDEO}", $datos_video[0]->descripcion_video, $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_REPRODUCTOR_VIDEO}", file_get_contents("views/cursos/objetos/subirVideos/mensaje_seleccione_video.html"), $PRINCIPAL);
    }
    if ($datos) {
        $PRINCIPAL = str_replace("{STYLO_MUESTRA_BOTON2}", "", $PRINCIPAL);
        //$PRINCIPAL = str_replace("{STYLO_MUESTRA_BOTON1}",'style="display:none;"',$PRINCIPAL);
        $PRINCIPAL = str_replace("{STYLO_MUESTRA_BOTON1}", '', $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{STYLO_MUESTRA_BOTON1}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{STYLO_MUESTRA_BOTON2}", 'style="display:none;"', $PRINCIPAL);
    }
    return ($PRINCIPAL);
}
function FinalizaObjetoPorUsuario($rut, $id_objeto, $id_empresa)
{
    $datos_objeto = DatosObjeto($id_objeto);
    $puntos       = $datos_objeto[0]->puntos;
    $medalla      = $datos_objeto[0]->medallas;
    FinalizaObjetoFullDatos($rut, $id_objeto, $id_empresa);
}
function BuscaUserBci($email, $id_empresa)
{
    //echo "$email, $id_empresa";
    $key        = buscaUserBciData($email, $id_empresa);
    $entregarut = $key[0]->rut;
    return $entregarut;
}
function EnviaCorreoAccionesPendientes($rut_colaborador, $rut_jefatura, $id_empresa)
{
    //echo "$rut_destinatario,$nombre, $id_estado, $id_empresa, $tipo_correo, $tiporecipiente, $id_mp";
    $datos_empresa      = DatosEmpresa($id_empresa);
    $datos_colaborador  = UsuarioEnBasePersonas($rut_colaborador);
    $datos_jefatura     = UsuarioEnBasePersonas($rut_jefatura);
    $nombre_colaborador = $datos_colaborador[0]->nombre_completo;
    $nombre_jefatura    = $datos_jefatura[0]->nombre_completo;
    $email_jefatura     = $datos_jefatura[0]->email;
    $template_correo    = file_get_contents("views/correos/61_correo_a_jefe.html");
    $template_correo    = str_replace("{NOMBRE_JEFE}", utf8_encode($nombre_jefatura), $template_correo);
    $template_correo    = str_replace("{NOMBRE_COLABORADOR}", utf8_encode($nombre_colaborador), $template_correo);
    //$template_correo = str_replace("{PRACTICA}",utf8_encode($nombre_practica),$template_correo);
    $mail               = new PHPMailer;
    //Tell PHPMailer to use SMTP
    $mail->isSMTP(); //Enable SMTP debugging
    // 0 = off (for production use)
    // 1 = client messages
    // 2 = client and server messages
    $mail->SMTPDebug   = 1;
    //Ask for HTML-friendly debug output
    $mail->Debugoutput = 'error_log';
    //Set the hostname of the mail server
    $mail->Host        = $datos_empresa[0]->server;
    //Set the SMTP port number - likely to be 25, 465 or 587
    $mail->Port        = 25;
    //Whether to use SMTP authentication
    $mail->SMTPAuth    = true;
    //Username to use for SMTP authentication
    $mail->Username    = $datos_empresa[0]->envio_correos;
    //Password to use for SMTP authentication
    $mail->Password    = $datos_empresa[0]->envio_correos_pass;
    //Set who the message is to be sent from
    $mail->setFrom($datos_empresa[0]->envio_correos, "RF");
    $mail->addAddress("daniel@gop.cl", $datos_destinatario[0]->nombre_completo);
    $mail->addAddress("rod@gop.cl", $datos_destinatario[0]->nombre_completo);
    //Set the subject line
    $mail->Subject = "Jefe debes validar el Pasaporte";
    //Read an HTML message body from an external file, convert referenced images to embedded,
    //convert HTML into a basic plain-text alternative body
    $mail->msgHTML($template_correo, dirname(__FILE__));
    //Replace the plain text body with one created manually
    $mail->AltBody = 'Si no puedes visualizar este correo ....';
    //Attach an image file
    //$mail->addAttachment('images/phpmailer_mini.png');
    //send the message, check for errors
    if (!$mail->send()) {
        //echo "Mailer Error: " . $mail->ErrorInfo;
    } else {
        //echo "Message sent!";
    }
    //exit;
}
function MuestraInformeSoloMensaje($PRINCIPAL, $id_empresa, $id_encuesta, $id_objeto, $id_curso)
{
    $html .= file_get_contents("views/encuesta/" . $id_empresa . "_template_enc_mensaje_final.html");
    $PRINCIPAL      = str_replace("{BLOQUE_ENCUESTA}", ($html), $PRINCIPAL);
    $datos_encuesta = DDatosEncSatis($id_encuesta);
    $PRINCIPAL      = str_replace("{TITULO}", utf8_encode($datos_encuesta[0]->nombre), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{ID_CURSO_ENCODEADO}", Encodear3($id_curso), $PRINCIPAL);
    return ($PRINCIPAL);
}
function VerificoEvalCursos($id_objeto, $rut)
{
    $datos_objeto = DatosObjeto($id_objeto);
    if ($datos_objeto[0]->preguntas_aleatorias > 0) {
        //$datos_preguntas=PreguntasDadoIdObjetoaleatorio($id_objeto, $rut);
        $datos_preguntas = EVALUACION_PreguntasDadoIdObjetoaleatorio($id_objeto, $rut);
    } else {
        //$datos_preguntas=PreguntasDadoIdObjeto($id_objeto);
        $datos_preguntas = EVALUACION_PreguntasDadoIdObjeto($id_objeto);
    }
    $PRINCIPAL       = str_replace("{NOMBRE_OBJETO}", utf8_encode($datos_objeto[0]->titulo), $PRINCIPAL);
    $datos_usuario   = UsuarioEnBasePersonas($rut);
    $PRINCIPAL       = str_replace("{NOMBRE_USUARIO}", utf8_encode($datos_usuario[0]->nombre_completo), $PRINCIPAL);
    $total_preguntas = "";
    $i               = 1;
    $correctas       = 0;
    foreach ($datos_preguntas as $preg) {
        $total_preguntas .= file_get_contents("views/cursos/informe/" . $_SESSION["id_empresa"] . "_row_informe_eval_preguntas.html");
        $total_preguntas   = str_replace("{N}", $i, $total_preguntas);
        $total_preguntas   = str_replace("{PREGUNTA}", $preg->pregunta, $total_preguntas);
        //Verifico si la respuesta que ingreso el usuario para eta pregunta es correcta o no
        $respuesta_usuario = ObtenerRespuestaDeUsuario($preg->id, $rut);
        //print_r($respuesta_usuario);
        $total_preguntas   = str_replace("{TURESPUESTA}", $respuesta_usuario[0]->alternativa, $total_preguntas);
        if ($respuesta_usuario[0]->correcta == "1") {
            $total_preguntas = str_replace("{COLOR_FONDO}", "color_aprobado_text", $total_preguntas);
            $total_preguntas = str_replace("{ICONO_INFORME_PREGUNTAS}", "fas fa-check-square", $total_preguntas);
            $total_preguntas = str_replace("{RESPUESTA_CORRECTA}", "", $total_preguntas);
            $correctas++;
        } else {
            $total_preguntas = str_replace("{COLOR_FONDO}", "color_reprobado_text", $total_preguntas);
            $total_preguntas = str_replace("{ICONO_INFORME_PREGUNTAS}", "far fa-times-circle", $total_preguntas);
            if ($_SESSION["id_empresa"] <> 57) {
                $total_preguntas = str_replace("{RESPUESTA_CORRECTA}", file_get_contents("views/cursos/informe/row_respuesta_correcta.html"), $total_preguntas);
            } else {
                $total_preguntas = str_replace("{RESPUESTA_CORRECTA}", "", $total_preguntas);
            }
            $total_preguntas = str_replace("{CORRECTA}", $respuesta_usuario[0]->alternativa_correcta, $total_preguntas);
        }
        $i++;
    }
    //NotaFinal
    $nota_final = ($correctas * 100) / count($datos_preguntas);
    if ($_SESSION["id_empresa"] == 57) {
        if ($nota_final == 100) {
            $arreglo[0] = "aprobado";
        } else if ($nota_final >= 0 and $nota_final < 100) {
            $arreglo[0] = "reprobado";
        }
    } else if ($_SESSION["id_empresa"] == 53) {
        if ($nota_final >= 75) {
            $arreglo[0] = "aprobado";
        } else {
            $arreglo[0] = "reprobado";
        }
    } else {
        //Veo si tiene nota de aprobacion el objeto
        $nota_aprobacion_objeto = $datos_objeto[0]->nota_aprobacion;
        if ($nota_aprobacion_objeto) {
            if ($nota_final >= $nota_aprobacion_objeto) {
                $arreglo[0] = "aprobado";
            } else {
                $arreglo[0] = "reprobado";
            }
        } else {
            if ($nota_final == 100) {
                $arreglo[0] = "aprobado";
            } else {
                $arreglo[0] = "reprobado";
            }
        }
    }
    return ($arreglo);
}
function ColocaPReguntasPorEval($id_objeto)
{
    //traigo las preguntas
    $preguntas = PreguntasEvalDadoIdObjeto($id_objeto);
    foreach ($preguntas as $preg) {
        $bloque_preguntas .= file_get_contents("views/cursos/objetos/preguntas/row_pregunta.html");
        $bloque_preguntas  = str_replace("{PREGUNTA}", ($preg->pregunta), $bloque_preguntas);
        $bloque_preguntas  = str_replace("{NUMERO_PREGUNTA}", ($preg->orden_preguntas), $bloque_preguntas);
        //Por cada pregunta, traigo las alternativas
        $alternativas      = AlternativasDadoId($preg->id_grupo_alternativas);
        $html_alternativas = "";
        foreach ($alternativas as $alt) {
            $html_alternativas .= file_get_contents("views/cursos/objetos/preguntas/row_alternativa.html");
            $html_alternativas = str_replace("{ALTERNATIVA}", ($alt->alternativa), $html_alternativas);
            if ($alt->correcta == 1) {
                $html_alternativas = str_replace("{CORRECTA}", "<img src='img/correcta.png'>", $html_alternativas);
            } else if ($alt->correcta == 0) {
                $html_alternativas = str_replace("{CORRECTA}", "<img src='img/incorrecta.png'>", $html_alternativas);
            }
        }
        $bloque_preguntas = str_replace("{ROW_ALTERNATIVAS}", ($html_alternativas), $bloque_preguntas);
    }
    return (utf8_encode($bloque_preguntas));
}
function ColocaObjetosPorCursoSiNotiene($id_empresa, $id_curso, $codigo_imparticion)
{
    $tiene_objeto = CHECK_ObjetosPorCurso($id_curso);
    if (!$tiene_objeto) {
        //Inserto los objetos en la tabla objeto, por este curso
        $objetos = CHECK_TraeObjetosPAraIngresar();
        $orden   = 1;
        foreach ($objetos as $obj) {
            //Inserto el objeto
            //InsertoObjetoCheckin($obj, $id_empresa, $id_curso, $orden);
            if ($codigo_imparticion) {
                InsertoObjetoCheckin($obj, $id_empresa, $codigo_imparticion, $orden, $id_curso);
            } else {
                InsertoObjetoCheckin($obj, $id_empresa, $id_curso, $orden);
            }
            $orden++;
            if ($obj->extension_objeto == "18") {
                if ($codigo_imparticion) {
                    $id_evaluacion = CreoEvaluacionPorObjeto($id_empresa, $codigo_imparticion, $codigo_imparticion . "_" . $obj->id);
                } else {
                    $id_evaluacion = CreoEvaluacionPorObjeto($id_empresa, $id_curso, $id_curso . "_" . $obj->id);
                }
            }
        }
    }
}
function ColocaBloqueComentariosPorObjetoConReplay($id_objeto, $rut, $rut_colaborador_vista_jefe)
{
    //Veo si hay documentos por Objeto
    //echo " rut $rut  ----  desde jefe $rut_colaborador_vista_jefe";
    //$comentarios=ComentariosPorObjeto($id_objeto);
    //echo $rut_colaborador_vista_jefe." rut col desde vista jefe";
    if ($rut_colaborador_vista_jefe) {
        $comentarios = ComentariosPorObjetoPorColaborador($id_objeto, $rut_colaborador_vista_jefe);
    } else {
        $comentarios = ComentariosPorObjetoPorColaborador($id_objeto, $rut);
    }
    $bloque_comentarios = "";
    if ($comentarios) {
        $total = "";
        foreach ($comentarios as $unico) {
            $bloque_comentarios = file_get_contents("views/cursos/objetos/foro_prod/bloque_comentario.html");
            $bloque_comentarios = str_replace("{URL_IMAGEN_PERSONA}", VerificaFotoPersonal($unico->rut), $bloque_comentarios);
            $bloque_comentarios = str_replace("{NOMBRE}", ($unico->nombre_persona), $bloque_comentarios);
            $bloque_comentarios = str_replace("{COMENTARIO}", ($unico->comentario), $bloque_comentarios);
            $bloque_comentarios = str_replace("{RUT_ENCODEADO_AUTOR_COMENTARIO}", Encodear3($unico->rut), $bloque_comentarios);
            $bloque_comentarios = str_replace("{FECHA}", FechaTipoSpa($unico->fecha . " " . $unico->hora), $bloque_comentarios);
            $tiene_megusta      = MegustaPorComentarioRut($unico->id, $rut);
            if ($unico->rut == $rut) {
                $bloque_comentarios = str_replace("{BLOQUE_MEGUSTA}", file_get_contents("views/cursos/objetos/foro_prod/bloque_comentario_micomentario.html"), $bloque_comentarios);
            } else {
                if ($tiene_megusta) {
                    $bloque_comentarios = str_replace("{BLOQUE_MEGUSTA}", file_get_contents("views/cursos/objetos/foro_prod/bloque_comentario_yamegusta.html"), $bloque_comentarios);
                } else {
                    $bloque_comentarios = str_replace("{BLOQUE_MEGUSTA}", file_get_contents("views/cursos/objetos/foro_prod/bloque_comentario_megusta.html"), $bloque_comentarios);
                }
            }
            $bloque_comentarios             = str_replace("{ID_COMENTARIO}", $unico->id, $bloque_comentarios);
            // $bloque_comentarios = str_replace("{ID_OBJETO_ENCODEADO}",$id_objeto,$bloque_comentarios);
            $bloque_comentarios             = str_replace("{ID_COMENTARIO_MEGUSTA}", $unico->id, $bloque_comentarios);
            //Verifico si este comentario ya tiene un me gusta, si ya tiene, le muestro un bloque de me gusta,
            //sino el bloque de Yamegusta
            //Veo cuantos ME GUSTA tiene este comentario
            $cantidad_megusta_porcomentario = MegustaPorComentario($unico->id);
            $bloque_comentarios             = str_replace("{XMEGUSTA}", count($cantidad_megusta_porcomentario), $bloque_comentarios);
            //Aca veo si tiene REPLYS
            $replys                         = ReplysPorComentarios($unico->id);
            $bloque_comentarios             = str_replace("{NUM_RESP}", count($replys), $bloque_comentarios);
            if ($replys) {
                foreach ($replys as $repl) {
                    $replys_html .= file_get_contents("views/cursos/objetos/foro_prod/bloque_comentario_replay.html");
                    $replys_html             = str_replace("{URL_IMAGEN_PERSONA}", VerificaFotoPersonal($repl->rut), $replys_html);
                    $replys_html             = str_replace("{NOMBRE}", ($repl->nombre_completo), $replys_html);
                    $replys_html             = str_replace("{COMENTARIO}", ($repl->comentario), $replys_html);
                    $replys_html             = str_replace("{RUT_ENCODEADO_AUTOR_COMENTARIO}", Encodear3($repl->rut), $replys_html);
                    $replys_html             = str_replace("{FECHA}", FechaTipoSpa($repl->fecha . " " . $repl->hora), $replys_html);
                    $tiene_megusta_por_reply = MegustaPorComentarioRutReply($repl->id, $rut);
                    if ($repl->rut == $rut) {
                        $replys_html = str_replace("{BLOQUE_MEGUSTA_REPLY}", file_get_contents("views/cursos/objetos/foro_prod/bloque_comentario_reply_micomentario.html"), $replys_html);
                    } else {
                        if ($tiene_megusta_por_reply) {
                            $replys_html = str_replace("{BLOQUE_MEGUSTA_REPLY}", file_get_contents("views/cursos/objetos/foro_prod/bloque_comentario_reply_yamegusta.html"), $replys_html);
                        } else {
                            $replys_html = str_replace("{BLOQUE_MEGUSTA_REPLY}", file_get_contents("views/cursos/objetos/foro_prod/bloque_comentario_reply_megusta.html"), $replys_html);
                        }
                    }
                    $replys_html                         = str_replace("{ID_COMENTARIO_REPLY}", ($repl->id), $replys_html);
                    $cantidad_megusta_porcomentarioReply = MegustaPorComentarioReply($repl->id);
                    $replys_html                         = str_replace("{XMEGUSTAREPLY}", count($cantidad_megusta_porcomentarioReply), $replys_html);
                }
                $bloque_comentarios = str_replace("{LISTADO_REPLY_POR_COMENTARIO}", $replys_html, $bloque_comentarios);
            } else {
                $bloque_comentarios = str_replace("{LISTADO_REPLY_POR_COMENTARIO}", "", $bloque_comentarios);
            }
            $total .= $bloque_comentarios;
        }
    } else {
    }
    return (utf8_encode($total));
}
function ColocaBloqueComparte($PRINCIPAL, $id_empresa, $id_malla, $rut, $tipo)
{
    if ($tipo == "home") {
        $limit_total = "3";
        $html        = file_get_contents("views/cursos/objetos/foro_cat/formulario.html");
    } else if ($tipo == "todo") {
        $limit_total = "";
        $html        = file_get_contents("views/cursos/objetos/foro_cat/formulario_completo.html");
    }
    $html             = str_replace("{URL_MIPERFIL}", VerificaFotoPersonal($rut), $html);
    $html             = str_replace("{ID_MALLA_ENCODEADO}", Encodear3($id_malla), $html);
    //Dado la malla, traigo los cursos
    $cursos_por_malla = ObtenerCursosDadoMalla2($id_malla);
    $options_cursos   = "";
    foreach ($cursos_por_malla as $curso) {
        $options_cursos .= "<option value='" . $curso->id . "'>" . $curso->nombre . "</option>";
    }
    $html                = str_replace("{OPTIONS}", utf8_encode($options_cursos), $html);
    $html                = str_replace("{ID_MALLA_ENCODEADA}", Encodear3($id_malla), $html);
    //Aca traigo los ultimos 3 comentarios con m?s me gusta
    $ultimos_comentarios = ComentariosPorMallaEmpresa($id_malla, $id_empresa, $limit_total);
    $html_comentarios    = "";
    foreach ($ultimos_comentarios as $comen) {
        $html_comentarios .= file_get_contents("views/cursos/objetos/foro_cat/row_reciente.html");
        $html_comentarios = str_replace("{NOMBRE_COMPLETO}", $comen->nombre_completo, $html_comentarios);
        $html_comentarios = str_replace("{COMENTARIO}", $comen->comentario, $html_comentarios);
        $html_comentarios = str_replace("{CATEGORIA}", $comen->valor_categoria, $html_comentarios);
        $html_comentarios = str_replace("{URL_PERSONA}", VerificaFotoPersonal($comen->rut), $html_comentarios);
        $html_comentarios = str_replace("{TIEMPO}", ($comen->fecha), $html_comentarios);
        $tiene_megusta    = MegustaPorComentarioRut($comen->id, $rut);
        if ($comean->rut == $rut) {
            $html_comentarios = str_replace("{BLOQUE_MEGUSTA}", file_get_contents("views/cursos/objetos/foro_cat/bloque_comentario_micomentario.html"), $html_comentarios);
        } else {
            if ($tiene_megusta) {
                $html_comentarios = str_replace("{BLOQUE_MEGUSTA}", file_get_contents("views/cursos/objetos/foro_cat/bloque_comentario_yamegusta.html"), $html_comentarios);
            } else {
                $html_comentarios = str_replace("{BLOQUE_MEGUSTA}", file_get_contents("views/cursos/objetos/foro_cat/bloque_comentario_megusta.html"), $html_comentarios);
            }
        }
        $html_comentarios               = str_replace("{ID_COMENTARIO_MEGUSTA}", ($comen->id), $html_comentarios);
        $cantidad_megusta_porcomentario = MegustaPorComentario($comen->id);
        $html_comentarios               = str_replace("{XMEGUSTA}", count($cantidad_megusta_porcomentario), $html_comentarios);
    }
    $ultimos_comentarios_ingresados = ComentariosPorMallaEmpresaLimit($id_malla, $id_empresa, $limit_total);
    foreach ($ultimos_comentarios_ingresados as $comen) {
        $html_comentarios_ultimos .= file_get_contents("views/cursos/objetos/foro_cat/row_reciente.html");
        $html_comentarios_ultimos = str_replace("{NOMBRE_COMPLETO}", $comen->nombre_completo, $html_comentarios_ultimos);
        $html_comentarios_ultimos = str_replace("{COMENTARIO}", $comen->comentario, $html_comentarios_ultimos);
        $html_comentarios_ultimos = str_replace("{CATEGORIA}", $comen->valor_categoria, $html_comentarios_ultimos);
        $html_comentarios_ultimos = str_replace("{URL_PERSONA}", VerificaFotoPersonal($comen->rut), $html_comentarios_ultimos);
        $html_comentarios_ultimos = str_replace("{TIEMPO}", ($comen->fecha), $html_comentarios_ultimos);
        $tiene_megusta            = MegustaPorComentarioRut($comen->id, $rut);
        if ($comean->rut == $rut) {
            $html_comentarios_ultimos = str_replace("{BLOQUE_MEGUSTA}", file_get_contents("views/cursos/objetos/foro_cat/bloque_comentario_micomentario.html"), $html_comentarios_ultimos);
        } else {
            if ($tiene_megusta) {
                $html_comentarios_ultimos = str_replace("{BLOQUE_MEGUSTA}", file_get_contents("views/cursos/objetos/foro_cat/bloque_comentario_yamegusta.html"), $html_comentarios_ultimos);
            } else {
                $html_comentarios_ultimos = str_replace("{BLOQUE_MEGUSTA}", file_get_contents("views/cursos/objetos/foro_cat/bloque_comentario_megusta.html"), $html_comentarios_ultimos);
            }
        }
        $html_comentarios_ultimos       = str_replace("{ID_COMENTARIO_MEGUSTA}", ($comen->id), $html_comentarios_ultimos);
        $cantidad_megusta_porcomentario = MegustaPorComentario($comen->id);
        $html_comentarios_ultimos       = str_replace("{XMEGUSTA}", count($cantidad_megusta_porcomentario), $html_comentarios_ultimos);
    }
    $html      = str_replace("{LISTADO_COMENTARIOS}", utf8_encode($html_comentarios), $html);
    $html      = str_replace("{LISTADO_COMENTARIOS_RECIENTES}", utf8_encode($html_comentarios_ultimos), $html);
    $PRINCIPAL = str_replace("{BLOQUE_COMPARTE}", $html, $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaRankingTopHomeInicial($PRINCIPAL, $id_empresa, $id_malla)
{
    $limit            = 10;
    //Por default ejecuta en base a avance de la malla
    $listado_usuarios = ObtenerRankigPorAvanceMallaempresa($limit, $id_empresa, $id_malla);
    $i                = 1;
    foreach ($listado_usuarios as $unico) {
        $listado .= file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_ranking_individual_home.html");
        $listado = str_replace("{NOMBRE_COMPLETO}", $unico->nombre_completo, $listado);
        $listado = str_replace("{CARGO}", $unico->cargo, $listado);
        $listado = str_replace("{URL_PERSONA}", ColocaImagenVerificaAvatar($unico->rut), $listado);
        $listado = str_replace("{RANK}", $i, $listado);
        $listado = str_replace("{VALOR}", FormatearPorcentajes($unico->valor), $listado);
        $listado = str_replace("{medallas}", ($unico->cuentamedallas), $listado);
        $listado = str_replace("{PUNTOS_CONSOLIDADOS}", ($unico->cuentapuntos), $listado);
        $i++;
    }
    $PRINCIPAL = str_replace("{ROW_LISTADO_RANKING_Individual}", $listado, $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_LISTADO_RANKING_HOME}", $listado, $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaRankingTopHomeInicialIndividual($PRINCIPAL, $id_empresa, $id_malla)
{
    $limit            = 10;
    //Por default ejecuta en base a avance de la malla
    $listado_usuarios = ObtenerRankigPorAvanceMallaempresaIndividual($limit, $id_empresa, $id_malla);
    $i                = 1;
    foreach ($listado_usuarios as $unico) {
        $listado .= file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_ranking_individual_home.html");
        $listado = str_replace("{NOMBRE_COMPLETO}", $unico->nombre_completo, $listado);
        $listado = str_replace("{CARGO}", $unico->cargo, $listado);
        $listado = str_replace("{URL_PERSONA}", ColocaImagenVerificaAvatar($unico->rut), $listado);
        $listado = str_replace("{RANK}", $i, $listado);
        $listado = str_replace("{VALOR}", ($unico->puntos), $listado);
        $i++;
    }
    $PRINCIPAL = str_replace("{ROW_LISTADO_RANKING_Individual}", $listado, $PRINCIPAL);
    return ($PRINCIPAL);
}
function PuntosPersonalesHomeBciRev($id_empresa, $id_malla, $rut, $PRINCIPAL)
{
    $limit            = 10;
    //Por default ejecuta en base a avance de la malla
    $listado_usuarios = PuntosPersonalesHomeBciRev_data($id_empresa, $id_malla, $rut);
    $i                = 1;
    //print_r($listado_usuarios);
    foreach ($listado_usuarios as $unico) {
        $listado .= file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_ranking_individual_home.html");
        $listado = str_replace("{NOMBRE_COMPLETO}", $unico->nombre_completo, $listado);
        $listado = str_replace("{CARGO}", $unico->cargo, $listado);
        $listado = str_replace("{URL_PERSONA}", ColocaImagenVerificaAvatar($unico->rut), $listado);
        $listado = str_replace("{RANK}", $i, $listado);
        $listado = str_replace("{VALOR}", FormatearPorcentajes($unico->valor), $listado);
        $i++;
    }
    $PRINCIPAL = str_replace("{REV_MUESTRA_PUNTOS_TOTALES}", $listado, $PRINCIPAL);
    return (FormatearPorcentajes($unico->valor));
}
function ColocarBLOQUEDATOSUsuarios2($total, $id_empresa, $rut)
{
    $total                   = str_replace("{BLOQUE_DATOS_PERSONALES}", file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_mi_perfil_bloque_datos.html"), $total);
    $total                   = str_replace("{RANK}", $i, $total);
    $total                   = str_replace("{NOMBRE_COMPLETO}", $usu->nombre_completo, $total);
    $total                   = str_replace("{CARGO}", $usu->cargo, $total);
    $total                   = str_replace("{PUNTOS_CONSOLIDADOS}", $usu->puntosconsolidados, $total);
    $total                   = str_replace("{medallas}", $usu->medallas, $total);
    $total                   = str_replace("{URL_PERSONA}", ColocaImagenVerificaAvatar($usu->rut), $total);
    $total                   = str_replace("{RUT_ENCODEADO}", Encodear3($usu->rut), $total);
    $total                   = str_replace("{RUT}", ($usu->rut), $total);
    $total_imagenes_medallas = ColocaImagenesMedallas($usu->medallas, $imagen_medalla);
    $total                   = str_replace("{IMAGENMEDALLAS}", $total_imagenes_medallas, $total);
    $total                   = str_replace("{CAMPO1}", ($usu->campo1), $total);
    $total                   = str_replace("{CAMPO2}", ($usu->campo2), $total);
    $total                   = str_replace("{CAMPO3}", ($usu->campo3), $total);
    $total                   = str_replace("{NOMBRE_COMPLETO}", "hol", $total);
    return ($total);
}
function Lms_Muestra_Objetos_Comunidades($PRINCIPAL, $id_malla, $id_empresa)
{
    $Lms_Trae_Comunidades = Lms_Trae_Comunidades_Objeto_Malla_empresa($id_malla, $id_empresa);
    //print_r($Lms_Trae_Comunidades);
    if ($Lms_Trae_Comunidades) {
        foreach ($Lms_Trae_Comunidades as $Lms_Trae_Comunidad) {
            //print_r($Lms_Trae_Comunidad);
            $PRINCIPAL = ComunidadObjeto($PRINCIPAL, $Lms_Trae_Comunidad->template, $Lms_Trae_Comunidad->id_objeto, $Lms_Trae_Comunidad->numerorows, $Lms_Trae_Comunidad->orden, $Lms_Trae_Comunidad->lectura, $Lms_Trae_Comunidad->volver, $Lms_Trae_Comunidad->sinboton, $Lms_Trae_Comunidad->textoboton);
        }
    } else {
        echo "No hay objetos cargados en las comunidades";
    }
    return $PRINCIPAL;
}
function ColocaBloqueCompromisosMasVotados($PRINCIPAL, $id_objeto)
{
    //obtengo comentarios dado id_objeto
    $total_compromisos = ObtenerCompromisosDadoIdObjeto($id_objeto);
    if ($total_compromisos) {
        foreach ($total_compromisos as $comp) {
            $row_html .= file_get_contents("views/cursos/objetos/compromisos/row_reciente.html");
            $row_html = str_replace("{NOMBRE_COMPLETO}", $comp->nombre_completo, $row_html);
            $row_html = str_replace("{COMPROMISO}", $comp->compromiso, $row_html);
            $row_html = str_replace("{PA1}", $comp->pa1, $row_html);
            $row_html = str_replace("{PC1}", $comp->pc1, $row_html);
            $row_html = str_replace("{PA2}", $comp->pa2, $row_html);
            $row_html = str_replace("{PC2}", $comp->pc2, $row_html);
            $row_html = str_replace("{PA3}", $comp->pa3, $row_html);
            $row_html = str_replace("{PC3}", $comp->pc3, $row_html);
            $row_html = str_replace("{TIEMPO}", FechaTipoSpa($comp->fecha . " " . $comp->hora), $row_html);
            $row_html = str_replace("{CANTIDAD_MEGUSTA}", $comp->total_megusta, $row_html);
            $row_html = str_replace("{URL_PERSONA}", VerificaFotoPersonal($comp->rut), $row_html);
        }
        $PRINCIPAL = str_replace("{BLOQUE_COMPROMISOS_MAS_VOTADOS}", utf8_encode($row_html), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_COMPROMISOS_MAS_VOTADOS}", "", $PRINCIPAL);
    }
    return ($PRINCIPAL);
}
function ColocaCompromisosPorObjeto($id_objeto, $rut)
{
    //Veo si hay documentos por Objeto
    $compromisos        = CompromisosPorObjetosDatos($id_objeto);
    $bloque_compromisos = "";
    if ($compromisos) {
        $total = "";
        foreach ($compromisos as $unico) {
            $bloque_compromisos = file_get_contents("views/cursos/objetos/compromisos/bloque_compromiso.html");
            $bloque_compromisos = str_replace("{URL_IMAGEN_PERSONA}", VerificaFotoPersonal($unico->rut), $bloque_compromisos);
            $bloque_compromisos = str_replace("{NOMBRE}", ($unico->nombre_completo), $bloque_compromisos);
            $bloque_compromisos = str_replace("{COMPROMISO}", ($unico->compromiso), $bloque_compromisos);
            $bloque_compromisos = str_replace("{PA1}", ($unico->pa1), $bloque_compromisos);
            $bloque_compromisos = str_replace("{PC1}", ($unico->pc1), $bloque_compromisos);
            $bloque_compromisos = str_replace("{PA2}", ($unico->pa1), $bloque_compromisos);
            $bloque_compromisos = str_replace("{PC2}", ($unico->pc1), $bloque_compromisos);
            $bloque_compromisos = str_replace("{PA3}", ($unico->pa1), $bloque_compromisos);
            $bloque_compromisos = str_replace("{PC3}", ($unico->pc1), $bloque_compromisos);
            $bloque_compromisos = str_replace("{META}", ($unico->meta), $bloque_compromisos);
            $bloque_compromisos = str_replace("{PLAN}", ($unico->plan), $bloque_compromisos);
            $bloque_compromisos = str_replace("{RUT_ENCODEADO_AUTOR_COMENTARIO}", Encodear3($unico->rut), $bloque_compromisos);
            $bloque_compromisos = str_replace("{FECHA}", FechaTipoSpa($unico->fecha . " " . $unico->hora), $bloque_compromisos);
            $tiene_megusta      = MegustaPorCompromisoRut($unico->id, $rut);
            /* if($unico->rut==$rut){
            $bloque_compromisos = str_replace("{BLOQUE_MEGUSTA}",file_get_contents("views/cursos/objetos/compromisos/bloque_micompromiso.html"),$bloque_compromisos);
            }else{
            if($tiene_megusta){
            $bloque_compromisos = str_replace("{BLOQUE_MEsGUSTA}",file_get_contents("views/cursos/objetos/compromisos/bloque_yamegusta.html"),$bloque_compromisos);
            }else{
            $bloque_compromisos = str_replace("{BLOQUE_MEGUdSTA}",file_get_contents("views/cursos/objetos/compromisos/bloque_megusta.html"),$bloque_compromisos);
            }
            }
            * */
            if ($tiene_megusta) {
                $bloque_compromisos = str_replace("{BLOQUE_MEGUSTA}", file_get_contents("views/cursos/objetos/compromisos/bloque_yamegusta.html"), $bloque_compromisos);
            } else {
                $bloque_compromisos = str_replace("{BLOQUE_MEGUSTA}", file_get_contents("views/cursos/objetos/compromisos/bloque_megusta.html"), $bloque_compromisos);
            }
            $bloque_compromisos             = str_replace("{ID_COMPROMISO}", $unico->id, $bloque_compromisos);
            $bloque_compromisos             = str_replace("{ID_COMPROMISO_MEGUSTA}", $unico->id, $bloque_compromisos);
            //Verifico si este comentario ya tiene un me gusta, si ya tiene, le muestro un bloque de me gusta,
            //sino el bloque de Yamegusta
            //Veo cuantos ME GUSTA tiene este comentario
            $cantidad_megusta_porcompromiso = MegustaPorCompromiso($unico->id);
            $bloque_compromisos             = str_replace("{XMEGUSTA}", count($cantidad_megusta_porcompromiso), $bloque_compromisos);
            $total .= $bloque_compromisos;
        }
    } else {
    }
    return (utf8_encode($total));
}
function MuestraInformeEnc($PRINCIPAL, $id_encuesta, $id_empresa, $id_objeto, $id_curso)
{
    //dada la id de la encuestra, traigo las dimesiones
    $dimensiones_por_encuesta = ENC_TraigoDimensionesPorEncuesta($id_empresa, $id_encuesta);
    $html .= file_get_contents("views/encuesta/" . $id_empresa . "_template_enc_informe.html");
    foreach ($dimensiones_por_encuesta as $dimen) {
        $row .= file_get_contents("views/encuesta/" . $id_empresa . "_row_dimension_informe.html");
        $row                     = str_replace("{GRAFICO}", file_get_contents("views/encuesta/" . $id_empresa . "_barra1.html"), $row);
        $row                     = str_replace("{CODIGO_GRAFICO}", ($dimen->iddimension), $row);
        $row                     = str_replace("{NOMBRE_DIMENSION}", ($dimen->dimension), $row);
        //Por cada dimension traigo las preguntas
        $preguntas_por_dimension = ENC_TraigoPreguntaDadaDimenion($dimen->iddimension);
        $acumulador_notas        = 0;
        $acumulador_rojo         = 0;
        $acumulador_amarillo     = 0;
        $acamulador_verde        = 0;
        $acumulador_cuenta       = 0;
        $acumulador_1            = 0;
        $acumulador_2            = 0;
        $acumulador_3            = 0;
        $acumulador_4            = 0;
        $acumulador_5            = 0;
        $acumulador_6            = 0;
        $acumulador_7            = 0;
        $acumulador_T            = 0;
        //echo $dimen->dimension."<br>";
        foreach ($preguntas_por_dimension as $preg) {
            $promedio_por_preg = ENC_CuentaDeRespuestasPorPregunta7op($id_empresa, $id_encuesta, $preg->idpregunta, $id_objeto);
            //echo "<pre>";
            //print_r($promedio_por_preg);
            $acumulador_notas  = $acumulador_notas + $promedio_por_preg[0]->promedio_pregunta;
            ++$numpreg;
            $acumulador_1 = $promedio_por_preg[0]->cuenta1 + $acumulador_1;
            $acumulador_2 = $promedio_por_preg[0]->cuenta2 + $acumulador_2;
            $acumulador_3 = $promedio_por_preg[0]->cuenta3 + $acumulador_3;
            $acumulador_4 = $promedio_por_preg[0]->cuenta4 + $acumulador_4;
            $acumulador_5 = $promedio_por_preg[0]->cuenta5 + $acumulador_5;
            $acumulador_6 = $promedio_por_preg[0]->cuenta6 + $acumulador_6;
            $acumulador_7 = $promedio_por_preg[0]->cuenta7 + $acumulador_7;
            $acumulador_T = $promedio_por_preg[0]->cuentatodas + $acumulador_T;
        }
        //echo "$acumulador_1 $acumulador_2 $acumulador_3 $acumulador_4 $acumulador_5 $acumulador_6 $acumulador_7 <br>";
        $promedio_1 = round(100 * $acumulador_1 / $acumulador_T, 1);
        $promedio_2 = round(100 * $acumulador_2 / $acumulador_T, 1);
        $promedio_3 = round(100 * $acumulador_3 / $acumulador_T, 1);
        $promedio_4 = round(100 * $acumulador_4 / $acumulador_T, 1);
        $promedio_5 = round(100 * $acumulador_5 / $acumulador_T, 1);
        $promedio_6 = round(100 * $acumulador_6 / $acumulador_T, 1);
        $promedio_7 = round(100 * $acumulador_7 / $acumulador_T, 1);
        $row        = str_replace("{VALUE1}", round($promedio_1, 0), $row);
        $row        = str_replace("{VALUE2}", round($promedio_2, 0), $row);
        $row        = str_replace("{VALUE3}", round($promedio_3, 0), $row);
        $row        = str_replace("{VALUE4}", round($promedio_4, 0), $row);
        $row        = str_replace("{VALUE5}", round($promedio_5, 0), $row);
        $row        = str_replace("{VALUE6}", round($promedio_6, 0), $row);
        $row        = str_replace("{VALUE7}", round($promedio_7, 0), $row);
    }
    $html = str_replace("{LISTADO_DIMENSIONES}", ($row), $html);
    //$comentarios=ComentariosFinalesEncSatis($id_objeto, $id_empresa);
    foreach ($comentarios as $comentario) {
        $row_comentario .= file_get_contents("views/encuesta/" . $id_empresa . "_row_comentario_informe.html");
        $row_comentario = str_replace("{COMENTARIO}", ($comentario->comentario), $row_comentario);
    }
    $html      = str_replace("{LISTADO_COMENTARIOS}", ($row_comentario), $html);
    $PRINCIPAL = str_replace("{BLOQUE_ENCUESTA}", utf8_encode($html), $PRINCIPAL);
    return ($PRINCIPAL);
}
function TransformaEscalaBase100($promedio_por_dimension, $max, $min)
{
    $resto = $max - $min;
    $saldo = round(100 / $resto);
    $valor = round(($promedio_por_dimension - 1) * $saldo);
    return $valor;
}
function FinalizaObjetoFullDatos($rut, $id_objeto, $id_empresa, $nota_sugerida)
{
    //echo "<br> -  $rut, $id_objeto, $id_empresa <br>";
    $datos_objeto = DatosObjeto($id_objeto);
    //$id_curso     = $_SESSION["id_curso"];
        $id_curso = $datos_objeto[0]->id_curso;
   //print_r($datos_objeto); sleep(5);
    if (!$id_curso) {
        $id_curso = $datos_objeto[0]->id_curso;
    }
    //IngresoObjetoFinalizado($rut, $id_objeto, "", "", "", $datos_objeto[0]->id_curso);
    IngresoObjetoFinalizado($rut, $id_objeto, "", $nota_sugerida, "", $id_curso);
    //VerificaFinalizaCurso($datos_objeto[0]->id_curso, $rut);
    VerificaFinalizaCurso($id_curso, $rut);
    //$datos_siguiente_objeto=DatosObjetoDadoRutCursoyOrden($datos_objeto[0]->id_curso, $datos_objeto[0]->orden+1);
    $datos_siguiente_objeto = DatosObjetoDadoRutCursoyOrden($id_curso, $datos_objeto[0]->orden + 1);
    $id_objeto_siguiente    = $datos_siguiente_objeto[0]->id;
    //$tiene_cierre_curso=TieneInscripcionCierreDadoRutYCursoEmpresa($rut, $datos_objeto[0]->id_curso, $id_empresa);
    $tiene_cierre_curso     = TieneInscripcionCierreDadoRutYCursoEmpresa($rut, $id_curso, $id_empresa);
    if (!$tiene_cierre_curso) {
        InsertarInsripcionCierre($rut, $id_curso, $id_empresa);
    }
    //ActualizoEstadoInscripcionCierre($datos_objeto[0]->id_curso, $rut, $id_empresa);
    ActualizoEstadoInscripcionCierre($id_curso, $rut, $id_empresa);
    $tips = LeoTipsGanados($id_objeto, $id_empresa);
    ActualizoTipsGanados($id_objeto, $tips[0]->id_tip, $rut, $id_empresa);
    //$tiene_puntos=GAMIFICACIONTienePuntosPorCursoObjetoRutEmpresa($rut, $id_objeto, $datos_objeto[0]->id_curso, $id_empresa);
    $tiene_puntos = GAMIFICACIONTienePuntosPorCursoObjetoRutEmpresa($rut, $id_objeto, $id_curso, $id_empresa);
    //$tiene_puntos=GAMIFICACIONTienePuntosPorCursoObjetoRutEmpresa($rut, $id_objeto, $datos_objeto[0]->id_curso, $id_empresa);
    $tiene_puntos = GAMIFICACIONTienePuntosPorCursoObjetoRutEmpresa($rut, $id_objeto, $id_curso, $id_empresa);
    if (!$tiene_puntos) {
        //GAMIFICACIONInsertaPuntosPorObjeto($rut, $id_objeto, $datos_objeto[0]->id_curso, $id_empresa, $datos_objeto[0]->puntos);
        GAMIFICACIONInsertaPuntosPorObjeto($rut, $id_objeto, $id_curso, $id_empresa, $datos_objeto[0]->puntos);
        $tiene_puntos_acumulados = GAMIFICACIONTienePuntosAcumuladosPorRutEmpresa($rut, $id_empresa);
        if ($tiene_puntos_acumulados) {
            $suma_puntos = $tiene_puntos_acumulados[0]->puntos + $datos_objeto[0]->puntos;
            GAMIFICACIONActualizarDatosConsolidados($rut, $id_empresa, $datos_objeto[0]->puntos, $tiene_puntos_acumulados[0]->nivel);
        } else {
            GAMIFICACIONInsertaPuntosAcumulados($rut, $id_empresa, $datos_objeto[0]->puntos);
        }
    } else {
        $tiene_consolidado_puntos = GAMIFICACIONTienePuntosAcumuladosPorRutEmpresa($rut, $id_empresa);
        if ($tiene_consolidado_puntos) {
            $puntos_para_consolidado = $tiene_consolidado_puntos[0]->puntos;
            GAMIFICACIONActualizarDatosConsolidados($rut, $id_empresa, $puntos_para_consolidado + $datos_objeto[0]->puntos, $tiene_consolidado_puntos[0]->nivel, $medallas);
        } else {
            GAMIFICACIONInsertaPuntosAcumulados($rut, $id_empresa, $puntos_para_consolidado, $tiene_consolidado_puntos[0]->nivel, $medallas);
        }
    }
    if (!$id_objeto_siguiente) {
        $datos_malla = CAPACITACION_malla_porUsuario($rut);
        GAMIFICACION_ActualizaNivelVersion2($datos_malla[0]->id_malla, $id_empresa, $rut);
    }
}
function ColocaListadoParticipantesPorcurso($PRINCIPAL, $id_curso, $id_empresa)
{
    //$listadp_participantes=ListadoParticipantesDadoCursiEmpresa($id_curso, $id_empresa);
    $listadp_participantes = ListadoParticipantesDadoCursiEmpresaSinRelator($id_curso, $id_empresa);
    $datos_usuario         = UsuarioEnBasePersonas($_SESSION["user_"]);
    $PRINCIPAL             = str_replace("{NOMBRE_USUARIO}", utf8_encode($datos_usuario[0]->nombre_completo), $PRINCIPAL);
    foreach ($listadp_participantes as $unico) {
        $row .= file_get_contents("views/cursos/objetos/check/row_listado_participantes.html");
        $row = str_replace("{NOMBRE}", $unico->nombre_completo, $row);
        $row = str_replace("{CARGO}", $unico->cargo, $row);
        $row = str_replace("{URL_MIPERFIL}", VerificaFotoPersonal($unico->rut), $row);
    }
    $PRINCIPAL = str_replace("{LISTADO_USUARIOS}", utf8_encode($row), $PRINCIPAL);
    $PRINCIPAL = str_replace("{CODIGO_CURSO_ENCODEADO}", Encodear3($id_curso), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaListadoParticipantesPorinscripcion($PRINCIPAL, $id_inscripcion, $id_empresa)
{
    //$listadp_participantes=ListadoParticipantesDadoCursiEmpresa($id_curso, $id_empresa);
    //$listadp_participantes=ListadoParticipantesDadoCursiEmpresaSinRelator($id_curso, $id_empresa);
    //echo "<br>$id_inscripcion, $id_empresa";
    $listadp_participantes = ListadoParticipantesDadoInscripcionEmpresaSinRelator($id_inscripcion, $id_empresa);
    $datos_usuario         = UsuarioEnBasePersonas($_SESSION["user_"]);
    $PRINCIPAL             = str_replace("{NOMBRE_USUARIO}", utf8_encode($datos_usuario[0]->nombre_completo), $PRINCIPAL);
    foreach ($listadp_participantes as $unico) {
        $row .= file_get_contents("views/cursos/objetos/check/row_listado_participantes.html");
        $row = str_replace("{NOMBRE}", $unico->nombre_completo, $row);
        $row = str_replace("{CARGO}", $unico->cargo, $row);
        $row = str_replace("{URL_MIPERFIL}", VerificaFotoPersonal($unico->rut), $row);
    }
    $PRINCIPAL = str_replace("{LISTADO_USUARIOS}", utf8_encode($row), $PRINCIPAL);
    $PRINCIPAL = str_replace("{CODIGO_CURSO_ENCODEADO}", Encodear3($id_curso), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaObjetosDadoCurso($PRINCIPAL, $id_curso, $id_empresa, $rut)
{
    //dado el curso, traigo los objetos
    //echo $id_empresa;
    //$objetos=TraeObjetosDadoCursoCheck($id_curso, $id_empresa);
    $objetos          = ObjetosDadoCurso($id_curso, $rut);
    //verifico los datos para este usuario y para este curso
    $usuario_en_curso = CI_verificausuariocurso($rut, $id_curso, $id_empresa);
    foreach ($objetos as $ob) {
        $row .= file_get_contents("views/checkin/CI_row_entorno_home_actividades.html");
        if ($usuario_en_curso[0]->relator == 1) {
            $row = str_replace("{NOMBRE}", $ob->titulo_relator, $row);
        } else {
            $row = str_replace("{NOMBRE}", $ob->titulo, $row);
        }
        $row = str_replace("{IMAGEN}", $ob->imagen, $row);
        if ($ob->extension_objeto == 11) {
            $total_archivos = TodasFotosPorObjetoEmpresa($ob->id, $id_empresa);
            $row            = str_replace("{PARTICIPANTES}", count($total_archivos), $row);
        } else if ($ob->id_encuesta) {
            //veo el total de finalizados dado el id de la encuesta
            $total_finalizados_encuesta = VerificoEncuestaFinalizadaCheckin($ob->id_encuesta, $ob->id, $id_empresa);
            $row                        = str_replace("{PARTICIPANTES}", count($total_finalizados_encuesta), $row);
        } else if ($ob->extension_objeto == 9) {
            //veo el total de finalizados dado el id de la encuesta
            $total_comentarios = TotalComentariosDadoIdObjetoEmpresa($ob->id);
            $row               = str_replace("{PARTICIPANTES}", count($total_comentarios), $row);
        } else if ($ob->extension_objeto == 18) {
            //veo el total de finalizados dado el id de la encuesta
            $total_preguntas = TotalPreguntasDadoIdObjetoEmpresa($ob->id);
            $row             = str_replace("{PARTICIPANTES}", $total_preguntas[0]->cuenta, $row);
        } else if ($ob->tipo_de_objeto == 8) {
            //veo el total de finalizados dado el id de la encuesta
            $total_participantes = ListadoParticipantesDadoCursiEmpresaSinRelator($ob->id_curso, $id_empresa);
            $row                 = str_replace("{PARTICIPANTES}", count($total_participantes), $row);
        } else if ($ob->tipo_de_objeto == 10) {
            //veo el total de finalizados dado el id de la encuesta
            $total_mensajes = TotalMensajerPorObjetoMensajeria($ob->id);
            $row            = str_replace("{PARTICIPANTES}", count($total_mensajes), $row);
        } else {
            $row = str_replace("{PARTICIPANTES}", "-", $row);
        }
        if ($ob->id_evaluacion) {
            if ($usuario_en_curso[0]->relator == 1) {
                $row = str_replace("{AMBIENTE}", $ob->ambiente, $row);
            } else {
                $row = str_replace("{AMBIENTE}", "intro_eval", $row);
            }
        } else {
            $row = str_replace("{AMBIENTE}", $ob->ambiente, $row);
        }
        $row = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($ob->id), $row);
        $row = str_replace("{ID_CURSO_ENCODEADO}", Encodear3($id_curso), $row);
        $row = str_replace("{ID_ENCUESTA_ENCODEADO}", Encodear3($ob->id_encuesta), $row);
    }
    $PRINCIPAL = str_replace("{LISTADO_OBJETOS_CHECKIN}", utf8_encode($row), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaObjetosDadoImparticion($PRINCIPAL, $id_inscripcion, $id_empresa, $rut)
{
    //echo "$id_inscripcion";
    //dado el curso, traigo los objetos
    //echo $id_empresa;
    //$objetos=TraeObjetosDadoCursoCheck($id_curso, $id_empresa);
    $objetos          = ObjetosDadoInscripcion($id_inscripcion, $rut);
    //verifico los datos para este usuario y para este curso
    $usuario_en_curso = CI_verificausuariocurso($rut, $id_inscripcion, $id_empresa);
    //print_r($usuario_en_curso);
    foreach ($objetos as $ob) {
        $row .= file_get_contents("views/checkin/CI_row_entorno_home_actividades.html");
        if ($usuario_en_curso[0]->relator == 1) {
            $row = str_replace("{NOMBRE}", $ob->titulo_relator, $row);
        } else {
            $row = str_replace("{NOMBRE}", $ob->titulo, $row);
        }
        $row = str_replace("{IMAGEN}", $ob->imagen, $row);
        if ($ob->extension_objeto == 11) {
            $total_archivos = TodasFotosPorObjetoEmpresa($ob->id, $id_empresa);
            $row            = str_replace("{PARTICIPANTES}", count($total_archivos), $row);
        } else if ($ob->id_encuesta) {
            //veo el total de finalizados dado el id de la encuesta
            $total_finalizados_encuesta = VerificoEncuestaFinalizadaCheckin($ob->id_encuesta, $ob->id, $id_empresa);
            $row                        = str_replace("{PARTICIPANTES}", count($total_finalizados_encuesta), $row);
        } else if ($ob->extension_objeto == 9) {
            //veo el total de finalizados dado el id de la encuesta
            $total_comentarios = TotalComentariosDadoIdObjetoEmpresa($ob->id);
            $row               = str_replace("{PARTICIPANTES}", count($total_comentarios), $row);
        } else if ($ob->extension_objeto == 18) {
            //veo el total de finalizados dado el id de la encuesta
            $total_preguntas = TotalPreguntasDadoIdObjetoEmpresa($ob->id);
            $row             = str_replace("{PARTICIPANTES}", $total_preguntas[0]->cuenta, $row);
        } else if ($ob->tipo_de_objeto == 8) {
            //veo el total de finalizados dado el id de la encuesta
            $total_participantes = ListadoParticipantesDadoInscripcionEmpresaSinRelator($ob->id_curso, $id_empresa);
            $row                 = str_replace("{PARTICIPANTES}", count($total_participantes), $row);
        } else if ($ob->tipo_de_objeto == 10) {
            //veo el total de finalizados dado el id de la encuesta
            $total_mensajes = TotalMensajerPorObjetoMensajeria($ob->id);
            $row            = str_replace("{PARTICIPANTES}", count($total_mensajes), $row);
        } else {
            $row = str_replace("{PARTICIPANTES}", "-", $row);
        }
        if ($ob->id_evaluacion) {
            if ($usuario_en_curso[0]->relator == 1) {
                //    echo "hola1";exit();
                $row = str_replace("{AMBIENTE}", $ob->ambiente, $row);
            } else {
                $row = str_replace("{AMBIENTE}", "intro_eval", $row);
                //    echo "hola2";exit();
            }
        } else {
            //echo "hola3";exit();
            $row = str_replace("{AMBIENTE}", $ob->ambiente, $row);
        }
        $row = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($ob->id), $row);
        $row = str_replace("{ID_CURSO_ENCODEADO}", Encodear3($id_curso), $row);
        $row = str_replace("{ID_ENCUESTA_ENCODEADO}", Encodear3($ob->id_encuesta), $row);
        $row = str_replace("{CODIGO_INSCRIPCION_ENCODEADO}", Encodear3($id_inscripcion), $row);
    }
    $PRINCIPAL = str_replace("{LISTADO_OBJETOS_CHECKIN}", utf8_encode($row), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ConsultaWebService($rut, $id_objeto, $verifica)
{
    $id_empresa      = $_SESSION["id_empresa"];
    $datos_objeto    = DatosObjeto($id_objeto);
    $datos_usuario   = UsuarioEnBasePersonas($rut);
    $link_webservice = utf8_encode($datos_objeto[0]->llamada_webservice);
    //$datos_usuario[0]->email="pamela.bizama@bci.cl";
    $link_webservice = str_replace("{CORREO}", $datos_usuario[0]->email, $link_webservice);
    //print_r($link_webservice);
    $JsonSource      = $link_webservice;
    $json            = json_decode(file_get_contents($JsonSource));
    $status          = $json->info->status;
    $resultado       = $json->info->resutl;
    //$status="OK";
    //$status="ERROR";
    if ($verifica == 1) {
        if ($id_objeto == "br_m1c5m5") {
            $status = "OK";
        }
        ;
        if ($id_objeto == "br_m1c5m6") {
            $status = "OK";
        }
        ;
        if ($id_objeto == "br_m2m29") {
            $status = "OK";
        }
        ;
        if ($id_objeto == "br_m2m30") {
            $status = "OK";
        }
        ;
    }
    if ($status == "OK" or $id_objeto == "br_m1c1m3") {
        /*$tiene_punto_objeto=GAMIFICACIONTienePuntosPorCursoObjetoRutEmpresa($rut, $id_objeto, $datos_objeto[0]->id_curso, $_SESSION["id_empresa"]);
        if($tiene_punto_objeto){
        $objeto_finalizado=ObjetoFinalizadoDadoIdYRut($rut ,$id_objeto);
        if(!$objeto_finalizado){
        IngresoObjetoFinalizado($rut, $id_objeto, "", "", "", $datos_objeto[0]->id_curso);
        VerificaFinalizaCurso($datos_objeto[0]->id_curso, $rut);
        CAPACITACIONActualizarDatosCierre($id_curso, $rut, $_SESSION["id_empresa"], "");
        }
        }else{
        if($datos_objeto[0]->gamificado==1){
        IngresoObjetoFinalizado($rut, $id_objeto, $tiempo_navegado, "", "", $datos_objeto[0]->id_curso);
        VerificaFinalizaCurso($datos_objeto[0]->id_curso, $rut);
        }
        }
        */
        FinalizaObjetoFullDatos($rut, $id_objeto, $id_empresa);
        $bloque_finalizado = file_get_contents("views/cursos/objetos/WebService/bloqueRealizado.html");
        $arreglo[0]        = $bloque_finalizado;
    } else {
        if ($verifica == 1) {
            //$bloque_finalizado.=file_get_contents("views/cursos/objetos/WebService/bloqueError.html");
            //Inserto registro en tabla de objetos no finalizados
            InsertaRegistroTblRegistrosNofinalizados($rut, $id_empresa, $id_malla, $datos_objeto[0]->id_curso, $id_objeto);
            $bloque_finalizado .= file_get_contents("views/cursos/objetos/WebService/bloqueNoRealizadoConAlert.html");
            $bloque_finalizado = str_replace("{ID_CURSO_ENCODEADO}", Encodear3($datos_objeto[0]->id_curso), $bloque_finalizado);
        } else {
            $bloque_finalizado .= file_get_contents("views/cursos/objetos/WebService/bloqueNoRealizado.html");
        }
        //$bloque_finalizado = str_replace("{URL}",$link_webservice,$bloque_finalizado);
        $arreglo[0] = $bloque_finalizado;
    }
    return ($arreglo);
}
function ObtenerDatosMoodle($arreglo_datos_curso, $HTML, $bloque, $id_scorm, $rut_usuario)
{
    if ($rut_usuario) {
        $datos_usuario = UsuarioEnBasePersonas($rut_usuario);
    } else {
        $datos_usuario = UsuarioEnBasePersonas($_SESSION["user_"]);
    }
    $userid_moodle = $datos_usuario[0]->userid_moodle;
    $id_curso      = $arreglo_datos_curso->id_curso;
    //$id_scorm=$arreglo_datos_curso->id_scorm;
    $link2         = mysql_connect("gopartners.cl", "gopartne_moodle", "GMknehSNTpSR");
    mysql_select_db("gopartne_moodle26", $link2);
    $sql2                 = "SELECT * FROM mdl_scorm_scoes where scorm='$id_scorm' and scormtype='sco'";
    //echo $sql2;
    $result2              = mysql_query($sql2, $link2);
    //esta correspnde a la cantidad de modulos por ese scorm
    $cantidad_scorm       = mysql_num_rows($result2);
    //echo $cantidad_scorm;echo "<br>";
    //$sql3="select * from mdl_scorm_scoes_track where userid='$userid_moodle' and value>='0' and value <='100' and scormid='$id_scorm'";
    //$sql3="select * from mdl_scorm_scoes_track where userid='$userid_moodle' and value='completed'   and scormid='$id_scorm'";
    $sql3                 = "select * from mdl_scorm_scoes_track where userid='$userid_moodle' and (value='completed' or value='passed' or value='failed')  and scormid='$id_scorm'";
    //echo "<br>";
    //echo $sql3;
    //exit;
    $result3              = mysql_query($sql3, $link2);
    $cantidad_finalizados = mysql_num_rows($result3);
    //echo $cantidad_finalizados;exit;
    //PORCENTAJE DE AVANCE
    $porcentaje_avance    = round(($cantidad_finalizados * 100) / $cantidad_scorm);
    //porcentaje de avance
    $arreglo[0]           = $porcentaje_avance;
    //echo $porcentaje_avance."<br><br>";
    //Ahora obtengo la nota mas alta
    $sql4                 = "select *  from mdl_scorm_scoes_track where userid='$userid_moodle' and element='cmi.core.score.raw' and scormid='$id_scorm' order by value desc limit 1";
    $result4              = mysql_query($sql4, $link2);
    while ($row = mysql_fetch_array($result4)) {
        $nota = $row['value'];
    }
    //devuelvo la nota
    $arreglo[1]      = $nota;
    //devuelvo el total de modulos
    $arreglo[2]      = $cantidad_scorm;
    //devuelvo el total de finalizados
    $arreglo[3]      = $cantidad_finalizados;
    $HTML            = str_replace("{TOTAL_MODULOS}", $arreglo[2], $HTML);
    $HTML            = str_replace("{TOTAL_MODULOS_PENDIENTES}", $arreglo[2] - $arreglo[3], $HTML);
    $HTML            = str_replace("{TOTAL_MODULOS_FINALIZADOS}", $arreglo[3], $HTML);
    $HTML            = str_replace("{NOTA_OBTENIDA}", $arreglo[1], $HTML);
    $arreglo[4]      = $HTML;
    $row_curso_nivel = file_get_contents("views/cursos/capacitacion/" . $_SESSION["id_empresa"] . "_row_bloque_niveles_curso.html");
    $row_curso_nivel = str_replace("{TOTAL_MODULOS_PENDIENTES}", $arreglo[2] - $arreglo[3], $row_curso_nivel);
    $row_curso_nivel = str_replace("{TOTAL_MODULOS_FINALIZADOS}", $arreglo[3], $row_curso_nivel);
    $row_curso_nivel = str_replace("{NOMBRE_CURSO_MOODLE}", utf8_encode($arreglo_datos_curso->nombre_curso), $row_curso_nivel);
    $arreglo[5]      = $row_curso_nivel;
    return ($arreglo);
}
function MPColocaOtrasPracticas($id_mp, $tipo, $id_empresa, $limit)
{
    //trae el total de interacciones por mp
    $total_practicas_leidas = MPOtrasPracticas($id_mp, $tipo, $id_empresa, $limit);
    //echo "<br>$id_mp, $tipo, $id_empresa, $limit<br>";
    //print_r($total_practicas);
    if ($total_practicas_leidas) {
        foreach ($total_practicas_leidas as $total_practica) {
            $total_practicas .= file_get_contents("views/mejorespracticas/mp_row_otraspracticas.html");
            $total_practicas = str_replace("{NOMBRE_PRACTICA}", $total_practica->nombre, $total_practicas);
            $total_practicas = str_replace("{ID_MP}", $total_practica->id_mp, $total_practicas);
            $total_practicas = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($total_practica->rut), $total_practicas);
            $datos_usuario   = UsuarioEnBasePersonas($total_practica->rut);
            $total_practicas = str_replace("{NOMBRE_AUTOR}", $datos_usuario[0]->nombre_completo, $total_practicas);
            //$total_practicas = str_replace("{LINK}",VerificaFotoPersonal($total_practica->rut),$total_practicas);
        }
    } else {
        $total_practicas = "No existen pr&aacute;cticas";
    }
    //print_r($total_practicas);
    //$PRINCIPAL = str_replace("{INTERACCIONES}",$listado_interacciones,$PRINCIPAL);
    return (utf8_encode($total_practicas));
}
function MPColocaPreguntasPracticas($id_empresa, $limit)
{
    $total_practicas_leidas = MPPreguntas($id_empresa, $limit);
    //echo "<br>$id_empresa, $limit<br>";
    //print_r($total_practicas);
    if ($total_practicas_leidas) {
        foreach ($total_practicas_leidas as $total_practica) {
            $total_practicas .= file_get_contents("views/mejorespracticas/mp_row_preguntaspracticas.html");
            $total_practicas = str_replace("{NOMBRE_PRACTICA}", $total_practica->pregunta, $total_practicas);
            $total_practicas = str_replace("{ID_MP}", $total_practica->id_mp, $total_practicas);
            $total_practicas = str_replace("{RUT_AUTOR}", $total_practica->autor_pregunta, $total_practicas);
            $total_practicas = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($total_practica->autor_pregunta), $total_practicas);
            $datos_usuario   = UsuarioEnBasePersonas($total_practica->autor_pregunta);
            $total_practicas = str_replace("{NOMBRE_AUTOR}", $datos_usuario[0]->nombre_completo, $total_practicas);
            //$total_practicas = str_replace("{LINK}",VerificaFotoPersonal($total_practica->rut),$total_practicas);
        }
    } else {
        $total_practicas = "No existen preguntas";
    }
    //$PRINCIPAL = str_replace("{INTERACCIONES}",$listado_interacciones,$PRINCIPAL);
    return (utf8_encode($total_practicas));
}
function MPColocaBloqueInteracciones($id_mp, $id_empresa, $pdf)
{
    //trae el total de interacciones por mp
    $total_interacciones = MPTotalInteraccionesPorMP($id_mp, $id_empresa);
    if ($total_interacciones) {
        foreach ($total_interacciones as $tot) {
            if ($pdf == "pdf") {
                $listado_interacciones .= file_get_contents("views/mejorespracticas/mp_interaccion_ingresada_pdf.html");
            } else {
                $listado_interacciones .= file_get_contents("views/mejorespracticas/mp_interaccion_ingresada.html");
            }
            $listado_interacciones = str_replace("{NOMBRE_COMPLETO}", $tot->nombre_completo, $listado_interacciones);
            $listado_interacciones = str_replace("{COMENTARIO}", $tot->contenido, $listado_interacciones);
            $listado_interacciones = str_replace("{TIEMPO}", formatearFechaCompleta($tot->fecha), $listado_interacciones);
            $listado_interacciones = str_replace("{URL_PERSONA}", VerificaFotoPersonal($tot->rut), $listado_interacciones);
        }
    } else {
        $total_interacciones = "No existen interacciones";
    }
    //$PRINCIPAL = str_replace("{INTERACCIONES}",$listado_interacciones,$PRINCIPAL);
    return (utf8_encode($listado_interacciones));
}
function MPColocaBloqueComentario($id_mp, $id_empresa, $rut)
{
    //echo "$id_mp, $id_empresa, $rut";
    $html          = file_get_contents("views/mejorespracticas/mp_interaccion_comentario.html");
    $html          = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($rut), $html);
    $datos_usuario = UsuarioEnBasePersonas($rut);
    //print_r($datos_usuario);
    //echo "nombre ".$datos_usuario[0]->nombre_completo;
    $html          = str_replace("{NOMBRE_AUTOR}", $datos_usuario[0]->nombre_completo, $html);
    $html          = str_replace("{ID_MP_ENCODEADO}", Encodear3($id_mp), $html);
    return ($html);
}
function SubirArchivosGenericos($FILES, $extension_doc, $prefijo, $ruta, $numero, $nombre_file)
{
    //echo "$extension_archivo, $prefijo, $ruta";exit;
    //$ruta_con_archivo=$ruta."/".$prefijo."_BK.".$extension_archivo;
    $ruta_con_archivo = $ruta . "/" . $prefijo . "." . $extension_doc;
    copy($FILES[$nombre_file]['tmp_name'], $ruta_con_archivo);
    $nombre_imagen_video = $prefijo . "." . $extension_doc;
    //RedimensionarImagenSlider($ruta_con_archivo, $nombre_imagen_slider);
    //Devuelvol un arreglo, con datos del archivo subido
    $arreglo[0]          = $ruta_con_archivo; //Ruta Completa
    $arreglo[1]          = $prefijo . "." . $extension_doc; //Nombre del Archivo
    $arreglo[2]          = $ruta . "/" . $prefijo; //Ruta del Objeto sin el index
    return ($arreglo);
}
function SubirImagenfondo($FILES, $extension_doc, $prefijo, $ruta, $numero)
{
    //echo "$extension_archivo, $prefijo, $ruta";exit;
    //$ruta_con_archivo=$ruta."/".$prefijo."_BK.".$extension_archivo;
    $ruta_con_archivo = $ruta . "/" . $prefijo . "." . $extension_doc;
    copy($FILES['imagen_fondo']['tmp_name'], $ruta_con_archivo);
    $nombre_imagen_video = $prefijo . "." . $extension_doc;
    //RedimensionarImagenSlider($ruta_con_archivo, $nombre_imagen_slider);
    //Devuelvol un arreglo, con datos del archivo subido
    $arreglo[0]          = $ruta_con_archivo; //Ruta Completa
    $arreglo[1]          = $prefijo . "." . $extension_doc; //Nombre del Archivo
    $arreglo[2]          = $ruta . "/" . $prefijo; //Ruta del Objeto sin el index
    return ($arreglo);
}
function SubirArchivos($FILES, $extension_doc, $prefijo, $ruta, $numero)
{
    //echo "$extension_archivo, $prefijo, $ruta";exit;
    //$ruta_con_archivo=$ruta."/".$prefijo."_BK.".$extension_archivo;
    $ruta_con_archivo = $ruta . "/" . $prefijo . "." . $extension_doc;
    copy($FILES['archivo'.$numero]['tmp_name'], $ruta_con_archivo);
    $nombre_imagen_video = $prefijo . "." . $extension_doc;
    //RedimensionarImagenSlider($ruta_con_archivo, $nombre_imagen_slider);
    //Devuelvol un arreglo, con datos del archivo subido
    $arreglo[0]          = $ruta_con_archivo; //Ruta Completa
    $arreglo[1]          = $prefijo . "." . $extension_doc; //Nombre del Archivo
    $arreglo[2]          = $ruta . "/" . $prefijo; //Ruta del Objeto sin el index
    return ($arreglo);
}
function SubirArchivos2($FILES, $extension_doc, $prefijo, $ruta, $numero)
{
    //echo "$extension_archivo, $prefijo, $ruta";exit;
    //$ruta_con_archivo=$ruta."/".$prefijo."_BK.".$extension_archivo;
    $ruta_con_archivo = $ruta . "/" . $prefijo . "." . $extension_doc;
    copy($FILES['archivo2']['tmp_name'], $ruta_con_archivo);
    $nombre_imagen_video = $prefijo . "." . $extension_doc;
    //RedimensionarImagenSlider($ruta_con_archivo, $nombre_imagen_slider);
    //Devuelvol un arreglo, con datos del archivo subido
    $arreglo[0]          = $ruta_con_archivo; //Ruta Completa
    $arreglo[1]          = $prefijo . "." . $extension_doc; //Nombre del Archivo
    $arreglo[2]          = $ruta . "/" . $prefijo; //Ruta del Objeto sin el index
    return ($arreglo);
}
function EnviarCorreosCial($evaluador, $tipo, $evaluado)
{
    $tipo_correo     = ObtengoTipoCorreo($tipo);
    $datos_evaluador = UsuarioEnBasePersonas($evaluador);
    $datos_evaluado  = UsuarioEnBasePersonas($evaluado);
    $plantilla       = $tipo_correo[0]->texto;
    $plantilla       = str_replace("{NOMBRE_EVALUADOR}", htmlentities($datos_evaluador[0]->nombre_completo), $plantilla);
    $plantilla       = str_replace("{NOMBRE_EVALUADO}", htmlentities($datos_evaluado[0]->nombre_completo), $plantilla);
    //echo $plantilla;
    $mail            = new PHPMailer;
    //Set who the message is to be sent from
    $mail->setFrom($tipo_correo[0]->from_correo, $tipo_correo[0]->from);
    //Set an alternative reply-to address
    //$mail->addReplyTo('replyto@example.com', 'First Last');
    //Set who the message is to be sent to
    //$mail->addAddress($datos_usuario[0]->email, $datos_usuario[0]->nombre_completo);
    //$mail->addAddress('Jaime.Roca@cialalimentos.cl', $datos_usuario[0]->nombre_completo);
    //$mail->addAddress('rod@gop.cl', $datos_usuario[0]->nombre_completo);
    $mail->addAddress('daniel@gop.cl', $datos_usuario[0]->nombre_completo);
    $mail->AddBCC("backup@sgd.cl", "BCC: " . $datos_usuario[0]->nombre_completo);
    //Set the subject line
    $mail->Subject = $tipo_correo[0]->titulo;
    //Read an HTML message body from an external file, convert referenced images to embedded,
    //convert HTML into a basic plain-text alternative body
    $mail->msgHTML($plantilla, dirname(__FILE__));
    //Replace the plain text body with one created manually
    $mail->AltBody = 'Alt Body';
    //Attach an image file
    //$mail->addAttachment('img/Prop_Intranet_TNT.docx');
    //send the message, check for errors
    if (!$mail->send()) {
        echo "Mailer Error: " . $mail->ErrorInfo;
    } else {
        //echo "Message sent!";
    }
    //exit;
}
function ConectaLDAP($user, $pass, $dominio)
{
    // ejemplo de autenticación
    $ldaprdn  = $user . '@' . $dominio; // ldap rdn or dn
    $ldappass = $pass; // associated password
    //echo "user:". $ldaprdn;
    //echo "<br>";
    //echo "pass:". $ldappass;
    //exit;
    // conexiÃ³n al servidor LDAP
    if ($dominio == "cl.minvest.net") {
        $ldapconn = ldap_connect("172.26.22.5") or die("Could not connect to LDAP server.");
    } else if ($dominio == "gildemeister.local") {
        $ldapconn = ldap_connect("193.9.200.120") or die("Could not connect to LDAP server.");
    }
    if ($ldapconn) {
        // realizando la autenticaciÃ³n
        $ldapbind = ldap_bind($ldapconn, $ldaprdn, $ldappass);
        // verificaciÃ³n del enlace
        if ($ldapbind) {
            // echo "LDAP bind successful...";
            return ("si");
        } else {
            // echo "LDAP bind failed...";
            return ("no");
        }
    }
}
function encryptMoodleAula($string, $key)
{
    $key    = "fb22a3635eaae749279313c23bc40429";
    $result = '';
    for ($i = 0; $i < strlen($string); $i++) {
        $char    = substr($string, $i, 1);
        $keychar = substr($key, ($i % strlen($key)) - 1, 1);
        $char    = chr(ord($char) + ord($keychar));
        $result .= $char;
    }
    return base64_encode($result);
}
function ColocaPreguntaConcurso($PRINCIPAL, $id_empresa, $rut)
{
    $PRINCIPAL             = str_replace("{RUT}", Encodear3($rut), $PRINCIPAL);
    $datos_pregunta_activa = TraePreguntaActivaConcurso($id_empresa);
    $PRINCIPAL             = str_replace("{PREGUNTA_ACTIVA}", utf8_encode($datos_pregunta_activa[0]->pregunta), $PRINCIPAL);
    $PRINCIPAL             = str_replace("{ID_PREGUNTA}", Encodear3($datos_pregunta_activa[0]->id), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaAvanceDadoMP($PRINCIPAL, $id_mp, $rut, $id_empresa)
{
    $avance_mp    = DatosMPDadoId($id_mp);
    $participants = MP_UsuariosPorMPYUsuario($id_empresa, $id_mp);
    if (count($participants) > 0) {
        $PRINCIPAL = str_replace("{PORCENTAJE_AVANCE_MP}", "100", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ACTIVE_PASO4}", ' class="active"', $PRINCIPAL);
    } else if ($avance_mp[0]->contenido && $avance_mp[0]->tag) {
        $PRINCIPAL = str_replace("{PORCENTAJE_AVANCE_MP}", "75", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ACTIVE_PASO4}", ' class="active"', $PRINCIPAL);
    } else if ($avance_mp[0]->nombre) {
        $PRINCIPAL = str_replace("{PORCENTAJE_AVANCE_MP}", "50", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ACTIVE_PASO3}", ' class="active"', $PRINCIPAL);
    } else if ($avance_mp[0]->id_categoria) {
        $PRINCIPAL = str_replace("{PORCENTAJE_AVANCE_MP}", "25", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ACTIVE_PASO2}", ' class="active"', $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{PORCENTAJE_AVANCE_MP}", "0", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ACTIVE_PASO1}", ' class="active"', $PRINCIPAL);
    }
    return ($PRINCIPAL);
}
function ListadoMejoresPracticas($PRINCIPAL, $id_empresa, $rut, $ord_by, $filt_by, $filt_cat, $vp)
{
    $todas         = MPObtengoTodasDadoRut($id_empresa, $rut, $ord_by, $filt_by, $filt_cat, $vp);
    $total_listado = "";
    //echo "<pre>";
    //print_r($todas);
    foreach ($todas as $unico) {
        //echo $unico->id_estado;
        if ($unico->id_estado == 1 or $unico->id_estado == 4 or $unico->id_estado == 6) {
            $link_MP = "PrevMejPrac";
        } else {
            $link_MP = "VistaMejPrac";
        }
        $total_listado .= file_get_contents("views/mejorespracticas/mp_row_listado.html");
        $total_listado = str_replace("{ID_MP}", $unico->id_mp, $total_listado);
        $total_listado = str_replace("{LINK}", $link_MP, $total_listado);
        $total_listado = str_replace("{CATEGORIA_MP}", ($unico->categoria), $total_listado);
        $total_listado = str_replace("{DESCRIPCION_CATEGORIA}", utf8_encode($unico->descripcion_categoria), $total_listado);
        $total_listado = str_replace("{NOMBRE}", ($unico->nombre), $total_listado);
        $total_listado = str_replace("{CONTENIDO}", limit_text($unico->contenido, 25), $total_listado);
        $total_listado = str_replace("{FECHA}", formatearFechaSmall($unico->fecha), $total_listado);
        $total_listado = str_replace("{ESTADO}", ($unico->estado), $total_listado);
        $total_listado = str_replace("{DESCRIPCION_ESTADO}", ($unico->descripcion_estado), $total_listado);
        $total_listado = str_replace("{RUT_AUTOR}", ($unico->rut), $total_listado);
        $total_listado = str_replace("{NOMBRE_AUTOR}", ($unico->nombre_autor), $total_listado);
        $total_listado = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($unico->rut), $total_listado);
        $total_listado = str_replace("{NUMVISITAS}", round($unico->numvisitas), $total_listado);
        $total_listado = str_replace("{NUMMEGUSTA}", ($unico->nummegusta), $total_listado);
        $total_listado = str_replace("{NUMCOMPARTIDA}", ($unico->numcompartido), $total_listado);
        $total_listado = str_replace("{NUMCOMENTARIO}", ($unico->numcomentarios), $total_listado);
        $total_listado = str_replace("{ESTILOESTADO}", ($unico->estilo), $total_listado);
        $total_listado = str_replace("{ICONOESTADO}", ($unico->icono_estado), $total_listado);
        $total_listado = str_replace("{ESTILOCATEGORIA}", ($unico->style), $total_listado);
        $total_listado = str_replace("{ICONOCATEGORIA}", ($unico->icono), $total_listado);
        $total_listado = str_replace("{CATEGORIA_MP}", ($unico->categoria), $total_listado);
    }
    $agrup_categorias      = MPObtengoCategoriasNumero($id_empresa);
    $total_agrup_categoria = "";
    foreach ($agrup_categorias as $agrup_categoria) {
        $total_agrup_categoria .= file_get_contents("views/mejorespracticas/mp_row_agrupacion_categoria_ambito.html");
        $total_agrup_categoria = str_replace("{ITEM}", ($agrup_categoria->categoria), $total_agrup_categoria);
        $total_agrup_categoria = str_replace("{NUM}", ($agrup_categoria->cuenta), $total_agrup_categoria);
        $link_cat_amb          = "?sw=listMejPrac&ord_by=" . $ord_by . "&filt_cat=cat-" . $agrup_categoria->id_categoria . "#lista";
        $total_agrup_categoria = str_replace("{LINK}", $link_cat_amb, $total_agrup_categoria);
        //    echo $agrup_categoria->categoria;
    }
    $limit                           = 3;
    $listado_mas                     = MPObtengoMasInteracciones($id_empresa, "MASPARTICIPATIVO", $limit);
    $total_listado_mas_participativo = "";
    foreach ($listado_mas as $listado_mas_unico) {
        $total_listado_mas_participativo .= file_get_contents("views/mejorespracticas/mp_row_participantes_mas.html");
        $datos_usuario                   = UsuarioEnBasePersonas($listado_mas_unico->rut);
        $total_listado_mas_participativo = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($listado_mas_unico->rut), $total_listado_mas_participativo);
        $total_listado_mas_participativo = str_replace("{NOMBRE_AUTOR}", ($datos_usuario[0]->nombre_completo), $total_listado_mas_participativo);
        $total_listado_mas_participativo = str_replace("{NUM}", ($listado_mas_unico->cuenta), $total_listado_mas_participativo);
        $total_listado_mas_participativo = str_replace("{NUMTEXT}", " Interacciones", $total_listado_mas_participativo);
        $link                            = "?sw=listMejPrac&filt_by=" . $datos_usuario[0]->rut . "&vp=1#lista";
        $total_listado_mas_participativo = str_replace("{LINK}", $link, $total_listado_mas_participativo);
    }
    $listado_mas                   = MPObtengoMasInteracciones($id_empresa, "MASCOLABORATIVO", $limit);
    $total_listado_mas_colaborador = "";
    foreach ($listado_mas as $listado_mas_unico) {
        $total_listado_mas_colaborador .= file_get_contents("views/mejorespracticas/mp_row_participantes_mas.html");
        $datos_usuario                 = UsuarioEnBasePersonas($listado_mas_unico->rut);
        $total_listado_mas_colaborador = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($listado_mas_unico->rut), $total_listado_mas_colaborador);
        $total_listado_mas_colaborador = str_replace("{NOMBRE_AUTOR}", ($datos_usuario[0]->nombre_completo), $total_listado_mas_colaborador);
        $total_listado_mas_colaborador = str_replace("{NUM}", ($listado_mas_unico->cuenta), $total_listado_mas_colaborador);
        $total_listado_mas_colaborador = str_replace("{NUMTEXT}", " Colaboraciones", $total_listado_mas_colaborador);
        $link                          = "?sw=listMejPrac&filt_by=" . $datos_usuario[0]->rut . "&vp=1#lista";
        $total_listado_mas_colaborador = str_replace("{LINK}", $link, $total_listado_mas_colaborador);
    }
    $listado_mas                = MPObtengoMasInteracciones($id_empresa, "MASAPOYADOR", $limit);
    $total_listado_mas_apoyador = "";
    foreach ($listado_mas as $listado_mas_unico) {
        $total_listado_mas_apoyador .= file_get_contents("views/mejorespracticas/mp_row_participantes_mas.html");
        $datos_usuario              = UsuarioEnBasePersonas($listado_mas_unico->rut);
        $total_listado_mas_apoyador = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($listado_mas_unico->rut), $total_listado_mas_apoyador);
        $total_listado_mas_apoyador = str_replace("{NOMBRE_AUTOR}", ($datos_usuario[0]->nombre_completo), $total_listado_mas_apoyador);
        $total_listado_mas_apoyador = str_replace("{NUM}", ($listado_mas_unico->cuenta), $total_listado_mas_apoyador);
        $total_listado_mas_apoyador = str_replace("{NUMTEXT}", " Me Gusta y Favoritas", $total_listado_mas_apoyador);
        $link                       = "?sw=listMejPrac&filt_by=" . $datos_usuario[0]->rut . "&vp=1#lista";
        $total_listado_mas_apoyador = str_replace("{LINK}", $link, $total_listado_mas_apoyador);
    }
    $listado_mas                   = MPObtengoMasInteracciones($id_empresa, "MASPROPOSITIVO", $limit);
    $total_listado_mas_propositivo = "";
    foreach ($listado_mas as $listado_mas_unico) {
        $total_listado_mas_propositivo .= file_get_contents("views/mejorespracticas/mp_row_participantes_mas.html");
        $datos_usuario                 = UsuarioEnBasePersonas($listado_mas_unico->rut);
        $total_listado_mas_propositivo = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($listado_mas_unico->rut), $total_listado_mas_propositivo);
        $total_listado_mas_propositivo = str_replace("{NOMBRE_AUTOR}", ($datos_usuario[0]->nombre_completo), $total_listado_mas_propositivo);
        $total_listado_mas_propositivo = str_replace("{NUM}", ($listado_mas_unico->cuenta), $total_listado_mas_propositivo);
        $total_listado_mas_propositivo = str_replace("{NUMTEXT}", " Pr&aacute;cticas Publicadas", $total_listado_mas_propositivo);
        $link                          = "?sw=listMejPrac&filt_by=" . $datos_usuario[0]->rut . "&vp=1#lista";
        $total_listado_mas_propositivo = str_replace("{LINK}", $link, $total_listado_mas_propositivo);
    }
    $listado_mas              = MPObtengoMasInteracciones($id_empresa, "MASMASTER", $limit);
    $total_listado_mas_master = "";
    foreach ($listado_mas as $listado_mas_unico) {
        $total_listado_mas_master .= file_get_contents("views/mejorespracticas/mp_row_participantes_mas.html");
        $datos_usuario            = UsuarioEnBasePersonas($listado_mas_unico->rut);
        $total_listado_mas_master = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($listado_mas_unico->rut), $total_listado_mas_master);
        $total_listado_mas_master = str_replace("{NOMBRE_AUTOR}", ($datos_usuario[0]->nombre_completo), $total_listado_mas_master);
        $total_listado_mas_master = str_replace("{NUM}", round($listado_mas_unico->cuenta), $total_listado_mas_master);
        $total_listado_mas_master = str_replace("{NUMTEXT}", " Puntos Ponderados", $total_listado_mas_master);
        $link                     = "?sw=listMejPrac&filt_by=" . $datos_usuario[0]->rut . "&vp=1#lista";
        $total_listado_mas_master = str_replace("{LINK}", $link, $total_listado_mas_master);
    }
    $total_listado_tags      = TraeTagCloudPorEmpresa($id_empresa);
    $total_listado_tag_cloud = "";
    foreach ($total_listado_tags as $total_listado_tag_unico) {
        $total_listado_tag_cloud .= file_get_contents("views/mejorespracticas/mp_row_tag_cloud.html");
        $total_listado_tag_cloud = str_replace("{TAG}", $total_listado_tag_unico->tag, $total_listado_tag_cloud);
        $total_listado_tag_cloud = str_replace("{NUM}", $total_listado_tag_unico->cuenta, $total_listado_tag_cloud);
        $link                    = "?sw=listMejPrac&filt_by=" . $total_listado_tag_unico->tag . "&vp=tag#lista";
        $total_listado_tag_cloud = str_replace("{LINK}", $link, $total_listado_tag_cloud);
    }
    $PRINCIPAL = str_replace("{NUM_FAV}", MPbuscaFav($rut, $id_empresa), $PRINCIPAL);
    $PRINCIPAL = str_replace("{NUM_MISPR}", MPbuscaMp($rut, $id_empresa), $PRINCIPAL);
    $PRINCIPAL = str_replace("{INSIGNIA}", "", $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_LISTADO_RECIENTES}", utf8_encode($total_listado), $PRINCIPAL);
    $PRINCIPAL = str_replace("{AGRUPACION_CATEGORIAS}", utf8_encode($total_agrup_categoria), $PRINCIPAL);
    $PRINCIPAL = str_replace("{AGRUPACION_AMBITOS}", utf8_encode($total_agrup_ambito), $PRINCIPAL);
    $PRINCIPAL = str_replace("{MAS_PROPOSITIVOS}", utf8_encode($total_listado_mas_propositivo), $PRINCIPAL);
    $PRINCIPAL = str_replace("{MAS_COLABORADORES}", utf8_encode($total_listado_mas_colaborador), $PRINCIPAL);
    $PRINCIPAL = str_replace("{MAS_APOYADORES}", utf8_encode($total_listado_mas_apoyador), $PRINCIPAL);
    $PRINCIPAL = str_replace("{MAS_PARTICIPATIVOS}", utf8_encode($total_listado_mas_participativo), $PRINCIPAL);
    $PRINCIPAL = str_replace("{MAS_MASTER}", utf8_encode($total_listado_mas_master), $PRINCIPAL);
    $PRINCIPAL = str_replace("{TAG_CLOUD}", utf8_encode($total_listado_tag_cloud), $PRINCIPAL);
    return ($PRINCIPAL);
}
function VistaMejorPractica($PRINCIPAL, $id_empresa, $id_mp, $pdf)
{
    //echo     "<br>$id_empresa, $id_mp";
    $todas = MPObtengoMejorPractica($id_empresa, $id_mp);
    //$total_listado="";
    //echo "<pre>";
    //print_r($todas);
    foreach ($todas as $unico) {
        if ($pdf == "pdf") {
            $total_listado .= file_get_contents("views/mejorespracticas/mp_vista_practica_pdf.html");
        } else {
            $total_listado .= file_get_contents("views/mejorespracticas/mp_vista_practica.html");
        }
        $total_listado = str_replace("{ID_CATEGORIA_MP}", utf8_encode($unico->id_categoria), $total_listado);
        $total_listado = str_replace("{CATEGORIA_MP}", utf8_encode($unico->categoria), $total_listado);
        $total_listado = str_replace("{DESCRIPCION_CATEGORIA}", ($unico->descripcion_categoria), $total_listado);
        $total_listado = str_replace("{NOMBRE}", utf8_encode($unico->nombre), $total_listado);
        $total_listado = str_replace("{OBJETIVO}", utf8_encode($unico->objetivo), $total_listado);
        $total_listado = str_replace("{IMPACTO}", utf8_encode($unico->impacto), $total_listado);
        $total_listado = str_replace("{CONTENIDO}", $unico->contenido, $total_listado);
        $total_listado = str_replace("{FECHA}", formatearFechaSmall($unico->fecha), $total_listado);
        $total_listado = str_replace("{ESTADO}", utf8_encode($unico->estado), $total_listado);
        $total_listado = str_replace("{DESCRIPCION_ESTADO}", ($unico->descripcion_estado), $total_listado);
        $total_listado = str_replace("{RUT_AUTOR}", ($unico->rut), $total_listado);
        $total_listado = str_replace("{NOMBRE_AUTOR}", utf8_encode($unico->nombre_autor), $total_listado);
        $total_listado = str_replace("{FOTO_AUTOR}", VerificaFotoPersonal($unico->rut), $total_listado);
        if ($unico->rut == $_SESSION["user_"] AND $unico->id_estado == 1) {
            $total_listado = str_replace("{BLOQUE_EDITAR}", file_get_contents("views/mejorespracticas/mp_bloque_edita.html"), $total_listado);
        } elseif ($unico->rut == $_SESSION["user_"] AND $unico->id_estado == 6) {
            $total_listado = str_replace("{BLOQUE_EDITAR}", file_get_contents("views/mejorespracticas/mp_bloque_edita.html"), $total_listado);
        } elseif ($unico->rut == $_SESSION["user_"] AND $unico->id_estado == 4) {
            $total_listado = str_replace("{BLOQUE_EDITAR}", file_get_contents("views/mejorespracticas/mp_bloque_edita.html"), $total_listado);
        } else {
            $total_listado = str_replace("{BLOQUE_EDITAR}", "", $total_listado);
        }
        $total_listado = str_replace("{ID_MP}", ($unico->id_mp), $total_listado);
        $total_listado = str_replace("{ID_MP_ENCODEADO}", Encodear3($unico->id_mp), $total_listado);
        //INSIGNIA DE CADA UUSUARIO
        //echo "hola ".$unico->numvisitas;
        $total_listado = str_replace("{NUMVISITAS}", round($unico->numvisitas), $total_listado);
        $total_listado = str_replace("{NUMMEGUSTA}", ($unico->nummegusta), $total_listado);
        $total_listado = str_replace("{NUMCOMPARTIDA}", ($unico->numcompartido), $total_listado);
        $total_listado = str_replace("{NUMCOMENTARIO}", ($unico->numcomentarios), $total_listado);
        $total_listado = str_replace("{NUMVISITAS}", round($unico->numvisitas), $total_listado);
        $total_listado = str_replace("{ESTILOESTADO}", ($unico->estilo), $total_listado);
        $total_listado = str_replace("{ICONOESTADO}", ($unico->icono_estado), $total_listado);
        $total_listado = str_replace("{ESTILOCATEGORIA}", ($unico->style), $total_listado);
        $total_listado = str_replace("{ICONOCATEGORIA}", ($unico->icono), $total_listado);
        $total_listado = str_replace("{AMBITO}", utf8_encode($unico->ambitonombre), $total_listado);
        $total_listado = str_replace("{ESTILOAMBITO}", ($unico->ambitostyle), $total_listado);
        $total_listado = str_replace("{ICONOAMBITO}", ($unico->ambitoicono), $total_listado);
        $total_listado = str_replace("{CATEGORIA_MP}", ($unico->categoria), $total_listado);
        $archivo       = $unico->archivo;
        $trozos        = explode(".", $archivo);
        $extension     = end($trozos);
        //echo "$archivo= $extension";
        if ($extension <> "") {
            $total_listado = str_replace("{BLOQUE_ARCHIVO}", file_get_contents("views/mejorespracticas/mp_vista_practica_bloque_archivo.html"), $total_listado);
            $total_listado = str_replace("{NOMBRE_ARCHIVO}", $unico->archivo, $total_listado);
        } else {
            $total_listado = str_replace("{BLOQUE_ARCHIVO}", "", $total_listado);
        }
        $total_listado = utf8_decode(ColocaListadoColaboradoresPorMP($total_listado, $id_empresa, "", $id_mp));
        if ($unico->id_estado >= 5) {
            $textocomentario    = "
            <br><hr><div class='row'>
            <div class='col-xs-12 mp_ayudaamejorar'>
            Colabora y  ayuda a " . $unico->nombre_autor . " a mejorar su pr?ctica
            </div>
            </div><br>";
            $textointeracciones = "
            <br><hr><div class='row'>
            <div class='col-xs-12 mp_ayudaamejorar pull-left'>
            Colaboraciones
            </div>
            </div><br>";
            $total_listado      = str_replace("{TEXTO_COMENTARIO}", utf8_decode($textocomentario), $total_listado);
            $total_listado      = str_replace("{TEXTO_INTERACCIONES}", utf8_decode($textointeracciones), $total_listado);
            $total_listado      = str_replace("{PRACTICA_MEGUSTA}", ColocaMeGustaApoyoInt($id_mp, "id_mp", $id_empresa, $_SESSION["user_"], "", $id_mp), $total_listado);
            $total_listado      = str_replace("{PRACTICA_FAVORITA}", ColocaFavoritoInt($id_mp, "id_mp", $id_empresa, $_SESSION["user_"], "", $id_mp), $total_listado);
            $total_listado      = str_replace("{PRACTICA_PDF}", ColocaPDFInt($id_mp, "id_mp", $id_empresa, $_SESSION["user_"], "", $id_mp), $total_listado);
        } else {
            $total_listado = str_replace("{PRACTICA_MEGUSTA}", "", $total_listado);
            $total_listado = str_replace("{TEXTO_COMENTARIO}", "", $total_listado);
            $total_listado = str_replace("{TEXTO_INTERACCIONES}", "", $total_listado);
            $total_listado = str_replace("{COMPARTIR}", "", $total_listado);
            $total_listado = str_replace("{PRACTICA_PDF}", "", $total_listado);
            $total_listado = str_replace("{PRACTICA_FAVORITA}", "", $total_listado);
        }
    }
    $PRINCIPAL = str_replace("{ROW_LISTADO_RECIENTES}", utf8_encode($total_listado), $PRINCIPAL);
    $PRINCIPAL = str_replace("{GALERIAIMAGENES}", "", $PRINCIPAL);
    $PRINCIPAL = str_replace("{INSIGNIA}", "", $PRINCIPAL);
    return ($PRINCIPAL);
}
function limit_text($text, $limit)
{
    if (str_word_count($text, 0) > $limit) {
        $words = str_word_count($text, 2);
        $pos   = array_keys($words);
        $text  = substr($text, 0, $pos[$limit]) . '...';
    }
    return strip_tags($text);
}
function EnviaCorreoBuenasPracticas($rut_destinatario, $nombre, $id_estado, $id_empresa, $tipo_correo, $tiporecipiente, $id_mp)
{
    //echo "$rut_destinatario,$nombre, $id_estado, $id_empresa, $tipo_correo, $tiporecipiente, $id_mp";
    $datos_empresa   = DatosEmpresa($id_empresa);
    $datos_practica  = MPObtengoMejorPractica($id_empresa, $id_mp);
    $nombre_practica = $datos_practica[0]->nombre;
    $nombre_autor    = $datos_practica[0]->nombre_autor;
    $rut_autor       = $datos_practica[0]->rut;
    $datos_autor     = UsuarioEnBasePersonas($rut_autor);
    $datos_admin     = UsuarioAdminEmpresa($id_empresa);
    //print_r($datos_autor);
    $nombre_autor    = $datos_autor[0]->nombre_completo;
    $email_autor     = $datos_autor[0]->email;
    $datos_Estado    = MP_ObtengoDatosEstadoPorEmpresa($id_empresa, $id_estado);
    $template_correo = file_get_contents("views/mejorespracticas/correos/" . $datos_Estado[0]->{$tipo_correo});
    $template_correo = str_replace("{NOMBRE}", utf8_encode($nombre_autor), $template_correo);
    $template_correo = str_replace("{PRACTICA}", utf8_encode($nombre_practica), $template_correo);
    $asunto          = $datos_Estado[0]->{$tiporecipiente};
    //print_r($datos_Estado);
    //echo "<br>asunto $asunto";
    if ($tipo_correo == "template_email_autor") {
        $nombre_envio = $datos_autor[0]->nombre_completo;
        $email_envio  = $datos_autor[0]->email;
        //echo "<br><br>usuario $rut_destinatario,$nombre, $id_estado, $id_empresa, $tipo_correo, $tiporecipiente,  $id_mp,
        //nombrepractica $nombre_practica, rut_autor $rut_autor,  nombre_autor $nombre_autor, email_autor $email_autor    ";
    }
    if ($tipo_correo == "template_email_admin") {
        //print_r($datos_admin);
        foreach ($datos_admin as $datos_admin_usuario) {
            $email_admin = $datos_admin_usuario->email;
        }
        $nombre_envio = "Administrador";
        $email_envio  = $email_admin;
        //$email_envio="rod.arancibia@gmail.cl";
        //echo "<br><br>admin $rut_destinatario,$nombre, $id_estado, $id_empresa, $tipo_correo, $tiporecipiente,  $id_mp,
        //nombrepractica $nombre_practica, rut_autor $rut_autor,  nombre_autor $nombre_autor, email_autor $email_autor, email_admin $email_admin  <br>
        //$nombre_envio<br>
        // $email_admin ";   exit();
    }
    if ($id_estado > 1) {
        $mail = new PHPMailer;
        //Tell PHPMailer to use SMTP
        $mail->isSMTP(); //Enable SMTP debugging
        // 0 = off (for production use)
        // 1 = client messages
        // 2 = client and server messages
        $mail->SMTPDebug   = 1;
        //Ask for HTML-friendly debug output
        $mail->Debugoutput = 'error_log';
        //Set the hostname of the mail server
        $mail->Host        = $datos_empresa[0]->server;
        //Set the SMTP port number - likely to be 25, 465 or 587
        $mail->Port        = 25;
        //Whether to use SMTP authentication
        $mail->SMTPAuth    = true;
        //Username to use for SMTP authentication
        $mail->Username    = $datos_empresa[0]->envio_correos;
        //Password to use for SMTP authentication
        $mail->Password    = $datos_empresa[0]->envio_correos_pass;
        //Set who the message is to be sent from
        $mail->setFrom($datos_empresa[0]->envio_correos, $datos_empresa[0]->envio_correos);
        //Set an alternative reply-to address
        //$mail->addReplyTo('replyto@example.com', 'First Last');
        //Set who the message is to be sent to
        //$mail->addAddress($datos_destinatario[0]->email, $datos_destinatario[0]->nombre_completo);
        //$mail->addAddress("daniel@gop.cl", $datos_destinatario[0]->nombre_completo);
        $mail->addAddress($email_envio, $nombre_envio);
        //$mail->addAddress("francisco.lopez@tnt.com", $datos_destinatario[0]->nombre_completo);
        //$mail->addAddress("rod@gop.cl", $datos_destinatario[0]->nombre_completo);
        //$mail->AddBCC("backup@sgd.cl","BCC: ".$datos_destinatario[0]->nombre_completo);
        //Set the subject line
        $mail->Subject = $asunto;
        //Read an HTML message body from an external file, convert referenced images to embedded,
        //convert HTML into a basic plain-text alternative body
        $mail->msgHTML($template_correo, dirname(__FILE__));
        //Replace the plain text body with one created manually
        $mail->AltBody = 'Si no puedes visualizar este correo ....';
        //Attach an image file
        //$mail->addAttachment('images/phpmailer_mini.png');
        //send the message, check for errors
        if (!$mail->send()) {
            echo "Mailer Error: " . $mail->ErrorInfo;
        } else {
            echo "Message sent!";
        }
    }
    //exit;
}
function ColocaListadoColaboradoresPorMP($PRINCIPAL, $id_empresa, $rut, $id_mp)
{
    $usuarios = MP_UsuariosPorMPYUsuario($id_mp, $id_empresa);
    if ($usuarios) {
        $total_colaboradores = "";
        foreach ($usuarios as $usu) {
            $total_colaboradores .= file_get_contents("views/mejorespracticas/mp_row_colaboradores.html");
            $total_colaboradores = str_replace("{NOMBRE}", $usu->nombre_completo, $total_colaboradores);
            $total_colaboradores = str_replace("{CARGO}", $usu->cargo, $total_colaboradores);
            $total_colaboradores = str_replace("{ROL}", $usu->rol, $total_colaboradores);
        }
        $PRINCIPAL = str_replace("{LISTADO_USUARIOS}", utf8_encode($total_colaboradores), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{LISTADO_USUARIOS}", "", $PRINCIPAL);
    }
    return ($PRINCIPAL);
}
function allPersonasPorNombrePorEmpresaGenerico($buscar, $id_empresa, $rut)
{
    $datos_usuario = UsuarioEnBasePersonas($rut);
    $dataPersonas  = allPersonasPorEmpresa($buscar, $id_empresa);
    if ($dataPersonas) {
        foreach ($dataPersonas as $dataPersonas_aux) {
            echo utf8_encode($dataPersonas_aux->nombre) . " " . utf8_encode($dataPersonas_aux->apaterno) . " " . utf8_encode($dataPersonas_aux->amaterno) . " " . "|" . $dataPersonas_aux->rut . "\n";
            //echo utf8_encode($dataPersonas_aux->nombre)."\n";
        }
    } else {
        $data = 'No Existe este nombre';
    }
    return $data;
}
function ColocaTitulosPorPaso($PRINCIPAL, $id_empresa)
{
    $pasos = MP_TraigoPasosPorEmpresa($id_empresa);
    $i     = 1;
    foreach ($pasos as $pas) {
        $PRINCIPAL = str_replace("{NUMPASO$i}", $i, $PRINCIPAL);
        $PRINCIPAL = str_replace("{NOMBREPASO$i}", utf8_encode($pas->paso), $PRINCIPAL);
        $PRINCIPAL = str_replace("{DESCRIPCION$i}", utf8_encode($pas->descripcion), $PRINCIPAL);
        $PRINCIPAL = str_replace("{TEXTO$i}", utf8_encode($pas->texto), $PRINCIPAL);
        $i++;
    }
    return ($PRINCIPAL);
}
function FormularioBuenasPracticas($PRINCIPAL, $id_empresa, $rut, $id_mp)
{
    //Coloco combobox, de categorias.
    //$categorias=TraeCategoriasMejoresPracticas($id_empresa);
    $categorias = TraeCategoriasMejoresPracticasParaCombo($id_empresa);
    $datos_mp   = DatosMPDadoId($id_mp);
    $ambitos    = TraeAmbitosMejoresPracticas($id_empresa);
    if ($id_mp) {
        if ($datos_mp[0]->muestra == 1) {
            $PRINCIPAL = str_replace("{STYLE_BLOQUE_OTRA_OPOR}", '', $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{STYLE_BLOQUE_OTRA_OPOR}", 'style="display:none;"', $PRINCIPAL);
        }
    } else {
        $PRINCIPAL = str_replace("{STYLE_BLOQUE_OTRA_OPOR}", 'style="display:none;"', $PRINCIPAL);
    }
    $categoria_options     = "";
    $listado_colaboradores = TotalUsuariosPorempresa($id_empresa);
    foreach ($listado_colaboradores as $list) {
        $html_colaboradores .= "<option value='" . $list->rut . "'>" . $list->nombre_completo . "</option>";
    }
    foreach ($categorias as $cat) {
        if ($datos_mp[0]->id_categoria == $cat->id_categoria) {
            $categoria_options .= "<option selected='selected' value='" . $cat->id_categoria . "'>" . $cat->categoria . "</option>";
        } else if ($datos_mp[0]->muestra == "1" and $cat->id_categoria == "0") {
            $categoria_options .= "<option selected='selected' value='" . $cat->id_categoria . "'>" . $cat->categoria . "</option>";
        } else {
            $categoria_options .= "<option value='" . $cat->id_categoria . "'>" . $cat->categoria . "</option>";
        }
    }
    $ambito_options = "";
    foreach ($ambitos as $amb) {
        if ($datos_mp[0]->id_ambito == $amb->id_ambito) {
            $ambito_options .= "<option selected='selected' value='" . $amb->id_ambito . "'>" . $amb->ambito . "</option>";
        } else {
            $ambito_options .= "<option value='" . $amb->id_ambito . "'>" . $amb->ambito . "</option>";
        }
    }
    if ($id_mp) {
        $PRINCIPAL = str_replace("{ID_MP}", $id_mp, $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_MP_ENCODEADO}", Encodear3($id_mp), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{ID_MP}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_MP_ENCODEADO}", "", $PRINCIPAL);
    }
    $PRINCIPAL = str_replace("{OPTIONS_CATEGORIAS_MEJORES_PRACTICAS}", utf8_encode($categoria_options), $PRINCIPAL);
    $PRINCIPAL = str_replace("{OPTIONS_AMBITOS_MEJORES_PRACTICAS}", utf8_encode($ambito_options), $PRINCIPAL);
    $PRINCIPAL = str_replace("{OPTION_LISTADO_COLABORADORES}", utf8_encode($html_colaboradores), $PRINCIPAL);
    $PRINCIPAL = str_replace("{VALUE_NOMBRE}", utf8_encode($datos_mp[0]->nombre), $PRINCIPAL);
    $PRINCIPAL = str_replace("{VALUE_OBJETIVO}", utf8_encode($datos_mp[0]->objetivo), $PRINCIPAL);
    $PRINCAL   = str_replace("{VALUE_APLICACION}", utf8_encode($datos_mp[0]->aplicacion), $PRINCIPAL);
    $PRINCIPAL = str_replace("{VALUE_METRICA}", utf8_encode($datos_mp[0]->metrica), $PRINCIPAL);
    $PRINCIPAL = str_replace("{VALUE_IMPACTO}", utf8_encode($datos_mp[0]->impacto), $PRINCIPAL);
    $PRINCIPAL = str_replace("{VALUE_PROBLEMA}", utf8_encode($datos_mp[0]->problema), $PRINCIPAL);
    $PRINCIPAL = str_replace("{VALUE_KPI_AFECTADO}", utf8_encode($datos_mp[0]->kpi_afectado), $PRINCIPAL);
    $PRINCIPAL = str_replace("{VALUE_CUANTIFICACION}", utf8_encode($datos_mp[0]->cuantificacion), $PRINCIPAL);
    $PRINCIPAL = str_replace("{VALUE_COACH}", utf8_encode($datos_mp[0]->coach), $PRINCIPAL);
    $PRINCIPAL = str_replace("{CONTENIDO_INGRESADO}", utf8_encode($datos_mp[0]->contenido), $PRINCIPAL);
    $PRINCIPAL = str_replace("{VALUE_TAGS}", utf8_encode($datos_mp[0]->tag), $PRINCIPAL);
    if ($datos_mp[0]->muestra == 1) {
        $PRINCIPAL = str_replace("{NOMBRE_CATEGORIA}", utf8_encode($datos_mp[0]->nombre_categoria), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{NOMBRE_CATEGORIA}", "", $PRINCIPAL);
    }
    //coloca listado de Usuarios por ID_MP
    $PRINCIPAL = ColocaListadoColaboradoresPorMP($PRINCIPAL, $id_empresa, $rut, $id_mp);
    return ($PRINCIPAL);
}
function ColocaDatosHomeSGD($PRINCIPAL, $id_empresa)
{
    $datos_home = ObtenerContenidosInicialSGDPorEmpresa($id_empresa);
    $PRINCIPAL  = str_replace("{TITULO}", utf8_encode($datos_home[0]->titulo), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{TEXTO_INTRODUCCION}", utf8_encode($datos_home[0]->introduccion), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{TEXTO_TRANSVERSALES}", utf8_encode($datos_home[0]->competencias_transversales), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{TEXTO_LIDERAZGO}", utf8_encode($datos_home[0]->competencias_liderazgo), $PRINCIPAL);
    $PRINCIPAL  = str_replace("{IMAGEN_LOGIN}", utf8_encode($datos_home[0]->imagen_home), $PRINCIPAL);
    $importante = ObtenerContenidosBloqueImportante($id_empresa);
    foreach ($importante as $imp) {
        $row_importante_home .= '<tr>
                                <td  valign="top"><span class="color_cafeemiliana"><i class="fa fa-angle-right padRight10px"></i></span></td>
                                <td><span class="color_cafeemiliana">' . $imp->texto . '</td>
                            </tr>
                            <tr><td colspan="2"><br></td></tr>';
    }
    $PRINCIPAL = str_replace("{ROW_IMPORTANTES}", utf8_encode($row_importante_home), $PRINCIPAL);
    $tips      = ObtenerContenidosBloqueTips($id_empresa);
    foreach ($tips as $imp) {
        $row_tips_home .= '<tr>
                                <td  valign="top"><span class="color_cafeemiliana"><i class="fa fa-angle-right padRight10px"></i></span></td>
                                <td><span class="color_cafeemiliana">' . $imp->texto . '</td>
                            </tr>
                            <tr><td colspan="2"><br></td></tr>
                            ';
    }
    $PRINCIPAL = str_replace("{ROW_TIPS}", utf8_encode($row_tips_home), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaPaginacionDeNoticias($pagina, $id_empresa, $noticas_por_pagina, $id_categoria)
{
    //$imagenes=FotosPorObjeto($id_objeto, $_SESSION["id_empresa"], "no");
    $noticias = TraeNoticiasTodas($id_empresa, $id_categoria);
    if (!$pagina) {
        $pagina = 1;
    }
    $total_noticias = count($noticias);
    $paginacion     = file_get_contents("views/noticias/entorno_paginacion.html");
    $total_paginas  = ceil($total_noticias / $noticas_por_pagina);
    //echo "$imagenes_por_pagina, $total_imagenes, $total_paginas";
    for ($i = 1; $i <= $total_paginas; $i++) {
        $row .= file_get_contents("views/noticias/row_paginacion.html");
        $row = str_replace("{NUMERO_PAGINA}", $i, $row);
        $row = str_replace("{PAGINA}", $i, $row);
        if ($pagina == $i) {
            $row = str_replace("{CLASE_ACTIVO}", "class='active'", $row);
        } else {
            $row = str_replace("{CLASE_ACTIVO}", "", $row);
        }
    }
    $paginacion = str_replace("{ROW_PAGINACION}", $row, $paginacion);
    return ($paginacion);
}
function ObtenerNotaDeEvaluacionSuma($id_objeto, $rut)
{
    $respuestas      = RespuestasDadoRutObjeto($rut, $id_objeto);
    $suma_respuestas = 0;
    foreach ($respuestas as $res) {
        $suma_respuestas = $suma_respuestas + $res->puntaje;
    }
    return ($suma_respuestas);
}
function ColocarFormularioPorImagenSubida($PRINCIPAL, $rut, $id_empresa, $id_imagen)
{
    $datos_imagen = ObtenerImagenDadoID($id_imagen);
    $PRINCIPAL    = str_replace("{URL_FOTO}", $datos_imagen[0]->archivo, $PRINCIPAL);
    $PRINCIPAL    = str_replace("{ID_IMAGEN_ENCODEADA}", Encodear3($id_imagen), $PRINCIPAL);
    $PRINCIPAL    = str_replace("{COMENTARIOS}", utf8_encode($datos_imagen[0]->comentarios), $PRINCIPAL);
    if ($datos_imagen[0]->modalidad == 1) {
        $PRINCIPAL = str_replace("{DESCCATEGORIA}", "Mi Mam?", $PRINCIPAL);
        $PRINCIPAL = str_replace("{SEL1}", "selected='selected'", $PRINCIPAL);
    } else if ($datos_imagen[0]->modalidad == 2) {
        $PRINCIPAL = str_replace("{DESCCATEGORIA}", "La Mam? de mis hijos", $PRINCIPAL);
        $PRINCIPAL = str_replace("{SEL2}", "selected='selected'", $PRINCIPAL);
    } else if ($datos_imagen[0]->modalidad == 3) {
        $PRINCIPAL = str_replace("{DESCCATEGORIA}", "Yo como Mam?", $PRINCIPAL);
        $PRINCIPAL = str_replace("{SEL3}", "selected='selected'", $PRINCIPAL);
    }
    return ($PRINCIPAL);
}
function ColocaObjetivoPorGerencia($PRINCIPAL, $id_empresa, $rut)
{
    $datos     = DNCObtengoObjetivoPorEmpresa($rut, $id_empresa);
    $PRINCIPAL = str_replace("{OBJETIVO_POR_GERENCIA}", utf8_encode($datos[0]->objetivo), $PRINCIPAL);
    return ($PRINCIPAL);
}
function GAMIFICACIONResultadosPorCursoMalla($rut, $id_curso, $id_malla, $id_empresa)
{
    if ($id_curso && $id_malla) {
        $nota_por_curso = GAMIFICACION_NotaPorCursoUsuarioEmpresa($rut, $id_curso, $id_empresa, $id_malla);
        $nota           = round($nota_por_curso[0]->nota_por_curso);
    } else if ($id_malla && !$id_curso) {
        $nota_por_malla = GAMIFICACION_NotaPorMallaUsuarioEmpresa($rut, $id_malla, $id_empresa);
        $nota           = round($nota_por_malla[0]->nota_por_malla);
    }
    return ($nota);
}
function GAMIFICACIONResultadosPorSoloCurso($rut, $id_curso, $id_empresa)
{
    $nota_por_curso = GAMIFICACION_NotaPorSoloCursoUsuarioEmpresa($rut, $id_curso, $id_empresa);
    $nota           = $nota_por_curso[0]->nota_por_curso;
    return ($nota);
}
function GAMIFICACION_ActualizaNivelVersion2($id_malla, $id_empresa, $rut)
{
    //Primero traigo el nivel actual.
    $datos_puntos_consolidado = TienePuntosConsolidadosPorMalla($rut, $id_empresa, $id_malla);
    $id_nivel                 = $datos_puntos_consolidado[0]->nivel;
    //dado el nivel, traigo el curso
    $datos_curso              = GAMIFICACION_ObtengoCursoDadoNivel($id_nivel, $id_empresa);
    $id_curso                 = $datos_curso[0]->idcurso;
    $datos_objeto_por_curso   = GAMIFICACIONTraeDatosObjetosPorCurso($rut, $id_curso);
    if ($datos_objeto_por_curso[0]->total_objetos == $datos_objeto_por_curso[0]->total_objetos_finalizados) {
        //Si la cantidad de objetos del curso, mas la cantidad de objetos finalizados,
        //significa que el nivel se paso, por ende se actualiza
        $orden_actual        = $datos_curso[0]->idorden;
        $orden_proximo_nivel = $orden_actual + 1;
        //ahora obtengo nivel, dado la malla y el orden
        $datos_nuevo_nivel   = GAMIFICACION_TraigoNivelDadoOrdenYMalla($id_malla, $orden_proximo_nivel);
        GAMIFICACION_ActualizaSoloNivel($datos_nuevo_nivel[0]->idnivel, $id_empresa, $rut, $id_malla);
    }
}
function ColocaPaginacionDeImagenes($pagina, $id_objeto, $rut, $id_malla, $cantidad_imagenes_galeria)
{
    //$imagenes=FotosPorObjeto($id_objeto, $_SESSION["id_empresa"], "no");
    //echo "$pagina, $id_objeto, $rut, idmalla $id_malla";
    $imagenes = FotosPorObjeto($id_objeto, $_SESSION["id_empresa"], "no", $id_malla);
    if (!$pagina) {
        $pagina = 1;
    }
    $imagenes_por_pagina = $cantidad_imagenes_galeria;
    $total_imagenes      = count($imagenes);
    $paginacion          = file_get_contents("views/cursos/objetos/subirFotos/entorno_paginacion.html");
    $total_paginas       = ceil($total_imagenes / $imagenes_por_pagina);
    //echo "$imagenes_por_pagina, $total_imagenes, $total_paginas";
    for ($i = 1; $i <= $total_paginas; $i++) {
        $row .= file_get_contents("views/cursos/objetos/subirFotos/row_paginacion.html");
        $row = str_replace("{NUMERO_PAGINA}", $i, $row);
        $row = str_replace("{PAGINA}", $i, $row);
        if ($pagina == $i) {
            $row = str_replace("{CLASE_ACTIVO}", "class='active'", $row);
        } else {
            $row = str_replace("{CLASE_ACTIVO}", "", $row);
        }
    }
    $paginacion = str_replace("{ROW_PAGINACION}", $row, $paginacion);
    return ($paginacion);
}
function RedimensionarImagenParaGaleria($rutaImagenOriginal, $nombre_imagen, $ext, $nombre_nuevo_archivo, $id_empresa)
{
    //echo "$rutaImagenOriginal, $nombre_imagen, $ext, $nombre_nuevo_archivo, $id_empresa";exit;
    //Ruta de la imagen original
    //$rutaImagenOriginal="./imagen/i2.jpg";
    //Creamos una variable imagen a partir de la imagen original
    if ($ext == "gif") {
        $img_original = imagecreatefromgif($rutaImagenOriginal);
    } else if ($ext == "png") {
        $img_original = imagecreatefrompng($rutaImagenOriginal);
    } else {
        $img_original = imagecreatefromjpeg($rutaImagenOriginal);
    }
    //echo $rutaImagenOriginal;exit;
    //Se define el maximo ancho o alto que tendra la imagen final
    //$alto_orig=imagesy($img_original);
    //$ancho_orig=imagesx($img_original);
    $max_ancho = 1000;
    $max_alto  = 1000;
    //Ancho y alto de la imagen original
    list($ancho, $alto) = getimagesize($rutaImagenOriginal);
    //Se calcula ancho y alto de la imagen final
    $x_ratio = $max_ancho / $ancho;
    $y_ratio = $max_alto / $alto;
    //Si el ancho y el alto de la imagen no superan los maximos,
    //ancho final y alto final son los que tiene actualmente
    if (($ancho <= $max_ancho) && ($alto <= $max_alto)) { //Si ancho
        $ancho_final = $ancho;
        $alto_final  = $alto;
    }
    /*
     * si proporcion horizontal*alto mayor que el alto maximo,
     * alto final es alto por la proporcion horizontal
     * es decir, le quitamos al alto, la misma proporcion que
     * le quitamos al alto
     *
     */
    elseif (($x_ratio * $alto) < $max_alto) {
        $alto_final  = ceil($x_ratio * $alto);
        $ancho_final = $max_ancho;
    }
    /*
     * Igual que antes pero a la inversa
     */
    else {
        $ancho_final = ceil($y_ratio * $ancho);
        $alto_final  = $max_alto;
    }
    if ($ancho > $alto) {
        $alto_final  = $max_alto;
        $ancho_final = ceil($y_ratio * $ancho);
    } else if ($alto > $ancho) {
        $alto_final  = ceil($x_ratio * $alto);
        $ancho_final = $max_ancho;
    }
    //Creamos una imagen en blanco de tamaño $ancho_final  por $alto_final .
    $tmp = imagecreatetruecolor($ancho_final, $alto_final);
    //Copiamos $img_original sobre la imagen que acabamos de crear en blanco ($tmp)
    imagecopyresampled($tmp, $img_original, 0, 0, 0, 0, $ancho_final, $alto_final, $ancho, $alto);
    //Se destruye variable $img_original para liberar memoria
    imagedestroy($img_original);
    //Definimos la calidad de la imagen final
    $calidad = 95;
    //Se crea la imagen final en el directorio indicado
    //imagejpeg($tmp,"../front/img/noticias/thum/".$nombre_imagen,$calidad);
    if ($ext == "gif") {
        imagegif($tmp, "../../front/galeria/" . $nombre_nuevo_archivo);
    } else if ($ext == "png") {
        imagepng($tmp, "../../front/galeria/" . $nombre_nuevo_archivo);
    } else {
        imagejpeg($tmp, "../../front/galeria/" . $nombre_nuevo_archivo);
    }
    /* SI QUEREMOS MOSTRAR LA IMAGEN EN EL NAVEGADOR
     *
     * descomentamos las lineas 64 ( Header("Content-type: image/jpeg"); ) y 65 ( imagejpeg($tmp); )
     * y comentamos la linea 57 ( imagejpeg($tmp,"./imagen/retoque.jpg",$calidad); )
     */
    //Header("Content-type: image/jpeg");
    //imagejpeg($tmp);
}
function OptionsCompetenciasDadoPerfil($perfil_evaluacion, $seleccionado)
{
    $competencias = ObtengoCompetenciasDadoPerfilConNombreCompetencia($perfil_evaluacion);
    foreach ($competencias as $comp) {
        if ($seleccionado == $comp->id_competencia) {
            $options .= "<option selected='selected' value='" . $comp->id_competencia . "'>" . $comp->nombre_competencia . "</option>";
        } else {
            $options .= "<option value='" . $comp->id_competencia . "'>" . $comp->nombre_competencia . "</option>";
        }
    }
    return (utf8_encode($options));
}
function getRutDV($rut)
{
    $rut = strrev($rut);
    $aux = 1;
    for ($i = 0; $i < strlen($rut); $i++) {
        $aux++;
        $s += intval($rut[$i]) * $aux;
        if ($aux == 7) {
            $aux = 1;
        }
    }
    $digit = 11 - $s % 11;
    if ($digit == 11) {
        $d = 0;
    } elseif ($digit == 10) {
        $d = "K";
    } else {
        $d = $digit;
    }
    return $d;
}
function ObtieneNotaObjetivosSinTablaRespuesta($evaluado, $evaluador, $id_proceso, $id_dimension)
{
    //$objetivos=ObjetivosEspecificosConRespuestaEvaluadoEvaluadorProceso($evaluado, $evaluador, $id_proceso);
    $objetivos  = NotasObjetivosPorDimension($evaluado, $evaluador, $id_proceso);
    $pond_total = 100;
    $i          = 0;
    foreach ($objetivos as $ob) {
        $acumulador = $acumulador + (($ob->nota_promediada * $ob->ponderacion) / $pond_total);
        $i++;
    }
    //echo "acumulador $acumulador <br>";
    //exit;
    return ($acumulador);
}
function ColocaBloqueMasMeGustaFotos($PRINCIPAL, $id_objeto, $id_malla)
{
    //obtengo comentarios dado id_objeto
    //$total_galerias=ObtenerFotosMasMegusta($id_objeto, $_SESSION["id_empresa"]);
    $total_galerias = ObtenerFotosMasMegustaPorMalla($id_objeto, $_SESSION["id_empresa"], $id_malla);
    if ($total_galerias) {
        foreach ($total_galerias as $arch) {
            $row_html .= file_get_contents("views/cursos/objetos/subirFotos/62_lista_archivos_bloque.html");
            $row_html = str_replace("{URL_IMAGEN_ARCHIVO}", $arch->archivo, $row_html);
            $row_html = str_replace("{URL_IMAGEN_PERSONA}", VerificaFotoPersonal($arch->rut_autor), $row_html);
            $row_html = str_replace("{DESCRIPCION}", ($arch->nombre_completo), $row_html);
            $row_html = str_replace("{MEGUSTA}", ColocaMeGusta($arch->id, "id_imagen_galeria", $_SESSION["id_empresa"], $arch->rut_autor, "autor", $id_objeto), $row_html);
        }
        $PRINCIPAL = str_replace("{BLOQUE_FOTOS_MAS_MEGUSTA}", utf8_encode($row_html), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_FOTOS_MAS_MEGUSTA}", "", $PRINCIPAL);
    }
    return ($PRINCIPAL);
}
function RedimensionarImagenSubirObjetos($rutaImagenOriginal, $nombre_imagen, $ext, $nombre_nuevo_archivo, $id_empresa)
{
    //Ruta de la imagen original
    //$rutaImagenOriginal="./imagen/i2.jpg";
    //Creamos una variable imagen a partir de la imagen original
    if ($ext == "gif") {
        $img_original = imagecreatefromgif($rutaImagenOriginal);
    } else if ($ext == "png") {
        $img_original = imagecreatefrompng($rutaImagenOriginal);
    } else {
        $img_original = imagecreatefromjpeg($rutaImagenOriginal);
    }
    //Se define el maximo ancho o alto que tendra la imagen final
    //$alto_orig=imagesy($img_original);
    //$ancho_orig=imagesx($img_original);
    $max_ancho = 800;
    $max_alto  = 800;
    //Ancho y alto de la imagen original
    list($ancho, $alto) = getimagesize($rutaImagenOriginal);
    //Se calcula ancho y alto de la imagen final
    $x_ratio = $max_ancho / $ancho;
    $y_ratio = $max_alto / $alto;
    //Si el ancho y el alto de la imagen no superan los maximos,
    //ancho final y alto final son los que tiene actualmente
    //if( ($ancho >= $max_ancho) && ($alto >= $max_alto) ){//Si ancho
    if ($ancho >= $alto and $ancho > 50) {
        //Horizontal
        if ($ancho >= $max_alto) {
            $ancho_final = $max_ancho;
            //$alto_final = $alto;
            $alto_final  = round(($x_ratio * $alto), 0);
            //echo "ancho ".$ancho_final." ".$alto_final;exit;
        }
    } else if ($ancho < $alto and $ancho > 50) {
        //Vertical
        if ($alto >= $max_ancho) {
            //$ancho_final = $ancho;
            $alto_final  = $max_alto;
            $ancho_final = round(($y_ratio * $ancho), 0);
        }
    } else {
        echo "<script>
                    window.history.back();
                    </script>";
        exit;
    }
    /*if($ancho >= $max_alto){
    $ancho_final = $max_ancho;
    //$alto_final = $alto;
    $alto_final = ceil($x_ratio * $alto);
    //echo "ancho ".$ancho_final." ".$alto_final;exit;
    } else if($alto >= $max_ancho){
    //$ancho_final = $ancho;
    $alto_final = $max_alto;
    $ancho_final = ceil($y_ratio * $ancho);
    }else{
    $alto_final = 800;
    $ancho_final = 800;
    }
    /*if( ($ancho >= $max_alto) && ($alto >= $max_ancho) ){
    $ancho_final = $ancho;
    $alto_final = $alto;
    }
    * */
    /*
     * si proporcion horizontal*alto mayor que el alto maximo,
     * alto final es alto por la proporcion horizontal
     * es decir, le quitamos al alto, la misma proporcion que
     * le quitamos al alto
     *
     */
    /*elseif (($x_ratio * $alto) < $max_alto){
    $alto_final = ceil($x_ratio * $alto);
    $ancho_final = $max_ancho;
    }
    * */
    /*
     * Igual que antes pero a la inversa
     */
    /*else{
    $ancho_final = ceil($y_ratio * $ancho);
    $alto_final = $max_alto;
    }
    *
    * */
    /*if($ancho>$alto){
    $alto_final=$max_alto;
    $ancho_final=ceil($y_ratio * $ancho);
    }else if($alto>$ancho){
    $alto_final=ceil($x_ratio * $alto);
    $ancho_final=$max_ancho;
    }
    *
    * */
    //Creamos una imagen en blanco de tamaño $ancho_final  por $alto_final .
    $tmp = imagecreatetruecolor($ancho_final, $alto_final);
    //Copiamos $img_original sobre la imagen que acabamos de crear en blanco ($tmp)
    imagecopyresampled($tmp, $img_original, 0, 0, 0, 0, $ancho_final, $alto_final, $ancho, $alto);
    //Se destruye variable $img_original para liberar memoria
    imagedestroy($img_original);
    //Definimos la calidad de la imagen final
    $calidad = 95;
    //Se crea la imagen final en el directorio indicado
    //imagejpeg($tmp,"../front/img/noticias/thum/".$nombre_imagen,$calidad);
    if ($ext == "gif") {
        imagegif($tmp, "img/objetos/" . $nombre_nuevo_archivo);
    } else if ($ext == "png") {
        imagepng($tmp, "img/objetos/" . $nombre_nuevo_archivo);
    } else {
        imagejpeg($tmp, "img/objetos/" . $nombre_nuevo_archivo);
    }
    /* SI QUEREMOS MOSTRAR LA IMAGEN EN EL NAVEGADOR
     *
     * descomentamos las lineas 64 ( Header("Content-type: image/jpeg"); ) y 65 ( imagejpeg($tmp); )
     * y comentamos la linea 57 ( imagejpeg($tmp,"./imagen/retoque.jpg",$calidad); )
     */
    //Header("Content-type: image/jpeg");
    //imagejpeg($tmp);
}
function ColocaBloqueDerechoCursosNiveles($PRINCIPAL, $rut, $id_empresa, $id_clasificacion, $id_malla)
{
    $PRINCIPAL = str_replace("{BLOQUE_CURSOS_NIVELES}", file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_bloque_niveles_curso.html"), $PRINCIPAL);
    if ($id_clasificacion && $id_malla) {
        $cursos = CAPACITACION_cursosPorClasificacionMalla($id_malla, $id_clasificacion);
        //exit;
    } else if ($id_malla) {
        $cursos = CAPACITACION_cursosPorClasificacionMalla($id_malla, null);
    }
    $total_avance                     = 0;
    $total_puntajes_maximos_por_curso = 0;
    foreach ($cursos as $cur) {
        $row_curso .= file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_bloque_niveles_curso.html");
        $avances                          = ColocaAvanceCursoPorPuntosDeObjetos($row_curso, $cur->id_curso, $rut, $id_empresa);
        $row_curso                        = $avances[0];
        $total_avance                     = $total_avance + $avances[1];
        $total_puntajes_maximos_por_curso = $total_puntajes_maximos_por_curso + $cur->puntos_maximo;
    }
    $promedio  = (100 * $total_avance) / $total_puntajes_maximos_por_curso;
    //echo $total_avance." - ".$total_puntajes_maximos_por_curso;
    $PRINCIPAL = str_replace("{AVANCE_MALLA_POR_OBJETOS}", FormatearPorcentajes($promedio), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_CURSOS_RESUMENES}", $row_curso, $PRINCIPAL);
    return ($PRINCIPAL);
}
//$directorio_galerias='../admin/img/galerias/';
function ColocaAvanceCursoPorPuntosDeObjetos($html, $id_curso, $rut, $id_empresa)
{
    $datos_puntos = TienePuntosConsolidadosPorCurso($rut, $id_empresa, $id_curso);
    $grafico      = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_grafico_avance_curso_por_objeto.html");
    $html         = str_replace("{GRAFICO_AVANCE_CURSO_POR_OBJETOS}", $grafico, $html);
    $html         = str_replace("{TOTAL_PUNTOS_POR_OBJETOS}", $datos_puntos[0]->puntos_maximo, $html);
    $html         = str_replace("{NOMBRE_CURSO}", utf8_encode($datos_puntos[0]->nombre_curso), $html);
    $html         = str_replace("{ID_CURSO}", $id_curso, $html);
    $html         = str_replace("{BRECHA_COMPLETADOS_VS_NOCOMPLETADOS}", $datos_puntos[0]->puntos_maximo - $datos_puntos[0]->suma_puntos_por_curso, $html);
    //if($datos_puntos[0]->suma_puntos_por_curso){
    //    $html = str_replace("{TOTAL_COMPLETADOS}",50,$html);
    //}else{
    //    $html = str_replace("{TOTAL_COMPLETADOS}",0,$html);
    //}
    $html         = str_replace("{TOTAL_COMPLETADOS}", $datos_puntos[0]->suma_puntos_por_curso, $html);
    $arreglo[0]   = $html;
    $arreglo[1]   = $datos_puntos[0]->suma_puntos_por_curso;
    return ($arreglo);
}
function RedimensionarImagenPerfil($rutaImagenOriginal, $nombre_imagen, $ext, $nombre_nuevo_archivo, $id_empresa)
{
    //Ruta de la imagen original
    //$rutaImagenOriginal="./imagen/i2.jpg";
    //Creamos una variable imagen a partir de la imagen original
    if ($ext == "gif") {
        $img_original = imagecreatefromgif($rutaImagenOriginal);
    } else if ($ext == "png") {
        $img_original = imagecreatefrompng($rutaImagenOriginal);
    } else {
        $img_original = imagecreatefromjpeg($rutaImagenOriginal);
    }
    //Se define el maximo ancho o alto que tendra la imagen final
    //$alto_orig=imagesy($img_original);
    //$ancho_orig=imagesx($img_original);
    $max_ancho = 250;
    $max_alto  = 250;
    //Ancho y alto de la imagen original
    list($ancho, $alto) = getimagesize($rutaImagenOriginal);
    //Se calcula ancho y alto de la imagen final
    $x_ratio = $max_ancho / $ancho;
    $y_ratio = $max_alto / $alto;
    //Si el ancho y el alto de la imagen no superan los maximos,
    //ancho final y alto final son los que tiene actualmente
    if (($ancho <= $max_ancho) && ($alto <= $max_alto)) { //Si ancho
        $ancho_final = $ancho;
        $alto_final  = $alto;
    }
    /*
     * si proporcion horizontal*alto mayor que el alto maximo,
     * alto final es alto por la proporcion horizontal
     * es decir, le quitamos al alto, la misma proporcion que
     * le quitamos al alto
     *
     */
    elseif (($x_ratio * $alto) < $max_alto) {
        $alto_final  = ceil($x_ratio * $alto);
        $ancho_final = $max_ancho;
    }
    /*
     * Igual que antes pero a la inversa
     */
    else {
        $ancho_final = ceil($y_ratio * $ancho);
        $alto_final  = $max_alto;
    }
    if ($ancho > $alto) {
        $alto_final  = $max_alto;
        $ancho_final = ceil($y_ratio * $ancho);
    } else if ($alto > $ancho) {
        $alto_final  = ceil($x_ratio * $alto);
        $ancho_final = $max_ancho;
    }
    //Creamos una imagen en blanco de tamaño $ancho_final  por $alto_final .
    $tmp = imagecreatetruecolor($ancho_final, $alto_final);
    //Copiamos $img_original sobre la imagen que acabamos de crear en blanco ($tmp)
    imagecopyresampled($tmp, $img_original, 0, 0, 0, 0, $ancho_final, $alto_final, $ancho, $alto);
    //Se destruye variable $img_original para liberar memoria
    imagedestroy($img_original);
    //Definimos la calidad de la imagen final
    $calidad = 95;
    //Se crea la imagen final en el directorio indicado
    //imagejpeg($tmp,"../front/img/noticias/thum/".$nombre_imagen,$calidad);
    if ($ext == "gif") {
        imagegif($tmp, "img/avatars/" . $id_empresa . "/thum_" . $nombre_nuevo_archivo);
    } else if ($ext == "png") {
        imagepng($tmp, "img/avatars/" . $id_empresa . "/thum_" . $nombre_nuevo_archivo);
    } else {
        imagejpeg($tmp, "img/avatars/" . $id_empresa . "/thum_" . $nombre_nuevo_archivo);
    }
    /* SI QUEREMOS MOSTRAR LA IMAGEN EN EL NAVEGADOR
     *
     * descomentamos las lineas 64 ( Header("Content-type: image/jpeg"); ) y 65 ( imagejpeg($tmp); )
     * y comentamos la linea 57 ( imagejpeg($tmp,"./imagen/retoque.jpg",$calidad); )
     */
    //Header("Content-type: image/jpeg");
    //imagejpeg($tmp);
}
function ColocaImagenVerificaAvatar($rut, $desde_admin)
{
    //Debo traer los datos del usuario, para ver si la foto esta con guion
    if ($_SESSION["id_empresa"] == 28) {
        $datos_usuario = UsuarioEnBasePersonas($rut);
        $numero_sap    = $datos_usuario[0]->codigo_sap;
        $rut           = $numero_sap;
        $rut_completo  = $numero_sap;
        if ($desde_admin == "admin") {
            $ruta              = "img/personas/28/" . $rut;
            $ruta_rut_completo = "img/personas/28/" . $rut_completo;
        } else {
            $ruta              = "img/personas/28/" . $rut;
            $ruta_rut_completo = "img/personas/28/" . $rut_completo;
        }
    } else {
        $datos_usuario = UsuarioEnBasePersonas($rut);
        $rut_completo  = $datos_usuario[0]->rut_completo;
        if ($desde_admin == "admin") {
            $ruta              = "../front/img/personas/" . $rut;
            $ruta_rut_completo = "../front/img/personas/" . $rut_completo;
        } else {
            $ruta              = "img/personas/" . $rut;
            $ruta_rut_completo = "img/personas/" . $rut_completo;
        }
    }
    if ($datos_usuario[0]->avatar) {
        if ($_SESSION["id_empresa"] == 59 or $_SESSION["id_empresa"] == 75 or $_SESSION["id_empresa"] == 22) {
            $imagen = $datos_usuario[0]->avatar;
            //    echo $imagen."<br><br>";
        } else {
            $imagen = "img/avatars/" . $_SESSION["id_empresa"] . "/" . $datos_usuario[0]->avatar;
        }
    } else {
        if (file_exists($ruta . ".jpg")) {
            $imagen = $ruta . ".jpg";
        } else if (file_exists($ruta . ".JPG")) {
            $imagen = $ruta . ".JPG";
        } else if (file_exists($ruta . ".gif")) {
            $imagen = $ruta . ".gif";
        } else if (file_exists($ruta_rut_completo . ".jpg")) {
            $imagen = $ruta_rut_completo . ".jpg";
        } else if (file_exists($ruta_rut_completo . ".JPG")) {
            $imagen = $ruta_rut_completo . ".JPG";
        } else if (file_exists($ruta_rut_completo . ".gif")) {
            $imagen = $ruta_rut_completo . ".gif";
        } else {
            $imagen = "img/sinfoto.png";
        }
    }
    return ($imagen);
}
function ColocaImagenesMedallas($total_medallas, $imagen_medalla)
{
    for ($tot = 1; $tot <= $total_medallas; $tot++) {
        $html_medallas .= "<img src='img/bci_elviaje_medalla.jpg'>";
    }
    return ($html_medallas);
}
function colocaImagenesPorObjeto($id_objeto, $rut, $id_empresa, $pagina, $id_malla, $cantidad_imagenes_galeria)
{
    //echo "$id_objeto, $id_empresa, $pagina, $id_malla)";
    $imagenes = FotosPorObjetoPorMalla($id_objeto, $id_empresa, $pagina, $id_malla, $cantidad_imagenes_galeria);
    $j        = 1;
    foreach ($imagenes as $img) {
        if ($j == 1) {
            $row_html .= "<div class='row'>";
        }
        $row_html .= file_get_contents("views/cursos/objetos/subirFotos/" . $id_empresa . "_lista_archivos.html");
        if ($j == 3) {
            $row_html .= "</div>";
            $j = 1;
        } else {
            $j++;
        }
        $figura   = '<a href="galeria/' . $img->archivo . '" title="' . $img->descripcion . '" onclick="vista_galeria(' . $img->id . ')"  data-gallery><img src="img/objetos/' . $img->archivo . '""></a>';
        $row_html = str_replace("{FIGURA}", $figura, $row_html);
        $row_html = str_replace("{URL_IMAGEN_ARCHIVO}", "img/objetos/" . $img->archivo . "", $row_html);
        $row_html = str_replace("{DESCRIPCION}", utf8_encode($img->nombre_completo), $row_html);
        $row_html = str_replace("{COMENTARIO}", utf8_encode($img->comentarios), $row_html);
        $row_html = str_replace("{URL_IMAGEN_PERSONA}", VerificaFotoPersonal($img->rut_autor), $row_html);
        if ($img->rut_autor == $rut) {
            $row_html = str_replace("{MEGUSTA}", ColocaMeGusta($img->id, "id_imagen_galeria", $id_empresa, $rut, "autor"), $row_html);
            $row_html = str_replace("{DELETE}", file_get_contents("views/cursos/objetos/subirFotos/" . $id_empresa . "_delete_imagen.html"), $row_html);
            $row_html = str_replace("{ID_IMAGEN_ENCODEADA}", Encodear3($img->id), $row_html);
        } else {
            $row_html = str_replace("{MEGUSTA}", ColocaMeGusta($img->id, "id_imagen_galeria", $id_empresa, $rut), $row_html);
            $row_html = str_replace("{DELETE}", "", $row_html);
        }
        $row_html = str_replace("{VISITAS}", 0, $row_html);
        if ($img->modalidad == 1) {
            $row_html = str_replace("{CATEGORIA}", "Mi Mam?", $row_html);
        } else if ($img->modalidad == 2) {
            $row_html = str_replace("{CATEGORIA}", "La Mam? de mis hijos", $row_html);
        } else if ($img->modalidad == 3) {
            $row_html = str_replace("{CATEGORIA}", "Yo como Mam?", $row_html);
        }
    }
    if ($j == 2 or $j == 3) {
        $row_html .= "</div>";
    }
    return ($row_html);
}
function ColocaBloqueRecienteForo($PRINCIPAL, $id_objeto)
{
    //obtengo comentarios dado id_objeto
    $total_comentarios = ObtenerComentariosDadoIdObjeto($id_objeto);
    if ($total_comentarios) {
        foreach ($total_comentarios as $come) {
            $row_html .= file_get_contents("views/cursos/objetos/foro/bloque_comentario_destacado.html");
            $row_html = str_replace("{NOMBRE_COMPLETO}", $come->nombre_completo, $row_html);
            $row_html = str_replace("{COMENTARIO}", $come->comentario, $row_html);
            $row_html = str_replace("{CANTIDAD_MEGUSTA}", $come->total_megusta, $row_html);
            $row_html = str_replace("{TIEMPO}", FechaTipoSpa($come->fecha . " " . $come->hora), $row_html);
            $row_html = str_replace("{URL_PERSONA}", VerificaFotoPersonal($come->rut), $row_html);
        }
        $PRINCIPAL = str_replace("{BLOQUE_DESTACADOS}", utf8_encode($row_html), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_DESTACADOS}", "", $PRINCIPAL);
    }
    return ($PRINCIPAL);
}
function colocaBloqueHomeObjetos1($PRINCIPAL, $id_objeto, $limit)
{
    //obtengo comentarios dado id_objeto
    $total_comentarios = ObtenerComentariosDadoIdObjeto($id_objeto, "", $limit);
    if ($total_comentarios) {
        foreach ($total_comentarios as $come) {
            $row_html .= file_get_contents("views/cursos/objetos/foro/row_reciente.html");
            $row_html = str_replace("{NOMBRE_COMPLETO}", $come->nombre_completo, $row_html);
            $row_html = str_replace("{COMENTARIO}", $come->comentario, $row_html);
            $row_html = str_replace("{CANTIDAD_MEGUSTA}", $come->total_megusta, $row_html);
            $row_html = str_replace("{TIEMPO}", FechaTipoSpa($come->fecha . " " . $come->hora), $row_html);
            $row_html = str_replace("{URL_PERSONA}", VerificaFotoPersonal($come->rut), $row_html);
        }
        $PRINCIPAL = str_replace("{BLOQUE_DESTACADOS1}", utf8_encode($row_html), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_DESTACADOS1}", "", $PRINCIPAL);
    }
    return ($PRINCIPAL);
}
function colocaBloqueHomeObjetos2($PRINCIPAL, $id_objeto, $limit)
{
    //obtengo comentarios dado id_objeto
    $total_comentarios = ObtenerComentariosDadoIdObjeto($id_objeto, "", $limit);
    if ($total_comentarios) {
        foreach ($total_comentarios as $come) {
            $row_html .= file_get_contents("views/cursos/objetos/foro/row_reciente.html");
            $row_html = str_replace("{NOMBRE_COMPLETO}", $come->nombre_completo, $row_html);
            $row_html = str_replace("{COMENTARIO}", $come->comentario, $row_html);
            $row_html = str_replace("{CANTIDAD_MEGUSTA}", $come->total_megusta, $row_html);
            $row_html = str_replace("{TIEMPO}", FechaTipoSpa($come->fecha . " " . $come->hora), $row_html);
            $row_html = str_replace("{URL_PERSONA}", VerificaFotoPersonal($come->rut), $row_html);
        }
        $PRINCIPAL = str_replace("{BLOQUE_DESTACADOS2}", utf8_encode($row_html), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_DESTACADOS2}", "", $PRINCIPAL);
    }
    $PRINCIPAL = str_replace("{BLOQUE_DESTACADOS2}", "2222", $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaMPEstadisticas($PRINCIPAL, $id_empresa)
{
    $total_estadisticas = MPEstadisticasporEstado($id_empresa);
    //print_r($total_estadisticas);
    foreach ($total_estadisticas as $total_estadistica) {
        $row_html .= file_get_contents("views/mejorespracticas/mp_row_estadisticas.html");
        $row_html = str_replace("{NUM}", $total_estadistica->cuenta, $row_html);
        $row_html = str_replace("{ITEM}", utf8_encode($total_estadistica->estado), $row_html);
    }
    $PRINCIPAL = str_replace("{ESTADISTICAS_MP}", $row_html, $PRINCIPAL);
    return ($PRINCIPAL);
}
function GAMIFICACIONColocaEnvironmentBotonModulos($PRINCIPAL, $rut, $id_objetivo, $orden, $id_curso, $id_empresa)
{
    $datos_objeto_por_curso = GAMIFICACIONTraeDatosObjetosPorCurso($rut, $id_curso);
    if ($datos_objeto_por_curso[0]->total_objetos == $datos_objeto_por_curso[0]->total_objetos_finalizados) {
        $PRINCIPAL = str_replace("{ENVIRONMENT_AMBIENTE}", "FinNivel", $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{ENVIRONMENT_AMBIENTE}", "interPant", $PRINCIPAL);
    }
    return ($PRINCIPAL);
}
function ActualizoEstadoInscripcionCierre($id_curso, $rut, $id_empresa)
{
    //
    $datos                     = GAMIFICACIONTraeDatosObjetosPorCurso($rut, $id_curso);
    $total_objetos             = $datos[0]->total_objetos;
    $total_objetos_finalizados = $datos[0]->total_objetos_finalizados;
    $promedio_por_curso        = $datos[0]->promedio_por_curso;
   // print_r($datos);
    $porcentaje_Avance         = ColocaDecimalesNotasFinales(0, (($total_objetos_finalizados * 100) / $total_objetos), $tipo);
    if ($porcentaje_Avance == 100) {

            $estado = 1;

    } else if ($porcentaje_Avance >= 0 or $porcentaje_Avance < 100 and ($total_objetos <> $total_objetos_finalizados)) {
        //en proceso
        $estado = 3;
    }
    //ahora actualizo el porcentaje de avance de la tabla inscripcion cierre
    //ahora,
    $array_malla = BuscaMallaapartirRutCursoObjeto($id_curso, $rut, $id_empresa);
    //print_r($array_malla);
    GAMIFICACIONActualizarDatosCierre($id_curso, $rut, $id_empresa, $porcentaje_Avance, $estado, $promedio_por_curso);
}
function ActualizoEstadoInscripcionCierreObjeto($id_objeto, $id_curso, $rut, $id_empresa, $id_inscripcion)
{

    //echo "$id_objeto, $id_curso, $rut, $id_empresa, $id_inscripcion";
    //
    //echo "hola";
    $datos                     = GAMIFICACIONTraeDatosObjetosPorCurso($rut, $id_curso);
    $total_objetos             = $datos[0]->total_objetos;
    $total_objetos_finalizados = $datos[0]->total_objetos_finalizados;
    $promedio_por_curso        = $datos[0]->promedio_por_curso;
    $datos_objeto              = DatosObjeto($id_objeto);
       // print_r($datos_objeto);
    $porcentaje_Avance         = ColocaDecimalesNotasFinales(0, (($total_objetos_finalizados * 100) / $total_objetos), $tipo);
    if ($porcentaje_Avance == 100) {
        //finalizado
        /*if($id_empresa==61){
        if($promedio_por_curso<75){
        $estado=0;
        }else{
        $estado=1;
        }
        }else{
        */

        if ($datos_objeto[0]->nota_aprobacion <> '' and $promedio_por_curso < $datos_objeto[0]->nota_aprobacion and $datos_objeto[0]->cm <> "OPCIONAL") {
            //REPROBADO
            //$estado=0;
            $estado             = 1;
            $estado_descripcion = "REPROBADO";
        }else if(!$datos_objeto[0]->nota_aprobacion and $promedio_por_curso<100){
            $estado             = 1;
            $estado_descripcion = "REPROBADO";
        }


        else {
            //APROBADO
            $estado             = 1;
            $estado_descripcion = "APROBADO";
        }
        //}
    } else if ($porcentaje_Avance >= 0 or $porcentaje_Avance < 100 and ($total_objetos <> $total_objetos_finalizados)) {
        //en proceso
        $estado = 3;
    }
    //ahora actualizo el porcentaje de avance de la tabla inscripcion cierre
    //ahora,
    $array_malla = BuscaMallaapartirRutCursoObjeto($id_curso, $rut, $id_empresa);
    //print_r($array_malla);
    GAMIFICACIONActualizarDatosCierre($id_curso, $rut, $id_empresa, $porcentaje_Avance, $estado, $promedio_por_curso, $estado_descripcion,$id_inscripcion);
}




function ActualizoTipsGanados($id_objeto, $id_tip, $rut, $id_empresa)
{
    InsertUpdateTipsGanados($id_objeto, $id_tip, $rut, $id_empresa);
}
function GamificacionPuntos($rut, $id_empresa, $id_objeto, $id_curso, $malla, $puntos, $medallas)
{
    //Primero veo si tiene o no en la tabla de puntos
    $tiene_puntos_objeto = GAMIFICACIONTienePuntosPorCursoObjetoRutEmpresa($rut, $id_objeto, $id_curso, $id_empresa);
    if (!$tiene_puntos_objeto) {
        GAMIFICACIONInsertaPuntosPorObjeto($rut, $id_objeto, $id_curso, $id_empresa, $puntos, $medallas);
        $tiene_consolidado_puntos = GAMIFICACIONTienePuntosAcumuladosPorRutEmpresa($rut, $id_empresa);
        if ($tiene_consolidado_puntos) {
            $puntos_para_consolidado = $tiene_consolidado_puntos[0]->puntos + $puntos;
            GAMIFICACIONActualizarDatosConsolidados($rut, $id_empresa, $puntos_para_consolidado, $tiene_consolidado_puntos[0]->nivel, $medallas);
        } else {
            GAMIFICACIONInsertaPuntosAcumulados($rut, $id_empresa, $puntos_para_consolidado, $tiene_consolidado_puntos[0]->nivel, $medallas);
        }
    } else {
        $tiene_consolidado_puntos = GAMIFICACIONTienePuntosAcumuladosPorRutEmpresa($rut, $id_empresa);
        if ($tiene_consolidado_puntos) {
            $puntos_para_consolidado = $tiene_consolidado_puntos[0]->puntos;
            GAMIFICACIONActualizarDatosConsolidados($rut, $id_empresa, $puntos_para_consolidado, $tiene_consolidado_puntos[0]->nivel, $medallas);
        } else {
            GAMIFICACIONInsertaPuntosAcumulados($rut, $id_empresa, $puntos_para_consolidado, $tiene_consolidado_puntos[0]->nivel, $medallas);
        }
    }
    //veo si tiene puntos consolidados
}
function ColocaBloqueDeComentariosFinalesEvaluado($PRINCIPAL, $evaluado, $evaluador, $id_proceso)
{
    $esta_validado_el_evaluado = VerificaSiObjetivosEstanValidadosDadoEvaluadorIdProcesoEvaluado($evaluador, $id_proceso, $evaluado);
    if ($esta_validado_el_evaluado) {
        $html = file_get_contents("views/sgd/objetivos/preguntas_finales_evaluado_evaluado.html");
    } else {
        $finalizado_evaluado = TienePReguntasFinalesEvaluado($evaluado);
        if ($finalizado_evaluado) {
            $html = file_get_contents("views/sgd/objetivos/preguntas_finales_evaluado_lectura.html");
            $html = str_replace("{CORP}", $finalizado_evaluado[0]->conocimiento_corporativo, $html);
            $html = str_replace("{AREA}", $finalizado_evaluado[0]->conocimiento_area, $html);
            $html = str_replace("{INDIVIDUAL}", $finalizado_evaluado[0]->conocimiento_objetivos_individual, $html);
            $html = str_replace("{COMPETENCIAS}", $finalizado_evaluado[0]->conocimiento_competencias, $html);
            $html = str_replace("{TUVE_FEEDBACK}", $finalizado_evaluado[0]->tuve_reunion, $html);
            $html = str_replace("{COMENTARIO}", $finalizado_evaluado[0]->comentarios, $html);
        } else {
            $html = file_get_contents("views/sgd/objetivos/preguntas_finales_evaluado.html");
        }
    }
    $PRINCIPAL = str_replace("{BLOQUE_VALIDACION_EVALUADO}", $html, $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocarRankingPorCamposPorPuntos($PRINCIPAL, $id_empresa, $rut)
{
    $datos_empresa          = DatosEmpresa($id_empresa);
    //Campo1
    $datos_usuario_campo123 = UsuarioEnBaseDePersonasInnerEmpresa($rut);
    $datos                  = GAMIFICACION_TodosLosConsolidadosPorCampoEmpresa($id_empresa, $datos_empresa[0]->campo1);
    if ($datos) {
        $i     = 1;
        $total = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_ranking_grupal_titulo.html");
        $total = str_replace("{NOMBRE_CRITERIO}", $datos_empresa[0]->campo1, $total);
        foreach ($datos as $uni) {
            $total .= file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_ranking_grupal.html");
            $total = str_replace("{RANK}", $i, $total);
            if ($datos_usuario_campo123[0]->{$datos_usuario_campo123[0]->campo1} == $uni->valor_campo) {
                $total = str_replace("{CLASE_COMOVOY}", "lms_miranking", $total);
            } else {
                $total = str_replace("{CLASE_COMOVOY}", "", $total);
            }
            $total = str_replace("{NOMBRE}", $uni->valor_campo, $total);
            $total = str_replace("{PUNTOS}", $uni->suma_puntos, $total);
            $total = str_replace("{MEDALLAS}", $uni->suma_medallas, $total);
            $i++;
        }
    }
    $datos = GAMIFICACION_TodosLosConsolidadosPorCampoEmpresa($id_empresa, $datos_empresa[0]->campo2);
    if ($datos) {
        $i = 1;
        $total .= file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_ranking_grupal_titulo.html");
        $total = str_replace("{NOMBRE_CRITERIO}", $datos_empresa[0]->campo2, $total);
        foreach ($datos as $uni) {
            $total .= file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_ranking_grupal.html");
            $total = str_replace("{RANK}", $i, $total);
            if ($datos_usuario_campo123[0]->{$datos_usuario_campo123[0]->campo2} == $uni->valor_campo) {
                $total = str_replace("{CLASE_COMOVOY}", "lms_miranking", $total);
            } else {
                $total = str_replace("{CLASE_COMOVOY}", "", $total);
            }
            $total = str_replace("{NOMBRE}", $uni->valor_campo, $total);
            $total = str_replace("{PUNTOS}", $uni->suma_puntos, $total);
            $total = str_replace("{MEDALLAS}", $uni->suma_medallas, $total);
            $i++;
        }
    }
    $datos = GAMIFICACION_TodosLosConsolidadosPorCampoEmpresa($id_empresa, $datos_empresa[0]->campo3);
    if ($datos) {
        $i = 1;
        $total .= file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_ranking_grupal_titulo.html");
        $total = str_replace("{NOMBRE_CRITERIO}", $datos_empresa[0]->campo3, $total);
        foreach ($datos as $uni) {
            $total .= file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_ranking_grupal.html");
            $total = str_replace("{RANK}", $i, $total);
            if ($datos_usuario_campo123[0]->{$datos_usuario_campo123[0]->campo3} == $uni->valor_campo) {
                $total = str_replace("{CLASE_COMOVOY}", "lms_miranking", $total);
            } else {
                $total = str_replace("{CLASE_COMOVOY}", "", $total);
            }
            $total = str_replace("{NOMBRE}", $uni->valor_campo, $total);
            $total = str_replace("{PUNTOS}", $uni->suma_puntos, $total);
            $total = str_replace("{MEDALLAS}", $uni->suma_medallas, $total);
            $i++;
        }
    }
    $PRINCIPAL = str_replace("{ROW_RANKING}", utf8_encode($total), $PRINCIPAL);
    return ($PRINCIPAL);
}
function OBJETIVOS_AvanceEvaluador($rut_evaluador, $id_proceso, $id_empresa)
{
    $total_evaluados             = TraeRelacionesSinAeConDatos($rut_evaluador, $id_proceso);
    //Ahora traigo el total de evaluados finalizados en la tabla objetivos_individuales_finalizados
    $total_evaluados_finalizados = VerificoEvaluadosFinalizadosPorEvaluador($rut_evaluador, $id_proceso, $id_empresa);
    //echo count($total_evaluados)."<br>".count($total_evaluados_finalizados);
    if (count($total_evaluados) == count($total_evaluados_finalizados)) {
        $arreglo[0] = 1;
        $arreglo[1] = "Finalizados";
    } else {
        $arreglo[0] = 0;
        $arreglo[1] = "Pendientes";
    }
    return ($arreglo);
}
function ColocarRankingUsuariosPorPuntos($PRINCIPAL, $id_empresa, $id_malla)
{
    //echo "$id_empresa, $id_malla";
    //$total_usuarios=GAMIFICACION_TodosLosConsolidados($id_empresa);
    $total_usuarios = GAMIFICACION_TodosLosConsolidados($id_empresa, $id_malla);
    $i              = 1;
    //print_r($total_usuarios);
    foreach ($total_usuarios as $usu) {
        $total .= file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_ranking_individual.html");
        $total = str_replace("{BLOQUE_DATOS_PERSONALES_VE}", file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_ve_perfil_bloque_datos.html"), $total);
        $total = str_replace("{RANK}", $i, $total);
        $total = str_replace("{NOMBRE_COMPLETO}", $usu->nombre_completo, $total);
        $total = str_replace("{CARGO}", $usu->cargo, $total);
        $total = str_replace("{PUNTOS}", $usu->puntos, $total);
        $total = str_replace("{PUNTOS_CONSOLIDADOS}", $usu->puntosconsolidados, $total);
        $total = str_replace("{medallas}", $usu->medallas, $total);
        //$total = str_replace("{URL_PERSONA}",VerificaFotoPersonal($usu->rut),$total);
        if ($_SESSION["user_"] == $usu->rut) {
            $total = str_replace("{CLASE_COMOVOY}", "lms_miranking", $total);
        } else {
            $total = str_replace("{CLASE_COMOVOY}", "", $total);
        }
        $total                   = str_replace("{URL_PERSONA}", ColocaImagenVerificaAvatar($usu->rut), $total);
        $total                   = str_replace("{RUT_ENCODEADO}", Encodear3($usu->rut), $total);
        $total                   = str_replace("{RUT}", ($usu->rut), $total);
        $total_imagenes_medallas = ColocaImagenesMedallas($usu->medallas, $imagen_medalla);
        $total                   = str_replace("{IMAGENMEDALLAS_USUARIOS}", $total_imagenes_medallas, $total);
        $total                   = str_replace("{CAMPO1}", ($usu->campo1), $total);
        $total                   = str_replace("{CAMPO2}", ($usu->campo2), $total);
        $total                   = str_replace("{CAMPO3}", ($usu->campo3), $total);
        $i++;
    }
    $PRINCIPAL = str_replace("{ROW_RANKING}", utf8_encode($total), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocarBLOQUEDATOSUsuarios($PRINCIPAL, $id_empresa, $rut)
{
    $total                   = str_replace("{BLOQUE_DATOS_PERSONALES}", file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_mi_perfil_bloque_datos.html"), $total);
    $total                   = str_replace("{RANK}", $i, $total);
    $total                   = str_replace("{NOMBRE_COMPLETO}", $usu->nombre_completo, $total);
    $total                   = str_replace("{CARGO}", $usu->cargo, $total);
    $total                   = str_replace("{PUNTOS_CONSOLIDADOS}", $usu->puntosconsolidados, $total);
    $total                   = str_replace("{medallas}", $usu->medallas, $total);
    $total                   = str_replace("{URL_PERSONA}", ColocaImagenVerificaAvatar($usu->rut), $total);
    $total                   = str_replace("{RUT_ENCODEADO}", Encodear3($usu->rut), $total);
    $total                   = str_replace("{RUT}", ($usu->rut), $total);
    $total_imagenes_medallas = ColocaImagenesMedallas($usu->medallas, $imagen_medalla);
    $total                   = str_replace("{IMAGENMEDALLAS_USUARIOS}", $total_imagenes_medallas, $total);
    $total                   = str_replace("{CAMPO1}", ($usu->campo1), $total);
    $total                   = str_replace("{CAMPO2}", ($usu->campo2), $total);
    $total                   = str_replace("{CAMPO3}", ($usu->campo3), $total);
    $total                   = str_replace("{NOMBRE_COMPLETO}", "hol", $total);
    print_r($total);
    return ($total);
}
function GAMIFICACION_ActualizaNivel($id_malla, $id_empresa, $rut)
{
    $datos_nivel = GAMIFICACION_ObtenerNivelesPorMallaEmpresa($id_malla, $id_empresa);
    //ahora que tengo los datos, hago un ciclo, para ver si cada curs esta o no finalizado
    foreach ($datos_nivel as $unico) {
        $estado_por_curso = CAPACITACION_ObtenerEstadoAvanceCurso($rut, $unico->idcurso, "", $id_empresa);
        $curso_finalizado = VErificaCursoFinalizado($unico->idcurso, $rut);
        if ($curso_finalizado)
            continue;
        if ($estado_por_curso[4] == 0) {
            //Verifico si la cantidad de modulos del curso=nivel es igual a los modulos finalizados de este curso=nivel
            $datos_objeto_por_curso = GAMIFICACIONTraeDatosObjetosPorCurso($rut, $id_curso);
            $detalle_nivel          = GAMIFICACION_ObtenerDescripcionNivelesPorIdEmpresa($unico->idnivel, $id_empresa);
            //veo si tiene acumulado los puntos
            $tiene_puntos           = GAMIFICACIONTienePuntosAcumuladosPorRutEmpresa($rut, $id_empresa);
            if ($tiene_puntos) {
                GAMIFICACIONActualizarDatosConsolidados($rut, $id_empresa, $tiene_puntos[0]->puntos, $unico->idnivel, $tiene_puntos[0]->medallas + $unico->medallas);
            } else {
                GAMIFICACIONInsertaPuntosAcumulados($rut, $id_empresa, 0, $unico->idnivel, 0);
            }
            break;
        }
    }
}
function MuestraContenidoCap($PRINCIPAL, $id_objeto, $rut, $pagina, $tipo_template, $id_malla, $rut_colaborador_desde_vista_jefe)
{
    //echo "<br>$id_objeto, $rut, $pagina, $tipo_template, $id_malla, $rut_colaborador_desde_vista_jefe";
    $datos_usuario = UsuarioEnBasePersonas($rut);
    $id_empresa    = $_SESSION["id_empresa"];
    $PRINCIPAL     = str_replace("{NOMBRE_USUARIO}", utf8_encode($datos_usuario[0]->nombre_completo), $PRINCIPAL);
    $datos_objeto  = DatosObjeto($id_objeto);
    if ($datos_objeto[0]->id == "bci_v2017_cm5") {
        $finalizado = ObjetoFinalizadoDadoIdYRut($rut, $datos_objeto[0]->id);
        if ($finalizado) {
            echo "<script>alert('Ya finalizaste el Juego');</script>";
            echo "<script>window.history.back();</script>";
            //exit;
        }
    }
    //print_r($datos_objeto);
    $PRINCIPAL = str_replace("{URL_VOLVER_CHECKIN}", utf8_encode($datos_objeto[0]->url_volver_checkin), $PRINCIPAL);
    if ($_SESSION["id_curso"]) {
        $PRINCIPAL = str_replace("{ID_CURSO_ENCODEADO}", Encodear3($_SESSION["id_curso"]), $PRINCIPAL);
    }
    $objeto_tiene_puntos = GAMIFICACIONTienePuntosPorCursoObjetoRutEmpresa($rut, $id_objeto, $datos_objeto[0]->id_curso, $_SESSION["id_empresa"]);
    $datos_curso         = DetalleCurso($datos_objeto[0]->id_curso);
    $datos_malla         = GAMIFICACIONObtengoDatosMallaCursoDadoRutEmpresa($rut, $_SESSION["id_empresa"]);
    $datos_usuario_malla = ObtenerDatosRelMallaUsuarioDadoRut($rut, $_SESSION["id_empresa"]);
    $objeto_finalizado   = VerObjetoFinalizado($id_objeto, $rut);
    if ($id_malla) {
        $datos_empresa = DatosEmpresa($_SESSION["id_empresa"]);
        //$PRINCIPAL = str_replace("{BLOQUE_OBJETO}",file_get_contents("views/cursos/objetos/foro_cat/formulario_completo.html"),$PRINCIPAL);
        $PRINCIPAL     = ColocaBloqueComparte($PRINCIPAL, $_SESSION["id_empresa"], $id_malla, $rut, "todo");
        $PRINCIPAL     = str_replace("{ENV_HOME}", $datos_empresa[0]->case_home, $PRINCIPAL);
        //$PRINCIPAL = str_replace("{ID_MALLA_ENCODEADA}",$id_malla,$PRINCIPAL);
    }
    if ($datos_objeto[0]->extension_objeto) {
        //Esto quiere decir que tiene algun tipo de extension el objeto
        $datos_extension = DatosExtensionDeObjeto($datos_objeto[0]->extension_objeto);
        $deviceipad      = strtolower($_SERVER[""]);
        $deviceipod      = strtolower($_SERVER[""]);
        if ($datos_objeto[0]->id_template) {
            if (file_exists("views/pagina/" . $datos_malla[0]->id_malla . "_" . ($datos_objeto[0]->template_para_entorno))) {
                $template_objeto = "views/pagina/" . $datos_malla[0]->id_malla . "_" . ($datos_objeto[0]->template_para_entorno);
            } else {
                if ($tipo_template == 11) {
                    ;
                    $template_objeto = "views/pagina/" . ($datos_extension[0]->template_lectura);
                } else {
                    $template_objeto = "views/pagina/" . ($datos_objeto[0]->template_para_entorno);
                }
            }
        } else {
            if ($tipo_template == 1) {
                $template_objeto = ($datos_extension[0]->template_lectura);
            } else {
                //checkin
                if ($datos_objeto[0]->checkin == 1 or $_GET["checkin"] == 1) {
                    $template_objeto = ($datos_extension[0]->template_check);
                    //echo "1";
                } else {
                    if ($datos_objeto[0]->extension_objeto == 21 or $datos_objeto[0]->extension_objeto == 20) {
                        //echo "2";
                        $esta_finalizado = TieneAccionesPEndientes($rut, $_SESSION["id_empresa"], $datos_objeto[0]->id_curso, $id_objeto);
                        if ($esta_finalizado) {
                            //echo "3";
                            $template_objeto = ($datos_extension[0]->template_lectura);
                        } else {
                            //echo "4";
                            $template_objeto = ($datos_extension[0]->template);
                        }
                    } else {
                        if ($objeto_finalizado) {
                            //echo "5";
                            //$template_objeto=($datos_extension[0]->template);
                            $datos_desafio = TraeDatosDesafioDadoId($datos_objeto[0]->id_desafio);
                            //if($datos_desafio[0]->modificable=="si"){
                            if ($_GET["edidesa"] == 1) {
                                if ($datos_desafio[0]->id_objeto) {
                                    //echo "<br>5.1";
                                    $template_objeto = "views/cursos/objetos/desafio/index_" . $datos_desafio[0]->id_objeto . ".html";
                                } else {
                                    //echo "<br>5.2";
                                    $template_objeto = ($datos_extension[0]->template);
                                }
                            } else {
                                $datos_desafio = TraeDatosDesafioDadoId($datos_objeto[0]->id_desafio);
                                if ($datos_desafio[0]->id_objeto) {
                                    //echo "<br>5.3";
                                    $template_objeto = "views/cursos/objetos/desafio/index_lectura_" . $datos_desafio[0]->id_objeto . ".html";
                                } else {
                                    //echo "<br>5.4";
                                    $template_objeto = ($datos_extension[0]->template_lectura);
                                }
                            }
                        } else {
                            //echo "6";
                            //Si es desafio, veo si tiene un template distinto
                            $datos_desafio = TraeDatosDesafioDadoId($datos_objeto[0]->id_desafio);
                            if ($datos_desafio[0]->id_objeto) {
                                $template_objeto = "views/cursos/objetos/desafio/index_" . $datos_desafio[0]->id_objeto . ".html";
                            } else {
                                //echo "cursos/objetos/desafio/".$id_empresa."_".$datos_extension[0]->template;exit;
                                //echo $datos_extension[0]->template;exit;
                                if(file_exists("cursos/objetos/desafio/".$id_empresa."_".$datos_extension[0]->template)){
                                        $template_objeto = $id_empresa."_".$datos_extension[0]->template;
                                }else{
                                    $template_objeto = ($datos_extension[0]->template);
                                }

                            }
                        }
                    }
                }
            }
        }

        //echo $datos_extension[0]->template;
        //echo $template_objeto;
        //exit;
        //$PRINCIPAL = str_replace("{BLOQUE_OBJETO}",file_get_contents($template_objeto),$PRINCIPAL);
        if ($datos_objeto[0]->extension_objeto == 150) {
            $PRINCIPAL = str_replace("{BLOQUE_OBJETO}", '<iframe class="embed-responsive-item" width="100%"  src="' . $datos_objeto[0]->url_objeto . '"></iframe>', $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{BLOQUE_OBJETO}", file_get_contents($template_objeto), $PRINCIPAL);
        }
        $PRINCIPAL           = str_replace("{URL_OBJETO}", $datos_extension[0]->template, $PRINCIPAL);
        //$PRINCIPAL = str_replace("{BLOQUE_OBJETO}",$template_objeto,$PRINCIPAL);
        $PRINCIPAL           = str_replace("{NOMBRE_DOCUMENTO}", $datos_objeto[0]->url_objeto, $PRINCIPAL);
        $PRINCIPAL           = str_replace("{NOMBRE_VIDEO_MP4}", $datos_objeto[0]->url_objeto, $PRINCIPAL);
        //echo Encodear($datos_objeto[0]->url_objeto);
        //$PRINCIPAL = str_replace("{NOMBRE_VIDEO_MP4_ENCODEADA}",Encodear3($datos_objeto[0]->url_objeto),$PRINCIPAL);
        $token_fecha_hora    = Encodear(date("Y-m-d") . "" . date("H:i:s") . "-" . $rut);
        $_SESSION["veVideo"] = $token_fecha_hora;
        $PRINCIPAL           = str_replace("{URL_OBJETO_LINK}", $datos_objeto[0]->url_objeto, $PRINCIPAL);
        $PRINCIPAL           = str_replace("{EXTENSION_OBJETO}", $datos_objeto[0]->duracion_video, $PRINCIPAL);
        $PRINCIPAL           = str_replace("{SESION_VIDEO_ENCODEADO}", $token_fecha_hora, $PRINCIPAL);
        if ($datos_objeto[0]->id_desafio) {
            if ($rut_colaborador_desde_vista_jefe) {
                $PRINCIPAL = str_replace("{ROW_PREGUNTAS}", ColocaPreguntasorDesafio($datos_objeto[0]->id_desafio, $rut_colaborador_desde_vista_jefe, $id_objeto, $datos_objeto[0]->id_curso, $datos_objeto[0]->id_desafio, $_SESSION["id_empresa"]), $PRINCIPAL);
            } else {
                $PRINCIPAL = str_replace("{ROW_PREGUNTAS}", ColocaPreguntasorDesafio($datos_objeto[0]->id_desafio, $rut, $id_objeto, $datos_objeto[0]->id_curso, $datos_objeto[0]->id_desafio, $_SESSION["id_empresa"]), $PRINCIPAL);
            }
            $PRINCIPAL        = str_replace("{ROW_BLOQUE_TEXTOS}", ColocaBloqueTextoDesafio($datos_objeto[0]->id_desafio, $rut, $id_objeto, $datos_objeto[0]->id_curso, $datos_objeto[0]->id_desafio, $_SESSION["id_empresa"]), $PRINCIPAL);
            $PRINCIPAL        = str_replace("{ID_DESAFIO_ENCODEADO}", Encodear3($datos_objeto[0]->id_desafio), $PRINCIPAL);
            $tiene_respuestas = VerificoDesafioPorObjeto($rut, $id_objeto, $datos_objeto[0]->id_curso, $_SESSION["id_empresa"], $datos_objeto[0]->id_desafio);
            if ($tiene_respuestas) {
                //$PRINCIPAL = str_replace("{STYLO_MUESTRA_BOTON1}",'style="display:none;"',$PRINCIPAL);
                if ($_GET["edidesa"] == 1) {
                    $PRINCIPAL = str_replace("{STYLO_MUESTRA_BOTON2_DESAFIOS}", 'style="display:none;"', $PRINCIPAL);
                } else {
                    $PRINCIPAL = str_replace("{STYLO_MUESTRA_BOTON2_DESAFIOS}", "", $PRINCIPAL);
                }
                $PRINCIPAL = str_replace("{STYLO_MUESTRA_BOTON1_DESAFIOS}", '', $PRINCIPAL);
            } else {
                $PRINCIPAL = str_replace("{STYLO_MUESTRA_BOTON1_DESAFIOS}", "", $PRINCIPAL);
                $PRINCIPAL = str_replace("{STYLO_MUESTRA_BOTON2_DESAFIOS}", 'style="display:none;"', $PRINCIPAL);
            }
            $datos_desafio = TraeDatosDesafioDadoId($datos_objeto[0]->id_desafio);
            $PRINCIPAL     = str_replace("{titulo_principal_desafio}", utf8_encode($datos_desafio[0]->titulo_principal_desafio), $PRINCIPAL);
            $PRINCIPAL     = str_replace("{bajada_principal_desafio}", utf8_encode($datos_desafio[0]->bajada_principal_desafio), $PRINCIPAL);
        }
        //PARA SESSIONS
        $PRINCIPAL = str_replace("{TITULO}", utf8_encode($datos_objeto[0]->titulo), $PRINCIPAL);
        $PRINCIPAL = str_replace("{TEXTO_BAJADA}", utf8_encode($datos_objeto[0]->texto_bajada), $PRINCIPAL);
        $PRINCIPAL = str_replace("{BAJADA}", utf8_encode($datos_objeto[0]->bajada), $PRINCIPAL);
        $PRINCIPAL = str_replace("{URL_VIDEO}", utf8_encode($datos_objeto[0]->video), $PRINCIPAL);
        $PRINCIPAL = str_replace("{PDF}", utf8_encode($datos_objeto[0]->archivo), $PRINCIPAL);
        $PRINCIPAL = str_replace("{TRANSCRIPCION}", utf8_encode($datos_objeto[0]->transcripcion), $PRINCIPAL);
        $PRINCIPAL = str_replace("{titulo_principal}", utf8_encode($datos_objeto[0]->titulo_principal), $PRINCIPAL);
        $PRINCIPAL = str_replace("{pregunta_principal}", utf8_encode($datos_objeto[0]->pregunta_principal), $PRINCIPAL);
        $PRINCIPAL = str_replace("{bajada_principal}", utf8_encode($datos_objeto[0]->bajada_principal), $PRINCIPAL);
        $PRINCIPAL = str_replace("{titulo_secundario}", utf8_encode($datos_objeto[0]->titulo_secundario), $PRINCIPAL);
        $PRINCIPAL = str_replace("{bajada_secundario}", utf8_encode($datos_objeto[0]->bajada_secundario), $PRINCIPAL);
        $PRINCIPAL = str_replace("{subtitulo_principal}", utf8_encode($datos_objeto[0]->subtitulo_principal), $PRINCIPAL);
        $PRINCIPAL = str_replace("{bajada_subtitulo_principal}", utf8_encode($datos_objeto[0]->bajada_subtitulo_principal), $PRINCIPAL);
        if ($datos_objeto[0]->rut_relator) {
            $PRINCIPAL = str_replace("{BLOQUE_RELATOR}", file_get_contents("views/cursos/contenidos/bloque_relator_con_link.html"), $PRINCIPAL);
            $PRINCIPAL = str_replace("{RUT_RELATOR_ENCODEADO}", Encodear3($datos_objeto[0]->rut_relator), $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{BLOQUE_RELATOR}", file_get_contents("views/cursos/contenidos/bloque_relator_sin_link.html"), $PRINCIPAL);
        }
        $PRINCIPAL = str_replace("{BIO_RELATOR}", utf8_encode($datos_objeto[0]->bio_relator), $PRINCIPAL);
        $PRINCIPAL = str_replace("{URL_IMAGEN_RELATOR}", utf8_encode($datos_objeto[0]->foto_relator), $PRINCIPAL);
        $PRINCIPAL = str_replace("{URL_MIPERFIL}", VerificaFotoPersonal($rut), $PRINCIPAL);
        //Bloque con textos
        $PRINCIPAL = str_replace("{RESUMEN_EJECUTIVO}", ColocaBloqueTextosPorObjeto($datos_objeto[0]->id), $PRINCIPAL);
        //Bloque con citas
        $PRINCIPAL = str_replace("{ENTORNO_CITA}", ColocaBloqueCitasPorObjeto($datos_objeto[0]->id), $PRINCIPAL);
        //BLOQUE MP3
        $PRINCIPAL = str_replace("{ENTORNO_DOCUMENTOS}", ColocaBloqueDocumentosPorObjeto($datos_objeto[0]->id), $PRINCIPAL);
        //Bloque Biograf?a Profesional
        if ($rut_colaborador_desde_vista_jefe) {
            $PRINCIPAL = ColocaDatosBiografiaProfesional($datos_objeto[0]->id, $rut_colaborador_desde_vista_jefe, $PRINCIPAL);
        } else {
            $PRINCIPAL = ColocaDatosBiografiaProfesional($datos_objeto[0]->id, $rut, $PRINCIPAL);
        }
        //Bloque para Documentos
        $PRINCIPAL                             = str_replace("{ENTORNO_MP3}", ColocaBloqueMP3PorObjeto($datos_objeto[0]->id), $PRINCIPAL);
        //Bloque para Pregunta
        $PRINCIPAL                             = str_replace("{ENTORNO_PREGUNTA}", ColocaBloquePreguntaPorObjeto($datos_objeto[0]->id, $rut, 1), $PRINCIPAL);
        $PRINCIPAL                             = str_replace("{ENTORNO_PREGUNTA_UNICA_POR_OBJETO}", ColocaBloquePreguntaPorObjetoUnicaRadio($datos_objeto[0]->id, $rut, 1), $PRINCIPAL);
        //Bloque para Comentarios - Post
        $PRINCIPAL                             = str_replace("{LISTADO_COMENTARIOS}", ColocaBloqueComentariosPorObjeto($datos_objeto[0]->id, $rut), $PRINCIPAL);
        $PRINCIPAL                             = str_replace("{GALERIA_VIDEOS_USUARIOS_}", colocaVideosPorObjeto($datos_objeto[0]->id, $rut, $_SESSION["id_empresa"], $pagina, $datos_malla[0]->id_malla), $PRINCIPAL);
        //Bloque para Compromisos
        $PRINCIPAL                             = str_replace("{LISTADO_COMPROMISOS_POR_OBJETO}", ColocaCompromisosPorObjeto($datos_objeto[0]->id, $rut), $PRINCIPAL);
        //Bloque para Comentarios - Con Reply
        $PRINCIPAL                             = str_replace("{LISTADO_COMENTARIOS_CON_REPLY}", ColocaBloqueComentariosPorObjetoConReplay($datos_objeto[0]->id, $rut, $rut_colaborador_desde_vista_jefe), $PRINCIPAL);
        //Verifico si el colaborador, esta finalizado con su desafio, si es asi, no muestro los botones
        $esta_finalizado_por_agente_el_desafio = EstaFinalizadoDesafio($rut_colaborador_desde_vista_jefe, $datos_objeto[0]->id, $datos_objeto[0]->id_curso, $_SESSION["id_empresa"]);
        if ($esta_finalizado_por_agente_el_desafio) {
            $PRINCIPAL = str_replace("{BOTON_VALIDA}", file_get_contents("views/cursos/objetos/desafio/boton_validado_desafio.html"), $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{BOTON_VALIDA}", file_get_contents("views/cursos/objetos/desafio/boton_valida_desafio_final.html"), $PRINCIPAL);
        }
        $estavalidado_vistacolaborador = EstaFinalizadoDesafio($rut, $datos_objeto[0]->id, $datos_objeto[0]->id_curso, $_SESSION["id_empresa"]);
        if ($estavalidado_vistacolaborador) {
            $PRINCIPAL = str_replace("{BOTON_MODIFICAR_VISTA_COLABORADOR}", file_get_contents("views/cursos/objetos/desafio/boton_validado_desafio.html"), $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{BOTON_MODIFICAR_VISTA_COLABORADOR}", file_get_contents("views/cursos/objetos/desafio/boton_modifica_desafio.html"), $PRINCIPAL);
        }
        //Bloque para Comentarios - Con Reply Por USUARIO
        //$PRINCIPAL = str_replace("{LISTADO_COMENTARIOS_CON_REPLY}",ColocaBloqueComentariosPorObjetoConReplayPorUsuario($datos_objeto[0]->id, $rut, $rut_colaborador_desde_vista_jefe), $PRINCIPAL);
        //Bloque para Pregunta 2
        $PRINCIPAL = str_replace("{ENTORNO_PREGUNTA_2}", ColocaBloquePreguntaPorObjeto($datos_objeto[0]->id, $rut, 2), $PRINCIPAL);
        //Coloca datos de la linea de tiempo del Desafio
        $PRINCIPAL = str_replace("{FECHA_CREACION_DESAFIO}", ColocaFechaCreacionDesafio($datos_objeto[0]->id, $rut, $rut_colaborador_desde_vista_jefe), $PRINCIPAL);
        $PRINCIPAL = str_replace("{GALERIA_FOTOS_USUARIOS_}", colocaImagenesPorObjeto($datos_objeto[0]->id, $rut, $_SESSION["id_empresa"], $pagina, $datos_usuario_malla[0]->id_malla, 12), $PRINCIPAL);
        $PRINCIPAL = str_replace("{GALERIA_FOTOS_USUARIOS_DESDE_MULTIMEDIA}", colocaImagenesPorObjeto($datos_objeto[0]->id, $rut, $_SESSION["id_empresa"], $pagina, $datos_usuario_malla[0]->id_malla, 12), $PRINCIPAL);
        $PRINCIPAL = str_replace("{PAGINACION_GALERIA_IMAGENES}", ColocaPaginacionDeImagenes($pagina, $datos_objeto[0]->id, $rut, $datos_malla[0]->id_malla), $PRINCIPAL);
        //Bloque para Listado de preguntas creadas por el relator. CHECKIN
        $PRINCIPAL = str_replace("{LISTADO_PREGUNTAS_POR_EVAL}", ColocaPReguntasPorEval($datos_objeto[0]->id), $PRINCIPAL);
        //Bloque para olocar datos de las Acciones Pendientes
        if ($rut_colaborador_desde_vista_jefe) {
            $PRINCIPAL = ColocaDatosAccionesClaves($datos_objeto[0]->id, $datos_objeto[0]->id_curso, $_SESSION["id_empresa"], $rut_colaborador_desde_vista_jefe, $PRINCIPAL);
        } else {
            $PRINCIPAL = ColocaDatosAccionesClaves($datos_objeto[0]->id, $datos_objeto[0]->id_curso, $_SESSION["id_empresa"], $rut, $PRINCIPAL);
        }
        //Arma paginacion para GALERIA DE IMAGENES
    } else if ($datos_objeto[0]->id_encuesta) {
        echo "encuesta";
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_OBJETO}", file_get_contents("views/cursos/contenidos/bloque_iframe.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{URL_OBJETO}", $datos_objeto[0]->url, $PRINCIPAL);
        $PRINCIPAL = str_replace("{EXTENSION_OBJETO}", $datos_objeto[0]->duracion_video, $PRINCIPAL);
    }
    //Dado la extension del objeto, traigo el template a utilizar por el tipo de objeto.
    //DESCARGABLES
    if ($datos_objeto[0]->transcripcion <> '') {
        $descargable = "
    <div class='subtituloSeccionMiEquipo'>
    <div class='icon-block half bg-orange-300'>
        <span aria-hidden='true' class='text-white_icon icon-cloud-download'></span>
    </div>
Material Complementario
</div><br>
    <div class='alert alert-info' role='alert'>
     <a href='" . $datos_objeto[0]->transcripcion . "' class='btn btn-success' target='_blank'><span class='blanco'> Descarga aqu? documento complementario del curso.</span></a></div>";
    } else {
        $descargable = "";
    }
    $PRINCIPAL = str_replace("{NOMBRE_OBJETO}", utf8_encode($datos_objeto[0]->titulo), $PRINCIPAL);
    $PRINCIPAL = str_replace("{NUMERO_OBJETO}", ($datos_objeto[0]->orden), $PRINCIPAL);
    $PRINCIPAL = str_replace("{DESCARGABLE}", ($descargable), $PRINCIPAL);
    //Interacciones
    if ($datos_objeto[0]->paramasinfo == "interacciones") {
        $PRINCIPAL   = str_replace("{TITULO_INTERACCIONES}", file_get_contents("views/cursos/contenidos/bloque_titulo_interacciones.html"), $PRINCIPAL);
        $PRINCIPAL   = str_replace("{BLOQUE_INTERACCIONES}", file_get_contents("views/cursos/contenidos/bloque_interacciones.html"), $PRINCIPAL);
        $PRINCIPAL   = str_replace("{ID_OBJETO}", ($id_objeto), $PRINCIPAL);
        $PRINCIPAL   = str_replace("{USUARIO_EMBAJADOR}", ($rut), $PRINCIPAL);
        $comentarios = ColocaComentariosInterraccionesGenericoObjetos($id_empresa, $id_objeto, $rut);
        $PRINCIPAL   = str_replace("{BLOQUE_COMENTARIOS_INGRESADOS" . $datos_objeto[0]->id . "}", ($comentarios), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{TITULO_INTERACCIONES}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{BLOQUE_INTERACCIONES}", "", $PRINCIPAL);
    }
    //Seccion del Cronometro
    $PRINCIPAL = BarraNavegacion($PRINCIPAL, "contenido");
    $PRINCIPAL = str_replace("{CRONOMETRO_PARA_CONTENIDOS}", file_get_contents("views/cursos/contenidos/cronometro.html"), $PRINCIPAL);
    //Verifico si esta finalizado o no este objetos
    if ($objeto_tiene_puntos) {
        $PRINCIPAL = str_replace("{BOTON_MATERIAL_OK}", "", $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BOTON_MATERIAL_OK}", file_get_contents("views/cursos/contenidos/" . $_SESSION["id_empresa"] . "_boton_ok_material.html"), $PRINCIPAL);
    }
    //if($objeto_finalizado && $datos_objeto[0]->opcional<>1){
    if ($datos_objeto[0]->opcional == 1 && $datos_objeto[0]->extension_objeto <> 25) {
        $PRINCIPAL = str_replace("{BOTON_VOLVER}", file_get_contents("views/cursos/contenidos/boton_volver_curso.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_CURSO_ENCODEADO_VOLVER}", Encodear3($datos_objeto[0]->id_curso), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ENVBOTON}", "backcont", $PRINCIPAL);
        $PRINCIPAL = str_replace("{BOTON_FINALIZAR}", file_get_contents("views/cursos/contenidos/boton_siguiente_curso_v2.html"), $PRINCIPAL);
    } else {
        if ($_SESSION["id_empresa"] == 59) {
            $PRINCIPAL = str_replace("{BOTON_FINALIZAR}", file_get_contents("views/cursos/contenidos/59_boton_finaliza_curso.html"), $PRINCIPAL);
        } else {
            if ($objeto_finalizado && $datos_objeto[0]->id_desafio <> '') {
                $PRINCIPAL = str_replace("{BOTON_FINALIZAR}", "", $PRINCIPAL);
            } else {
                $PRINCIPAL = str_replace("{BOTON_FINALIZAR}", file_get_contents("views/cursos/contenidos/boton_finaliza_curso.html"), $PRINCIPAL);
            }
        }
        $PRINCIPAL = str_replace("{ID_OBJETIVO_ENCODEADO}", Encodear3($id_objeto), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ENVBOTON}", "fincont", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_CURSO_ENCODEADO}", Encodear3($datos_objeto[0]->id_curso), $PRINCIPAL);
        $PRINCIPAL = str_replace("{BOTON_VOLVER}", file_get_contents("views/cursos/contenidos/CAP_boton_volver_curso.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_CURSO_ENCODEADO_VOLVER}", Encodear3($datos_objeto[0]->id_curso), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ENVBOTON}", "backcont", $PRINCIPAL);
    }
    $PRINCIPAL                        = str_replace("{RUT_ENCODEADO}", Encodear3($rut), $PRINCIPAL);
    $PRINCIPAL                        = str_replace("{ID_OBJETO}", ($id_objeto), $PRINCIPAL);
    $PRINCIPAL                        = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($id_objeto), $PRINCIPAL);
    //ACA OBTENGO EL SIGUIENTE OBJETO
    $datos_siguiente_objeto           = DatosObjetoDadoRutCursoyOrden($datos_objeto[0]->id_curso, $datos_objeto[0]->orden + 1);
    $PRINCIPAL                        = str_replace("{ID_SIGUIENTE_OBJETO_ENCODEADO}", Encodear3($datos_siguiente_objeto[0]->id), $PRINCIPAL);
    //total de navegacion para esteobjeto, rut y curso
    $suma_navegacion_por_curso_objeto = SumaNavegacionesDadoRutYObjeto($rut, $id_objeto, $datos_objeto[0]->id_curso);
    if ($suma_navegacion_por_curso_objeto[0]->total_tiempo) {
        $PRINCIPAL = str_replace("{SUMA_NAVEGACION}", ($suma_navegacion_por_curso_objeto[0]->total_tiempo), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{SUMA_NAVEGACION}", "00:00:00", $PRINCIPAL);
    }
    //echo $datos_objeto[0]->id_curso;
    $PRINCIPAL = str_replace("{CODIGO_CURSO_ENCODEADO}", Encodear3($datos_objeto[0]->id_curso), $PRINCIPAL);
    $PRINCIPAL = str_replace("{RUT_JEFATURA}", Encodear3($datos_usuario[0]->jefe), $PRINCIPAL);
    $PRINCIPAL = str_replace("{RUT_JEFATURA_DESDE_VISTA_JEFE}", Encodear3($rut), $PRINCIPAL);
    $PRINCIPAL = str_replace("{RUT_ENCODEADO_DESDE_VISTA_JEFE}", Encodear3($rut_colaborador_desde_vista_jefe), $PRINCIPAL);
    $PRINCIPAL = str_replace("{BLOQUE_OBJETO-PDF}", file_get_contents("dflip/examples/entorno_objeto.html"), $PRINCIPAL);
    $PRINCIPAL = str_replace("{BLOQUE_OBJETO-PDF-URL}", "dflip/examples/entorno_objeto.html", $PRINCIPAL);
    $PRINCIPAL = str_replace("{PDF}", $datos_objeto[0]->url, $PRINCIPAL);
    return ($PRINCIPAL);
}
function comprimir_pagina($buffer)
{
    $busca     = array(
        '/\>[^\S ]+/s',
        '/[^\S ]+\</s',
        '/(\s)+/s'
    );
    $reemplaza = array(
        '>',
        '<',
        '\\1'
    );
    return preg_replace($busca, $reemplaza, $buffer);
}
function MuestraContenidoCapBK17012017($PRINCIPAL, $id_objeto, $rut, $pagina, $tipo_template, $id_malla, $rut_colaborador_desde_vista_jefe)
{
    $cantidad_imagenes_galeria = 9;
    //echo "$id_objeto, $rut, $pagina, $tipo_template, $id_malla, $rut_colaborador_desde_vista_jefe";
    $datos_usuario             = UsuarioEnBasePersonas($rut);
    $PRINCIPAL                 = str_replace("{NOMBRE_USUARIO}", utf8_encode($datos_usuario[0]->nombre_completo), $PRINCIPAL);
    $datos_objeto              = DatosObjeto($id_objeto);
    //print_r($datos_objeto);
    $PRINCIPAL                 = str_replace("{URL_VOLVER_CHECKIN}", utf8_encode($datos_objeto[0]->url_volver_checkin), $PRINCIPAL);
    if ($_SESSION["id_curso"]) {
        $PRINCIPAL = str_replace("{ID_CURSO_ENCODEADO}", Encodear3($_SESSION["id_curso"]), $PRINCIPAL);
    }
    $objeto_tiene_puntos = GAMIFICACIONTienePuntosPorCursoObjetoRutEmpresa($rut, $id_objeto, $datos_objeto[0]->id_curso, $_SESSION["id_empresa"]);
    $datos_curso         = DetalleCurso($datos_objeto[0]->id_curso);
    $datos_malla         = GAMIFICACIONObtengoDatosMallaCursoDadoRutEmpresa($rut, $_SESSION["id_empresa"]);
    $datos_usuario_malla = ObtenerDatosRelMallaUsuarioDadoRut($rut, $_SESSION["id_empresa"]);
    $objeto_finalizado   = VerObjetoFinalizado($id_objeto, $rut);
    if ($id_malla) {
        $datos_empresa = DatosEmpresa($_SESSION["id_empresa"]);
        //$PRINCIPAL = str_replace("{BLOQUE_OBJETO}",file_get_contents("views/cursos/objetos/foro_cat/formulario_completo.html"),$PRINCIPAL);
        $PRINCIPAL     = ColocaBloqueComparte($PRINCIPAL, $_SESSION["id_empresa"], $id_malla, $rut, "todo");
        $PRINCIPAL     = str_replace("{ENV_HOME}", $datos_empresa[0]->case_home, $PRINCIPAL);
        //$PRINCIPAL = str_replace("{ID_MALLA_ENCODEADA}",$id_malla,$PRINCIPAL);
    }
    if ($datos_objeto[0]->extension_objeto) {
        //Esto quiere decir que tiene algun tipo de extension el objeto
        $datos_extension = DatosExtensionDeObjeto($datos_objeto[0]->extension_objeto);
        $deviceipad      = strtolower($_SERVER[""]);
        $deviceipod      = strtolower($_SERVER[""]);
        if ($datos_objeto[0]->id_template) {
            if (file_exists("views/pagina/" . $datos_malla[0]->id_malla . "_" . ($datos_objeto[0]->template_para_entorno))) {
                $template_objeto = "views/pagina/" . $datos_malla[0]->id_malla . "_" . ($datos_objeto[0]->template_para_entorno);
            } else {
                if ($tipo_template == 11) {
                    ;
                    $template_objeto = "views/pagina/" . ($datos_extension[0]->template_lectura);
                } else {
                    $template_objeto = "views/pagina/" . ($datos_objeto[0]->template_para_entorno);
                }
            }
        } else {
            if ($tipo_template == 1) {
                $template_objeto = ($datos_extension[0]->template_lectura);
            } else {
                //checkin
                if ($datos_objeto[0]->checkin == 1 or $_GET["checkin"] == 1) {
                    $template_objeto = ($datos_extension[0]->template_check);
                    //echo "1";
                } else {
                    if ($datos_objeto[0]->extension_objeto == 21 or $datos_objeto[0]->extension_objeto == 20) {
                        //echo "2";
                        $esta_finalizado = TieneAccionesPEndientes($rut, $_SESSION["id_empresa"], $datos_objeto[0]->id_curso, $id_objeto);
                        if ($esta_finalizado) {
                            //echo "3";
                            $template_objeto = ($datos_extension[0]->template_lectura);
                        } else {
                            //echo "4";
                            $template_objeto = ($datos_extension[0]->template);
                        }
                    } else {
                        if ($objeto_finalizado) {
                            //$template_objeto=($datos_extension[0]->template);
                            //$template_objeto=($datos_extension[0]->template_lectura);
                            $datos_desafio = TraeDatosDesafioDadoId($datos_objeto[0]->id_desafio);
                            //if($datos_desafio[0]->modificable=="si"){
                            if ($_GET["edidesa"] == 1) {
                                if ($datos_desafio[0]->id_objeto) {
                                    $template_objeto = "views/cursos/objetos/desafio/index_" . $datos_desafio[0]->id_objeto . ".html";
                                } else {
                                    $template_objeto = ($datos_extension[0]->template);
                                }
                            } else {
                                $template_objeto = ($datos_extension[0]->template_lectura);
                            }
                        } else {
                            //$template_objeto=($datos_extension[0]->template);
                            $datos_desafio = TraeDatosDesafioDadoId($datos_objeto[0]->id_desafio);
                            if ($datos_desafio[0]->id_objeto) {
                                $template_objeto = "views/cursos/objetos/desafio/index_" . $datos_desafio[0]->id_objeto . ".html";
                            } else {
                                $template_objeto = ($datos_extension[0]->template);
                            }
                        }
                    }
                }
            }
        }
        //echo $datos_extension[0]->template;
        $PRINCIPAL = str_replace("{BLOQUE_OBJETO}", file_get_contents($template_objeto), $PRINCIPAL);
        $PRINCIPAL = str_replace("{URL_OBJETO}", $datos_extension[0]->template, $PRINCIPAL);
        //$PRINCIPAL = str_replace("{BLOQUE_OBJETO}",$template_objeto,$PRINCIPAL);
        $PRINCIPAL = str_replace("{NOMBRE_DOCUMENTO}", $datos_objeto[0]->url_objeto, $PRINCIPAL);
        $PRINCIPAL = str_replace("{NOMBRE_VIDEO_MP4}", $datos_objeto[0]->url_objeto, $PRINCIPAL);
        $PRINCIPAL = str_replace("{URL_OBJETO_LINK}", $datos_objeto[0]->url_objeto, $PRINCIPAL);
        $PRINCIPAL = str_replace("{EXTENSION_OBJETO}", $datos_objeto[0]->duracion_video, $PRINCIPAL);
        if ($datos_objeto[0]->id_desafio) {
            if ($rut_colaborador_desde_vista_jefe) {
                $PRINCIPAL = str_replace("{ROW_PREGUNTAS}", ColocaPreguntasorDesafio($datos_objeto[0]->id_desafio, $rut_colaborador_desde_vista_jefe, $id_objeto, $datos_objeto[0]->id_curso, $datos_objeto[0]->id_desafio, $_SESSION["id_empresa"]), $PRINCIPAL);
            } else {
                $PRINCIPAL = str_replace("{ROW_PREGUNTAS}", ColocaPreguntasorDesafio($datos_objeto[0]->id_desafio, $rut, $id_objeto, $datos_objeto[0]->id_curso, $datos_objeto[0]->id_desafio, $_SESSION["id_empresa"]), $PRINCIPAL);
            }
            $PRINCIPAL        = str_replace("{ROW_BLOQUE_TEXTOS}", ColocaBloqueTextoDesafio($datos_objeto[0]->id_desafio, $rut, $id_objeto, $datos_objeto[0]->id_curso, $datos_objeto[0]->id_desafio, $_SESSION["id_empresa"]), $PRINCIPAL);
            $PRINCIPAL        = str_replace("{ID_DESAFIO_ENCODEADO}", Encodear3($datos_objeto[0]->id_desafio), $PRINCIPAL);
            $tiene_respuestas = VerificoDesafioPorObjeto($rut, $id_objeto, $datos_objeto[0]->id_curso, $_SESSION["id_empresa"], $datos_objeto[0]->id_desafio);
            /*if($tiene_respuestas){
            $PRINCIPAL = str_replace("{STYLO_MUESTRA_BOTON2_DESAFIOS}","",$PRINCIPAL);
            $PRINCIPAL = str_replace("{STYLO_MUESTRA_BOTON1_DESAFIOS}",'',$PRINCIPAL);
            }else{
            $PRINCIPAL = str_replace("{STYLO_MUESTRA_BOTON1_DESAFIOS}","",$PRINCIPAL);
            $PRINCIPAL = str_replace("{STYLO_MUESTRA_BOTON2_DESAFIOS}",'style="display:none;"',$PRINCIPAL);
            }*/
            if ($tiene_respuestas) {
                //$PRINCIPAL = str_replace("{STYLO_MUESTRA_BOTON1}",'style="display:none;"',$PRINCIPAL);
                if ($_GET["edidesa"] == 1) {
                    $PRINCIPAL = str_replace("{STYLO_MUESTRA_BOTON2_DESAFIOS}", 'style="display:none;"', $PRINCIPAL);
                } else {
                    $PRINCIPAL = str_replace("{STYLO_MUESTRA_BOTON2_DESAFIOS}", "", $PRINCIPAL);
                }
                $PRINCIPAL = str_replace("{STYLO_MUESTRA_BOTON1_DESAFIOS}", '', $PRINCIPAL);
            } else {
                $PRINCIPAL = str_replace("{STYLO_MUESTRA_BOTON1_DESAFIOS}", "", $PRINCIPAL);
                $PRINCIPAL = str_replace("{STYLO_MUESTRA_BOTON2_DESAFIOS}", 'style="display:none;"', $PRINCIPAL);
            }
            $datos_desafio = TraeDatosDesafioDadoId($datos_objeto[0]->id_desafio);
            $PRINCIPAL     = str_replace("{titulo_principal_desafio}", utf8_encode($datos_desafio[0]->titulo_principal_desafio), $PRINCIPAL);
            $PRINCIPAL     = str_replace("{bajada_principal_desafio}", utf8_encode($datos_desafio[0]->bajada_principal_desafio), $PRINCIPAL);
        }
        //PARA SESSIONS
        $PRINCIPAL = str_replace("{TITULO}", utf8_encode($datos_objeto[0]->titulo), $PRINCIPAL);
        $PRINCIPAL = str_replace("{TEXTO_BAJADA}", utf8_encode($datos_objeto[0]->texto_bajada), $PRINCIPAL);
        $PRINCIPAL = str_replace("{BAJADA}", utf8_encode($datos_objeto[0]->bajada), $PRINCIPAL);
        $PRINCIPAL = str_replace("{URL_VIDEO}", utf8_encode($datos_objeto[0]->video), $PRINCIPAL);
        $PRINCIPAL = str_replace("{PDF}", utf8_encode($datos_objeto[0]->archivo), $PRINCIPAL);
        $PRINCIPAL = str_replace("{TRANSCRIPCION}", utf8_encode($datos_objeto[0]->transcripcion), $PRINCIPAL);
        $PRINCIPAL = str_replace("{titulo_principal}", utf8_encode($datos_objeto[0]->titulo_principal), $PRINCIPAL);
        $PRINCIPAL = str_replace("{pregunta_principal}", utf8_encode($datos_objeto[0]->pregunta_principal), $PRINCIPAL);
        $PRINCIPAL = str_replace("{bajada_principal}", utf8_encode($datos_objeto[0]->bajada_principal), $PRINCIPAL);
        $PRINCIPAL = str_replace("{titulo_secundario}", utf8_encode($datos_objeto[0]->titulo_secundario), $PRINCIPAL);
        $PRINCIPAL = str_replace("{bajada_secundario}", utf8_encode($datos_objeto[0]->bajada_secundario), $PRINCIPAL);
        $PRINCIPAL = str_replace("{subtitulo_principal}", utf8_encode($datos_objeto[0]->subtitulo_principal), $PRINCIPAL);
        $PRINCIPAL = str_replace("{bajada_subtitulo_principal}", utf8_encode($datos_objeto[0]->bajada_subtitulo_principal), $PRINCIPAL);
        if ($datos_objeto[0]->rut_relator) {
            $PRINCIPAL = str_replace("{BLOQUE_RELATOR}", file_get_contents("views/cursos/contenidos/bloque_relator_con_link.html"), $PRINCIPAL);
            $PRINCIPAL = str_replace("{RUT_RELATOR_ENCODEADO}", Encodear3($datos_objeto[0]->rut_relator), $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{BLOQUE_RELATOR}", file_get_contents("views/cursos/contenidos/bloque_relator_sin_link.html"), $PRINCIPAL);
        }
        $PRINCIPAL = str_replace("{BIO_RELATOR}", utf8_encode($datos_objeto[0]->bio_relator), $PRINCIPAL);
        $PRINCIPAL = str_replace("{URL_IMAGEN_RELATOR}", utf8_encode($datos_objeto[0]->foto_relator), $PRINCIPAL);
        $PRINCIPAL = str_replace("{URL_MIPERFIL}", VerificaFotoPersonal($rut), $PRINCIPAL);
        //Bloque con textos
        $PRINCIPAL = str_replace("{RESUMEN_EJECUTIVO}", ColocaBloqueTextosPorObjeto($datos_objeto[0]->id), $PRINCIPAL);
        //Bloque con citas
        $PRINCIPAL = str_replace("{ENTORNO_CITA}", ColocaBloqueCitasPorObjeto($datos_objeto[0]->id), $PRINCIPAL);
        //BLOQUE MP3
        $PRINCIPAL = str_replace("{ENTORNO_DOCUMENTOS}", ColocaBloqueDocumentosPorObjeto($datos_objeto[0]->id), $PRINCIPAL);
        //Bloque Biograf?a Profesional
        if ($rut_colaborador_desde_vista_jefe) {
            $PRINCIPAL = ColocaDatosBiografiaProfesional($datos_objeto[0]->id, $rut_colaborador_desde_vista_jefe, $PRINCIPAL);
        } else {
            $PRINCIPAL = ColocaDatosBiografiaProfesional($datos_objeto[0]->id, $rut, $PRINCIPAL);
        }
        //Bloque para Documentos
        $PRINCIPAL                             = str_replace("{ENTORNO_MP3}", ColocaBloqueMP3PorObjeto($datos_objeto[0]->id), $PRINCIPAL);
        //Bloque para Pregunta
        $PRINCIPAL                             = str_replace("{ENTORNO_PREGUNTA}", ColocaBloquePreguntaPorObjeto($datos_objeto[0]->id, $rut, 1), $PRINCIPAL);
        $PRINCIPAL                             = str_replace("{ENTORNO_PREGUNTA_UNICA_POR_OBJETO}", ColocaBloquePreguntaPorObjetoUnicaRadio($datos_objeto[0]->id, $rut, 1), $PRINCIPAL);
        //Bloque para Comentarios - Post
        $PRINCIPAL                             = str_replace("{LISTADO_COMENTARIOS}", ColocaBloqueComentariosPorObjeto($datos_objeto[0]->id, $rut, $pagina, $cantidad_imagenes_galeria), $PRINCIPAL);
        //PAginacion para los FORO
        $PRINCIPAL                             = str_replace("{PAGINACION_COMENTARIOS}", ColocaPaginacionDeComentarios($pagina, $datos_objeto[0]->id, $rut, $datos_malla[0]->id_malla, $cantidad_imagenes_galeria), $PRINCIPAL);
        //Bloque para Compromisos
        $PRINCIPAL                             = str_replace("{LISTADO_COMPROMISOS_POR_OBJETO}", ColocaCompromisosPorObjeto($datos_objeto[0]->id, $rut), $PRINCIPAL);
        //Bloque para Comentarios - Con Reply
        $PRINCIPAL                             = str_replace("{LISTADO_COMENTARIOS_CON_REPLY}", ColocaBloqueComentariosPorObjetoConReplay($datos_objeto[0]->id, $rut), $PRINCIPAL);
        $esta_finalizado_por_agente_el_desafio = EstaFinalizadoDesafio($rut_colaborador_desde_vista_jefe, $datos_objeto[0]->id, $datos_objeto[0]->id_curso, $_SESSION["id_empresa"]);
        if ($esta_finalizado_por_agente_el_desafio) {
            $PRINCIPAL = str_replace("{BOTON_VALIDA}", file_get_contents("views/cursos/objetos/desafio/boton_validado_desafio.html"), $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{BOTON_VALIDA}", file_get_contents("views/cursos/objetos/desafio/boton_valida_desafio_final.html"), $PRINCIPAL);
        }
        $estavalidado_vistacolaborador = EstaFinalizadoDesafio($rut, $datos_objeto[0]->id, $datos_objeto[0]->id_curso, $_SESSION["id_empresa"]);
        if ($estavalidado_vistacolaborador) {
            $PRINCIPAL = str_replace("{BOTON_MODIFICAR_VISTA_COLABORADOR}", file_get_contents("views/cursos/objetos/desafio/boton_validado_desafio.html"), $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{BOTON_MODIFICAR_VISTA_COLABORADOR}", file_get_contents("views/cursos/objetos/desafio/boton_modifica_desafio.html"), $PRINCIPAL);
        }
        //Bloque para Pregunta 2
        $PRINCIPAL = str_replace("{ENTORNO_PREGUNTA_2}", ColocaBloquePreguntaPorObjeto($datos_objeto[0]->id, $rut, 2), $PRINCIPAL);
        //Coloca datos de la linea de tiempo del Desafio
        $PRINCIPAL = str_replace("{FECHA_CREACION_DESAFIO}", ColocaFechaCreacionDesafio($datos_objeto[0]->id, $rut, $rut_colaborador_desde_vista_jefe), $PRINCIPAL);
        $PRINCIPAL = str_replace("{GALERIA_FOTOS_USUARIOS_}", colocaImagenesPorObjeto($datos_objeto[0]->id, $rut, $_SESSION["id_empresa"], $pagina, $datos_usuario_malla[0]->id_malla, $cantidad_imagenes_galeria), $PRINCIPAL);
        $PRINCIPAL = str_replace("{PAGINACION_GALERIA_IMAGENES}", ColocaPaginacionDeImagenes($pagina, $datos_objeto[0]->id, $rut, $datos_malla[0]->id_malla, $cantidad_imagenes_galeria), $PRINCIPAL);
        //Bloque para Listado de preguntas creadas por el relator. CHECKIN
        $PRINCIPAL = str_replace("{LISTADO_PREGUNTAS_POR_EVAL}", ColocaPReguntasPorEval($datos_objeto[0]->id), $PRINCIPAL);
        //Bloque para olocar datos de las Acciones Pendientes
        if ($rut_colaborador_desde_vista_jefe) {
            $PRINCIPAL = ColocaDatosAccionesClaves($datos_objeto[0]->id, $datos_objeto[0]->id_curso, $_SESSION["id_empresa"], $rut_colaborador_desde_vista_jefe, $PRINCIPAL);
        } else {
            $PRINCIPAL = ColocaDatosAccionesClaves($datos_objeto[0]->id, $datos_objeto[0]->id_curso, $_SESSION["id_empresa"], $rut, $PRINCIPAL);
        }
        //Arma paginacion para GALERIA DE IMAGENES
    } else if ($datos_objeto[0]->id_encuesta) {
        echo "encuesta";
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_OBJETO}", file_get_contents("views/cursos/contenidos/bloque_iframe.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{URL_OBJETO}", $datos_objeto[0]->url, $PRINCIPAL);
        $PRINCIPAL = str_replace("{EXTENSION_OBJETO}", $datos_objeto[0]->duracion_video, $PRINCIPAL);
    }
    //Dado la extension del objeto, traigo el template a utilizar por el tipo de objeto.
    $PRINCIPAL = str_replace("{NOMBRE_OBJETO}", utf8_encode($datos_objeto[0]->titulo), $PRINCIPAL);
    $PRINCIPAL = str_replace("{NUMERO_OBJETO}", ($datos_objeto[0]->orden), $PRINCIPAL);
    //Seccion del Cronometro
    $PRINCIPAL = BarraNavegacion($PRINCIPAL, "contenido");
    $PRINCIPAL = str_replace("{CRONOMETRO_PARA_CONTENIDOS}", file_get_contents("views/cursos/contenidos/cronometro.html"), $PRINCIPAL);
    //Verifico si esta finalizado o no este objetos
    if ($objeto_tiene_puntos) {
        $PRINCIPAL = str_replace("{BOTON_MATERIAL_OK}", "", $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BOTON_MATERIAL_OK}", file_get_contents("views/cursos/contenidos/" . $_SESSION["id_empresa"] . "_boton_ok_material.html"), $PRINCIPAL);
    }
    //if($objeto_finalizado && $datos_objeto[0]->opcional<>1){
    if ($datos_objeto[0]->opcional == 1) {
        $PRINCIPAL = str_replace("{BOTON_VOLVER}", file_get_contents("views/cursos/contenidos/boton_volver_curso.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_CURSO_ENCODEADO_VOLVER}", Encodear3($datos_objeto[0]->id_curso), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ENVBOTON}", "backcont", $PRINCIPAL);
        $PRINCIPAL = str_replace("{BOTON_FINALIZAR}", file_get_contents("views/cursos/contenidos/boton_siguiente_curso_v2.html"), $PRINCIPAL);
    } else {
        if ($_SESSION["id_empresa"] == 59) {
            $PRINCIPAL = str_replace("{BOTON_FINALIZAR}", file_get_contents("views/cursos/contenidos/59_boton_finaliza_curso.html"), $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{BOTON_FINALIZAR}", file_get_contents("views/cursos/contenidos/boton_finaliza_curso.html"), $PRINCIPAL);
        }
        $PRINCIPAL = str_replace("{ID_OBJETIVO_ENCODEADO}", Encodear3($id_objeto), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ENVBOTON}", "fincont", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_CURSO_ENCODEADO}", Encodear3($datos_objeto[0]->id_curso), $PRINCIPAL);
        $PRINCIPAL = str_replace("{BOTON_VOLVER}", file_get_contents("views/cursos/contenidos/CAP_boton_volver_curso.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_CURSO_ENCODEADO_VOLVER}", Encodear3($datos_objeto[0]->id_curso), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ENVBOTON}", "backcont", $PRINCIPAL);
    }
    $PRINCIPAL                        = str_replace("{RUT_ENCODEADO}", Encodear3($rut), $PRINCIPAL);
    $PRINCIPAL                        = str_replace("{ID_OBJETO}", ($id_objeto), $PRINCIPAL);
    $PRINCIPAL                        = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($id_objeto), $PRINCIPAL);
    //ACA OBTENGO EL SIGUIENTE OBJETO
    $datos_siguiente_objeto           = DatosObjetoDadoRutCursoyOrden($datos_objeto[0]->id_curso, $datos_objeto[0]->orden + 1);
    $PRINCIPAL                        = str_replace("{ID_SIGUIENTE_OBJETO_ENCODEADO}", Encodear3($datos_siguiente_objeto[0]->id), $PRINCIPAL);
    //total de navegacion para esteobjeto, rut y curso
    $suma_navegacion_por_curso_objeto = SumaNavegacionesDadoRutYObjeto($rut, $id_objeto, $datos_objeto[0]->id_curso);
    if ($suma_navegacion_por_curso_objeto[0]->total_tiempo) {
        $PRINCIPAL = str_replace("{SUMA_NAVEGACION}", ($suma_navegacion_por_curso_objeto[0]->total_tiempo), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{SUMA_NAVEGACION}", "00:00:00", $PRINCIPAL);
    }
    //echo $datos_objeto[0]->id_curso;
    $PRINCIPAL = str_replace("{CODIGO_CURSO_ENCODEADO}", Encodear3($datos_objeto[0]->id_curso), $PRINCIPAL);
    $PRINCIPAL = str_replace("{RUT_JEFATURA}", Encodear3($datos_usuario[0]->jefe), $PRINCIPAL);
    $PRINCIPAL = str_replace("{RUT_JEFATURA_DESDE_VISTA_JEFE}", Encodear3($rut), $PRINCIPAL);
    $PRINCIPAL = str_replace("{RUT_ENCODEADO_DESDE_VISTA_JEFE}", Encodear3($rut_colaborador_desde_vista_jefe), $PRINCIPAL);
    $PRINCIPAL = str_replace("{BLOQUE_OBJETO-PDF}", file_get_contents("dflip/examples/entorno_objeto.html"), $PRINCIPAL);
    $PRINCIPAL = str_replace("{BLOQUE_OBJETO-PDF-URL}", "dflip/examples/entorno_objeto.html", $PRINCIPAL);
    $PRINCIPAL = str_replace("{PDF}", $datos_objeto[0]->url, $PRINCIPAL);
    return ($PRINCIPAL);
}
function CAPACITACION_ObtenerEstadoAvanceCurso($rut, $id_curso, $id_inscripcion, $id_empresa)
{

//echo "<br>CAPACITACION_ObtenerEstadoAvanceCurso($rut, $id_curso, $id_inscripcion, $id_empresa";

    if ($id_inscripcion) {

    //echo "id inscripcion";
    //TIENE INSCRIPCION EN ELEARNING

     $datos_inscripcion_cierre = TieneInscripcionCierreDadoRutYCursoEmpresaInscripcion($rut, $id_curso, $id_inscripcion, $id_empresa);

        if ($datos_inscripcion_cierre[0]->estado == 1 and $datos_inscripcion_cierre[0]->estado_descripcion == "") {
            //echo "___1.1";exit();
            $arreglo[0]  = '<span class="etiquetaPrograma etiquetaPrograma-aprobado pull-left"><i class="fas fa-check-square"></i>&nbsp;&nbsp;Aprobado</span>';
            $arreglo[1]  = 'success';
            $arreglo[2]  = '<i class="fas fa-check-square"></i>';
            $arreglo[3]  = 100;
            //avance de tabla cierre
            $arreglo[4]  = $datos_inscripcion_cierre[0]->avance;
            $arreglo[5]  = $datos_inscripcion_cierre[0]->navegacionminutos;
            $arreglo[6]  = $datos_inscripcion_cierre[0]->estado;
            $arreglo[7]  = $datos_inscripcion_cierre[0]->nota;
            $arreglo[8]  = $datos_inscripcion_cierre[0]->fecha_termino;
            $arreglo[9]  = '<span class="etiquetaPrograma etiquetaPrograma-aprobado pull-left"><i class="fas fa-check-square"></i>&nbsp;&nbsp;Aprobado&nbsp;' . $datos_inscripcion_cierre[0]->nota . '</span>';
            $arreglo[10] = $datos_inscripcion_cierre[0]->porcentaje_asistencia;
            $arreglo[11] = '<i class="fa fa-check" aria-hidden="true"></i>';
            $arreglo[12] = 'vr_color_verde';
            $arreglo[13] = $datos_inscripcion_cierre[0]->caso_especial;
        } else if ($datos_inscripcion_cierre[0]->estado === '0') {
            //echo "___2.1";exit();
            $arreglo[0]  = '<span class="etiquetaPrograma etiquetaPrograma-reprobado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;Reprobado</span>';
            $arreglo[1]  = 'danger';
            $arreglo[2]  = '<i class="far fa-times-circle"></i>';
            $arreglo[3]  = 100;
            $arreglo[4]  = $datos_inscripcion_cierre[0]->avance;
            $arreglo[5]  = $datos_inscripcion_cierre[0]->navegacionminutos;
            $arreglo[6]  = $datos_inscripcion_cierre[0]->estado;
            $arreglo[7]  = $datos_inscripcion_cierre[0]->nota;
            $arreglo[8]  = $datos_inscripcion_cierre[0]->fecha_termino;
            $arreglo[9]  = '<span class="etiquetaPrograma etiquetaPrograma-reprobado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;Reprobado&nbsp;' . $datos_inscripcion_cierre[0]->nota . '</span>';
            $arreglo[10] = $datos_inscripcion_cierre[0]->porcentaje_asistencia;
            $arreglo[11] = '<i class="fa fa-times" aria-hidden="true"></i>';
            $arreglo[12] = 'vr_color_rojo';
            $arreglo[13] = $datos_inscripcion_cierre[0]->caso_especial;
        } else if ($datos_inscripcion_cierre[0]->estado == 3) {
            //echo "___3.1";exit();
            $arreglo[0]  = '<span class="etiquetaPrograma etiquetaPrograma-proceso pull-left"><i class="fas fa-spinner"></i>&nbsp;En Proceso</span>';
            $arreglo[1]  = 'danger';
            $arreglo[2]  = '<i class="icon-hourglass icons"></i>';
            $arreglo[3]  = 100;
            $arreglo[4]  = $datos_inscripcion_cierre[0]->avance;
            $arreglo[5]  = $datos_inscripcion_cierre[0]->navegacionminutos;
            $arreglo[6]  = $datos_inscripcion_cierre[0]->estado;
            $arreglo[7]  = $datos_inscripcion_cierre[0]->nota;
            $arreglo[8]  = $datos_inscripcion_cierre[0]->fecha_termino;
            $arreglo[9]  = '<span class="etiquetaPrograma etiquetaPrograma-proceso pull-left"><i class="fas fa-spinner"></i>&nbsp;En Proceso&nbsp;' . $datos_inscripcion_cierre[0]->nota . '</span>';
            $arreglo[10] = $datos_inscripcion_cierre[0]->porcentaje_asistencia;
            $arreglo[11] = '<i class="fa fa-clock-o" aria-hidden="true"></i>';
            $arreglo[12] = 'vr_color_amarillo';
            $arreglo[13] = $datos_inscripcion_cierre[0]->caso_especial;
        } else if ($datos_inscripcion_cierre[0]->estado == 4) {
            //   echo "___4.1";exit();
            $arreglo[0]  = '<span class="etiquetaPrograma etiquetaPrograma-noiniciado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;No Iniciado </span>';
            $arreglo[1]  = 0;
            $arreglo[2]  = '<i class="icon-frame icons"></i>';
            $arreglo[3]  = 0;
            $arreglo[4]  = $datos_inscripcion_cierre[0]->avance;
            $arreglo[5]  = $datos_inscripcion_cierre[0]->navegacionminutos;
            $arreglo[6]  = $datos_inscripcion_cierre[0]->estado;
            $arreglo[7]  = $datos_inscripcion_cierre[0]->nota;
            $arreglo[8]  = $datos_inscripcion_cierre[0]->fecha_termino;
            $arreglo[9]  = '<span class="etiquetaPrograma etiquetaPrograma-noiniciado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;No Iniciado </span>';
            $arreglo[10] = $datos_inscripcion_cierre[0]->porcentaje_asistencia;
            $arreglo[11] = '<i class="fa fa-circle-thin" aria-hidden="true"></i>';
            $arreglo[12] = 'vr_color_gris';
            $arreglo[13] = $datos_inscripcion_cierre[0]->caso_especial;
        } else if (count($datos_inscripcion_cierre) == 0) {
            //echo "___5.1";exit();
            $arreglo[0]  = '<span class="etiquetaPrograma etiquetaPrograma-noiniciado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;No Iniciado </span>';
            $arreglo[1]  = 0;
            $arreglo[2]  = '<i class="icon-frame icons"></i>';
            $arreglo[3]  = 0;
            $arreglo[4]  = 0;
            $arreglo[5]  = 0;
            $arreglo[6]  = $datos_inscripcion_cierre[0]->estado;
            $arreglo[7]  = $datos_inscripcion_cierre[0]->nota;
            $arreglo[8]  = $datos_inscripcion_cierre[0]->fecha_termino;
            $arreglo[9]  = '<span class="etiquetaPrograma etiquetaPrograma-noiniciado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;No Iniciado </span>';
            $arreglo[10] = $datos_inscripcion_cierre[0]->porcentaje_asistencia;
            $arreglo[11] = '<i class="fa fa-circle-thin" aria-hidden="true"></i>';
            $arreglo[12] = 'vr_color_gris';
            $arreglo[13] = $datos_inscripcion_cierre[0]->caso_especial;
        } else if ($datos_inscripcion_cierre[0]->estado == 1 and $datos_inscripcion_cierre[0]->estado_descripcion == "Aprueba") {
            //echo "___6.1";exit();
            $arreglo[0]  = '<span class="etiquetaPrograma etiquetaPrograma-aprobado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;Aprueba </span>';
            $arreglo[1]  = 0;
            $arreglo[2]  = '<i class="icon-frame icons"></i>';
            $arreglo[3]  = 100;
            $arreglo[4]  = $datos_inscripcion_cierre[0]->avance;
            $arreglo[5]  = $datos_inscripcion_cierre[0]->navegacionminutos;
            $arreglo[6]  = $datos_inscripcion_cierre[0]->estado;
            $arreglo[7]  = $datos_inscripcion_cierre[0]->nota;
            $arreglo[8]  = $datos_inscripcion_cierre[0]->fecha_termino;
            $arreglo[9]  = '<span class="etiquetaPrograma etiquetaPrograma-aprobado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;Aprueba </span>';
            $arreglo[10] = $datos_inscripcion_cierre[0]->porcentaje_asistencia;
            $arreglo[11] = '<i class="fa fa-check" aria-hidden="true"></i>';
            $arreglo[12] = 'vr_color_verde';
            $arreglo[13] = $datos_inscripcion_cierre[0]->caso_especial;
        } else if ($datos_inscripcion_cierre[0]->estado == 1 and $datos_inscripcion_cierre[0]->estado_descripcion == "APROBADO") {
            //   echo "___7.1";exit();
            $arreglo[0]  = '<span class="etiquetaPrograma etiquetaPrograma-aprobado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;APROBADO </span>';
            $arreglo[1]  = 0;
            $arreglo[2]  = '<i class="icon-frame icons"></i>';
            $arreglo[3]  = 100;
            $arreglo[4]  = $datos_inscripcion_cierre[0]->avance;
            $arreglo[5]  = $datos_inscripcion_cierre[0]->navegacionminutos;
            $arreglo[6]  = $datos_inscripcion_cierre[0]->estado;
            $arreglo[7]  = $datos_inscripcion_cierre[0]->nota;
            $arreglo[8]  = $datos_inscripcion_cierre[0]->fecha_termino;
            $arreglo[9]  = '<span class="etiquetaPrograma etiquetaPrograma-aprobado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;APROBADO </span>';
            $arreglo[10] = $datos_inscripcion_cierre[0]->porcentaje_asistencia;
            $arreglo[11] = '<i class="fa fa-check" aria-hidden="true"></i>';
            $arreglo[12] = 'vr_color_verde';
            $arreglo[13] = $datos_inscripcion_cierre[0]->caso_especial;
        } else if ($datos_inscripcion_cierre[0]->estado == 1 and $datos_inscripcion_cierre[0]->estado_descripcion == "Reprueba") {
            //echo "___8.1";exit();
            $arreglo[0]  = '<span class="etiquetaPrograma etiquetaPrograma-reprobado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;Reprueba </span>';
            $arreglo[1]  = 0;
            $arreglo[2]  = '<i class="icon-frame icons"></i>';
            $arreglo[3]  = 100;
            $arreglo[4]  = $datos_inscripcion_cierre[0]->avance;
            $arreglo[5]  = $datos_inscripcion_cierre[0]->navegacionminutos;
            $arreglo[6]  = $datos_inscripcion_cierre[0]->estado;
            $arreglo[7]  = $datos_inscripcion_cierre[0]->nota;
            $arreglo[8]  = $datos_inscripcion_cierre[0]->fecha_termino;
            $arreglo[9]  = '<span class="etiquetaPrograma etiquetaPrograma-reprobado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;Reprueba </span>';
            $arreglo[10] = $datos_inscripcion_cierre[0]->porcentaje_asistencia;
            $arreglo[11] = '<i class="fa fa-check" aria-hidden="true"></i>';
            $arreglo[12] = 'vr_color_rojo';
            $arreglo[13] = $datos_inscripcion_cierre[0]->caso_especial;
        } else if ($datos_inscripcion_cierre[0]->estado == 1 and $datos_inscripcion_cierre[0]->estado_descripcion == "REPROBADO") {
            //echo "___9.1";exit();
            $arreglo[0]  = '<span class="etiquetaPrograma etiquetaPrograma-reprobado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;REPROBADO </span>';
            $arreglo[1]  = 0;
            $arreglo[2]  = '<i class="icon-frame icons"></i>';
            $arreglo[3]  = 100;
            $arreglo[4]  = $datos_inscripcion_cierre[0]->avance;
            $arreglo[5]  = $datos_inscripcion_cierre[0]->navegacionminutos;
            $arreglo[6]  = $datos_inscripcion_cierre[0]->estado;
            $arreglo[7]  = $datos_inscripcion_cierre[0]->nota;
            $arreglo[8]  = $datos_inscripcion_cierre[0]->fecha_termino;
            $arreglo[9]  = '<span class="etiquetaPrograma etiquetaPrograma-reprobado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;REPROBADO </span>';
            $arreglo[10] = $datos_inscripcion_cierre[0]->porcentaje_asistencia;
            $arreglo[11] = '<i class="fa fa-check" aria-hidden="true"></i>';
            $arreglo[12] = 'vr_color_rojo';
            $arreglo[13] = $datos_inscripcion_cierre[0]->caso_especial;
        }



    } else {
        $datos_inscripcion_cierre = TieneInscripcionCierreDadoRutYCursoEmpresa($rut, $id_curso, $id_empresa);
//        print_r($datos_inscripcion_cierre);

        if ($datos_inscripcion_cierre[0]->estado == 1 and $datos_inscripcion_cierre[0]->estado_descripcion == "") {
            //echo "___1.1";exit();
            $arreglo[0]  = '<span class="etiquetaPrograma etiquetaPrograma-aprobado pull-left"><i class="fas fa-check-square"></i>&nbsp;&nbsp;Aprobado</span>';
            $arreglo[1]  = 'success';
            $arreglo[2]  = '<i class="fas fa-check-square"></i>';
            $arreglo[3]  = 100;
            //avance de tabla cierre
            $arreglo[4]  = $datos_inscripcion_cierre[0]->avance;
            $arreglo[5]  = $datos_inscripcion_cierre[0]->navegacionminutos;
            $arreglo[6]  = $datos_inscripcion_cierre[0]->estado;
            $arreglo[7]  = $datos_inscripcion_cierre[0]->nota;
            $arreglo[8]  = $datos_inscripcion_cierre[0]->fecha_termino;
            $arreglo[9]  = '<span class="etiquetaPrograma etiquetaPrograma-aprobado pull-left"><i class="fas fa-check-square"></i>&nbsp;&nbsp;Aprobado&nbsp;' . $datos_inscripcion_cierre[0]->nota . '</span>';
            $arreglo[10] = $datos_inscripcion_cierre[0]->porcentaje_asistencia;
            $arreglo[11] = '<i class="fa fa-check" aria-hidden="true"></i>';
            $arreglo[12] = 'vr_color_verde';
            $arreglo[13] = $datos_inscripcion_cierre[0]->caso_especial;
        } else if ($datos_inscripcion_cierre[0]->estado === '0') {
            //echo "___2.1";exit();
            $arreglo[0]  = '<span class="etiquetaPrograma etiquetaPrograma-reprobado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;Reprobado</span>';
            $arreglo[1]  = 'danger';
            $arreglo[2]  = '<i class="far fa-times-circle"></i>';
            $arreglo[3]  = 100;
            $arreglo[4]  = $datos_inscripcion_cierre[0]->avance;
            $arreglo[5]  = $datos_inscripcion_cierre[0]->navegacionminutos;
            $arreglo[6]  = $datos_inscripcion_cierre[0]->estado;
            $arreglo[7]  = $datos_inscripcion_cierre[0]->nota;
            $arreglo[8]  = $datos_inscripcion_cierre[0]->fecha_termino;
            $arreglo[9]  = '<span class="etiquetaPrograma etiquetaPrograma-reprobado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;Reprobado&nbsp;' . $datos_inscripcion_cierre[0]->nota . '</span>';
            $arreglo[10] = $datos_inscripcion_cierre[0]->porcentaje_asistencia;
            $arreglo[11] = '<i class="fa fa-times" aria-hidden="true"></i>';
            $arreglo[12] = 'vr_color_rojo';
            $arreglo[13] = $datos_inscripcion_cierre[0]->caso_especial;
        } else if ($datos_inscripcion_cierre[0]->estado == 3) {
            //echo "___3.1";exit();
            $arreglo[0]  = '<span class="etiquetaPrograma etiquetaPrograma-proceso pull-left"><i class="fas fa-spinner"></i>&nbsp;En Proceso</span>';
            $arreglo[1]  = 'danger';
            $arreglo[2]  = '<i class="icon-hourglass icons"></i>';
            $arreglo[3]  = 100;
            $arreglo[4]  = $datos_inscripcion_cierre[0]->avance;
            $arreglo[5]  = $datos_inscripcion_cierre[0]->navegacionminutos;
            $arreglo[6]  = $datos_inscripcion_cierre[0]->estado;
            $arreglo[7]  = $datos_inscripcion_cierre[0]->nota;
            $arreglo[8]  = $datos_inscripcion_cierre[0]->fecha_termino;
            $arreglo[9]  = '<span class="etiquetaPrograma etiquetaPrograma-proceso pull-left"><i class="fas fa-spinner"></i>&nbsp;En Proceso&nbsp;' . $datos_inscripcion_cierre[0]->nota . '</span>';
            $arreglo[10] = $datos_inscripcion_cierre[0]->porcentaje_asistencia;
            $arreglo[11] = '<i class="fa fa-clock-o" aria-hidden="true"></i>';
            $arreglo[12] = 'vr_color_amarillo';
            $arreglo[13] = $datos_inscripcion_cierre[0]->caso_especial;
        } else if ($datos_inscripcion_cierre[0]->estado == 4) {
            //   echo "___4.1";exit();
            $arreglo[0]  = '<span class="etiquetaPrograma etiquetaPrograma-noiniciado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;No Iniciado </span>';
            $arreglo[1]  = 0;
            $arreglo[2]  = '<i class="icon-frame icons"></i>';
            $arreglo[3]  = 0;
            $arreglo[4]  = $datos_inscripcion_cierre[0]->avance;
            $arreglo[5]  = $datos_inscripcion_cierre[0]->navegacionminutos;
            $arreglo[6]  = $datos_inscripcion_cierre[0]->estado;
            $arreglo[7]  = $datos_inscripcion_cierre[0]->nota;
            $arreglo[8]  = $datos_inscripcion_cierre[0]->fecha_termino;
            $arreglo[9]  = '<span class="etiquetaPrograma etiquetaPrograma-noiniciado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;No Iniciado </span>';
            $arreglo[10] = $datos_inscripcion_cierre[0]->porcentaje_asistencia;
            $arreglo[11] = '<i class="fa fa-circle-thin" aria-hidden="true"></i>';
            $arreglo[12] = 'vr_color_gris';
            $arreglo[13] = $datos_inscripcion_cierre[0]->caso_especial;
        } else if (count($datos_inscripcion_cierre) == 0) {
            //echo "___5.1";exit();
            $arreglo[0]  = '<span class="etiquetaPrograma etiquetaPrograma-noiniciado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;No Iniciado </span>';
            $arreglo[1]  = 0;
            $arreglo[2]  = '<i class="icon-frame icons"></i>';
            $arreglo[3]  = 0;
            $arreglo[4]  = 0;
            $arreglo[5]  = 0;
            $arreglo[6]  = $datos_inscripcion_cierre[0]->estado;
            $arreglo[7]  = $datos_inscripcion_cierre[0]->nota;
            $arreglo[8]  = $datos_inscripcion_cierre[0]->fecha_termino;
            $arreglo[9]  = '<span class="etiquetaPrograma etiquetaPrograma-noiniciado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;No Iniciado </span>';
            $arreglo[10] = $datos_inscripcion_cierre[0]->porcentaje_asistencia;
            $arreglo[11] = '<i class="fa fa-circle-thin" aria-hidden="true"></i>';
            $arreglo[12] = 'vr_color_gris';
            $arreglo[13] = $datos_inscripcion_cierre[0]->caso_especial;
        } else if ($datos_inscripcion_cierre[0]->estado == 1 and $datos_inscripcion_cierre[0]->estado_descripcion == "Aprueba") {
            //echo "___6.1";exit();
            $arreglo[0]  = '<span class="etiquetaPrograma etiquetaPrograma-aprobado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;Aprueba </span>';
            $arreglo[1]  = 0;
            $arreglo[2]  = '<i class="icon-frame icons"></i>';
            $arreglo[3]  = 100;
            $arreglo[4]  = $datos_inscripcion_cierre[0]->avance;
            $arreglo[5]  = $datos_inscripcion_cierre[0]->navegacionminutos;
            $arreglo[6]  = $datos_inscripcion_cierre[0]->estado;
            $arreglo[7]  = $datos_inscripcion_cierre[0]->nota;
            $arreglo[8]  = $datos_inscripcion_cierre[0]->fecha_termino;
            $arreglo[9]  = '<span class="etiquetaPrograma etiquetaPrograma-aprobado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;Aprueba </span>';
            $arreglo[10] = $datos_inscripcion_cierre[0]->porcentaje_asistencia;
            $arreglo[11] = '<i class="fa fa-check" aria-hidden="true"></i>';
            $arreglo[12] = 'vr_color_verde';
            $arreglo[13] = $datos_inscripcion_cierre[0]->caso_especial;
        } else if ($datos_inscripcion_cierre[0]->estado == 1 and $datos_inscripcion_cierre[0]->estado_descripcion == "APROBADO") {
            //   echo "___7.1";exit();
            $arreglo[0]  = '<span class="etiquetaPrograma etiquetaPrograma-aprobado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;APROBADO </span>';
            $arreglo[1]  = 0;
            $arreglo[2]  = '<i class="icon-frame icons"></i>';
            $arreglo[3]  = 100;
            $arreglo[4]  = $datos_inscripcion_cierre[0]->avance;
            $arreglo[5]  = $datos_inscripcion_cierre[0]->navegacionminutos;
            $arreglo[6]  = $datos_inscripcion_cierre[0]->estado;
            $arreglo[7]  = $datos_inscripcion_cierre[0]->nota;
            $arreglo[8]  = $datos_inscripcion_cierre[0]->fecha_termino;
            $arreglo[9]  = '<span class="etiquetaPrograma etiquetaPrograma-aprobado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;APROBADO </span>';
            $arreglo[10] = $datos_inscripcion_cierre[0]->porcentaje_asistencia;
            $arreglo[11] = '<i class="fa fa-check" aria-hidden="true"></i>';
            $arreglo[12] = 'vr_color_verde';
            $arreglo[13] = $datos_inscripcion_cierre[0]->caso_especial;
        } else if ($datos_inscripcion_cierre[0]->estado == 1 and $datos_inscripcion_cierre[0]->estado_descripcion == "Reprueba") {
            //echo "___8.1";exit();
            $arreglo[0]  = '<span class="etiquetaPrograma etiquetaPrograma-reprobado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;Reprueba </span>';
            $arreglo[1]  = 0;
            $arreglo[2]  = '<i class="icon-frame icons"></i>';
            $arreglo[3]  = 100;
            $arreglo[4]  = $datos_inscripcion_cierre[0]->avance;
            $arreglo[5]  = $datos_inscripcion_cierre[0]->navegacionminutos;
            $arreglo[6]  = $datos_inscripcion_cierre[0]->estado;
            $arreglo[7]  = $datos_inscripcion_cierre[0]->nota;
            $arreglo[8]  = $datos_inscripcion_cierre[0]->fecha_termino;
            $arreglo[9]  = '<span class="etiquetaPrograma etiquetaPrograma-reprobado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;Reprueba </span>';
            $arreglo[10] = $datos_inscripcion_cierre[0]->porcentaje_asistencia;
            $arreglo[11] = '<i class="fa fa-check" aria-hidden="true"></i>';
            $arreglo[12] = 'vr_color_rojo';
            $arreglo[13] = $datos_inscripcion_cierre[0]->caso_especial;
        } else if ($datos_inscripcion_cierre[0]->estado == 1 and $datos_inscripcion_cierre[0]->estado_descripcion == "REPROBADO") {
            //echo "___9.1";exit();
            $arreglo[0]  = '<span class="etiquetaPrograma etiquetaPrograma-reprobado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;REPROBADO </span>';
            $arreglo[1]  = 0;
            $arreglo[2]  = '<i class="icon-frame icons"></i>';
            $arreglo[3]  = 100;
            $arreglo[4]  = $datos_inscripcion_cierre[0]->avance;
            $arreglo[5]  = $datos_inscripcion_cierre[0]->navegacionminutos;
            $arreglo[6]  = $datos_inscripcion_cierre[0]->estado;
            $arreglo[7]  = $datos_inscripcion_cierre[0]->nota;
            $arreglo[8]  = $datos_inscripcion_cierre[0]->fecha_termino;
            $arreglo[9]  = '<span class="etiquetaPrograma etiquetaPrograma-reprobado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;REPROBADO </span>';
            $arreglo[10] = $datos_inscripcion_cierre[0]->porcentaje_asistencia;
            $arreglo[11] = '<i class="fa fa-check" aria-hidden="true"></i>';
            $arreglo[12] = 'vr_color_rojo';
            $arreglo[13] = $datos_inscripcion_cierre[0]->caso_especial;
        }
    }
    return ($arreglo);
}
function ColocaFiltros3Campos($PRINCIPAL, $id_empresa, $arreglo_post)
{
    $datos_empresa = DatosEmpresa($id_empresa);
    $PRINCIPAL     = str_replace("{CAMPO1}", $datos_empresa[0]->campo1, $PRINCIPAL);
    $campo1        = CriteriosParaTablaResumenReporteAvanceParaReportesSGD($id_empresa, $datos_empresa[0]->campo1);
    foreach ($campo1 as $val) {
        if ($arreglo_post[$datos_empresa[0]->campo1] == $val->campo) {
            $options_campo1 .= "<option selected value='" . $val->campo . "'>" . $val->campo . "</option>";
        } else {
            $options_campo1 .= "<option value='" . $val->campo . "'>" . $val->campo . "</option>";
        }
    }
    $PRINCIPAL = str_replace("{OPTIONS_CAMPO1}", utf8_encode($options_campo1), $PRINCIPAL);
    $PRINCIPAL = str_replace("{CAMPO2}", $datos_empresa[0]->campo2, $PRINCIPAL);
    $campo2    = CriteriosParaTablaResumenReporteAvanceParaReportesSGD($id_empresa, $datos_empresa[0]->campo2);
    foreach ($campo2 as $val) {
        if ($arreglo_post[$datos_empresa[0]->campo2] == $val->campo) {
            $options_campo2 .= "<option selected value='" . $val->campo . "'>" . $val->campo . "</option>";
        } else {
            $options_campo2 .= "<option value='" . $val->campo . "'>" . $val->campo . "</option>";
        }
    }
    $PRINCIPAL = str_replace("{OPTIONS_CAMPO2}", utf8_encode($options_campo2), $PRINCIPAL);
    $PRINCIPAL = str_replace("{CAMPO3}", $datos_empresa[0]->campo3, $PRINCIPAL);
    $campo3    = CriteriosParaTablaResumenReporteAvanceParaReportesSGD($id_empresa, $datos_empresa[0]->campo3);
    foreach ($campo3 as $val) {
        if ($arreglo_post[$datos_empresa[0]->campo3] == $val->campo) {
            $options_campo3 .= "<option selected value='" . $val->campo . "'>" . $val->campo . "</option>";
        } else {
            $options_campo3 .= "<option value='" . $val->campo . "'>" . $val->campo . "</option>";
        }
    }
    $PRINCIPAL = str_replace("{OPTIONS_CAMPO3}", utf8_encode($options_campo3), $PRINCIPAL);
    if ($arreglo_post["rutevaluador"] && $arreglo_post["evaluador"]) {
        $PRINCIPAL = str_replace("{FILTRO_RUTEVALUADOR}", $arreglo_post["rutevaluador"], $PRINCIPAL);
        $PRINCIPAL = str_replace("{FILTRO_NOMBREEVALUADOR}", $arreglo_post["evaluador"], $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{FILTRO_RUTEVALUADOR}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{FILTRO_NOMBREEVALUADOR}", "", $PRINCIPAL);
    }
    if ($arreglo_post["rutcalibrador"] && $arreglo_post["calibrador"]) {
        $PRINCIPAL = str_replace("{FILTRO_RUTCALIBRADOR}", $arreglo_post["rutcalibrador"], $PRINCIPAL);
        $PRINCIPAL = str_replace("{FILTRO_NOMBRECALIBRADOR}", $arreglo_post["calibrador"], $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{FILTRO_RUTCALIBRADOR}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{FILTRO_NOMBRECALIBRADOR}", "", $PRINCIPAL);
    }
    return ($PRINCIPAL);
}
function GraficoArana($matriz)
{
    for ($i = 1; $i <= count($matriz); $i++) {
        $nombres .= "'" . $matriz[$i - 1]["nombre"] . "' ";
        $notas_jefe .= $matriz[$i - 1]["nota"];
        if ($matriz[$i - 1]["nota_ae"]) {
            $notas_ae .= $matriz[$i - 1]["nota_ae"];
        } else {
            $notas_ae .= "0";
        }
        if ($i < count($matriz)) {
            $nombres .= ", ";
            $notas_jefe .= ", ";
            $notas_ae .= ", ";
        }
    }
    $grafico       = file_get_contents("views/sgd/graficos/graficoAranaAeJefe.html");
    $datos_empresa = DatosEmpresa($_SESSION["id_empresa"]);
    $grafico       = str_replace("{COLOR_GRAFICO}", $datos_empresa[0]->color_grafico1, $grafico);
    $grafico       = str_replace("{COMPETENCIAS}", utf8_encode($nombres), $grafico);
    $grafico       = str_replace("{NOTAS_DESCENDENTE}", ($notas_jefe), $grafico);
    //$grafico = str_replace("{NOTAS_AUTOEVALUACION}",utf8_encode($notas_ae),$grafico);
    $grafico       = str_replace("{NOTAS_AUTOEVALUACION}", ($notas_ae), $grafico);
    return ($grafico);
}
function ColocaDatosUsuarioSGD($html, $rut, $texto_mensaje, $rut_evaluador, $id_proceso)
{
    $html           = str_replace("{SECCION_DATOS_USUARIO}", file_get_contents("views/sgd/datos_superior_usuario.html"), $html);
    $datos          = DatosUsuarioConDatosEvaluadorPorProceso($rut, $rut_evaluador, $id_proceso);
    //exit;
    $datos_proceso_ = TraeDatosProcesoAnualDadoProcesoEval($id_proceso);
    if ($datos[0]->nombre_evaluador) {
        //$html = str_replace("{EVALUADOR}",utf8_encode($datos[0]->nombrecompletojefe),$html);
        $html = str_replace("{EVALUADOR}", utf8_encode($datos[0]->nombrecompletojefe), $html);
        $html = str_replace("{CARGO_EVALUADOR}", utf8_encode($datos[0]->cargo_evaluador), $html);
        $html = str_replace("{NOMBRE_CALIBRADOR}", utf8_encode($datos[0]->nombrecompletocalibrador), $html);
        $html = str_replace("{CARGO_CALIBRADOR}", utf8_encode($datos[0]->cargo_calibrador), $html);
        $html = str_replace("{NOMBRE_VALIDADOR}", utf8_encode($datos[0]->nombrecompletovalidador), $html);
        $html = str_replace("{CARGO_VALIDADOR}", utf8_encode($datos[0]->cargo_validador), $html);
        $html = str_replace("{AGNO_PROCESO}", utf8_encode($datos_proceso_[0]->agno_proceso), $html);
    } else {
        $html = str_replace("{EVALUADOR}", "Sin Evaluador", $html);
        $html = str_replace("{CARGO_EVALUADOR}", "Sin Evaluador", $html);
    }
    //SECCION NOMBRE EVALUADO
    if ($datos[0]->nombre && $datos[0]->apaterno && $datos[0]->amaterno) {
        $html = str_replace("{NOMBRE_EVALUADO}", utf8_encode($datos[0]->nombre . " " . $datos[0]->apaterno . " " . $datos[0]->amaterno), $html);
    } else if ($datos[0]->nombre_completo) {
        $html = str_replace("{NOMBRE_EVALUADO}", utf8_encode($datos[0]->nombre_completo), $html);
    } else if ($datos[0]->nombre) {
        $html = str_replace("{NOMBRE_EVALUADO}", utf8_encode($datos[0]->nombre), $html);
    } else {
        $html = str_replace("{NOMBRE_EVALUADO}", "Sin Nombre", $html);
    }
    if ($datos[0]->nombre && $datos[0]->apaterno && $datos[0]->amaterno) {
        $html = str_replace("{NOMBRE}", utf8_encode($datos[0]->nombre . " " . $datos[0]->apaterno . " " . $datos[0]->amaterno), $html);
    } else {
        $html = str_replace("{NOMBRE}", utf8_encode($datos[0]->nombre_completo), $html);
    }
    //SECCION NOMBRE JEFATURA - ESTE SE LEE DESDE LA TABLA TBL_USUARIO, CAMPO JEFE DEL USUARIO
    if ($datos[0]->nombre && $datos[0]->apaterno && $datos[0]->amaterno) {
        $html = str_replace("{NOMBRE_EVALUADO}", utf8_encode($datos[0]->nombre . " " . $datos[0]->apaterno . " " . $datos[0]->amaterno), $html);
    } else {
        $html = str_replace("{NOMBRE_EVALUADO}", utf8_encode($datos[0]->nombre_completo), $html);
    }
    if ($datos[0]->nombre_jefatura_tabla_usuario && $datos[0]->apaterno_jefatura_tabla_usuario && $datos[0]->amaterno_jefatura_tabla_usuario) {
        $html = str_replace("{NOMBRE_JEFATURA_TBL_USUARIO}", utf8_encode($datos[0]->nombre_jefatura_tabla_usuario . " " . $datos[0]->apaterno_jefatura_tabla_usuario . " " . $datos[0]->amaterno_jefatura_tabla_usuario), $html);
    } else {
        $html = str_replace("{NOMBRE_JEFATURA_TBL_USUARIO}", utf8_encode($datos[0]->nombre_completo_jefatura_tabla_usuario), $html);
    }
    //$html = str_replace("{NOMBRE}",utf8_encode($datos[0]->nombre_completo),$html);
    $html = str_replace("{CARGO_EVALUADO}", utf8_encode($datos[0]->cargo), $html);
    $html = str_replace("{CARGO}", utf8_encode($datos[0]->cargo), $html);
    $html = str_replace("{PERFIL_EVALUACION}", utf8_encode($datos[0]->nombre_perfil), $html);
    $html = str_replace("{IMAGEN_EVALUADO}", VerificaFotoPersonal($datos[0]->rut), $html);
    $html = str_replace("{IMG_FOTO}", VerificaFotoPersonal($datos[0]->rut), $html);
    if ($texto_mensaje == 1) {
        $html = str_replace("{MENSAJE}", file_get_contents("views/sgd/validacion/texto_no_validacion.html"), $html);
    } elseif ($texto_mensaje == 2) {
        $html = str_replace("{MENSAJE}", file_get_contents("views/sgd/texto_no_objetivos_jefe.html"), $html);
    } elseif ($texto_mensaje == "bitacora") {
        $html = str_replace("{MENSAJE}", file_get_contents("views/sgd/bitacora/boton_ingreso_formulario.html"), $html);
    } elseif ($texto_mensaje == "planes") {
        $html = str_replace("{MENSAJE}", file_get_contents("views/sgd/planes/boton_ingreso_formulario.html"), $html);
    } elseif ($texto_mensaje == "graficoFrecuenciaCompetencia ") {
        $html = str_replace("{MENSAJE}", "", $html);
    } elseif ($texto_mensaje == "sinmensaje") {
        $html = str_replace("{MENSAJE}", "", $html);
    } else {
        $html = str_replace("{MENSAJE}", "", $html);
    }
    //Verifico si el usuario es JEfe, si es asi, coloca boton Mi Equipo
    $es_evaluador = VerSiEsEvaluador($rut);
    if ($es_evaluador) {
        $html = str_replace("{EQUIPO}", '<a href="?sw=sgd2_e&er=' . Encodear3($rut) . '"><button class="btnver btn-gray btn-sm"><i class="fa fa-users pad_r"></i>Ver Equipo</button></a>', $html);
    } else {
        $html = str_replace("{EQUIPO}", "", $html);
    }
    if (file_exists("docs/dc/" . $rut . ".pdf")) {
        $html = str_replace("{DESCRIPCIONCARGO}", file_get_contents("views/sgd/boton_descripcion_cargo.html"), $html);
        $html = str_replace("{RUT}", $rut, $html);
    } else {
        $html = str_replace("{DESCRIPCIONCARGO}", "", $html);
    }
    return ($html);
}
function BloqueCursosPendientes($bloque, $rut, $id_malla)
{
    $cursos_no_iniciados = CursosNoIniciados($rut, $id_malla);
    foreach ($cursos_no_iniciados as $otros) {
        $rows_cursos .= file_get_contents("views/cursos/capacitacion/row_cursos_pendientes_malla.html");
        ;
        $rows_cursos = str_replace("{NOMBRE_CURSO}", utf8_encode($otros->nombre_curso), $rows_cursos);
    }
    $bloque = str_replace("{ROW_CURSOS_PENDIENTES}", $rows_cursos, $bloque);
    return ($bloque);
}
function OtrosCursosRealizados($PRINCIPAL, $rut, $id_malla)
{
    //echo "<br>$rut, $id_malla";
    //Funcion que trae datos de lso cursos que estan en inscripcion cierre pero que no estan en rel malla
    $otros_cursos = OtrosCursosNoMalla($rut, $id_malla);
    foreach ($otros_cursos as $otros) {
        $rows_cursos .= file_get_contents("views/cursos/capacitacion/row_listado_otros_cursos.html");
        ;
        $rows_cursos = str_replace("{NOMBRE_CURSO}", utf8_encode($otros->nombre_curso), $rows_cursos);
        if ($otros->estado == 1) {
            $rows_cursos = str_replace("{ESTADO}", '<span class="etiquetaPrograma etiquetaPrograma-aprobado pull-left"><i class="fas fa-check-square"></i>&nbsp;&nbsp;Aprobado</span>', $rows_cursos);
            $rows_cursos = str_replace("{BARRA_ESTADO}", 'success', $rows_cursos);
            $rows_cursos = str_replace("{ICONO_ESTADO_CURSO}", '<i class="fas fa-check-square"></i>', $rows_cursos);
            $rows_cursos = str_replace("{AVANCE_CURSO}", 100, $rows_cursos);
            $cantidad_cursos_aprobados_por_clasificacion++;
        } else if ($otros->estado === '0') {
            $rows_cursos = str_replace("{ESTADO}", '<span class="etiquetaPrograma etiquetaPrograma-reprobado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;Reprobado</span>', $rows_cursos);
            $rows_cursos = str_replace("{BARRA_ESTADO}", 'danger', $rows_cursos);
            $rows_cursos = str_replace("{ICONO_ESTADO_CURSO}", '<i class="far fa-times-circle"></i>', $rows_cursos);
            $rows_cursos = str_replace("{AVANCE_CURSO}", 100, $rows_cursos);
        } else if ($otros->estado == 3) {
            $rows_cursos = str_replace("{ESTADO}", '<span class="etiquetaPrograma etiquetaPrograma-proceso pull-left"><i class="fas fa-spinner"></i>&nbsp;En Proceso</span>', $rows_cursos);
            $rows_cursos = str_replace("{BARRA_ESTADO}", 'danger', $rows_cursos);
            $rows_cursos = str_replace("{ICONO_ESTADO_CURSO}", '<i class="icon-hourglass icons"></i>', $rows_cursos);
            $rows_cursos = str_replace("{AVANCE_CURSO}", 100, $rows_cursos);
        } else {
            $rows_cursos = str_replace("{ESTADO}", '<span class="etiquetaPrograma etiquetaPrograma-noiniciado pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;No Iniciado</span>', $rows_cursos);
            $rows_cursos = str_replace("{AVANCE_CURSO}", 0, $rows_cursos);
            $rows_cursos = str_replace("{ICONO_ESTADO_CURSO}", '<i class="icon-frame icons"></i>', $rows_cursos);
        }
    }
    if ($otros_cursos) {
        $PRINCIPAL = str_replace("{BLOQUE_OTROS_CURSOS_REALIZADOS}", file_get_contents("views/cursos/capacitacion/titulo_otros_cursos_realizados_malla.html"), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_OTROS_CURSOS_REALIZADOS}", "", $PRINCIPAL);
    }
    $PRINCIPAL = str_replace("{ROW_LISTADO_OTROS_CURSOS}", $rows_cursos, $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocarAvanceValidacionDadoRutValidador($PRINCIPAL, $rut_validador, $id_empresa)
{
    $evaluadores                  = TraeEvaluadoresDadoValidadorFijObjetivos($rut_validador, $id_empresa);
    $dimensiones_por_empresa      = DimensionesObjetivosPorEmpresa($id_empresa);
    $total_dimensiones            = 0;
    $total_fijaciones_finalizadas = 0;
    $total_fijaciones_proceso     = 0;
    $total_fijaciones_pendientes  = 0;
    $total_validadas              = 0;
    foreach ($evaluadores as $eva) {
        $total_dimensiones_evaluador            = 0;
        $total_fijaciones_finalizadas_evaluador = 0;
        $total_fijaciones_proceso_evaluador     = 0;
        $total_fijaciones_pendientes_evaluador  = 0;
        //$total_validadas_evaluador=0;
        unset($matriz_estados_generales_validador);
        $row .= file_get_contents("views/sgd/objetivos/row_evaluadores_lista_resumen.html");
        $row       = str_replace("{NOMBRE}", $eva->nombre_completo, $row);
        $row       = str_replace("{CARGO}", $eva->cargo, $row);
        $row       = str_replace("{RUT_EVALUADOR_ENCODEADO}", Encodear3($eva->evaluador), $row);
        $row       = str_replace("{URL_PERSONA}", VerificaFotoPersonal($eva->evaluador), $row);
        //Por cada colaborador, armo el menu de resumen
        $evaluados = TraeRelacionesSinAeSinProceso($eva->evaluador);
        foreach ($evaluados as $rut_eva) {
            //Por cada Evaluado, hago un foreach de dimensiones, y por cada dimension, veo si est? finalizada o no
            foreach ($dimensiones_por_empresa as $dimen) {
                $total_dimensiones++;
                $total_dimensiones_evaluador++;
                //Aca verifico si este evaluado para esta dimension est? finalizada o no.
                $estado_evaluado = VerificaEstadoDimensionesObjetivos($rut_eva->evaluado, $dimen->id, $id_empresa);
                $estado_validado = VerificaEstadoDimensionesObjetivosParaValidacion($rut_eva->evaluado, $dimen->id, $id_empresa);
                $matriz_estados_generales_validador[0]["total_total"]++;
                $matriz_validados_evaluador[0][total_total]++;
                if ($estado_validado[1] == 3) {
                    $total_validadas_evaluador[$dimen->id]["validadas"]++;
                    $total_fijaciones_validadas++;
                }
                if ($estado_evaluado[1] == 1) {
                    $total_fijaciones_finalizadas++;
                    $total_fijaciones_finalizadas_evaluador++;
                    $matriz_estados_generales_validador[$dimen->id]["estado_ingreso_finalizado"]++;
                }
                if ($estado_evaluado[1] == 2) {
                    $total_fijaciones_proceso++;
                    $total_fijaciones_proceso_evaluador++;
                    $matriz_estados_generales_validador[$dimen->id]["estado_enproceso_fijacion"]++;
                }
                if ($estado_evaluado[1] == 0) {
                    $total_fijaciones_pendientes++;
                    $total_fijaciones_pendientes_evaluador++;
                    $matriz_estados_generales_validador[$dimen->id]["estado_pendiente_fijacion"]++;
                }
            }
        }
        $row_dimensiones = "";
        //echo "echo $total_dimensiones_evaluador
        //<pre>";
        // print_r($matriz_estados_generales_validador);
        foreach ($dimensiones_por_empresa as $dimen) {
            $row_dimensiones .= file_get_contents("views/sgd/objetivos/row_resumen_por_dimension_evaluado.html");
            $row_dimensiones = str_replace("{NOMBRE_DIMENSION}", $dimen->nombre, $row_dimensiones);
            if ($matriz_estados_generales_validador[$dimen->id]["estado_ingreso_finalizado"] == $total_dimensiones_evaluador / 3) {
                $row_dimensiones = str_replace("{ESTADO}", '<span class="etiquetaPrograma etiquetaPrograma-aprobado pull-left"><i class="fas fa-check-square"></i>&nbsp;&nbsp;Ingresado</span>', $row_dimensiones);
            } else if ($matriz_estados_generales_validador[$dimen->id]["estado_enproceso_fijacion"] > 0 or $matriz_estados_generales_validador[$dimen->id]["estado_ingreso_finalizado"] < $total_dimensiones_evaluador) {
                $row_dimensiones = str_replace("{ESTADO}", '<span class="etiquetaPrograma etiquetaPrograma-proceso pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;Pendiente</span>', $row_dimensiones);
            } else {
                $row_dimensiones = str_replace("{ESTADO}", '<span class="etiquetaPrograma etiquetaPrograma-pendiente pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;Pendiente</span>', $row_dimensiones);
            }
            if ($total_validadas_evaluador[$dimen->id]["validadas"] == $total_dimensiones_evaluador / 3) {
                $row_dimensiones = str_replace("{ESTADO_VALIDACION}", '<span class="etiquetaPrograma etiquetaPrograma-aprobado pull-left"><i class="fas fa-check-square"></i>&nbsp;&nbsp;Validado</span>', $row_dimensiones);
            } else {
                $row_dimensiones = str_replace("{ESTADO_VALIDACION}", '<span class="etiquetaPrograma etiquetaPrograma-pendiente pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;Pendiente</span>', $row_dimensiones);
            }
        }
        $row = str_replace("{ROW_RESUMEN_POR_EVALUADO}", $row_dimensiones, $row);
    }
    $PRINCIPAL  = str_replace("{LISTADO_COLABORADORES}", utf8_encode($row), $PRINCIPAL);
    //Avance Validador
    $arreglo[0] = EntregaPorcentaje($total_dimensiones, $total_fijaciones_validadas);
    $PRINCIPAL  = str_replace("{AVANCE_VALIDADOR_ETAPA}", $arreglo[0] . "%", $PRINCIPAL);
    return ($PRINCIPAL);
}
function EnviaCorreoAJefeDesdeValidador($rut_emisor, $rut_destinatario, $id_empresa)
{
    $datos_destinatario = UsuarioEnBasePersonas($destinatario);
    //print_r($datos_destinatario);exit;
    $datos_emisor       = UsuarioEnBasePersonas($rut_emisor);
    $datos_destinatario = UsuarioEnBasePersonas($rut_destinatario);
    $template_correo    = file_get_contents("views/sgd/objetivos/correos/email_a_jefe_de_validador.html");
    $template_correo    = str_replace("{NOMBRE_JEFE}", utf8_encode($datos_destinatario[0]->nombre_completo), $template_correo);
    $template_correo    = str_replace("{NOMBRE_DEL_JEFE_DE_JEFE}", utf8_encode($datos_emisor[0]->nombre_completo), $template_correo);
    $template_correo    = str_replace("{texto_mensaje}", utf8_encode($mensaje), $template_correo);
    $asunto_mensaje     = TraeAsuntoDeMensaje($tipo_mensaje);
    $datos_empresa      = DatosEmpresa($id_empresa);
    $mail               = new PHPMailer;
    //Tell PHPMailer to use SMTP
    $mail->isSMTP(); //Enable SMTP debugging
    // 0 = off (for production use)
    // 1 = client messages
    // 2 = client and server messages
    $mail->SMTPDebug   = 1;
    //Ask for HTML-friendly debug output
    $mail->Debugoutput = 'error_log';
    //Set the hostname of the mail server
    $mail->Host        = $datos_empresa[0]->server;
    //Set the SMTP port number - likely to be 25, 465 or 587
    $mail->Port        = 25;
    //Whether to use SMTP authentication
    $mail->SMTPAuth    = true;
    //Username to use for SMTP authentication
    $mail->Username    = $datos_empresa[0]->envio_correos;
    //Password to use for SMTP authentication
    $mail->Password    = $datos_empresa[0]->envio_correos_pass;
    //Set who the message is to be sent from
    $mail->setFrom($datos_empresa[0]->envio_correos, $datos_empresa[0]->envio_correos);
    //Set an alternative reply-to address
    //$mail->addReplyTo('replyto@example.com', 'First Last');
    //Set who the message is to be sent to
    //$mail->addAddress($datos_destinatario[0]->email, $datos_destinatario[0]->nombre_completo);
    $mail->addAddress("daniel@gop.cl", $datos_destinatario[0]->nombre_completo);
    //$mail->addAddress("rod@gop.cl", $datos_destinatario[0]->nombre_completo);
    //$mail->addAddress("francisco.lopez@tnt.com", $datos_destinatario[0]->nombre_completo);
    //$mail->addAddress("rod@gop.cl", $datos_destinatario[0]->nombre_completo);
    $mail->AddBCC("backup@sgd.cl", "BCC: " . $datos_destinatario[0]->nombre_completo);
    //Set the subject line
    $mail->Subject = "" . $datos_emisor[0]->nombre_completo . " ha validado tu Fijacion de Objetivos";
    //Read an HTML message body from an external file, convert referenced images to embedded,
    //convert HTML into a basic plain-text alternative body
    $mail->msgHTML($template_correo, dirname(__FILE__));
    //Replace the plain text body with one created manually
    $mail->AltBody = 'Si no puedes visualizar este correo ....';
    //Attach an image file
    //$mail->addAttachment('images/phpmailer_mini.png');
    //send the message, check for errors
    if (!$mail->send()) {
        //echo "Mailer Error: " . $mail->ErrorInfo;
    } else {
        //echo "Message sent!";
    }
    //exit;
}
function EnviaCorreoAJefeDelJefeParaValidar($rut_emisor, $rut_destinatario, $id_empresa)
{
    $datos_destinatario = UsuarioEnBasePersonas($destinatario);
    //print_r($datos_destinatario);exit;
    $datos_emisor       = UsuarioEnBasePersonas($rut_emisor);
    $datos_destinatario = UsuarioEnBasePersonas($rut_destinatario);
    $template_correo    = file_get_contents("views/sgd/objetivos/correos/email_a_jefe_de_jefe.html");
    $template_correo    = str_replace("{NOMBRE_JEFE}", utf8_encode($datos_emisor[0]->nombre_completo), $template_correo);
    $template_correo    = str_replace("{NOMBRE_DEL_JEFE_DE_JEFE}", utf8_encode($datos_destinatario[0]->nombre_completo), $template_correo);
    $template_correo    = str_replace("{texto_mensaje}", utf8_encode($mensaje), $template_correo);
    $asunto_mensaje     = TraeAsuntoDeMensaje($tipo_mensaje);
    $datos_empresa      = DatosEmpresa($id_empresa);
    $mail               = new PHPMailer;
    //Tell PHPMailer to use SMTP
    $mail->isSMTP(); //Enable SMTP debugging
    // 0 = off (for production use)
    // 1 = client messages
    // 2 = client and server messages
    $mail->SMTPDebug   = 1;
    //Ask for HTML-friendly debug output
    $mail->Debugoutput = 'error_log';
    //Set the hostname of the mail server
    $mail->Host        = $datos_empresa[0]->server;
    //Set the SMTP port number - likely to be 25, 465 or 587
    $mail->Port        = 25;
    //Whether to use SMTP authentication
    $mail->SMTPAuth    = true;
    //Username to use for SMTP authentication
    $mail->Username    = $datos_empresa[0]->envio_correos;
    //Password to use for SMTP authentication
    $mail->Password    = $datos_empresa[0]->envio_correos_pass;
    //Set who the message is to be sent from
    $mail->setFrom($datos_empresa[0]->envio_correos, $datos_empresa[0]->envio_correos);
    //Set an alternative reply-to address
    //$mail->addReplyTo('replyto@example.com', 'First Last');
    //Set who the message is to be sent to
    //$mail->addAddress($datos_destinatario[0]->email, $datos_destinatario[0]->nombre_completo);
    $mail->addAddress("daniel@gop.cl", $datos_destinatario[0]->nombre_completo);
    //$mail->addAddress("rod@gop.cl", $datos_destinatario[0]->nombre_completo);
    //$mail->addAddress("francisco.lopez@tnt.com", $datos_destinatario[0]->nombre_completo);
    //$mail->addAddress("rod@gop.cl", $datos_destinatario[0]->nombre_completo);
    $mail->AddBCC("backup@sgd.cl", "BCC: " . $datos_destinatario[0]->nombre_completo);
    //Set the subject line
    $mail->Subject = "" . $datos_emisor[0]->nombre_completo . " solicita validar Fijacion de Objetivos";
    //Read an HTML message body from an external file, convert referenced images to embedded,
    //convert HTML into a basic plain-text alternative body
    $mail->msgHTML($template_correo, dirname(__FILE__));
    //Replace the plain text body with one created manually
    $mail->AltBody = 'Si no puedes visualizar este correo ....';
    //Attach an image file
    //$mail->addAttachment('images/phpmailer_mini.png');
    //send the message, check for errors
    if (!$mail->send()) {
        //echo "Mailer Error: " . $mail->ErrorInfo;
    } else {
        //echo "Message sent!";
    }
    //exit;
}
function ComboBoxConductasCriticasDadoPerfilYCompetencias($id_perfil, $competencia, $conducta_seleccionada)
{
    $conducta = TraeConductasDadaIdCompetencia($competencia, $id_perfil);
    foreach ($conducta as $con) {
        if ($conducta_seleccionada == $con->id_conducta) {
            $options .= "<option selected value='" . $con->id_conducta . "'>" . $con->conducta . "</option>";
        } else {
            $options .= "<option value='" . $con->id_conducta . "'>" . $con->conducta . "</option>";
        }
    }
    return ($options);
}
function ComboBoxCompetenciasPorPerfil($id_perfil, $seleccionado)
{
    $competencias = CompetenciasDadoPerfilParaObjetivos($id_perfil);
    foreach ($competencias as $comp) {
        if ($seleccionado == $comp->id_componente_reporte) {
            $options .= "<option selected value='" . $comp->id_componente_reporte . "'>" . $comp->nombre . "</option>";
        } else {
            $options .= "<option value='" . $comp->id_componente_reporte . "'>" . $comp->nombre . "</option>";
        }
    }
    return ($options);
}
function VerificaEstadoDimensionesObjetivosParaValidacion($evaluado, $id_dimension, $id_empresa)
{
    //Verifico si se encuentra validado
    $objetivos_por_dimension_validados = VerificaSiObjetivosEstanValidadosPorDimension($evaluado, $id_dimension, $id_empresa);
    if ($objetivos_por_dimension_validados) {
        $arreglo[0] = '<span class="etiquetaPrograma etiquetaPrograma-aprobado pull-left"><i class="fas fa-check-square"></i>&nbsp;&nbsp;Validado</span>';
        $arreglo[1] = 3;
    } else {
        $datos_finalizado = VerificaDimensionFinalizadaObjetivos($evaluado, $id_dimension, $id_empresa);
        $arreglo[0]       = '<span class="etiquetaPrograma etiquetaPrograma-pendiente pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;Pendiente</span>';
        $arreglo[1]       = 2;
    }
    return ($arreglo);
}
function FormularioValidacionObjetivosV2($PRINCIPAL, $rut_fijador, $rut_evaluado, $id_empresa, $id_proceso, $id_objetivo, $rut_validador)
{
    $muestra_boton_envia_a_jefe = 0;
    //$datos_evaluado=UsuarioEnBasePersonas($rut_evaluado);
    $datos_evaluado             = UsuarioEnBasePersonasConEvaluadorValidador($rut_evaluado);
    $dimensiones_por_empresa    = DimensionesObjetivosPorEmpresa($id_empresa);
    $PRINCIPAL                  = str_replace("{BLOQUE_RESUMEN_COLABORADOR}", file_get_contents("views/sgd/objetivos/row_colaboradores_lista_resumen_superior.html"), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{NOMBRE}", utf8_encode($datos_evaluado[0]->nombre_completo), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{PERFIL_COMPETENCIAS}", utf8_encode($datos_evaluado[0]->perfil_competencia), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{JEFE}", utf8_encode($datos_evaluado[0]->nombre_evaluador), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{JEFE_DEL_JEFE}", utf8_encode($datos_evaluado[0]->nombre_validador), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{CARGO}", utf8_encode($datos_evaluado[0]->cargo), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{FECHA_INGRESO}", utf8_encode($datos_evaluado[0]->fecha_ingreso), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{URL_PERSONA}", VerificaFotoPersonal($rut_evaluado), $PRINCIPAL);
    $row_dimensiones            = "";
    foreach ($dimensiones_por_empresa as $dimen) {
        $row_dimensiones .= file_get_contents("views/sgd/objetivos/row_resumen_por_dimension_evaluado.html");
        $row_dimensiones             = str_replace("{NOMBRE_DIMENSION}", $dimen->nombre, $row_dimensiones);
        $estado_dimension            = VerificaEstadoDimensionesObjetivos($rut_evaluado, $dimen->id, $id_empresa);
        $row_dimensiones             = str_replace("{ESTADO}", $estado_dimension[0], $row_dimensiones);
        $estado_dimension_validacion = VerificaEstadoDimensionesObjetivosParaValidacion($rut_evaluado, $dimen->id, $id_empresa);
        $row_dimensiones             = str_replace("{ESTADO_VALIDACION}", $estado_dimension_validacion[0], $row_dimensiones);
    }
    $PRINCIPAL = str_replace("{ROW_RESUMEN_POR_EVALUADO}", utf8_encode($row_dimensiones), $PRINCIPAL);
    //Por cada dimension, armo el formulario
    foreach ($dimensiones_por_empresa as $dimen) {
        //$estado_dimension=VerificaEstadoDimensionesObjetivos($rut_evaluado, $dimen->id, $id_empresa);
        $estado_dimension = VerificaEstadoDimensionesObjetivosParaValidacion($rut_evaluado, $dimen->id, $id_empresa);
        if ($estado_dimension[1] <> 3) {
            $formularios .= file_get_contents("views/sgd/objetivos/dimensiones/" . $dimen->template);
            $row_html = file_get_contents("views/sgd/objetivos/dimensiones/" . $dimen->row);
            $dimensiones_finalizadas++;
        } else {
            $formularios .= file_get_contents("views/sgd/objetivos/dimensiones/" . $dimen->template_lectura);
            $row_html = file_get_contents("views/sgd/objetivos/dimensiones/" . $dimen->row_lectura);
        }
        //$formularios.=file_get_contents("views/sgd/objetivos/dimensiones/".$dimen->template);
        //$row_html=file_get_contents("views/sgd/objetivos/dimensiones/".$dimen->row);
        //Aca veo si hay comentarios de esta dimension o no
        $tiene_comentarios = VerificaComentariosPorDimension($rut_fijador, $rut_evaluado, $dimen->id, $id_empresa);
        if ($tiene_comentarios) {
            $formularios = str_replace("{VALUE_ACCIONES_REALIZADAS}", utf8_encode($tiene_comentarios[0]->acciones_realizadas), $formularios);
            $formularios = str_replace("{VALUE_IMPACTO}", utf8_encode($tiene_comentarios[0]->impacto), $formularios);
            $formularios = str_replace("{CASE_FORM_COMEN_DIMENSION}", "updComDim", $formularios);
        } else {
            $formularios = str_replace("{VALUE_ACCIONES_REALIZADAS}", "", $formularios);
            $formularios = str_replace("{VALUE_IMPACTO}", "", $formularios);
            $formularios = str_replace("{CASE_FORM_COMEN_DIMENSION}", "saveComDim", $formularios);
        }
        $formularios               = str_replace("{NUMERO}", $dimen->orden, $formularios);
        $formularios               = str_replace("{NOMBRE_DIMENSION}", utf8_encode($dimen->nombre), $formularios);
        $formularios               = str_replace("{CASE_FORM}", $dimen->case . "&val=1", $formularios);
        //$formularios = str_replace("{BOTON1}",file_get_contents("views/sgd/objetivos/BotonJefeJefeValida.html"),$formularios);
        $formularios               = str_replace("{BOTON1}", "", $formularios);
        $formularios               = str_replace("{ID_DIMENSION_ENCODEADO}", $dimen->id, $formularios);
        $formularios               = str_replace("{OPTIONS_PONDERACIONES}", PondObjetivos2(""), $formularios);
        $formularios               = str_replace("{OPTIONS_COMPETENCIAS}", utf8_encode(ComboBoxCompetenciasPorPerfil($datos_evaluado[0]->id_perfil_competencia, "")), $formularios);
        //Por cada formulario, veo si existen objetivos ingresados en esta dimension
        //$objetivos_ingresados=ObjetivosPodDimensionEmpresaUsuario($rut_evaluado, $id_empresa, $dimen->id);
        //Por cada formulario, veo si existen objetivos ingresados en esta dimension
        $objetivos_ingresados      = ObjetivosPodDimensionEmpresaUsuario($rut_evaluado, $id_empresa, $dimen->id, $datos_evaluado[0]->id_perfil_competencia);
        $suma_objetivos_ingresados = ObjetivosPodDimensionEmpresaUsuarioSumaPonderacion($rut_evaluado, $id_empresa, $dimen->id);
        if ($dimen->tiene_ponderacion == 1) {
            if (count($objetivos_ingresados) >= $dimen->minimo && count($objetivos_ingresados) <= $dimen->maximo && $suma_objetivos_ingresados[0]->suma_ponderaciones == 100) {
                $muestra_boton_envia_a_jefe++;
            }
        } else {
            if (count($objetivos_ingresados) >= $dimen->minimo && count($objetivos_ingresados) <= $dimen->maximo) {
                $muestra_boton_envia_a_jefe++;
            }
        }
        if ($objetivos_ingresados) {
            $formularios                = str_replace("{BLOQUE_LISTADO_OBJETIVOS_INGRESADOS}", file_get_contents("views/sgd/objetivos/dimensiones/" . $dimen->entornoLecturaForm), $formularios);
            $total_objetivos_ingresados = "";
            $k                          = 0;
            $suma_ponderacion           = 0;
            foreach ($objetivos_ingresados as $obj_ing) {
                $k++;
                //$total_objetivos_ingresados.=file_get_contents("views/sgd/objetivos/dimensiones/".$dimen->row);
                if ($id_objetivo == $obj_ing->id) {
                    $total_objetivos_ingresados .= file_get_contents("views/sgd/objetivos/dimensiones/edita_" . $dimen->row);
                } else {
                    $total_objetivos_ingresados .= $row_html;
                }
                //$total_objetivos_ingresados.=$row_html;
                $total_objetivos_ingresados = str_replace("{NUMERO}", $k, $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{ID_DIMENSION}", $dimen->id, $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{ID_DIMENSION_ENCODEADA}", Encodear3($dimen->id), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{PARAMETROS_VAL}", "&rval=" . $rut_validador, $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{OBJETIVO}", utf8_encode($obj_ing->descripcion_objetivo), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{ID_OBJETIVO_ENCODEADO}", Encodear3($obj_ing->id), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{ID_OBJETIVO}", ($obj_ing->id), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{ACCION}", utf8_encode($obj_ing->accion_clave), $total_objetivos_ingresados);
                //$total_objetivos_ingresados = str_replace("{CONDUCTA_CRITICA}",utf8_encode($obj_ing->conducta_critica),$total_objetivos_ingresados);
                //$total_objetivos_ingresados = str_replace("{CONDUCTA_CRITICA}",utf8_encode($obj_ing->nombre_competencia),$total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{CONDUCTA_CRITICA}", utf8_encode($obj_ing->nombre_conducta), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{COMPETENCIA}", utf8_encode($obj_ing->nombre_competencia), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{COMENTARIO}", utf8_encode($obj_ing->comentarios), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{ACCION_DESARROLLO}", utf8_encode($obj_ing->acciones_desarrollo), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{RESPONSABLE}", utf8_encode($obj_ing->responsable), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{FECHA}", utf8_encode($obj_ing->fecha_limite), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{ENV_EDITAR}", "updobjetivoV2Val", $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{PONDERACION}", utf8_encode($obj_ing->ponderacion) . "%", $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{OPTIONS_PONDERACIONES_INGRESADO}", PondObjetivos2($obj_ing->ponderacion) . "%", $total_objetivos_ingresados);
                //$total_objetivos_ingresados  = str_replace("{OPTIONS_COMPETENCIAS_INGRESADO}",utf8_encode(ComboBoxCompetenciasPorPerfil($datos_evaluado[0]->id_perfil_competencia, $obj_ing->conducta_critica)),$total_objetivos_ingresados );
                $total_objetivos_ingresados = str_replace("{OPTIONS_COMPETENCIAS_INGRESADO}", utf8_encode(ComboBoxCompetenciasPorPerfil($datos_evaluado[0]->id_perfil_competencia, $obj_ing->competencia)), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{OPTIONS_CONDUCTAS_CRITICAS}", utf8_encode(ComboBoxConductasCriticasDadoPerfilYCompetencias($datos_evaluado[0]->id_perfil_competencia, $obj_ing->competencia, $obj_ing->conducta_critica)), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{ACCIONES_REALIZADAS}", utf8_encode($obj_ing->acciones_realizadas), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{IMPACTO}", utf8_encode($obj_ing->impacto), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{TIPO_ACCION}", utf8_encode($obj_ing->tipo_accion), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{SELECTED_" . utf8_encode($obj_ing->tipo_accion) . "}", "selected", $total_objetivos_ingresados);
                $suma_ponderacion           = $suma_ponderacion + $obj_ing->ponderacion;
            }
            $formularios = str_replace("{ROW_INGRESADOS}", $total_objetivos_ingresados, $formularios);
            $formularios = str_replace("{TOTAL_PONDERACION}", $suma_ponderacion . "%", $formularios);
            $formularios = str_replace("{ID_PERFIL_COMPETENCIAS}", $datos_evaluado[0]->id_perfil_competencia, $formularios);
            if ($suma_ponderacion == 100) {
                $formularios = str_replace("{CLASE_PONDERACION}", "pond_correcto", $formularios);
            } else {
                $formularios = str_replace("{CLASE_PONDERACION}", "pond_alerta", $formularios);
            }
        } else {
            $formularios = str_replace("{ROW_INGRESADOS}", "NO", $formularios);
        }
    }
    //$PRINCIPAL = str_replace("{BOTON_ENVIA_A_VALIDAR_OBJETIVOS}",file_get_contents("views/sgd/objetivos/BotonJefeJefeValida.html"),$PRINCIPAL);
    if ($muestra_boton_envia_a_jefe == count($dimensiones_por_empresa) && $estado_dimension[1] <> 3) {
        $PRINCIPAL = str_replace("{BOTON_ENVIA_A_VALIDAR_OBJETIVOS}", file_get_contents("views/sgd/objetivos/BotonJefeJefeValida.html"), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BOTON_ENVIA_A_VALIDAR_OBJETIVOS}", "", $PRINCIPAL);
    }
    $PRINCIPAL = str_replace("{NUMERO_PASO}", count($dimensiones_por_empresa) + 1, $PRINCIPAL);
    $PRINCIPAL = str_replace("{BLOQUE_FORMULARIOS_POR_DIMENSIONES}", $formularios, $PRINCIPAL);
    $PRINCIPAL = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($rut_evaluado), $PRINCIPAL);
    return ($PRINCIPAL);
}
function LimpiaRutFront($rut)
{
    $rut         = str_replace(".", "", $rut);
    $arreglo_rut = explode("-", $rut);
    $rut         = intval(preg_replace('/[^0-9]+/', '', $arreglo_rut[0]), 10);
    return ($rut);
}
function ColocaJefaturasDadoValidador($PRINCIPAL, $rut_validador, $id_empresa)
{
    //$evaluados=TraeRelacionesSinAeSinProceso($rut_fijador);
    $evaluadores                  = TraeEvaluadoresDadoValidadorFijObjetivos($rut_validador, $id_empresa);
    $dimensiones_por_empresa      = DimensionesObjetivosPorEmpresa($id_empresa);
    $total_dimensiones            = 0;
    $total_fijaciones_finalizadas = 0;
    $total_fijaciones_proceso     = 0;
    $total_fijaciones_pendientes  = 0;
    $total_validadas              = 0;
    foreach ($evaluadores as $eva) {
        $total_dimensiones_evaluador            = 0;
        $total_fijaciones_finalizadas_evaluador = 0;
        $total_fijaciones_proceso_evaluador     = 0;
        $total_fijaciones_pendientes_evaluador  = 0;
        //$total_validadas_evaluador=0;
        //Esta es para cada evaluador, por eso se limpia en cada vuelta
        unset($matriz_estados_generales_validador);
        $row .= file_get_contents("views/sgd/objetivos/row_evaluadores_lista_resumen.html");
        $row       = str_replace("{NOMBRE}", $eva->nombre_completo, $row);
        $row       = str_replace("{CARGO}", $eva->cargo, $row);
        $row       = str_replace("{RUT_EVALUADOR_ENCODEADO}", Encodear3($eva->evaluador), $row);
        $row       = str_replace("{URL_PERSONA}", VerificaFotoPersonal($eva->evaluador), $row);
        //Por cada colaborador, armo el menu de resumen
        $evaluados = TraeRelacionesSinAeSinProceso($eva->evaluador);
        foreach ($evaluados as $rut_eva) {
            //Por cada Evaluado, hago un foreach de dimensiones, y por cada dimension, veo si est? finalizada o no
            foreach ($dimensiones_por_empresa as $dimen) {
                $total_dimensiones++;
                $total_dimensiones_evaluador++;
                //Aca verifico si este evaluado para esta dimension est? finalizada o no.
                $estado_evaluado = VerificaEstadoDimensionesObjetivos($rut_eva->evaluado, $dimen->id, $id_empresa);
                $estado_validado = VerificaEstadoDimensionesObjetivosParaValidacion($rut_eva->evaluado, $dimen->id, $id_empresa);
                $matriz_estados_generales_validador[0]["total_total"]++;
                $matriz_validados_evaluador[0][total_total]++;
                $matriz_estados_generales_validador[$dimen->id]["total_por_dimension"]++;
                if ($estado_validado[1] == 3) {
                    $total_validadas_evaluador[$dimen->id]["validadas"]++;
                    $total_fijaciones_validadas++;
                }
                if ($estado_evaluado[1] == 1) {
                    $total_fijaciones_finalizadas++;
                    $total_fijaciones_finalizadas_evaluador++;
                    $matriz_estados_generales_validador[$dimen->id]["estado_ingreso_finalizado"]++;
                }
                if ($estado_evaluado[1] == 2) {
                    $total_fijaciones_proceso++;
                    $total_fijaciones_proceso_evaluador++;
                    $matriz_estados_generales_validador[$dimen->id]["estado_enproceso_fijacion"]++;
                }
                if ($estado_evaluado[1] == 0) {
                    $total_fijaciones_pendientes++;
                    $total_fijaciones_pendientes_evaluador++;
                    $matriz_estados_generales_validador[$dimen->id]["estado_pendiente_fijacion"]++;
                }
            }
        }
        $row_dimensiones = "";
        //echo "echo $total_dimensiones_evaluador
        //<pre>";
        // print_r($matriz_estados_generales_validador);
        foreach ($dimensiones_por_empresa as $dimen) {
            $row_dimensiones .= file_get_contents("views/sgd/objetivos/row_resumen_por_dimension_evaluado.html");
            $row_dimensiones = str_replace("{NOMBRE_DIMENSION}", $dimen->nombre, $row_dimensiones);
            if ($matriz_estados_generales_validador[$dimen->id]["estado_ingreso_finalizado"] == $total_dimensiones_evaluador / count($dimensiones_por_empresa)) {
                //if($matriz_estados_generales_validador[$dimen->id]["estado_ingreso_finalizado"]==$matriz_estados_generales_validador[$dimen->id]["total_por_dimension"]){
                $row_dimensiones = str_replace("{ESTADO}", '<span class="etiquetaPrograma etiquetaPrograma-aprobado pull-left"><i class="fas fa-check-square"></i>&nbsp;&nbsp;Ingresado</span>', $row_dimensiones);
            } else if ($matriz_estados_generales_validador[$dimen->id]["estado_enproceso_fijacion"] > 0 or $matriz_estados_generales_validador[$dimen->id]["estado_ingreso_finalizado"] < $total_dimensiones_evaluador) {
                $row_dimensiones = str_replace("{ESTADO}", '<span class="etiquetaPrograma etiquetaPrograma-proceso pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;Pendiente</span>', $row_dimensiones);
            } else {
                $row_dimensiones = str_replace("{ESTADO}", '<span class="etiquetaPrograma etiquetaPrograma-pendiente pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;Pendiente</span>', $row_dimensiones);
            }
            if ($total_validadas_evaluador[$dimen->id]["validadas"] == $total_dimensiones_evaluador / count($dimensiones_por_empresa)) {
                $row_dimensiones = str_replace("{ESTADO_VALIDACION}", '<span class="etiquetaPrograma etiquetaPrograma-aprobado pull-left"><i class="fas fa-check-square"></i>&nbsp;&nbsp;Validado</span>', $row_dimensiones);
            } else {
                $row_dimensiones = str_replace("{ESTADO_VALIDACION}", '<span class="etiquetaPrograma etiquetaPrograma-pendiente pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;Pendiente</span>', $row_dimensiones);
            }
        }
        //print_r($matriz_estados_generales_validador);echo "<br>";
        $row = str_replace("{ROW_RESUMEN_POR_EVALUADO}", $row_dimensiones, $row);
    }
    //echo "total dimensiones $total_dimensiones total dimensiones evaluador $total_dimensiones_evaluador";
    $PRINCIPAL = str_replace("{LISTADO_COLABORADORES}", utf8_encode($row), $PRINCIPAL);
    $PRINCIPAL = str_replace("{AVANCE_EVALUADOS}", EntregaPorcentaje($total_dimensiones, $total_fijaciones_validadas), $PRINCIPAL);
    $PRINCIPAL = str_replace("{AVANCE_VALIDADOR}", EntregaPorcentaje($total_dimensiones, $total_fijaciones_validadas) . "%", $PRINCIPAL);
    //print_r($total_validadas_evaluador);
    foreach ($dimensiones_por_empresa as $dimen) {
        $row_dimensiones_gen .= file_get_contents("views/sgd/objetivos/row_resumen_por_dimension.html");
        $row_dimensiones_gen = str_replace("{NOMBRE_DIMENSION}", $dimen->nombre, $row_dimensiones_gen);
        $row_dimensiones_gen = str_replace("{AVANCE_DIMENSION}", EntregaPorcentaje($total_dimensiones, $total_fijaciones_finalizadas), $row_dimensiones_gen);
        $row_dimensiones_gen = str_replace("{AVANCE_DIMENSION_VALIDACION}", EntregaPorcentaje($total_dimensiones, $total_fijaciones_validadas), $row_dimensiones_gen);
    }
    //echo "total $total_dimensiones, total finalizadas $total_fijaciones_finalizadas, total en proceso $total_fijaciones_proceso , total pendientes $total_fijaciones_pendientes";
    $PRINCIPAL = str_replace("{ROW_LISTADO_RESUMEN}", utf8_encode($row_dimensiones_gen), $PRINCIPAL);
    return ($PRINCIPAL);
}
function VerificaEstadoDimensionesObjetivos($evaluado, $id_dimension, $id_empresa)
{
    $datos_finalizado = VerificaDimensionFinalizadaObjetivos($evaluado, $id_dimension, $id_empresa);
    if ($datos_finalizado) {
        $arreglo[0] = '<span class="etiquetaPrograma etiquetaPrograma-aprobado pull-left"><i class="fas fa-check-square"></i>&nbsp;&nbsp;Ingresado</span>';
        $arreglo[1] = 1;
    } else {
        //Veo si tiene 1 objetivo ingresado
        $objetivo_por_dimension = ObjetivosPodDimensionEmpresaUsuario($evaluado, $id_empresa, $id_dimension);
        if (count($objetivo_por_dimension) > 0) {
            if ($id_empresa == 76 or $id_empresa == 61) {
                $arreglo[0] = '<span class="etiquetaPrograma etiquetaPrograma-proceso pull-left"><i class="fas fa-spinner"></i>&nbsp;En Proceso</span>';
                $arreglo[1] = 2;
            } else {
                $arreglo[0] = '<span class="etiquetaPrograma etiquetaPrograma-pendiente pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;Pendiente</span>';
                $arreglo[1] = 2;
            }
        } else {
            $arreglo[0] = '<span class="etiquetaPrograma etiquetaPrograma-pendiente pull-left"><i class="far fa-times-circle"></i>&nbsp;&nbsp;Pendiente</span>';
            $arreglo[1] = 0;
        }
    }
    return ($arreglo);
}
function FormularioIngresoObjetivosV2($PRINCIPAL, $rut_fijador, $rut_evaluado, $id_empresa, $id_proceso, $id_objetivo, $rut_validador, $tipo_reporte, $tipo_proceso_objetivos, $tipo_vista)
{
    $muestra_boton_envia_a_jefe = 0;
    //$datos_evaluado=UsuarioEnBasePersonas($rut_evaluado);
    $datos_evaluado             = UsuarioEnBasePersonasConEvaluadorValidador($rut_evaluado);
    $dimensiones_por_empresa    = DimensionesObjetivosPorEmpresa($id_empresa);
    if ($tipo_reporte == "pdf") {
        $PRINCIPAL = str_replace("{BLOQUE_RESUMEN_COLABORADOR}", file_get_contents("views/sgd/objetivos/row_colaboradores_lista_resumen_superior_pdf.html"), $PRINCIPAL);
        //$codigo_barra=new barCodeGenrator("201601".$datos_evaluado[0]->rut_completo,0,'hello.gif', 190, 130, true);
        //$PRINCIPAL = str_replace("{CODIGO_INFORME}",$codigo_barra,$PRINCIPAL);
        $PRINCIPAL = str_replace("{CODIGO_INFORME}", "201601" . $datos_evaluado[0]->rut_completo, $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_RESUMEN_COLABORADOR}", file_get_contents("views/sgd/objetivos/" . $id_empresa . "_row_colaboradores_lista_resumen_superior.html"), $PRINCIPAL);
    }
    $PRINCIPAL       = str_replace("{RUT_COMPLETO}", utf8_encode($datos_evaluado[0]->rut_completo), $PRINCIPAL);
    $PRINCIPAL       = str_replace("{NOMBRE}", utf8_encode($datos_evaluado[0]->nombre_completo), $PRINCIPAL);
    $PRINCIPAL       = str_replace("{PERFIL_COMPETENCIAS}", utf8_encode($datos_evaluado[0]->perfil_competencia), $PRINCIPAL);
    $PRINCIPAL       = str_replace("{FECHA_INGRESO}", formatearFechaCompleta($datos_evaluado[0]->fecha_ingreso), $PRINCIPAL);
    $PRINCIPAL       = str_replace("{JEFE}", utf8_encode($datos_evaluado[0]->nombre_evaluador), $PRINCIPAL);
    $PRINCIPAL       = str_replace("{JEFE_DEL_JEFE}", utf8_encode($datos_evaluado[0]->nombre_validador), $PRINCIPAL);
    $PRINCIPAL       = str_replace("{CARGO}", utf8_encode($datos_evaluado[0]->cargo), $PRINCIPAL);
    $PRINCIPAL       = str_replace("{GERENCIA}", utf8_encode($datos_evaluado[0]->gerencia), $PRINCIPAL);
    $PRINCIPAL       = str_replace("{DEPARTAMENTO}", utf8_encode($datos_evaluado[0]->departamento), $PRINCIPAL);
    $PRINCIPAL       = str_replace("{GRUPO_COMPETENCIAS}", utf8_encode($datos_evaluado[0]->perfil_competencia), $PRINCIPAL);
    $PRINCIPAL       = str_replace("{URL_PERSONA}", VerificaFotoPersonal($rut_evaluado), $PRINCIPAL);
    $row_dimensiones = "";
    foreach ($dimensiones_por_empresa as $dimen) {
        $row_dimensiones .= file_get_contents("views/sgd/objetivos/" . $id_empresa . "_row_resumen_por_dimension_evaluado.html");
        $row_dimensiones             = str_replace("{NOMBRE_DIMENSION}", $dimen->nombre, $row_dimensiones);
        $estado_dimension            = VerificaEstadoDimensionesObjetivos($rut_evaluado, $dimen->id, $id_empresa);
        $row_dimensiones             = str_replace("{ESTADO}", $estado_dimension[0], $row_dimensiones);
        $estado_dimension_validacion = VerificaEstadoDimensionesObjetivosParaValidacion($rut_evaluado, $dimen->id, $id_empresa);
        $row_dimensiones             = str_replace("{ESTADO_VALIDACION}", $estado_dimension_validacion[0], $row_dimensiones);
        $estado_ingresado            = VerificaEstadoDimensionesObjetivosIngresados($rut_evaluado, $dimen->id, $id_empresa);
        $row_dimensiones             = str_replace("{ESTADO_INGRESO}", $estado_ingresado[0], $row_dimensiones);
    }
    $PRINCIPAL = str_replace("{ROW_RESUMEN_POR_EVALUADO}", utf8_encode($row_dimensiones), $PRINCIPAL);
    //Por cada dimension, armo el formulario
    if ($id_empresa == 61) {
        if ($tipo_reporte == "pdf") {
            $formularios .= file_get_contents("views/sgd/objetivos/dimensiones/formulario_resultados_negocio_pdf.html");
            $formularios .= file_get_contents("views/sgd/objetivos/dimensiones/61_titulo_resultado_individuales_pdf.html");
        } else {
            $formularios .= file_get_contents("views/sgd/objetivos/dimensiones/formulario_resultados_negocio.html");
            $formularios .= file_get_contents("views/sgd/objetivos/dimensiones/61_titulo_resultado_individuales.html");
        }
    }
    foreach ($dimensiones_por_empresa as $dimen) {
        $estado_dimension                        = VerificaEstadoDimensionesObjetivos($rut_evaluado, $dimen->id, $id_empresa);
        $vista_lectura_para_colaborador_fijacion = "";
        if ($estado_dimension[1] == 1) {
            if ($tipo_reporte == "pdf") {
                $formularios .= file_get_contents("views/sgd/objetivos/dimensiones/pdf_" . $dimen->template_lectura);
                $row_html = file_get_contents("views/sgd/objetivos/dimensiones/pdf_" . $dimen->row_lectura);
                //echo "1.1";
            } else {
                if ($id_empresa == 76 && $rut_fijador <> $rut_evaluado) {
                    //aca ya esta finalizada, veo si est? validado o no
                    $objetivos_validados_por_dimension = VerificaSiObjetivosEstanValidadosPorDimension($rut_evaluado, $dimen->id, $id_empresa);
                    if ($objetivos_validados_por_dimension && $tipo_vista <> "prop") {
                        //$formularios.=file_get_contents("views/sgd/objetivos/dimensiones/".$dimen->template_lectura);
                        //$row_html=file_get_contents("views/sgd/objetivos/dimensiones/".$dimen->row_lectura);
                        $formularios .= file_get_contents("views/sgd/objetivos/dimensiones/" . $dimen->template);
                        $row_html = file_get_contents("views/sgd/objetivos/dimensiones/" . $dimen->row);
                        //echo "1.2";
                    } else if ($tipo_vista == "prop") {
                        $formularios .= file_get_contents("views/sgd/objetivos/dimensiones/" . $dimen->template_lectura);
                        $row_html = file_get_contents("views/sgd/objetivos/dimensiones/" . $dimen->row_lectura);
                        //echo "1.3";
                        if ($id_empresa == 76) {
                            $vista_lectura_para_colaborador_fijacion = "log";
                        } else {
                            $vista_lectura_para_colaborador_fijacion = "";
                        }
                    } else {
                        $formularios .= file_get_contents("views/sgd/objetivos/dimensiones/" . $dimen->template);
                        $row_html = file_get_contents("views/sgd/objetivos/dimensiones/" . $dimen->row);
                        //echo "1.4";
                    }
                } else {
                    $formularios .= file_get_contents("views/sgd/objetivos/dimensiones/" . $dimen->template_lectura);
                    $row_html = file_get_contents("views/sgd/objetivos/dimensiones/" . $dimen->row_lectura);
                    //echo "1.5";
                    if ($tipo_vista == "prop") {
                        $vista_lectura_para_colaborador_fijacion = "log";
                    } else {
                        $vista_lectura_para_colaborador_fijacion = "";
                    }
                }
            }
            $dimensiones_finalizadas++;
        } else if ($estado_dimension[1] == 0 or $estado_dimension[1] == 2) {
            if ($dimen->solo_lectura == 1) {
                exit;
                $formularios .= file_get_contents("views/sgd/objetivos/dimensiones/" . $dimen->template_lectura);
                $row_html = file_get_contents("views/sgd/objetivos/dimensiones/" . $dimen->row_lectura);
                //echo "1.6";
            } else {
                $formularios .= file_get_contents("views/sgd/objetivos/dimensiones/" . $dimen->template);
                $row_html = file_get_contents("views/sgd/objetivos/dimensiones/" . $dimen->row);
                //echo "1.7";
            }
        }
        $objetivos_ingresados = ObjetivosPodDimensionEmpresaUsuario($rut_evaluado, $id_empresa, $dimen->id, $datos_evaluado[0]->id_perfil_competencia, $vista_lectura_para_colaborador_fijacion);
        $formularios          = str_replace("{CASE_FORM}", $dimen->case, $formularios);
        $formularios          = str_replace("{NUMERO}", $dimen->orden, $formularios);
        $formularios          = str_replace("{NOMBRE_DIMENSION}", utf8_encode($dimen->nombre), $formularios);
        $formularios          = str_replace("{DESCRIPCION}", utf8_encode($dimen->descripcion), $formularios);
        $formularios          = str_replace("{BOTON1}", "", $formularios);
        $formularios          = str_replace("{ID_DIMENSION_ENCODEADO}", $dimen->id, $formularios);
        $formularios          = str_replace("{OPTIONS_PONDERACIONES}", PondObjetivos2(""), $formularios);
        $formularios          = str_replace("{OPTIONS_PONDERACIONES_1_A_99}", PondObjetivosa99(""), $formularios);
        $formularios          = str_replace("{OPTIONS_DIMENSION_" . $dimen->id . "}", ColocaOpcionesDeMetrica($id_empresa, $dimen->id), $formularios);
        //Traigo las metricas por empresa
        $metricas             = totalMetricasObjetivosPorEmpresa($id_empresa);
        foreach ($metricas as $metri) {
            $options_metricas .= "<option value='" . $metri->metrica . "'>" . $metri->metrica . "</option>";
        }
        $formularios           = str_replace("{OPTIONS_PONDERACIONES_A10}", PondObjetivosa100(""), $formularios);
        $formularios           = str_replace("{OPTIONS_METRICAS_OBJETIVOS}", utf8_encode($options_metricas), $formularios);
        //Verifico si este jefe, ya tiene algunos finalizados, si es asi, isto a los usuarios finalizados
        $evalaudos_finalizados = VerificoEvaluadosFinalizadosPorEvaluador($rut_fijador, $id_proceso, $id_empresa);
        if ($id_empresa == 76) {
            $evaluados_finalizados_2 = VerificoEvaluadosFinalizadosPorEvaluador2($rut_fijador, $id_proceso, $id_empresa);
            if ($evaluados_finalizados_2) {
                //Verifico si este evaluado ya esta finalizado con la fijaci?n
                $individual_finalizado = VerificoEvaluadoPRocesoEmpresaFinalizadoObjetivos($rut_evaluado, $id_empresa, $id_proceso);
                $PRINCIPAL             = str_replace("{BLOQUE_REPLICA}", file_get_contents("views/sgd/objetivos/" . $id_empresa . "_paso2_bloque_replica.html"), $PRINCIPAL);
                foreach ($evaluados_finalizados_2 as $eva) {
                    $options_usuarios .= "<option value='" . $eva->evaluado . "'>" . $eva->nombre_completo . "</option>";
                }
                $PRINCIPAL = str_replace("{OPTIONS_USUARIOS}", $options_usuarios, $PRINCIPAL);
                $PRINCIPAL = str_replace("{RUT_EVALUADO}", encodear3($rut_evaluado), $PRINCIPAL);
            } else {
                $PRINCIPAL = str_replace("{BLOQUE_REPLICA}", "???", $PRINCIPAL);
            }
        } else {
            if ($evalaudos_finalizados) {
                //Verifico si este evaluado ya esta finalizado con la fijaci?n
                $individual_finalizado = VerificoEvaluadoPRocesoEmpresaFinalizadoObjetivos($rut_evaluado, $id_empresa, $id_proceso);
                if ($individual_finalizado) {
                    $PRINCIPAL = str_replace("{BLOQUE_REPLICA}", "", $PRINCIPAL);
                } else {
                    $PRINCIPAL = str_replace("{BLOQUE_REPLICA}", file_get_contents("views/sgd/objetivos/" . $id_empresa . "_paso2_bloque_replica.html"), $PRINCIPAL);
                }
                foreach ($evalaudos_finalizados as $eva) {
                    $options_usuarios .= "<option value='" . $eva->evaluado . "'>" . $eva->nombre_completo . "</option>";
                }
                $PRINCIPAL = str_replace("{OPTIONS_USUARIOS}", $options_usuarios, $PRINCIPAL);
                $PRINCIPAL = str_replace("{RUT_EVALUADO}", encodear3($rut_evaluado), $PRINCIPAL);
            } else {
                $PRINCIPAL = str_replace("{BLOQUE_REPLICA}", "", $PRINCIPAL);
            }
        }
        $formularios                         = str_replace("{ID_PERFIL_COMPETENCIAS}", $datos_evaluado[0]->id_perfil_competencia, $formularios);
        $options_pond_dimensiones            = "";
        $tiene_ponderacion_dimension_usuario = TienePonderacionDimensionPorUsuarioDimension($rut_evaluado, $id_empresa, $dimen->id);
        $formularios                         = str_replace("{PONDERACION_DESDE_BASE}", $tiene_ponderacion_dimension_usuario[0]->ponderacion, $formularios);
        for ($j = 5; $j <= 50; $j++) {
            if ($tiene_ponderacion_dimension_usuario[0]->ponderacion == $j) {
                $options_pond_dimensiones .= "<option value='" . $j . "' selected='selected'>$j%</option>";
            } else {
                $options_pond_dimensiones .= "<option value='" . $j . "'>$j%</option>";
            }
            $j = $j + 4;
        }
        $formularios               = str_replace("{OPTIONS_PONDERACIONES_DIMENSIONES}", $options_pond_dimensiones, $formularios);
        //Options de Competencias
        $formularios               = str_replace("{OPTIONS_COMPETENCIAS}", utf8_encode(ComboBoxCompetenciasPorPerfil($datos_evaluado[0]->id_perfil_competencia, "")), $formularios);
        //Por cada formulario, veo si existen objetivos ingresados en esta dimension
        $suma_objetivos_ingresados = ObjetivosPodDimensionEmpresaUsuarioSumaPonderacion($rut_evaluado, $id_empresa, $dimen->id);
        if ($dimen->tiene_ponderacion == 1) {
            if (count($objetivos_ingresados) >= $dimen->minimo && count($objetivos_ingresados) <= $dimen->maximo && $suma_objetivos_ingresados[0]->suma_ponderaciones == 100) {
                $muestra_boton_envia_a_jefe++;
            }
        } else {
            if (count($objetivos_ingresados) >= $dimen->minimo && count($objetivos_ingresados) <= $dimen->maximo) {
                $muestra_boton_envia_a_jefe++;
            }
        }
        if ($objetivos_ingresados) {
            $formularios                = str_replace("{BLOQUE_LISTADO_OBJETIVOS_INGRESADOS}", file_get_contents("views/sgd/objetivos/dimensiones/" . $dimen->entornoLecturaForm), $formularios);
            $formularios                = str_replace("{TEXTO_MENSAJE_CUMPLE_OBJETIVOS}", file_get_contents("views/sgd/objetivos/dimensiones/texto_suma_objetivos.html"), $formularios);
            $total_objetivos_ingresados = "";
            $k                          = 0;
            $suma_ponderacion           = 0;
            foreach ($objetivos_ingresados as $obj_ing) {
                $k++;
                //$total_objetivos_ingresados.=file_get_contents("views/sgd/objetivos/dimensiones/".$dimen->row);
                if ($id_objetivo == $obj_ing->id) {
                    $total_objetivos_ingresados .= file_get_contents("views/sgd/objetivos/dimensiones/edita_" . $dimen->row);
                } else {
                    $total_objetivos_ingresados .= $row_html;
                }
                $total_objetivos_ingresados = str_replace("{NUMERO}", $k, $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{ID_DIMENSION}", $dimen->id, $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{ID_DIMENSION_ENCODEADA}", Encodear3($dimen->id), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{NOMBRE_DIMENSION_PDF}", utf8_encode($obj_ing->nombre_dimension_pdf), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{PONDERACION_PDF_POR_DIMENSION}", $tiene_ponderacion_dimension_usuario[0]->ponderacion, $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{PARAMETROS_VAL}", "", $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{OBJETIVO}", utf8_encode($obj_ing->descripcion_objetivo), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{OBJETIVO_METRICA}", utf8_encode($obj_ing->descripcion_metrica), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{ID_OBJETIVO_ENCODEADO}", Encodear3($obj_ing->id), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{ID_OBJETIVO}", ($obj_ing->id), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{ACCION}", utf8_encode($obj_ing->accion_clave), $total_objetivos_ingresados);
                //$total_objetivos_ingresados = str_replace("{CONDUCTA_CRITICA}",utf8_encode($obj_ing->conducta_critica),$total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{CONDUCTA_CRITICA}", utf8_encode($obj_ing->nombre_conducta), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{COMPETENCIA}", utf8_encode($obj_ing->nombre_competencia), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{COMENTARIO}", utf8_encode($obj_ing->comentarios), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{ACCION_DESARROLLO}", utf8_encode($obj_ing->acciones_desarrollo), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{RESPONSABLE}", utf8_encode($obj_ing->responsable), $total_objetivos_ingresados);
                foreach ($metricas as $metri) {
                    if (($obj_ing->metrica) == $metri->metrica) {
                        $options_metricas_por_objetivo .= "<option value='" . $metri->metrica . "' selected='selected'>" . $metri->metrica . "</option>";
                    } else {
                        $options_metricas_por_objetivo .= "<option value='" . $metri->metrica . "'>" . $metri->metrica . "</option>";
                    }
                }
                $total_objetivos_ingresados = str_replace("{OPTIONS_METRICAS_OBJETIVOS}", utf8_encode($options_metricas_por_objetivo), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{NOCUMPLE}", utf8_encode($obj_ing->nocumple), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{CUMPLE}", utf8_encode($obj_ing->cumple), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{SOBRESALE}", utf8_encode($obj_ing->sobresale), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{FECHA}", utf8_encode($obj_ing->fecha_limite), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{ENV_EDITAR}", "updobjetivoV2", $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{PONDERACION}", utf8_encode($obj_ing->ponderacion) . "%", $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{METRICA}", utf8_encode($obj_ing->metrica), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{META}", utf8_encode($obj_ing->meta), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{OPTIONS_PONDERACIONES_INGRESADO}", PondObjetivos2($obj_ing->ponderacion) . "%", $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{OPTIONS_PONDERACIONES_INGRESADO_1_A_99}", PondObjetivosa99($obj_ing->ponderacion) . "%", $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{OPTIONS_PONDERACIONES_A10}", PondObjetivosa100($obj_ing->ponderacion), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{OPTIONS_COMPETENCIAS_INGRESADO}", utf8_encode(ComboBoxCompetenciasPorPerfil($datos_evaluado[0]->id_perfil_competencia, $obj_ing->competencia)), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{OPTIONS_CONDUCTAS_CRITICAS}", utf8_encode(ComboBoxConductasCriticasDadoPerfilYCompetencias($datos_evaluado[0]->id_perfil_competencia, $obj_ing->competencia, $obj_ing->conducta_critica)), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{ACCIONES_REALIZADAS}", utf8_encode($obj_ing->acciones_realizadas), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{IMPACTO}", utf8_encode($obj_ing->impacto), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{TIPO_ACCION}", utf8_encode($obj_ing->tipo_accion), $total_objetivos_ingresados);
                $total_objetivos_ingresados = str_replace("{SELECTED_" . utf8_encode($obj_ing->tipo_accion) . "}", "selected", $total_objetivos_ingresados);
                $suma_ponderacion           = $suma_ponderacion + $obj_ing->ponderacion;
            }
            $formularios = str_replace("{ROW_INGRESADOS}", $total_objetivos_ingresados, $formularios);
            $formularios = str_replace("{TOTAL_PONDERACION}", $suma_ponderacion . "%", $formularios);
            if ($suma_ponderacion == 100) {
                $formularios = str_replace("{CLASE_PONDERACION}", "pond_correcto", $formularios);
            } else {
                $formularios = str_replace("{CLASE_PONDERACION}", "pond_alerta", $formularios);
            }
        } else {
            $formularios = str_replace("{BLOQUE_LISTADO_OBJETIVOS_INGRESADOS}", "", $formularios);
            $formularios = str_replace("{ROW_INGRESADOS}", "NO", $formularios);
        }
    }
    //if($dimensiones_finalizadas==count($dimensiones_por_empresa)){
    //echo $muestra_boton_envia_a_jefe;
    if ($muestra_boton_envia_a_jefe == count($dimensiones_por_empresa) && $estado_dimension[1] <> 1) {
        if ($tipo_proceso_objetivos == 1) {
            $PRINCIPAL = str_replace("{BOTON_ENVIA_A_VALIDAR_OBJETIVOS}", file_get_contents("views/sgd/objetivos/boton_envia_valida_a_evaluado.html"), $PRINCIPAL);
            $alerta    = "no";
        } else {
            $PRINCIPAL = str_replace("{BOTON_ENVIA_A_VALIDAR_OBJETIVOS}", file_get_contents("views/sgd/objetivos/boton_envia_a_jefatura.html"), $PRINCIPAL);
            $alerta    = "si";
        }
    } else {
        //Aca ademas debo validar si es que este evaluado ya esta finalizado, porque si ya esta finalizado
        //No se debe mostrar ningun boton
        $verifico_evaluado_finalizado = VerificoEvaluadoEvaluadorPRocesoEmpresaFinalizadoObjetivos($rut_evaluado, $rut_fijador, $id_empresa, $id_proceso);
        if ($verifico_evaluado_finalizado) {
            if ($id_empresa == 41) {
                $PRINCIPAL = str_replace("{BOTON_ENVIA_A_VALIDAR_OBJETIVOS}", file_get_contents("views/sgd/objetivos/bloque_competencias.html"), $PRINCIPAL);
            } else {
                $PRINCIPAL = str_replace("{BOTON_ENVIA_A_VALIDAR_OBJETIVOS}", "", $PRINCIPAL);
            }
        } else {
            if ($id_empresa == 41) {
                $PRINCIPAL = str_replace("{BOTON_ENVIA_A_VALIDAR_OBJETIVOS}", "", $PRINCIPAL);
            } else {
                if ($rut_fijador == $rut_evaluado) {
                    $PRINCIPAL = str_replace("{BOTON_ENVIA_A_VALIDAR_OBJETIVOS}", file_get_contents("views/sgd/objetivos/boton_envia_a_jefatura.html"), $PRINCIPAL);
                } else {
                    if ($id_empresa == 76) {
                        //si no est? validado, muestro el oton, si no no muestro el boton
                        $evaluado_esta_validado = VerificaSiObjetivosEstanValidadosDadoIdProcesoSoloEvaluado($id_proceso, $rut_evaluado);
                        if ($evaluado_esta_validado) {
                            $PRINCIPAL = str_replace("{BOTON_ENVIA_A_VALIDAR_OBJETIVOS}", "", $PRINCIPAL);
                        } else {
                            if ($tipo_vista == "prop") {
                                $PRINCIPAL = str_replace("{BOTON_ENVIA_A_VALIDAR_OBJETIVOS}", "", $PRINCIPAL);
                            } else {
                                $PRINCIPAL = str_replace("{BOTON_ENVIA_A_VALIDAR_OBJETIVOS}", file_get_contents("views/sgd/objetivos/" . $id_empresa . "_boton_jefe_valida_objetivos.html"), $PRINCIPAL);
                            }
                        }
                    } else {
                        $PRINCIPAL = str_replace("{BOTON_ENVIA_A_VALIDAR_OBJETIVOS}", file_get_contents("views/sgd/objetivos/boton_envia_a_jefatura.html"), $PRINCIPAL);
                    }
                }
                //$PRINCIPAL = str_replace("{BOTON_ENVIA_A_VALIDAR_OBJETIVOS}",file_get_contents("views/sgd/objetivos/boton_envia_a_jefatura_NO.html"),$PRINCIPAL);
            }
        }
        $alerta = "no";
    }
    $PRINCIPAL  = str_replace("{NUMERO_PASO}", count($dimensiones_por_empresa) + 1, $PRINCIPAL);
    $PRINCIPAL  = str_replace("{BLOQUE_FORMULARIOS_POR_DIMENSIONES}", $formularios, $PRINCIPAL);
    $PRINCIPAL  = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($rut_evaluado), $PRINCIPAL);
    $arreglo[0] = $alerta;
    $arreglo[1] = $PRINCIPAL;
    //return($PRINCIPAL);
    return ($arreglo);
}
function ColocaColaboradoresResumenObjetivos($PRINCIPAL, $rut_fijador, $id_empresa, $rut_validador, $id_proceso)
{
    if ($id_proceso) {
        //$evaluados=TraeRelacionesSinAe($rut_fijador, $id_proceso);
        if ($id_empresa == 766) {
            $evaluados = TraeRelacionesConDatosConAe($rut_fijador, $id_proceso);
        } else {
            $evaluados = TraeRelacionesSinAeConDatos($rut_fijador, $id_proceso);
        }
    } else {
        $evaluados = TraeRelacionesSinAeSinProceso($rut_fijador);
    }
    $datos_fijador = UsuarioEnBasePersonas($rut_fijador);
    if ($evaluados) {
        $PRINCIPAL = str_replace("{BLOQUE_MI_EQUIPO}", file_get_contents("views/sgd/objetivos/" . $id_empresa . "_paso1_bloque_equipo.html"), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_MI_EQUIPO}", "", $PRINCIPAL);
    }
    $PRINCIPAL                    = str_replace("{NOMBRE_FIJADOR}", utf8_encode($datos_fijador[0]->nombre_completo), $PRINCIPAL);
    $dimensiones_por_empresa      = DimensionesObjetivosPorEmpresa($id_empresa);
    $total_dimensiones            = 0;
    $total_fijaciones_finalizadas = 0;
    $total_validadas              = 0;
    if ($rut_validador) {
        $row_html = file_get_contents("views/sgd/objetivos/row_colaboradores_lista_resumen_validador.html");
    } else {
        //$row_html=file_get_contents("views/sgd/objetivos/row_colaboradores_lista_resumen.html");
        $row_html = file_get_contents("views/sgd/objetivos/" . $id_empresa . "_row_colaboradores_lista_resumen.html");
    }
    $datos_proceso = TraeProcesosDeEvaluacionDadoId($id_proceso);
    if ($datos_proceso[0]->quien_fija == "evaluado") {
        $row .= $row_html;
        $row                         = str_replace("{NOMBRE}", $datos_fijador[0]->nombre_completo, $row);
        $row                         = str_replace("{FECHA_INGRESO}", $datos_fijador[0]->fecha_ingreso, $row);
        $row                         = str_replace("{PERFIL_COMPETENCIAS}", $datos_fijador[0]->perfil_competencia, $row);
        $row                         = str_replace("{JEFE}", $datos_fijador[0]->nombre_evaluador, $row);
        $datos_jefe_dede_tbl_usuario = UsuarioEnBasePersonas($datos_fijador[0]->jefe);
        if ($datos_jefe_dede_tbl_usuario[0]->nombre_completo) {
            $row = str_replace("{JEFE_DESDE_TABLA_USUARIO}", $datos_jefe_dede_tbl_usuario[0]->nombre_completo, $row);
        } else {
            $row = str_replace("{JEFE_DESDE_TABLA_USUARIO}", "Sin Jefatura", $row);
        }
        $row             = str_replace("{JEFE_DEL_JEFE}", $datos_fijador[0]->nombre_validador, $row);
        $row             = str_replace("{CARGO}", $datos_fijador[0]->cargo_evaluado, $row);
        $row             = str_replace("{FECHA_INGRESO}", $datos_fijador[0]->fecha_ingreso_evaluado, $row);
        $row             = str_replace("{SUCURSALES_CASAMATRIZ}", $eva->sucursal, $row);
        //Veo si esta finalizado para el evaluado, si es asi, muestro el boton para que ve alos objetivos fijados
        $esta_finalizado = VerificaDimensionFinalizadaObjetivosPorEvaluado($rut_fijador, $id_empresa);
        if ($esta_finalizado) {
            $row = str_replace("{BOTON_VER_DETALLE}", file_get_contents("views/sgd/objetivos/boton_ver_detalle_evaluado_desde_evaluado.html"), $row);
            $row = str_replace("{BOTON_VE_INFORME}", file_get_contents("views/sgd/objetivos/" . $id_empresa . "_boton_descarga_informe.html"), $row);
        } else {
            $row = str_replace("{BOTON_VE_INFORME}", "", $row);
            if ($id_empresa == 76) {
                $row = str_replace("{BOTON_VER_DETALLE}", file_get_contents("views/sgd/objetivos/boton_ver_detalle_evaluado_desde_evaluador.html"), $row);
            } else {
                $row = str_replace("{BOTON_VER_DETALLE}", "", $row);
            }
        }
        $row = str_replace("{RUT_EVALUADO}", $rut_fijador, $row);
        $row = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($rut_fijador), $row);
        $row = str_replace("{URL_PERSONA}", VerificaFotoPersonal($rut_fijador), $row);
        foreach ($dimensiones_por_empresa as $dimen) {
            $row_dimensiones .= file_get_contents("views/sgd/objetivos/" . $id_empresa . "_row_resumen_por_dimension_evaluado.html");
            $row_dimensiones             = str_replace("{NOMBRE_DIMENSION}", $dimen->nombre, $row_dimensiones);
            //Verifico si est? finalizada esta dimension para este evaluado
            $estado_dimension            = VerificaEstadoDimensionesObjetivos($rut_fijador, $dimen->id, $id_empresa);
            $row_dimensiones             = str_replace("{ESTADO}", $estado_dimension[0], $row_dimensiones);
            $estado_dimension_validacion = VerificaEstadoDimensionesObjetivosParaValidacion($rut_fijador, $dimen->id, $id_empresa);
            $row_dimensiones             = str_replace("{ESTADO_VALIDACION}", $estado_dimension_validacion[0], $row_dimensiones);
            $estado_ingresado            = VerificaEstadoDimensionesObjetivosIngresados($rut_fijador, $dimen->id, $id_empresa);
            $row_dimensiones             = str_replace("{ESTADO_INGRESO}", $estado_ingresado[0], $row_dimensiones);
            if ($estado_ingresado[1] == 1) {
                $total_ingresos++;
            }
        }
        $row = str_replace("{ROW_RESUMEN_POR_EVALUADO}", $row_dimensiones, $row);
        if ($id_empresa == 76) {
            $row_miperfil = $row;
            $row          = "";
        }
    }
    $PRINCIPAL = str_replace("{LISTADO_MI_PERFIL}", utf8_encode($row_miperfil), $PRINCIPAL);
    foreach ($evaluados as $eva) {
        //$dimensione s_por_empresa=DimensionesObjetivosPorEmpresaCruceFinalizados($id_empresa, $eva->evaluado);
        if ($eva->objetivos_masivos == 1) {
            $row .= file_get_contents("views/sgd/objetivos/" . $id_empresa . "_row_colaboradores_lista_resumen_masivo.html");
        } else {
            $row .= $row_html;
        }
        //ACA Verifico si es que est? o no validado
        $objetivos_validados = VerificaSiObjetivosEstanValidadosDadoEvaluadorIdProcesoEvaluado($rut_fijador, $id_proceso, $eva->evaluado);
        if ($objetivos_validados or $eva->objetivos_masivos == 1) {
            if ($rut_validador) {
                $row = str_replace("{BOTON_VE_INFORME}", file_get_contents("views/sgd/objetivos/boton_descarga_informe_desde_validador.html"), $row);
            } else {
                //$row = str_replace("{BOTON_VE_INFORME}",file_get_contents("views/sgd/objetivos/boton_descarga_informe.html"),$row);
                if ($eva->objetivos_masivos == 1) {
                    $row = str_replace("{BOTON_VE_INFORME}", file_get_contents("views/sgd/objetivos/boton_descarga_informe_solo_texto.html"), $row);
                } else {
                    $row = str_replace("{BOTON_VE_INFORME}", file_get_contents("views/sgd/objetivos/boton_descarga_informe.html"), $row);
                }
            }
            //Veo si esta descargado este informe, si es asi, coloco texto finalizado
            $esta_finalizado_proceso = OBJETIVOS_InformesDescargadosPorEvaluadorProcesoEmpresaEvaluado($eva->evaluado, $eva->evaluador, $id_proceso, $id_empresa);
            if ($esta_finalizado_proceso) {
                $texto_a_mostrar = file_get_contents("views/sgd/objetivos/texto_proceso_finalizado.html");
            } else {
                $texto_a_mostrar = "";
            }
            if ($eva->objetivos_masivos == 1) {
                $texto_a_mostrar .= file_get_contents("views/sgd/objetivos/texto_carga_masiva.html");
            }
            $row = str_replace("{TEXTO_PROCESO_FINALIZADO}", $texto_a_mostrar, $row);
            //$row = str_replace("{BOTON_VER_DETALLE}","acacacac",$row);
            $row = str_replace("{BOTON_VER_DETALLE}", file_get_contents("views/sgd/objetivos/boton_visualiza_metas.html"), $row);
        } else {
            $row = str_replace("{BOTON_VE_INFORME}", "", $row);
            if ($rut_validador) {
                $row = str_replace("{BOTON_VER_DETALLE}", file_get_contents("views/sgd/objetivos/boton_ver_detalle_evaluado.html"), $row);
            } else {
                $row = str_replace("{BOTON_VER_DETALLE}", file_get_contents("views/sgd/objetivos/boton_ver_detalle_evaluado_desde_evaluador.html"), $row);
            }
        }
        $row             = str_replace("{NOMBRE}", $eva->nombre_completo, $row);
        $row             = str_replace("{FECHA_INGRESO}", $eva->fecha_ingreso, $row);
        $row             = str_replace("{PERFIL_COMPETENCIAS}", $eva->perfil_competencia, $row);
        $row             = str_replace("{JEFE}", $eva->nombre_evaluador_1, $row);
        $row             = str_replace("{JEFE_DEL_JEFE}", $eva->nombre_validador, $row);
        $row             = str_replace("{JEFE_DESDE_TABLA_USUARIO}", $eva->nombre_evaluador_1, $row);
        $row             = str_replace("{CARGO}", $eva->cargo_evaluado, $row);
        $row             = str_replace("{CARGO}", $eva->cargo_evaluado, $row);
        $row             = str_replace("{SUCURSALES_CASAMATRIZ}", $eva->sucursal, $row);
        $row             = str_replace("{RUT_EVALUADO}", $eva->evaluado, $row);
        $row             = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($eva->evaluado), $row);
        $row             = str_replace("{URL_PERSONA}", VerificaFotoPersonal($eva->evaluado), $row);
        //Por cada colaborador, armo el menu de resumen
        $row_dimensiones = "";
        foreach ($dimensiones_por_empresa as $dimen) {
            $row_dimensiones .= file_get_contents("views/sgd/objetivos/" . $id_empresa . "_row_resumen_por_dimension_evaluado.html");
            $row_dimensiones             = str_replace("{NOMBRE_DIMENSION}", $dimen->nombre, $row_dimensiones);
            //Verifico si est? finalizada esta dimension para este evaluado
            $estado_dimension            = VerificaEstadoDimensionesObjetivos($eva->evaluado, $dimen->id, $id_empresa);
            $row_dimensiones             = str_replace("{ESTADO}", $estado_dimension[0], $row_dimensiones);
            $estado_dimension_validacion = VerificaEstadoDimensionesObjetivosParaValidacion($eva->evaluado, $dimen->id, $id_empresa);
            $row_dimensiones             = str_replace("{ESTADO_VALIDACION}", $estado_dimension_validacion[0], $row_dimensiones);
            $estado_ingresado            = VerificaEstadoDimensionesObjetivosIngresados($eva->evaluado, $dimen->id, $id_empresa);
            $row_dimensiones             = str_replace("{ESTADO_INGRESO}", $estado_ingresado[0], $row_dimensiones);
            if ($estado_dimension_validacion[1] == 3) {
                $matriz_total_validadas[$dimen->id]["validadas"]++;
            }
            if ($estado_ingresado[1] == 1) {
                $total_ingresos++;
            }
            $total_dimensiones++;
            $matris_datos_generales[$dimen->id]["total"]++;
            //Esto implica si esta finalizado o no.
            if ($estado_dimension[1] == 1) {
                $total_fijaciones_finalizadas++;
                $matris_datos_generales[$dimen->id]["finalizado"]++;
            }
        }
        $row = str_replace("{ROW_RESUMEN_POR_EVALUADO}", $row_dimensiones, $row);
    }
    $PRINCIPAL = str_replace("{LISTADO_COLABORADORES}", utf8_encode($row), $PRINCIPAL);
    $PRINCIPAL = str_replace("{AVANCE_EVALUADOS}", EntregaPorcentaje($total_dimensiones, $total_fijaciones_finalizadas), $PRINCIPAL);
    foreach ($dimensiones_por_empresa as $dimen) {
        $row_dimensiones_gen .= file_get_contents("views/sgd/objetivos/" . $id_empresa . "_row_resumen_por_dimension.html");
        $row_dimensiones_gen = str_replace("{NOMBRE_DIMENSION}", $dimen->nombre, $row_dimensiones_gen);
        $row_dimensiones_gen = str_replace("{AVANCE_DIMENSION}", EntregaPorcentaje($matris_datos_generales[$dimen->id]["total"], $matris_datos_generales[$dimen->id]["finalizado"]), $row_dimensiones_gen);
        $row_dimensiones_gen = str_replace("{AVANCE_DIMENSION_VALIDACION}", EntregaPorcentaje($matris_datos_generales[$dimen->id]["total"], $matriz_total_validadas[$dimen->id]["validadas"]), $row_dimensiones_gen);
        $row_dimensiones_gen = str_replace("{AVANCE_DIMENSION_INGRESO}", EntregaPorcentaje($matris_datos_generales[$dimen->id]["total"], ($total_ingresos / count($dimensiones_por_empresa))), $row_dimensiones_gen);
    }
    $PRINCIPAL = str_replace("{ROW_LISTADO_RESUMEN}", utf8_encode($row_dimensiones_gen), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaResumenObjetivos($PRINCIPAL, $rut_fijador, $id_empresa)
{
    return ($PRINCIPAL);
}
function colocarColaboradoresPorRutConDatos($PRINCIPAL, $id_empresa, $rut)
{
    $listado_colaboradores = TotalUsuariosPorRutJefe($rut);
    foreach ($listado_colaboradores as $unico) {
        //$row.=file_get_contents("views/miperfil/row_colaboradores_miperfil.html");
        $row .= file_get_contents("views/miequipo/row_equipo_resumen.html");
        $row = str_replace("{NOMBRE}", $unico->nombre . " " . $unico->apaterno . " " . $unico->amaterno, $row);
        $row = str_replace("{CARGO}", $unico->cargo, $row);
        $row = str_replace("{FECHA_CUMPLEANOS}", formatearFecha($unico->fecha_nacimiento), $row);
        $row = str_replace("{URL_PERSONA}", VerificaFotoPersonal($unico->rut), $row);
        $row = str_replace("{RUT_ENCODEADO}", Encodear3($unico->rut), $row);
        list($total_inscripciones, $total_aprobados, $total_reprobados, $total_en_proceso) = CAPACITACION_DatosGeneralesPorUsuario($unico->rut);
        $estado                           = EntregaEstadoAvanceBarraMalla(EntregaPorcentaje($total_inscripciones, $total_aprobados));
        $acumulador_avance_colaboradores  = $acumulador_avance_colaboradores + EntregaPorcentaje($total_inscripciones, $total_aprobados);
        $PRINCIPAL                        = str_replace("{NUMERO_AVANCE}", round(EntregaPorcentaje($total_inscripciones, $total_aprobados)), $PRINCIPAL);
        $PRINCIPAL                        = str_replace("{COLOR_PROGRESS_BAR}", $estado[0], $PRINCIPAL);
        $row                              = str_replace("{AVANCE_COLABORADOR}", EntregaPorcentaje($total_inscripciones, $total_aprobados), $row);
        $total_visitas                    = TotalVisitasDadoRutCaseEmpresaFront($unico->rut, $id_empresa, "home_minvest");
        $row                              = str_replace("{NUM_VISITAS_COLABORADOR}", $total_visitas[0]->total_visitas, $row);
        $acumulador_visitas_colaboradores = $acumulador_visitas_colaboradores + $total_visitas[0]->total_visitas;
    }
    $PRINCIPAL = str_replace("{NUM_PERSONAS_MI_EQUIPO}", count($listado_colaboradores), $PRINCIPAL);
    $PRINCIPAL = str_replace("{PROMEDIO_EQUIPO}", round($acumulador_avance_colaboradores / count($listado_colaboradores)), $PRINCIPAL);
    $PRINCIPAL = str_replace("{NUM_VISITAS_MI_EQUIPO}", $acumulador_visitas_colaboradores, $PRINCIPAL);
    $PRINCIPAL = str_replace("{BLOQUE_COLABORADORES}", utf8_encode($row), $PRINCIPAL);
    return ($PRINCIPAL);
}
function colocarReconocimientosGraciasPorRut($PRINCIPAL, $id_empresa, $rut)
{
    $listado = TotalReconocimientosGraciasJefe($rut, $id_empresa);
    //print_r($listado);
    foreach ($listado as $unico) {
        $row .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_rec_vot_carrusel.html");
        $row                              = str_replace("{NOMBRE_DESTINATARIO}", $unico->nombre_destinatario, $row);
        $row                              = str_replace("{NOMBRE_REMITENTE}", $unico->nombre_remitente, $row);
        $row                              = str_replace("{FOTO_DESTINATARIO}", VerificaFotoPersonal($unico->avatar_destinatario), $row);
        $row                              = str_replace("{FOTO_REMITENTE}", VerificaFotoPersonal($unico->avatar_remitente), $row);
        $row                              = str_replace("{MENSAJE}", ($unico->mensaje), $row);
        $acumulador_visitas_colaboradores = $acumulador_visitas_colaboradores + $total_visitas[0]->total_visitas;
        $cuenta_colaborador++;
    }
    $lms_graf_acciones_verde = $sum_verde;
    $PRINCIPAL               = str_replace("{NUM_PERSONAS_MI_EQUIPO}", count($listado_colaboradores), $PRINCIPAL);
    $PRINCIPAL               = str_replace("{PROMEDIO_EQUIPO}", round($acumulador_avance_colaboradores / count($listado_colaboradores)), $PRINCIPAL);
    $PRINCIPAL               = str_replace("{NUM_VISITAS_MI_EQUIPO}", $acumulador_visitas_colaboradores, $PRINCIPAL);
    $PRINCIPAL               = str_replace("{ROW_REC_VAL_CARRUSEL_RECONOCIMIENTOS_GRACIAS}", utf8_encode($row), $PRINCIPAL);
    return ($PRINCIPAL);
}
function colocarPuntosPorRut($PRINCIPAL, $id_empresa, $rut)
{
    $listado = TotalReconocimientosGraciasJefe($rut, $id_empresa);
    //print_r($listado);

    foreach ($listado as $unico) {
        //$row.=file_get_contents("views/reconoce_vota/".$id_empresa."_rec_vot_carrusel.html");
        //$row = str_replace("{NOMBRE_DESTINATARIO}",$unico->nombre_destinatario,$row);
        //$row = str_replace("{NOMBRE_REMITENTE}",$unico->nombre_remitente,$row);
        // $row = str_replace("{FOTO_DESTINATARIO}",VerificaFotoPersonal($unico->avatar_destinatario),$row);
        // $row = str_replace("{FOTO_REMITENTE}",VerificaFotoPersonal($unico->avatar_remitente),$row);
        // $row = str_replace("{MENSAJE}",($unico->mensaje),$row);
        // $acumulador_visitas_colaboradores=$acumulador_visitas_colaboradores+$total_visitas[0]->total_visitas;
        // $cuenta_colaborador++;
    }

    // solo dos tipos de puntos

    if($id_empresa=="52"){



    $row .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_puntos_counter.html");
    $row = str_replace("{ICONO_PUNTOS}", "i-plain nobottommargin i-azul fas fa-gem", $row);
    $row = str_replace("{PUNTOS}", "0", $row);
    $row = str_replace("{NOMBRE_PUNTOS}", "Diamantes", $row);
    $row .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_puntos_counter.html");
    $row       = str_replace("{ICONO_PUNTOS}", "i-plain nobottommargin i-azul far fa-dot-circle", $row);
    $row       = str_replace("{PUNTOS}", "0", $row);
    $row       = str_replace("{NOMBRE_PUNTOS}", "Puntos", $row);
    $PRINCIPAL = str_replace("{ROW_PUNTOS_PROFILE}", utf8_encode($row), $PRINCIPAL);

    }


    if($id_empresa=="81"){

    $row1 .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_puntos_counter_only.html");
    $row1       = str_replace("{ICONO_PUNTOS}", "i-plain nobottommargin i-azul far fa-dot-circle", $row1);
    $row1       = str_replace("{PUNTOS}", "0", $row1);
    $row1       = str_replace("{NOMBRE_PUNTOS}", "Puntos", $row1);
    $PRINCIPAL = str_replace("{ROW_PUNTOS_PROFILE}", utf8_encode($row1), $PRINCIPAL);

    }
    //puntos empresa 78

    if($id_empresa=="78"){

    $row1 .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_puntos_counter_only.html");
    $row1       = str_replace("{ICONO_PUNTOS}", "i-plain nobottommargin i-azul fas fa-globe", $row1);
    $row1       = str_replace("{PUNTOS}", "0", $row1);
    $row1       = str_replace("{NOMBRE_PUNTOS}", "Puntos", $row1);
    $PRINCIPAL = str_replace("{ROW_PUNTOS_PROFILE}", utf8_encode($row1), $PRINCIPAL);

    }

    return ($PRINCIPAL);
}



function colocarReconocimientosPerfilPorEquipo($PRINCIPAL, $id_empresa, $rut)
{
    $arr_reco            = BuscaDatosReconocimientoAgradecimientosEquipo($rut, $id_empresa);
    $num_gracias         = $arr_reco[0]->num_gracias;
    $num_reconocimientos = $arr_reco[0]->num_reconocimientos;
    $row .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_puntos_counter.html");
    $row = str_replace("{ICONO_PUNTOS}", "icon-star", $row);
    $row = str_replace("{PUNTOS}", $num_reconocimientos, $row);
    $row = str_replace("{NOMBRE_PUNTOS}", "Reconocimientos", $row);
    $row .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_puntos_counter.html");
    $row       = str_replace("{ICONO_PUNTOS}", "far fa-heart", $row);
    $row       = str_replace("{PUNTOS}", $num_gracias, $row);
    $row       = str_replace("{NOMBRE_PUNTOS}", "Agradecimientos", $row);
    $PRINCIPAL = str_replace("{ROW_RECONOCIMIENTOS_PROFILE}", utf8_encode($row), $PRINCIPAL);
    return ($PRINCIPAL);
}
function colocarReconocimientosPerfilPorRut($PRINCIPAL, $id_empresa, $rut)
{
    $arr_reco            = BuscaDatosReconocimientoAgradecimientos($rut, $id_empresa);
    $num_gracias         = $arr_reco[0]->num_gracias;
    $num_reconocimientos = $arr_reco[0]->num_reconocimientos;
    $row .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_puntos_counter.html");
    $row = str_replace("{ICONO_PUNTOS}", "icon-star", $row);
    $row = str_replace("{PUNTOS}", $num_reconocimientos, $row);
    $row = str_replace("{NOMBRE_PUNTOS}", "Reconocimientos", $row);
    $row .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_puntos_counter.html");
    $row       = str_replace("{ICONO_PUNTOS}", "far fa-heart", $row);
    $row       = str_replace("{PUNTOS}", $num_gracias, $row);
    $row       = str_replace("{NOMBRE_PUNTOS}", "Agradecimientos", $row);
    $PRINCIPAL = str_replace("{ROW_RECONOCIMIENTOS_PROFILE}", utf8_encode($row), $PRINCIPAL);
    return ($PRINCIPAL);
}

function colocarKpiPorRut($PRINCIPAL, $id_empresa, $rut)
{
    $cuenta_kpi = 0;
    $listado       = lista_kpis_por_rut($rut, $id_empresa);
   // print_r($listado);

    foreach ($listado as $unico) {

        $row .= file_get_contents("views/kpi/".$id_empresa."_lista_kpis.html");
        $row = str_replace("{NOMBRE_KPI}",  utf8_encode($unico->nombre),     $row);
        $row = str_replace("{DATO1}",       utf8_encode($unico->avance),     $row);
        $row = str_replace("{DATO2}",       utf8_encode($unico->variacion),  $row);
        $row = str_replace("{DATO3}",       utf8_encode($unico->monto),      $row);

    }
    $PRINCIPAL = str_replace("{KPIS_PERFIL_PERSONAL}", ($row), $PRINCIPAL);
    $PRINCIPAL = str_replace("{NUM_BADGES}", ($cuenta_badges), $PRINCIPAL);
    return ($PRINCIPAL);
}

function colocarlogrosBadgesPorRut($PRINCIPAL, $id_empresa, $rut)
{
    $cuenta_badges = 0;
    $listado       = lista_badges_por_rut($rut, $id_empresa);
    foreach ($listado as $unico) {
        if ($unico->fecha == "") {
            $estilo_badge = " img_grayscale_opacity";
            $texto        = "<br>" . utf8_encode($unico->nombre);
            $width_image  = "96px";
        } else {
            $estilo_badge = "";
            $texto        = "<br>" . utf8_encode($unico->nombre) . "<br>" . $unico->fecha;
            $width_image  = "96px";
            $cuenta_badges++;
        }
        $row .= file_get_contents("views/badges/" . $id_empresa . "_lista_badges.html");
        $row = str_replace("{IMAGEN_BADGE}", $unico->imagen, $row);
        $row = str_replace("{ESTILO_IMAGEN_BADGE}", $estilo_badge, $row);
        $row = str_replace("{TEXTO_BADGE}", $texto, $row);
        $row = str_replace("{WIDTH_IMAGEN_BADGE}", $width_image, $row);
    }
    $PRINCIPAL = str_replace("{LISTA_BADGES_PLATAFORMA}", ($row), $PRINCIPAL);
    $PRINCIPAL = str_replace("{NUM_BADGES}", ($cuenta_badges), $PRINCIPAL);
    return ($PRINCIPAL);
}

function colocarReconocimiesBadgesPorRutEquipo($PRINCIPAL, $id_empresa, $rut)
{
    $cuenta_badges = 0;
    $listado       = lista_reconocimientos_badges_por_rut($rut, $id_empresa);
    foreach ($listado as $unico) {

        print_r($unico);
        $row="hola";


    }
    $PRINCIPAL = str_replace("{LISTA_RECONOCIMIENTOS_PLATAFORMA}", ($row), $PRINCIPAL);
    return ($PRINCIPAL);
}

function colocarlogrosBadgesPorEquipo($PRINCIPAL, $id_empresa, $rut)
{
    $cuenta_badges = 0;
    $listado       = lista_badges_por_rut($rut, $id_empresa);
    // busca usuarios de equipo
    foreach ($listado as $unico) {
        if ($unico->fecha == "") {
            $estilo_badge = " img_grayscale_opacity";
            $texto        = "<br>" . $unico->nombre;
        } else {
            $estilo_badge = "";
            $texto        = "<br>" . $unico->nombre . "<br>" . $unico->fecha;
            $cuenta_badges++;
        }
        $row .= file_get_contents("views/badges/" . $id_empresa . "_lista_badges.html");
        $row = str_replace("{IMAGEN_BADGE}", $unico->imagen, $row);
        $row = str_replace("{ESTILO_IMAGEN_BADGE}", $estilo_badge, $row);
        $row = str_replace("{TEXTO_BADGE}", $texto, $row);
    }
    $PRINCIPAL = str_replace("{LISTA_BADGES_PLATAFORMA}", utf8_encode($row), $PRINCIPAL);
    $PRINCIPAL = str_replace("{NUM_BADGES}", ($cuenta_badges), $PRINCIPAL);
    return ($PRINCIPAL);
}
function colocarListaEquipoLogros($PRINCIPAL, $id_empresa, $rut)
{
    $listado = lista_PersonasEquipo($rut, $id_empresa);
    foreach ($listado as $unico) {
        $row .= file_get_contents("views/badges/" . $id_empresa . "_row_lista_equipo_logros.html");
        $num_badges = $unico->numbadges + $num_badges;
        $row        = str_replace("{RUT_DESTINATARIO}", $unico->rut, $row);
        $row        = str_replace("{AVATAR_DESTINATARIO}", VerificaFotoPersonal($unico->rut), $row, $row);
        $row        = str_replace("{NOMBRE_DESTINATARIO}", utf8_decode($unico->nombre_destinatario), $row);
        $row        = str_replace("{CARGO_DESTINATARIO}", utf8_decode($unico->cargo_destinatario), $row);
        $row        = str_replace("{NUM_RECONOCIMIENTOS_DESTINATARIO}", $unico->num_reconocimientos_destinatario, $row);
        $row        = str_replace("{NUM_GRACIAS_DESTINATARIO}", $unico->num_gracias_destinatario, $row);
        $row        = colocarlogrosBadgesPorRut($row, $id_empresa, $unico->rut);
    }
    $PRINCIPAL = str_replace("{NUM_BADGES}", ($num_badges), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ROW_TABLA_BADGES_RECIBIDOS}", ($row), $PRINCIPAL);
    return ($PRINCIPAL);
}

function colocarListaEquipoReconocimientos($PRINCIPAL, $id_empresa, $rut)
{
    $listado = lista_PersonasReconocidasEquipo($rut, $id_empresa);
    foreach ($listado as $unico) {

        //print_r($unico);
     $row .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_row_lista_equipo_reconocer.html");
        $num_badges = $unico->numbadges + $num_badges;
        $row        = str_replace("{RUT_DESTINATARIO}", $unico->rut, $row);
        $row        = str_replace("{AVATAR_DESTINATARIO}", VerificaFotoPersonal($unico->rut), $row, $row);
        $row        = str_replace("{NOMBRE_DESTINATARIO}", utf8_decode($unico->nombre_destinatario), $row);
        $row        = str_replace("{CARGO_DESTINATARIO}", utf8_decode($unico->cargo_destinatario), $row);
        $row        = str_replace("{NUM_RECONOCIMIENTOS_DESTINATARIO}", $unico->num_reconocimientos_destinatario, $row);
        $row        = str_replace("{NUM_GRACIAS_DESTINATARIO}", $unico->num_gracias_destinatario, $row);

    //echo "<br> num_reconocimientos_destinatario".$unico->num_reconocimientos_destinatario;

    $suma_reconocimientos=$unico->num_reconocimientos_destinatario+$suma_reconocimientos;
    $suma_gracias=$unico->num_gracias_destinatario+$suma_gracias;
    //echo "<br>suma_reconocimientos $suma_reconocimientos , unico ".$unico->num_reconocimientos_destinatario;


    $array_badge=lista_reconocimientos_badges_por_rut($unico->rut, $id_empresa);
    //print_r($array_badge);
    $lista_reconocimiento="";
    foreach ($array_badge as $unico2){

         $tipo_reco=""; $estilo_reco=="";
    if ($unico2->tipo == "RECONOCIMIENTO") {
            $tipo_reco   = "<i class='i-plain-sm nobottommargin i-azul icon-star'></i> <STRONG>Reconocimiento de ".$unico2->remitente."</STRONG><BR>Mensaje:&nbsp;".utf8_encode($unico2->mensaje)."<br>Fecha: ".utf8_encode($unico2->fecha);
            $estilo_reco = "";
        } elseif ($unico2->tipo == "GRACIAS") {
            $tipo_reco   = "<i class='i-plain-sm nobottommargin i-azul far fa-heart'></i> <STRONG>Agradecimiento de ".$unico2->remitente."</STRONG><BR>Mensaje:&nbsp;".utf8_encode($unico2->mensaje)."<br>Fecha: ".utf8_encode($unico2->fecha);
            $estilo_reco = "";
        }
        if ($unico2->tipo == "RECONOCIMIENTO" and $unico->rut_destinatario == $rut) {
            $tipo_reco   = "";
            $estilo_reco = "info";
        }
        if ($unico2->tipo == "GRACIAS" and $unico->rut_destinatario == $rut) {
            $tipo_reco   = "";
            $estilo_reco = "";
        }

        $lista_reconocimiento.="<br>$tipo_reco ";

    }





    $row        = str_replace("{ROW_RECONOCIMIENTOS_RECIBIDOS}", $lista_reconocimiento, $row);





    }

        $PRINCIPAL = str_replace("{NUM_BADGES}", ($num_badges), $PRINCIPAL);


    //echo "<br>$suma_reconocimientos";
    $PRINCIPAL = str_replace("{NUM_RECO}",     ($suma_reconocimientos), $PRINCIPAL);
    $PRINCIPAL = str_replace("{NUM_GRAC}",             ($suma_gracias), $PRINCIPAL);

    $PRINCIPAL = str_replace("{ROW_TABLA_RECONOCIMIENTOS_RECIBIDOS}", ($row), $PRINCIPAL);
    return ($PRINCIPAL);
}

function colocarListaReconocimientosPorRut($PRINCIPAL, $id_empresa, $rut)
{
    $listado = TotalReconocimientosGraciasVistaPerfil($rut, $id_empresa, "recibidos");
    foreach ($listado as $unico) {
        $cuenta_reconocimiento_recibidos++;
        if ($unico->tipo == "RECONOCIMIENTO") {
            $tipo_reco   = "<i class='i-plain-sm nobottommargin i-azul icon-star'></i> <BR>Reconocimiento";
            $estilo_reco = "";
        } elseif ($unico->tipo == "GRACIAS") {
            $tipo_reco   = "<i class='i-plain-sm nobottommargin i-azul far fa-heart'></i> <BR>Agradecimiento";
            $estilo_reco = "";
        }
        if ($unico->tipo == "RECONOCIMIENTO" and $unico->rut_destinatario == $rut) {
            $estilo_reco = "info";
        }
        if ($unico->tipo == "GRACIAS" and $unico->rut_destinatario == $rut) {
            $estilo_reco = "";
        }
        //    echo "<br>".$tipo_reco;
        $row .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_lista_reconocimientos_perfil_tabla.html");
        $row = str_replace("{ESTILO}", $estilo_reco, $row);
        $row = str_replace("{FECHA}", $unico->fecha, $row);
        $row = str_replace("{TIPO_RECO}", $tipo_reco, $row);
        $row = str_replace("{RUT_REMITENTE}", $unico->rut_remitente, $row);
        $row = str_replace("{AVATAR_REMITENTE}", "multimedia/" . utf8_decode($unico->avatar_remitente), $row);
        $row = str_replace("{NOMBRE_REMITENTE}", $unico->nombre_remitente, $row);
        $row = str_replace("{CARGO_REMITENTE}", $unico->cargo_remitente, $row);
        $row = str_replace("{NUM_RECONOCIMIENTOS_REMITENTE}", $unico->num_reconocimientos_rut_remitente, $row);
        $row = str_replace("{NUM_GRACIAS_REMITENTE}", $unico->num_gracias_rut_remitente, $row);
        $row = str_replace("{RUT_DESTINATARIO}", $unico->rut_destinatario, $row);
        $row = str_replace("{AVATAR_DESTINATARIO}", VerificaFotoPersonal($unico->rut_destinatario), $row, $row);
        $row = str_replace("{NOMBRE_DESTINATARIO}", $unico->nombre_destinatario, $row);
        $row = str_replace("{CARGO_DESTINATARIO}", $unico->cargo_destinatario, $row);
        $row = str_replace("{NUM_RECONOCIMIENTOS_DESTINATARIO}", $unico->num_reconocimientos_destinatario, $row);
        $row = str_replace("{NUM_GRACIAS_DESTINATARIO}", $unico->num_gracias_destinatario, $row);
        $row = str_replace("{MENSAJE}", ($unico->mensaje), $row);

        if($tipo_reco=="GRACIAS"){$icono="<i class='i-plain-sm nobottommargin i-azul far fa-heart'></i>"; $tipotext="Agradecimiento de ";}
         else {$icono="<i class='i-plain-sm nobottommargin i-azul icon-star'></i>"; $tipotext="Agradecimiento de ";}
        $row = str_replace("{ICONO}", ($icono), $row);
        $row = str_replace("{TIPOTEXT}", ($tipotext), $row);

    }
    $PRINCIPAL = str_replace("{ROW_REC_TABLA_RECONOCIMIENTOS_GRACIAS_RECIBIDOS_PERFIL}", utf8_encode($row), $PRINCIPAL);
    $row       = "";
    $listado   = TotalReconocimientosGraciasVistaPerfil($rut, $id_empresa, "enviados");
    foreach ($listado as $unico) {
        $cuenta_reconocimiento_entregados++;
        if ($unico->tipo == "RECONOCIMIENTO") {
            $tipo_reco   = "<i class='i-plain-sm nobottommargin i-azul icon-star'></i> <BR>Reconocimiento";
            $estilo_reco = "";
        } elseif ($unico->tipo == "GRACIAS") {
            $tipo_reco   = "<i class='i-plain-sm nobottommargin i-azul far fa-heart'></i> <BR>Agradecimiento";
            $estilo_reco = "";
        }
        if ($unico->tipo == "RECONOCIMIENTO" and $unico->rut_destinatario == $rut) {
            $estilo_reco = "info";
        }
        if ($unico->tipo == "GRACIAS" and $unico->rut_destinatario == $rut) {
            $estilo_reco = "";
        }
        $row .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_lista_reconocimientos_perfil_tabla.html");
        $row = str_replace("{ESTILO}", $estilo_reco, $row);
        $row = str_replace("{FECHA}", $unico->fecha, $row);
        $row = str_replace("{TIPO_RECO}", $tipo_reco, $row);
        $row = str_replace("{RUT_REMITENTE}", $unico->rut_remitente, $row);
        $row = str_replace("{AVATAR_REMITENTE}", VerificaFotoPersonal($unico->rut_remitente), $row);
        $row = str_replace("{NOMBRE_REMITENTE}", $unico->nombre_remitente, $row);
        $row = str_replace("{CARGO_REMITENTE}", $unico->cargo_remitente, $row);
        $row = str_replace("{NUM_RECONOCIMIENTOS_REMITENTE}", $unico->num_reconocimientos_rut_remitente, $row);
        $row = str_replace("{NUM_GRACIAS_REMITENTE}", $unico->num_gracias_rut_remitente, $row);
        $row = str_replace("{RUT_DESTINATARIO}", $unico->rut_destinatario, $row);
        $row = str_replace("{AVATAR_DESTINATARIO}", VerificaFotoPersonal($unico->rut_destinatario), $row, $row);
        $row = str_replace("{NOMBRE_DESTINATARIO}", $unico->nombre_destinatario, $row);
        $row = str_replace("{CARGO_DESTINATARIO}", $unico->cargo_destinatario, $row);
        $row = str_replace("{NUM_RECONOCIMIENTOS_DESTINATARIO}", $unico->num_reconocimientos_destinatario, $row);
        $row = str_replace("{NUM_GRACIAS_DESTINATARIO}", $unico->num_gracias_destinatario, $row);
        $row = str_replace("{MENSAJE}", ($unico->mensaje), $row);
    }
    $PRINCIPAL = str_replace("{ROW_REC_TABLA_RECONOCIMIENTOS_GRACIAS_ENVIADOS}", utf8_encode($row), $PRINCIPAL);
    if ($cuenta_reconocimiento_entregados > 0) {
        $rowT      = file_get_contents("views/reconoce_vota/" . $id_empresa . "_titulo_lista_reconocimientos_perfil_tabla_enviados.html");
        $PRINCIPAL = str_replace("{TITULO_ROW_REC_TABLA_RECONOCIMIENTOS_GRACIAS_ENVIADOS}", ($rowT), $PRINCIPAL);
        $rowT2     = file_get_contents("views/reconoce_vota/" . $id_empresa . "_titulo_fin_lista_reconocimientos_perfil_enviados.html");
        $PRINCIPAL = str_replace("{FIN_TITULO_ROW_REC_TABLA_RECONOCIMIENTOS_GRACIAS_ENVIADOS}", ($rowT2), $PRINCIPAL);
    } else {
        $rowT      = "";
        $rowT2     = "";
        $PRINCIPAL = str_replace("{TITULO_ROW_REC_TABLA_RECONOCIMIENTOS_GRACIAS_ENVIADOS}", ($rowT), $PRINCIPAL);
        $PRINCIPAL = str_replace("{FIN_TITULO_ROW_REC_TABLA_RECONOCIMIENTOS_GRACIAS_ENVIADOS}", ($rowT2), $PRINCIPAL);
    }
    if ($cuenta_reconocimiento_recibidos > 0) {
        $rowT      = file_get_contents("views/reconoce_vota/" . $id_empresa . "_titulo_lista_reconocimientos_perfil_tabla_recibidos.html");
        $PRINCIPAL = str_replace("{TITULO_ROW_REC_TABLA_RECONOCIMIENTOS_GRACIAS_RECIBIDOS}", ($rowT), $PRINCIPAL);
        $rowT2     = file_get_contents("views/reconoce_vota/" . $id_empresa . "_titulo_fin_lista_reconocimientos_perfil_tabla_recibidos.html");
        $PRINCIPAL = str_replace("{FIN_TITULO_ROW_REC_TABLA_RECONOCIMIENTOS_GRACIAS_RECIBIDOS}", ($rowT2), $PRINCIPAL);
    } else {
        $rowT      = "";
        $rowT2     = "";
        $PRINCIPAL = str_replace("{TITULO_ROW_REC_TABLA_RECONOCIMIENTOS_GRACIAS_RECIBIDOS}", ($rowT), $PRINCIPAL);
        $PRINCIPAL = str_replace("{FIN_TITULO_ROW_REC_TABLA_RECONOCIMIENTOS_GRACIAS_RECIBIDOS}", ($rowT2), $PRINCIPAL);
    }
    return ($PRINCIPAL);
}
function colocarListaReconocimientosPorEquipo($PRINCIPAL, $id_empresa, $rut)
{
    $listado = TotalReconocimientosGraciasVistaPerfilEquipo($rut, $id_empresa, "recibidos");
    foreach ($listado as $unico) {
        $cuenta_reconocimiento_recibidos++;
        if ($unico->tipo == "RECONOCIMIENTO") {
            $tipo_reco   = "<i class='i-plain-sm nobottommargin i-azul icon-star'></i> <BR>Reconocimiento";
            $estilo_reco = "";
        } elseif ($unico->tipo == "GRACIAS") {
            $tipo_reco   = "<i class='i-plain-sm nobottommargin i-azul far fa-heart'></i> <BR>Agradecimiento";
            $estilo_reco = "";
        }
        if ($unico->tipo == "RECONOCIMIENTO" and $unico->rut_destinatario == $rut) {
            $estilo_reco = "info";
        }
        if ($unico->tipo == "GRACIAS" and $unico->rut_destinatario == $rut) {
            $estilo_reco = "";
        }
        //  echo "<br>".$tipo_reco;
        $row .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_lista_reconocimientos_perfil_tabla.html");
        $row = str_replace("{ESTILO}", $estilo_reco, $row);
        $row = str_replace("{FECHA}", $unico->fecha, $row);
        $row = str_replace("{TIPO_RECO}", $tipo_reco, $row);
        $row = str_replace("{RUT_REMITENTE}", $unico->rut_remitente, $row);
        $row = str_replace("{AVATAR_REMITENTE}", VerificaFotoPersonal($unico->rut_remitente), $row);
        $row = str_replace("{NOMBRE_REMITENTE}", $unico->nombre_remitente, $row);
        $row = str_replace("{CARGO_REMITENTE}", $unico->cargo_remitente, $row);
        $row = str_replace("{NUM_RECONOCIMIENTOS_REMITENTE}", $unico->num_reconocimientos_rut_remitente, $row);
        $row = str_replace("{NUM_GRACIAS_REMITENTE}", $unico->num_gracias_rut_remitente, $row);
        $row = str_replace("{RUT_DESTINATARIO}", $unico->rut_destinatario, $row);
        $row = str_replace("{AVATAR_DESTINATARIO}", VerificaFotoPersonal($unico->rut_destinatario), $row, $row);
        $row = str_replace("{NOMBRE_DESTINATARIO}", $unico->nombre_destinatario, $row);
        $row = str_replace("{CARGO_DESTINATARIO}", $unico->cargo_destinatario, $row);
        $row = str_replace("{NUM_RECONOCIMIENTOS_DESTINATARIO}", $unico->num_reconocimientos_destinatario, $row);
        $row = str_replace("{NUM_GRACIAS_DESTINATARIO}", $unico->num_gracias_destinatario, $row);
        $row = str_replace("{MENSAJE}", ($unico->mensaje), $row);
    }
    $PRINCIPAL = str_replace("{ROW_REC_TABLA_RECONOCIMIENTOS_GRACIAS_RECIBIDOS}", utf8_encode($row), $PRINCIPAL);
    $row       = "";
    $listado   = TotalReconocimientosGraciasVistaPerfilEquipo($rut, $id_empresa, "enviados");
    foreach ($listado as $unico) {
        $cuenta_reconocimiento_entregados++;
        if ($unico->tipo == "RECONOCIMIENTO") {
            $tipo_reco   = "<i class='i-plain-sm nobottommargin i-azul icon-star'></i> <BR>Reconocimiento";
            $estilo_reco = "";
        } elseif ($unico->tipo == "GRACIAS") {
            $tipo_reco   = "<i class='i-plain-sm nobottommargin i-azul far fa-heart'></i> <BR>Agradecimiento";
            $estilo_reco = "";
        }
        if ($unico->tipo == "RECONOCIMIENTO" and $unico->rut_destinatario == $rut) {
            $estilo_reco = "info";
        }
        if ($unico->tipo == "GRACIAS" and $unico->rut_destinatario == $rut) {
            $estilo_reco = "";
        }
        $row .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_lista_reconocimientos_perfil_tabla.html");
        $row = str_replace("{ESTILO}", $estilo_reco, $row);
        $row = str_replace("{FECHA}", $unico->fecha, $row);
        $row = str_replace("{TIPO_RECO}", $tipo_reco, $row);
        $row = str_replace("{RUT_REMITENTE}", $unico->rut_remitente, $row);
        $row = str_replace("{AVATAR_REMITENTE}", VerificaFotoPersonal($unico->rut_destinatario), $row);
        $row = str_replace("{NOMBRE_REMITENTE}", $unico->nombre_remitente, $row);
        $row = str_replace("{CARGO_REMITENTE}", $unico->cargo_remitente, $row);
        $row = str_replace("{NUM_RECONOCIMIENTOS_REMITENTE}", $unico->num_reconocimientos_rut_remitente, $row);
        $row = str_replace("{NUM_GRACIAS_REMITENTE}", $unico->num_gracias_rut_remitente, $row);
        $row = str_replace("{RUT_DESTINATARIO}", $unico->rut_destinatario, $row);
        $row = str_replace("{AVATAR_DESTINATARIO}", VerificaFotoPersonal($unico->rut_destinatario), $row, $row);
        $row = str_replace("{NOMBRE_DESTINATARIO}", $unico->nombre_destinatario, $row);
        $row = str_replace("{CARGO_DESTINATARIO}", $unico->cargo_destinatario, $row);
        $row = str_replace("{NUM_RECONOCIMIENTOS_DESTINATARIO}", $unico->num_reconocimientos_destinatario, $row);
        $row = str_replace("{NUM_GRACIAS_DESTINATARIO}", $unico->num_gracias_destinatario, $row);
        $row = str_replace("{MENSAJE}", ($unico->mensaje), $row);
    }
    $PRINCIPAL = str_replace("{ROW_REC_TABLA_RECONOCIMIENTOS_GRACIAS_ENVIADOS}", utf8_encode($row), $PRINCIPAL);
    if ($cuenta_reconocimiento_entregados > 0) {
        $rowT      = file_get_contents("views/reconoce_vota/" . $id_empresa . "_titulo_lista_reconocimientos_perfil_tabla_enviados.html");
        $PRINCIPAL = str_replace("{TITULO_ROW_REC_TABLA_RECONOCIMIENTOS_GRACIAS_ENVIADOS}", ($rowT), $PRINCIPAL);
        $rowT2     = file_get_contents("views/reconoce_vota/" . $id_empresa . "_titulo_fin_lista_reconocimientos_perfil_enviados.html");
        $PRINCIPAL = str_replace("{FIN_TITULO_ROW_REC_TABLA_RECONOCIMIENTOS_GRACIAS_ENVIADOS}", ($rowT2), $PRINCIPAL);
    } else {
        $rowT      = "";
        $rowT2     = "";
        $PRINCIPAL = str_replace("{TITULO_ROW_REC_TABLA_RECONOCIMIENTOS_GRACIAS_ENVIADOS}", ($rowT), $PRINCIPAL);
        $PRINCIPAL = str_replace("{FIN_TITULO_ROW_REC_TABLA_RECONOCIMIENTOS_GRACIAS_ENVIADOS}", ($rowT2), $PRINCIPAL);
    }
    if ($cuenta_reconocimiento_recibidos > 0) {
        $rowT      = file_get_contents("views/reconoce_vota/" . $id_empresa . "_titulo_lista_reconocimientos_perfil_tabla_recibidos.html");
        $PRINCIPAL = str_replace("{TITULO_ROW_REC_TABLA_RECONOCIMIENTOS_GRACIAS_RECIBIDOS}", ($rowT), $PRINCIPAL);
        $rowT2     = file_get_contents("views/reconoce_vota/" . $id_empresa . "_titulo_fin_lista_reconocimientos_perfil_tabla_recibidos.html");
        $PRINCIPAL = str_replace("{FIN_TITULO_ROW_REC_TABLA_RECONOCIMIENTOS_GRACIAS_RECIBIDOS}", ($rowT2), $PRINCIPAL);
    } else {
        $rowT      = "";
        $rowT2     = "";
        $PRINCIPAL = str_replace("{TITULO_ROW_REC_TABLA_RECONOCIMIENTOS_GRACIAS_RECIBIDOS}", ($rowT), $PRINCIPAL);
        $PRINCIPAL = str_replace("{FIN_TITULO_ROW_REC_TABLA_RECONOCIMIENTOS_GRACIAS_RECIBIDOS}", ($rowT2), $PRINCIPAL);
    }
    return ($PRINCIPAL);
}
function colocarListaRankingAgradecimientos($PRINCIPAL, $id_empresa)
{
    $listado = DataChartAgradecimientos($id_empresa);
    //print_r($listado);
    foreach ($listado as $unico) {
        //    echo "<br>".$tipo_reco;
        $row .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_lista_rank_gracias_tabla.html");
        $row = str_replace("{CATEGORIA}", $unico->categoria, $row);
        $row = str_replace("{DESCRIPCION_CATEGORIA}", $unico->categoria_resumen, $row);
        $row = str_replace("{NUM_GRACIAS}", $unico->cuentaCat, $row);
        $row = str_replace("{PORCENTAJE}", $unico->PromCat, $row);
    }
    $PRINCIPAL = str_replace("{ROW_REC_RANKING_LISTA_GRACIAS}", utf8_encode($row), $PRINCIPAL);
    return ($PRINCIPAL);
}
function colocarListadONUTRankingAgradecimientos($PRINCIPAL, $div, $id_empresa)
{
    $listado = DataChartDonutAgradecimientos($id_empresa, $div);
    //print_r($listado);
    foreach ($listado as $unico){
            $serie.= "['".$unico->categorita."', ".$unico->Cuenta."],";
    }
    //echo  $serie;
    $row .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_chart_semidonut.html");
    $row = str_replace("{SERIE}", $serie, $row);

    $PRINCIPAL = str_replace("{CHART_DONUT_RANKING_LISTA_GRACIAS}", utf8_encode($row), $PRINCIPAL);
    return ($PRINCIPAL);
}
function colocarListadONUTRankingReco($PRINCIPAL, $div, $id_empresa)
{
    $listado = DataChartDonutReco($id_empresa, $div);
    //print_r($listado);
    foreach ($listado as $unico){
            $serie.= "['".$unico->categorita."', ".$unico->Cuenta."],";
    }
    //echo  $serie;
    $row .= file_get_contents("views/reconoce_vota/" . $id_empresa . "_chart_semidonut.html");
    $row = str_replace("{SERIE}", $serie, $row);

    $PRINCIPAL = str_replace("{CHART_DONUT_RANKING_LISTA_GRACIAS}", utf8_encode($row), $PRINCIPAL);
    return ($PRINCIPAL);
}
function colocarColaboradoresPorRutSoloClick($PRINCIPAL, $id_empresa, $rut)
{
    $listado_colaboradores = TotalUsuariosPorRutJefe($rut);
    foreach ($listado_colaboradores as $unico) {
        $array_Reco_Gracias = BuscaDatosReconocimientoAgradecimientos($unico->rut, $id_empresa);
        //print_r($array_Reco_Gracias);
        if ($array_Reco_Gracias[0]->num_gracias > 0) {
            $num_gracias = $array_Reco_Gracias[0]->num_gracias;
        } else {
            $num_gracias = 0;
        }
        if ($array_Reco_Gracias[0]->num_reconocimientos > 0) {
            $num_reconocimientos = $array_Reco_Gracias[0]->num_reconocimientos;
        } else {
            $num_reconocimientos = 0;
        }
        // print_r($unico);
        //$row.=file_get_contents("views/miperfil/row_colaboradores_miperfil.html");
        //$row.=file_get_contents("views/mi_equipo_lms/row_equipo_resumen.html");
        //echo "" . $id_empresa . "_row_equipo_resumen_soloclick.html";

        $row .= file_get_contents("views/mi_equipo_lider/" . $id_empresa . "_row_equipo_resumen_soloclick.html");
        //$row = str_replace("{MEDALLAS}",$datos_consolidados[0]->medallas,$row);
        $row                              = str_replace("{MEDALLAS}", $medallas, $row);
        $row                              = str_replace("{NOMBRE}", $unico->nombre . " " . $unico->apaterno . " " . $unico->amaterno, $row);
        $row                              = str_replace("{CARGO}", $unico->cargo, $row);
        $row                              = str_replace("{GERENCIA}", $unico->gerencia, $row);
        $row                              = str_replace("{FECHA_CUMPLEANOS}", formatearFecha($unico->fecha_nacimiento), $row);
        $row                              = str_replace("{URL_PERSONA}", VerificaFotoPersonal($unico->rut), $row);
        $row                              = str_replace("{RUT_ENCODEADO}", Encodear3($unico->rut), $row);
        $row                              = str_replace("{RUT_COL}", ($unico->rut), $row);
        $row                              = str_replace("{NUM_RECONOCIMIENTOS}", $num_reconocimientos, $row);
        $row                              = str_replace("{NUM_GRACIAS}", $num_gracias, $row);
        $row                              = str_replace("{ACCION}", ($accion), $row);
        $acumulador_visitas_colaboradores = $acumulador_visitas_colaboradores + $total_visitas[0]->total_visitas;
        $cuenta_colaborador++;
    }
    $lms_graf_acciones_verde = $sum_verde;
    $PRINCIPAL               = str_replace("{NUM_PERSONAS_MI_EQUIPO}", count($listado_colaboradores), $PRINCIPAL);
    $PRINCIPAL               = str_replace("{PROMEDIO_EQUIPO}", round($acumulador_avance_colaboradores / count($listado_colaboradores)), $PRINCIPAL);
    $PRINCIPAL               = str_replace("{NUM_VISITAS_MI_EQUIPO}", $acumulador_visitas_colaboradores, $PRINCIPAL);
    $PRINCIPAL               = str_replace("{BLOQUE_COLABORADORES}", utf8_encode($row), $PRINCIPAL);
    $PRINCIPAL               = str_replace("{LMS_GRAFICO_1COLOR}", file_get_contents("views/mi_equipo_lms/" . $id_empresa . "_barra_1color.html"), $PRINCIPAL);
    $PRINCIPAL               = str_replace("{LMS_AVANCEEQUIPO}", $lms_avance_equipo, $PRINCIPAL);
    $PRINCIPAL               = str_replace("{LMS_GRAFICO_3COLORES}", file_get_contents("views/mi_equipo_lms/" . $id_empresa . "_barra_3colores.html"), $PRINCIPAL);
    $PRINCIPAL               = str_replace("{VALUEVERDE}", $lms_graf_acciones_verde, $PRINCIPAL);
    $PRINCIPAL               = str_replace("{VALUEAMARILLO}", $lms_graf_acciones_amarillo, $PRINCIPAL);
    $PRINCIPAL               = str_replace("{VALUEROJO}", $lms_graf_acciones_rojo, $PRINCIPAL);
    $PRINCIPAL               = str_replace("{LMS_NUM_PENDIENTES}", $num_acciones_pendientes, $PRINCIPAL);
    return ($PRINCIPAL);
}

function colocarNotificacionesEncuestas($PRINCIPAL, $id_empresa, $rut, $hoy)
{
    $listado_notificacionesEncuestas = NotificacionesEncuestasPendientes($rut, $hoy, $id_empresa);
    //print_r($listado_notificacionesEncuestas);
    $cuenta_pendientes=0;
    foreach ($listado_notificacionesEncuestas as $unico) {


        if($unico->respuestas>=$unico->preguntas){
            //echo "listo";


        } else {
            //echo "pendiente";
            $cuenta_pendientes++;


        }
    }


    if($cuenta_pendientes>0){
    $AlertaNotificar="
        <div class='alert alert-warning' role='alert'>
            <strong>Encuestas Pendientes</strong>: Tienes una encuesta pendiente de realizar.
            <a href='?sw=medicion_encuestas' class='btn btn-info btn-sm'>Ingresa aqu?</a>
        </div>";

    } else {
    $AlertaNotificar="
        ";


    }

    $lms_graf_acciones_verde = $sum_verde;

    $PRINCIPAL               = str_replace("{NOTIFICACIONES_PENDIENTES}", ($AlertaNotificar), $PRINCIPAL);

    return ($PRINCIPAL);
}


function colocarNotificacionesFormacionContinua($PRINCIPAL, $id_empresa, $rut)
{

     $id_empresa=$_SESSION["id_empresa"];
    $listado_notificacionesFC = NotificacionesFormacionContinuaPendientes($rut, $id_empresa);
    //print_r($listado_notificacionesEncuestas);
    $cuenta_pendientes=0;
    foreach ($listado_notificacionesFC as $unico) {



            //echo "pendiente";
            $cuenta_pendientes++;


    }


    if($cuenta_pendientes>0){
    $AlertaNotificar="
        <div class='alert alert-warning' role='alert'>
            <strong>Validaciones Pendientes</strong>: Tienes validaciones pendientes de Formaci?n Continua.
            <a href='?sw=formacion_continua' class='btn btn-info btn-sm'>Ingresa aqu?</a>
        </div>";

    } else {
    $AlertaNotificar="
        ";


    }

    $lms_graf_acciones_verde = $sum_verde;

    $PRINCIPAL               = str_replace("{NOTIFICACIONES_PENDIENTES_FC}", ($AlertaNotificar), $PRINCIPAL);

    return ($PRINCIPAL);
}

function colocarNotificacionesTalentSkill($PRINCIPAL, $id_empresa, $rut){

 $listado_notificacionesEncuestas = NotificacionesTalentPendiente($rut, $hoy, $id_empresa);
    //print_r($listado_notificacionesEncuestas);
    if($listado_notificacionesEncuestas[0]->cuenta>0){
    $AlertaNotificar="
        <div class='alert alert-warning' role='alert'>
        <strong>?Tienes que realizar la Evaluaci?n sobre tu Cargo! </strong>.
        <center><a href='?sw=intro_eval&i=VEVhdDA4UWx6UVFnMGo0MUdqRStUQT09&ie=VU1oMEQ1VVRRZHk2SFNrcDlCRDlrUT09&ip=TlVLM3QvUyttRnNZUTc3Uk1ZbitwUT09&ae=1'
        class='btn btn-info'>Ingresa a la Evaluaci?n aqu?</a></center>
        </div>";
    } else {
    $AlertaNotificar="";
    }

    $PRINCIPAL               = str_replace("{NOTIFICACIONES_PENDIENTES_TALENT}", ($AlertaNotificar), $PRINCIPAL);
    return ($PRINCIPAL);

}

function colocarNotificacionesEncuestasImpacto($PRINCIPAL, $id_empresa, $rut, $hoy)
{
    $listado_notificacionesEncuestas = NotificacionesEncuestasPendientes($rut, $hoy, $id_empresa);
    //print_r($listado_notificacionesEncuestas);

    $cuenta_pendientes=0;
    foreach ($listado_notificacionesEncuestas as $unico) {

        if($unico->respuestas>=$unico->preguntas){
            //echo "listo";


        } else {
            //echo "pendiente";
            $cuenta_pendientes++;


        }
    }   //$cuenta_pendientes=1;

    //echo "cuenta_pendientes $cuenta_pendientes";

    if($cuenta_pendientes>0){
    $AlertaNotificar="
        <div class='alert alert-warning' role='alert'>
            <strong>Evaluaciones Pendientes</strong>: Tienes una evaluaci?n de impacto pendiente de realizar.
            <br><center><a href='?sw=medicion' class='btn btn-info'>Ingresa aqu?</a></center>
        </div>";
    //    <center><a href='?sw=medicion' class='btn btn-info btn-sm'>Ingresa aqu?</a></center>

    } else {
    $AlertaNotificar="
        ";

    }

    //echo "<br>AlertaNotificar $AlertaNotificar";

    $PRINCIPAL               = str_replace("{NOTIFICACIONES_PENDIENTES_IMPACTO}", ($AlertaNotificar), $PRINCIPAL);

    return ($PRINCIPAL);
}


function colocarMedidorAnimo($PRINCIPAL, $id_empresa, $rut, $hoy, $id_encuesta, $id_medicion)
{
    $listado_animo = NotificacionesEncuestasMedicionPorDiaPendientes($rut, $hoy, $id_empresa, $id_encuesta, $id_medicion);
    //print_r( $listado_animo);

if($listado_animo[0]->cuenta>0){
    $ColocarMedidorAnimo="";

} else {


    $ColocarMedidorAnimo="

    <div class='pull-right'>
        <form action='?sw=SaveMedicionAnimo' method='post'>
            <small><span class='negro_suave'>?Qu? tan satisfecho est?s hoy de trabajar en Banco de Chile?</span>
            <input id='input-animo' name='input-animo'   data-show-caption='false' data-show-clear='false'
            type='number'         class='rating'         data-symbol='&#xe73b;' max='5' data-stars='5'
            data-size='sm' data-glyphicon='false'
            data-rating-class='fontawesome-icon'>
            <input type='hidden' id='rut_colaborador' name='rut_colaborador' value='".$rut."'>
            <input type='hidden' id='id_encuesta' name='id_encuesta' value='".$id_encuesta."'>
            <input type='hidden' id='id_medicion' name='id_medicion' value='".$id_medicion."'>
            <input type='hidden' id='fecha' name='fecha' value='".$hoy."'>
            <input type='submit' value='Grabar' class='btn btn-info btn-sm'>
        </form>
    <br>
    </div>



    ";

}


    $PRINCIPAL               = str_replace("{MEDICION_ANIMO}", $ColocarMedidorAnimo, $PRINCIPAL);
    return ($PRINCIPAL);
}


function ColocaChartAgradecimientos($PRINCIPAL, $id_empresa)
{
    $listado_por_Agradecimientos = DataChartAgradecimientos($id_empresa);
    foreach ($listado_por_Agradecimientos as $unico) {
        $linea_data .= "{name : '" . $unico->categoria . "', y : " . $unico->PromCat . "},";
    }
    $PRINCIPAL = str_replace("{DATA_VALUES_RECONOCE_GRACIAS_CHART}", ($linea_data), $PRINCIPAL);
    return ($PRINCIPAL);

}


function colocarResultadosUsuariosFullTextCompartiriografiasoloClick($PRINCIPAL, $q, $id_empresa)
{
    $listado = BuscaUsuarioDadoFullTexto($q,$id_empresa);

    //print_r($listado);

    foreach ($listado as $unico) {
        //echo "<br><br>rut ".$unico->rut;
        $array_Reco_Gracias = BuscaDatosReconocimientoAgradecimientos($unico->rut, $id_empresa);
        //print_r($array_Reco_Gracias);
        if ($array_Reco_Gracias[0]->num_gracias > 0) {
            $num_gracias = $array_Reco_Gracias[0]->num_gracias;
        } else {
            $num_gracias = 0;
        }
        if ($array_Reco_Gracias[0]->num_reconocimientos > 0) {
            $num_reconocimientos = $array_Reco_Gracias[0]->num_reconocimientos;
        } else {
            $num_reconocimientos = 0;
        }
        //echo "<br>views/mi_equipo_lider/".$id_empresa."_row_ultimos_ingresos_soloclick.html";
        $row_ULTIMOS .= file_get_contents("views/compartir/" . $id_empresa . "_row_ultimos_ingresos_soloclick.html");
        $row_ULTIMOS = str_replace("{MEDALLAS}", $medallas, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{NOMBRE}", $unico->nombre . " " . $unico->apaterno . " " . $unico->amaterno, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{NOMBRE_CORTO}", $unico->nombre  , $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{CARGO}", $unico->cargo, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{GERENCIA}", $unico->gerencia, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{RUT}", $unico->rut, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{NUM_RECONOCIMIENTOS}", $num_reconocimientos, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{NUM_GRACIAS}", $num_gracias, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{URL_PERSONA}", utf8_decode(VerificaFotoPersonal($unico->rut)), $row_ULTIMOS);
        $cuenta_colaborador++;
    }

    $PRINCIPAL = str_replace("{BLOQUE_RESULTADOS_COMPARTIR_PERFIL}", utf8_encode($row_ULTIMOS), $PRINCIPAL);
    return ($PRINCIPAL);
}
function colocarResultadosUsuariosFullTextiografiasoloClick($PRINCIPAL, $q, $id_empresa)
{
    $listado = BuscaUsuarioDadoFullTexto($q,$id_empresa);

    //print_r($listado);

    foreach ($listado as $unico) {
        //echo "<br><br>rut ".$unico->rut;
        $array_Reco_Gracias = BuscaDatosReconocimientoAgradecimientos($unico->rut, $id_empresa);
        //print_r($array_Reco_Gracias);
        if ($array_Reco_Gracias[0]->num_gracias > 0) {
            $num_gracias = $array_Reco_Gracias[0]->num_gracias;
        } else {
            $num_gracias = 0;
        }
        if ($array_Reco_Gracias[0]->num_reconocimientos > 0) {
            $num_reconocimientos = $array_Reco_Gracias[0]->num_reconocimientos;
        } else {
            $num_reconocimientos = 0;
        }
        //echo "<br>views/mi_equipo_lider/".$id_empresa."_row_ultimos_ingresos_soloclick.html";
        $row_ULTIMOS .= file_get_contents("views/mi_equipo_lider/" . $id_empresa . "_row_ultimos_ingresos_soloclick.html");
        $row_ULTIMOS = str_replace("{MEDALLAS}", $medallas, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{NOMBRE}", $unico->nombre . " " . $unico->apaterno . " " . $unico->amaterno, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{NOMBRE_CORTO}", $unico->nombre  , $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{CARGO}", $unico->cargo, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{GERENCIA}", $unico->gerencia, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{RUT}", $unico->rut, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{NUM_RECONOCIMIENTOS}", $num_reconocimientos, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{NUM_GRACIAS}", $num_gracias, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{URL_PERSONA}", utf8_decode(VerificaFotoPersonal($unico->rut)), $row_ULTIMOS);
        $cuenta_colaborador++;
    }

    $PRINCIPAL = str_replace("{BLOQUE_ULTIMOS_BIOGRAFIA_COLABORADORES_PERFIL}", utf8_encode($row_ULTIMOS), $PRINCIPAL);
    return ($PRINCIPAL);
}

function colocarResultadosUsuariosReconocerFullTextiografiasoloClick($PRINCIPAL, $q, $id_empresa)
{
    $listado = BuscaUsuarioDadoFullTexto($q,$id_empresa);

    //print_r($listado);

    foreach ($listado as $unico) {
        //echo "<br><br>rut ".$unico->rut;
        $array_Reco_Gracias = BuscaDatosReconocimientoAgradecimientos($unico->rut, $id_empresa);
        //print_r($array_Reco_Gracias);
        if ($array_Reco_Gracias[0]->num_gracias > 0) {
            $num_gracias = $array_Reco_Gracias[0]->num_gracias;
        } else {
            $num_gracias = 0;
        }
        if ($array_Reco_Gracias[0]->num_reconocimientos > 0) {
            $num_reconocimientos = $array_Reco_Gracias[0]->num_reconocimientos;
        } else {
            $num_reconocimientos = 0;
        }
        //echo "<br>views/mi_equipo_lider/".$id_empresa."_row_ultimos_ingresos_soloclick.html";
        $row_ULTIMOS .= file_get_contents("views/mi_equipo_lider/" . $id_empresa . "_row_ultimos_ingresos_soloclick_reco.html");
        $row_ULTIMOS = str_replace("{MEDALLAS}", $medallas, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{NOMBRE}", $unico->nombre . " " . $unico->apaterno . " " . $unico->amaterno, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{CARGO}", $unico->cargo, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{GERENCIA}", $unico->gerencia, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{RUT}", $unico->rut, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{NUM_RECONOCIMIENTOS}", $num_reconocimientos, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{NUM_GRACIAS}", $num_gracias, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{URL_PERSONA}", utf8_decode(VerificaFotoPersonal($unico->rut)), $row_ULTIMOS);
        $cuenta_colaborador++;
    }
    $PRINCIPAL = str_replace("{BLOQUE_RESULTADOS_RECONOCIMIENTO_PERFIL}", utf8_encode($row_ULTIMOS), $PRINCIPAL);
    return ($PRINCIPAL);
}
function colocarResultadosUsuariosColaboracionNoEquipoFullTextiografiasoloClick($PRINCIPAL, $q, $id_empresa)
{
    $listado = BuscaUsuarioDadoFullTextoNoEquipo($q,$id_empresa);

    //print_r($listado);

    foreach ($listado as $unico) {
        //echo "<br><br>rut ".$unico->rut;
        $array_Reco_Gracias = BuscaDatosReconocimientoAgradecimientos($unico->rut, $id_empresa);
        //print_r($array_Reco_Gracias);
        if ($array_Reco_Gracias[0]->num_gracias > 0) {
            $num_gracias = $array_Reco_Gracias[0]->num_gracias;
        } else {
            $num_gracias = 0;
        }
        if ($array_Reco_Gracias[0]->num_reconocimientos > 0) {
            $num_reconocimientos = $array_Reco_Gracias[0]->num_reconocimientos;
        } else {
            $num_reconocimientos = 0;
        }
        //echo "<br>views/mi_equipo_lider/".$id_empresa."_row_ultimos_ingresos_soloclick.html";
        $row_ULTIMOS .= file_get_contents("views/mi_equipo_lider/" . $id_empresa . "_row_ultimos_ingresos_soloclick_reco_cola.html");
        $row_ULTIMOS = str_replace("{MEDALLAS}", $medallas, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{NOMBRE}", $unico->nombre . " " . $unico->apaterno . " " . $unico->amaterno, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{CARGO}", $unico->cargo, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{GERENCIA}", $unico->gerencia, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{RUT}", $unico->rut, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{NUM_RECONOCIMIENTOS}", $num_reconocimientos, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{NUM_GRACIAS}", $num_gracias, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{URL_PERSONA}", utf8_decode(VerificaFotoPersonal($unico->rut)), $row_ULTIMOS);
        $cuenta_colaborador++;
    }
    $PRINCIPAL = str_replace("{BLOQUE_RESULTADOS_RECONOCIMIENTO_PERFIL}", utf8_encode($row_ULTIMOS), $PRINCIPAL);
    return ($PRINCIPAL);
}
function colocarUltimosIngresosBiografiasoloClick($PRINCIPAL, $id_empresa)
{
    $listado = BuscaUltimosIngresosBiografiasoloClick($id_empresa);
    foreach ($listado as $unico) {
        //echo "<br><br>rut ".$unico->rut;
        $array_Reco_Gracias = BuscaDatosReconocimientoAgradecimientos($unico->rut, $id_empresa);
        //print_r($array_Reco_Gracias);
        if ($array_Reco_Gracias[0]->num_gracias > 0) {
            $num_gracias = $array_Reco_Gracias[0]->num_gracias;
        } else {
            $num_gracias = 0;
        }
        if ($array_Reco_Gracias[0]->num_reconocimientos > 0) {
            $num_reconocimientos = $array_Reco_Gracias[0]->num_reconocimientos;
        } else {
            $num_reconocimientos = 0;
        }
        //echo "<br>views/mi_equipo_lider/".$id_empresa."_row_ultimos_ingresos_soloclick.html";
        $row_ULTIMOS .= file_get_contents("views/mi_equipo_lider/" . $id_empresa . "_row_ultimos_ingresos_soloclick.html");
        $row_ULTIMOS = str_replace("{MEDALLAS}", $medallas, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{NOMBRE}", $unico->nombre . " " . $unico->apaterno . " " . $unico->amaterno, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{CARGO}", $unico->cargo, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{GERENCIA}", $unico->gerencia, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{RUT}", $unico->rut, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{NUM_RECONOCIMIENTOS}", $num_reconocimientos, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{NUM_GRACIAS}", $num_gracias, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{URL_PERSONA}", utf8_decode(VerificaFotoPersonal($unico->rut)), $row_ULTIMOS);
        $cuenta_colaborador++;
    }
    $PRINCIPAL = str_replace("{BLOQUE_ULTIMOS_BIOGRAFIA_COLABORADORES_PERFIL}", utf8_encode($row_ULTIMOS), $PRINCIPAL);
    return ($PRINCIPAL);
}

function OfertaAbierta_Dimensiones($PRINCIPAL, $id_empresa)
{
    $listado = OfertaAbiertaDimensionData($id_empresa);
    //print_r($listado);
    foreach ($listado as $unico) {

        $row_ULTIMOS .= file_get_contents("views/oferta_abierta/" . $id_empresa . "_row_dimension.html");
        $row_ULTIMOS = str_replace("{ID_DIMENSION}", $unico->id, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{DIMENSION}",      $unico->text, $row_ULTIMOS);

    }
    $PRINCIPAL = str_replace("{DIMENSIONES_OFERTA_ABIERTA_LMS_DIMENSIONES_CURSOS}", utf8_encode($row_ULTIMOS), $PRINCIPAL);
    return ($PRINCIPAL);
}

function OfertaAbierta_Cursos($PRINCIPAL, $id_empresa)
{
    $listado = OfertaAbiertaCursosDimensionData($id_empresa);
    foreach ($listado as $unico) {

        $row_ULTIMOS .= file_get_contents("views/oferta_abierta/" . $id_empresa . "_row_cursos.html");
        $row_ULTIMOS = str_replace("{ID_DIMENSION}", $unico->id_dimension, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{IMAGEN}", $unico->imagen, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{NOMBRE_CURSO}", $unico->curso, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{DIMENSION}", $unico->dimension, $row_ULTIMOS);

        $cuenta_colaborador++;
    }
    $PRINCIPAL = str_replace("{DIMENSIONES_OFERTA_ABIERTA_LMS_CURSOS}", utf8_encode($row_ULTIMOS), $PRINCIPAL);
    return ($PRINCIPAL);
}

function OfertaAbierta_Dimension_Cursos($PRINCIPAL, $rut, $id_dimension, $id_empresa)
{
    $listado = OfertaAbiertaCursosEventosDimensionData($id_dimension,$id_empresa);


foreach ($listado as $unico) {

        $EstoyInscrito=OfertaAbierta_miinscripcion($rut, $unico->codigo, $id_empresa);
        //echo  "EstoyInscrito $EstoyInscrito";

        $row_ULTIMOS .= file_get_contents("views/oferta_abierta/" . $id_empresa . "_row_cursos.html");
        $row_ULTIMOS = str_replace("{ID_DIMENSION}", $unico->id_dimension, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{IMAGEN}", $unico->imagen, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{NOMBRE_POSTULABLE}", $unico->nombre, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{DESCRIPCION_POSTULABLE}", $unico->descripcion, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{INSTRUCCION}", $unico->instruccion, $row_ULTIMOS);

        $row_ULTIMOS = str_replace("{CUPOS}", $unico->cupos, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{DISPONIBLES}", $unico->disponibles, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{FICHA_CURSO}", "", $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{FICHA}", $unico->ficha, $row_ULTIMOS);

        $row_ULTIMOS = str_replace("{DATO1}", "", $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{TXTO_FALTAN}", "", $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{MENU_SECUNDARIO}", "", $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{INSCRITOS}", $unico->inscritos, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{ICONO}", $unico->icono, $row_ULTIMOS);
               $cupos=$unico->cupos;
               $inscritos= $unico->inscritos;
        $disponibles= ($cupos-$inscritos);

        //echo "<br>disponibles $disponibles, $cupos - $inscritos";
        $row_ULTIMOS = str_replace("{CUPOS_DISPONIBLES}", $disponibles, $row_ULTIMOS);


  //BOTON inscribirme o ya estoy inscrito y desistir
            $codigo_enc=Encodear3($unico->codigo);

  if($EstoyInscrito==0){
      if($disponibles>0){
     $inscribirme="

     <br /><a href='?sw=save_inscripcion_evento_inscribete&id_postulable=" . $codigo_enc . "'
        class='btn btn-info' style='padding:10px'><span class='blanco'>Quiero Asistir</span></a><br />
          ";             } else {
      $inscribirme="<span class='badge badge-warning badge-lg'><span class='blanco'><i class='fas fa-check-circle'></i> Cupos Completos</span></span>";

          }
  }   else {

    $inscribirme="
    <span class='badge badge-success badge-lg'><span class='blanco'><i class='fas fa-check-circle'></i> Ya est&aacute;s inscrito</span></span>

    <br><br><a href='?sw=save_inscripcion_evento_inscribete_delete&id_postulable=" . $codigo_enc . "'
        class='btn btn-danger btn-sm'><span class='blanco'>desistir de Postulaci&oacute;n</span></a>
       ";

  }

        $row_ULTIMOS = str_replace("{INSCRIBIRME}", $inscribirme, $row_ULTIMOS);

        $row_ULTIMOS = str_replace("{DIMENSION}", $unico->dimension, $row_ULTIMOS);

        $cuenta_colaborador++;
    }
    $PRINCIPAL = str_replace("{DIMENSIONES_OFERTA_ABIERTA_LMS_CURSOS}", utf8_encode($row_ULTIMOS), $PRINCIPAL);
    return ($PRINCIPAL);
}


function formacion_continua_modalidad($PRINCIPAL, $id_empresa)
{
    $listado = FormacionContinua_ModalidadData($id_empresa);
    //print_r($listado);
    foreach ($listado as $unico) {

        $row_ULTIMOS .= file_get_contents("views/formacion_continua/" . $id_empresa . "_row_agrupacion.html");
        $row_ULTIMOS = str_replace("{ID_AGRUPACION}",      $unico->id_agrupacion, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{AGRUPACION}",      $unico->agrupacion, $row_ULTIMOS);

    }
    $PRINCIPAL = str_replace("{FORMACION_CONTINUA_MODALIDAD}", utf8_encode($row_ULTIMOS), $PRINCIPAL);
    return ($PRINCIPAL);
}

function formacion_continua_agrupaciones($PRINCIPAL, $id_empresa)
{
    $listado = FormacionContinua_AgrupacionData($id_empresa);
    //print_r($listado);
    foreach ($listado as $unico) {

        $row_ULTIMOS .= file_get_contents("views/formacion_continua/" . $id_empresa . "_row_agrupacion.html");
        $row_ULTIMOS = str_replace("{ID_AGRUPACION}",      $unico->id_agrupacion, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{AGRUPACION}",      $unico->agrupacion, $row_ULTIMOS);

    }
    $PRINCIPAL = str_replace("{FORMACION_CONTINUA_AGRUPACIONES}", utf8_encode($row_ULTIMOS), $PRINCIPAL);
    return ($PRINCIPAL);
}

function formacion_continua_competencias($PRINCIPAL, $id_empresa)
{
    $listado = FormacionContinua_CompetenciasData($id_empresa);
    //print_r($listado);
    foreach ($listado as $unico) {

        $row_ULTIMOS .= file_get_contents("views/formacion_continua/" . $id_empresa . "_row_competencias.html");
        $row_ULTIMOS = str_replace("{ID_COMPETENCIA}",      $unico->id_competencia, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{COMPETENCIA}",      $unico->competencia, $row_ULTIMOS);

    }
    $PRINCIPAL = str_replace("{FORMACION_CONTINUA_COMPETENCIAS}", utf8_encode($row_ULTIMOS), $PRINCIPAL);
    return ($PRINCIPAL);
}


function formacion_continua_cursos($PRINCIPAL, $id_empresa)
{

    $rut=$_SESSION["user_"];
    $array_usuario=TraeDatosBiografiayUsuario($rut, $id_empresa);
    //print_r($array_usuario);
    $esjefe=EsJefetblUsuario($rut, $id_empresa);
    if($id_empresa=="75"){
        $listado = FormacionContinua_CursosDataRUT($id_empresa, $array_usuario[0]->regional, $esjefe, $rut);

    }   else {
       $listado = FormacionContinua_CursosData($id_empresa, $array_usuario[0]->regional, $esjefe);

    }
    //print_r($listado);

    foreach ($listado as $unico) {
        //echo "<br><br>rut ".$unico->rut;

        if($unico->cuenta==0){continue;}

        $row_ULTIMOS .= file_get_contents("views/formacion_continua/" . $id_empresa . "_row_cursos.html");
        $row_ULTIMOS = str_replace("{ID_AGRUPACION1}",         $unico->id_agrupacion1, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{ID_AGRUPACION2}",         $unico->id_agrupacion2, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{ID_AGRUPACION3}",         $unico->id_agrupacion3, $row_ULTIMOS);

        $row_ULTIMOS = str_replace("{ID_COMPETENCIA1}",     $unico->id_competencia1, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{ID_COMPETENCIA2}",     $unico->id_competencia2, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{ID_COMPETENCIA3}",         $unico->id_competencia3, $row_ULTIMOS);

        $row_ULTIMOS = str_replace("{ID_MODALIDAD}", $unico->id_modalidad, $row_ULTIMOS);

        $row_ULTIMOS = str_replace("{IMAGEN}", $unico->imagen, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{NOMBRE}", $unico->dimension, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{ID_CURSO_ENCODEADO}",     Encodear3($unico->id_dimension), $row_ULTIMOS);

        $cuenta_colaborador++;
    }
    $PRINCIPAL = str_replace("{FORMACION_CONTINUA_CURSOS}", utf8_encode($row_ULTIMOS), $PRINCIPAL);
    return ($PRINCIPAL);
}

function playbook_paginas($PRINCIPAL, $id_empresa, $home){

    $array_paginas=playbook_paginas_data($id_empresa, $home);
    //print_r($array_paginas);
    foreach($array_paginas as $unico ){
            $row .= file_get_contents("views/playbook/" . $id_empresa . "_pagina_row.html");
            $row = str_replace("{ID_PAGINA}",               $unico->id_pagina, $row);
            $row = str_replace("{ID_TEMA_ENCODEADO}",       Encodear3($home), $row);
            $row = str_replace("{NOMBRE_PAGINA}",           $unico->nombre, $row);
            $url="?sw=playbook_pagina&id_p=".Encodear3($unico->id_pagina);
            $row = str_replace("{URL}",                     $url, $row);
            $row_sc="";
            $array_seccion=playbook_secciones_de_pagina_data($unico->id_pagina, $id_empresa);
                //print_r($array_seccion);
                foreach($array_seccion as $unico2 ){
                        $row_sc .= file_get_contents("views/playbook/" . $id_empresa . "_seccion_row.html");
                        $row_sc = str_replace("{ID_PAGINA}",             $unico->id_pagina, $row_sc);
                        $row_sc = str_replace("{NOMBRE_SECCION}",        $unico2->nombre, $row_sc);
                        $row_sc = str_replace("{CONTENIDO_SECCION}",     $unico2->contenido, $row_sc);
                        $url_SC="?sw=playbook_pagina&id_p=".Encodear3($unico->id_pagina)."#".$unico2->id_seccion;
                        $row_sc = str_replace("{URL_SECCION}",                   $url_SC, $row_sc);

                }
             $row = str_replace("{LINK_SECCION}",                     $row_sc, $row);
    }
    $PRINCIPAL = str_replace("{HOME_LISTA_PAGINAS}", utf8_encode($row), $PRINCIPAL);
    return ($PRINCIPAL);

}

function playbook_temas($PRINCIPAL, $id_empresa, $home){

    $array_temas=playbook_temas_data($id_empresa, $home);
    //print_r($array_temas);
    foreach($array_temas as $unico ){
            $row .= file_get_contents("views/playbook/" . $id_empresa . "_row_temas.html");
            $row = str_replace("{ID_TEMA}",               Encodear3($unico->id_home), $row);
            $row = str_replace("{NOMBRE_TEMA}",           $unico->nombre, $row);
            $row = str_replace("{URL}",                   $url, $row);


            //$array_seccion=playbook_secciones_de_pagina_data($unico->id_pagina, $id_empresa);

    }
    $PRINCIPAL = str_replace("{HOME_LISTA_TEMAS}", utf8_encode($row), $PRINCIPAL);
    return ($PRINCIPAL);
}

function PlayBook_busca_Menu_Pagina($PRINCIPAL, $id_empresa,$id_home){

    $array_paginas=playbook_pagina_menu_data($id_pagina, $id_empresa,$id_home);
    //print_r($array_paginas);
    foreach($array_paginas as $unico ){
            $row_sc .= file_get_contents("views/playbook/" . $id_empresa . "_row_home.html");


            $row_sc = str_replace("{URL}",               "?sw=playbook_pagina&id_p=".Encodear3($unico->id_pagina)."", $row_sc);
            $row_sc = str_replace("{TITULO}",           $unico->nombre, $row_sc);
            $row_sc = str_replace("{DESCRIPCION}",      $unico->descripcion, $row_sc);
            $row_sc = str_replace("{ID_TEMA_ENCODEADO}",    Encodear3($id_home), $row_sc);
            $row_sc = str_replace("{ID_PAGINA_ENCODEADO}",  Encodear3($unico->id_pagina), $row_sc);
            $row_sc = str_replace("{TITULO}",           $unico->nombre, $row_sc);

    }
    $PRINCIPAL = str_replace("{LISTA_PAGINAS_BOTONES_MENU}", utf8_encode($row_sc), $PRINCIPAL);
    return ($PRINCIPAL);

}

function PlayBook_busca_Pagina($PRINCIPAL, $id_pagina, $id_empresa){

    $array_seccion=playbook_secciones_de_pagina_data($id_pagina, $id_empresa);
    //print_r($array_seccion);
    foreach($array_seccion as $unico ){
            $row_sc .= file_get_contents("views/playbook/" . $id_empresa . "_seccion.html");

             if($unico->imagen<>''){
                $row_sc = str_replace("{IMAGEN_SECCION}",               "<img src='multimedia/".$unico->imagen."' width='350px'>", $row_sc);
             } else {
                $row_sc = str_replace("{IMAGEN_SECCION}",               "", $row_sc);
             }
            $row_sc = str_replace("{ID_PAGINA}",                            $unico->id_pagina, $row_sc);
            $row_sc = str_replace("{ID_PAGINA_ENCODEADO}",                  Encodear3($unico->id_pagina), $row_sc);
            $row_sc = str_replace("{ID_SECCION}",                           $unico->id_seccion, $row_sc);
            $row_sc = str_replace("{ID_SECCION_ENCODEADO}",                 Encodear3($unico->id_seccion), $row_sc);
            $row_sc = str_replace("{NOMBRE_SECCION}",                       $unico->nombre, $row_sc);
            $row_sc = str_replace("{CONTENIDO_SECCION}",                    $unico->contenido, $row_sc);
            $url="?sw=playbook_pagina&id_p=".Encodear3($unico->id_pagina);
            $row_sc = str_replace("{URL}",                     $url, $row_sc);

    }
    $PRINCIPAL = str_replace("{HOME_LISTA_SECCIONES}", utf8_encode($row_sc), $PRINCIPAL);
    return ($PRINCIPAL);

}

function PlayBook_busca_Menu_SubPagina($PRINCIPAL, $id_pagina, $id_empresa){

    $array_subpaginas=playbook_paginas_de_pagina_data($id_pagina, $id_empresa);
    //print_r($array_seccion);
    foreach($array_subpaginas as $unico ){
            $row_sc .= file_get_contents("views/playbook/" . $id_empresa . "_row_menu_subpagina.html");
            $row_sc = str_replace("{ID_PAGINA}",                    $unico->id_home, $row_sc);
            $row_sc = str_replace("{ID_SUBPAGINA}",                 $unico->id_pagina, $row_sc);
            $row_sc = str_replace("{NOMBRE_PAGINA}",                $unico->nombre, $row_sc);
            $url="?sw=playbook_pagina_sub&id_p=".Encodear3($unico->id_home)."&id_subp=".Encodear3($unico->id_pagina);
            $row_sc = str_replace("{URL}",                          $url, $row_sc);
    }
    $PRINCIPAL = str_replace("{URL_SUBPAGINA_MENU}", utf8_encode($row_sc), $PRINCIPAL);
    return ($PRINCIPAL);

}

function PlayBook_busca_Menu_Seccion($PRINCIPAL, $id_pagina, $id_empresa){

    $array_menusecciones=playbook_menu_secciones_de_pagina_data($id_pagina, $id_empresa);
    //print_r($array_menusecciones);
    foreach($array_menusecciones as $unico ){
            $row_sc .= file_get_contents("views/playbook/" . $id_empresa . "_row_menu_secciones.html");
            $row_sc = str_replace("{ID_PAGINA}",                    $unico->id_pagina, $row_sc);
            $row_sc = str_replace("{NOMBRE_PAGINA}",                $unico->nombre, $row_sc);
            //$url="?sw=playbook_pagina_sub&id_p=".Encodear3($unico->id_home)."&id_subp=".Encodear3($unico->id_pagina);
            $url="?sw=playbook_pagina&id_p=".Encodear3($unico->id_pagina)."#".$unico->id_seccion;
            $row_sc = str_replace("{URL}",                          $url, $row_sc);
    }
    $PRINCIPAL = str_replace("{URL_SUBPAGINA_SECCIONES}", utf8_encode($row_sc), $PRINCIPAL);
    return ($PRINCIPAL);

}

function SkillMuestraTxt($id_curso, $id_empresa){

   //echo "<br>$id_curso, $id_empresa";

    $array_curso    =Skill_Info_id_Curso($id_curso, $id_empresa);
    //print_r($array_curso);

    $plataforma =$array_curso[0]->plataforma;
    $url        =$array_curso[0]->url;
    $proveedor  =$array_curso[0]->proveedor;
    $curso          =utf8_encode($array_curso[0]->curso);

    $array_mensaje  =SkillBuscaMensaje($plataforma, $url, $id_empresa);

    //print_r($array_mensaje);
    if($url<>'PROXIMAMENTE'){
        $mensaje=utf8_encode($array_mensaje[0]->mensaje);
    } else {
        $mensaje=utf8_encode($array_mensaje[0]->mensaje_proximamente);
        $url="";
    }
        $textoboton=utf8_encode($array_mensaje[0]->textoboton);
    //echo "<br>$plataforma, $url, $proveedor, mensaje $mensaje, textoboton $textoboton";//exit();
    $arreglo[0]=$curso;
    $arreglo[1]=$plataforma;
    $arreglo[2]=$url;
    $arreglo[3]=$proveedor;
    $arreglo[4]=$mensaje;
    $arreglo[5]=$textoboton;

    return ($arreglo);
}

function formacion_continua_cursos_skills($PRINCIPAL, $rut, $parametro,$id_empresa)
{

    $rut=$_SESSION["user_"];
    $array_usuario=TraeDatosBiografiayUsuario($rut, $id_empresa);
    $esjefe=EsJefetblUsuario($rut, $id_empresa);
    $array_skill=Ass_Busca_Equipo_con_RutCol_Cargo_skill($rut, $id_empresa);

   // print_r($array_skill);
    //echo "<br>";
    $listado = FormacionContinua_Cursos_SkillsData($id_empresa, $rut, $parametro, $array_skill[0]->id_cargo);

    //print_r($listado);

if($parametro=="full"){
         $row_ULTIMOS .= file_get_contents("views/formacion_continua/" . $id_empresa . "_row_cursos_skill.html");

     foreach ($listado as $unico) {
            // echo "<br>hola".$unico->PROYECTO;
      if($unico->proveedor=="PROYECTO"){
               //echo "<br>A<br>";
            $row_ULTIMOS2.= file_get_contents("views/formacion_continua/" . $id_empresa . "_row_lista_cursos_skill_proyecto_".$unico->nom_nivel_skill.".html");
            //echo "views/formacion_continua/" . $id_empresa . "_row_lista_cursos_skill_proyecto_".$unico->nom_nivel_skill.".html";
                                         } else {  // echo "<br>B<br>";
            $row_ULTIMOS2.= file_get_contents("views/formacion_continua/" . $id_empresa . "_row_lista_cursos_skill.html");
                                         }
            //$row_ULTIMOS2.= file_get_contents("views/formacion_continua/" . $id_empresa . "_row_lista_cursos_skill.html");

            $url_texto="Ir al Curso";
            $url_texto2="Ver Info del Curso";
            $estado_url_texto="primary";
            $url="?sw=formacion_continua_skills&idus=".Encodear3($unico->id_curso);
            $url2="".$unico->Id_Skill_url."";
            $row_ULTIMOS2 = str_replace("{ICONO}",          "<i class='fas fa-chevron-circle-right'></i>", $row_ULTIMOS2);
            $row_ULTIMOS2 = str_replace("{NOMBRE_CURSO}",   ($unico->curso), $row_ULTIMOS2);
            $row_ULTIMOS2 = str_replace("{DESCRIPCION}",    ($unico->descripcion_curso), $row_ULTIMOS2);
            $row_ULTIMOS2 = str_replace("{PLATAFORMA}",     ($unico->plataforma), $row_ULTIMOS2);
            $row_ULTIMOS2 = str_replace("{LINK}",           ($url), $row_ULTIMOS2);
            $row_ULTIMOS2 = str_replace("{LINK_TEXT}",           ($url_texto), $row_ULTIMOS2);
            $row_ULTIMOS2 = str_replace("{ESTADO_TEXT}",           ($estado_url_texto), $row_ULTIMOS2);
            $row_ULTIMOS2 = str_replace("{ID_SKILL}", ($unico->id_skill), $row_ULTIMOS2);

            $row_ULTIMOS2 = str_replace("{LINK2}",           ($url2), $row_ULTIMOS2);
            $row_ULTIMOS2 = str_replace("{LINK_TEXT2}",           ($url_texto2), $row_ULTIMOS2);
            $row_ULTIMOS2 = str_replace("{ESTADO_TEXT2}",           ("primary"), $row_ULTIMOS2);


            //echo "<br>".$row_ULTIMOS2;
            //exit() ;
            $row_ULTIMOS2 = str_replace("{CURSO_INSCRITO}",     "", $row_ULTIMOS2);
            $row_ULTIMOS2 = str_replace("{CONVALIDADO_EXIMIDA}","", $row_ULTIMOS2);


     }
    $row_ULTIMOS = str_replace("{LISTA_CURSOS_SKILLS_PERSONAL}",     $row_ULTIMOS2, $row_ULTIMOS);


}   else {


    foreach ($listado as $unico) {
        //echo "<br>hola";
        //echo "<br>hola".$unico->proyecto;
        $row_ULTIMOS .= file_get_contents("views/formacion_continua/" . $id_empresa . "_row_cursos_skill.html");



        $row_ULTIMOS = str_replace("{IMAGEN}", "img/iddim_01.jpg", $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{NOMBRE}", ($unico->Skill), $row_ULTIMOS);
        //$row_ULTIMOS = str_replace("{ID_SKILL}", ($unico->Id_Skill), $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{ID_CURSO_ENCODEADO}",     Encodear3($unico->id_dimension), $row_ULTIMOS);
        if($unico->opcion_por_desarrollar=="Skill Eximida" or $unico->opcion_por_desarrollar=="Skill Convalidada"){
            $row_ULTIMOS = str_replace("{CONVALIDADO_EXIMIDA}",     "<span class='badge badge-success'><span class='blanco'>".$unico->opcion_por_desarrollar."</span></span>", $row_ULTIMOS);
        } else {
            $row_ULTIMOS = str_replace("{CONVALIDADO_EXIMIDA}",     "", $row_ULTIMOS);
        }

        // busca cursos especificos
        $lista_cursos= FormacionContinua_Cursos_Por_SkillsData($id_empresa, $rut, $array_skill[0]->id_cargo, $unico->id_skill, $unico->nivel );
        //print_r($lista_cursos);
        $row_ULTIMOS2="";
        foreach ($lista_cursos as $unico2){
            //PRINT_R($unico2);

            //echo "<br>".$unico2->inscripcion;
        //echo "<br>hola ".$unico2->proveedor;
        if($unico2->proveedor=="PROYECTO"){        //echo "<br>A<br>";
            $row_ULTIMOS2.= file_get_contents("views/formacion_continua/" . $id_empresa . "_row_lista_cursos_skill_proyecto_".$unico2->nom_nivel_skill.".html");
            //echo "views/formacion_continua/" . $id_empresa . "_row_lista_cursos_skill_proyecto_".$unico2->nom_nivel_skill.".html";
                                         } else {  // echo "<br>B<br>";
            $row_ULTIMOS2.= file_get_contents("views/formacion_continua/" . $id_empresa . "_row_lista_cursos_skill.html");
                                         }

            if($unico2->idinscripcion>0){
                $url_texto="Ir al Curso";
                $estado_url_texto="primary";
            }
            else {
                $url_texto="Ir al Curso";
                $estado_url_texto="primary";
            }
                        $url_texto2="Ver Info del Curso";
                                    $url2="".$unico->Id_Skill_url."";

            //echo "$url_texto $estado_url_texto";
            $url="?sw=formacion_continua_skills&idus=".Encodear3($unico2->id_curso);
            $row_ULTIMOS2 = str_replace("{ICONO}",          "<i class='fas fa-chevron-circle-right'></i>", $row_ULTIMOS2);
            $row_ULTIMOS2 = str_replace("{NOMBRE_CURSO}",   ($unico2->curso), $row_ULTIMOS2);
            $row_ULTIMOS2 = str_replace("{DESCRIPCION}",    ($unico2->descripcion_curso), $row_ULTIMOS2);
            $row_ULTIMOS2 = str_replace("{PLATAFORMA}",     ($unico2->plataforma), $row_ULTIMOS2);
            $row_ULTIMOS2 = str_replace("{LINK}",           ($url), $row_ULTIMOS2);
            $row_ULTIMOS2 = str_replace("{LINK_TEXT}",           ($url_texto), $row_ULTIMOS2);
            $row_ULTIMOS2 = str_replace("{ESTADO_TEXT}",           ($estado_url_texto), $row_ULTIMOS2);
            $row_ULTIMOS2 = str_replace("{ID_SKILL}", ($unico->Id_Skill), $row_ULTIMOS2);
            $row_ULTIMOS2 = str_replace("{LINK2}",           ($url2), $row_ULTIMOS2);
            $row_ULTIMOS2 = str_replace("{LINK_TEXT2}",           ($url_texto2), $row_ULTIMOS2);
            $row_ULTIMOS2 = str_replace("{ESTADO_TEXT2}",           ("primary"), $row_ULTIMOS2);

        if($unico->opcion_por_desarrollar=="Skill Eximida" or $unico->opcion_por_desarrollar=="Skill Convalidada"){
            $row_ULTIMOS2 = str_replace("{CONVALIDADO_EXIMIDA}",     "<span class='badge badge-success'><span class='blanco'>".$unico->opcion_por_desarrollar."</span></span>", $row_ULTIMOS2);
        } else {
            $row_ULTIMOS2 = str_replace("{CONVALIDADO_EXIMIDA}",     "", $row_ULTIMOS2);
        }

        if($unico2->idinscripcion>0){
            $row_ULTIMOS2 = str_replace("{CURSO_INSCRITO}",     "<span class='badge badge-warning'><span class='blanco'>Curso Inscrito</span></span>", $row_ULTIMOS2);
        } else {
            $row_ULTIMOS2 = str_replace("{CURSO_INSCRITO}",     "", $row_ULTIMOS2);
        }


        }
        //exit();
        $row_ULTIMOS = str_replace("{LISTA_CURSOS_SKILLS_PERSONAL}",     $row_ULTIMOS2, $row_ULTIMOS);

        $cuenta_colaborador++;
    }

}

    $PRINCIPAL = str_replace("{FORMACION_CONTINUA_CURSOS_SKILL}", utf8_encode($row_ULTIMOS), $PRINCIPAL);
    return ($PRINCIPAL);
}

function formacion_continua_lista_eventos($PRINCIPAL,$idc, $id_empresa){


    $hoy=date("Y-m-d");

    $listado = FormacionContinua_EventosCursosData($idc,$id_empresa);
   // print_r($listado);
    foreach ($listado as $unico) {

    $date1 = new DateTime($hoy);         $date2 = new DateTime($unico->fecha);    $diff = $date1->diff($date2);
    if($diff->days<20 and $unico->fecha<>''){
       // ActualizaFCInvisibleItem($unico->id_postulable,$id_empresa);
       //         continue;
    }

    $dias_quedan=  $diff->days-20;     $txt_quedan="";
    if($dias_quedan<=20 and $unico->fecha<>''){      $txt_quedan="<span class='badge badge-warning'><i class='fas fa-exclamation-circle'></i>".$dias_quedan." d?as para postular </span>";}


//        $fecha=  $unico->fecha;
//          $interval = $fecha->diff($hoy);
//echo $interval->format('%R%a d?as');


        $row_ULTIMOS .= file_get_contents("views/formacion_continua/" . $id_empresa . "_row_lista_eventos_cursos.html");
        $row_ULTIMOS = str_replace("{DATO1}",                     $unico->dato1, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{DATO2}",               $unico->dato2, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{IMAGEN}",          $unico->imagen, $row_ULTIMOS);

        $row_ULTIMOS = str_replace("{DESCRIPCION_POSTULABLE}",     $unico->descripcion, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{DATO3}",                     $unico->dato3, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{NOMBRE_POSTULABLE}",         $unico->nombre, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{MODALIDAD}",                 $unico->modalidad, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{ID_EVENTO_ENCODEADO}",     Encodear3($unico->id_postulable), $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{ID_CURSO_ENCODEADO}",         Encodear3($unico->id_dimension), $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{FICHA_CURSO}",                     ($unico->ficha), $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{TXTO_FALTAN}",                     ($txt_quedan), $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{NUM_INSCRITOS}",                     $unico->inscritos, $row_ULTIMOS);
        $row_ULTIMOS = str_replace("{NUM_INSCRITOS_REAL}",                     $unico->inscritosreal, $row_ULTIMOS);

        $cuenta_colaborador++;
    }

    $listado = FormacionContinua_EventosCursosDataModalidad($idc,"Presencial",$id_empresa);
    $cuenta_colaborador_presencial=0;
    foreach ($listado as $unico) {
                  //print_r($unico);
    //Busca si tiene Regoion
   // echo "cuenta inscrito ".$unico->inscritos;

    //echo "<br> Region ".$unico->region." - Usuario ".$datos_usuario[0]->region;
    //Busca si tiene jefe

    $date1 = new DateTime($hoy);         $date2 = new DateTime($unico->fecha);    $diff = $date1->diff($date2);
    if($diff->days<20 and $unico->fecha<>''){
        //ActualizaFCInvisibleItem($unico->id_postulable,$id_empresa);
        //continue;
    }

    $dias_quedan=  $diff->days-20;     $txt_quedan="";

   // echo "dias $dias_quedan"; echo "fecha ".$unico->fecha;
    if($dias_quedan<=20 and $unico->fecha<>'' and $dias_quedan>=0){
        $txt_quedan="<br><span class='badge badge-warning'><span class='blanco'><i class='fas fa-exclamation-circle'></i>
        Restan ".$dias_quedan." d&iacute;as para postular</span> </span>";}
          //echo "txt_quedan $txt_quedan";

    if($unico->region <>''){
        $rut=$_SESSION["user_"];
        $id_empresa=$_SESSION["id_empresa"];
        $datos_usuario=TraeDatosBiografiayUsuario($rut, $id_empresa);
        //echo "<br> Region ".$unico->regional." - Usuario ".$datos_usuario[0]->region;
        if($datos_usuario[0]->regional <> $unico->region){
            continue;
        }

    }

    if($unico->jefatura <>''){
        $rut=$_SESSION["user_"];
        $id_empresa=$_SESSION["id_empresa"];
        $esjefe=rutesjefe($rut, $id_empresa);

        if($esjefe[0]->cuenta==0){
            continue;
        }

    }  //echo  $unico->invisible;
    if($unico->invisible<>1 or $unico->invisible==""){
                $row_ULTIMOS_PRES .= file_get_contents("views/formacion_continua/" . $id_empresa . "_row_lista_eventos_cursos.html");

    }   else {
                $row_ULTIMOS_PRES .= file_get_contents("views/formacion_continua/" . $id_empresa . "_row_lista_eventos_cursos_solo_vista.html");

    }
        //$row_ULTIMOS_PRES .= file_get_contents("views/formacion_continua/" . $id_empresa . "_row_lista_eventos_cursos.html");
        $row_ULTIMOS_PRES = str_replace("{DATO1}",                     $unico->dato1, $row_ULTIMOS_PRES);
        $row_ULTIMOS_PRES = str_replace("{DESCRIPCION_POSTULABLE}",     $unico->descripcion, $row_ULTIMOS_PRES);
        $row_ULTIMOS_PRES = str_replace("{DATO3}",                     $unico->dato3, $row_ULTIMOS_PRES);
       $row_ULTIMOS_PRES = str_replace("{DATO2}",               $unico->dato2, $row_ULTIMOS_PRES);
        $row_ULTIMOS_PRES = str_replace("{IMAGEN}",          $unico->imagen, $row_ULTIMOS_PRES);        $row_ULTIMOS_PRES = str_replace("{NUM_INSCRITOS}",                     $unico->inscritos, $row_ULTIMOS_PRES);
        $row_ULTIMOS_PRES = str_replace("{NOMBRE_POSTULABLE}",         $unico->nombre, $row_ULTIMOS_PRES);
        $row_ULTIMOS_PRES = str_replace("{MODALIDAD}",                 $unico->modalidad, $row_ULTIMOS_PRES);
        $row_ULTIMOS_PRES = str_replace("{ID_EVENTO_ENCODEADO}",     Encodear3($unico->id_postulable), $row_ULTIMOS_PRES);
        $row_ULTIMOS_PRES = str_replace("{ID_CURSO_ENCODEADO}",         Encodear3($unico->id_dimension), $row_ULTIMOS_PRES);

if($unico->ficha<>''){$ficha="<a href='docs/".$unico->ficha."' target='_blank' class='btn btn-primary'>Descargar Ficha Curso</a>";
} else {$ficha="";}

        $row_ULTIMOS_PRES = str_replace("{FICHA_CURSO}",                     ($ficha), $row_ULTIMOS_PRES);
        $row_ULTIMOS_PRES = str_replace("{TXTO_FALTAN}",                     ($txt_quedan), $row_ULTIMOS_PRES);
        $row_ULTIMOS_PRES = str_replace("{NUM_INSCRITOS_REAL}",                     ($unico->inscritosreal), $row_ULTIMOS_PRES);

        $cuenta_colaborador_presencial++;
    }
    $listado = FormacionContinua_EventosCursosDataModalidad($idc,"Elearning",$id_empresa);

//print_r($listado);
$cuenta_colaborador_elearning=0;
    foreach ($listado as $unico) {

    $date1 = new DateTime($hoy);         $date2 = new DateTime($unico->fecha);    $diff = $date1->diff($date2);
    if($diff->days<20 and $unico->fecha<>''){
        //ActualizaFCInvisibleItem($unico->id_postulable,$id_empresa);
        //continue;
    }

    $dias_quedan=  $diff->days-20;     $txt_quedan="";

   // echo "dias $dias_quedan"; echo "fecha ".$unico->fecha;
    if($dias_quedan<=20 and $unico->fecha<>''  and $dias_quedan>=0){
        $txt_quedan="<br><span class='badge badge-warning'><span class='blanco'><i class='fas fa-exclamation-circle'></i>
        Restan ".$dias_quedan." d&iacute;as para postular</span> </span>";}
if($unico->invisible<>1 or $unico->invisible==""){
         //echo "/";
         //echo $unico->link;
        if($unico->link=="SI"){
        $row_ULTIMOS_ELEA .= file_get_contents("views/formacion_continua/" . $id_empresa . "_row_lista_eventos_cursos_autoinscripcion.html");

        }   else {
                $row_ULTIMOS_ELEA .= file_get_contents("views/formacion_continua/" . $id_empresa . "_row_lista_eventos_cursos.html");

       // echo ",";
       }

    }   else {
                $row_ULTIMOS_ELEA .= file_get_contents("views/formacion_continua/" . $id_empresa . "_row_lista_eventos_cursos_solo_vista.html");
          //echo ".";
    }
        $row_ULTIMOS_ELEA = str_replace("{DATO1}",                      $unico->dato1, $row_ULTIMOS_ELEA);
        $row_ULTIMOS_ELEA = str_replace("{DESCRIPCION_POSTULABLE}",     $unico->descripcion, $row_ULTIMOS_ELEA);
        $row_ULTIMOS_ELEA = str_replace("{DATO3}",                      $unico->dato3, $row_ULTIMOS_ELEA);
       $row_ULTIMOS_ELEA = str_replace("{DATO2}",                       $unico->dato2, $row_ULTIMOS_ELEA);
        $row_ULTIMOS_ELEA = str_replace("{IMAGEN}",                     $unico->imagen, $row_ULTIMOS_ELEA);        $row_ULTIMOS_ELEA = str_replace("{NUM_INSCRITOS}",                     $unico->inscritos, $row_ULTIMOS_ELEA);
        $row_ULTIMOS_ELEA = str_replace("{NOMBRE_POSTULABLE}",          $unico->nombre, $row_ULTIMOS_ELEA);
        $row_ULTIMOS_ELEA = str_replace("{MODALIDAD}",                  $unico->modalidad, $row_ULTIMOS_ELEA);
        $row_ULTIMOS_ELEA = str_replace("{ID_EVENTO_ENCODEADO}",        Encodear3($unico->id_postulable), $row_ULTIMOS_ELEA);
        $row_ULTIMOS_ELEA = str_replace("{ID_CURSO_ENCODEADO}",         Encodear3($unico->id_dimension), $row_ULTIMOS_ELEA);
        $row_ULTIMOS_ELEA = str_replace("{LINK_POSTULABLE}",            utf8_encode($unico->link), $row_ULTIMOS_ELEA);
         $row_ULTIMOS_ELEA = str_replace("{NUM_INSCRITOS_REAL}",                     ($unico->inscritosreal), $row_ULTIMOS_ELEA);

if($unico->ficha<>''){$ficha="<a href='docs/".$unico->ficha."' target='_blank' class='btn btn-primary btn-sm'>Descargar Ficha Curso</a>";
} else {$ficha="";}

        $row_ULTIMOS_ELEA = str_replace("{FICHA_CURSO}",                     ($ficha), $row_ULTIMOS_ELEA);
        $row_ULTIMOS_ELEA = str_replace("{TXTO_FALTAN}",                     ($txt_quedan), $row_ULTIMOS_ELEA);
        $cuenta_colaborador_elearning++;
    }

        if($cuenta_colaborador_presencial==0){
$Despliegue_presencial=utf8_decode("<center><br><br><span class='badge badge-pill badge-light'>Este curso s?lo se dicta en modalidad Elearning</span></center>");

        } else {
            $Despliegue_presencial=$row_ULTIMOS_PRES;
        }

        if($cuenta_colaborador_elearning==0){
$Despliegue_elearning=utf8_decode("<center><br><br><span class='badge badge-pill badge-light'>Este curso s?lo se dicta en modalidad Presencial</span></center>");
        } else {
            $Despliegue_elearning=$row_ULTIMOS_ELEA;
        }



    if($cuenta_colaborador_elearning==0 and $cuenta_colaborador_presencial==0){
    $Despliegue_elearning=utf8_decode("<center><br><br><span class='badge badge-pill badge-light'>No existen actividades para este curso.</span></center>");
    $Despliegue_presencial=utf8_decode("<center><br><br><span class='badge badge-pill badge-light'>No existen actividades para este curso.</span></center>");

    }

    $PRINCIPAL = str_replace("{NOMBRE_CURSO}", utf8_encode($unico->dimension), $PRINCIPAL);
    $PRINCIPAL = str_replace("{DESCRIPCION_CURSO}", utf8_encode($unico->descripcion), $PRINCIPAL);
    $PRINCIPAL = str_replace("{IMAGEN_CURSO}", utf8_encode($unico->imagen), $PRINCIPAL);
    $PRINCIPAL = str_replace("{LINK_CURSO}", utf8_encode($unico->link), $PRINCIPAL);

    $PRINCIPAL = str_replace("{FORMACION_CONTINUA_LISTA_EVENTOS_CURSOS}", utf8_encode($row_ULTIMOS), $PRINCIPAL);
    $PRINCIPAL = str_replace("{FORMACION_CONTINUA_LISTA_EVENTOS_CURSOS_PRESENCIAL}", utf8_encode($Despliegue_presencial), $PRINCIPAL);
    $PRINCIPAL = str_replace("{FORMACION_CONTINUA_LISTA_EVENTOS_CURSOS_ELEARNING}", utf8_encode($Despliegue_elearning), $PRINCIPAL);

    return ($PRINCIPAL);

}


function colocarColaboradoresPorRutConDatos_lms($PRINCIPAL, $id_empresa, $rut)
{

//echo "id empresa $id_empresa, $rut";
    $listado_colaboradores = TotalUsuariosPorRutJefe($rut);
    foreach ($listado_colaboradores as $unico) {
       // print_r($unico);
        //$row.=file_get_contents("views/miperfil/row_colaboradores_miperfil.html");
        //$row.=file_get_contents("views/mi_equipo_lms/row_equipo_resumen.html");
        $row .= file_get_contents("views/mi_equipo_lms/" . $id_empresa . "_row_equipo_resumen.html");
        $datos_mallapersona = buscamalla($unico->rut, $id_empresa);
        $datos_mallapersona[0]->id_malla;
        $datos_malla        = DatosMalla($datos_mallapersona[0]->id_malla);
        //print_r($datos_malla);
        $datos_consolidados = TienePuntosConsolidadosPorMalla($unico->rut, $id_empresa, $datos_mallapersona[0]->id_malla);
        $row                = str_replace("{PUNTOS}", $datos_consolidados[0]->puntos, $row);
        $promedio_trivias   = PromedioTrivias($unico->rut, $id_empresa);
        if (!$promedio_trivias[0]->promedio_trivias) {
            $row = str_replace("{PROMEDIO}", "0", $row);
        } else {
            $row = str_replace("{PROMEDIO}", round($promedio_trivias[0]->promedio_trivias), $row);
        }
        if ($promedio_trivias[0]->promedio_trivias > 0) {
            $row = str_replace("{PODERES}", "<img src='img/61_rf_badges_5.png' width='20'>", $row);
        } else {
            $row = str_replace("{PODERES}", "", $row);
        }
        $medallas = "";
        for ($k = 1; $k <= $datos_consolidados[0]->medallas; $k++) {
            $medallas .= "<img src='img/rf_medal.png'>";
        }
        //$row = str_replace("{MEDALLAS}",$datos_consolidados[0]->medallas,$row);
        $row = str_replace("{MEDALLAS}", $medallas, $row);
        $row = str_replace("{NOMBRE}", $unico->nombre . " " . $unico->apaterno . " " . $unico->amaterno, $row);
        $row = str_replace("{CARGO}", $unico->cargo, $row);
        $row = str_replace("{GERENCIA}", $unico->gerencia, $row);
        $row = str_replace("{FECHA_CUMPLEANOS}", formatearFecha($unico->fecha_nacimiento), $row);
        $row = str_replace("{URL_PERSONA}", VerificaFotoPersonal($unico->rut), $row);
        $row = str_replace("{RUT_ENCODEADO}", Encodear3($unico->rut), $row);
        $row = str_replace("{RUT_COL}", ($unico->rut), $row);
        $row = str_replace("{MALLA}", ($datos_malla[0]->nombre), $row);
        list($total_inscripciones, $total_aprobados, $total_reprobados, $total_en_proceso) = CAPACITACION_DatosGeneralesPorUsuario($unico->rut);
        $estado                  = EntregaEstadoAvanceBarraMalla(EntregaPorcentaje($total_inscripciones, $total_aprobados));
        $listado_colaborador_sub = TotalUsuariosPorRutJefe($unico->rut);
        $num_reportes_sub        = count($listado_colaborador_sub);
        if ($num_reportes_sub > 0) {
            $num_reportes_template = "<br>
            <a href='?sw=mi_equipo_lms&rutenc=" . Encodear3($unico->rut) . "'
            class='btn btn-lg btn-flat border-white
            text-white text-uppercase text-size-small text-semibold content-group'>
            Equipo ($num_reportes_sub)</a>";
            $row                   = str_replace("{SUBREPORTES}", $num_reportes_template, $row);
        } else {
            $row = str_replace("{SUBREPORTES}", "", $row);
        }
        $accion                           = Lms_Busca_Acciones_Pendientes($rut, $unico->rut, $id_empresa);
        $row                              = str_replace("{ACCION}", ($accion), $row);
        $row                              = str_replace("{COMPROMISO}", ColocaBotonCompromisosPorcolaborador($id_empresa), $row);
        $row                              = str_replace("{TRIVIAS}", ("Trivia"), $row);
        $avance                           = round(EntregaPorcentaje($total_inscripciones, $total_aprobados));
        //    echo "<br>$avance";
        $acumulador_avance_colaboradores  = $acumulador_avance_colaboradores + EntregaPorcentaje($total_inscripciones, $total_aprobados);
        $PRINCIPAL                        = str_replace("{NUMERO_AVANCE}", round(EntregaPorcentaje($total_inscripciones, $total_aprobados)), $PRINCIPAL);
        $PRINCIPAL                        = str_replace("{COLOR_PROGRESS_BAR}", $estado[0], $PRINCIPAL);
        $row                              = str_replace("{AVANCE_COLABORADOR}", EntregaPorcentaje($total_inscripciones, $total_aprobados), $row);
        //$total_visitas=TotalVisitasDadoRutCaseEmpresaFront($unico->rut, $id_empresa, "home_minvest");
        $row                              = str_replace("{NUM_VISITAS_COLABORADOR}", $total_visitas[0]->total_visitas, $row);
        $acumulador_visitas_colaboradores = $acumulador_visitas_colaboradores + $total_visitas[0]->total_visitas;
        $cuenta_colaborador++;
    }
    $accionesPendiente          = Lms_Cuenta_Acciones_Pendientes_data($rut, $id_empresa);
    $num_acciones_pendientes    = $accionesPendiente[0]->cuenta;
    $num_acciones_realizadas    = $cuenta_colaborador - $num_acciones_pendientes;
    //echo "cuentacolaborador $cuenta_colaborador, nun acciones $num_acciones_pendientes, $num_acciones_realizadas";
    //echo "100*$acumulador_avance_colaboradores/$cuenta_colaborador";
    $sum_verde                  = round(100 * $num_acciones_realizadas / $cuenta_colaborador);
    $sum_amarillo               = 0;
    $sum_rojo                   = round(100 * $num_acciones_pendientes / $cuenta_colaborador);
    $sum_avanceequipo           = round($acumulador_avance_colaboradores / $cuenta_colaborador);
    $lms_avance_equipo          = $sum_avanceequipo;
    $lms_graf_acciones_rojo     = $sum_rojo;
    $lms_graf_acciones_amarillo = $sum_amarillo;
    $lms_graf_acciones_verde    = $sum_verde;
    $PRINCIPAL                  = str_replace("{NUM_PERSONAS_MI_EQUIPO}", count($listado_colaboradores), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{PROMEDIO_EQUIPO}", round($acumulador_avance_colaboradores / count($listado_colaboradores)), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{NUM_VISITAS_MI_EQUIPO}", $acumulador_visitas_colaboradores, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{BLOQUE_COLABORADORES}", utf8_encode($row), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{LMS_GRAFICO_1COLOR}", file_get_contents("views/mi_equipo_lms/" . $id_empresa . "_barra_1color.html"), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{LMS_AVANCEEQUIPO}", $lms_avance_equipo, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{LMS_GRAFICO_3COLORES}", file_get_contents("views/mi_equipo_lms/" . $id_empresa . "_barra_3colores.html"), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{VALUEVERDE}", $lms_graf_acciones_verde, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{VALUEAMARILLO}", $lms_graf_acciones_amarillo, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{VALUEROJO}", $lms_graf_acciones_rojo, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{LMS_NUM_PENDIENTES}", $num_acciones_pendientes, $PRINCIPAL);
    return ($PRINCIPAL);
}
function colocarColaboradoresPorRutConDatos_lms_liderBK2($PRINCIPAL, $id_empresa, $rut, $id_programa_bbdd, $id_curso, $id_objeto)
{
    $listado_colaboradores = TotalUsuariosPorRutJefe($rut);
    if (count($listado_colaboradores) == 0) {
        $listado_colaboradores = TotalUsuariosPorRutJefeResponsable($rut);
    }
    foreach ($listado_colaboradores as $unico) {
        //print_r($unico);
        //$row.=file_get_contents("views/miperfil/row_colaboradores_miperfil.html");
        //$row.=file_get_contents("views/mi_equipo_lms/row_equipo_resumen.html");
        //$datos_integracion = lms_integracion_programas($unico->rut, $id_empresa, "equipo", $id_programa_bbdd, $id_curso, $id_objeto);
        //$row = str_replace("{ROW_LISTA_PROGRAMAS}",utf8_decode($datos_integracion[0]),$row);
        //$row.=file_get_contents("views/mi_equipo_lider/".$id_empresa."_row_equipo_resumen.html");
        //$row = str_replace("{TRIVIAS}",$datos_integracion[2]." &nbsp;&nbsp;Ver Ficha <a href='?sw=fichasTrivias'>aca</a>",$row);
        //print_r($datos_integracion);}
        $row .= file_get_contents("views/mi_equipo_lider/" . $id_empresa . "_row_equipo_resumen.html");
        $row = str_replace("{ROW_LISTA_PROGRAMAS}", utf8_decode($datos_integracion[0]), $row);
        if ($datos_integracion[2]) {
            $row = str_replace("{TRIVIAS}", file_get_contents("views/mi_equipo_lider/" . $id_empresa . "_boton_ver_trivias.html"), $row);
            if ($id_objeto) {
                $datos_objeto = DatosObjeto($id_objeto);
                $row          = str_replace("{OBJETO}", $datos_objeto[0]->titulo, $row);
            } else {
                $row = str_replace("{OBJETO}", "", $row);
            }
            $row = str_replace("{PROMEDIO_TRIVIAS_POR_PROGRAMA}", $datos_integracion[2], $row);
            $row = str_replace("{PROMEDIO_TRIVIAS_POR_PROGRAMA_1A7}", ColocaNotaConvertidaTrivia($datos_integracion[2]), $row);
            $row = str_replace("{RUT_COLABORADOR_ENCODADO}", Encodear3($unico->rut), $row);
        } else {
            $row = str_replace("{TRIVIAS}", "", $row);
        }
        $datos_mallapersona = buscamalla($unico->rut, $id_empresa);
        $datos_mallapersona[0]->id_malla;
        $datos_malla        = DatosMalla($datos_mallapersona[0]->id_malla);
        $datos_consolidados = TienePuntosConsolidadosPorMalla($unico->rut, $id_empresa, $datos_mallapersona[0]->id_malla);
        $row                = str_replace("{PUNTOS}", $datos_consolidados[0]->puntos, $row);
        $promedio_trivias   = PromedioTrivias($unico->rut, $id_empresa);
        if (!$promedio_trivias[0]->promedio_trivias) {
            $row = str_replace("{PROMEDIO}", "0", $row);
        } else {
            $row = str_replace("{PROMEDIO}", round($promedio_trivias[0]->promedio_trivias), $row);
        }
        if ($promedio_trivias[0]->promedio_trivias > 0) {
            $row = str_replace("{PODERES}", "<img src='img/61_rf_badges_5.png' width='20'>", $row);
        } else {
            $row = str_replace("{PODERES}", "", $row);
        }
        $medallas = "";
        for ($k = 1; $k <= $datos_consolidados[0]->medallas; $k++) {
            $medallas .= "<img src='img/rf_medal.png'>";
        }
        //$row = str_replace("{MEDALLAS}",$datos_consolidados[0]->medallas,$row);
        $row = str_replace("{MEDALLAS}", $medallas, $row);
        $row = str_replace("{NOMBRE}", $unico->nombre . " " . $unico->apaterno . " " . $unico->amaterno, $row);
        $row = str_replace("{CARGO}", $unico->cargo, $row);
        $row = str_replace("{GERENCIA}", $unico->gerencia, $row);
        $row = str_replace("{FECHA_CUMPLEANOS}", formatearFecha($unico->fecha_nacimiento), $row);
        $row = str_replace("{URL_PERSONA}", VerificaFotoPersonal($unico->rut), $row);
        $row = str_replace("{RUT_ENCODEADO}", Encodear3($unico->rut), $row);
        $row = str_replace("{MALLA}", ($datos_malla[0]->nombre), $row);
        $row = str_replace("{RUT_COL}", ($unico->rut), $row);
        list($total_inscripciones, $total_aprobados, $total_reprobados, $total_en_proceso) = CAPACITACION_DatosGeneralesPorUsuario($unico->rut);
        $estado                           = EntregaEstadoAvanceBarraMalla(EntregaPorcentaje($total_inscripciones, $total_aprobados));
        $listado_colaborador_sub          = TotalUsuariosPorRutJefe($unico->rut);
        $num_reportes_sub                 = count($listado_colaborador_sub);
        $accion                           = Lms_Busca_Acciones_Pendientes($rut, $unico->rut, $id_empresa);
        $preguntaspendientes              = Lms_Busca_Preguntas_Pendientes($rut, $unico->rut, $id_empresa);
        //echo "<pre>";
        //print_r($preguntaspendientes);
        //$row = str_replace("{TRIVIAS}",("TRIVIAS"),$row);
        $row                              = str_replace("{ACCION}", ($accion), $row);
        $row                              = str_replace("{PREGUNTAS}", ($preguntaspendientes), $row);
        //Desafios Finaliados
        $desafios_finalizados             = TraigoDesafiosFinalizados($unico->rut, $id_empresa);
        $row                              = str_replace("{DESAFIOS_FINALIZADOS}", count($desafios_finalizados), $row);
        $avance                           = round(EntregaPorcentaje($total_inscripciones, $total_aprobados));
        //    echo "<br>$avance";
        $acumulador_avance_colaboradores  = $acumulador_avance_colaboradores + EntregaPorcentaje($total_inscripciones, $total_aprobados);
        $PRINCIPAL                        = str_replace("{NUMERO_AVANCE}", round(EntregaPorcentaje($total_inscripciones, $total_aprobados)), $PRINCIPAL);
        $PRINCIPAL                        = str_replace("{COLOR_PROGRESS_BAR}", $estado[0], $PRINCIPAL);
        $row                              = str_replace("{AVANCE_COLABORADOR}", EntregaPorcentaje($total_inscripciones, $total_aprobados), $row);
        //$total_visitas=TotalVisitasDadoRutCaseEmpresaFront($unico->rut, $id_empresa, "home_minvest");
        $row                              = str_replace("{NUM_VISITAS_COLABORADOR}", $total_visitas[0]->total_visitas, $row);
        $acumulador_visitas_colaboradores = $acumulador_visitas_colaboradores + $total_visitas[0]->total_visitas;
        $cuenta_colaborador++;
        $preguntasPendiente       = Lms_Cuenta_Preguntas_Pendientes_data($unico->rut, $id_empresa);
        $num_preguntas_pendientes = $preguntasPendiente[0]->pendientes + $num_preguntas_pendientes;
        //print_r($preguntasPendiente);
        //echo "<br>num_preguntas_pendientes $num_preguntas_pendientes";
        $num_preguntas_realizadas = $preguntasPendiente[0]->realizadas + $num_preguntas_realizadas;
    }
    $accionesPendiente          = Lms_Cuenta_Acciones_Pendientes_data_lider($rut, $id_empresa);
    $num_acciones_pendientes    = $accionesPendiente[0]->pendientes;
    $num_acciones_realizadas    = $accionesPendiente[0]->realizadas;
    //echo "cuentacolaborador $cuenta_colaborador, nun acciones $num_acciones_pendientes, $num_acciones_realizadas";
    //echo "100*$acumulador_avance_colaboradores/$cuenta_colaborador";
    $sum_verde                  = round(100 * $num_acciones_realizadas / $cuenta_colaborador);
    $sum_amarillo               = 0;
    $sum_rojo                   = round(100 * $num_acciones_pendientes / $cuenta_colaborador);
    $sum_avanceequipo           = round($acumulador_avance_colaboradores / $cuenta_colaborador);
    $lms_avance_equipo          = $sum_avanceequipo;
    $lms_graf_acciones_rojo     = $sum_rojo;
    $lms_graf_acciones_amarillo = $sum_amarillo;
    $lms_graf_acciones_verde    = $sum_verde;
    $PRINCIPAL                  = str_replace("{NUM_PERSONAS_MI_EQUIPO}", count($listado_colaboradores), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{PROMEDIO_EQUIPO}", round($acumulador_avance_colaboradores / count($listado_colaboradores)), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{NUM_VISITAS_MI_EQUIPO}", $acumulador_visitas_colaboradores, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{BLOQUE_COLABORADORES}", utf8_encode($row), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{LMS_GRAFICO_1COLOR}", file_get_contents("views/mi_equipo_lms/" . $id_empresa . "_barra_1color.html"), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{LMS_AVANCEEQUIPO}", $lms_avance_equipo, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{LMS_GRAFICO_3COLORES}", file_get_contents("views/mi_equipo_lms/" . $id_empresa . "_barra_3colores.html"), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{VALUEVERDE}", $lms_graf_acciones_verde, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{VALUEAMARILLO}", $lms_graf_acciones_amarillo, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{VALUEROJO}", $lms_graf_acciones_rojo, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{LMS_NUM_PENDIENTES}", $num_acciones_pendientes, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{LMS_NUM_REALIZADOS}", $num_acciones_realizadas, $PRINCIPAL);
    $listaProgramas_Select      = lms_integracion_lista_programasSinRut($id_empresa, $rut);
    $options_select_programa    = "";
    foreach ($listaProgramas_Select as $prog) {
        if ($id_programa_bbdd == $prog->id_programa) {
            $options_select_programa .= "<option value='" . $prog->id_programa . "' selected='selected'>" . $prog->nombre_programa . "</option>";
        } else {
            $options_select_programa .= "<option value='" . $prog->id_programa . "'>" . $prog->nombre_programa . "</option>";
        }
    }
    $PRINCIPAL = str_replace("{OPTIONS_PROGRAMAS_BBDD}", utf8_encode($options_select_programa), $PRINCIPAL);
    if ($id_programa_bbdd) {
        $arreglo_post   = $_POST;
        $cursos         = REL_MALLA_CURSO_TraeCursosDadoPrograma2($id_empresa, $arreglo_post);
        $options_cursos = "";
        foreach ($cursos as $prog) {
            if ($prog->id_curso == $id_curso) {
                $options_cursos .= "<option value='" . $prog->id_curso . "' selected>" . $prog->nombre . " (" . $prog->id_curso . ")</option>";
            } else {
                $options_cursos .= "<option value='" . $prog->id_curso . "'>" . $prog->nombre . " (" . $prog->id_curso . ")</option>";
            }
        }
    }
    $PRINCIPAL = str_replace("{OPTIONS_CURSOS}", utf8_encode($options_cursos), $PRINCIPAL);
    //Objetos
    if ($id_curso) {
        $objetos = CHECK_ObjetosPorCurso($arreglo_post["cursos"]);
        $options = "";
        foreach ($objetos as $obj) {
            if ($obj->id == $id_objeto) {
                $options .= "<option selected value='" . $obj->id . "'>" . $obj->titulo . "</option>";
            } else {
                $options .= "<option value='" . $obj->id . "'>" . $obj->titulo . "</option>";
            }
        }
        $PRINCIPAL = str_replace("{OPTIONS_OBJETOS}", utf8_encode($options), $PRINCIPAL);
    }
    //Mensajes_por Agente
    $total_respondidas    = 0;
    $total_no_respondidas = 0;
    $mensajes_por_Agente  = TraeMensajesPorAgente($rut, $id_empresa);
    foreach ($mensajes_por_Agente as $mensaje) {
        if ($mensaje->total_respuestas_agente > 0) {
            $total_respondidas++;
        } else {
            $total_no_respondidas++;
        }
    }
    //$PRINCIPAL = str_replace("{LMS_NUM_PREGUNTAS_PENDIENTES}",$num_preguntas_pendientes,$PRINCIPAL);
    //$PRINCIPAL = str_replace("{LMS_NUM_PREGUNTAS_REALIZADOS}",$num_preguntas_realizadas,$PRINCIPAL);
    $PRINCIPAL = str_replace("{LMS_NUM_PREGUNTAS_PENDIENTES}", $total_no_respondidas, $PRINCIPAL);
    $PRINCIPAL = str_replace("{LMS_NUM_PREGUNTAS_REALIZADOS}", $total_respondidas, $PRINCIPAL);
    return ($PRINCIPAL);
}
function colocarColaboradoresPorRutConDatos_lms_lider_ejecutivos($PRINCIPAL, $id_empresa, $rut, $id_programa_bbdd, $id_curso, $id_objeto, $ajax)
{
    $listado_colaboradores = TotalUsuariosPorRutLiderEjecutivos($rut);
    if ($_GET["sw"] == "mi_perfil_esc") {
        $listado_colaboradores = TotalUsuariosMiRut($rut);
    }
    $acumulador_nota_final  = 0;
    $contador_colaboradores = 0;
    foreach ($listado_colaboradores as $unico) {
        //print_r($unico);
        //$row.=file_get_contents("views/miperfil/row_colaboradores_miperfil.html");
        //$row.=file_get_contents("views/mi_equipo_lms/row_equipo_resumen.html");
        //ActualizaTablatblLmsReportePorRut($unico->rut);
        $datos_integracion     = lms_integracion_programas($unico->rut, $id_empresa, "equipo", $id_programa_bbdd, $id_curso, $id_objeto);
        $acumulador_nota_final = $acumulador_nota_final + $datos_integracion[1];
        $contador_colaboradores++;
        //$row = str_replace("{ROW_LISTA_PROGRAMAS}",utf8_decode($datos_integracion[0]),$row);
        //$row.=file_get_contents("views/mi_equipo_lider/".$id_empresa."_row_equipo_resumen.html");
        //$row = str_replace("{TRIVIAS}",$datos_integracion[2]." &nbsp;&nbsp;Ver Ficha <a href='?sw=fichasTrivias'>aca</a>",$row);
        //echo "<br>".$unico->rut." ".$id_programa_bbdd;
        //print_r($datos_integracion[2]);
        if ($ajax == "ajax") {
            $row .= file_get_contents("views/mi_equipo_ejecutivos/" . $id_empresa . "_row_equipo_resumen_ajax.html");
        } else {
            $row .= file_get_contents("views/mi_equipo_ejecutivos/" . $id_empresa . "_row_equipo_resumen.html");
        }
        $row = str_replace("{ROW_LISTA_PROGRAMAS_mi_equipo_lider}", utf8_decode($datos_integracion[0]), $row);
        $row = str_replace("{RUT_JEFE}", $unico->rut, $row);
        if ($datos_integracion[2]) {
            $row = str_replace("{TRIVIAS}", file_get_contents("views/mi_equipo_ejecutivos/" . $id_empresa . "_boton_ver_trivias.html"), $row);
            if ($id_objeto) {
                $datos_objeto = DatosObjeto($id_objeto);
                $row          = str_replace("{OBJETO}", $datos_objeto[0]->titulo, $row);
            } else {
                $row = str_replace("{OBJETO}", "", $row);
            }
            $row = str_replace("{PROMEDIO_TRIVIAS_POR_PROGRAMA}", $datos_integracion[2], $row);
            $row = str_replace("{PROMEDIO_TRIVIAS_POR_PROGRAMA_1A7}", ColocaNotaConvertidaTrivia($datos_integracion[2]), $row);
            $row = str_replace("{RUT_COLABORADOR_ENCODADO}", Encodear3($unico->rut), $row);
        } else {
            $row = str_replace("{TRIVIAS}", "", $row);
        }
        $datos_mallapersona = buscamalla($unico->rut, $id_empresa);
        $datos_mallapersona[0]->id_malla;
        $datos_malla        = DatosMalla($datos_mallapersona[0]->id_malla);
        $datos_consolidados = TienePuntosConsolidadosPorMalla($unico->rut, $id_empresa, $datos_mallapersona[0]->id_malla);
        $row                = str_replace("{PUNTOS}", $datos_consolidados[0]->puntos, $row);
        $promedio_trivias   = PromedioTrivias($unico->rut, $id_empresa);
        if (!$promedio_trivias[0]->promedio_trivias) {
            $row = str_replace("{PROMEDIO}", "0", $row);
        } else {
            $row = str_replace("{PROMEDIO}", round($promedio_trivias[0]->promedio_trivias), $row);
        }
        if ($promedio_trivias[0]->promedio_trivias > 0) {
            $row = str_replace("{PODERES}", "<img src='img/61_rf_badges_5.png' width='20'>", $row);
        } else {
            $row = str_replace("{PODERES}", "", $row);
        }
        $medallas = "";
        for ($k = 1; $k <= $datos_consolidados[0]->medallas; $k++) {
            $medallas .= "<img src='img/rf_medal.png'>";
        }
        //$row = str_replace("{MEDALLAS}",$datos_consolidados[0]->medallas,$row);
        $row               = str_replace("{MEDALLAS}", $medallas, $row);
        $arreglo_subequipo = TotalUsuariosPorRutJefe($unico->rut);
        $num_subequipo     = count($arreglo_subequipo);
        if ($num_subequipo > 0) {
            $mi_equipo_ver_equipo = "<span class='label-small label-small-info  pull-right'>Ver Equipo <span class='badge'>" . $num_subequipo . " <i class='icon-people icons'></i></span> </span>";
        } else {
            $mi_equipo_ver_equipo = "";
        }
        $row = str_replace("{NOMBRE}", $unico->nombre . " " . $unico->apaterno . " " . $unico->amaterno, $row);
        $row = str_replace("{CARGO}", $unico->cargo, $row);
        $row = str_replace("{GERENCIA}", $unico->gerencia, $row);
        $row = str_replace("{FECHA_CUMPLEANOS}", formatearFecha($unico->fecha_nacimiento), $row);
        $row = str_replace("{URL_PERSONA}", VerificaFotoPersonal($unico->rut), $row);
        $row = str_replace("{RUT_ENCODEADO}", Encodear3($unico->rut), $row);
        $row = str_replace("{MALLA}", ($datos_malla[0]->nombre), $row);
        $row = str_replace("{MIEQUIPO_VER_EQUIPO}", ($mi_equipo_ver_equipo), $row);
        $row = str_replace("{MIEQUIPO_VER_EQUIPO_CLICK}", ($mi_equipo_ver_equipo), $row);
        $row = str_replace("{NUM_MIEQUIPO_VER_EQUIPO}", ($num_subequipo), $row);
        $row = str_replace("{RUT_COL}", ($unico->rut), $row);
        list($total_inscripciones, $total_aprobados, $total_reprobados, $total_en_proceso) = CAPACITACION_DatosGeneralesPorUsuario($unico->rut);
        $estado                           = EntregaEstadoAvanceBarraMalla(EntregaPorcentaje($total_inscripciones, $total_aprobados));
        $listado_colaborador_sub          = TotalUsuariosPorRutJefe($unico->rut);
        $num_reportes_sub                 = count($listado_colaborador_sub);
        $accion                           = Lms_Busca_Acciones_Pendientes($rut, $unico->rut, $id_empresa);
        $preguntaspendientes              = Lms_Busca_Preguntas_Pendientes($rut, $unico->rut, $id_empresa);
        //echo "<pre>";
        //print_r($preguntaspendientes);
        //$row = str_replace("{TRIVIAS}",("TRIVIAS"),$row);
        $row                              = str_replace("{ACCION}", ($accion), $row);
        $row                              = str_replace("{PREGUNTAS}", ($preguntaspendientes), $row);
        //Desafios Finaliados
        $desafios_finalizados             = TraigoDesafiosFinalizados($unico->rut, $id_empresa);
        $row                              = str_replace("{DESAFIOS_FINALIZADOS}", count($desafios_finalizados), $row);
        $avance                           = round(EntregaPorcentaje($total_inscripciones, $total_aprobados));
        //    echo "<br>$avance";
        $acumulador_avance_colaboradores  = $acumulador_avance_colaboradores + EntregaPorcentaje($total_inscripciones, $total_aprobados);
        $PRINCIPAL                        = str_replace("{NUMERO_AVANCE}", round(EntregaPorcentaje($total_inscripciones, $total_aprobados)), $PRINCIPAL);
        $PRINCIPAL                        = str_replace("{COLOR_PROGRESS_BAR}", $estado[0], $PRINCIPAL);
        $row                              = str_replace("{AVANCE_COLABORADOR}", EntregaPorcentaje($total_inscripciones, $total_aprobados), $row);
        //$total_visitas=TotalVisitasDadoRutCaseEmpresaFront($unico->rut, $id_empresa, "home_minvest");
        $row                              = str_replace("{NUM_VISITAS_COLABORADOR}", $total_visitas[0]->total_visitas, $row);
        $acumulador_visitas_colaboradores = $acumulador_visitas_colaboradores + $total_visitas[0]->total_visitas;
        $cuenta_colaborador++;
        $preguntasPendiente       = Lms_Cuenta_Preguntas_Pendientes_data($unico->rut, $id_empresa);
        $num_preguntas_pendientes = $preguntasPendiente[0]->pendientes + $num_preguntas_pendientes;
        //print_r($preguntasPendiente);
        //echo "<br>num_preguntas_pendientes $num_preguntas_pendientes";
        $num_preguntas_realizadas = $preguntasPendiente[0]->realizadas + $num_preguntas_realizadas;
    }
    $accionesPendiente          = Lms_Cuenta_Acciones_Pendientes_data_lider($rut, $id_empresa);
    $num_acciones_pendientes    = $accionesPendiente[0]->pendientes;
    $num_acciones_realizadas    = $accionesPendiente[0]->realizadas;
    //echo "cuentacolaborador $cuenta_colaborador, nun acciones $num_acciones_pendientes, $num_acciones_realizadas";
    //echo "100*$acumulador_avance_colaboradores/$cuenta_colaborador";
    $sum_verde                  = round(100 * $num_acciones_realizadas / $cuenta_colaborador);
    $sum_amarillo               = 0;
    $sum_rojo                   = round(100 * $num_acciones_pendientes / $cuenta_colaborador);
    $sum_avanceequipo           = round($acumulador_avance_colaboradores / $cuenta_colaborador);
    $lms_avance_equipo          = $sum_avanceequipo;
    $lms_graf_acciones_rojo     = $sum_rojo;
    $lms_graf_acciones_amarillo = $sum_amarillo;
    $lms_graf_acciones_verde    = $sum_verde;
    $promedio_final             = $acumulador_nota_final / $contador_colaboradores;
    $PRINCIPAL                  = str_replace("{VALOR_PROMEDIO}", round($promedio_final), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{NUM_PERSONAS_MI_EQUIPO}", count($listado_colaboradores), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{PROMEDIO_EQUIPO}", round($acumulador_avance_colaboradores / count($listado_colaboradores)), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{NUM_VISITAS_MI_EQUIPO}", $acumulador_visitas_colaboradores, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{BLOQUE_COLABORADORES}", utf8_encode($row), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{LMS_GRAFICO_1COLOR}", file_get_contents("views/mi_equipo_lms/" . $id_empresa . "_barra_1color.html"), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{LMS_AVANCEEQUIPO}", $lms_avance_equipo, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{LMS_GRAFICO_3COLORES}", file_get_contents("views/mi_equipo_lms/" . $id_empresa . "_barra_3colores.html"), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{VALUEVERDE}", $lms_graf_acciones_verde, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{VALUEAMARILLO}", $lms_graf_acciones_amarillo, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{VALUEROJO}", $lms_graf_acciones_rojo, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{LMS_NUM_PENDIENTES}", $num_acciones_pendientes, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{LMS_NUM_REALIZADOS}", $num_acciones_realizadas, $PRINCIPAL);
    $listaProgramas_Select      = lms_integracion_lista_programasSinRut($id_empresa, $rut);
    $options_select_programa    = "";
    foreach ($listaProgramas_Select as $prog) {
        if ($id_programa_bbdd == $prog->id_programa) {
            $options_select_programa .= "<option value='" . $prog->id_programa . "' selected='selected'>" . $prog->nombre_programa . "</option>";
        } else {
            $options_select_programa .= "<option value='" . $prog->id_programa . "'>" . $prog->nombre_programa . "</option>";
        }
    }
    $PRINCIPAL = str_replace("{OPTIONS_PROGRAMAS_BBDD}", utf8_encode($options_select_programa), $PRINCIPAL);
    if ($id_programa_bbdd) {
        $arreglo_post   = $_POST;
        $cursos         = REL_MALLA_CURSO_TraeCursosDadoPrograma2($id_empresa, $arreglo_post);
        $options_cursos = "";
        foreach ($cursos as $prog) {
            if ($prog->id_curso == $id_curso) {
                $options_cursos .= "<option value='" . $prog->id_curso . "' selected>" . $prog->nombre . " (" . $prog->id_curso . ")</option>";
            } else {
                $options_cursos .= "<option value='" . $prog->id_curso . "'>" . $prog->nombre . " (" . $prog->id_curso . ")</option>";
            }
        }
    }
    $PRINCIPAL = str_replace("{OPTIONS_CURSOS}", utf8_encode($options_cursos), $PRINCIPAL);
    //Objetos
    if ($id_curso) {
        $objetos = CHECK_ObjetosPorCurso($arreglo_post["cursos"]);
        $options = "";
        foreach ($objetos as $obj) {
            if ($obj->id == $id_objeto) {
                $options .= "<option selected value='" . $obj->id . "'>" . $obj->titulo . "</option>";
            } else {
                $options .= "<option value='" . $obj->id . "'>" . $obj->titulo . "</option>";
            }
        }
        $PRINCIPAL = str_replace("{OPTIONS_OBJETOS}", utf8_encode($options), $PRINCIPAL);
    }
    //Mallas
    $mallas = MallasPorEmpresa2($id_empresa);
    foreach ($mallas as $mal) {
        if ($mal->nombre <> '') {
            $options_mallas .= "<option value='" . $mal->id . "'>" . $mal->nombre . "</option>";
        }
    }
    $PRINCIPAL            = str_replace("{OPTIONS_MALLAS}", utf8_encode($options_mallas), $PRINCIPAL);
    //Mensajes_por Agente
    $total_respondidas    = 0;
    $total_no_respondidas = 0;
    $mensajes_por_Agente  = TraeMensajesPorAgente($rut, $id_empresa);
    foreach ($mensajes_por_Agente as $mensaje) {
        if ($mensaje->total_respuestas_agente > 0) {
            $total_respondidas++;
        } else {
            $total_no_respondidas++;
        }
    }
    //$PRINCIPAL = str_replace("{LMS_NUM_PREGUNTAS_PENDIENTES}",$num_preguntas_pendientes,$PRINCIPAL);
    //$PRINCIPAL = str_replace("{LMS_NUM_PREGUNTAS_REALIZADOS}",$num_preguntas_realizadas,$PRINCIPAL);
    $PRINCIPAL = str_replace("{LMS_NUM_PREGUNTAS_PENDIENTES}", $total_no_respondidas, $PRINCIPAL);
    $PRINCIPAL = str_replace("{LMS_NUM_PREGUNTAS_REALIZADOS}", $total_respondidas, $PRINCIPAL);
    return ($PRINCIPAL);
}

function colocarColaboradoresPorRutConDatos_lms_lider($PRINCIPAL, $id_empresa, $rut, $id_programa_bbdd, $id_curso, $id_objeto, $ajax)
{

//echo       // "<br>colocarColaboradoresPorRutConDatos_lms_lider  $id_programa_bbdd, $id_curso ";

    $listado_colaboradores = TotalUsuariosPorRutJefe($rut);
    if (count($listado_colaboradores) == 0) {
        $listado_colaboradores = TotalUsuariosPorRutJefeResponsable($rut);
    }
    if ($_GET["sw"] == "mi_perfil_esc") {
        $listado_colaboradores = TotalUsuariosMiRut($rut);
    }
    $acumulador_nota_final  = 0;
    $contador_colaboradores = 0;

    foreach ($listado_colaboradores as $unico) {
      //print_r($unico);
        //$row.=file_get_contents("views/miperfil/row_colaboradores_miperfil.html");
        //$row.=file_get_contents("views/mi_equipo_lms/row_equipo_resumen.html");
        //ActualizaTablatblLmsReportePorRut($unico->rut);
        $datos_integracion     = lms_integracion_programas($unico->rut, $id_empresa, "equipo", $id_programa_bbdd, $id_curso, $id_objeto);
        //print_r($datos_integracion);
        $acumulador_nota_final = $acumulador_nota_final + $datos_integracion[1];
        $contador_colaboradores++;
        //$row = str_replace("{ROW_LISTA_PROGRAMAS}",utf8_decode($datos_integracion[0]),$row);
        //$row.=file_get_contents("views/mi_equipo_lider/".$id_empresa."_row_equipo_resumen.html");
        //$row = str_replace("{TRIVIAS}",$datos_integracion[2]." &nbsp;&nbsp;Ver Ficha <a href='?sw=fichasTrivias'>aca</a>",$row);
        //echo "<br>".$unico->rut." ".$id_programa_bbdd;
        //print_r($datos_integracion[2]);
        if ($ajax == "ajax") {
                $row .= file_get_contents("views/mi_equipo_lider/" . $id_empresa . "_row_equipo_resumen_ajax.html");
        } else {
                $row .= file_get_contents("views/mi_equipo_lider/" . $id_empresa . "_row_equipo_resumen.html");
        }
         //echo "<br>hola1";
        $buscaCursosHistoricosAprobados=VistaCursosHistoricosResumenData($unico->rut, $id_empresa);
        $cuentaApro=0;$cuentaCursos=0;
        foreach ($buscaCursosHistoricosAprobados as $unicoRow)

        {
                if($unicoRow->estado=="APROBADO"){
                    $cuentaApro++;
                }
                $cuentaCursos++;
        }
        $rut_enco=Encodear3($unico->rut);
        $row_historicos="

                            <span class='badge badge-info'><span class='blanco'>".$cuentaCursos."</span> </span> <span class=' font-blue'> cursos realizados</span>
                            <span class='badge badge-primary'><span class='blanco'>     ".$cuentaApro."</span> </span><span class=' font-blue'>  cursos aprobados</span>
                            <a href='?sw=lms_lista_historicos&rut_enc=".$rut_enco."' class='btn btn-info btn-sm' ><span class='blanco'>Ver Cursos Hist?ricos</span></a>
                            <br>
                        ";

        $row                = str_replace("{ROW_HISTORICOS}", utf8_decode($row_historicos), $row);

        $row                = str_replace("{ROW_LISTA_PROGRAMAS_mi_equipo_lider}", utf8_decode($datos_integracion[0]), $row);
        //echo "<br>hola2";

        $row                = str_replace("{RUT_JEFE}", $unico->rut, $row);
        $array_Reco_Gracias = BuscaDatosReconocimientoAgradecimientos($unico->rut, $id_empresa);
        if ($array_Reco_Gracias[0]->num_gracias > 0) {
            $num_gracias = $array_Reco_Gracias[0]->num_gracias;
        } else {
            $num_gracias = 0;
        }
        if ($array_Reco_Gracias[0]->num_reconocimientos > 0) {
            $num_reconocimientos = $array_Reco_Gracias[0]->num_reconocimientos;
        } else {
            $num_reconocimientos = 0;
        }
        $row = str_replace("{NUM_RECONOCIMIENTOS}", $num_reconocimientos, $row);
        $row = str_replace("{NUM_GRACIAS}", $num_gracias, $row);
        if ($datos_integracion[2]) {
            $row = str_replace("{TRIVIAS}", file_get_contents("views/mi_equipo_lider/" . $id_empresa . "_boton_ver_trivias.html"), $row);
            if ($id_objeto) {
                $datos_objeto = DatosObjeto($id_objeto);
                $row          = str_replace("{OBJETO}", $datos_objeto[0]->titulo, $row);
            } else {
                $row = str_replace("{OBJETO}", "", $row);
            }
            $row = str_replace("{PROMEDIO_TRIVIAS_POR_PROGRAMA}", $datos_integracion[2], $row);
            $row = str_replace("{PROMEDIO_TRIVIAS_POR_PROGRAMA_1A7}", ColocaNotaConvertidaTrivia($datos_integracion[2]), $row);
            $row = str_replace("{RUT_COLABORADOR_ENCODADO}", Encodear3($unico->rut), $row);
        } else {
            $row = str_replace("{TRIVIAS}", "", $row);
        }
        $datos_mallapersona = buscamalla($unico->rut, $id_empresa);
        $datos_mallapersona[0]->id_malla;
        $datos_malla        = DatosMalla($datos_mallapersona[0]->id_malla);
        $datos_consolidados = TienePuntosConsolidadosPorMalla($unico->rut, $id_empresa, $datos_mallapersona[0]->id_malla);
        $row                = str_replace("{PUNTOS}", $datos_consolidados[0]->puntos, $row);
        $promedio_trivias   = PromedioTrivias($unico->rut, $id_empresa);
        if (!$promedio_trivias[0]->promedio_trivias) {
            $row = str_replace("{PROMEDIO}", "0", $row);
        } else {
            $row = str_replace("{PROMEDIO}", round($promedio_trivias[0]->promedio_trivias), $row);
        }
        if ($promedio_trivias[0]->promedio_trivias > 0) {
            $row = str_replace("{PODERES}", "<img src='img/61_rf_badges_5.png' width='20'>", $row);
        } else {
            $row = str_replace("{PODERES}", "", $row);
        }
        $medallas = "";
        for ($k = 1; $k <= $datos_consolidados[0]->medallas; $k++) {
            $medallas .= "<img src='img/rf_medal.png'>";
        }
        //$row = str_replace("{MEDALLAS}",$datos_consolidados[0]->medallas,$row);
        $row               = str_replace("{MEDALLAS}", $medallas, $row);
        $arreglo_subequipo = TotalUsuariosPorRutJefe($unico->rut);
        $num_subequipo     = count($arreglo_subequipo);
        if ($num_subequipo > 0) {
            $mi_equipo_ver_equipo = "<span class='label-small label-small-info  pull-right'>Ver Equipo <span class='badge'>" . $num_subequipo . " <i class='icon-people icons'></i></span> </span>";
        } else {
            $mi_equipo_ver_equipo = "";
        }
        $row = str_replace("{NOMBRE}", $unico->nombre . " " . $unico->apaterno . " " . $unico->amaterno, $row);
        $row = str_replace("{CARGO}", $unico->cargo, $row);
        $row = str_replace("{GERENCIA}", $unico->gerencia, $row);
        $row = str_replace("{FECHA_CUMPLEANOS}", formatearFecha($unico->fecha_nacimiento), $row);
        $row = str_replace("{URL_PERSONA}", VerificaFotoPersonal($unico->rut), $row);
        $row = str_replace("{RUT_ENCODEADO}", Encodear3($unico->rut), $row);
        $row = str_replace("{MALLA}", ($datos_malla[0]->nombre), $row);
        $row = str_replace("{MIEQUIPO_VER_EQUIPO}", ($mi_equipo_ver_equipo), $row);
        $row = str_replace("{NUM_MIEQUIPO_VER_EQUIPO}", ($num_subequipo), $row);
        $row = str_replace("{RUT_COL}", ($unico->rut), $row);

    //echo "<br>hola3";


 list($total_inscripciones, $total_aprobados, $total_reprobados, $total_en_proceso) = CAPACITACION_DatosGeneralesPorUsuario($unico->rut);
        $estado                           = EntregaEstadoAvanceBarraMalla(EntregaPorcentaje($total_inscripciones, $total_aprobados));
        $listado_colaborador_sub          = TotalUsuariosPorRutJefe($unico->rut);
        $num_reportes_sub                 = count($listado_colaborador_sub);
        $accion                           = Lms_Busca_Acciones_Pendientes($rut, $unico->rut, $id_empresa);
        $preguntaspendientes              = Lms_Busca_Preguntas_Pendientes($rut, $unico->rut, $id_empresa);
        //echo "<pre>";
        //print_r($preguntaspendientes);
        //$row = str_replace("{TRIVIAS}",("TRIVIAS"),$row);
        $row                              = str_replace("{ACCION}", ($accion), $row);
        $row                              = str_replace("{PREGUNTAS}", ($preguntaspendientes), $row);
        //Desafios Finaliados
        $desafios_finalizados             = TraigoDesafiosFinalizados($unico->rut, $id_empresa);
        $row                              = str_replace("{DESAFIOS_FINALIZADOS}", count($desafios_finalizados), $row);
        $avance                           = round(EntregaPorcentaje($total_inscripciones, $total_aprobados));
        //    echo "<br>$avance";
        $acumulador_avance_colaboradores  = $acumulador_avance_colaboradores + EntregaPorcentaje($total_inscripciones, $total_aprobados);
        $PRINCIPAL                        = str_replace("{NUMERO_AVANCE}", round(EntregaPorcentaje($total_inscripciones, $total_aprobados)), $PRINCIPAL);
        $PRINCIPAL                        = str_replace("{COLOR_PROGRESS_BAR}", $estado[0], $PRINCIPAL);
        $row                              = str_replace("{AVANCE_COLABORADOR}", EntregaPorcentaje($total_inscripciones, $total_aprobados), $row);
        //$total_visitas=TotalVisitasDadoRutCaseEmpresaFront($unico->rut, $id_empresa, "home_minvest");
        $row                              = str_replace("{NUM_VISITAS_COLABORADOR}", $total_visitas[0]->total_visitas, $row);
        $acumulador_visitas_colaboradores = $acumulador_visitas_colaboradores + $total_visitas[0]->total_visitas;
        $cuenta_colaborador++;
        $preguntasPendiente       = Lms_Cuenta_Preguntas_Pendientes_data($unico->rut, $id_empresa);
        $num_preguntas_pendientes = $preguntasPendiente[0]->pendientes + $num_preguntas_pendientes;
        //print_r($preguntasPendiente);
        //echo "<br>num_preguntas_pendientes $num_preguntas_pendientes";
        $num_preguntas_realizadas = $preguntasPendiente[0]->realizadas + $num_preguntas_realizadas;
    }


    $accionesPendiente          = Lms_Cuenta_Acciones_Pendientes_data_lider($rut, $id_empresa);
    $num_acciones_pendientes    = $accionesPendiente[0]->pendientes;
    $num_acciones_realizadas    = $accionesPendiente[0]->realizadas;
    //echo "<br>hola4";

    //echo "cuentacolaborador $cuenta_colaborador, nun acciones $num_acciones_pendientes, $num_acciones_realizadas";
    //echo "100*$acumulador_avance_colaboradores/$cuenta_colaborador";
    $sum_verde                  = round(100 * $num_acciones_realizadas / $cuenta_colaborador);
    $sum_amarillo               = 0;
    $sum_rojo                   = round(100 * $num_acciones_pendientes / $cuenta_colaborador);
    $sum_avanceequipo           = round($acumulador_avance_colaboradores / $cuenta_colaborador);
    $lms_avance_equipo          = $sum_avanceequipo;
    $lms_graf_acciones_rojo     = $sum_rojo;
    $lms_graf_acciones_amarillo = $sum_amarillo;
    $lms_graf_acciones_verde    = $sum_verde;
    $promedio_final             = $acumulador_nota_final / $contador_colaboradores;
    $PRINCIPAL                  = str_replace("{VALOR_PROMEDIO}", round($promedio_final), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{NUM_PERSONAS_MI_EQUIPO}", count($listado_colaboradores), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{PROMEDIO_EQUIPO}", round($acumulador_avance_colaboradores / count($listado_colaboradores)), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{NUM_VISITAS_MI_EQUIPO}", $acumulador_visitas_colaboradores, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{BLOQUE_COLABORADORES}", utf8_encode($row), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{LMS_GRAFICO_1COLOR}", file_get_contents("views/mi_equipo_lms/" . $id_empresa . "_barra_1color.html"), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{LMS_AVANCEEQUIPO}", $lms_avance_equipo, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{LMS_GRAFICO_3COLORES}", file_get_contents("views/mi_equipo_lms/" . $id_empresa . "_barra_3colores.html"), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{VALUEVERDE}", $lms_graf_acciones_verde, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{VALUEAMARILLO}", $lms_graf_acciones_amarillo, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{VALUEROJO}", $lms_graf_acciones_rojo, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{LMS_NUM_PENDIENTES}", $num_acciones_pendientes, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{LMS_NUM_REALIZADOS}", $num_acciones_realizadas, $PRINCIPAL);
    //AVANCE GLOBAL Y POR C1,C2, C3, C4
    $arra_usu                   = busca_c1_c2_c3_c4_jefe($rut, $id_empresa);
    //print_r($arra_usu);
    $c1                         = $arra_usu[0]->c1;
    $c2                         = $arra_usu[0]->c2;
    $c3                         = $arra_usu[0]->c3;
    $c4                         = $arra_usu[0]->c4;
    $jefe                       = $arra_usu[0]->jefe;
    //echo "<br>c1 $c1, c2 $c2, c3 $c3, c4 $c4, jefe $jefe<br>";
    $data_array_avance          = lms_avance_promedio_c1_c2_c3_c4_jefe($rut, $c1, $c2, $c3, $c4, $jefe, $programa, $curso, $id_empresa);
    //print_r($data_array_avance);
    $PRINCIPAL                  = str_replace("{AVANCE_PROM_TOTAL}", round($data_array_avance[5], 0), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{AVANCE_PROM_JEFE}", round($data_array_avance[4], 0), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{AVANCE_PROM_C1}", round($data_array_avance[0], 0), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{AVANCE_PROM_C2}", round($data_array_avance[1], 0), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{AVANCE_PROM_C3}", round($data_array_avance[2], 0), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{AVANCE_PROM_C4}", round($data_array_avance[3], 0), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{AVANCE_PROM_IND}", round($data_array_avance[6], 0), $PRINCIPAL);

  $listaProgramas_Select      = lms_integracion_lista_programasSinRut($id_empresa, $rut);
    $options_select_programa    = "";
    foreach ($listaProgramas_Select as $prog) {
        if ($id_programa_bbdd == $prog->id_programa) {
            $options_select_programa .= "<option value='" . $prog->id_programa . "' selected='selected'>" . $prog->nombre_programa . "</option>";
        } else {
            $options_select_programa .= "<option value='" . $prog->id_programa . "'>" . $prog->nombre_programa . "</option>";
        }
    }
    $PRINCIPAL = str_replace("{OPTIONS_PROGRAMAS_BBDD}", utf8_encode($options_select_programa), $PRINCIPAL);
    if ($id_programa_bbdd) {
        $arreglo_post   = $_POST;
        $cursos         = REL_MALLA_CURSO_TraeCursosDadoPrograma2($id_empresa, $arreglo_post);
        $options_cursos = "";
        foreach ($cursos as $prog) {
            if ($prog->id_curso == $id_curso) {
                $options_cursos .= "<option value='" . $prog->id_curso . "' selected>" . $prog->nombre . " (" . $prog->id_curso . ")</option>";
            } else {
                $options_cursos .= "<option value='" . $prog->id_curso . "'>" . $prog->nombre . " (" . $prog->id_curso . ")</option>";
            }
        }
    }
    $PRINCIPAL = str_replace("{OPTIONS_CURSOS}", utf8_encode($options_cursos), $PRINCIPAL);
    //Objetos
    if ($id_curso) {
        $objetos = CHECK_ObjetosPorCurso($arreglo_post["cursos"]);
        $options = "";
        foreach ($objetos as $obj) {
            if ($obj->id == $id_objeto) {
                $options .= "<option selected value='" . $obj->id . "'>" . $obj->titulo . "</option>";
            } else {
                $options .= "<option value='" . $obj->id . "'>" . $obj->titulo . "</option>";
            }
        }
        $PRINCIPAL = str_replace("{OPTIONS_OBJETOS}", utf8_encode($options), $PRINCIPAL);
    }
    //Mallas
    $mallas = MallasPorEmpresa2($id_empresa);
    foreach ($mallas as $mal) {
        if ($mal->nombre <> '') {
            $options_mallas .= "<option value='" . $mal->id . "'>" . $mal->nombre . "</option>";
        }
    }
    $PRINCIPAL            = str_replace("{OPTIONS_MALLAS}", utf8_encode($options_mallas), $PRINCIPAL);
    //Mensajes_por Agente
    $total_respondidas    = 0;
    $total_no_respondidas = 0;
    $mensajes_por_Agente  = TraeMensajesPorAgente($rut, $id_empresa);
    foreach ($mensajes_por_Agente as $mensaje) {
        if ($mensaje->total_respuestas_agente > 0) {
            $total_respondidas++;
        } else {
            $total_no_respondidas++;
        }
    }
    //$PRINCIPAL = str_replace("{LMS_NUM_PREGUNTAS_PENDIENTES}",$num_preguntas_pendientes,$PRINCIPAL);
    //$PRINCIPAL = str_replace("{LMS_NUM_PREGUNTAS_REALIZADOS}",$num_preguntas_realizadas,$PRINCIPAL);
    $array_Reco_Gracias = BuscaDatosReconocimientoAgradecimientos($unico->rut, $id_empresa);
    if ($array_Reco_Gracias[0]->num_gracias > 0) {
        $num_gracias = $array_Reco_Gracias[0]->num_gracias;
    } else {
        $num_gracias = 0;
    }
    if ($array_Reco_Gracias[0]->num_reconocimientos > 0) {
        $num_reconocimientos = $array_Reco_Gracias[0]->num_reconocimientos;
    } else {
        $num_reconocimientos = 0;
    }
    $PRINCIPAL = str_replace("{NUM_RECONOCIMIENTOS}", $num_reconocimientos, $PRINCIPAL);
    $PRINCIPAL = str_replace("{NUM_GRACIAS}", $num_gracias, $PRINCIPAL);
    $PRINCIPAL = str_replace("{LMS_NUM_PREGUNTAS_PENDIENTES}", $total_no_respondidas, $PRINCIPAL);
    $PRINCIPAL = str_replace("{LMS_NUM_PREGUNTAS_REALIZADOS}", $total_respondidas, $PRINCIPAL);
    return ($PRINCIPAL);
}

function Busca_Cursos_historicos($PRINCIPAL, $id_empresa, $rut)
{
    $cursos_historicos = VistaCursosHistoricosData($rut, $id_empresa);
    // print_r($cursos_historicos);
    foreach($cursos_historicos as $unico) {
        if ($unico->estado == "APROBADO") {
            $estado_curso = "<span class='label label-sm label-success'> Aprobado </span>";
            $txt_estado = "APROBADO";
        }
        elseif ($unico->estado <> "APROBADO" and $unico->avance2 > 0 and $unico->avance2 < 100) {
            $txt_estado = "EN_PROCESO";
            $estado_curso = "<span class='label label-sm label-warning'> En Proceso </span>";
        }
        elseif ($unico->estado <> "APROBADO" and $unico->avance2 > 0 and $unico->avance2 < 100) {
            $txt_estado = "EN_PROCESO";
            $estado_curso = "<span class='label label-sm label-warning'> En Proceso </span>";
        }
        else {
            $txt_estado = "REPROBADO";
            $estado_curso = "";
        }
        if ($unico->modalidad == "1") {
            $modalidad = "Elearning";
        }
        else {
            $modalidad = "Presencial";
        }
        if ($unico->avance <> '') {
            $avance = $unico->avance . "%";
        }
        else {
            if ($unico->avance2 <> '') {
                $avance = $unico->avance2 . "%";
            }
            else {
                $avance = "-";
            }
        }
        if ($unico->nota <> '') {
            $nota = $unico->nota;
        }
        else {
            if ($unico->nota2 <> '') {
                $nota = $unico->nota2;
            }
            else {
                $nota = "-";
            }
        }
        //    <td>".utf8_encode($unico->id_inscripcion)."</td>
        if ($txt_estado == "APROBADO") {
            $rows.= "<tr>
    <td style='text-transform: uppercase;'>" . utf8_encode($unico->curso) . "</td>
    <td>" . utf8_encode($modalidad) . "</td>
    <td>" . utf8_encode($unico->fecha_inicio) . "</td>
    <td>" . utf8_encode($unico->fecha_termino) . "</td>
    <td>" . utf8_encode($estado_curso) . "</td>
    <td>" . utf8_encode($avance) . "</td>
    <td>" . utf8_encode($nota) . "</td>
    <td><center><input type='checkbox' name='" . $unico->id_inscripcion . "' value='" . $unico->id_inscripcion . "'></center></td>
</tr>";
        }
        else if ($txt_estado == "EN_PROCESO") {
            $rows.= "<tr>
    <td style='text-transform: uppercase;'>" . utf8_encode($unico->curso) . "</td>
    <td>" . utf8_encode($modalidad) . "</td>
    <td>" . utf8_encode($unico->fecha_inicio) . "</td>
    <td>" . utf8_encode($unico->fecha_termino) . "</td>
    <td>" . utf8_encode($estado_curso) . "</td>
    <td>" . utf8_encode($avance) . "</td>
    <td>" . utf8_encode($nota) . "</td>
    <td></td>
</tr>";
        }
        else if ($txt_estado == "REPROBADO") {
            $rows.= "<tr>
    <td style='text-transform: uppercase;'>" . utf8_encode($unico->curso) . "</td>
    <td >" . utf8_encode($modalidad) . "</td>
    <td>" . utf8_encode($unico->fecha_inicio) . "</td>
    <td>" . utf8_encode($unico->fecha_termino) . "</td>
    <td>" . utf8_encode($estado_curso) . "</td>
    <td>" . utf8_encode($avance) . "</td>
    <td>" . utf8_encode($nota) . "</td>
    <td></td>
</tr>";
        }
        // echo "$options";
    }
    return ($rows);
}

function Busca_Certificados_Cursos_lmsReportes($PRINCIPAL, $id_empresa, $rut, $id_modalidad)
{
    $cursos_certificados = VistaCursosLmsReporte_Certificado_Data($rut, $id_empresa,$id_modalidad);
     //print_r($cursos_certificados);
    foreach($cursos_certificados as $unico) {

    if($unico->avance<>100){continue;}
    if($unico->curso==""){continue;}

     if ($unico->estado_descripcion == "APROBADO") {
            $estado_curso = "<span class='label label-sm label-success'><span class='blanco'> Aprobado </span></span>";
            $txt_estado = "APROBADO";
        }
        elseif ($unico->estado_descripcion <> "APROBADO" and $unico->avance2 > 0 and $unico->avance2 < 100) {
            $txt_estado = "EN_PROCESO";
            $estado_curso = "<span class='label label-sm label-warning'><span class='blanco'> En Proceso </span></span>";
        }
        elseif ($unico->estado_descripcion <> "APROBADO" and $unico->avance2 > 0 and $unico->avance2 < 100) {
            $txt_estado = "EN_PROCESO";
            $estado_curso = "<span class='label label-sm label-warning'><span class='blanco'> En Proceso </span></span>";
        }
        elseif ($unico->estado_descripcion =="REPROBADO") {
            $txt_estado = "REPROBADO";
            $estado_curso = "<span class='label label-sm label-danger'><span class='blanco'> Reprobado </span></span>";
        }
         elseif ($unico->estado_descripcion =="" and $unico->estado_reportes=="REPROBADO") {
            $txt_estado = "REPROBADO";
            $estado_curso = "<span class='label label-sm label-danger'><span class='blanco'> Reprobado </span></span>";
        }
       elseif ($unico->estado_descripcion =="" and $unico->estado_reportes=="APROBADO") {
            $txt_estado = "APROBADO";
            $estado_curso = "<span class='label label-sm label-success'><span class='blanco'> APROBADO </span></span>";
        }
        else {
            $txt_estado = "REPROBADO";
            $estado_curso = "";
        }
        if ($unico->modalidad == "1") {
            $modalidad = "Elearning";
        }
        elseif($unico->modalidad == "2") {
            $modalidad = "Presencial";
        }
        elseif($unico->modalidad == "3") {
            $modalidad = "Blended";
        }
        elseif($unico->modalidad == "4") {
            $modalidad = "Elearning";
        }

        if ($unico->avance <> '') {
            $avance = $unico->avance . "%";
        }
        else {
            if ($unico->avance2 <> '') {
                $avance = $unico->avance2 . "%";
            }
            else {
                $avance = "-";
            }
        }
        if ($unico->nota <> '') {
            $nota = $unico->nota;
        }
        else {
            if ($unico->nota2 <> '') {
                $nota = $unico->nota2;
            }
            else {
                $nota = "-";
            }
        }



        $fecha=$unico->fecha_Curso_Id_Inscripcion;


        if($fecha==""){
                 $fecha=$unico->fecha_Curso_Id_Inscripcion;

        }
        if($fecha==""){
                 $fecha=$unico->fecha_Curso_Id_Inscripcion_respuestas;

        }

if($id_empresa=="61"){

        if ($txt_estado == "APROBADO") {
            $rows.= "<tr>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'> <i class='fas fa-angle-right'></i> " . utf8_encode($unico->programa) . " " . utf8_encode($unico->curso) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($modalidad) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($fecha) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($estado_curso) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'><center>" . utf8_encode($avance) . "</center></td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($nota) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'><center><input type='checkbox' name='" . $unico->id_inscripcion . "' value='" . $unico->id_inscripcion . "'></center></td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'><center><a href='?sw=lms_diploma_curso_generico&rut_enc=".Encodear3($rut)."&text_curso=".Encodear3($unico->curso)."&pdf=1' target='_blank' class='btn btn-info'><span class='blanco'>Ver Diploma</span></a></td>
</tr>";
        }
        else if ($txt_estado == "EN_PROCESO") {
            $rows.= "<tr>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'> <i class='fas fa-angle-right'></i> " . utf8_encode($unico->curso) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($modalidad) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($fecha) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($estado_curso) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'><center>" . utf8_encode($avance) . "</center></td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($nota) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'></td>
    <td></td>
</tr>";
        }
        else if ($txt_estado == "REPROBADO") {
            $rows.= "<tr>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'> <i class='fas fa-angle-right'></i> " . utf8_encode($unico->curso) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($modalidad) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($fecha) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($estado_curso) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'><center>" . utf8_encode($avance) . "</center></td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($nota) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'></td>
    <td></td>
</tr>";
        }
     }

else if($id_empresa=="75"){

        if ($txt_estado == "APROBADO") {
            $rows.= "<tr>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'> <i class='fas fa-angle-right'></i> " . utf8_encode($unico->curso) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($modalidad) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($fecha) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($estado_curso) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'><center>" . utf8_encode($avance) . "</center></td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($nota) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'><center><a href='?sw=lms_diploma_curso_generico&rut_enc=".Encodear3($rut)."&text_curso=".Encodear3($unico->curso)."&text_curso2=".Encodear3($unico->nota)."&text_curso3=".Encodear3($nota)."&pdf=1' target='_blank' class='btn btn-info'><span class='blanco'>Ver Diploma</span></a></td>
</tr>";
        }
        else if ($txt_estado == "EN_PROCESO") {
            $rows.= "<tr>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'> <i class='fas fa-angle-right'></i> " . utf8_encode($unico->curso) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($modalidad) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($fecha) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($estado_curso) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'><center>" . utf8_encode($avance) . "</center></td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($nota) . "</td>

    <td></td>
</tr>";
        }
        else if ($txt_estado == "REPROBADO") {
            $rows.= "<tr>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'> <i class='fas fa-angle-right'></i> " . utf8_encode($unico->curso) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($modalidad) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($fecha) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($estado_curso) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'><center>" . utf8_encode($avance) . "</center></td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($nota) . "</td>

    <td></td>
</tr>";
        }

}   else {
        //    <td>".utf8_encode($unico->id_inscripcion)."</td>
        if ($txt_estado == "APROBADO") {
            $rows.= "<tr>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'> <i class='fas fa-angle-right'></i> " . utf8_encode($unico->curso) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($modalidad) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($fecha) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($estado_curso) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'><center>" . utf8_encode($avance) . "</center></td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($nota) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'><center><input type='checkbox' name='" . $unico->id_inscripcion . "' value='" . $unico->id_inscripcion . "'></center></td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'><center><a href='?sw=lms_diploma_curso_generico&rut_enc=".Encodear3($rut)."&text_curso=".Encodear3($unico->curso)."&text_curso2=".Encodear3($unico->nota)."&text_curso3=".Encodear3($nota)."&pdf=1' target='_blank' class='btn btn-info'><span class='blanco'>Ver Diploma</span></a></td>

</tr>";
        }
        else if ($txt_estado == "EN_PROCESO") {
            $rows.= "<tr>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'> <i class='fas fa-angle-right'></i> " . utf8_encode($unico->curso) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($modalidad) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($fecha) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($estado_curso) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'><center>" . utf8_encode($avance) . "</center></td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($nota) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'></td>
<td></td></tr>";
        }
        else if ($txt_estado == "REPROBADO") {
            $rows.= "<tr>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'> <i class='fas fa-angle-right'></i> " . utf8_encode($unico->curso) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($modalidad) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($fecha) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($estado_curso) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'><center>" . utf8_encode($avance) . "</center></td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'>" . utf8_encode($nota) . "</td>
    <td style='text-transform: uppercase; padding: 10px; vertical-align: middle;'></td>
<td></td></tr>";
        }
        // echo "$options";

        }
    }
    return ($rows);
}



function BacBus_FILTRO_TIPO($PRINCIPAL, $id_empresa, $dato)
{
    if ($dato <> '') {
        $options .= "<option value='" . $dato . "'>" . utf8_encode($dato) . "</option>";
    }
    $options .= "<option value=''>Todos</option>";
    $options .= "<option value='BAC'>IRP</option>";
    $options .= "<option value='BUS'>IRU</option>";
    $options .= "<option value='DCR'>IRA</option>";
    return ($options);
}
function BacBus_FILTRO_ESTADO($PRINCIPAL, $id_empresa, $dato)
{
    if ($dato <> '') {
        $options .= "<option value='" . $dato . "'>" . utf8_encode($dato) . "</option>";
    }
    $options .= "<option value=''>Todos</option>";
    $options .= "<option value='Sin Iniciar'>Sin Iniciar</option>";
    $options .= "<option value='En Proceso'>En Proceso</option>";
    $options .= "<option value='Demora'>Demora</option>";
    $options .= "<option value='Cerrada'>Cerrada</option>";
    return ($options);
}
function BacBus_FILTRO_CUI($PRINCIPAL, $id_empresa, $dato)
{
    if ($dato <> '') {
        $options .= "<option value='" . $dato . "'>" . utf8_encode($dato) . "</option>";
    }
    $options .= "<option value=''>Todos</option>";
    $dash_id_gerencias = BAC_buscaCuiAgrupado($id_empresa);
    foreach ($dash_id_gerencias as $unico) {
        $options .= "<option value='" . $unico->id_cui_col . "'>" . utf8_encode($unico->id_cui_col) . "</option>";
    }
    //echo "$options";
    return ($options);
}
function Dashboard_Full_filtro_gerencia($PRINCIPAL, $id_empresa, $id_gerencia)
{
    $buscadato_seleccionado = dash_buscadatocampo('dato10', 'dato138', $id_gerencia, $id_empresa);
    $options .= "<option value='" . $buscadato_seleccionado[0]->campo2 . "'>" . utf8_encode($buscadato_seleccionado[0]->campo) . "</option>";
    $dash_id_gerencias = dash_busca_id_gerencia($id_empresa);
    foreach ($dash_id_gerencias as $unico) {
        $options .= "<option value='" . $unico->dato138 . "'>" . utf8_encode($unico->dato10) . "</option>";
    }
    //echo "$options";
    return ($options);
}
function Dashboard_Full_filtro_departamento($PRINCIPAL, $id_empresa, $id_departamento)
{
    $buscadato_seleccionado = dash_buscadatocampo('dato7', 'dato9', $id_departamento, $id_empresa);
    $options .= "<option value='" . $buscadato_seleccionado[0]->campo2 . "'>" . utf8_encode($buscadato_seleccionado[0]->campo) . "</option>";
    $dash_id_gerencias = dash_busca_id_departamento($id_empresa);
    foreach ($dash_id_gerencias as $unico) {
        $options .= "<option value='" . $unico->dato9 . "'>" . utf8_encode($unico->dato7) . "</option>";
    }
    return ($options);
}
function Dashboard_Full_filtro_zona($PRINCIPAL, $id_empresa, $id_zona)
{
    $buscadato_seleccionado = dash_buscadatocampo('dato12', 'dato13', $id_zona, $id_empresa);
    $options .= "<option value='" . $buscadato_seleccionado[0]->campo2 . "'>" . utf8_encode($buscadato_seleccionado[0]->campo) . "</option>";
    $dash_id_gerencias = dash_busca_id_zona($id_empresa);
    foreach ($dash_id_gerencias as $unico) {
        $options .= "<option value='" . $unico->dato13 . "'>" . utf8_encode($unico->dato12) . "</option>";
    }
    //echo "$options";
    return ($options);
}

function Dashboard_Full_filtro_zona_depto($PRINCIPAL, $id_empresa)
{
    $buscadato_seleccionado = dash_busca_zona_depto($id_empresa);
    $options .= "<option value=''>Todos</option>";
    foreach ($buscadato_seleccionado as $unico) {
        $options .= "<option value='" . $unico->campo . "'>" . utf8_encode($unico->campo) . "</option>";
    }
  //  echo "$options";
    return ($options);
}


function Dashboard_Full_filtro_dotacion_gerencia($PRINCIPAL, $id_empresa, $id_gerencia, $id_departamento, $id_zona)
{
    $dash_dotaciones = dash_busca_dotacion($id_gerencia, $id_departamento, $id_zona, $id_empresa);
    return ($dash_dotaciones);
}
function colocarColaboradoresPorRutConDatos_lms_liderBK($PRINCIPAL, $id_empresa, $rut)
{
    $listado_colaboradores = TotalUsuariosPorRutJefe($rut);
    foreach ($listado_colaboradores as $unico) {
        $row .= file_get_contents("views/mi_equipo_lider/" . $id_empresa . "_row_equipo_resumen.html");
        $datos_mallapersona = buscamalla($unico->rut, $id_empresa);
        $datos_mallapersona[0]->id_malla;
        $datos_malla        = DatosMalla($datos_mallapersona[0]->id_malla);
        $datos_consolidados = TienePuntosConsolidadosPorMalla($unico->rut, $id_empresa, $datos_mallapersona[0]->id_malla);
        $row                = str_replace("{PUNTOS}", $datos_consolidados[0]->puntos, $row);
        $promedio_trivias   = PromedioTrivias($unico->rut, $id_empresa);
        if (!$promedio_trivias[0]->promedio_trivias) {
            $row = str_replace("{PROMEDIO}", "0", $row);
        } else {
            $row = str_replace("{PROMEDIO}", round($promedio_trivias[0]->promedio_trivias), $row);
        }
        if ($promedio_trivias[0]->promedio_trivias > 0) {
            $row = str_replace("{PODERES}", "<img src='img/61_rf_badges_5.png' width='20'>", $row);
        } else {
            $row = str_replace("{PODERES}", "", $row);
        }
        $medallas = "";
        for ($k = 1; $k <= $datos_consolidados[0]->medallas; $k++) {
            $medallas .= "<img src='img/rf_medal.png'>";
        }
        //$row = str_replace("{MEDALLAS}",$datos_consolidados[0]->medallas,$row);
        $row = str_replace("{MEDALLAS}", $medallas, $row);
        $row = str_replace("{NOMBRE}", $unico->nombre . " " . $unico->apaterno . " " . $unico->amaterno, $row);
        $row = str_replace("{CARGO}", $unico->cargo, $row);
        $row = str_replace("{FECHA_CUMPLEANOS}", formatearFecha($unico->fecha_nacimiento), $row);
        $row = str_replace("{URL_PERSONA}", VerificaFotoPersonal($unico->rut), $row);
        $row = str_replace("{RUT_ENCODEADO}", Encodear3($unico->rut), $row);
        $row = str_replace("{MALLA}", ($datos_malla[0]->nombre), $row);
        $row = str_replace("{RUT_COL}", ($unico->rut), $row);
        list($total_inscripciones, $total_aprobados, $total_reprobados, $total_en_proceso) = CAPACITACION_DatosGeneralesPorUsuario($unico->rut);
        $estado                           = EntregaEstadoAvanceBarraMalla(EntregaPorcentaje($total_inscripciones, $total_aprobados));
        $listado_colaborador_sub          = TotalUsuariosPorRutJefe($unico->rut);
        $num_reportes_sub                 = count($listado_colaborador_sub);
        $accion                           = Lms_Busca_Acciones_Pendientes($rut, $unico->rut, $id_empresa);
        $preguntaspendientes              = Lms_Busca_Preguntas_Pendientes($rut, $unico->rut, $id_empresa);
        //echo "<pre>";
        //print_r($preguntaspendientes);
        $row                              = str_replace("{ACCION}", ($accion), $row);
        $row                              = str_replace("{PREGUNTAS}", ($preguntaspendientes), $row);
        $avance                           = round(EntregaPorcentaje($total_inscripciones, $total_aprobados));
        //    echo "<br>$avance";
        $acumulador_avance_colaboradores  = $acumulador_avance_colaboradores + EntregaPorcentaje($total_inscripciones, $total_aprobados);
        $PRINCIPAL                        = str_replace("{NUMERO_AVANCE}", round(EntregaPorcentaje($total_inscripciones, $total_aprobados)), $PRINCIPAL);
        $PRINCIPAL                        = str_replace("{COLOR_PROGRESS_BAR}", $estado[0], $PRINCIPAL);
        $row                              = str_replace("{AVANCE_COLABORADOR}", EntregaPorcentaje($total_inscripciones, $total_aprobados), $row);
        //$total_visitas=TotalVisitasDadoRutCaseEmpresaFront($unico->rut, $id_empresa, "home_minvest");
        $row                              = str_replace("{NUM_VISITAS_COLABORADOR}", $total_visitas[0]->total_visitas, $row);
        $acumulador_visitas_colaboradores = $acumulador_visitas_colaboradores + $total_visitas[0]->total_visitas;
        $cuenta_colaborador++;
        $preguntasPendiente       = Lms_Cuenta_Preguntas_Pendientes_data($unico->rut, $id_empresa);
        $num_preguntas_pendientes = $preguntasPendiente[0]->pendientes + $num_preguntas_pendientes;
        //print_r($preguntasPendiente);
        //echo "<br>num_preguntas_pendientes $num_preguntas_pendientes";
        $num_preguntas_realizadas = $preguntasPendiente[0]->realizadas + $num_preguntas_realizadas;
    }
    $accionesPendiente          = Lms_Cuenta_Acciones_Pendientes_data_lider($rut, $id_empresa);
    $num_acciones_pendientes    = $accionesPendiente[0]->pendientes;
    $num_acciones_realizadas    = $accionesPendiente[0]->realizadas;
    //echo "cuentacolaborador $cuenta_colaborador, nun acciones $num_acciones_pendientes, $num_acciones_realizadas";
    //echo "100*$acumulador_avance_colaboradores/$cuenta_colaborador";
    $sum_verde                  = round(100 * $num_acciones_realizadas / $cuenta_colaborador);
    $sum_amarillo               = 0;
    $sum_rojo                   = round(100 * $num_acciones_pendientes / $cuenta_colaborador);
    $sum_avanceequipo           = round($acumulador_avance_colaboradores / $cuenta_colaborador);
    $lms_avance_equipo          = $sum_avanceequipo;
    $lms_graf_acciones_rojo     = $sum_rojo;
    $lms_graf_acciones_amarillo = $sum_amarillo;
    $lms_graf_acciones_verde    = $sum_verde;
    $PRINCIPAL                  = str_replace("{NUM_PERSONAS_MI_EQUIPO}", count($listado_colaboradores), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{PROMEDIO_EQUIPO}", round($acumulador_avance_colaboradores / count($listado_colaboradores)), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{NUM_VISITAS_MI_EQUIPO}", $acumulador_visitas_colaboradores, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{BLOQUE_COLABORADORES}", utf8_encode($row), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{LMS_GRAFICO_1COLOR}", file_get_contents("views/mi_equipo_lms/" . $id_empresa . "_barra_1color.html"), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{LMS_AVANCEEQUIPO}", $lms_avance_equipo, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{LMS_GRAFICO_3COLORES}", file_get_contents("views/mi_equipo_lms/" . $id_empresa . "_barra_3colores.html"), $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{VALUEVERDE}", $lms_graf_acciones_verde, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{VALUEAMARILLO}", $lms_graf_acciones_amarillo, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{VALUEROJO}", $lms_graf_acciones_rojo, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{LMS_NUM_PENDIENTES}", $num_acciones_pendientes, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{LMS_NUM_REALIZADOS}", $num_acciones_realizadas, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{LMS_NUM_PREGUNTAS_PENDIENTES}", $num_preguntas_pendientes, $PRINCIPAL);
    $PRINCIPAL                  = str_replace("{LMS_NUM_PREGUNTAS_REALIZADOS}", $num_preguntas_realizadas, $PRINCIPAL);
    return ($PRINCIPAL);
}
function Lms_Busca_Acciones_PendientesBK($rut, $rut_colaborador, $id_empresa)
{
    $Busca_pendientes = Lms_Busca_Acciones_Pendientes_data($rut, $rut_colaborador, $id_empresa);
    if ($Busca_pendientes[0]->estado === "0") {
        $objeto    = $Busca_pendientes[0]->nombre_objeto;
        $curso     = $Busca_pendientes[0]->nombrecurso;
        $fecha     = $Busca_pendientes[0]->fecha;
        $id_objeto = $Busca_pendientes[0]->id_objeto;
        if ($Busca_pendientes[0]->inscripcion_curso == 1) {
            $accion            = utf8_decode(file_get_contents("views/mi_equipo_lms/" . $id_empresa . "_jefe_boton_inscripcion_pendiente.html"));
            $accion            = str_replace("{RUT_COLABORADOR_ENCODEADO}", Encodear3($rut_colaborador), $accion);
            $accion            = str_replace("{ID_ACCION_PENDIENTE}", $Busca_pendientes[0]->id, $accion);
            $accion            = str_replace("{ID_CURSO_ENCODEADO}", Encodear3($Busca_pendientes[0]->id_curso), $accion);
            $accion            = str_replace("{CODIGO_INSCRIPCION}", Encodear3($Busca_pendientes[0]->codigo_inscripcion), $accion);
            $accion            = str_replace("{FECHA}", ($Busca_pendientes[0]->fecha), $accion);
            $datos_curso       = ListaCursosDisponibleYDatosPorCursoInscripcion($rut_colaborador, $id_empresa, $Busca_pendientes[0]->id_curso, $Busca_pendientes[0]->codigo_inscripcion);
            $accion            = str_replace("{NOMBRE_CURSO}", ($datos_curso[0]->nombre_curso), $accion);
            $accion            = str_replace("{IMAGEN_CURSO}", $datos_curso[0]->imagen_curso, $accion);
            $fecha_inicio      = $datos_curso[0]->fecha_inicio;
            $dia               = date('d', strtotime($datos_curso[0]->fecha_inicio));
            $mes               = date('m', strtotime($datos_curso[0]->fecha_inicio));
            $mestxt            = mes_3letras($mes);
            $num_inscritos     = $datos_curso[0]->Inscritos;
            $num_preinscritos  = $datos_curso[0]->Preinscritos;
            $num_listaespera   = $datos_curso[0]->ListaEspera;
            $cupos_inscritos   = $num_inscritos + $num_preinscritos;
            $cupos_espera      = $num_listaespera;
            $cupos_disponibles = $datos_curso[0]->cupos - $cupos_inscritos;
            if ($cupos_disponibles <= 0) {
                $cupos_disponibles = 0;
            }
            if ($cupos_disponibles > 0) {
                $texto_inscripcion = "Cupos Disponibles";
                $link_icono        = '<i class="fas fa-check-square"></i>';
                $label             = "label-success";
                $boton_llamada     = "btn btn-success";
                $texto_llamada     = "Postular";
            }
            if ($cupos_disponibles <= 0) {
                $texto_inscripcion = "No hay Cupos, S?lo lista Espera";
                $link_icono        = '<i class="icon-calendar-empty"></i>';
                $label             = "label-warning";
                $boton_llamada     = "btn btn-warning";
                $texto_llamada     = "Dejarme en Lista de Espera";
            }
            $accion = str_replace("{ID}", $datos_curso[0]->id, $accion);
            $accion = str_replace("{DIA}", $dia, $accion);
            $accion = str_replace("{MES}", $mestxt, $accion);
            $accion = str_replace("{CUPOS}", $ListaCurso->cupos, $accion);
            $accion = str_replace("{HORARIO}", $datos_curso[0]->comentarios, $accion);
            $accion = str_replace("{CUPOSINSCRIPCIONES}", $cupos_inscritos, $accion);
            $accion = str_replace("{CUPOSDISPONIBLES}", $cupos_disponibles, $accion);
            $accion = str_replace("{LABEL_INSCRIPCION}", $label, $accion);
            $accion = str_replace("{TEXTO_INSCRIPCION}", $texto_inscripcion, $accion);
            $accion = str_replace("{LINK_INSCRIPCION}", $cupos_inscritos, $accion);
            $accion = str_replace("{LINK_ICONO}", $link_icono, $accion);
            $accion = str_replace("{LINK_LLAMADA}", $texto_llamada, $accion);
            $accion = str_replace("{LINK_MODAL_CURSO}", $cupos_inscritos, $accion);
            $accion = str_replace("{BOTON_LLAMADA}", $boton_llamada, $accion);
            $accion = str_replace("{HORAINICIO}", $datos_curso[0]->horainicio, $accion);
            $accion = str_replace("{HORATERMINADA}", $datos_curso[0]->horatermino, $accion);
            $accion = str_replace("{DIRECCION}", $datos_curso[0]->direccion, $accion);
            $accion = str_replace("{DESCRIPCION}", utf8_encode($datos_curso[0]->descripcion), $accion);
            $accion = str_replace("{DESCRIPTOR}", utf8_encode($datos_curso[0]->descriptor), $accion);
            $accion = str_replace("{ACERCADE}", utf8_encode($datos_curso[0]->acercade), $accion);
            $accion = str_replace("{OBJETIVO_CURSO}", utf8_encode($datos_curso[0]->objetivo_curso), $accion);
        } else {
            $accion = "
                        <div class='col1'>
                                <div class='cont'>
                                    <div class='cont-col1'>
                                        <div class='label label-sm label-danger'>
                                            <i class='fa fa-bolt'></i>
                                        </div>
                                    </div>
                                    <div class='cont-col2'>
                                        <div class='desc'> $objeto<br>$curso
                                       <a href='?sw=contenido&i=" . Encodear3($id_objeto) . "&rc=" . Encodear3($rut_colaborador) . "&checkin=1'> <span class='btn btn-info'> Realizar Tarea1
                                                <i class='fa fa-share'></i>
                                            </span>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                        </div>
                            <div class='col2'>
                                <div class='date'> $fecha </div>
                            </div>
        ";
        }
    } else {
        $accion == "";
    }
    return $accion;
}
function Lms_Busca_Acciones_Pendientes($rut, $rut_colaborador, $id_empresa)
{
    //$Busca_pendientes=Lms_Busca_Acciones_Pendientes_data($rut, $rut_colaborador, $id_empresa);
    $Busca_pendientes = Lms_Busca_Acciones_Pendientes_dataVistaAgente($rut, $rut_colaborador, $id_empresa);
    //if($Busca_pendientes[0]->estado==="0")    {
    if ($Busca_pendientes[0]->estado === "1") {
        $objeto    = $Busca_pendientes[0]->nombre_objeto;
        $curso     = $Busca_pendientes[0]->nombrecurso;
        $fecha     = $Busca_pendientes[0]->fecha;
        $id_objeto = $Busca_pendientes[0]->id_objeto;
        if ($Busca_pendientes[0]->inscripcion_curso == 1) {
            $accion            = utf8_decode(file_get_contents("views/mi_equipo_lms/" . $id_empresa . "_jefe_boton_inscripcion_pendiente.html"));
            $accion            = str_replace("{RUT_COLABORADOR_ENCODEADO}", Encodear3($rut_colaborador), $accion);
            $accion            = str_replace("{ID_ACCION_PENDIENTE}", $Busca_pendientes[0]->id, $accion);
            $accion            = str_replace("{ID_CURSO_ENCODEADO}", Encodear3($Busca_pendientes[0]->id_curso), $accion);
            $accion            = str_replace("{CODIGO_INSCRIPCION}", Encodear3($Busca_pendientes[0]->codigo_inscripcion), $accion);
            $accion            = str_replace("{FECHA}", ($Busca_pendientes[0]->fecha), $accion);
            $datos_curso       = ListaCursosDisponibleYDatosPorCursoInscripcion($rut_colaborador, $id_empresa, $Busca_pendientes[0]->id_curso, $Busca_pendientes[0]->codigo_inscripcion);
            $accion            = str_replace("{NOMBRE_CURSO}", ($datos_curso[0]->nombre_curso), $accion);
            $accion            = str_replace("{IMAGEN_CURSO}", $datos_curso[0]->imagen_curso, $accion);
            $fecha_inicio      = $datos_curso[0]->fecha_inicio;
            $dia               = date('d', strtotime($datos_curso[0]->fecha_inicio));
            $mes               = date('m', strtotime($datos_curso[0]->fecha_inicio));
            $mestxt            = mes_3letras($mes);
            $num_inscritos     = $datos_curso[0]->Inscritos;
            $num_preinscritos  = $datos_curso[0]->Preinscritos;
            $num_listaespera   = $datos_curso[0]->ListaEspera;
            $cupos_inscritos   = $num_inscritos + $num_preinscritos;
            $cupos_espera      = $num_listaespera;
            $cupos_disponibles = $datos_curso[0]->cupos - $cupos_inscritos;
            if ($cupos_disponibles <= 0) {
                $cupos_disponibles = 0;
            }
            if ($cupos_disponibles > 0) {
                $texto_inscripcion = "Cupos Disponibles";
                $link_icono        = '<i class="fas fa-check-square"></i>';
                $label             = "label-success";
                $boton_llamada     = "btn btn-success";
                $texto_llamada     = "Postular";
            }
            if ($cupos_disponibles <= 0) {
                $texto_inscripcion = "No hay Cupos, S?lo lista Espera";
                $link_icono        = '<i class="icon-calendar-empty"></i>';
                $label             = "label-warning";
                $boton_llamada     = "btn btn-warning";
                $texto_llamada     = "Dejarme en Lista de Espera";
            }
            $accion = str_replace("{ID}", $datos_curso[0]->id, $accion);
            $accion = str_replace("{DIA}", $dia, $accion);
            $accion = str_replace("{MES}", $mestxt, $accion);
            $accion = str_replace("{CUPOS}", $ListaCurso->cupos, $accion);
            $accion = str_replace("{HORARIO}", $datos_curso[0]->comentarios, $accion);
            $accion = str_replace("{CUPOSINSCRIPCIONES}", $cupos_inscritos, $accion);
            $accion = str_replace("{CUPOSDISPONIBLES}", $cupos_disponibles, $accion);
            $accion = str_replace("{LABEL_INSCRIPCION}", $label, $accion);
            $accion = str_replace("{TEXTO_INSCRIPCION}", $texto_inscripcion, $accion);
            $accion = str_replace("{LINK_INSCRIPCION}", $cupos_inscritos, $accion);
            $accion = str_replace("{LINK_ICONO}", $link_icono, $accion);
            $accion = str_replace("{LINK_LLAMADA}", $texto_llamada, $accion);
            $accion = str_replace("{LINK_MODAL_CURSO}", $cupos_inscritos, $accion);
            $accion = str_replace("{BOTON_LLAMADA}", $boton_llamada, $accion);
            $accion = str_replace("{HORAINICIO}", $datos_curso[0]->horainicio, $accion);
            $accion = str_replace("{HORATERMINADA}", $datos_curso[0]->horatermino, $accion);
            $accion = str_replace("{DIRECCION}", $datos_curso[0]->direccion, $accion);
            $accion = str_replace("{DESCRIPCION}", utf8_encode($datos_curso[0]->descripcion), $accion);
            $accion = str_replace("{DESCRIPTOR}", utf8_encode($datos_curso[0]->descriptor), $accion);
            $accion = str_replace("{ACERCADE}", utf8_encode($datos_curso[0]->acercade), $accion);
            $accion = str_replace("{OBJETIVO_CURSO}", utf8_encode($datos_curso[0]->objetivo_curso), $accion);
        } else {
            $accionBK1           = "
                        <div class='col1'>
                                <div class='cont'>
                                    <div class='cont-col1'>
                                        <div class='label label-sm label-danger'>
                                            <i class='fa fa-bolt'></i>
                                        </div>
                                    </div>
                                    <div class='cont-col2'>
                                        <div class='desc'> $objeto<br>$curso
                                       <a href='?sw=contenido&i=" . Encodear3($id_objeto) . "&rc=" . Encodear3($rut_colaborador) . "&checkin=1'> <span class='btn btn-info'> Ver Desafios
                                                <i class='fa fa-share'></i>
                                            </span>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                        </div>
                            <div class='col2'>
                                <div class='date'> $fecha </div>
                            </div>
        ";
            $accionBK2           = "
                        <div class='col1'>
                                <div class='cont'>
                                    <div class='cont-col1'>
                                        <div class='label label-sm label-danger'>
                                            <i class='fa fa-bolt'></i>
                                        </div>
                                    </div>
                                    <div class='cont-col2'>
                                        <div class='desc'> $objeto<br>$curso
                                       <a href='?sw=malla_resumen&i=" . Encodear3($id_objeto) . "&rutenc=" . Encodear3($rut_colaborador) . "&checkin=1'> <span class='btn btn-info'> Ver Desafios
                                                <i class='fa fa-share'></i>
                                            </span>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                        </div>
                            <div class='col2'>
                                <div class='date'> $fecha </div>
                            </div>
        ";
            $accion              = file_get_contents("views/mi_equipo_lms/" . $id_empresa . "_boton_ver_desafios.html");
            $desafios_pendientes = utf8_decode(ColocaNotificacionesBannerJefe($rut, $id_empresa, $rut_colaborador));
            if ($desafios_pendientes) {
                $accion = str_replace("{BLOQUE_CANTIDAD_DESAFIOS_PENDIENTES}", file_get_contents("views/home/index_bci_capacitacionbci20_entorno_alertas.html"), $accion);
                $accion = str_replace("{BLOQUE_BANNER_NOTIFICACIONES}", "", $accion);
                $accion = str_replace("{BLOQUE_BANNER_NOTIFICACIONES_JEFE}", $desafios_pendientes, $accion);
            } else {
                $accion = str_replace("{BLOQUE_CANTIDAD_DESAFIOS_PENDIENTES}", "", $accion);
            }
            $accion = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($id_objeto), $accion);
            $accion = str_replace("{FECHA_}", $fecha, $accion);
            $accion = str_replace("{RUT_COLABORADOR_ENCODADO}", Encodear3($rut_colaborador), $accion);
        }
    } else {
        $accion == "";
    }
    return $accion;
}
function Lms_Busca_Preguntas_Pendientes($rut, $rut_colaborador, $id_empresa)
{
    $Busca_pendientes_pregunta = Lms_Busca_Preguntas_Pendientes_data($rut, $rut_colaborador, $id_empresa);
    if ($Busca_pendientes_pregunta[0]->estado === "0") {
        $pregunta = $Busca_pendientes[0]->mensaje;
        $id       = $Busca_pendientes[0]->id;
        $accion   = "
                        <div class='col1'>
                                <div class='cont'>
                                    <div class='cont-col1'>
                                        <div class='label label-sm label-danger'>
                                            <i class='fa fa-bolt'></i>
                                        </div>
                                    </div>
                                    <div class='cont-col2'>
                                        <div class='desc'> $objeto<br>$curso
                                       <a href='?sw=home_mensajeria&i=" . Encodear3($id_objeto) . "&rc=" . Encodear3($rut_colaborador) . "&checkin=1&jefe=1&ragente=" . Encodear3($rut) . "'> <span class='btn btn-info'> Responder Pregunta
                                                <i class='fa fa-share'></i>
                                            </span>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                        </div>
                            <div class='col2'>
                                <div class='date'> $fecha </div>
                            </div>
        ";
        $accion   = file_get_contents("views/mi_equipo_lms/" . $id_empresa . "_boton_ver_preguntas.html");
        $accion   = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($id_objeto), $accion);
        $accion   = str_replace("{RUT_COLABORADOR_ENCODEADO}", Encodear3($rut_colaborador), $accion);
        $accion   = str_replace("{RUT_AGENTE_ENCODEADO}", Encodear3($rut), $accion);
        $accion   = str_replace("{FECHA_}", ($fecha), $accion);
    } else {
        $accion == "";
    }
    return $accion;
}
function Lms_Busca_Preguntas_PendientesBK($rut, $rut_colaborador, $id_empresa)
{
    $Busca_pendientes_pregunta = Lms_Busca_Preguntas_Pendientes_data($rut, $rut_colaborador, $id_empresa);
    if ($Busca_pendientes_pregunta[0]->estado === "0") {
        $pregunta = $Busca_pendientes[0]->mensaje;
        $id       = $Busca_pendientes[0]->id;
        $accion   = "
                        <div class='col1'>
                                <div class='cont'>
                                    <div class='cont-col1'>
                                        <div class='label label-sm label-danger'>
                                            <i class='fa fa-bolt'></i>
                                        </div>
                                    </div>
                                    <div class='cont-col2'>
                                        <div class='desc'> $objeto<br>$curso
                                       <a href='?sw=home_mensajeria&i=" . Encodear3($id_objeto) . "&rc=" . Encodear3($rut_colaborador) . "&checkin=1&jefe=1&ragente=" . Encodear3($rut) . "'> <span class='btn btn-info'> Responder Pregunta
                                                <i class='fa fa-share'></i>
                                            </span>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                        </div>
                            <div class='col2'>
                                <div class='date'> $fecha </div>
                            </div>
        ";
    } else {
        $accion == "";
    }
    return $accion;
}
function conectaBaseMinvest()
{
    $serverName     = "AGRRHH"; //serverName\instanceName
    $connectionInfo = array(
        "Database" => "Intranet",
        "UID" => "usr_intranet",
        "PWD" => "1ntr4n3t.2016"
    );
    $conn           = sqlsrv_connect($serverName, $connectionInfo);
    if ($conn) {
        echo "Conexi?n establecida.<br />";
    } else {
        echo "Conexi?n no se pudo establecer.<br />";
        die(print_r(sqlsrv_errors(), true));
    }
}
function ColocaIndicadoresVarios($PRINCIPAL)
{
    //$xmlSource = "http://indicadoresdeldia.cl/webservice/indicadores.xml";
    //$xml = simplexml_load_file($xmlSource);
    /*
    echo $xml->santoral->ayer;
    echo $xml->santoral->hoy;
    echo $xml->santoral->maniana;
    echo $xml->moneda->dolar;
    echo $xml->moneda->euro;
    echo $xml->moneda->dolar_clp; //Dolar interbancario
    echo $xml->indicador->ivp;
    echo $xml->indicador->uf;
    echo $xml->indicador->ipc;
    echo $xml->indicador->utm;
    echo $xml->indicador->imacec;
    echo $xml->bolsa->ipsa;
    echo $xml->bolsa->igpa;
    echo $xml->bolsa->banca;
    echo $xml->bolsa->commodities;
    echo $xml->bolsa->retail;
    echo $xml->bolsa->consumo;
    echo $xml->bolsa->utilities;
    */
    //Traigo los indicadores del dia
    $indicadores_del_dia = TraeIndicadoresDelDia();
    $PRINCIPAL           = str_replace("{VALOR_UF}", $indicadores_del_dia[0]->uf, $PRINCIPAL);
    $PRINCIPAL           = str_replace("{VALOR_DOLAR}", $indicadores_del_dia[0]->dolar, $PRINCIPAL);
    $PRINCIPAL           = str_replace("{VALOR_UTM}", $indicadores_del_dia[0]->utm, $PRINCIPAL);
    $PRINCIPAL           = str_replace("{VALOR_IVP}", $indicadores_del_dia[0]->ivp, $PRINCIPAL);
    $PRINCIPAL           = str_replace("{VALOR_IPC}", $indicadores_del_dia[0]->ipc, $PRINCIPAL);
    $PRINCIPAL           = str_replace("{SANTORAL_DIA}", $indicadores_del_dia[0]->santoral_hoy, $PRINCIPAL);
    return ($PRINCIPAL);
}
function ListadoColaboradoresObjetivos($html, $evaluador, $rut_evaluado, $id_bitacora, $sgd_version, $id_proceso)
{
    $evaluados                     = TraeRelacionesSinAe($evaluador, $id_proceso);
    $total_html                    = file_get_contents("views/sgd/bitacora/entorno_bloque_principal_chilquinta.html");
    $row_template                  = file_get_contents("views/sgd/listado_colaboradores/row_colaboradores_objetivo.html");
    $row                           = "";
    $ok_finalizado                 = 0;
    $html                          = str_replace("{SECCION_EQUIPO_CONSOLIDADO}", file_get_contents("views/sgd/bitacora/vista_consolidada_equipo.html"), $html);
    $html                          = str_replace("{GRAFICO}", file_get_contents("views/sgd/graficos/graficoBarraBitacora.html"), $html);
    $total_positivas_por_evaluador = 0;
    $total_negativas_por_evaluador = 0;
    foreach ($evaluados as $evaluado) {
        $row .= $row_template;
        $objetivos_validados_por_validador = VerificaSiObjetivosEstanValidados($evaluado->evaluado);
        //$row=FormularioIngresaObjetivos($row, $evaluado->evaluado, $evaluador);
        $row                               = ColocaDatosUsuario($row, $evaluado->evaluado, "bitacora");
        $row                               = str_replace("{BOTON_BITACORA}", file_get_contents("views/sgd/listado_colaboradores/boton_ingresa_objetivos.html"), $row);
        //$valores_objetivos=ListadoObjetivosAValidar($evaluado->evaluado, $evaluador, $id_objetivo, "jefe");
        $valores_objetivos                 = ListadoIngresoBitacoras($evaluado->evaluado, $evaluador, $id_bitacora, "jefe");
        $row                               = str_replace("{LISTADO_OBJETIVOS_A_EVALUAR}", $valores_objetivos, $row);
        $row                               = str_replace("{ID_PROCESO_ENCODEADO}", Encodear3($id_proceso), $row);
        $ponderaciones_bases               = DevuelvePonderacionesPorEvaluado($evaluado->evaluado);
        $verifica_evaluado_validado        = VerificaSiObjetivosEstanAjustados($evaluado->evaluado);
        if ($rut_evaluado == $evaluado->evaluado) {
            $row = str_replace("{FORMULARIO_INGRESO}", file_get_contents("views/sgd/objetivos/formulario.html"), $row);
            $row = str_replace("{OPTIONS_VALORES}", OptionsGenericoNombreDadoValoresPorEmpresa("tbl_bitacora_valores", "", "valor", "id", "order by valor asc", $_SESSION["id_empresa"]), $row);
        } else {
            $row = str_replace("{FORMULARIO_INGRESO}", "", $row);
        }
        $row                           = str_replace("{RUT_ENCODEADO}", Encodear3($evaluado->evaluado), $row);
        $row                           = str_replace("{RUT_EVALUADO}", ($evaluado->evaluado), $row);
        //Veo cuantas posotivas y cuantas negativas tiene
        $positivas                     = VerificaBitacorasPositivasNegativas($evaluado->evaluado, "si");
        $negativas                     = VerificaBitacorasPositivasNegativas($evaluado->evaluado, "no");
        $row                           = str_replace("{X_POSITIVAS}", count($positivas), $row);
        $row                           = str_replace("{X_NEGATIVAS}", count($negativas), $row);
        $total_positivas_por_evaluador = $total_positivas_por_evaluador + count($positivas);
        $total_negativas_por_evaluador = $total_negativas_por_evaluador + count($negativas);
        $row                           = str_replace("{CANTIDAD}", count($positivas) + count($negativas), $row);
        $row                           = str_replace("{BOTON_JEFE_VALIDA_OBJETIVOS}", "", $row);
        $row                           = str_replace("{TOTAL_SUMA_PONDERACION}", $valores_objetivos[1], $row);
        $row                           = str_replace("{PONDERACION_OBJETIVOS_INDIVIDUALES}", $ponderaciones_bases[2], $row);
        if ($valores_objetivos[1] == $ponderaciones_bases[2]) {
            $row = str_replace("{OK}", "OK", $row);
        } else {
            $row = str_replace("{OK}", "", $row);
        }
        $row = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($evaluado->evaluado), $row);
        if ($valores_objetivos[1] == $ponderaciones_bases[2]) {
            $ok_finalizado++;
        }
        //ACA veo si es que tiene comentarios de rechazo
        $comentarios           = ObtenerObjetivosDeRechazoUltimo($evaluado->evaluado);
        $comentarios_validador = "";
        foreach ($comentarios as $com) {
            $comentarios_validador .= $com->comentario . "<br>";
        }
        $row = str_replace("{COMENTARIOS_VALIDADOR}", $comentarios_validador, $row);
    }
    $total_total = ($total_negativas_por_evaluador + $total_positivas_por_evaluador);
    $html        = str_replace("{TOTAL_POSITIVAS}", ColocaDecimalesNotasFinales(0, ($total_positivas_por_evaluador * 100) / $total_total), $html);
    $html        = str_replace("{TOTAL_NEGATIVAS}", ColocaDecimalesNotasFinales(0, ($total_negativas_por_evaluador * 100) / $total_total), $html);
    $html        = str_replace("{TOTAL_POR_EVALUADOR}", $total_total, $html);
    $html        = str_replace("{TOTAL_EVALUADOR_POSITIVAS}", ($total_positivas_por_evaluador), $html);
    $html        = str_replace("{TOTAL_EVALUADOR_NEGATIVAS}", ($total_negativas_por_evaluador), $html);
    $total_html  = str_replace("{LISTADO_COLABORADORES}", ($row), $total_html);
    $html        = str_replace("{ENTORNO_LISTADO_EVALUACION}", ($total_html), $html);
    return ($html);
}
function EntregaEstadoAvanceBarraMalla($valor)
{
    if ($valor < 50) {
        $arreglo[0] = "etiquetaPrograma-reprobado";
    } else if ($valor < 75) {
        $arreglo[0] = "etiquetaPrograma-proceso";
    } else if ($valor >= 75) {
        $arreglo[0] = "etiquetaPrograma-aprobado";
    }
    return ($arreglo);
}
function EntregaPorcentaje($total, $valor)
{
    return (FormatearPorcentajes(($valor * 100) / $total));
}
function ColocaDatosCampusPuntos($PRINCIPAL, $rut, $id_empresa, $tipo_llamada, $filtro_desde_admin)
{
    //La variable tipo_llamada, se utiliza para cuando se llama desde el administrador
    $puntos = 0;
    //echo "<br><br>2724 ColocaDatosCampusPuntos tipo llamada $tipo_llamada, $filtro_desde_Admin";
    $datos  = GAMIFICACIONTienePuntosAcumuladosPorRutEmpresa($rut, $id_empresa, $filtro_desde_admin);
    //print_r($datos); exit();
    if ($datos[0]->avatar) {
        if ($id_empresa == '59' or $id_empresa == '75' or $id_empresa == '22') {
            $PRINCIPAL = str_replace("{URL_PERSONA}", "" . $datos[0]->avatar, $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{URL_PERSONA}", "img/avatars/$id_empresa/" . $datos[0]->avatar, $PRINCIPAL);
        }
    } else {
        $PRINCIPAL = str_replace("{URL_PERSONA}", VerificaFotoPersonal($rut), $PRINCIPAL);
    }
    for ($tot = 1; $tot <= $datos[0]->medallas; $tot++) {
        //$html_medallas.="<img src='img/".$datos[0]->imagenmedalla."'>";
        $imagen_medalla = $datos[0]->imagenmedalla;
        if ($imagen_medalla == "") {
            $imagen_medalla_array = buscaimagenmedallamalla($rut, $id_empresa);
            $imagen_medalla       = $imagen_medalla_array[0]->imagenmedallamalla;
            $html_medallas .= "<img src='img/$imagen_medalla' width='24' height='24'>";
        } else {
            $html_medallas .= "<img src='img/$imagen_medalla'  width='24' height='24'>";
        }
    }
    $PRINCIPAL = str_replace("{IMAGENMEDALLAS}", $html_medallas, $PRINCIPAL);
    if ($datos[0]->puntosconsolidados === 0 or $datos[0]->puntosconsolidados > 0) {
        $puntos = $datos[0]->puntosconsolidados;
    }
    if ($puntos === 0 and $datos[0]->puntos > 0) {
        $puntos = $datos[0]->puntos;
    }
    //$PRINCIPAL = str_replace("{PUNTOS}",$datos[0]->puntos,$PRINCIPAL);
    //$PRINCIPAL = str_replace("{PUNTOS}",$datos[0]->puntosconsolidados,$PRINCIPAL);
    $PRINCIPAL     = str_replace("{PUNTOS}", $puntos, $PRINCIPAL);
    $PRINCIPAL     = str_replace("{NUMNIVEL}", $datos[0]->numnivel, $PRINCIPAL);
    $PRINCIPAL     = str_replace("{NOMBRENIVELPERSONA}", $datos[0]->descripcion_nivel, $PRINCIPAL);
    $PRINCIPAL     = str_replace("{DESCRIPCIONNIVEL}", utf8_encode($datos[0]->texto_descripcion_nivel), $PRINCIPAL);
    $PRINCIPAL     = str_replace("{TEXTOACCION}", utf8_encode($datos[0]->textoaccion), $PRINCIPAL);
    $PRINCIPAL     = str_replace("{IMAGENNIVEL}", utf8_encode($datos[0]->imagenmiperfil), $PRINCIPAL);
    $PRINCIPAL     = str_replace("{RANKING}", "-", $PRINCIPAL);
    $PRINCIPAL     = str_replace("{MEDALLAS}", $datos[0]->medallas, $PRINCIPAL);
    $PRINCIPAL     = str_replace("{CAMPO1}", utf8_encode($datos[0]->campo1), $PRINCIPAL);
    $PRINCIPAL     = str_replace("{CAMPO2}", $datos[0]->campo2, $PRINCIPAL);
    $PRINCIPAL     = str_replace("{CAMPO3}", $datos[0]->campo3, $PRINCIPAL);
    $PRINCIPAL     = str_replace("{CAMPO4}", $datos[0]->campo4, $PRINCIPAL);
    $PRINCIPAL     = str_replace("{EMAIL}", $datos[0]->email, $PRINCIPAL);
    //echo "rut $rut, c3".$datos[0]->campo3." c4 ".$datos[0]->campo4;
    $PRINCIPAL     = str_replace("{RUT_EVALUADO}", $rut, $PRINCIPAL);
    $PRINCIPAL     = str_replace("{NOMBRE_COMPLETO}", utf8_encode($datos[0]->nombre_completo), $PRINCIPAL);
    $PRINCIPAL     = str_replace("{RUT_COMPLETO_EVALUADO}", $datos[0]->rut_completo_evaluado, $PRINCIPAL);
    $PRINCIPAL     = str_replace("{PORCENTAJE_BARRA_NIVEL}", $datos[0]->porcentajebarranivel, $PRINCIPAL);
    $PRINCIPAL     = str_replace("{NUMDESAFIOS}", $datos[0]->total_objetos_por_curso_actual - $datos[0]->totalobjetos_finalizados, $PRINCIPAL);
    $PRINCIPAL     = str_replace("{CARGO}", utf8_encode($datos[0]->cargo_usuario), $PRINCIPAL);
    $total_avatars = GAMIFICACION_AvatarsPorEmpresa($id_empresa);
    $cont_rows     = 0;
    foreach ($total_avatars as $avatar) {
        $cont_rows++;
        $total_avatars_html .= file_get_contents("views/cursos/capacitacion/row_avatar.html");
        $total_avatars_html = str_replace("{NOMBRE_ARCHIVO}", $avatar->nombre_archivo, $total_avatars_html);
        $total_avatars_html = str_replace("{CARPETA_AVATARS}", $id_empresa, $total_avatars_html);
        $total_avatars_html = str_replace("{ID_AVATAR}", $avatar->nombre_archivo, $total_avatars_html);
        $total_avatars_html = str_replace("{ID}", $avatar->id, $total_avatars_html);
        if ($cont_rows == 2) {
            $total_avatars_html .= "<div class='row'></div>";
            $cont_rows = 0;
        } else {
            $cont_rows++;
        }
    }
    $PRINCIPAL    = str_replace("{ID_EMPRESA}", $id_empresa, $PRINCIPAL);
    $PRINCIPAL    = str_replace("{ROWS_AVATARS}", $total_avatars_html, $PRINCIPAL);
    //Aca traigo el listado de los puntos
    $total_puntos = GAMIFICACIONTotalPuntosPorObjetoDadoRutEmpresa($rut, $id_empresa);
    foreach ($total_puntos as $pun) {
        $row_por_puntos .= file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_mi_perfil_row_puntos_por_objeto.html");
        $row_por_puntos = str_replace("{MODULO}", utf8_encode($pun->titulo), $row_por_puntos);
        $row_por_puntos = str_replace("{TOTAL_PUNTOS}", $pun->puntos, $row_por_puntos);
        $row_por_puntos = str_replace("{FECHA}", formatearFechaSmall($pun->fecha), $row_por_puntos);
        if ($pun->rut_autor_megusta) {
            //$row_por_puntos = str_replace("{MEGUSTA_ROW}","+1 ".$pun->nombre_autor_megusta,$row_por_puntos);
            $row_por_puntos = str_replace("{MEGUSTA_ROW}", "<br>Me Gusta", $row_por_puntos);
        } else {
            $row_por_puntos = str_replace("{MEGUSTA_ROW}", "", $row_por_puntos);
        }
        $imagen_medalla = "";
        $html_medallas  = "";
        for ($tott = 1; $tott <= $pun->medallas; $tott++) {
            //$html_medallas.="<img src='img/".$datos[0]->imagenmedalla."'>";
            $imagen_medalla = $datos[0]->imagenmedalla;
            if ($imagen_medalla == "") {
                //echo "hola";
                $imagen_medalla_array = buscaimagenmedallamalla($rut, $id_empresa);
                $imagen_medalla       = $imagen_medalla_array[0]->imagenmedallamalla;
                $html_medallas .= "<img src='img/$imagen_medalla'>";
            } else {
                $html_medallas .= "<img src='img/$imagen_medalla'>";
            }
        }
        if ($html_medallas) {
            $row_por_puntos = str_replace("{MEDALLA_ROW}", "<br>" . $html_medallas, $row_por_puntos);
        } else {
            $row_por_puntos = str_replace("{MEDALLA_ROW}", "", $row_por_puntos);
        }
    }
    $PRINCIPAL = str_replace("{LISTADO_DETALLE_PUNTOS}", $row_por_puntos, $PRINCIPAL);
    //print_r($datos);exit();
    if ($tipo_llamada == "admin") {
        //Rut Completo Usuario
        $arreglo[0] = $datos[0]->rut_completo_evaluado;
        //Nombre Completo
        $arreglo[1] = utf8_encode($datos[0]->nombre_completo);
        //CARGO
        $arreglo[2] = utf8_encode($datos[0]->cargo_usuario);
        //Campo 1
        $arreglo[3] = utf8_encode($datos[0]->campo1);
        //Campo 2
        $arreglo[4] = utf8_encode($datos[0]->campo2);
        //Campo 3
        $arreglo[5] = utf8_encode($datos[0]->campo3);
        //Puntos
        //$arreglo[6]=$datos[0]->puntosconsolidados;
        $arreglo[6] = $puntos;
        //Medallas
        $arreglo[7] = $datos[0]->medallas;
        if ($datos[0]->ingresocurso > 0) {
            $ingreso = 1;
        } else {
            $ingreso = 0;
        }
        $arreglo[8]  = $ingreso;
        $arreglo[9]  = utf8_encode($datos[0]->email_usuario);
        $arreglo[10] = utf8_encode($datos[0]->campo4);
        //    print_r($arreglo);
        return ($arreglo);
        //return($PRINCIPAL);
    } else {
        return ($PRINCIPAL);
    }
}


function ColocaDatosMallaCapacitacion($PRINCIPAL, $rut, $id_empresa, $id_clasificacion, $tipo_llamada, $filtro_desde_admin, $opcional, $tipo_reporte_desde_admin, $id_malla)
{


// echo "<br />coloca datos $rut, $id_empresa, $id_clasificacion, $tipo_llamada, $filtro_desde_admin, $opcional, $tipo_reporte_desde_admin, malla $id_malla";
// echo "<br />ColocaDatosMallaCapacitacion<br />";
// La variable, Tipo de Llamada, es para ver si es que es llamada desde
// admin o desde el front
// La variable $filtro_Desde_Admin, es para cuando se ejecuta desde el administrador, y se filtra por curso la queri
// echo "<br />ColocaDatosMallaCapacitacion rut $rut, tipollamada $tipo_llamada, filtro $filtro_desde_admin, opcional $opcional, id_clasificacion $id_clasificacion, id malla $id_malla";
$datos_empresa = DatosEmpresa($id_empresa);
// COMENTADO 22022018
// list($total_inscripciones, $total_aprobados, $total_reprobados, $total_en_proceso) = CAPACITACION_DatosGeneralesPorUsuario($rut, $filtro_desde_admin);
$PRINCIPAL      = str_replace("{BLOQUE_DATOS_PERSONALES}", file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_mi_perfil_bloque_datos.html") , $PRINCIPAL);
$datos_malla    = CAPACITACION_malla_porUsuario($rut, $id_malla, $id_empresa);
//print_r($datos_malla);
// GAMIFICACION_ActualizaNivel($datos_malla[0]->id_malla, $id_empresa, $rut);
$datos_puntos_acumulados = GAMIFICACIONTienePuntosAcumuladosPorRutEmpresa($rut, $id_empresa, $filtro_desde_admin);
$nivel_actual   = $datos_puntos_acumulados[0]->numnivel;
$estado         = EntregaEstadoAvanceBarraMalla(EntregaPorcentaje($total_inscripciones, $total_aprobados));
if (!$tipo_llamada) {
    // $PRINCIPAL=ColocarRankingUsuariosPorPuntos($PRINCIPAL, $id_empresa,$datos_malla[0]->id_malla);
}
// print_r($datos_malla);
// Funcionalidad para Asignar Niveles  a Cursos
if ($tipo_llamada) {
    $datos_usuario_para_admin = ColocaDatosCampusPuntos($PRINCIPAL, $rut, $id_empresa, $tipo_llamada, $filtro_desde_admin);
}
else {
    $PRINCIPAL = ColocaDatosCampusPuntos($PRINCIPAL, $rut, $id_empresa, $tipo_llamada, "");
}
if ($datos_malla) {
    /*if($id_empresa==52){
    }else{
    $PRINCIPAL = str_replace("{BLOQUE_TITULO_MALLA}",file_get_contents("views/cursos/capacitacion/titulo_nombre_malla.html"),$PRINCIPAL);
    }*/
    if ($id_clasificacion) {
        if (file_exists("views/cursos/capacitacion/" . $id_empresa . "_titulo_nombre_malla.html")) {
            $PRINCIPAL = str_replace("{BLOQUE_TITULO_MALLA}", file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_titulo_nombre_malla.html") , $PRINCIPAL);
        }
        else {
            $PRINCIPAL = str_replace("{BLOQUE_TITULO_MALLA}", file_get_contents("views/cursos/capacitacion/titulo_nombre_malla.html") , $PRINCIPAL);
        }
        // $PRINCIPAL = str_replace("{BLOQUE_TITULO_MALLA}",file_get_contents("views/cursos/capacitacion/".$id_empresa."_titulo_nombre_malla.html"),$PRINCIPAL);
    }
    else {
        if (file_exists("views/cursos/capacitacion/" . $id_empresa . "_titulo_nombre_malla_sin_imagen.html")) {
            $PRINCIPAL = str_replace("{BLOQUE_TITULO_MALLA}", file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_titulo_nombre_malla_sin_imagen.html") , $PRINCIPAL);
        }
        else {
            $PRINCIPAL = str_replace("{BLOQUE_TITULO_MALLA}", file_get_contents("views/cursos/capacitacion/titulo_nombre_malla_sin_imagen.html") , $PRINCIPAL);
        }
    }
    if (!$id_clasificacion) {
        $PRINCIPAL = str_replace("{DESCRIPCION_CLASIFICACION}", utf8_encode($datos_malla[0]->descripcion_malla) , $PRINCIPAL);
    }
    $PRINCIPAL = str_replace("{NOMBRE_MALLA}", utf8_encode($datos_malla[0]->nombre_malla) , $PRINCIPAL);
    $datos_clasificacion_unica = DatosClasificacionPorCurso($id_clasificacion, $id_empresa);
    $PRINCIPAL = str_replace("{NOMBRE_CLASIFICACION}", utf8_encode($datos_clasificacion_unica[0]->nombre_clasificacion) , $PRINCIPAL);
    $PRINCIPAL = str_replace("{DESCRIPCION__MALLA}", $datos_malla[0]->descripcion_malla, $PRINCIPAL);
    $PRINCIPAL = str_replace("{BLOQUE_CURSOS_PENDIENTES}", BloqueCursosPendientes(file_get_contents("views/cursos/capacitacion/titulo_cursos_pendientes_malla.html") , $rut, $datos_malla->id_malla) , $PRINCIPAL);
    if (file_exists("views/cursos/capacitacion/" . $id_empresa . "_titulo_avance_malla.html")) {
        $PRINCIPAL = str_replace("{BLOQUE_AVANCE_MALLA}", file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_titulo_avance_malla.html") , $PRINCIPAL);
    }
    else {
        $PRINCIPAL = str_replace("{BLOQUE_AVANCE_MALLA}", file_get_contents("views/cursos/capacitacion/titulo_avance_malla.html") , $PRINCIPAL);
    }
    $PRINCIPAL = OtrosCursosRealizados($PRINCIPAL, $rut, $datos_malla[0]->id_malla);
}
else {
    $PRINCIPAL = str_replace("{BLOQUE_TITULO_MALLA}", "", $PRINCIPAL);
    $PRINCIPAL = str_replace("{BLOQUE_CURSOS_PENDIENTES}", "", $PRINCIPAL);
    $PRINCIPAL = str_replace("{BLOQUE_AVANCE_MALLA}", "", $PRINCIPAL);
    // $PRINCIPAL = str_replace("{BLOQUE_OTROS_CURSOS_REALIZADOS}",file_get_contents("views/cursos/capacitacion/titulo_otros_cursos_realizados_malla.html"),$PRINCIPAL);
    $PRINCIPAL = OtrosCursosRealizados($PRINCIPAL, $rut, $datos_malla[0]->id_malla);
}
$porcentaje_avance_por_usuario = 0;
$PRINCIPAL = str_replace("{NUMERO_AVANCE}", round(EntregaPorcentaje($total_inscripciones, $total_aprobados)) , $PRINCIPAL);
$porcentaje_avance_por_usuario = $datos_puntos_acumulados[0]->avanceobjetos;
// echo "<br />108091 $porcentaje_avance_por_usuario";
// si no tiene avance por objetos ve si hay avance por curso
if ($porcentaje_avance_por_usuario == 0) {
    $porcentaje_avance_por_usuario = 100 * $datos_puntos_acumulados[0]->avancecurso;
}
// echo "<br />hol";
// echo "<br />108092 $porcentaje_avance_por_usuario";
// echo "<br /><br />";
//    print_r($datos_puntos_acumulados);
// echo "<br /><br />";
$PRINCIPAL = str_replace("{COLOR_PROGRESS_BAR}", $estado[0], $PRINCIPAL);
$PRINCIPAL = str_replace("{TOTAL_APROBADOS}", $total_aprobados, $PRINCIPAL);
$PRINCIPAL = str_replace("{TOTAL_REPROBADOS}", $total_reprobados, $PRINCIPAL);
$PRINCIPAL = str_replace("{TOTAL_EN_PROCESO}", $total_en_proceso, $PRINCIPAL);
$PRINCIPAL = str_replace("{TOTAL_NO_INICIADOS}", $total_inscripciones - ($total_aprobados + $total_reprobados + $total_en_proceso) , $PRINCIPAL);
// TRaigo la malla del usuario
$codigo_malla = $datos_malla[0]->id_malla;
// echo "<br />codigo_malla $codigo_malla";
// Con el id malla, traigo las clasificaciones
// $clasificaciones=CAPACITACION_clasificacionesPorMallaRut($rut, $codigo_malla);
// Voy a  pasar el id de clasificacion, esto es para cuando se quiere mostrar solo los cursos de una clasificacion.
// echo "<br />opcional $opcional";
if ($tipo_reporte_desde_admin <> "detallado") {
    if ($opcional == 1) {
        // echo "1.1";
        // exit;
        $clasificaciones = CAPACITACION_clasificacionesPorMallaClasificacionOpcional($codigo_malla, $id_empresa, $id_clasificacion);
    }
    else {
       // echo "1.2"; ;
        $clasificaciones = CAPACITACION_clasificacionesPorMalla($codigo_malla, $id_empresa, $id_clasificacion);
    }
    if (count($clasificaciones) == 0) {
       // echo "1.3";
        $clasificaciones = CAPACITACION_clasificacionesPorInscripcionUsuario($rut, $id_clasificacion);
    }
}
if ($tipo_reporte_desde_admin <> "detallado") {
    $total_clasificaciones = "";
    $i = 0;
    $numero_cursos_total = 0;
    $PRINCIPAL = str_replace("{NUM_CLASIFICACIONES}", count($clasificaciones) , $PRINCIPAL);
    $clasificaciones_entorno = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_programas_capacitacion.html");
    $curso_entorno = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_cursos_por_programas_capacitacion.html");
    $classrow = 3;
    $avance_clasificaciones_entorno = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_avance_clasificacion.html");
    if (count($clasificaciones) == 1) {
        if ($datos_malla[0]->template_malla) {
            $template_malla = "_" . $datos_malla[0]->template_malla;
        }
        else {
            $template_malla = "";
        }
        $clasificaciones_entorno = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_programas_capacitacion_unico" . $template_malla . ".html");
        $curso_entorno = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_cursos_por_programas_capacitacion_unico" . $template_malla . ".html");
        $PRINCIPAL = str_replace("{DESCRIPCION_CLASIFICACION}", utf8_encode($clasificaciones[0]->descripcion_clasificacion) , $PRINCIPAL);
        $PRINCIPAL = str_replace("{IMAGEN_CLASIFICACION}", utf8_encode($clasificaciones[0]->imagen) , $PRINCIPAL);
        $PRINCIPAL = str_replace("{COLOR_CLASIFICACION}", utf8_encode($clasificaciones[0]->color) , $PRINCIPAL);
    }
    if ($id_clasificacion) {
        // echo "<br />pilates";
        // echo "<br />template  $template_malla";
        $clasificaciones_entorno = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_programas_capacitacion_unico" . $template_malla . ".html");
        $curso_entorno = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_cursos_por_programas_capacitacion_unico" . $template_malla . ".html");
        $avance_clasificaciones_entorno = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_avance_clasificacion.html");
    }
}
if ($tipo_reporte_desde_admin <> "detallado") {
    $con_row = 1;
    $contador_arreglo_clasificaciones = 0;
    // print_r($clasificaciones);
    foreach($clasificaciones as $cla) {
        // echo "<br />cla pilta";
        // $html_cla=file_get_contents("views/cursos/row_programas_capacitacion.html");
        $html_cla = $clasificaciones_entorno;
        $avance_cla = $avance_clasificaciones_entorno;
        // $html_cla = str_replace("{ID_CLASIFICACION}",$cla->clasificacion,$html_cla);
        // print_r($cla);
        if ($cla->inactivo == 1) {
            $html_cla = str_replace("{LINK}", "", $html_cla);
            $html_cla = str_replace("{CLASSIMGBCK}", "img_bn_grasycale", $html_cla);
        }
        else {
            $html_cla = str_replace("{LINK}", "<a href='?sw=CurXClas&icl={ID_CLASIFICACION_ENCODEADO}'>", $html_cla);
            $html_cla = str_replace("{CLASSIMGBCK}", "", $html_cla);
        }
        $html_cla = str_replace("{LINK}", $cla->id_clasificacion, $html_cla);
        $html_cla = str_replace("{CLASSIMGBCK}", $cla->id_clasificacion, $html_cla);
        $html_cla = str_replace("{ID_CLASIFICACION}", $cla->id_clasificacion, $html_cla);
        $html_cla = str_replace("{ID_CLASIFICACION_ENCODEADO}", Encodear3($cla->id_clasificacion) , $html_cla);
        $avance_cla = str_replace("{ID_CLASIFICACION}", $cla->id_clasificacion, $avance_cla);
        $avance_cla = str_replace("{ID_CLASIFICACION_ENCODEADO}", Encodear3($cla->id_clasificacion) , $avance_cla);
        $html_cla = str_replace("{NOMBRE_CLASIFICACION}", $cla->nombre_clasificacion, $html_cla);
        $html_cla = str_replace("{DESCRIPCION_CLASIFICACION}", $cla->descripcion_clasificacion, $html_cla);
        $html_cla = str_replace("{IMAGEN_NIVEL_CLASIFICACION}", $cla->imagennivel, $html_cla);
        $html_cla = str_replace("{TEXTO_NIVEL_CLASIFICACION}", $cla->textonivel, $html_cla);
        $html_cla = str_replace("{DESCRIPCION_NIVEL_CLASIFICACION}", $cla->descripcionnivel, $html_cla);
        $html_cla = str_replace("{COLOR2}", $cla->color2, $html_cla);
        $html_cla = str_replace("{COLOR}", $cla->color, $html_cla);
        $html_cla = str_replace("{IMAGEN_BACK}", $cla->imagen_back, $html_cla);
        $html_cla = str_replace("{IMAGEN}", $cla->imagen, $html_cla);
        // Por cada clasificacion, traigo los cursos
        // $cursos_por_clasificacion=CAPACITACION_cursosPorClasificacion($rut, $codigo_malla, $cla->id_clasificacion);
        // $cursos_por_clasificacion_desde_malla=CAPACITACION_cursosPorClasificacionMalla($codigo_malla, $cla->clasificacion, $filtro_desde_admin);
        $cursos_por_clasificacion_desde_malla = CAPACITACION_cursosPorClasificacionMalla($codigo_malla, $cla->id_clasificacion, $filtro_desde_admin);
        // $avance_cursos_por_clasificacion_desde_malla=CAPACITACION_cursosPorClasificacionMalla($codigo_malla, $cla->id_clasificacion, $filtro_desde_admin);
        // echo "<br />".count($cursos_por_clasificacion_desde_malla);
        if (count($cursos_por_clasificacion_desde_malla) == 0) {
            $cursos_por_clasificacion_desde_malla = CAPACITACION_cursosPorClasificacionRut($rut, $cla->id_clasificacion);
        }
        // echo "<br />".count($cursos_por_clasificacion_desde_malla);
        // exit();
        // print_R($cursos_por_clasificacion_desde_malla);
        // echo "aca";
        $html_cla = str_replace("{CANTIDAD_CURSOS}", count($cursos_por_clasificacion) , $html_cla);
        $html_cla = str_replace("{CANTIDAD_CURSOS_MALLA}", count($cursos_por_clasificacion_desde_malla) , $html_cla);
        $total_cursos = "";
        $cantidad_cursos_aprobados_por_clasificacion = 0;
        foreach($cursos_por_clasificacion as $curso_unico) {
            $numero_cursos_total_up++;
        }
        foreach($cursos_por_clasificacion_desde_malla as $curso_unico) {
            $numero_cursos_total_desdemalla_up++;
        }
        // echo  "<br /> cursos_por_clasificacion ".count($cursos_por_clasificacion). " , cursos_por_clasificacion_desde_malla ".count($cursos_por_clasificacion_desde_malla);
        if (count($cursos_por_clasificacion) >= count($cursos_por_clasificacion_desde_malla)) {
            // si num cursos es inferior a inscripciones
            $contador_div_rows = 1;
            foreach($cursos_por_clasificacion as $curso_unico) {
                $numero_cursos_total++;
                // $row_curso=file_get_contents("views/cursos/row_cursos_por_programas_capacitacion.html");
                // echo $curso_unico->id_curso."<br />";
                $row_curso = $curso_entorno;
                $row_curso = str_replace("{ID_CURSO}", $curso_unico->id_curso, $row_curso);
                $row_curso = str_replace("{NOMBRE_CURSO}", $curso_unico->nombre_curso, $row_curso);
                $row_curso = str_replace("{FECHA_INICIO}", $curso_unico->fecha_inicio_insc, $row_curso);
                $row_curso = str_replace("{IMAGEN}", $curso_unico->imagen, $row_curso);
                $row_curso = str_replace("{DESCRIPCION_CURSO}", $curso_unico->descripcion_curso, $row_curso);
                $row_curso = str_replace("{DESCRIPTOR_CURSO}", $curso_unico->descriptor_curso, $row_curso);
                $row_curso = str_replace("{FECHA_TERMINO}", $curso_unico->fecha_termino_insc, $row_curso);
                $row_curso = str_replace("{ASISTENCIA}", $curso_unico->porcentaje_asistencia, $row_curso);
                if ($curso_unico->proveedor_curso == "OL") {
                    // $tiempo     = time();
                    // print_r($curso_unico);   //echo "<br /><br />";
                    // $id_curso_test="13HY13"; //echo "$rut - $tiempo - ".$curso_unico->codigo_curso." - ".$curso_unico->nombre_curso."<br />";
                    // $string_var = encryptMoodleAula($rut . "||" . $tiempo . "||" . $curso_unico->codigo_curso, "");
                    // $string_var=encryptMoodleAula($rut."||".$tiempo."||".$id_curso_test, "");
                    // echo $string_var."<br />";
                    // $string_var = encryptMoodleAula($rut . "||" . $tiempo . "||" . $id_curso_test, "");
                    // print_r($curso_unico);exit;
                    // echo $string_var;exit;
                    // $row_curso  = str_replace("{LINK_CURSO}", '<a target="_blank"  href="http://aula.openl.cl/local/minvest/login.php?token=' . $string_var . '">', $row_curso);
                    // $row_curso = str_replace("{LINK_CURSO}",'<a href="javascript: alert(\'Curso Cerrado\');">',$row_curso);
                    // $row_curso  = str_replace("{/LINK_CURSO}", '</a>', $row_curso);
                }
                else if ($curso_unico->modalidad <> 2) {
                    $row_curso = str_replace("{LINK_CURSO}", '<a href="?sw=detalle_cursoCap&idc={ID_CURSO_ENCODEADO}&idinsc={ID_INSCRIPCION_ENCODEADO}">', $row_curso);
                    $row_curso = str_replace("{/LINK_CURSO}", '</a>', $row_curso);
                    $row_curso = str_replace("{LINK_CURSO_JUSTURL}", '?sw=detalle_cursoCap&idc={ID_CURSO_ENCODEADO}&idinsc={ID_INSCRIPCION_ENCODEADO}', $row_curso);
                }
                else {
                    $row_curso = str_replace("{LINK_CURSO}", "", $row_curso);
                    $row_curso = str_replace("{/LINK_CURSO}", "", $row_curso);
                }
                // $row_curso = str_replace("{ID_CURSO_ENCODEADO}",Encodear3($curso_unico->id_curso),$row_curso);
                $row_curso = str_replace("{ID_CURSO_ENCODEADO}", Encodear3($curso_unico->codigo_curso) , $row_curso);
                list($estado, $porcentaje_asistencia, $nota) = CAPACITACION_VE_ESTADO($rut, $curso_unico->codigo_curso, $curso_unico->id_inscripcion, $id_empresa);
                $estado_por_curso = CAPACITACION_ObtenerEstadoAvanceCurso($rut, $curso_unico->codigo_curso, "", $id_empresa);
                $row_curso = str_replace("{ESTADO}", $estado_por_curso[0], $row_curso);
                $row_curso = str_replace("{ESTADO}", $estado_por_curso[1], $row_curso);
                $row_curso = str_replace("{ICONO_ESTADO_CURSO}", $estado_por_curso[2], $row_curso);
                // $row_curso = str_replace("{AVANCE_CURSO}",$estado_por_curso[3],$row_curso);
                $row_curso = str_replace("{AVANCE_CURSO}", $estado_por_curso[4], $row_curso);
                $total_cursos.= $row_curso;
            }
        }
        else {
            $cantidad_cursos_por_clasificacion = 0;
            $cla_sum_avance = 0;
            // si num cursos es igual o superior a inscripciones               // echo "<br /><pre>";
            // print_r($cursos_por_clasificacion_desde_malla);
            $contador_div_rows = 1;
            foreach($cursos_por_clasificacion_desde_malla as $curso_unico) {


            if($id_empresa=="52" and $rut<>"sabad" and $rut<>"fmancilla" and $curso_unico->id_curso=="wa_desafio_91"){
               continue;
            }
//           echo "<br /><pre>";    print_r($curso_unico);
           //echo "<br>id curso ".$curso_unico->id_curso;
                ReparaInconsistenciasAvanceCurso($rut, $curso_unico->id_curso, $id_empresa);
                // modalidad 4
                if ($curso_unico->cuentaCursos > 1) {
                    //echo "<br />".$curso_unico->id_curso." CURSO >1";
                    $array_InscripcionesModalidad4 = BuscaCantidadInstanciasInscripcionUsuario($curso_unico->id_curso, $codigo_malla, $id_empresa, $rut);
                    // print_r($array_InscripcionesModalidad4);
                    foreach($array_InscripcionesModalidad4 as $unico) {
                        $estado_por_curso = CAPACITACION_ObtenerEstadoAvanceCurso($rut, $curso_unico->id_curso, $unico->id_inscripcion, $id_empresa);

                        // echo "<br>$rut, ".$curso_unico->id_curso." $id_empresa";
                        //print_r($estado_por_curso);
                        //echo "<br>";
                        // echo "<br />".$unico->id_curso." CURSO id inscripcion ".$unico->id_inscripcion;
                        $curso_entorno = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_cursos_por_programas_capacitacion_unico" . $template_malla . ".html");
                        $numero_cursos_total_desdemalla++;
                        // $row_curso=file_get_contents("views/cursos/row_cursos_por_programas_capacitacion.html");
                        $row_curso = $curso_entorno;
                        // echo "<br /><br /><br /> INACTIVO curso_unico->inactivo_curso ".$curso_unico->inactivo_curso-" or curso_unico->inactivo ".$curso_unico->inactivo;
                        if ($curso_unico->inactivo_curso == 1 or $curso_unico->inactivo == 1) {
                            //                echo "hola inactivo";
                            $row_curso = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_cursos_por_programas_capacitacion_inactivo" . $template_malla . ".html");
                            //                echo "views/cursos/capacitacion/".$id_empresa."_row_cursos_por_programas_capacitacion_inactivo".$template_malla.".html"
                        }
                        if ($curso_unico->scoid == "CERTIFICACION") {
                            $row_curso = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_cursos_por_programas_capacitacion_certificacion.html");
                        }
                        // echo "1";
                        if ($curso_unico->valortotal == "CURSO_POR_FECHAS" or $curso_unico->modalidad == "4") {
                            // echo "<br />.2";
                            $inscripcion_curso = TraigoInscripcionUsuarioPorCursoEmpresaUsuarioImparticiones($id_empresa, $rut, $curso_unico->id_curso, $unico->id_inscripcion);
                            $fecha_actual = date("Y-m-d");
                            $hora_actual = date("H:i:s");
                            // echo "hora actual $hora_actual <br />";
                            // echo $inscripcion_curso[0]->hora_inicio."<br />";
                            // echo $inscripcion_curso[0]->hora_termino."<br />";
                            // echo $inscripcion_curso[0]->fecha_inicio."<br />";
                            // echo $inscripcion_curso[0]->fecha_termino."<br />";
                            $datos_objeto = TraeObjetosPorCurso($curso_unico->id_curso, $id_empresa);
                            $respuestas_por_objeto = RespuestasDadoRutObjeto($rut, $datos_objeto[0]->id);
                            // Traigo el total de preguntas para este objeto
                            if ($datos_objeto[0]->preguntas_aleatorias > 0) {
                                // Traigo el total de preguntas desde asociacion_preguntas
                                $total_preguntas = EVALUACION_PreguntasDadoIdObjetoaleatorio($datos_objeto[0]->id, $rut);
                            }
                            else {
                                // Traigo el total de preguntas, dado el id de la evaluacion
                                $total_preguntas = EVALUACION_PreguntasDadoIdObjeto($datos_objeto[0]->id);
                            }
                            if (count($respuestas_por_objeto) > 0 && count($respuestas_por_objeto) < count($total_preguntas)) {
                                $row_curso = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_cursos_por_programas_capacitacion_unico" . $template_malla . ".html");
                                // echo $unico->id_curso;echo "<br /><br />";
                                if ($unico->id_inscripcion) {
                                    $row_curso = str_replace("{PARAMETROS_AUTOEVAL_SGD}", "ii=" . Encodear3($unico->id_inscripcion) . "", $row_curso);
                                }
                                else {
                                    $row_curso = str_replace("{PARAMETROS_AUTOEVAL_SGD}", "", $row_curso);
                                }
                            }
                            else if ($fecha_actual < $inscripcion_curso[0]->fecha_inicio) {
                                $row_curso = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_cursos_por_programas_capacitacion_unico_sin_link" . $template_malla . ".html");
                                $mensaje_objeto="";
                                $mensaje_objeto.= "<small><strong>El curso se encuentra desactivado</strong>.<br /> La fecha de aplicaci&oacute;n es el " . $inscripcion_curso[0]->fecha_inicio . " y el horario de activaci&oacute;n es entre las " . $inscripcion_curso[0]->hora_inicio . " y " . $inscripcion_curso[0]->hora_termino . "</small>
                                <br><br><div class='alert alert-danger'><center>Recuerda presionar F5 al momento que llegue la hora para activar la Certificaci&oacute;n</center></div>";

                                $row_curso = str_replace("{MENSAJE_}", $mensaje_objeto, $row_curso);
                            }
                            else if ($fecha_actual > $inscripcion_curso[0]->fecha_termino) {
                                $row_curso = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_cursos_por_programas_capacitacion_unico_sin_link" . $template_malla . ".html");
                                $mensaje_objeto="";
                                $mensaje_objeto.= "<small><strong>El curso se encuentra desactivado</strong>.<br /> La fecha de aplicaci&oacute;n es el " . $inscripcion_curso[0]->fecha_inicio . " y el horario de activaci&oacute;n es entre las " . $inscripcion_curso[0]->hora_inicio . " y " . $inscripcion_curso[0]->hora_termino . "</small>
                                <br><br><div class='alert alert-danger'><center>Recuerda presionar F5 al momento que llegue la hora para activar la Certificaci&oacute;n</center></div>";

                                $row_curso = str_replace("{MENSAJE_}", $mensaje_objeto, $row_curso);
                            }
                            else if ($fecha_actual >= $inscripcion_curso[0]->fecha_inicio && $fecha_actual <= $inscripcion_curso[0]->fecha_termino) {
                                if ($fecha_actual == $inscripcion_curso[0]->fecha_inicio and $fecha_actual <> $inscripcion_curso[0]->fecha_termino) {
                                    // echo "es hoy inicio";
                                    if ($hora_actual < $inscripcion_curso[0]->hora_inicio) {
                                        $row_curso = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_cursos_por_programas_capacitacion_unico_sin_link" . $template_malla . ".html");
                                        $mensaje_objeto="";
                                        $mensaje_objeto.= "<small><strong>El curso se encuentra desactivado</strong>.<br /> La fecha de aplicaci&oacute;n es el " . $inscripcion_curso[0]->fecha_inicio . " y el horario de activaci&oacute;n es entre las " . $inscripcion_curso[0]->hora_inicio . " y " . $inscripcion_curso[0]->hora_termino . "</small>
<br><br><div class='alert alert-danger'><center>Recuerda presionar F5 al momento que llegue la hora para activar la Certificaci&oacute;n</center></div>";
                                        $row_curso = str_replace("{MENSAJE_}", $mensaje_objeto, $row_curso);
                                    }
                                }
                                elseif ($fecha_actual == $inscripcion_curso[0]->fecha_termino and $fecha_actual <> $inscripcion_curso[0]->fecha_inicio) {
                                    if ($hora_actual > $inscripcion_curso[0]->hora_termino) {
                                        exit;
                                        $row_curso = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_cursos_por_programas_capacitacion_unico_sin_link" . $template_malla . ".html");
                                        $mensaje_objeto="";
                                        $mensaje_objeto.= "<small><strong>El curso se encuentra desactivado</strong>.<br /> La fecha de aplicaci&oacute;n es el " . $inscripcion_curso[0]->fecha_inicio . " y el horario de activaci&oacute;n es entre las " . $inscripcion_curso[0]->hora_inicio . " y " . $inscripcion_curso[0]->hora_termino . "</small>
<br><br><div class='alert alert-danger'><center>Recuerda presionar F5 al momento que llegue la hora para activar la Certificaci&oacute;n</center></div>";
                                        $row_curso = str_replace("{MENSAJE_}", $mensaje_objeto, $row_curso);
                                    }
                                }
                                elseif ($fecha_actual == $inscripcion_curso[0]->fecha_termino and $fecha_actual == $inscripcion_curso[0]->fecha_inicio) {
                                    // echo "es hoy termino e iniciohora ahora es ".$hora_actual." hora termino ".$unico->hora_termino." hora inicio".$unico->hora_inicio;
                                    if ($hora_actual > $inscripcion_curso[0]->hora_termino or $hora_actual < $inscripcion_curso[0]->hora_inicio) {
                                        $row_curso = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_cursos_por_programas_capacitacion_unico_sin_link" . $template_malla . ".html");
                                        $mensaje_objeto="";
                                        $mensaje_objeto.= "<small><strong>El curso se encuentra desactivado</strong>.<br /> La fecha de aplicaci&oacute;n es el " . $inscripcion_curso[0]->fecha_inicio . " y el horario de activaci&oacute;n es entre las " . $inscripcion_curso[0]->hora_inicio . " y " . $inscripcion_curso[0]->hora_termino . "</small>
<br><br><div class='alert alert-danger'><center>Recuerda presionar F5 al momento que llegue la hora para activar la Certificaci&oacute;n</center></div>";
                                        $row_curso = str_replace("{MENSAJE_}", $mensaje_objeto, $row_curso);
                                    }
                                }
                            }
                            else {
                                $row_curso = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_cursos_por_programas_capacitacion_unico" . $template_malla . ".html");
                            }
                            // echo $id_empresa."_row_cursos_por_programas_capacitacion_inactivo".$template_malla.".html";
                        }
                        $row_curso = str_replace("{NOMBRE_CURSO}", $curso_unico->nombre_curso . "", $row_curso);
                        $row_curso = ListadoObjetosCapacitacionCert2017($row_curso, $curso_unico->id_curso, $_SESSION["user_"], "", $unico->id_inscripcion, $id_empresa, $template_malla, $back_home, $im, $id_programa, $id_nivel);
                        $row_curso = ListadoObjetosCapacitacionSecuencial2017($row_curso, $curso_unico->id_curso, $_SESSION["user_"], "", $id_inscripcion, $id_empresa, $template_malla, $back_home, $im, $id_programa, $id_nivel);
                        if ($unico->id_inscripcion) {
                            $row_curso = str_replace("{PARAMETROS_AUTOEVAL_SGD}", "ii=" . Encodear3($unico->id_inscripcion) . "", $row_curso);
                        }
                        else {
                            $row_curso = str_replace("{PARAMETROS_AUTOEVAL_SGD}", "", $row_curso);
                        }
                        $avances_cursos = ColocaAvanceCursoPorPuntosDeObjetos($row_curso, $curso_unico->id_curso, $rut, $id_empresa);
                        $row_curso = $avances_cursos[0];
                        $row_curso = str_replace("{ID_CURSO}", $curso_unico->id_curso, $row_curso);
                        $row_curso = str_replace("{IMAGEN_BACK}", $curso_unico->imagen_back, $row_curso);
                        $row_curso = str_replace("{IMAGEN}", $curso_unico->imagen, $row_curso);
                        $row_curso = str_replace("{DESCRIPCION_CURSO}", $curso_unico->descripcion_curso, $row_curso);
                        $row_curso = str_replace("{DESCRIPTOR_CURSO}", $curso_unico->descriptor_curso, $row_curso);
                        $row_curso = str_replace("{FECHA_INICIO}", $curso_unico->fecha_inicio_insc, $row_curso);
                        $row_curso = str_replace("{FECHA_TERMINO}", $curso_unico->fecha_termino_insc, $row_curso);
                        // $row_curso = str_replace("{FECHA_TERMINO_INSC}",$curso_unico->fecha_termino,$row_curso);
                        $row_curso = str_replace("{FECHA_TERMINO_INSC}", formatearFechaSmall($curso_unico->fecha_termino) , $row_curso);
                        $row_curso = str_replace("{FECHA_INICIO_INSC}", $curso_unico->fecha_inicio, $row_curso);
                        $row_curso = str_replace("{ASISTENCIA}", $curso_unico->porcentaje_asistencia, $row_curso);
                        if ($curso_unico->modalidad <> 2) {
                            if ($curso_unico->proveedor_curso == "OL") {
                            }
                            else {
                                $row_curso = str_replace("{LINK_CURSO}", '<a href="?sw=detalle_cursoCap&idc={ID_CURSO_ENCODEADO}">', $row_curso);
                                $row_curso = str_replace("{/LINK_CURSO}", '</a>', $row_curso);
                                $row_curso = str_replace("{LINK_CURSO_JUSTURL}", '?sw=detalle_cursoCap&idc={ID_CURSO_ENCODEADO}&idinsc={ID_INSCRIPCION_ENCODEADO}', $row_curso);
                            }
                        }
                        else {
                            $row_curso = str_replace("{LINK_CURSO}", "", $row_curso);
                            $row_curso = str_replace("{/LINK_CURSO}", "", $row_curso);
                        }
                        list($estado, $porcentaje_asistencia, $nota) = CAPACITACION_VE_ESTADO($rut, $curso_unico->codigo_curso, $curso_unico->id_inscripcion, $id_empresa);
                        $row_curso = str_replace("{ID_CURSO_ENCODEADO}", Encodear3($curso_unico->id_curso) , $row_curso);
                        $row_curso = str_replace("{ID_INSCRIPCION_ENCODEADO}", Encodear3($curso_unico->id_inscripcion) , $row_curso);
                        $row_curso = str_replace("{ESTADO}", $estado_por_curso[0], $row_curso);
                        $row_curso = str_replace("{ESTADO_CON_NOTA}", $estado_por_curso[9], $row_curso);
                        $row_curso = str_replace("{ASISTENCIA}", $estado_por_curso[0], $row_curso);
                        if ($estado_por_curso[10]) {
                            $row_curso = str_replace("{PORC_ASISTENCIA}", $estado_por_curso[10] . "%", $row_curso);
                        }
                        else {
                            $row_curso = str_replace("{PORC_ASISTENCIA}", "-", $row_curso);
                        }
                        $row_curso = str_replace("{ESTADO}", $estado_por_curso[1], $row_curso);
                        if ($estado_por_curso[13]) {
                            $row_curso = str_replace("{NOTA}", $estado_por_curso[7], $row_curso);
                            $row_curso = str_replace("{NOTA_porcentaje}", "" . $estado_por_curso[7] . "%", $row_curso);
                            if ($estado_por_curso[13] == "") {
                                if ($estado_por_curso[7] <> '') {
                                    $nota_decimal = $estado_por_curso[7] . "%";
                                }
                                else {
                                    $nota_decimal = "-";
                                }
                                $row_curso = str_replace("{NOTA_porcentaje_decimales}", "" . $nota_decimal, $row_curso);
                            }
                            else {
                                if ($estado_por_curso[7] <> '') {
                                    $nota_decimal = $estado_por_curso[7] . "%";
                                }
                                else {
                                    $nota_decimal = "-";
                                }
                                $row_curso = str_replace("{NOTA_porcentaje_decimales}", "" . $nota_decimal, $row_curso);
                            }
                            $row_curso = str_replace("{AVANCE_CURSO}", ($estado_por_curso[13]) , $row_curso);
                            $row_curso = str_replace("{AVANCE_CURSO2}", ($estado_por_curso[7]) , $row_curso);
                            /*$row_curso = str_replace("{BARRA_SIN_PORCENTAJE}","<div class='progress'>
                            <div class='progress-bar progress-bar-success progress-bar-striped progress-animation'
                            role='progressbar' aria-valuenow='".$estado_por_curso[7]."' aria-valuemin='0'
                            aria-valuemax='100' style='width: ".$estado_por_curso[7]."%'></div>
                            </div>",$row_curso);*/
                            $row_curso = str_replace("{BARRA_SIN_PORCENTAJE}", "", $row_curso);
                        }
                        else {
                            if ($estado_por_curso[7] <> "") {
                                if ($estado_por_curso[7] <> '') {
                                    $nota_decimal = $estado_por_curso[7] . "%";
                                }
                                else {
                                    $nota_decimal = "-";
                                }
                                $row_curso = str_replace("{NOTA_porcentaje_decimales}", "" . $nota_decimal, $row_curso);
                            }
                            else {
                                if ($estado_por_curso[7] <> '') {
                                    $nota_decimal = $estado_por_curso[7] . "%";
                                }
                                else {
                                    $nota_decimal = "-";
                                }
                                $row_curso = str_replace("{NOTA_porcentaje_decimales}", "" . $nota_decimal, $row_curso);
                            }
                            $row_curso = str_replace("{NOTA}", "-", $row_curso);
                            $row_curso = str_replace("{NOTA_SIN_PORCENTAJE}", "-", $row_curso);
                            $row_curso = str_replace("{NOTA_porcentaje}", "", $row_curso);
                            $row_curso = str_replace("{BARRA_SIN_PORCENTAJE}", "", $row_curso);
                        }
                        if ($estado_por_curso[8]) {
                            $row_curso = str_replace("{FECHA_FIN}", $estado_por_curso[8], $row_curso);
                        }
                        else {
                            $row_curso = str_replace("{FECHA_FIN}", "-", $row_curso);
                        }
                        $row_curso = str_replace("{ICONO_ESTADO_CURSO}", $estado_por_curso[2], $row_curso);
                        // $row_curso = str_replace("{AVANCE_CURSO}",$estado_por_curso[3],$row_curso);
                        if ($curso_unico->modalidad == 2) {
                            $row_curso = str_replace("{AVANCE_CURSO}", $estado_por_curso[3], $row_curso);
                            $row_curso = str_replace("{AVANCE_CURSO2}", $estado_por_curso[3], $row_curso);
                            if ($curso_unico->opcional <> 1 and $curso_unico->inactivo <> 1) {
                                $acumula_avance_curso = $estado_por_curso[3] + $acumula_avance_curso;
                            }
                        }
                        else {
                            $row_curso = str_replace("{AVANCE_CURSO}", $estado_por_curso[4], $row_curso);
                            $row_curso = str_replace("{AVANCE_CURSO2}", $estado_por_curso[4], $row_curso);
                            if ($curso_unico->opcional <> 1 and $curso_unico->inactivo <> 1) {
                                $acumula_avance_curso = $estado_por_curso[4] + $acumula_avance_curso;
                            }
                        }
                        if ($curso_unico->opcional <> 1 and $curso_unico->inactivo <> 1) {
                            $acumula_cursos++;
                        }
                        // Funcion para colocar Avance de Curso, Tipo Ultramar, en base a los puntos de los objetos.
                        // echo  "<br />".print_r($estado_por_curso);
                        if ($estado_por_curso[6] == 1) {
                            $cantidad_cursos_aprobados_por_clasificacion++;
                        }
                        // suma avance
                        $cla_sum_avance = $cla_sum_avance + $estado_por_curso[4];
                        // echo "<pre>";
                        //    print_r($estado_por_curso);
                        $cantidad_cursos_por_clasificacion++;
                        // AVANCE GLOBAL
                        $cla_sum_avance_total = $cla_sum_avance_total + $cla_sum_avance;
                        $cla_cantidad_cursos_por_clasificacion_total = $cla_cantidad_cursos_por_clasificacion_total + $cantidad_cursos_por_clasificacion;
                        // echo $total_cursos;
                        $total_cursos.= $row_curso;
                        // echo "<br />id curso ".$curso_unico->id_curso." estado ".$estado_por_curso;
                        // print_r($estado_por_curso);
                        if ($estado_por_curso[4] >= 100) {
                            $total_cursos_aprobados.= $row_curso;
                        }
                        else {
                            $total_cursos_pendientes.= $row_curso;
                        }
                        if ($curso_unico->inactivo == "1") {
                            $total_cursos_inactivos.= $row_curso;
                        }
                        else {
                            $total_cursos_activos.= $row_curso;
                        }
                    }
                }
                else {

                //$start = microtime(true);
                    //echo "<br />".$curso_unico->id_curso." CURSO =0, fecha inicio".$curso_unico->fecha_inicio;
                    // echo "<br /><pre>";
                    // echo "<br /> template $template_malla";
                    // $estado_por_curso=CAPACITACION_ObtenerEstadoAvanceCurso($rut, $curso_unico->codigo_curso, "", $id_empresa);
                      $estado_por_curso = CAPACITACION_ObtenerEstadoAvanceCurso($rut, $curso_unico->id_curso, "", $id_empresa);
                    // print_r($estado_por_curso);echo "<br />";
                    // echo "nivel ".$nivel_actual." - ".$curso_unico->numnivel."<br /><br />";
                    // echo "rut $rut ".$curso_unico->codigo_curso.", -, ".$curso_unico->id_curso." ".$id_empresa;
                    // echo "<br /><br />";
                    // echo "<br />nivel $nivel_actual curso ".$curso_unico->numnivel;
                    // echo "1";
                    $curso_entorno = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_cursos_por_programas_capacitacion_unico" . $template_malla . ".html");
                    // echo "views/cursos/capacitacion/" . $id_empresa . "_row_cursos_por_programas_capacitacion_unico" . $template_malla . ".html";
                    //
                    // echo "hola";
                    $numero_cursos_total_desdemalla++;
                    // $row_curso=file_get_contents("views/cursos/row_cursos_por_programas_capacitacion.html");
                    $row_curso = $curso_entorno;
                    // echo "<br /><br /><br /> INACTIVO curso_unico->inactivo_curso ".$curso_unico->inactivo_curso-" or curso_unico->inactivo ".$curso_unico->inactivo;
                    if ($curso_unico->inactivo_curso == 1 or $curso_unico->inactivo == 1) {
                        //                echo "hola inactivo";
                        $row_curso = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_cursos_por_programas_capacitacion_inactivo" . $template_malla . ".html");
                        //                echo "views/cursos/capacitacion/".$id_empresa."_row_cursos_por_programas_capacitacion_inactivo".$template_malla.".html"
                    }
                    if ($curso_unico->scoid == "CERTIFICACION") {
                        $row_curso = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_cursos_por_programas_capacitacion_certificacion.html");
                    }
                    // echo "1";
                    if ($curso_unico->valortotal == "CURSO_POR_FECHAS" or $curso_unico->modalidad == "4") {
                        // echo "2";
                        $inscripcion_curso = TraigoInscripcionUsuarioPorCursoEmpresaUsuario($id_empresa, $rut, $curso_unico->id_curso);
                        $fecha_actual = date("Y-m-d");
                        $hora_actual = date("H:i:s");
                        // echo "hora actual $hora_actual <br />";
                        // echo $inscripcion_curso[0]->hora_inicio."<br />";
                        // echo $inscripcion_curso[0]->hora_termino."<br />";
                        // echo $inscripcion_curso[0]->fecha_inicio."<br />";
                        // echo $inscripcion_curso[0]->fecha_termino."<br />";
                        if ($fecha_actual < $inscripcion_curso[0]->fecha_inicio) {
                            $row_curso = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_cursos_por_programas_capacitacion_unico_sin_link" . $template_malla . ".html");
                            $mensaje_objeto="";
                            $mensaje_objeto.= "<small><strong>El curso se encuentra desactivado</strong>.<br /> La fecha de aplicaci&oacute;n es el " . $inscripcion_curso[0]->fecha_inicio . " y el horario de activaci&oacute;n es entre las " . $inscripcion_curso[0]->hora_inicio . " y " . $inscripcion_curso[0]->hora_termino . "</small>
                            <br><br><div class='alert alert-danger'><center>Recuerda presionar F5 al momento que llegue la hora para activar la Certificaci&oacute;n</center></div>";
                            $row_curso = str_replace("{MENSAJE_}", $mensaje_objeto, $row_curso);
                        }
                        else if ($fecha_actual > $inscripcion_curso[0]->fecha_termino) {
                            $row_curso = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_cursos_por_programas_capacitacion_unico_sin_link" . $template_malla . ".html");
                            $mensaje_objeto="";
                            $mensaje_objeto.= "<small><strong>El curso se encuentra desactivado</strong>.<br /> La fecha de aplicaci&oacute;n es el " . $inscripcion_curso[0]->fecha_inicio . " y el horario de activaci&oacute;n es entre las " . $inscripcion_curso[0]->hora_inicio . " y " . $inscripcion_curso[0]->hora_termino . "</small>
                            <br><br><div class='alert alert-danger'><center>Recuerda presionar F5 al momento que llegue la hora para activar la Certificaci&oacute;n</center></div>";
                            $row_curso = str_replace("{MENSAJE_}", $mensaje_objeto, $row_curso);
                        }
                        else if ($fecha_actual >= $inscripcion_curso[0]->fecha_inicio && $fecha_actual <= $inscripcion_curso[0]->fecha_termino) {
                            if ($fecha_actual == $inscripcion_curso[0]->fecha_inicio and $fecha_actual <> $inscripcion_curso[0]->fecha_termino) {
                                // echo "es hoy inicio";
                                if ($hora_actual < $inscripcion_curso[0]->hora_inicio) {
                                    $row_curso = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_cursos_por_programas_capacitacion_unico_sin_link" . $template_malla . ".html");
                                    $mensaje_objeto="";
                                    $mensaje_objeto.= "<small><strong>El curso se encuentra desactivado</strong>.<br /> La fecha de aplicaci&oacute;n es el " . $inscripcion_curso[0]->fecha_inicio . " y el horario de activaci&oacute;n es entre las " . $inscripcion_curso[0]->hora_inicio . " y " . $inscripcion_curso[0]->hora_termino . "</small>
                                    <br><br><div class='alert alert-danger'><center>Recuerda presionar F5 al momento que llegue la hora para activar la Certificaci&oacute;n</center></div>";
                                    $row_curso = str_replace("{MENSAJE_}", $mensaje_objeto, $row_curso);
                                }
                            }
                            elseif ($fecha_actual == $inscripcion_curso[0]->fecha_termino and $fecha_actual <> $inscripcion_curso[0]->fecha_inicio) {
                                if ($hora_actual > $inscripcion_curso[0]->hora_termino) {
                                    exit;
                                    $row_curso = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_cursos_por_programas_capacitacion_unico_sin_link" . $template_malla . ".html");
                                    $mensaje_objeto="";
                                    $mensaje_objeto.= "<small><strong>El curso se encuentra desactivado</strong>.<br /> La fecha de aplicaci&oacute;n es el " . $inscripcion_curso[0]->fecha_inicio . " y el horario de activaci&oacute;n es entre las " . $inscripcion_curso[0]->hora_inicio . " y " . $inscripcion_curso[0]->hora_termino . "</small>
                                    <br><br><div class='alert alert-danger'><center>Recuerda presionar F5 al momento que llegue la hora para activar la Certificaci&oacute;n</center></div>";
                                    $row_curso = str_replace("{MENSAJE_}", $mensaje_objeto, $row_curso);
                                }
                            }
                            elseif ($fecha_actual == $inscripcion_curso[0]->fecha_termino and $fecha_actual == $inscripcion_curso[0]->fecha_inicio) {
                                // echo "es hoy termino e iniciohora ahora es ".$hora_actual." hora termino ".$unico->hora_termino." hora inicio".$unico->hora_inicio;
                                if ($hora_actual > $inscripcion_curso[0]->hora_termino or $hora_actual < $inscripcion_curso[0]->hora_inicio) {
                                    $row_curso = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_cursos_por_programas_capacitacion_unico_sin_link" . $template_malla . ".html");
                                    $mensaje_objeto="";
                                    $mensaje_objeto.= "<small><strong>El curso se encuentra desactivado</strong>.<br /> La fecha de aplicaci&oacute;n es el " . $inscripcion_curso[0]->fecha_inicio . " y el horario de activaci&oacute;n es entre las " . $inscripcion_curso[0]->hora_inicio . " y " . $inscripcion_curso[0]->hora_termino . "</small>
                                    <br><br><div class='alert alert-danger'><center>Recuerda presionar F5 al momento que llegue la hora para activar la Certificaci&oacute;n</center></div>";
                                    $row_curso = str_replace("{MENSAJE_}", $mensaje_objeto, $row_curso);
                                }
                            }
                        }
                        else {
                            $row_curso = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_row_cursos_por_programas_capacitacion_unico" . $template_malla . ".html");
                        }
                        // echo $id_empresa."_row_cursos_por_programas_capacitacion_inactivo".$template_malla.".html";
                    }
                    $row_curso = str_replace("{NOMBRE_CURSO}", $curso_unico->nombre_curso . "", $row_curso);
                    if($id_empresa=="62"){
                        $row_curso = ListadoObjetosCapacitacionCert2017($row_curso, $curso_unico->id_curso, $_SESSION["user_"], "", $id_inscripcion, $id_empresa, $template_malla, $back_home, $im, $id_programa, $id_nivel);
                        $row_curso = ListadoObjetosCapacitacionSecuencial2017($row_curso, $curso_unico->id_curso, $_SESSION["user_"], "", $id_inscripcion, $id_empresa, $template_malla, $back_home, $im, $id_programa, $id_nivel);
                     }
                     $avances_cursos = ColocaAvanceCursoPorPuntosDeObjetos($row_curso, $curso_unico->id_curso, $rut, $id_empresa);
                    $row_curso = $avances_cursos[0];
                    $row_curso = str_replace("{ID_CURSO}", $curso_unico->id_curso, $row_curso);
                    $row_curso = str_replace("{IMAGEN_BACK}", $curso_unico->imagen_back, $row_curso);
                    $row_curso = str_replace("{FECHA_INICIO}", $curso_unico->fecha_inicio, $row_curso);
                    $row_curso = str_replace("{IMAGEN}", $curso_unico->imagen, $row_curso);
                    $row_curso = str_replace("{DESCRIPCION_CURSO}", $curso_unico->descripcion_curso, $row_curso);
                    $row_curso = str_replace("{DESCRIPTOR_CURSO}", $curso_unico->descriptor_curso, $row_curso);
                    $row_curso = str_replace("{FECHA_INICIO}", $curso_unico->fecha_inicio_insc, $row_curso);
                    $row_curso = str_replace("{FECHA_TERMINO}", $curso_unico->fecha_termino_insc, $row_curso);
                    // $row_curso = str_replace("{FECHA_TERMINO_INSC}",$curso_unico->fecha_termino,$row_curso);
                    $row_curso = str_replace("{FECHA_TERMINO_INSC}", formatearFechaSmall($curso_unico->fecha_termino) , $row_curso);
                    $row_curso = str_replace("{FECHA_INICIO_INSC}", $curso_unico->fecha_inicio, $row_curso);
                    $row_curso = str_replace("{ASISTENCIA}", $curso_unico->porcentaje_asistencia, $row_curso);
                                            $row_curso = str_replace("{NOTA_raw}", $estado_por_curso[7]."%", $row_curso);

                    if ($curso_unico->modalidad <> 2) {
                        if ($curso_unico->proveedor_curso == "OL") {
                        }
                        else {
                            $row_curso = str_replace("{LINK_CURSO}", '<a href="?sw=detalle_cursoCap&idc={ID_CURSO_ENCODEADO}">', $row_curso);
                            $row_curso = str_replace("{/LINK_CURSO}", '</a>', $row_curso);
                            $row_curso = str_replace("{LINK_CURSO_JUSTURL}", '?sw=detalle_cursoCap&idc={ID_CURSO_ENCODEADO}&idinsc={ID_INSCRIPCION_ENCODEADO}', $row_curso);
                        }
                    }
                    else {
                        $row_curso = str_replace("{LINK_CURSO}", "", $row_curso);
                        $row_curso = str_replace("{/LINK_CURSO}", "", $row_curso);
                    }
                    // ROD&nbsp; list($estado, $porcentaje_asistencia, $nota) = CAPACITACION_VE_ESTADO($rut, $curso_unico->codigo_curso, $curso_unico->id_inscripcion, $id_empresa);
                    $row_curso = str_replace("{ID_CURSO_ENCODEADO}", Encodear3($curso_unico->id_curso) , $row_curso);
                    $row_curso = str_replace("{ID_INSCRIPCION_ENCODEADO}", Encodear3($curso_unico->id_inscripcion) , $row_curso);
                    $row_curso = str_replace("{ESTADO}", $estado_por_curso[0], $row_curso);
                    $row_curso = str_replace("{ESTADO_CON_NOTA}", $estado_por_curso[9], $row_curso);
                    $row_curso = str_replace("{ASISTENCIA}", $estado_por_curso[0], $row_curso);
                    if ($estado_por_curso[10]) {
                        $row_curso = str_replace("{PORC_ASISTENCIA}", $estado_por_curso[10] . "%", $row_curso);
                    }
                    else {
                        $row_curso = str_replace("{PORC_ASISTENCIA}", "-", $row_curso);
                    }
                    $row_curso = str_replace("{ESTADO}", $estado_por_curso[1], $row_curso);
                    if ($estado_por_curso[13]) {
                        $row_curso = str_replace("{NOTA}", $estado_por_curso[7], $row_curso);
                        $row_curso = str_replace("{NOTA_porcentaje}", "" . $estado_por_curso[7] . "%", $row_curso);
                        if ($estado_por_curso[13] == "") {
                            if ($estado_por_curso[7] <> '') {
                                $nota_decimal = $estado_por_curso[7] . "%";
                            }
                            else {
                                $nota_decimal = "-";
                            }
                            $row_curso = str_replace("{NOTA_porcentaje_decimales}", "" . $nota_decimal, $row_curso);
                        }
                        else {
                            if ($estado_por_curso[7] <> '') {
                                $nota_decimal = $estado_por_curso[7] . "%";
                            }
                            else {
                                $nota_decimal = "-";
                            }
                            $row_curso = str_replace("{NOTA_porcentaje_decimales}", "" . $nota_decimal, $row_curso);
                        }
                        $row_curso = str_replace("{AVANCE_CURSO}", ($estado_por_curso[13]) , $row_curso);
                        $row_curso = str_replace("{AVANCE_CURSO2}", ($estado_por_curso[7]) , $row_curso);
                        /*$row_curso = str_replace("{BARRA_SIN_PORCENTAJE}","<div class='progress'>
                        <div class='progress-bar progress-bar-success progress-bar-striped progress-animation'
                        role='progressbar' aria-valuenow='".$estado_por_curso[7]."' aria-valuemin='0'
                        aria-valuemax='100' style='width: ".$estado_por_curso[7]."%'></div>
                        </div>",$row_curso);*/
                        $row_curso = str_replace("{BARRA_SIN_PORCENTAJE}", "", $row_curso);
                    }
                    else {
                        if ($estado_por_curso[7] <> "") {
                            if ($estado_por_curso[7] <> '') {
                                $nota_decimal = $estado_por_curso[7] . "%";
                            }
                            else {
                                $nota_decimal = "-";
                            }
                            $row_curso = str_replace("{NOTA_porcentaje_decimales}", "" . $nota_decimal, $row_curso);
                        }
                        else {
                            if ($estado_por_curso[7] <> '') {
                                $nota_decimal = $estado_por_curso[7] . "%";
                            }
                            else {
                                $nota_decimal = "-";
                            }
                            $row_curso = str_replace("{NOTA_porcentaje_decimales}", "" . $nota_decimal, $row_curso);
                        }
                        $row_curso = str_replace("{NOTA}", "-", $row_curso);
                        $row_curso = str_replace("{NOTA_SIN_PORCENTAJE}", "-", $row_curso);
                        $row_curso = str_replace("{NOTA_porcentaje}", "", $row_curso);
                        $row_curso = str_replace("{BARRA_SIN_PORCENTAJE}", "", $row_curso);
                    }
                    if ($estado_por_curso[8]) {
                        $row_curso = str_replace("{FECHA_FIN}", $estado_por_curso[8], $row_curso);
                    }
                    else {
                        $row_curso = str_replace("{FECHA_FIN}", "-", $row_curso);
                    }
                    $row_curso = str_replace("{ICONO_ESTADO_CURSO}", $estado_por_curso[2], $row_curso);
                    // $row_curso = str_replace("{AVANCE_CURSO}",$estado_por_curso[3],$row_curso);
                    if ($curso_unico->modalidad == 2) {
                        $row_curso = str_replace("{AVANCE_CURSO}", $estado_por_curso[3], $row_curso);
                        $row_curso = str_replace("{AVANCE_CURSO2}", $estado_por_curso[3], $row_curso);
                        if ($curso_unico->opcional <> 1 and $curso_unico->inactivo <> 1) {
                            $acumula_avance_curso = $estado_por_curso[3] + $acumula_avance_curso;
                        }
                    }
                    else {
                        $row_curso = str_replace("{AVANCE_CURSO}", $estado_por_curso[4], $row_curso);
                        $row_curso = str_replace("{AVANCE_CURSO2}", $estado_por_curso[4], $row_curso);
                        if ($curso_unico->opcional <> 1 and $curso_unico->inactivo <> 1) {
                            $acumula_avance_curso = $estado_por_curso[4] + $acumula_avance_curso;
                        }
                    }
                    if ($curso_unico->opcional <> 1 and $curso_unico->inactivo <> 1) {
                        $acumula_cursos++;
                    }
                    // Funcion para colocar Avance de Curso, Tipo Ultramar, en base a los puntos de los objetos.
                    // echo  "<br />".print_r($estado_por_curso);
                    if ($estado_por_curso[6] == 1) {
                        $cantidad_cursos_aprobados_por_clasificacion++;
                    }
                    // suma avance
                    $cla_sum_avance = $cla_sum_avance + $estado_por_curso[4];
                    // echo "<pre>";
                    //    print_r($estado_por_curso);
                    $cantidad_cursos_por_clasificacion++;
                    // AVANCE GLOBAL
                    $cla_sum_avance_total = $cla_sum_avance_total + $cla_sum_avance;
                    $cla_cantidad_cursos_por_clasificacion_total = $cla_cantidad_cursos_por_clasificacion_total + $cantidad_cursos_por_clasificacion;
                    // echo $total_cursos;
                    $total_cursos.= $row_curso;
                    // echo "<br />id curso ".$curso_unico->id_curso." estado ".$estado_por_curso;
                    // print_r($estado_por_curso);
                    if ($estado_por_curso[4] >= 100) {
                        $total_cursos_aprobados.= $row_curso;
                    }
                    else {
                        $total_cursos_pendientes.= $row_curso;
                    }
                    if ($curso_unico->inactivo == "1") {
                        $total_cursos_inactivos.= $row_curso;
                    }
                    else {
                        $total_cursos_activos.= $row_curso;
                    }

                    //$time_elapsed_secs = microtime(true) - $start;
                    //$time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
                    //echo "<br>VP finalizados y pendientes  : $time_elapsed<br><br>";

                }
            }
        }
        // VISTA AVANCE POR CLASIFICACION REAL POR OBJETO
        $avance_de_clasificacion = round($cla_sum_avance / $cantidad_cursos_por_clasificacion);
        $arreglo_avances_clasificaciones[$contador_arreglo_clasificaciones] = $avance_de_clasificacion;
        $contador_arreglo_clasificaciones++;
        $avance_cla = str_replace("{CLAS_IMG_NIVEL}", "img/" . $cla->imagennivel, $avance_cla);
        $avance_cla = str_replace("{CLAS_AVANCE}", $avance_de_clasificacion, $avance_cla);
        // $avance_cla = str_replace("{NOMBRE_CLASIFICACION}",$avance_de_clasificacion,$avance_cla);
        $avance_cla = str_replace("{NOMBRE_CLASIFICACION}", $cla->nombre_clasificacion, $avance_cla);
        if ($avance_de_clasificacion == 100) {
            $clase_estilo_img = "";
            $clase_estado_icono = "fas fa-check-squares";
            $clase_estado_estilo = "etiquetaPrograma-aprobado";
            $cla_estado = "Finalizada";
            // Aca inserto Poder por clasificacion
            InsertaPoder($rut, $id_empresa, $codigo_malla, $cla->id_clasificacion);
        }
        elseif ($avance_de_clasificacion < 100 and $avance_de_clasificacion > 0) {
            $clase_estilo_img = "img_bn_grasycale";
            $clase_estado_icono = "icon-note icons";
            $clase_estado_estilo = "etiquetaPrograma-proceso ";
            $cla_estado = "En Proceso";
        }
        else {
            $clase_estilo_img = "img_bn_grasycale";
            $clase_estado_icono = "far fa-times-circle";
            $clase_estado_estilo = "etiquetaPrograma-noiniciado ";
            $cla_estado = "No Iniciado";
        }
        $avance_cla = str_replace("{CLAS_ESTADO_ESTILO}", $clase_estado_estilo, $avance_cla);
        $avance_cla = str_replace("{CLAS_ESTADO_ICONO}", $clase_estado_icono, $avance_cla);
        $avance_cla = str_replace("{ESTILO_IMG_CLAS_AVANCE}", $clase_estilo_img, $avance_cla);
        $avance_cla = str_replace("{CLAS_ESTADO}", $cla_estado, $avance_cla);
        // VISTA AVANCE POR CLASIFICACION REAL POR OBJETO
        $html_cla = str_replace("{CANTIDAD_APROBADOS_MALLA}", $cantidad_cursos_aprobados_por_clasificacion, $html_cla);
        $html_cla = str_replace("{AVANCEMALLA}", "10", $html_cla);
        $html_cla = str_replace("{LISTADO_CURSOS_POR_CLASIFICACION}", ($total_cursos) , $html_cla);
        $html_cla = str_replace("{LISTADO_CURSOS_POR_CLASIFICACION_APROBADOS}", ($total_cursos_aprobados) , $html_cla);
        $html_cla = str_replace("{LISTADO_CURSOS_POR_CLASIFICACION_PENDIENTES}", ($total_cursos_pendientes) , $html_cla);
        $html_cla = str_replace("{LISTADO_CURSOS_POR_CLASIFICACION_ACTIVOS}", ($total_cursos_activos) , $html_cla);
        $html_cla = str_replace("{LISTADO_CURSOS_POR_CLASIFICACION_INACTIVOS}", ($total_cursos_inactivos) , $html_cla);
        // echo "<br /><br />hola cantidad_cursos_aprobados_por_clasificacion $cantidad_cursos_aprobados_por_clasificacion , cursos clasificacion $cantidad_cursos_por_clasificacion";
        // echo "<br />$acumula_avance_curso $acumula_cursos";
        $html_cla = str_replace("{APROBACION_CURSOS_PROGRAMA}", round(($cantidad_cursos_aprobados_por_clasificacion * 100) / $cantidad_cursos_por_clasificacion) . "%", $html_cla);
        $total_clasificaciones.= $html_cla;
        $avance_clasificaciones.= $avance_cla;
        $i++;
        if ($classrow) {
            if ($i == $classrow) {
                $total_clasificaciones.= "<div class='row'></div>";
                $i = 0;
            }
        }
        else {
            if ($i == 2) {
                $total_clasificaciones.= "<div class='row'></div>";
                $i = 0;
            }
        }
    }
    // en este arreglo, tengotodos los datos de los avances porclasificacion
    $arreglo_con_avances2 = $arreglo_avances_clasificaciones;
    // aca los ordeno de manera descendente. Si el primero es 0, implica que solo el primer queda abierto
    rsort($arreglo_con_avances2);
    $cont_2 = 1;
    $abierto = "";
    foreach($clasificaciones as $cla) {
        // echo $arreglo_avances_clasificaciones[$cont_2-2]." ".$arreglo_avances_clasificaciones[$cont_2-1]."<br /><br />";
        $id_clasificacion = $cla->id_clasificacion;
        if ($arreglo_con_avances2[0] == 0) {
            $abierto = 1;
        }
        // echo "<pre>";
        // print_r($arreglo_avances_clasificaciones);
        if ($cont_2 == $abierto) {
            // echo "{BLOQUE_JS_ABIERTO_CERRADO_".$id_clasificacion."}";exit;
            $total_clasificaciones = str_replace("{BLOQUE_JS_ABIERTO_CERRADO_" . $id_clasificacion . "}", "", $total_clasificaciones);
        }
        // echo $arreglo_avances_clasificaciones[$cont_2-1]."  ".$arreglo_avances_clasificaciones[$cont_2]." -<br />";
        if (($arreglo_avances_clasificaciones[$cont_2 - 2] == 100 && $arreglo_avances_clasificaciones[$cont_2 - 1] < 100) or ($arreglo_avances_clasificaciones[$cont_2 - 2] === "" && $arreglo_avances_clasificaciones[$cont_2 - 1] < 100)) {
            $total_clasificaciones = str_replace("{BLOQUE_JS_ABIERTO_CERRADO_" . $id_clasificacion . "}", "", $total_clasificaciones);
            $total_clasificaciones = str_replace("{LINK_ABRE_CIERRA_" . $id_clasificacion . "}", "show_hide" . $id_clasificacion, $total_clasificaciones);
        }
        else if ($arreglo_avances_clasificaciones[$cont_2 - 1] < 100 && $arreglo_avances_clasificaciones[$cont_2 - 1] > 0 && $arreglo_avances_clasificaciones[$cont_2] == 0) {
            $total_clasificaciones = str_replace("{BLOQUE_JS_ABIERTO_CERRADO_" . $id_clasificacion . "}", "", $total_clasificaciones);
            $total_clasificaciones = str_replace("{LINK_ABRE_CIERRA_" . $id_clasificacion . "}", "show_hide" . $id_clasificacion, $total_clasificaciones);
        }
        else {
            $total_clasificaciones = str_replace("{BLOQUE_JS_ABIERTO_CERRADO_" . $id_clasificacion . "}", '$(".slidingDiv' . $id_clasificacion . '").hide();', $total_clasificaciones);
            $total_clasificaciones = str_replace("{LINK_ABRE_CIERRA_" . $id_clasificacion . "}", "", $total_clasificaciones);
        }
        $cont_2++;
    }
}
// echo "$cla_sum_avance_total $cla_cantidad_cursos_por_clasificacion_total";
$avance_real = round($cla_sum_avance_total / $cla_cantidad_cursos_por_clasificacion_total);
$lms_medalla_tips = lms_medalla_tips($rut, $id_empresa);
$avance_real_malla = round(100 * $acumula_avance_curso / $acumula_cursos / 100);
// $PRINCIPAL = str_replace("{NUMERO_AVANCE_REAL}",$avance_real_malla,$PRINCIPAL);
$PRINCIPAL = str_replace("{NUMERO_AVANCE_REAL}", $avance_real_malla, $PRINCIPAL);
$PRINCIPAL = str_replace("{LMS_NUM_TIPS}", $lms_medalla_tips[0]->cuentatips, $PRINCIPAL);
$PRINCIPAL = str_replace("{LMS_NUM_MEDALLAS}", $lms_medalla_tips[0]->cuentamedallas, $PRINCIPAL);
$PRINCIPAL = str_replace("{ROW_CURSOS_RESUMENES2}", $resumen_niveles_curso, $PRINCIPAL);
$PRINCIPAL = str_replace("{APROBACION_CURSOS_PROGRAMA}", round(($cantidad_cursos_aprobados_por_clasificacion * 100) / $cantidad_cursos_por_clasificacion) , $PRINCIPAL);
$PRINCIPAL = str_replace("{NUM_INSCRIPCIONES}", ($numero_cursos_total_up) , $PRINCIPAL);
$PRINCIPAL = str_replace("{NUM_CURSOS}", ($numero_cursos_total_desdemalla_up) , $PRINCIPAL);
$PRINCIPAL = str_replace("{ROWS_CLASIFICACIONES}", utf8_encode($total_clasificaciones) , $PRINCIPAL);
$PRINCIPAL = str_replace("{ROWS_CLASIFICACIONES_ACTIVOS}", utf8_encode($total_cursos_activos) , $PRINCIPAL);
$PRINCIPAL = str_replace("{ROWS_CLASIFICACIONES_INACTIVOS}", utf8_encode($total_cursos_inactivos) , $PRINCIPAL);
// echo $total_clasificaciones;
$PRINCIPAL = str_replace("{BLOQUE_AVANCE_CLASIFICACIONES}", utf8_encode($avance_clasificaciones) , $PRINCIPAL);
if ($tipo_llamada == "admin") {
    $arreglo[0] = $PRINCIPAL;
    $arreglo[1] = $porcentaje_avance_por_usuario;
    $arreglo[2] = $datos_usuario_para_admin;
    // Numero de cursos
    $arreglo[3] = $numero_cursos_total_desdemalla_up;
    // echo "<br /> 11588";
    // print_r($arreglo);
    return ($arreglo);
}
elseif ($tipo_llamada == "avance") {
    $arreglo = $avance_real_malla;
    return ($arreglo);
}
else {
    return ($PRINCIPAL);
}

}
function ListadoObjetosCapacitacionSecuencial2017($PRINCIPAL, $id_curso, $rut, $tipo, $id_inscripcion, $id_empresa, $id_template, $back_home, $im, $id_programa, $id_nivel)
{
    //echo "<br><br><br>$id_curso, $rut, $tipo, $id_inscripcion, $id_empresa, $id_template, $back_home, $im, $id_programa, $id_nivel";
    $objetos = ObjetosDadoCurso($id_curso, $rut);
    //print_r($objetos);
    if ($id_template <> '') {
        $template = "" . $id_template;
    } else {
        $template = "";
    }
    //echo $template;
    foreach ($objetos as $unico) {
        //Primero verifico si la anterior esta finalizada y todo esto solo si es mayor a 1
        if ($unico->fecha_finalizacion) {
            $fila = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto" . $template . "_finalizado.html");
        } else {
            //Primero vei si tiene objeto anterion utilizando el campo orden
            $numero_anterior = $unico->orden - 1;
            if ($numero_anterior === 0) {
                $fila = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto" . $template . ".html");
            } else {
                $objeto_anterior_finalizado = VerificoObjetoAnteriorFinalizado($rut, $id_curso, $numero_anterior);
                if ($objeto_anterior_finalizado) {
                    $fila = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto" . $template . ".html");
                } else {
                    $fila = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto" . $template . "_pendiente.html");
                }
            }
        }
        $fila        = str_replace("{TIEMPOMODULO_O_NUM_PREGUNTAS}", "", $fila);
        $fila        = str_replace("{NOMBRE_OBJETO}", ($unico->titulo), $fila);
        $fila        = str_replace("{TIPO_OBJETO}", $unico->tipo_objeto, $fila);
        $fila        = str_replace("{CLASE_ICONO}", $unico->icono, $fila);
        $fila        = str_replace("{BAJADA1}", $unico->bajada, $fila);
        $fila        = str_replace("{BAJADA2}", $unico->texto_bajada, $fila);
        $fila        = str_replace("{TEXTO_BAJADA}", $unico->texto_bajada, $fila);
        $fila        = str_replace("{IMAGEN_MODULO}", "img/" . $unico->imagen, $fila);
        $fila        = str_replace("{IMAGEN_MODULO_ACTIVO}", "img/" . $unico->imagen . "_activo.png", $fila);
        $fila        = str_replace("{IMAGEN_MODULO_PASIVO}", "img/" . $unico->imagen . "_desactivo.png", $fila);
        $fila        = str_replace("{IMAGEN_MODULO_VISTO}", "img/" . $unico->imagen . "_visto.png", $fila);
        $fila        = str_replace("{IMAGEN_MODULO_DINAMICO}", "" . $unico->imagen, $fila);
        $fila        = str_replace("{IMAGEN_TEXTOMODULO}", $unico->imagentexto, $fila);
        $fila        = str_replace("{PORC_AVANC}", $porcentaje_Avance_de_Este_modulo . "%", $fila);
        $fila        = str_replace("{AMBIENTE}", $unico->ambiente, $fila);
        $fila        = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($unico->id), $fila);
        $fila        = str_replace("{ID_OBJETO}", ($unico->id), $fila);
        $fila        = str_replace("{RUT_MOODLE}", $rut, $fila);
        $fila        = str_replace("{PASS_MOODLE}", "Gop.123456", $fila);
        $fila        = str_replace("{ID_MOODLE}", $unico->idmoodle, $fila);
        $fila        = str_replace("{CURRENTORG}", $unico->currentorg, $fila);
        $fila        = str_replace("{SCOID}", $unico->scoid, $fila);
        $fila        = str_replace("{CM}", $unico->cm, $fila);
        $fila        = str_replace("{ACTION}", $unico->urlmoodle, $fila);
        $rut_enc_md5 = md5($rut);
        $fila        = str_replace("{RUT_ENC_MD5}", $rut_enc_md5, $fila);
        $estado      = EstadoObjeto($unico->id, $rut);
        //Estados
        if ($estado[1] == "si") {
            $total_finalizados++;
        }
        $fila = str_replace("{ICONO_ESTADO}", $estado[0], $fila);
        if ($unico->total_tiempo) {
            $fila = str_replace("{TIEMPO_NAVEGACION}", "<i class='fa fa-clock-o'></i>&nbsp;" . $unico->total_tiempo, $fila);
        } else if ($unico->nota_objeto >= "0") {
            $aprobado_reprobado = ApruebaReprueba($unico->nota_objeto);
            $fila               = str_replace("{TIEMPO_NAVEGACION}", "<img width='20%' src='img/" . $aprobado_reprobado[1] . "'>
<span ><br><b>Nota: " . number_format($unico->nota_objeto, 0) . "%</b></span>
", $fila);
        } else {
            $fila = str_replace("{TIEMPO_NAVEGACION}", "", $fila);
        }
        if ($unico->nota_objeto >= "0") {
            $total_notas++;
            $acum_notas = $acum_notas + $unico->nota_objeto;
        }
        $total_html .= $fila;
    }
    if ($total_notas > 0) {
        $PRINCIPAL = str_replace("{PROMEDIO_NOTAS_POR_CURSO}", number_format($acum_notas / $total_notas, 0), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{PROMEDIO_NOTAS_POR_CURSO}", "0", $PRINCIPAL);
    }
    $porcentaje_avance_curso = (100 * $total_finalizados) / count($objetos);
    $PRINCIPAL               = str_replace("{PORCENTAJE_AVANCE_CURSO}", number_format($porcentaje_avance_curso, 0), $PRINCIPAL);
    $PRINCIPAL               = str_replace("{LISTADO_OBJETOS_SECUENCIAL}", ($total_html), $PRINCIPAL);
    $detalle_curso           = DetalleCurso($id_curso);
    $PRINCIPAL               = str_replace("{NOMBRE_CURSO}", utf8_encode($detalle_curso[0]->nombre), $PRINCIPAL);
    $PRINCIPAL               = str_replace("{CANTIDAD_OBJETOS}", count($objetos), $PRINCIPAL);
    //Total NAvegacion por Curso.
    $navegacion_por_curso    = SumaNavegacionesDadoRutYCurso($rut, $id_curso);
    $PRINCIPAL               = str_replace("{TOTAL_NAVEGACION_CURSO}", $navegacion_por_curso[0]->total_tiempo, $PRINCIPAL);
    return ($PRINCIPAL);
}
function ListadoObjetosCapacitacionCert2017($PRINCIPAL, $id_curso, $rut, $tipo, $id_inscripcion, $id_empresa, $id_template, $back_home, $im, $id_programa, $id_nivel)
{
    //echo $id_inscripcion."<br>";
    //echo "<br><br><br>$id_curso, $rut, $tipo, $id_inscripcion, $id_empresa, $id_template, $back_home, $im, $id_programa, $id_nivel";
    $objetos = ObjetosDadoCurso($id_curso, $rut);
    //print_r($objetos);
    if ($id_template <> '') {
        $template = "" . $id_template;
    } else {
        $template = "";
    }
    //echo $template;

    foreach ($objetos as $unico) {
        //echo "views/cursos/" . $id_empresa . "_row_objeto" . $template . ".html";exit;
        //Primero verifico si la anterior esta finalizada y todo esto solo si es mayor a 1
        $esta_en_cierre=EstaEnInscripcionCierreConImparticion($rut, $id_curso, $id_empresa, $id_inscripcion);
        if($esta_en_cierre){
            //$fila = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto" . $template . "_cert_finalizada.html");
            $fila = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto" . $template . ".html");
        }else{
            $fila = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto" . $template . ".html");
        }


        if ($unico->extension_objeto == "zip") {

            $fila = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto_zip" . $template . ".html");
        }
        if ($unico->extension_objeto == "boost") {
            $fila = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto_boost" . $template . ".html");
        }
        if ($unico->opcional == 1 or $unico->opcional == 2) {
            $fila = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto_desactivado" . $template . ".html");
        }
        if ($unico->tipo_de_objeto == "3") {
            $fila = str_replace("{TIEMPOMODULO_O_NUM_PREGUNTAS}", $unico->duracion_video, $fila);
        } else if ($unico->tipo_de_objeto == "5") {
            $fila = str_replace("{TIEMPOMODULO_O_NUM_PREGUNTAS}", "<b>Cantidad Preguntas: " . $unico->total_preguntas_por_objeto . "</b>", $fila);
        }
        $fila        = str_replace("{TIEMPOMODULO_O_NUM_PREGUNTAS}", "", $fila);
        $fila        = str_replace("{NOMBRE_OBJETO}", ($unico->titulo), $fila);
        $fila        = str_replace("{TIPO_OBJETO}", $unico->tipo_objeto, $fila);
        $fila        = str_replace("{CLASE_ICONO}", $unico->icono, $fila);
        $fila        = str_replace("{BAJADA1}", $unico->bajada, $fila);
        $fila        = str_replace("{BAJADA2}", $unico->texto_bajada, $fila);
        $fila        = str_replace("{TEXTO_BAJADA}", $unico->texto_bajada, $fila);
        $fila        = str_replace("{IMAGEN_MODULO}", "img/" . $unico->imagen, $fila);
        $fila        = str_replace("{IMAGEN_MODULO_ACTIVO}", "img/" . $unico->imagen . "_activo.png", $fila);
        $fila        = str_replace("{IMAGEN_MODULO_PASIVO}", "img/" . $unico->imagen . "_desactivo.png", $fila);
        $fila        = str_replace("{IMAGEN_MODULO_VISTO}", "img/" . $unico->imagen . "_visto.png", $fila);
        $fila        = str_replace("{IMAGEN_MODULO_DINAMICO}", "" . $unico->imagen, $fila);
        $fila        = str_replace("{IMAGEN_TEXTOMODULO}", $unico->imagentexto, $fila);
        $fila        = str_replace("{PORC_AVANC}", $porcentaje_Avance_de_Este_modulo . "%", $fila);
        $fila        = str_replace("{AMBIENTE}", $unico->ambiente, $fila);
        $fila        = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($unico->id), $fila);
        $fila        = str_replace("{ID_OBJETO}", ($unico->id), $fila);
        $fila        = str_replace("{RUT_MOODLE}", $rut, $fila);
        $fila        = str_replace("{PASS_MOODLE}", "Gop.123456", $fila);
        $fila        = str_replace("{ID_MOODLE}", $unico->idmoodle, $fila);
        $fila        = str_replace("{CURRENTORG}", $unico->currentorg, $fila);
        $fila        = str_replace("{SCOID}", $unico->scoid, $fila);
        $fila        = str_replace("{CM}", $unico->cm, $fila);
        $fila        = str_replace("{ACTION}", $unico->urlmoodle, $fila);
        $rut_enc_md5 = md5($rut);
        $fila        = str_replace("{RUT_ENC_MD5}", $rut_enc_md5, $fila);
        $estado      = EstadoObjeto($unico->id, $rut);
        //Estados
        if ($estado[1] == "si") {
            $total_finalizados++;
        }
        $fila = str_replace("{ICONO_ESTADO}", $estado[0], $fila);
        if ($unico->total_tiempo) {
            $fila = str_replace("{TIEMPO_NAVEGACION}", "<i class='fa fa-clock-o'></i>&nbsp;" . $unico->total_tiempo, $fila);
        } else if ($unico->nota_objeto >= "0") {
            $aprobado_reprobado = ApruebaReprueba($unico->nota_objeto);
            $fila               = str_replace("{TIEMPO_NAVEGACION}", "<img width='20%' src='img/" . $aprobado_reprobado[1] . "'>
<span ><br><b>Nota: " . number_format($unico->nota_objeto, 0) . "%</b></span>
", $fila);
        } else {
            $fila = str_replace("{TIEMPO_NAVEGACION}", "", $fila);
        }
        if ($unico->nota_objeto >= "0") {
            $total_notas++;
            $acum_notas = $acum_notas + $unico->nota_objeto;
        }
        $total_html .= $fila;
    }
    if ($total_notas > 0) {
        $PRINCIPAL = str_replace("{PROMEDIO_NOTAS_POR_CURSO}", number_format($acum_notas / $total_notas, 0), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{PROMEDIO_NOTAS_POR_CURSO}", "0", $PRINCIPAL);
    }
    $porcentaje_avance_curso = (100 * $total_finalizados) / count($objetos);
    $PRINCIPAL               = str_replace("{PORCENTAJE_AVANCE_CURSO}", number_format($porcentaje_avance_curso, 0), $PRINCIPAL);
    $PRINCIPAL               = str_replace("{LISTADO_OBJETOS}", ($total_html), $PRINCIPAL);
    $detalle_curso           = DetalleCurso($id_curso);
    $PRINCIPAL               = str_replace("{NOMBRE_CURSO}", utf8_encode($detalle_curso[0]->nombre), $PRINCIPAL);
    $PRINCIPAL               = str_replace("{CANTIDAD_OBJETOS}", count($objetos), $PRINCIPAL);
    //Total NAvegacion por Curso.
    $navegacion_por_curso    = SumaNavegacionesDadoRutYCurso($rut, $id_curso);
    $PRINCIPAL               = str_replace("{TOTAL_NAVEGACION_CURSO}", $navegacion_por_curso[0]->total_tiempo, $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaDatosMallaCapacitacion_vr($PRINCIPAL, $rut, $id_empresa, $id_clasificacion, $tipo_llamada, $filtro_desde_admin, $opcional, $tipo_reporte_desde_admin, $id_malla)
{
    //echo "$rut, $id_empresa";
    $datos_empresa = DatosEmpresa($id_empresa);
    list($total_inscripciones, $total_aprobados, $total_reprobados, $total_en_proceso) = CAPACITACION_DatosGeneralesPorUsuario($rut, $filtro_desde_admin);
    $PRINCIPAL               = str_replace("{BLOQUE_DATOS_PERSONALES}", file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_mi_perfil_bloque_datos.html"), $PRINCIPAL);
    $datos_colaborador       = UsuarioEnBasePersonas($rut);
    $PRINCIPAL               = str_replace("{NOMBRE_USUARIO}", utf8_encode($datos_colaborador[0]->nombre_completo), $PRINCIPAL);
    $PRINCIPAL               = str_replace("{CARGO}", utf8_encode($datos_colaborador[0]->cargo), $PRINCIPAL);
    $PRINCIPAL               = str_replace("{EMAIL}", utf8_encode($datos_colaborador[0]->email), $PRINCIPAL);
    $PRINCIPAL               = str_replace("{TELEFONO}", utf8_encode($datos_colaborador[0]->telefono), $PRINCIPAL);
    $PRINCIPAL               = str_replace("{URL_IMAGEN}", utf8_encode(VerificaFotoPersonal($datos_colaborador[0]->rut)), $PRINCIPAL);
    $datos_malla             = CAPACITACION_malla_porUsuario($rut, $id_malla);
    //GAMIFICACION_ActualizaNivel($datos_malla[0]->id_malla, $id_empresa, $rut);
    $datos_puntos_acumulados = GAMIFICACIONTienePuntosAcumuladosPorRutEmpresa($rut, $id_empresa, $filtro_desde_admin);
    //print_r($datos_malla);
    $nivel_actual            = $datos_puntos_acumulados[0]->numnivel;
    $estado                  = EntregaEstadoAvanceBarraMalla(EntregaPorcentaje($total_inscripciones, $total_aprobados));
    if (!$tipo_llamada) {
        $PRINCIPAL = ColocarRankingUsuariosPorPuntos($PRINCIPAL, $id_empresa, $datos_malla[0]->id_malla);
    }
    //Funcionalidad para Asignar Niveles  a Cursos
    if ($tipo_llamada) {
        $datos_usuario_para_admin = ColocaDatosCampusPuntos($PRINCIPAL, $rut, $id_empresa, $tipo_llamada, $filtro_desde_admin);
    } else {
        $PRINCIPAL = ColocaDatosCampusPuntos($PRINCIPAL, $rut, $id_empresa, $tipo_llamada, "");
    }
    if ($datos_malla) {
        /*if($id_empresa==52){
        }else{
        $PRINCIPAL = str_replace("{BLOQUE_TITULO_MALLA}",file_get_contents("views/cursos/capacitacion/titulo_nombre_malla.html"),$PRINCIPAL);
        }*/
        if ($id_clasificacion) {
            if (file_exists("views/cursos/capacitacion/" . $id_empresa . "_titulo_nombre_malla.html")) {
                $PRINCIPAL = str_replace("{BLOQUE_TITULO_MALLA}", file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_vr_titulo_avance_malla.html"), $PRINCIPAL);
            } else {
                $PRINCIPAL = str_replace("{BLOQUE_TITULO_MALLA}", file_get_contents("views/cursos/capacitacion/vr_titulo_nombre_malla.html"), $PRINCIPAL);
            }
            //$PRINCIPAL = str_replace("{BLOQUE_TITULO_MALLA}",file_get_contents("views/cursos/capacitacion/".$id_empresa."_titulo_nombre_malla.html"),$PRINCIPAL);
        } else {
            if (file_exists("views/cursos/capacitacion/" . $id_empresa . "_titulo_nombre_malla_sin_imagen.html")) {
                $PRINCIPAL = str_replace("{BLOQUE_TITULO_MALLA}", file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_vr_titulo_nombre_malla_sin_imagen.html"), $PRINCIPAL);
            } else {
                $PRINCIPAL = str_replace("{BLOQUE_TITULO_MALLA}", file_get_contents("views/cursos/capacitacion/vr_titulo_nombre_malla_sin_imagen.html"), $PRINCIPAL);
            }
        }
        if (!$id_clasificacion) {
            $PRINCIPAL = str_replace("{DESCRIPCION_CLASIFICACION}", utf8_encode($datos_malla[0]->descripcion_malla), $PRINCIPAL);
        }
        $PRINCIPAL                 = str_replace("{NOMBRE_MALLA}", utf8_encode($datos_malla[0]->nombre_malla), $PRINCIPAL);
        $datos_clasificacion_unica = DatosClasificacionPorCurso($id_clasificacion, $id_empresa);
        $PRINCIPAL                 = str_replace("{NOMBRE_CLASIFICACION}", "- " . utf8_encode($datos_clasificacion_unica[0]->nombre_clasificacion), $PRINCIPAL);
        $PRINCIPAL                 = str_replace("{DESCRIPCION__MALLA}", $datos_malla[0]->descripcion_malla, $PRINCIPAL);
        $PRINCIPAL                 = str_replace("{BLOQUE_CURSOS_PENDIENTES}", BloqueCursosPendientes(file_get_contents("views/cursos/capacitacion/titulo_cursos_pendientes_malla.html"), $rut, $datos_malla->id_malla), $PRINCIPAL);
        if (file_exists("views/cursos/capacitacion/" . $id_empresa . "_titulo_avance_malla.html")) {
            $PRINCIPAL = str_replace("{BLOQUE_AVANCE_MALLA}", file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_titulo_avance_malla.html"), $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{BLOQUE_AVANCE_MALLA}", file_get_contents("views/cursos/capacitacion/titulo_avance_malla.html"), $PRINCIPAL);
        }
        $PRINCIPAL = OtrosCursosRealizados($PRINCIPAL, $rut, $datos_malla[0]->id_malla);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_TITULO_MALLA}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{BLOQUE_CURSOS_PENDIENTES}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{BLOQUE_AVANCE_MALLA}", "", $PRINCIPAL);
        //$PRINCIPAL = str_replace("{BLOQUE_OTROS_CURSOS_REALIZADOS}",file_get_contents("views/cursos/capacitacion/titulo_otros_cursos_realizados_malla.html"),$PRINCIPAL);
        $PRINCIPAL = OtrosCursosRealizados($PRINCIPAL, $rut, $datos_malla[0]->id_malla);
    }
    $PRINCIPAL                     = str_replace("{NUMERO_AVANCE}", round(EntregaPorcentaje($total_inscripciones, $total_aprobados)), $PRINCIPAL);
    //$porcentaje_avance_por_usuario=round(EntregaPorcentaje($total_inscripciones, $total_aprobados));
    $porcentaje_avance_por_usuario = $datos_puntos_acumulados[0]->avanceobjetos;
    //si no tiene avance por objetos ve si hay avance por curso
    if ($porcentaje_avance_por_usuario == 0) {
        $porcentaje_avance_por_usuario = 100 * $datos_puntos_acumulados[0]->avancecurso;
    }
    //echo "<br>2932 ".$estado[0]." / ".$estado_por_curso[3];
    $PRINCIPAL    = str_replace("{COLOR_PROGRESS_BAR}", $estado[0], $PRINCIPAL);
    $PRINCIPAL    = str_replace("{TOTAL_APROBADOS}", $total_aprobados, $PRINCIPAL);
    $PRINCIPAL    = str_replace("{TOTAL_REPROBADOS}", $total_reprobados, $PRINCIPAL);
    $PRINCIPAL    = str_replace("{TOTAL_EN_PROCESO}", $total_en_proceso, $PRINCIPAL);
    $PRINCIPAL    = str_replace("{TOTAL_NO_INICIADOS}", $total_inscripciones - ($total_aprobados + $total_reprobados + $total_en_proceso), $PRINCIPAL);
    //TRaigo la malla del usuario
    $codigo_malla = $datos_malla[0]->id_malla;
    //echo $codigo_malla;
    //Con el id malla, traigo las clasificaciones
    //$clasificaciones=CAPACITACION_clasificacionesPorMallaRut($rut, $codigo_malla);
    //Voy a  pasar el id de clasificacion, esto es para cuando se quiere mostrar solo los cursos de una clasificacion.
    //        echo "opcional $opcional";
    if ($tipo_reporte_desde_admin <> "detallado") {
        if ($opcional == 1) {
            $clasificaciones = CAPACITACION_clasificacionesPorMallaClasificacionOpcional($codigo_malla, $id_empresa, $id_clasificacion);
        } else {
            $clasificaciones = CAPACITACION_clasificacionesPorMalla($codigo_malla, $id_empresa, $id_clasificacion);
        }
        //    print_r($clasificaciones);
        if (count($clasificaciones) == 0) {
            //Voy a  pasar el id de clasificacion, esto es para cuando se quiere mostrar solo los cursos de una clasificacion.
            $clasificaciones = CAPACITACION_clasificacionesPorInscripcionUsuario($rut, $id_clasificacion);
            //echo "hola np";
            //print_r($clasificaciones);
        }
    }
    //print_r($clasificaciones);
    if ($tipo_reporte_desde_admin <> "detallado") {
        $total_clasificaciones          = "";
        $i                              = 0;
        $numero_cursos_total            = 0;
        $PRINCIPAL                      = str_replace("{NUM_CLASIFICACIONES}", count($clasificaciones), $PRINCIPAL);
        $clasificaciones_entorno        = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_vr_row_programas_capacitacion.html");
        $curso_entorno                  = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_vr_row_cursos_por_programas_capacitacion.html");
        $classrow                       = 3;
        $avance_clasificaciones_entorno = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_vr_row_avance_clasificacion.html");
        if (count($clasificaciones) == 1) {
            //echo "hola1";
            $clasificaciones_entorno = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_vr_row_programas_capacitacion_unico.html");
            $curso_entorno           = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_vr_row_cursos_por_programas_capacitacion_unico.html");
            $PRINCIPAL               = str_replace("{DESCRIPCION_CLASIFICACION}", utf8_encode($clasificaciones[0]->descripcion_clasificacion), $PRINCIPAL);
            $PRINCIPAL               = str_replace("{IMAGEN_CLASIFICACION}", utf8_encode($clasificaciones[0]->imagen), $PRINCIPAL);
            $PRINCIPAL               = str_replace("{COLOR_CLASIFICACION}", utf8_encode($clasificaciones[0]->color), $PRINCIPAL);
        }
        if ($id_clasificacion) {
            $clasificaciones_entorno        = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_vr_row_programas_capacitacion_unico.html");
            $curso_entorno                  = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_vr_row_cursos_por_programas_capacitacion_unico.html");
            $avance_clasificaciones_entorno = file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_vr_row_avance_clasificacion.html");
        }
    }
    if ($tipo_reporte_desde_admin <> "detallado") {
        $con_row                          = 1;
        $contador_arreglo_clasificaciones = 0;
        foreach ($clasificaciones as $cla) {
            //$html_cla=file_get_contents("views/cursos/row_programas_capacitacion.html");
            $html_cla   = $clasificaciones_entorno;
            $avance_cla = $avance_clasificaciones_entorno;
            //$html_cla = str_replace("{ID_CLASIFICACION}",$cla->clasificacion,$html_cla);
            //print_r($cla);
            if ($cla->inactivo == 1) {
                $html_cla = str_replace("{LINK}", "", $html_cla);
                $html_cla = str_replace("{CLASSIMGBCK}", "img_bn_grasycale", $html_cla);
            } else {
                $html_cla = str_replace("{LINK}", "<a href='?sw=CurXClas&icl={ID_CLASIFICACION_ENCODEADO}'>", $html_cla);
                $html_cla = str_replace("{CLASSIMGBCK}", "", $html_cla);
            }
            $html_cla                             = str_replace("{LINK}", $cla->id_clasificacion, $html_cla);
            $html_cla                             = str_replace("{CLASSIMGBCK}", $cla->id_clasificacion, $html_cla);
            $html_cla                             = str_replace("{ID_CLASIFICACION}", $cla->id_clasificacion, $html_cla);
            $html_cla                             = str_replace("{ID_CLASIFICACION_ENCODEADO}", Encodear3($cla->id_clasificacion), $html_cla);
            $avance_cla                           = str_replace("{ID_CLASIFICACION}", $cla->id_clasificacion, $avance_cla);
            $avance_cla                           = str_replace("{ID_CLASIFICACION_ENCODEADO}", Encodear3($cla->id_clasificacion), $avance_cla);
            $html_cla                             = str_replace("{NOMBRE_CLASIFICACION}", $cla->nombre_clasificacion . "", $html_cla);
            $html_cla                             = str_replace("{DESCRIPCION_CLASIFICACION}", $cla->descripcion_clasificacion, $html_cla);
            $html_cla                             = str_replace("{IMAGEN_NIVEL_CLASIFICACION}", $cla->imagennivel, $html_cla);
            $html_cla                             = str_replace("{TEXTO_NIVEL_CLASIFICACION}", $cla->textonivel, $html_cla);
            $html_cla                             = str_replace("{DESCRIPCION_NIVEL_CLASIFICACION}", $cla->descripcionnivel, $html_cla);
            $html_cla                             = str_replace("{COLOR2}", $cla->color2, $html_cla);
            $html_cla                             = str_replace("{COLOR}", $cla->color, $html_cla);
            $html_cla                             = str_replace("{IMAGEN_BACK}", $cla->imagen_back, $html_cla);
            $html_cla                             = str_replace("{IMAGEN}", $cla->imagen, $html_cla);
            //Por cada clasificacion, traigo los cursos
            $cursos_por_clasificacion             = CAPACITACION_cursosPorClasificacion($rut, $codigo_malla, $cla->id_clasificacion);
            //$cursos_por_clasificacion_desde_malla=CAPACITACION_cursosPorClasificacionMalla($codigo_malla, $cla->clasificacion, $filtro_desde_admin);
            $cursos_por_clasificacion_desde_malla = CAPACITACION_cursosPorClasificacionMalla($codigo_malla, $cla->id_clasificacion, $filtro_desde_admin);
            //$avance_cursos_por_clasificacion_desde_malla=CAPACITACION_cursosPorClasificacionMalla($codigo_malla, $cla->id_clasificacion, $filtro_desde_admin);
            //echo "<br>".count($cursos_por_clasificacion_desde_malla);
            if (count($cursos_por_clasificacion_desde_malla) == 0) {
                $cursos_por_clasificacion_desde_malla = CAPACITACION_cursosPorClasificacionRut($rut, $cla->id_clasificacion);
            }
            $html_cla                                    = str_replace("{CANTIDAD_CURSOS}", count($cursos_por_clasificacion), $html_cla);
            $html_cla                                    = str_replace("{CANTIDAD_CURSOS_MALLA}", count($cursos_por_clasificacion_desde_malla), $html_cla);
            $total_cursos                                = "";
            $cantidad_cursos_aprobados_por_clasificacion = 0;
            foreach ($cursos_por_clasificacion as $curso_unico) {
                $numero_cursos_total_up++;
            }
            foreach ($cursos_por_clasificacion_desde_malla as $curso_unico) {
                $numero_cursos_total_desdemalla_up++;
            }
            //    echo  "<br> cursos_por_clasificacion ".count($cursos_por_clasificacion). " , cursos_por_clasificacion_desde_malla ".count($cursos_por_clasificacion_desde_malla);
            if (count($cursos_por_clasificacion) >= count($cursos_por_clasificacion_desde_malla)) {
                //si num cursos es inferior a inscripciones
                $contador_div_rows = 1;
                foreach ($cursos_por_clasificacion as $curso_unico) {
                    $numero_cursos_total++;
                    //$row_curso=file_get_contents("views/cursos/row_cursos_por_programas_capacitacion.html");
                    //$row_curso=$curso_entorno;
                    $row_curso = str_replace("{ID_CURSO}", $curso_unico->id_curso, $row_curso);
                    $row_curso = str_replace("{NOMBRE_CURSO}", $curso_unico->nombre_curso . "aca", $row_curso);
                    $row_curso = str_replace("{FECHA_INICIO}", $curso_unico->fecha_inicio_insc, $row_curso);
                    $row_curso = str_replace("{IMAGEN}", $curso_unico->imagen, $row_curso);
                    $row_curso = str_replace("{DESCRIPCION_CURSO}", $curso_unico->descripcion_curso, $row_curso);
                    $row_curso = str_replace("{DESCRIPTOR_CURSO}", $curso_unico->descriptor_curso, $row_curso);
                    $row_curso = str_replace("{FECHA_TERMINO}", $curso_unico->fecha_termino_insc, $row_curso);
                    $row_curso = str_replace("{ASISTENCIA}", $curso_unico->porcentaje_asistencia, $row_curso);
                    if ($curso_unico->proveedor_curso == "OL") {
                        $tiempo     = time();
                        //print_r($curso_unico);
                        //echo "<br><br>";
                        //$id_curso_test="13HY13";
                        //echo "$rut - $tiempo - ".$curso_unico->codigo_curso." - ".$curso_unico->nombre_curso."<br>";
                        $string_var = encryptMoodleAula($rut . "||" . $tiempo . "||" . $curso_unico->codigo_curso, "");
                        //$string_var=encryptMoodleAula($rut."||".$tiempo."||".$id_curso_test, "");
                        //echo $string_var."<br>";
                        $string_var = encryptMoodleAula($rut . "||" . $tiempo . "||" . $id_curso_test, "");
                        //print_r($curso_unico);exit;
                        //echo $string_var;exit;
                        $row_curso  = str_replace("{LINK_CURSO}", '<a target="_blank"  href="http://aula.openl.cl/local/minvest/login.php?token=' . $string_var . '">', $row_curso);
                        //$row_curso = str_replace("{LINK_CURSO}",'<a href="javascript: alert(\'Curso Cerrado\');">',$row_curso);
                        $row_curso  = str_replace("{/LINK_CURSO}", '</a>', $row_curso);
                    } else if ($curso_unico->modalidad <> 2) {
                        $row_curso = str_replace("{LINK_CURSO}", '<a href="?sw=detalle_cursoCap&idc={ID_CURSO_ENCODEADO}&idinsc={ID_INSCRIPCION_ENCODEADO}">', $row_curso);
                        $row_curso = str_replace("{/LINK_CURSO}", '</a>', $row_curso);
                        $row_curso = str_replace("{LINK_CURSO_JUSTURL}", '?sw=detalle_cursoCap&idc={ID_CURSO_ENCODEADO}&idinsc={ID_INSCRIPCION_ENCODEADO}', $row_curso);
                    } else {
                        $row_curso = str_replace("{LINK_CURSO}", "", $row_curso);
                        $row_curso = str_replace("{/LINK_CURSO}", "", $row_curso);
                    }
                    //$row_curso = str_replace("{ID_CURSO_ENCODEADO}",Encodear3($curso_unico->id_curso),$row_curso);
                    $row_curso = str_replace("{ID_CURSO_ENCODEADO}", Encodear3($curso_unico->codigo_curso), $row_curso);
                    list($estado, $porcentaje_asistencia, $nota) = CAPACITACION_VE_ESTADO($rut, $curso_unico->codigo_curso, $curso_unico->id_inscripcion, $id_empresa);
                    $estado_por_curso = CAPACITACION_ObtenerEstadoAvanceCurso($rut, $curso_unico->codigo_curso, "", $id_empresa);
                    $row_curso        = str_replace("{ESTADO}", $estado_por_curso[0], $row_curso);
                    $row_curso        = str_replace("{ESTADO}", $estado_por_curso[1], $row_curso);
                    $row_curso        = str_replace("{VR_ICON_ESTADO}", $estado_por_curso[2], $row_curso);
                    //$row_curso = str_replace("{AVANCE_CURSO}",$estado_por_curso[3],$row_curso);
                    $row_curso        = str_replace("{AVANCE_CURSO}", $estado_por_curso[4], $row_curso);
                    $total_cursos .= $row_curso;
                }
            } else {
                $cantidad_cursos_por_clasificacion = 0;
                $cla_sum_avance                    = 0;
                //echo "NP";
                //si num cursos es igual o superior a inscripciones
                //print_r($cursos_por_clasificacion_desde_malla);
                $contador_div_rows                 = 1;
                foreach ($cursos_por_clasificacion_desde_malla as $curso_unico) {
                    //echo "<br>".$curso_unico->id_curso;
                    //echo "<br>";
                    //print_r($curso_unico);
                    //echo "<br>";
                    //$estado_por_curso=CAPACITACION_ObtenerEstadoAvanceCurso($rut, $curso_unico->codigo_curso, "", $id_empresa);
                    $estado_por_curso = CAPACITACION_ObtenerEstadoAvanceCurso($rut, $curso_unico->id_curso, "", $id_empresa);
                    //print_r($estado_por_curso);echo "<br>";
                    //echo $nivel_actual." - ".$curso_unico->numnivel."<br><br>";
                    //echo "$rut, ".$curso_unico->codigo_curso.", -, $id_empresa";
                    //echo "<br><br>";
                    //$curso_entorno=file_get_contents("views/cursos/capacitacion/".$id_empresa."_vr_row_cursos_por_programas_capacitacion_unico.html");
                    $numero_cursos_total_desdemalla++;
                    //$row_curso=file_get_contents("views/cursos/row_cursos_por_programas_capacitacion.html");
                    $row_curso         = $curso_entorno;
                    $row_curso         = str_replace("{NOMBRE_CURSO}", $curso_unico->nombre_curso . "", $row_curso);
                    $avances_cursos    = ColocaAvanceCursoPorPuntosDeObjetos($row_curso, $curso_unico->id_curso, $rut, $id_empresa);
                    $row_curso         = $avances_cursos[0];
                    $row_curso         = str_replace("{ID_CURSO}", $curso_unico->id_curso, $row_curso);
                    $row_curso         = str_replace("{IMAGEN_BACK}", $curso_unico->imagen_back, $row_curso);
                    $row_curso         = str_replace("{IMAGEN}", $curso_unico->imagen, $row_curso);
                    $row_curso         = str_replace("{DESCRIPCION_CURSO}", $curso_unico->descripcion_curso, $row_curso);
                    $row_curso         = str_replace("{DESCRIPTOR_CURSO}", $curso_unico->descriptor_curso, $row_curso);
                    $row_curso         = str_replace("{FECHA_INICIO}", $curso_unico->fecha_inicio_insc, $row_curso);
                    $row_curso         = str_replace("{FECHA_TERMINO}", $curso_unico->fecha_termino_insc, $row_curso);
                    $row_curso         = str_replace("{FECHA_TERMINO_INSC}", $curso_unico->fecha_termino, $row_curso);
                    $row_curso         = str_replace("{FECHA_INICIO_INSC}", $curso_unico->fecha_inicio, $row_curso);
                    $row_curso         = str_replace("{ASISTENCIA}", $curso_unico->porcentaje_asistencia, $row_curso);
                    //aca traigo el desafio del este curso
                    $desafio_por_curso = DesafioPorCurso2($curso_unico->id_curso, $id_empresa);
                    $contador_desafios = 0;
                    if ($desafio_por_curso) {
                        foreach ($desafio_por_curso as $desa_por_curso) {
                            $contador_desafios++;
                            $desafios_pendientes = ColocaNotificacionesBannerJefe($_SESSION["user_"], $id_empresa, $rut, $desa_por_curso->id, "listadoObjetos");
                            if ($desafios_pendientes) {
                                $row_curso = str_replace("{BLOQUE_NOTIFICACION}", file_get_contents("views/home/index_bci_capacitacionbci20_entorno_alertas.html"), $row_curso);
                                $row_curso = str_replace("{BLOQUE_BANNER_NOTIFICACIONES}", "", $row_curso);
                                $row_curso = str_replace("{BLOQUE_BANNER_NOTIFICACIONES_JEFE}", utf8_decode($desafios_pendientes), $row_curso);
                            } else {
                                $row_curso = str_replace("{BLOQUE_NOTIFICACION}", "", $row_curso);
                            }
                            $accion_pendiente        = TieneAccionesPEndientes($rut, $id_empresa, $desa_por_curso->id_curso, $desa_por_curso->id);
                            $esta_finalizado_desafio = EstaFinalizadoDesafio($rut, $desa_por_curso->id, $desa_por_curso->id_curso, $id_empresa);
                            if ($accion_pendiente[0]->estado == 1) {
                                //$row_curso = str_replace("{VE_DESAFIO}",file_get_contents("views/cursos/capacitacion/".$id_empresa."_boton_ve_desafios.html"),$row_curso);
                                $template_boton_desafios .= file_get_contents("views/cursos/capacitacion/" . $id_empresa . "_boton_ve_desafios.html") . "<br><br>";
                                if ($contador_desafios > 1) {
                                    $br = "<br>";
                                } else {
                                    $br = "";
                                }
                                if ($esta_finalizado_desafio) {
                                    $template_icono .= "$br<img src='img/lms_icons_aprobado.jpg' width='30'><br>";
                                } else {
                                    $template_icono .= "$br<img src='img/lms_icons_enproceso.png' width='30'><br>";
                                }
                                $nombre_desafios .= $br . "<span class='vr_titulo_desafio'>" . $desa_por_curso->titulo . "<br></span>";
                                $template_boton_desafios = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($desa_por_curso->id), $template_boton_desafios);
                                $template_boton_desafios = str_replace("{RUT_COLABORADOR_ENCODADO}", Encodear3($rut), $template_boton_desafios);
                            } else {
                                $template_boton_desafios = str_replace("{VE_DESAFIO}", "", $template_boton_desafios);
                                $template_boton_desafios = str_replace("{ICONO_ESTADO_DESAFIO}", "", $template_boton_desafios);
                            }
                        }
                        $row_curso = str_replace("{VE_DESAFIO}", $template_boton_desafios, $row_curso);
                        $row_curso = str_replace("{ICONO_ESTADO_DESAFIO}", $template_icono, $row_curso);
                        $row_curso = str_replace("{NOMBRE_DESAFIO}", $nombre_desafios, $row_curso);
                    } else {
                        $row_curso = str_replace("{VE_DESAFIO}", "", $row_curso);
                        $row_curso = str_replace("{ICONO_ESTADO_DESAFIO}", "", $row_curso);
                        $row_curso = str_replace("{BLOQUE_NOTIFICACION}", "", $row_curso);
                        $row_curso = str_replace("{NOMBRE_DESAFIO}", "", $row_curso);
                    }
                    /*
                    $desafios_pendientes=ColocaNotificacionesBannerJefe($_SESSION["user_"], $id_empresa, $rut, $desafio_por_curso[0]->id, "listadoObjetos");
                    if($desafios_pendientes){
                    $row_curso = str_replace("{BLOQUE_NOTIFICACION}",file_get_contents("views/home/index_bci_capacitacionbci20_entorno_alertas.html"),$row_curso);
                    $row_curso = str_replace("{BLOQUE_BANNER_NOTIFICACIONES}","",$row_curso);
                    $row_curso = str_replace("{BLOQUE_BANNER_NOTIFICACIONES_JEFE}",utf8_decode($desafios_pendientes),$row_curso);
                    }else{
                    $row_curso = str_replace("{BLOQUE_NOTIFICACION}","",$row_curso);
                    }
                    $accion_pendiente=TieneAccionesPEndientes($rut, $id_empresa, $desafio_por_curso[0]->id_curso, $desafio_por_curso[0]->id);
                    $esta_finalizado_desafio=EstaFinalizadoDesafio($rut, $desafio_por_curso[0]->id, $desafio_por_curso[0]->id_curso, $id_empresa);
                    if($accion_pendiente[0]->estado==1){
                    $row_curso = str_replace("{VE_DESAFIO}",file_get_contents("views/cursos/capacitacion/".$id_empresa."_boton_ve_desafios.html"),$row_curso);
                    if($esta_finalizado_desafio){
                    $row_curso = str_replace("{ICONO_ESTADO_DESAFIO}","<img src='img/lms_icons_aprobado.jpg' width='30'>",$row_curso);
                    }else{
                    $row_curso = str_replace("{ICONO_ESTADO_DESAFIO}","<img src='img/lms_icons_enproceso.png' width='30'>",$row_curso);
                    }
                    $row_curso = str_replace("{ID_OBJETO_ENCODEADO}",Encodear3($desafio_por_curso[0]->id),$row_curso);
                    $row_curso = str_replace("{RUT_COLABORADOR_ENCODADO}",Encodear3($rut),$row_curso);
                    }else{
                    $row_curso = str_replace("{VE_DESAFIO}","",$row_curso);
                    $row_curso = str_replace("{ICONO_ESTADO_DESAFIO}","",$row_curso);
                    }
                    */
                    if ($curso_unico->modalidad <> 2) {
                        if ($curso_unico->modalidad == 4 && $curso_unico->proveedor_curso <> "OL") {
                            //Con esta funcion, obtengo los datos desde la base de moodle de este curso
                            $datos_curso_moodle = ObtenerDatosMoodle($curso_unico, $row_curso);
                            $row_curso          = $datos_curso_moodle[4];
                            $resumen_niveles_curso .= $datos_curso_moodle[5];
                            $row_curso = str_replace("{LINK_CURSO}", '<a  href="#" onclick="EjecutaExterno' . $curso_unico->id_curso . '();">', $row_curso);
                            $row_curso = str_replace("{/LINK_CURSO}", '</a>', $row_curso);
                            $row_curso = str_replace("{TOTAL_MODULOS}", $datos_curso_moodle[2], $row_curso);
                            $row_curso = str_replace("{TOTAL_MODULOS_PENDIENTES}", $datos_curso_moodle[2] - $datos_curso_moodle[3], $row_curso);
                            $row_curso = str_replace("{TOTAL_MODULOS_FINALIZADOS}", $datos_curso_moodle[3], $row_curso);
                            $row_curso = str_replace("{NOTA_OBTENIDA}", $datos_curso_moodle[1], $row_curso);
                            $row_curso = str_replace("{RUT_MOODLE}", $_SESSION["user_"], $row_curso);
                            $row_curso = str_replace("{PASS_MOODLE}", 'Gop.123456', $row_curso);
                            $row_curso = str_replace("{ACTION}", $curso_unico->urlmoodle, $row_curso);
                            $row_curso = str_replace("{ID_MOODLE}", $curso_unico->idmoodle, $row_curso);
                            $row_curso = str_replace("{CURRENTORG}", $curso_unico->currentorg, $row_curso);
                            $row_curso = str_replace("{SCOID}", $curso_unico->scoid, $row_curso);
                            $row_curso = str_replace("{CM}", $curso_unico->cm, $row_curso);
                        } else if ($curso_unico->proveedor_curso == "OL") {
                            $tiempo     = time();
                            //print_r($curso_unico);
                            //echo "<br><br>";
                            //$id_curso_test="13HY13";
                            //echo "$rut - $tiempo - ".$curso_unico->codigo_curso." - ".$curso_unico->nombre_curso."<br>";
                            $string_var = encryptMoodleAula($rut . "||" . $tiempo . "||" . $curso_unico->codigo_curso, "");
                            //$string_var=encryptMoodleAula($rut."||".$tiempo."||".$id_curso_test, "");
                            //echo $string_var."<br>";
                            $string_var = encryptMoodleAula($rut . "||" . $tiempo . "||" . $id_curso_test, "");
                            //print_r($curso_unico);exit;
                            //echo $string_var;exit;
                            $row_curso  = str_replace("{LINK_CURSO}", '<a target="_blank"  href="http://aula.openl.cl/local/minvest/login.php?token=' . $string_var . '">', $row_curso);
                            //$row_curso = str_replace("{LINK_CURSO}",'<a href="javascript: alert(\'Curso Cerrado\');">',$row_curso);
                            $row_curso  = str_replace("{/LINK_CURSO}", '</a>', $row_curso);
                        } else {
                            $row_curso = str_replace("{LINK_CURSO}", '<a href="?sw=detalle_cursoCap&idc={ID_CURSO_ENCODEADO}">', $row_curso);
                            $row_curso = str_replace("{/LINK_CURSO}", '</a>', $row_curso);
                            $row_curso = str_replace("{LINK_CURSO_JUSTURL}", '?sw=detalle_cursoCap&idc={ID_CURSO_ENCODEADO}&idinsc={ID_INSCRIPCION_ENCODEADO}', $row_curso);
                        }
                    } else {
                        $row_curso = str_replace("{LINK_CURSO}", "", $row_curso);
                        $row_curso = str_replace("{/LINK_CURSO}", "", $row_curso);
                    }
                    list($estado, $porcentaje_asistencia, $nota) = CAPACITACION_VE_ESTADO($rut, $curso_unico->codigo_curso, $curso_unico->id_inscripcion, $id_empresa);
                    $row_curso = str_replace("{ID_CURSO_ENCODEADO}", Encodear3($curso_unico->id_curso), $row_curso);
                    $row_curso = str_replace("{ESTADO}", $estado_por_curso[0], $row_curso);
                    $row_curso = str_replace("{ESTADO_CON_NOTA}", $estado_por_curso[9], $row_curso);
                    $row_curso = str_replace("{ASISTENCIA}", $estado_por_curso[0], $row_curso);
                    if ($estado_por_curso[10]) {
                        $row_curso = str_replace("{PORC_ASISTENCIA}", $estado_por_curso[10] . "%", $row_curso);
                    } else {
                        $row_curso = str_replace("{PORC_ASISTENCIA}", "-", $row_curso);
                    }
                    $row_curso = str_replace("{ESTADO}", $estado_por_curso[1], $row_curso);
                    if ($estado_por_curso[7]) {
                        $row_curso = str_replace("{NOTA}", $estado_por_curso[7], $row_curso);
                        $row_curso = str_replace("{NOTA_SIN_PORCENTAJE}", round($estado_por_curso[7]) . "%", $row_curso);
                    } else {
                        $row_curso = str_replace("{NOTA}", "-", $row_curso);
                        $row_curso = str_replace("{NOTA_SIN_PORCENTAJE}", "-", $row_curso);
                    }
                    if ($estado_por_curso[8]) {
                        $row_curso = str_replace("{FECHA_FIN}", $estado_por_curso[8], $row_curso);
                    } else {
                        $row_curso = str_replace("{FECHA_FIN}", "-", $row_curso);
                    }
                    $row_curso = str_replace("{ICONO_ESTADO_CURSO}", $estado_por_curso[2], $row_curso);
                    //$row_curso = str_replace("{AVANCE_CURSO}",$estado_por_curso[3],$row_curso);
                    if ($curso_unico->modalidad == 2) {
                        $row_curso = str_replace("{AVANCE_CURSO}", $estado_por_curso[3], $row_curso);
                    } else {
                        $row_curso = str_replace("{AVANCE_CURSO}", $estado_por_curso[4], $row_curso);
                    }
                    //Funcion para colocar Avance de Curso, Tipo Ultramar, en base a los puntos de los objetos.
                    //echo  "<br>".$estado_por_curso[6];
                    $row_curso = str_replace("{VR_COLOR_ESTADO}", $estado_por_curso[12], $row_curso);
                    $row_curso = str_replace("{VR_ICON_ESTADO}", $estado_por_curso[11], $row_curso);
                    if ($estado_por_curso[6] == 1) {
                        $cantidad_cursos_aprobados_por_clasificacion++;
                    }
                    //suma avance
                    $cla_sum_avance = $cla_sum_avance + $estado_por_curso[4];
                    //echo "<pre>";
                    //    print_r($estado_por_curso);
                    $cantidad_cursos_por_clasificacion++;
                    //AVANCE GLOBAL
                    $cla_sum_avance_total                        = $cla_sum_avance_total + $cla_sum_avance;
                    $cla_cantidad_cursos_por_clasificacion_total = $cla_cantidad_cursos_por_clasificacion_total + $cantidad_cursos_por_clasificacion;
                    $total_cursos .= $row_curso;
                }
            }
            // VISTA AVANCE POR CLASIFICACION REAL POR OBJETO
            $avance_de_clasificacion                                            = round($cla_sum_avance / $cantidad_cursos_por_clasificacion);
            $arreglo_avances_clasificaciones[$contador_arreglo_clasificaciones] = $avance_de_clasificacion;
            $contador_arreglo_clasificaciones++;
            $avance_cla = str_replace("{CLAS_IMG_NIVEL}", "img/" . $cla->imagennivel, $avance_cla);
            $avance_cla = str_replace("{CLAS_AVANCE}", $avance_de_clasificacion, $avance_cla);
            if ($avance_de_clasificacion == 100) {
                $clase_estilo_img    = "";
                $clase_estado_icono  = "fas fa-check-squares";
                $clase_estado_estilo = "etiquetaPrograma-aprobado";
                $cla_estado          = "Finalizada";
            } elseif ($avance_de_clasificacion < 100 and $avance_de_clasificacion > 0) {
                $clase_estilo_img    = "img_bn_grasycale";
                $clase_estado_icono  = "icon-note icons";
                $clase_estado_estilo = "etiquetaPrograma-proceso ";
                $cla_estado          = "En Proceso 1";
            } else {
                $clase_estilo_img    = "img_bn_grasycale";
                $clase_estado_icono  = "far fa-times-circle";
                $clase_estado_estilo = "etiquetaPrograma-noiniciado ";
                $cla_estado          = "No Iniciado";
            }
            $avance_cla = str_replace("{CLAS_ESTADO_ESTILO}", $clase_estado_estilo, $avance_cla);
            $avance_cla = str_replace("{CLAS_ESTADO_ICONO}", $clase_estado_icono, $avance_cla);
            $avance_cla = str_replace("{ESTILO_IMG_CLAS_AVANCE}", $clase_estilo_img, $avance_cla);
            $avance_cla = str_replace("{CLAS_ESTADO}", $cla_estado, $avance_cla);
            // VISTA AVANCE POR CLASIFICACION REAL POR OBJETO
            $html_cla   = str_replace("{CANTIDAD_APROBADOS_MALLA}", $cantidad_cursos_aprobados_por_clasificacion, $html_cla);
            $html_cla   = str_replace("{AVANCEMALLA}", "10", $html_cla);
            $html_cla   = str_replace("{LISTADO_CURSOS_POR_CLASIFICACION}", ($total_cursos), $html_cla);
            //echo "<br><br>hola cantidad_cursos_aprobados_por_clasificacion $cantidad_cursos_aprobados_por_clasificacion , cursos clasificacion $cantidad_cursos_por_clasificacion";
            $html_cla   = str_replace("{APROBACION_CURSOS_PROGRAMA}", round(($cantidad_cursos_aprobados_por_clasificacion * 100) / $cantidad_cursos_por_clasificacion) . "%", $html_cla);
            $total_clasificaciones .= $html_cla;
            $avance_clasificaciones .= $avance_cla;
            $i++;
            if ($classrow) {
                if ($i == $classrow) {
                    $total_clasificaciones .= "<div class='row'></div>";
                    $i = 0;
                }
            } else {
                if ($i == 2) {
                    $total_clasificaciones .= "<div class='row'></div>";
                    $i = 0;
                }
            }
        }
        //en este arreglo, tengotodos los datos de los avances porclasificacion
        $arreglo_con_avances2 = $arreglo_avances_clasificaciones;
        //aca los ordeno de manera descendente. Si el primero es 0, implica que solo el primer queda abierto
        rsort($arreglo_con_avances2);
        $cont_2  = 1;
        $abierto = "";
        foreach ($clasificaciones as $cla) {
            //echo $arreglo_avances_clasificaciones[$cont_2-2]." ".$arreglo_avances_clasificaciones[$cont_2-1]."<br><br>";
            $id_clasificacion = $cla->id_clasificacion;
            if ($arreglo_con_avances2[0] == 0) {
                $abierto = 1;
            }
            //echo "<pre>";
            //print_r($arreglo_avances_clasificaciones);
            if ($cont_2 == $abierto) {
                //echo "{BLOQUE_JS_ABIERTO_CERRADO_".$id_clasificacion."}";exit;
                $total_clasificaciones = str_replace("{BLOQUE_JS_ABIERTO_CERRADO_" . $id_clasificacion . "}", "", $total_clasificaciones);
            }
            //echo $arreglo_avances_clasificaciones[$cont_2-1]."  ".$arreglo_avances_clasificaciones[$cont_2]." -<br>";
            if (($arreglo_avances_clasificaciones[$cont_2 - 2] == 100 && $arreglo_avances_clasificaciones[$cont_2 - 1] < 100) or ($arreglo_avances_clasificaciones[$cont_2 - 2] === "" && $arreglo_avances_clasificaciones[$cont_2 - 1] < 100)) {
                $total_clasificaciones = str_replace("{BLOQUE_JS_ABIERTO_CERRADO_" . $id_clasificacion . "}", "", $total_clasificaciones);
                $total_clasificaciones = str_replace("{LINK_ABRE_CIERRA_" . $id_clasificacion . "}", "show_hide" . $id_clasificacion, $total_clasificaciones);
            } else if ($arreglo_avances_clasificaciones[$cont_2 - 1] < 100 && $arreglo_avances_clasificaciones[$cont_2 - 1] > 0 && $arreglo_avances_clasificaciones[$cont_2] == 0) {
                $total_clasificaciones = str_replace("{BLOQUE_JS_ABIERTO_CERRADO_" . $id_clasificacion . "}", "", $total_clasificaciones);
                $total_clasificaciones = str_replace("{LINK_ABRE_CIERRA_" . $id_clasificacion . "}", "show_hide" . $id_clasificacion, $total_clasificaciones);
            } else {
                $total_clasificaciones = str_replace("{BLOQUE_JS_ABIERTO_CERRADO_" . $id_clasificacion . "}", '$(".slidingDiv' . $id_clasificacion . '").hide();', $total_clasificaciones);
                $total_clasificaciones = str_replace("{LINK_ABRE_CIERRA_" . $id_clasificacion . "}", "", $total_clasificaciones);
            }
            $cont_2++;
        }
    }
    //echo "$cla_sum_avance_total $cla_cantidad_cursos_por_clasificacion_total"
    $avance_real      = round($cla_sum_avance_total / $cla_cantidad_cursos_por_clasificacion_total);
    $lms_medalla_tips = lms_medalla_tips($rut, $id_empresa);
    $PRINCIPAL        = str_replace("{NUMERO_AVANCE_REAL}", $avance_real, $PRINCIPAL);
    $PRINCIPAL        = str_replace("{LMS_NUM_TIPS}", $lms_medalla_tips[0]->cuentatips, $PRINCIPAL);
    $PRINCIPAL        = str_replace("{LMS_NUM_MEDALLAS}", $lms_medalla_tips[0]->cuentamedallas, $PRINCIPAL);
    $PRINCIPAL        = str_replace("{ROW_CURSOS_RESUMENES2}", $resumen_niveles_curso, $PRINCIPAL);
    $PRINCIPAL        = str_replace("{APROBACION_CURSOS_PROGRAMA}", round(($cantidad_cursos_aprobados_por_clasificacion * 100) / $cantidad_cursos_por_clasificacion), $PRINCIPAL);
    $PRINCIPAL        = str_replace("{NUM_INSCRIPCIONES}", ($numero_cursos_total_up), $PRINCIPAL);
    $PRINCIPAL        = str_replace("{NUM_CURSOS}", ($numero_cursos_total_desdemalla_up), $PRINCIPAL);
    $PRINCIPAL        = str_replace("{ROWS_CLASIFICACIONES}", utf8_encode($total_clasificaciones), $PRINCIPAL);
    $PRINCIPAL        = str_replace("{BLOQUE_AVANCE_CLASIFICACIONES}", utf8_encode($avance_clasificaciones), $PRINCIPAL);
    if ($tipo_llamada == "admin") {
        $arreglo[0] = $PRINCIPAL;
        $arreglo[1] = $porcentaje_avance_por_usuario;
        $arreglo[2] = $datos_usuario_para_admin;
        //Numero de cursos
        $arreglo[3] = $numero_cursos_total_desdemalla_up;
        return ($arreglo);
    } else {
        return ($PRINCIPAL);
    }
}
function ColocaBloqueFeedback($PRINCIPAL, $datos_evaluacion, $id_empresa)
{
    $evaluado            = $datos_evaluacion[0]->evaluado;
    $evaluador           = $datos_evaluacion[0]->evaluador;
    $id_proceso          = $datos_evaluacion[0]->id_proceso;
    $feedback_finalizado = VErificaFeedbackFinalizado($evaluado, $evaluador, $id_proceso, $id_empresa);
    if ($feedback_finalizado) {
        $html_feedback = file_get_contents("views/sgd/feedback/formulario_lectura.html");
        $feedback      = TraeDatosPorFeedback($evaluado, $evaluador, $id_proceso);
        $html_feedback = str_replace("{RECIBI_FEEDBACK}", $feedback[0]->realizado, $html_feedback);
        $html_feedback = str_replace("{PREGUNTA1}", utf8_encode($feedback[0]->pregunta1), $html_feedback);
        $html_feedback = str_replace("{PREGUNTA2}", utf8_encode($feedback[0]->pregunta2), $html_feedback);
        $html_feedback = str_replace("{PREGUNTA3}", utf8_encode($feedback[0]->pregunta3), $html_feedback);
        $html_feedback = str_replace("{PREGUNTA4}", utf8_encode($feedback[0]->pregunta4), $html_feedback);
    } else {
        $html_feedback = file_get_contents("views/sgd/feedback/formulario.html");
        $html_feedback = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($evaluado), $html_feedback);
        $html_feedback = str_replace("{RUT_EVALUADOR_ENCODEADO}", Encodear3($evaluador), $html_feedback);
        $html_feedback = str_replace("{ID_PROCESO_ENCODEADO}", Encodear3($id_proceso), $html_feedback);
    }
    $PRINCIPAL = str_replace("{BLOQUE_FEEDBACK}", $html_feedback, $PRINCIPAL);
    return ($PRINCIPAL);
}
function LiberadoFeedbackLiberado($evaluado, $evaluador, $calibrador, $id_proceso, $id_empresa)
{
    if ($evaluado == $evaluador) {
        $relacion   = ObtenerJefeRelPorProceso($evaluado, $id_proceso);
        $evaluador  = $relacion[0]->evaluador;
        $calibrador = $relacion[0]->calibrador;
    }
    $feedback_finalizado = VErificaFeedbackFinalizado($evaluado, $evaluador, $id_proceso, $id_empresa);
    if ($feedback_finalizado) {
        $arreglo[0] = '<span class="etiquetaSGDSello">Feedback Realizado</span>';
    } else {
        $relacion_liberada = TraeLiberadoEvaluadoEvaluadorCalibrador($evaluado, $evaluador, $calibrador, $id_proceso);
        if ($relacion_liberada) {
            $arreglo[0] = '<span class="etiquetaSGDSello">Informe Liberado</span>';
        }
    }
    return ($arreglo);
}
Function GraficoPorCompetenciasPorEvaluadorCalibrador($evaluador, $id_proceso, $calibrador, $evaluado, $origen, $arreglo_post)
{
    //la variable origen es para ver si viene desde el admin o no
    $datos_empresa = DatosEmpresa($_SESSION["id_empresa"]);
    if ($origen == "admin") {
        $grafico = file_get_contents("../front/views/sgd/graficos/barra_frecuenciaCompetencias2.html");
    } else {
        $grafico = file_get_contents("views/sgd/graficos/barra_frecuenciaCompetencias2.html");
    }
    if ($arreglo_post["rutevaluador"])
        $evaluador = $arreglo_post["rutevaluador"];
    if ($arreglo_post["rutcalibrador"])
        $evaluador = $arreglo_post["rutcalibrador"];
    if ($evaluado) {
        //$relaciones=TraeDatosRelacionEvaluadoEvaluadorProceso($evaluado, $evaluador, $id_proceso);
        $relaciones = TraeDatosRelacionEvaluadoEvaluadorProceso($evaluado, $evaluador, $id_proceso);
        $perfiles   = TotalPerfilesDadoEvaluador1PorProcesoEvaluado($evaluador, $id_proceso, $evaluado);
    } else if ($evaluador) {
        //Traigo las evaluaciones, en base al evaluador
        $relaciones = TraeRelacionesSinAe($evaluador, $id_proceso);
        $perfiles   = TotalPerfilesDadoEvaluador1PorProceso($evaluador, $id_proceso);
    } else if ($calibrador) {
        //Traigo las evaluaciones en funcion al calibrador
        $relaciones = TraeRelacionesSinAeCalibrador($calibrador, $id_proceso);
        $perfiles   = TotalPerfilesDadoEvaluador1PorProcesoPorCalibrador($calibrador, $id_proceso);
    } else if ($id_proceso) {
        //$relaciones=TraeRelacionesSoloProceso($id_proceso);
        $relaciones = TraeRelacionesSoloProcesoSinAe($id_proceso, $arreglo_post);
        $perfiles   = TotalPerfilesDadoEvaluador1SoloProceso($id_proceso, $arreglo_post);
    }
    for ($i = 0; $i < count($perfiles); $i++) {
        $sql .= " perfil_evaluacion='" . $perfiles[$i]->id_perfil_ev . "'";
        if ($perfiles[$i + 1]->id_perfil_ev)
            $sql .= " or";
    }
    $total_competencias    = TotalIdCompetenciasSoloCompetencias($sql);
    $contador_competencias = 0;
    foreach ($total_competencias as $competencia) {
        //Por cada competencia, hago el ciclo de los evaluados, para por cada uno, traer el promedio de su competencia
        $contador   = 0;
        $acumulador = 0;
        foreach ($relaciones as $rel) {
            //Por cada uno, traigo las respuestas
            $promedio_por_comp_evaluado = PromedioPorCompetenciaDadoEvaluadoEvaluadoProcesoIdCOmpReporte($rel->evaluado, $rel->evaluador, $rel->id_proceso, $competencia->id_componente_reporte);
            if ($promedio_por_comp_evaluado[0]->promedio_comp) {
                $acumulador = $acumulador + $promedio_por_comp_evaluado[0]->promedio_comp;
                $contador++;
            }
        }
        $arreglo_promedio_competencias[$contador_competencias]["id"]     = $competencia->id_componente_reporte;
        $arreglo_promedio_competencias[$contador_competencias]["nombre"] = utf8_encode($competencia->nombre);
        $arreglo_promedio_competencias[$contador_competencias]["nota"]   = $acumulador / $contador;
        $arreglo_promedio_competencias[$contador_competencias]["sigla"]  = utf8_encode($competencia->nombre);
        $contador_competencias++;
    }
    foreach ($arreglo_promedio_competencias as $key => $row) {
        $aux[$key] = $row['nota'];
    }
    array_multisort($aux, SORT_DESC, $arreglo_promedio_competencias);
    $contador_ = 1;
    for ($i = 0; $i < count($arreglo_promedio_competencias); $i++) {
        $datos .= "['" . $arreglo_promedio_competencias[$i]['sigla'] . "', " . ColocaDecimalesNotasFinales(2, $arreglo_promedio_competencias[$i]['nota']) . "]";
        if ($contador_ < count($arreglo_promedio_competencias))
            $datos .= ",";
        $contador_++;
    }
    $grafico = str_replace("{ARREGLO_DATOS}", $datos, $grafico);
    $grafico = str_replace("{TITULO_GRAFICO_1}", "Titulo", $grafico);
    $grafico = str_replace("{COLOR_GRAFICO}", $datos_empresa[0]->color_grafico1, $grafico);
    return ($grafico);
}
function ConsolidadoLineal($evaluador, $calibrador, $id_proceso, $id_empresa, $origen, $arreglo_post)
{
    if ($origen == "admin") {
        $grafico = file_get_contents("../front/views/sgd/graficos/" . $id_empresa . "_graficoLineas1.html");
    } else {
        $grafico = file_get_contents("views/sgd/graficos/" . $id_empresa . "_graficoLineas1.html");
    }
    if ($arreglo_post["rutevaluador"])
        $evaluador = $arreglo_post["rutevaluador"];
    if ($arreglo_post["rutcalibrador"])
        $calibrador = $arreglo_post["rutcalibrador"];
    if ($evaluador) {
        //Traigo las evaluaciones, en base al evaluador
        $relaciones = TraeRelacionesSinAe($evaluador, $id_proceso);
    } else if ($calibrador) {
        //Traigo las evaluaciones en funcion al calibrador
        $relaciones = TraeRelacionesSinAeCalibrador($calibrador, $id_proceso);
    } else if ($id_proceso) {
        $relaciones = TraeRelacionesSoloProcesoParaGrafico($id_proceso, $arreglo_post);
    }
    for ($i = 1; $i <= 17; $i++) {
        ${'rango' . $i} = 0;
    }
    foreach ($relaciones as $rel) {
        $nota = ResultadosFinales($rel->evaluado, $rel->evaluador, $id_proceso, "");
        if ($arreglo_post["tipo_reporte"] == "individuales") {
            $nota_final = $nota[31];
            //echo $nota[18]." -  ".$nota[27]."<br>";
        } else {
            //Este if lo hago solo para que tome las evaluaciones finalizadas
            if ($nota[41] == "si") {
                $nota_final = $nota[27];
            } else {
                //$nota_final=$nota[27];
                continue;
            }
        }
        //echo $nota_final." ".$rel->evaluado;
        // echo "<br>";
        if ($id_empresa == 28) {
            if ($nota_final >= 1 && $nota_final < 1.25) {
                $rango1++;
            } else if ($nota_final >= 1.25 && $nota_final < 1.5) {
                $rango2++;
            } else if ($nota_final >= 1.5 && $nota_final < 1.75) {
                $rango3++;
            } else if ($nota_final >= 1.75 && $nota_final < 2) {
                $rango4++;
            } else if ($nota_final >= 2 && $nota_final < 2.25) {
                $rango5++;
            } else if ($nota_final >= 2.25 && $nota_final < 2.5) {
                $rango6++;
            } else if ($nota_final >= 2.25 && $nota_final < 2.5) {
                $rango7++;
            } else if ($nota_final >= 2.5 && $nota_final < 2.75) {
                $rango8++;
            } else if ($nota_final >= 2.75 && $nota_final < 3) {
                $rango9++;
            } else if ($nota_final >= 3 && $nota_final < 3.25) {
                $rango10++;
            } else if ($nota_final >= 3.25 && $nota_final < 3.5) {
                $rango11++;
            } else if ($nota_final >= 3.5 && $nota_final < 3.75) {
                $rango12++;
            } else if ($nota_final >= 3.75 && $nota_final < 4) {
                $rango13++;
            } else if ($nota_final >= 4 && $nota_final < 4.25) {
                $rango14++;
            } else if ($nota_final >= 4.25 && $nota_final < 4.5) {
                $rango15++;
            } else if ($nota_final >= 4.5 && $nota_final < 4.75) {
                $rango16++;
            } else if ($nota_final >= 4.75 && $nota_final < 4.75) {
                $rango17++;
            }
        } else if ($id_empresa == 43) {
            if ($nota_final >= 1 && $nota_final < 50) {
                $rango1++;
            } else if ($nota_final >= 50 && $nota_final < 90) {
                $rango2++;
            } else if ($nota_final >= 90 && $nota_final < 110) {
                $rango3++;
            } else if ($nota_final >= 110 && $nota_final < 119) {
                $rango4++;
            } else if ($nota_final >= 119 && $nota_final < 121) {
                $rango5++;
            }
        }
    }
    for ($i = 1; $i <= 17; $i++) {
        $grafico = str_replace("{RANGO" . $i . "}", ${'rango' . $i}, $grafico);
    }
    $datos_empresa = DatosEmpresa($id_empresa);
    $grafico       = str_replace("{COLOR_GRAFICO}", $datos_empresa[0]->color_grafico1, $grafico);
    return ($grafico);
}
function AvanceDeEvaluados($evaluador, $id_proceso, $campo_criterio, $valor_criterio, $id_proceso_anual, $evaluado, $tipo_reporte, $campo1, $valorcampo1, $campo2, $valorcampo2, $campo3, $valorcampo3)
{
    if ($campo1 or $campo2 or $campo3) {
        //echo "$campo1, $valorcampo1, $campo2, $valorcampo2, $campo3, $valorcampo3";
        $rel = DAtosEvaluadoEvaluadorParaAvancePorEvaluadorPorCampo123($id_proceso, $campo1, $valorcampo1, $campo2, $valorcampo2, $campo3, $valorcampo3, $tipo_reporte);
    } else if ($valor_criterio && $campo_criterio && $id_proceso) {
        //$rel=DAtosEvaluadoEvaluadorParaAvancePorEvaluadorPorCriterios($id_proceso, $campo_criterio, $valor_criterio, $tipo_reporte);
        $rel = DAtosEvaluadoEvaluadorParaAvancePorEvaluadorPorCriteriosV2($id_proceso, $campo_criterio, $valor_criterio, $tipo_reporte);
    } else if ($evaluador && $id_proceso && !$evaluado) {
        //$rel=DAtosEvaluadoEvaluadorParaAvancePorEvaluador($evaluador, $id_proceso);
        $rel = DAtosEvaluadoEvaluadorParaAvancePorEvaluadorV2($evaluador, $id_proceso);
    } else if ($id_proceso && !$evaluado) {
        $rel = DAtosEvaluadoEvaluadorParaAvancePorSoloProceso($id_proceso);
    } else if ($id_proceso_anual && !$evaluado) {
        $rel = DAtosEvaluadoEvaluadorParaAvancePorIdProcesoAnual($id_proceso_anual);
    } else if ($evaluado && $evaluador) {
        //$rel=DAtosEvaluadoEvaluadorParaAvancePorEvaluadoEvaluador($evaluador, $id_proceso, $evaluado);
        //$rel=DAtosEvaluadoEvaluadorParaAvancePorEvaluadoEvaluadorEvalIndividual($evaluador, $id_proceso, $evaluado);
        $rel = DAtosEvaluadoEvaluadorParaAvancePorEvaluadoEvaluadorEvalIndividualV2($evaluador, $id_proceso, $evaluado);
        //if($rel[0]->pagina==$rel[0]->total_preguntas)$rel[0]->pagina=$rel[0]->pagina-1;
    }
    $contador = 0;
    foreach ($rel as $rel_unico_dato) {
        //Por cada evaluado, traigo la cantidad de preguntas que debiese tener
        //$porcentaje_individual=($rel_unico_dato->pagina*100)/$rel_unico_dato->total_preguntas;
        //echo $rel_unico_dato->total_preguntas." - ".$rel_unico_dato->pagina."<br>";
        $k                     = (100 / ($rel_unico_dato->total_preguntas - 1));
        $porcentaje_individual = ($k * $rel_unico_dato->pagina) - $k;
        if ($porcentaje_individual <= 0) {
            $porcentaje_individual = 0;
        }
        $acumulador = $acumulador + $porcentaje_individual;
        $contador++;
    }
    //$porcentaje_total[0]=FormatearPorcentajes($acumulador/$contador);
    $porcentaje_total[0] = FormatearPorcentajesCon1Decimal($acumulador / $contador);
    return ($porcentaje_total);
}
function colocarPesos($valor)
{
    $valor = number_format($valor, 0, ",", ".");
    return ($valor);
}
function FormatearPorcentajesCon1Decimal($valor)
{
    $valor = number_format($valor, 1, ",", ".");
    return ($valor);
}
function FormatearPorcentajes($valor)
{
    $valor = number_format($valor, 0, ",", ".");
    return ($valor);
}
function ListadoTotalColaboradoresObjetivos($html, $rut, $proceso_anual, $id_empresa, $id_proceso, $tipo_sgd, $id_proceso_a_evaluar)
{
    $total_evaluados = "";
    //$row=file_get_contents("views/sgd/listado_colaboradores/row_colaboradores_objetivo.html");
    $entorno         = str_replace("{SECCION_GRAFICOS_CONSOLIDADOS}", file_get_contents("views/sgd/vista_consolidada_graficos.html"), $entorno);
    $entorno         = str_replace("{GRAFICO1.1}", ConsolidadoLineal($rut, "", $id_proceso_calibrar, $id_empresa), $entorno);
    $entorno         = str_replace("{GRAFICO1.2}", GraficoPorCompetenciasPorEvaluadorCalibrador($rut, $id_proceso_calibrar, ""), $entorno);
    $html            = ColocaDatosUsuario($html, $rut);
    $html            = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($rut), $html);
    $datos_usuario   = UsuarioEnBasePersonas($rut);
    $html            = str_replace("{NOMBRE_DEPENDIENTE}", utf8_encode($datos_usuario[0]->nombre), $html);
    $html            = str_replace("{PARAMETROS_EVAL}", Encodear3($ev->rut . ";" . $rut), $html);
    if ($tipo_sgd == 2) {
        $entorno         = file_get_contents("views/sgd/sgd2_entorno_equipo_chilquinta.html");
        $tiene_evaluados = TraeRelacionesSinAe($rut, $id_proceso);
        $entorno         = str_replace("{SECCION_EQUIPO_CONSOLIDADO}", "", $entorno);
    } else {
        $entorno = file_get_contents("views/sgd/sgd2_entorno_equipo.html");
    }
    $entorno            = str_replace("{SECCION_GRAFICOS_CONSOLIDADOS}", file_get_contents("views/sgd/vista_consolidada_graficos.html"), $entorno);
    $entorno            = str_replace("{GRAFICO1.1}", ConsolidadoLineal($rut, "", $id_proceso, $id_empresa), $entorno);
    $entorno            = str_replace("{GRAFICO1.2}", GraficoPorCompetenciasPorEvaluadorCalibrador($rut, $id_proceso, ""), $entorno);
    //valido, si es que este evaluador esta liberado para este proceso.
    //Si es asi, no muestro el boton Evaluar Equipo.
    $evaluador_liberado = TraeCantidadLiberadosPorEvaluador($rut, $id_proceso);
    if ($evaluador_liberado) {
        $entorno = str_replace("{BOTON_EVALUAR_EQUIPO}", "", $entorno);
    } else {
        $entorno = str_replace("{BOTON_EVALUAR_EQUIPO}", file_get_contents("views/sgd/" . $id_empresa . "_boton_evaluar_equipo.html"), $entorno);
    }
    $entorno   = str_replace("{TABLA_DATOS_USUARIO_SUPERIOR}", file_get_contents("views/sgd/tabla_datos_superior_usuario.html"), $entorno);
    $entorno   = ColocaDatosUsuario($entorno, $rut, "graficoFrecuenciaCompetencia");
    $evaluados = TraeEvaluadosDadoEvaluadorPorProceso2($rut, 55);
    if (!$evaluados) {
        $row_mis_objetivos = file_get_contents("views/sgd/listado_colaboradores/row_colaboradores_objetivo.html");
        $total_evaluados .= ColocaDatosUsuario($row, $rut);
        $total_evaluados         = str_replace("{BOTON_BITACORA}", file_get_contents("views/sgd/listado_colaboradores/boton_ingresa_objetivos.html"), $total_evaluados);
        $entorno                 = str_replace("{LISTADO_COLABORADORES}", ($total_evaluados), $entorno);
        $html                    = str_replace("{ENTORNO_LISTADO_COLABORADORES}", ($entorno), $html);
        $total_objetivos         = TraeObjetivosIndividualesDadoRut($rut);
        $total_evaluados         = str_replace("{CANTIDAD}", count($total_objetivos), $total_evaluados);
        $total_objetivos_conpond = TraeObjetivosIndividualesDadoRutConPond($rut);
        $total_evaluados         = str_replace("{X_VALIDADOS}", count($total_objetivos_conpond), $total_evaluados);
        $total_objetivos_sinpond = TraeObjetivosIndividualesDadoRutSinPond($rut);
        $total_evaluados         = str_replace("{X_NO_VALIDADOS}", count($total_objetivos_sinpond), $total_evaluados);
    } else {
        $total_evaluados   = "";
        $obj_fin           = 0;
        $row_mis_objetivos = file_get_contents("views/sgd/listado_colaboradores/row_colaboradores_objetivo.html");
        $total_evaluados .= ColocaDatosUsuario($row, $rut);
        $total_evaluados         = str_replace("{BOTON_BITACORA}", file_get_contents("views/sgd/listado_colaboradores/boton_ingresa_objetivos.html"), $total_evaluados);
        $total_objetivos         = TraeObjetivosIndividualesDadoRut($rut);
        $total_evaluados         = str_replace("{CANTIDAD}", count($total_objetivos), $total_evaluados);
        $total_objetivos_conpond = TraeObjetivosIndividualesDadoRutConPond($rut);
        //$total_evaluados = str_replace("{X_VALIDADOS}",count($total_objetivos_conpond),$total_evaluados);
        $total_objetivos_sinpond = TraeObjetivosIndividualesDadoRutSinPond($rut);
        $total_evaluados         = str_replace("{X_NO_VALIDADOS}", count($total_objetivos_sinpond), $total_evaluados);
        foreach ($evaluados as $ev) {
            //COMENTADO PARA OPTIMIZAR 22-11-2015
            $row = file_get_contents("views/sgd/listado_colaboradores/row_colaboradores_objetivo.html");
            $total_evaluados .= ColocaDatosUsuario($row, $ev->rut);
            $total_evaluados = str_replace("{BOTON_BITACORA}", file_get_contents("views/sgd/listado_colaboradores/boton_ve_objetivos_equipo.html"), $total_evaluados);
            if ($tipo_sgd == 2) {
                $total_evaluados   = str_replace("{TABLA_RESUMEN1}", file_get_contents("views/sgd/informe/tabla_superior_resumen/tabla_resumen1_sinareacorp_dinamico_chilquinta.html"), $total_evaluados);
                //aca verifico de manera individual si es que fue liberado o no este evaluado
                $evaluado_liberado = TraeLiberadoEvaluadoEvaluadorCalibrador($ev->rut, $rut, $ev->calibrador, $ev->id_proceso);
                if ($evaluado_liberado) {
                    $total_evaluados = str_replace("{BOTON_EVALUACION_INDIVIDUAL}", "", $total_evaluados);
                } else {
                    $total_evaluados = str_replace("{BOTON_EVALUACION_INDIVIDUAL}", file_get_contents("views/sgd/informe/tabla_superior_resumen/boton_eval_individual.html"), $total_evaluados);
                }
                $total_evaluados = str_replace("{BOTON_FEEDBACK}", "", $total_evaluados);
                $total_evaluados = str_replace("{BOTON_VE_INFORME_POR_PROCESO}", "", $total_evaluados);
                $total_evaluados = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($ev->rut), $total_evaluados);
                $total_evaluados = str_replace("{ID_PROCESO_ENCODEADO}", Encodear3($id_proceso), $total_evaluados);
            } else {
                $total_evaluados = str_replace("{TABLA_RESUMEN1}", file_get_contents("views/sgd/informe/tabla_superior_resumen/tabla_resumen1_sinareacorp_dinamico.html"), $total_evaluados);
            }
            $total_evaluados         = ArmaTemplareDeTablaResumen($total_evaluados, $proceso_anual, $id_empresa, $ev->perfil_evaluacion, $ev->rut, $rut);
            //total de Objetivos
            $total_objetivos         = TraeObjetivosIndividualesDadoRut($ev->rut);
            $total_evaluados         = str_replace("{CANTIDAD}", count($total_objetivos), $total_evaluados);
            $total_objetivos_conpond = TraeObjetivosIndividualesDadoRutConPond($ev->rut);
            $total_evaluados         = str_replace("{X_VALIDADOS}", count($total_objetivos_conpond), $total_evaluados);
            $total_objetivos_sinpond = TraeObjetivosIndividualesDadoRutSinPond($ev->rut);
            $total_evaluados         = str_replace("{X_NO_VALIDADOS}", count($total_objetivos_sinpond), $total_evaluados);
            //Verifico si est? finalizado este evaluado en el proceso de objetivos
            $feedback_objetivos      = TomoConocimientoEvaluado($ev->rut);
            if ($feedback_objetivos) {
                $obj_fin++;
            }
            //$total_evaluados = ColocaPonderaciones($total_evaluados, $ev->rut);
            $total_evaluados = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($ev->rut), $total_evaluados);
            //$total_evaluados=ColocaResultadosTablaReumen($total_evaluados, $ev->rut, $rut);
            $total_evaluados = SemaforosEstadosObjetivos($total_evaluados, $ev->rut, $_SESSION["ano_proceso_anual"]);
        }
        $nota_final_evaluados = $acummulador_notas / $contador;
        $entorno              = ObtieneResumenesNotasFinalesPorEvaluador($entorno, $rut, $id_proceso);
        //aca calculo el porcentaje de avance de objetivos de todos los colaboradores.
        $entorno              = str_replace("{POR_AVANCE_OBJ}", ($obj_fin * 100) / count($evaluados), $entorno);
        $entorno              = str_replace("{POR_AVANCE_EV_EQUIPO}", 0, $entorno);
        $entorno              = str_replace("{LISTADO_COLABORADORES}", ($total_evaluados), $entorno);
        $html                 = str_replace("{ENTORNO_LISTADO_COLABORADORES}", ($entorno), $html);
    }
    return ($html);
}
function BloqueListadoSalonFama($html, $id_empresa, $id_categoria, $ano)
{
    //Traigo el listado de usuarios para ver en Clasicos
    //$datos=TraeListadoClasicos($id_empresa, "", "order by antiguedad desc");
    //$datos=TotalReconocimientosPorCategoriaGenerico($id_categoria, $id_empresa);
    $datos       = TotalReconocimientosPorCategoriaGenericoPorAno($id_categoria, $id_empresa, $ano);
    $subtitulo   = "";
    //echo round($datos[0]->antiguedad/5);
    $valor_mayor = (round($datos[0]->antiguedad / 10) * 10);
    $html        = str_replace("{TITULO_SALON_FAMA}", utf8_encode($datos[0]->titulo_pagina), $html);
    $html        = str_replace("{DESCRIPCION}", utf8_encode($datos[0]->descripcion_categoria), $html);
    $valor_menor = $valor_mayor - 10;
    //echo "<br>";
    $j           = 0;
    foreach ($datos as $unico) {
        $row .= file_get_contents("views/salondelafama/row_generico.html");
        $row = str_replace("{NOMBRE}", $unico->nombre_completo, $row);
        $row = str_replace("{ANOS}", $unico->antiguedad, $row);
        $row = str_replace("{CARGO}", $unico->cargo, $row);
        $row = str_replace("{URL_PERSONA}", VerificaFotoPersonal($unico->rut), $row);
        $row = str_replace("{RUT_ENCODEADO}", Encodear3($unico->rut), $row);
    }
    $html = str_replace("{BLOQUE_LISTADO_CLASICOS}", utf8_Encode($row), $html);
    return ($html);
}
function ObtieneResumenesNotasFinalesPorEvaluador($entorno, $rut_evaluador, $id_proceso, $calibrador)
{
    if ($calibrador) {
        //$evaluados=TraeEvaluadosDadoEvaluadorPorProceso2PorCalibrador($calibrador, $id_proceso);
        $evaluados = TraeEvaluadosDadoEvaluadorPorProceso2PorCalibradorSinAe($calibrador, $id_proceso);
    } else {
        //$evaluados=TraeEvaluadosDadoEvaluadorPorProceso2($rut_evaluador, $id_proceso);
        $evaluados = TraeEvaluadosDadoEvaluadorPorProceso2SinAe($rut_evaluador, $id_proceso);
    }
    foreach ($evaluados as $ev) {
        $datos_resumen = ResultadosFinales($ev->rut, $ev->evaluador, $id_proceso, "");
        //PARA CHILQUINTA ES SOLO LA COMP, PARA TURBUS, EL PROMEDIO ENTRE COMP Y OBJ
        if ($datos_resumen[27] > 0) {
            $acummulador_notas = $acummulador_notas + $datos_resumen[27];
            $contador++;
        }
        //ESPECIFICOS
        if (round($datos_resumen[31]) > 0) {
            $acumulador_objetivos = $acumulador_objetivos + round($datos_resumen[31]);
            $contador_obj++;
        }
        if ($datos_resumen[32] > 0) {
            $acumulador_nota_competencias = $acumulador_nota_competencias + $datos_resumen[32];
            $contador_competencias++;
        }
        $datos_resumen_ae = ResultadosFinales($ev->rut, $ev->rut, $id_proceso, "");
        if ($datos_resumen_ae[27] > 0) {
            $acummulador_notas_ae = $acummulador_notas_ae + $datos_resumen_ae[27];
            $contador_ae++;
        }
    }
    if ($_SESSION["id_empresa"] == 43) {
        $nota_final_evaluados = (($acumulador_nota_competencias / $contador_competencias) * 0.4) + (($acumulador_objetivos / $contador_obj) * 0.6);
    } else {
        $nota_final_evaluados = $acummulador_notas / $contador;
    }
    $nota_final_objetivos    = $acumulador_objetivos / $contador_obj;
    $nota_final_competencias = $acumulador_nota_competencias / $contador_competencias;
    if ($nota_final_competencias) {
        $datos_nota_final_evaluados_competencias = ObtenerCriterioPuntajeMatrizNotaFinal($nota_final_competencias, "", 0, "nota_final", $rut_evaluador, $id_proceso);
        $entorno                                 = str_replace("{NOTA_COMP_ESPE_INT}", ColocaDecimalesNotasFinales(2, $nota_final_competencias), $entorno);
        $entorno                                 = str_replace("{CRITERIO_COMP_ESPE_INT}", $datos_nota_final_evaluados_competencias[0], $entorno);
        $entorno                                 = str_replace("{ESTILO_COMP_ESPE_INT}", $datos_nota_final_evaluados_competencias[2], $entorno);
    } else {
        $entorno = str_replace("{NOTA_COMP_ESPE_INT}", "", $entorno);
        $entorno = str_replace("{CRITERIO_COMP_ESPE_INT}", "", $entorno);
        $entorno = str_replace("{ESTILO_COMP_ESPE_INT}", "", $entorno);
    }
    if ($nota_final_objetivos) {
        $datos_nota_final_evaluados_objetivos = ObtenerCriterioPuntajeMatrizNotaFinal($nota_final_objetivos, "", 0, "nota_final", $rut_evaluador, $id_proceso);
        $entorno                              = str_replace("{NOTA_OBJ_ESP_INT}", ColocaDecimalesNotasFinales(2, $nota_final_objetivos), $entorno);
        $entorno                              = str_replace("{CRITERIO_OBJ_ESP_INT}", $datos_nota_final_evaluados_objetivos[0], $entorno);
        $entorno                              = str_replace("{ESTILO_OBJ_ESP_INT}", $datos_nota_final_evaluados_objetivos[2], $entorno);
    }
    if ($contador_competencias == count($evaluados)) {
        if ($nota_final_evaluados) {
            if ($calibrador) {
                //$datos_nota_final_evaluados=ObtenerCriterioPuntajeMatrizNotaFinal($nota_final_evaluados, $evaluados[0]->evaluador, 0, "nota_final", $evaluados[0]->evaluador, $id_proceso);
                $datos_nota_final_evaluados = ObtenerCriterioPuntajeMatrizNotaFinal($nota_final_evaluados, "", 0, "nota_final", $evaluados[0]->evaluador, $id_proceso);
            } else {
                //$datos_nota_final_evaluados=ObtenerCriterioPuntajeMatrizNotaFinal($nota_final_evaluados, $rut_evaluador, 0, "nota_final", $evaluados[0]->evaluador, $id_proceso);
                $datos_nota_final_evaluados = ObtenerCriterioPuntajeMatrizNotaFinal($nota_final_evaluados, "", 0, "nota_final", $rut_evaluador, $id_proceso);
            }
            $entorno = str_replace("{NOTA_FINAL}", ColocaDecimalesNotasFinales(2, $nota_final_evaluados), $entorno);
            $entorno = str_replace("{ESTILO_NOTA_FINAL}", $datos_nota_final_evaluados[2], $entorno);
            $entorno = str_replace("{ICONO_NOTA_FINAL}", $datos_nota_final_evaluados[3], $entorno);
            $entorno = str_replace("{CRITERIO_NOTA_FINAL}", $datos_nota_final_evaluados[0], $entorno);
        } else {
            $entorno = str_replace("{NOTA_FINAL}", "", $entorno);
            $entorno = str_replace("{ESTILO_NOTA_FINAL}", "etiquetaPrograma-pendiente", $entorno);
            $entorno = str_replace("{ICONO_NOTA_FINAL}", "circle-icon-sgd-3", $entorno);
            $entorno = str_replace("{CRITERIO_NOTA_FINAL}", "Pendiente", $entorno);
        }
    } else {
        $entorno = str_replace("{NOTA_FINAL}", "", $entorno);
        $entorno = str_replace("{ESTILO_NOTA_FINAL}", "etiquetaPrograma-pendiente", $entorno);
        $entorno = str_replace("{ICONO_NOTA_FINAL}", "circle-icon-sgd-3", $entorno);
        $entorno = str_replace("{CRITERIO_NOTA_FINAL}", "Pendiente", $entorno);
    }
    $nota_final_evaluados_ae = $acummulador_notas_ae / $contador_ae;
    if ($nota_final_evaluados_ae) {
        if ($calibrador) {
            //$datos_nota_final_evaluados_ae=ObtenerCriterioPuntajeMatrizNotaFinal($nota_final_evaluados_ae, $evaluados[0]->evaluador, 0, "nota_final", $evaluados[0]->evaluador, $id_proceso);
            $datos_nota_final_evaluados_ae = ObtenerCriterioPuntajeMatrizNotaFinal($nota_final_evaluados_ae, "", 0, "nota_final", $rut_evaluador, $id_proceso);
        } else {
            //$datos_nota_final_evaluados_ae=ObtenerCriterioPuntajeMatrizNotaFinal($nota_final_evaluados_ae, $rut_evaluador, 0, "nota_final", $evaluados[0]->evaluador, $id_proceso);
            $datos_nota_final_evaluados_ae = ObtenerCriterioPuntajeMatrizNotaFinal($nota_final_evaluados_ae, "", 0, "nota_final", $rut_evaluador, $id_proceso);
        }
        $entorno = str_replace("{NOTA_COMP_ESPE_INT_AE}", ColocaDecimalesNotasFinales(2, $nota_final_evaluados_ae), $entorno);
        $entorno = str_replace("{ESTILO_COMP_ESPE_INT_AE}", $datos_nota_final_evaluados_ae[2], $entorno);
        $entorno = str_replace("{ICONO_COMP_ESPE_INT_AE}", $datos_nota_final_evaluados_ae[3], $entorno);
        $entorno = str_replace("{CRITERIO_COMP_ESPE_INT_AE}", $datos_nota_final_evaluados_ae[0], $entorno);
    } else {
        $entorno = str_replace("{NOTA_COMP_ESPE_INT_AE}", "", $entorno);
        $entorno = str_replace("{ESTILO_COMP_ESPE_INT_AE}", "etiquetaPrograma-pendiente", $entorno);
        $entorno = str_replace("{ICONO_COMP_ESPE_INT_AE}", "circle-icon-sgd-3", $entorno);
        $entorno = str_replace("{CRITERIO_COMP_ESPE_INT_AE}", "Pendiente", $entorno);
    }
    return ($entorno);
}
function CalibraEval($html, $evaluado, $evaluador, $id_proceso, $id_empresa)
{
    $datos_proceso_evaluacion = TraeProcesosDeEvaluacionPorEmpresaYDiProceso($id_empresa, $id_proceso);
    $decimales_para_proceso   = $datos_proceso_evaluacion[0]->decimales_puntajes;
    $datos_evaluado           = UsuarioEnBasePersonas($evaluado);
    $datos_perfil_evaluacion  = UsuarioEnBasePersonas2PorProceso($evaluado, $id_proceso);
    //Bloque Resumen Superior
    $template_top             = file_get_contents("views/sgd/informe/tabla_superior_informe.html");
    //$total_evaluados.=ColocaDatosUsuario($template_top, $evaluado);
    $total_evaluados .= ColocaDatosUsuarioSGD($template_top, $evaluado, "", $evaluador, $id_proceso);
    $total_evaluados = str_replace("{TABLA_RESUMEN1}", file_get_contents("views/sgd/informe/tabla_superior_resumen/tabla_resumen1_sinareacorp_dinamico.html"), $total_evaluados);
    $total_evaluados = ArmaTemplareDeTablaResumen($total_evaluados, $_SESSION["ano_proceso_anual"], $id_empresa, $datos_perfil_evaluacion[0]->perfil_evaluacion, $evaluado, $evaluador, "no");
    $html            = str_replace("{BLOQUE_RESUMEN_EVALUADO}", $total_evaluados, $html);
    $html            = str_replace("{PASOS}", "", $html);
    //Bloque de detalle por competencias
    //$competencias=CompetenciasDadoPerfil($datos_perfil_evaluacion[0]->perfil_evaluacion, $evaluado, $evaluador);
    $competencias    = CompetenciasDadoPerfilPorProceso($datos_perfil_evaluacion[0]->perfil_evaluacion, $evaluado, $evaluador, $id_proceso);
    $html            = str_replace("{NOMBRE_INFORME_EVALUACION}", utf8_encode($datos_proceso_evaluacion[0]->titulo_informes_proceso), $html);
    //Aca pregunto si es que se muestra o no el promedio de las competencias.
    if ($datos_proceso_evaluacion[0]->muestra_promedio_competencias == 1) {
        $row                      = file_get_contents("views/sgd/informe/row_informe1_comp.html");
        $row                      = str_replace("{NOMBRE}", "Promedio por Competencias", $row);
        $nota_final_competencias  = ObtieneNotaFinalCompetencias($datos_perfil_evaluacion[0]->perfil_evaluacion, $evaluado, $evaluador, $id_proceso);
        $criterios_nota_final     = ObtenerCriterioPuntajeMatrizNotaFinal($nota_final_competencias[0], $evaluado, "", "comp", $evaluador, $id_proceso);
        $row                      = str_replace("{NOMBRE}", "Promedio por Competencias", $row);
        $row                      = str_replace("{ESTILO_ETIQUETA}", $criterios_nota_final[2], $row);
        $row                      = str_replace("{ICONO}", $criterios_nota_final[3], $row);
        $row                      = str_replace("{CRITERIO}", $criterios_nota_final[0], $row);
        $row                      = str_replace("{NOTA}", FormatearPorcentajesSinDecimal($nota_final_competencias[0]) . "", $row);
        $template_row_competencia = file_get_contents("views/sgd/informe/row_informe1_comp_v2.html");
    } else {
        //$template_row_competencia=file_get_contents("views/sgd/informe/row_informe1_comp_calibra.html");
        $template_row_competencia = file_get_contents("views/sgd/informe/row_informe1_comp_calibra.html");
    }
    $i = 0;
    foreach ($competencias as $com) {
        //$row.=file_get_contents("views/sgd/informe/row_informe1_comp.html");
        $row .= $template_row_competencia;
        $criterios                          = ObtenerCriterioPuntajeMatrizNotaFinal($com->nota_promedio, $evaluado, "", "comp", $evaluador, $id_proceso);
        $row                                = str_replace("{NOMBRE}", $com->nombre_componente, $row);
        $matriz_competencias[$i]["nombre"]  = $com->sigla;
        $row                                = str_replace("{ID_COMPETENCIA_NAME}", $com->id_componente, $row);
        $row                                = str_replace("{ID_COMPETENCIA_ENCODEADO}", Encodear3($com->id_componente), $row);
        $row                                = str_replace("{DESCRIPCION}", $com->descripcion_componente, $row);
        $row                                = str_replace("{RUT_EVALUADOR_ENCODEADO}", Encodear3($evaluador), $row);
        $row                                = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($evaluado), $row);
        $row                                = str_replace("{ID_PROCESO_ENCODEADO}", Encodear3($id_proceso), $row);
        $row                                = str_replace("{PONDERACION}", "", $row);
        $row                                = str_replace("{ESTILO_ETIQUETA}", $criterios[2], $row);
        $row                                = str_replace("{ICONO}", $criterios[3], $row);
        $row                                = str_replace("{CRITERIO}", $criterios[0], $row);
        //$row = str_replace("{NOTA}",FormatearPorcentajesSinDecimal($com->nota_promedio)."%",$row);
        $row                                = str_replace("{NOTA}", ColocaDecimalesNotasFinales($decimales_para_proceso, $com->nota_promedio, $tipo) . "", $row);
        $matriz_competencias[$i]["nota"]    = ($com->nota_promedio);
        $row                                = str_replace("{NOTA_CALIBRA}", ColocaDecimalesNotasFinales($decimales_para_proceso, $com->nota_promedio, $tipo) . "", $row);
        //AE
        //BLOQUE PARA MOSTRAR NOTAS AE
        $competencias_ae                    = CompetenciasDadoPerfilPorCompetencia($datos_perfil_evaluacion[0]->perfil_evaluacion, $evaluado, $evaluado, $com->id_competencia);
        $criterios_ae                       = ObtenerCriterioPuntajeMatrizNotaFinal($competencias_ae[0]->nota_promedio, $evaluado, "", "comp", $evaluador, $id_proceso);
        $row                                = str_replace("{ESTILO_ETIQUETA_AE}", $criterios_ae[2], $row);
        $row                                = str_replace("{ICONO_AE}", $criterios_ae[3], $row);
        $row                                = str_replace("{CRITERIO_AE}", $criterios_ae[0], $row);
        $row                                = str_replace("{NOTA_AE}", FormatearPorcentajesSinDecimal($competencias_ae[0]->nota_promedio) . "%", $row);
        $matriz_competencias[$i]["nota_ae"] = FormatearPorcentajesSinDecimal($competencias_ae[0]->nota_promedio);
        /*$row = str_replace("{ESTILO_ETIQUETA_AE}",$criterios_ae[2],$row);
        $row = str_replace("{ICONO_AE}",$criterios_ae[3],$row);
        $row = str_replace("{CRITERIO_AE}",$criterios_ae[0],$row);
        $row = str_replace("{NOTA_AE}",FormatearPorcentajesSinDecimal($competencias_ae[0]->nota_promedio)."",$row);
        $matriz_competencias[$i]["nota_ae"]=FormatearPorcentajesSinDecimal($competencias_ae[0]->nota_promedio);
        * */
        $i++;
        //Por cada competencia veo si tiene mas de una pregunta ,si es asi, las muestra, con la
        //Respuesta correspondiente
        if ($com->muestra_preguntas_informe == 1) {
            $preguntas_por_competencias = PreguntasPorCompetenciaConRespuesta($com->id_competencia, $evaluado, $evaluador, $id_proceso);
            $row_preg                   = "";
            //echo "$evaluado $evaluador <br>";
            foreach ($preguntas_por_competencias as $preg_uni) {
                //$row_preg.=file_get_contents("views/sgd/informe/row_informe1.1_comp.html");
                $row_preg .= file_get_contents("views/sgd/informe/row_informe1.1_comp_preg_calibra.html");
                $row_preg                      = str_replace("{NOMBRE_1}", $preg_uni->pregunta, $row_preg);
                $row_preg                      = str_replace("{NOMBRE_PREGUNTA}", $preg_uni->id, $row_preg);
                $row_preg                      = str_replace("{NOMBRE_PREGUNTA_COMPUESTO}", $evaluado . "-" . $preg_uni->id, $row_preg);
                $row_preg                      = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($evaluado), $row_preg);
                $row_preg                      = str_replace("{RUT_EVALUADOR_ENCODEADO}", Encodear3($evaluador), $row_preg);
                $row_preg                      = str_replace("{ID_PROCESO_ENCODEADO}", Encodear3($id_proceso), $row_preg);
                $row_preg                      = str_replace("{ID_PREGUNTA_ENCODEADO}", Encodear3($preg_uni->id), $row_preg);
                $row_preg                      = str_replace("{ID_COMPETENCIA_ENCODEADO}", Encodear3($com->id_competencia), $row_preg);
                $row_preg                      = str_replace("{DESCRIPCION_1}", "", $row_preg);
                $row_preg                      = str_replace("{PONDERACION_1}", "", $row_preg);
                $criterios_detalle_preg        = ObtenerCriterioPuntajeMatrizNotaFinal($preg_uni->puntaje, $evaluado, "", "comp", $evaluador, $id_proceso);
                $row_preg                      = str_replace("{ESTILO_ETIQUETA_1}", $criterios_detalle_preg[2], $row_preg);
                $row_preg                      = str_replace("{ICONO_1}", $criterios_detalle_preg[3], $row_preg);
                $row_preg                      = str_replace("{CRITERIO_1}", $criterios_detalle_preg[0], $row_preg);
                $row_preg                      = str_replace("{NOTA_1}", FormatearPorcentajesSinDecimal($preg_uni->puntaje) . "", $row_preg);
                //PARA AE
                $preguntas_por_competencias_ae = PreguntasPorCompetenciaConRespuestaPorPregunta($com->id_competencia, $evaluado, $evaluado, $id_proceso, $preg_uni->id);
                $criterios_detalle_preg_ae     = ObtenerCriterioPuntajeMatrizNotaFinal($preguntas_por_competencias_ae[0]->puntaje, $evaluado, "", "comp", $evaluador, $id_proceso);
                $row_preg                      = str_replace("{ESTILO_ETIQUETA_1_AE}", $criterios_detalle_preg_ae[2], $row_preg);
                $row_preg                      = str_replace("{ICONO_1_AE}", $criterios_detalle_preg_ae[3], $row_preg);
                $row_preg                      = str_replace("{CRITERIO_1_AE}", $criterios_detalle_preg_ae[0], $row_preg);
                $row_preg                      = str_replace("{NOTA_1_AE}", FormatearPorcentajesSinDecimal($preguntas_por_competencias_ae[0]->puntaje) . "", $row_preg);
            }
        }
        $row .= $row_preg;
        $row .= "</form>";
    }
    $html              = str_replace("{LISTADO_COMPETENCIAS}", utf8_encode($row), $html);
    $html              = str_replace("{BLOQUE_ESPECIFICOS}", "", $html);
    //Objetivos Empresa
    $objetivos_empresa = ObjetivosDeEmpresaConNota($datos_evaluado[0]->id_empresa, $id_proceso);
    if ($objetivos_empresa) {
        $html = str_replace("{BLOQUE_COORPORATIVOS}", file_get_contents("views/sgd/informe/entorno_informe_bloque_corporativo.html"), $html);
        foreach ($objetivos_empresa as $ob) {
            //$row3.=file_get_contents("views/sgd/informe/row_informe1_desactivado.html");
            $row3 .= file_get_contents("views/sgd/informe/row_informe1.html");
            $row3   = str_replace("{NOMBRE}", $ob->descripcion_objetivo, $row3);
            $row3   = str_replace("{PONDERACION}", "30%", $row3);
            $row3   = str_replace("{DESCRIPCION}", "", $row3);
            $datos3 = ObtenerCriterioPuntajeMatrizNotaFinal($ob->nota, $evaluado, "", "corp", $evaluador, $id_proceso);
            $row3   = str_replace("{NOTA}", FormatearPorcentajesSinDecimal($ob->nota) . "%", $row3);
            $row3   = str_replace("{ESTILO_ETIQUETA}", $datos3[2], $row3);
            $row3   = str_replace("{CRITERIO}", $datos3[0], $row3);
            $row3   = str_replace("{ICONO}", $datos3[3], $row3);
        }
        $html = str_replace("{LISTADO_OBJETIVOS_CORPORATIVOS}", utf8_encode($row3), $html);
    } else {
        $html = str_replace("{BLOQUE_COORPORATIVOS}", "", $html);
    }
    //OBJETIVOS AREA
    $datos_usuario               = UsuarioEnBasePersonasInnerArea($evaluado);
    //con el id del area, y el id de la empresa, traigo los datos de los objetivos de area
    $html                        = str_replace("{BLOQUE_AREA}", "", $html);
    $datos_evaluacion_resultados = ResultadosFinales($evaluado, $evaluador, $id_procesoo);
    $html                        = str_replace("{ESTILO_OBJIND}", $datos_evaluacion_resultados[0], $html);
    $html                        = str_replace("{ICONO_OBJIND}", $datos_evaluacion_resultados[4], $html);
    $html                        = str_replace("{CRITERIO_OBJETIVOS_IND}", $datos_evaluacion_resultados[1], $html);
    $html                        = str_replace("{ESTILO_COMP}", $datos_evaluacion_resultados[2], $html);
    $html                        = str_replace("{ICONO_COMP}", $datos_evaluacion_resultados[5], $html);
    $html                        = str_replace("{CRITERIO_COMPETENCIAS}", $datos_evaluacion_resultados[3], $html);
    //Graficos Individuales
    $html                        = str_replace("{GRAFICO_COMPETENCIAS}", GraficoPorCompetenciasPorEvaluadorCalibrador($evaluador, $id_proceso, "", $evaluado), $html);
    //Grafico de Ara?a
    $html                        = str_replace("{GRAFICO_ARANA}", GraficoArana($matriz_competencias), $html);
    return ($html);
}
function EstadoAvanceLiberacionCalibracion($rut_calibrador, $id_proceso, $evaluador)
{
    if ($evaluador) {
        //$cantidad_calibraciones=TraeCantidadDeCalibracionesPorEvaluador($rut_calibrador, $id_proceso, $evaluador);
        $cantidad_calibraciones = TraeCantidadDeCalibracionesPorEvaluadorSinAe($rut_calibrador, $id_proceso, $evaluador);
    } else {
        //$cantidad_calibraciones=TraeCantidadDeCalibraciones($rut_calibrador, $id_proceso);
        $cantidad_calibraciones = TraeCantidadDeCalibracionesSinAe($rut_calibrador, $id_proceso);
    }
    //Veo cuantos ya he liberado
    $cantidad_liberados = TraeCantidadLiberadosPorCalibrador($rut_calibrador, $id_proceso);
    //$arreglo[0]=count($cantidad_calibraciones)-count($cantidad_liberados);
    $arreglo[0]         = count($cantidad_calibraciones);
    //echo $arreglo[0]." aca";
    if ($arreglo[0] == "") {
    }
    $arreglo[1] = count($cantidad_liberados);
    return ($arreglo);
}
function ColocaGraficoAvanceLiberados($PRINCIPAL, $rut_calibrador, $id_proceso, $id_empresa)
{
    $grafico       = file_get_contents("views/sgd/graficos/graficoTorta.html");
    //Veo cuantos debe calibrar
    $datos         = EstadoAvanceLiberacionCalibracion($rut_calibrador, $id_proceso);
    $grafico       = str_replace("{DETIPO}", "evaluaciones liberadas", $grafico);
    $grafico       = str_replace("{PIECHART_SGD}", $rut_calibrador, $grafico);
    $grafico       = str_replace("{TOTAL_PENDIENTES}", $datos[0], $grafico);
    $grafico       = str_replace("{TOTAL_LIBERADOS}", $datos[1], $grafico);
    $grafico       = str_replace("{TOTAL_MENOS_LIBERADOS}", $datos[0] - $datos[1], $grafico);
    $grafico       = str_replace("{TOTAL_MENOS_LIBERADOS}", $datos[0] - $datos[1], $grafico);
    $datos_proceso = TraeProcesosDeEvaluacionPorEmpresaYDiProceso($id_empresa, $id_proceso);
    $grafico       = str_replace("{COLOR_GRAFICO_2}", $datos_proceso[0]->color_grafico_2, $grafico);
    $PRINCIPAL     = str_replace("{GRAFICO_TORTA}", $grafico, $PRINCIPAL);
    return ($PRINCIPAL);
}
function ListadoTotalColaboradoresPreviaCalibracion($html, $rut, $proceso_anual, $id_empresa, $id_proceso, $calibrador, $id_proceso_calibrar)
{
    $entorno              = file_get_contents("views/sgd/sgd2_entorno_equipo_chilquinta_calibracion.html");
    $entorno              = str_replace("{SECCION_GRAFICOS_CONSOLIDADOS}", file_get_contents("views/sgd/vista_consolidada_graficos.html"), $entorno);
    $entorno              = str_replace("{GRAFICO1.1}", ConsolidadoLineal($rut, "", $id_proceso_calibrar, $id_empresa), $entorno);
    $entorno              = str_replace("{GRAFICO1.2}", GraficoPorCompetenciasPorEvaluadorCalibrador($rut, $id_proceso_calibrar, ""), $entorno);
    $entorno              = ObtieneResumenesNotasFinalesPorEvaluador($entorno, $rut, $id_proceso_calibrar);
    //$entorno = str_replace("{TABLA_DATOS_USUARIO_SsUPERIOR}",file_get_contents("views/sgd/tabla_datos_superior_usuario.html"),$entorno);
    $entorno              = str_replace("{GRAFICO_TORTA}", "", $entorno);
    $entorno              = ColocaDatosUsuario($entorno, $rut, "graficoFrecuenciaCompetencia");
    //Aca valido si el evaluador termino sus evaluaciones, en tabla tbl_sgd_finalizados_evaluador.
    $finalizado_evaluador = FinalizadoEvaluador($rut);
    if ($finalizado_evaluador) {
        $entorno = str_replace("{LINK_EVALUACION_EQUIPO}", "sgd2", $entorno);
    } else {
        $entorno = str_replace("{LINK_EVALUACION_EQUIPO}", "ev#pag", $entorno);
    }
    //Aca traigo ellistado total de los colaboradores
    //$evaluados=TraeEvaluadosDadoEvaluador($rut);
    //$evaluados=TraeEvaluadosDadoEvaluadorSinMiPerfil($rut);
    //$evaluados=TraeEvaluadosDadoEvaluadorPorProceso($rut);
    //$evaluados=TraeEvaluadosDadoEvaluadorPorProcesoSinAe($rut, $id_proceso_calibrar);
    $evaluados = TraeEvaluadosDadoEvaluadorPorProcesoSinAePorProceso($rut, $id_proceso_calibrar);
    //$evaluados=TraeEvaluadosDadoEvaluadorPorProceso2($rut, $id_proceso_calibrar);
    if (!$evaluados) {
        $html = str_replace("{ENTORNO_LISTADO_COLABORADORES}", "
            <div class='row'>
</div>
            ", $html);
    } else {
        $total_evaluados = "";
        $obj_fin         = 0;
        foreach ($evaluados as $ev) {
            $row = file_get_contents("views/sgd/listado_colaboradores/row_colaboradores_previa_calibracion.html");
            $total_evaluados .= ColocaDatosUsuario($row, $ev->rut);
            //COMENTADO PARA OPTIMIZAR 22-11-2015
            if ($id_empresa == 28) {
                $total_evaluados     = str_replace("{TABLA_RESUMEN1}", file_get_contents("views/sgd/informe/tabla_superior_resumen/tabla_resumen1_sinareacorp_dinamico_chilquinta.html"), $total_evaluados);
                $total_evaluados     = str_replace("{BOTON_EVALUACION_INDIVIDUAL}", file_get_contents("views/sgd/informe/tabla_superior_resumen/boton_eval_individual.html"), $total_evaluados);
                //Verifico si est? finalizada la evaluacion de este proceso
                $verifica_finalizado = FinalizadoEvaluadoEvaluador($ev->rut, $ev->evaluador, $ev->id_proceso);
                if ($verifica_finalizado) {
                    //Verifico tambien si est? liberado o no por el calibrador
                    $verifica_liberado = TraeLiberadoEvaluadoEvaluadorCalibrador($ev->rut, $ev->evaluador, $calibrador, $ev->id_proceso);
                    if ($verifica_liberado) {
                        $total_evaluados = str_replace("{BOTON}", file_get_contents("views/sgd/evaluacion/boton_ver_informe.html"), $total_evaluados);
                    } else {
                        $total_evaluados = str_replace("{BOTON}", file_get_contents("views/sgd/listado_colaboradores/boton_calibra_individual.html"), $total_evaluados);
                    }
                } else {
                    $total_evaluados = str_replace("{BOTON}", "", $total_evaluados);
                }
                $estado_liberado_feedback = LiberadoFeedbackLiberado($ev->rut, $ev->evaluador, $ev->calibrador, $ev->id_proceso, $id_empresa);
                $total_evaluados          = str_replace("{ETIQUETA_ESTADO}", $estado_liberado_feedback[0], $total_evaluados);
                $total_evaluados          = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($ev->rut), $total_evaluados);
                $total_evaluados          = str_replace("{RUT_EVALUADOR_ENCODEADO}", Encodear3($ev->evaluador), $total_evaluados);
                $total_evaluados          = str_replace("{ID_PROCESO_ENCODEADO}", Encodear3($ev->id_proceso), $total_evaluados);
                //Aca traigo la nota final de cadaevaluadopara acumular y mostrar en el resumen superior
                $datos_resumen            = ResultadosFinales($ev->rut, $rut, $id_proceso, "");
                if ($datos_resumen[27] > 0) {
                    $acummulador_notas = $acummulador_notas + $datos_resumen[27];
                    $contador++;
                }
            } else {
                $total_evaluados = str_replace("{TABLA_RESUMEN1}", file_get_contents("views/sgd/informe/tabla_superior_resumen/tabla_resumen1_sinareacorp_dinamico.html"), $total_evaluados);
            }
            $total_evaluados    = ArmaTemplareDeTablaResumen($total_evaluados, $proceso_anual, $id_empresa, $ev->perfil_evaluacion, $ev->rut, $rut);
            //Verifico si est? finalizado este evaluado en el proceso de objetivos
            $feedback_objetivos = TomoConocimientoEvaluado($ev->rut);
            if ($feedback_objetivos) {
                $obj_fin++;
            }
            //$total_evaluados = ColocaPonderaciones($total_evaluados, $ev->rut);
            $total_evaluados = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($ev->rut), $total_evaluados);
            //$total_evaluados=ColocaResultadosTablaReumen($total_evaluados, $ev->rut, $rut);
            $total_evaluados = SemaforosEstadosObjetivos($total_evaluados, $ev->rut, $_SESSION["ano_proceso_anual"]);
            //COMENTADO PARA OPTIMIZAR 22-11-2015
            //$total_evaluados = str_replace("{PARAMETROS_EVAL}",Encodear3($ev->rut.";".$rut),$total_evaluados);
        }
        $nota_final_evaluados = $acummulador_notas / $contador;
        if ($nota_final_evaluados) {
            $datos_nota_final_evaluados = ObtenerCriterioPuntajeMatrizNotaFinal($nota_final_evaluados, $rut, 0, "nota_final");
            $entorno                    = str_replace("{NOTA_FINAL}", ColocaDecimalesNotasFinales(2, $nota_final_evaluados), $entorno);
            $entorno                    = str_replace("{ESTILO_NOTA_FINAL}", $datos_nota_final_evaluados[2], $entorno);
            $entorno                    = str_replace("{ICONO_NOTA_FINAL}", $datos_nota_final_evaluados[3], $entorno);
            $entorno                    = str_replace("{CRITERIO_NOTA_FINAL}", $datos_nota_final_evaluados[0], $entorno);
        } else {
            $entorno = str_replace("{NOTA_FINAL}", "", $entorno);
            $entorno = str_replace("{ESTILO_NOTA_FINAL}", "etiquetaPrograma-pendiente", $entorno);
            $entorno = str_replace("{ICONO_NOTA_FINAL}", "circle-icon-sgd-3", $entorno);
            $entorno = str_replace("{CRITERIO_NOTA_FINAL}", "Pendiente", $entorno);
        }
        //aca calculo el porcentaje de avance de objetivos de todos los colaboradores.
        $entorno = str_replace("{POR_AVANCE_OBJ}", ($obj_fin * 100) / count($evaluados), $entorno);
        $entorno = str_replace("{POR_AVANCE_EV_EQUIPO}", 0, $entorno);
        $entorno = str_replace("{LISTADO_COLABORADORES}", ($total_evaluados), $entorno);
        $html    = str_replace("{ENTORNO_LISTADO_COLABORADORES}", ($entorno), $html);
    }
    return ($html);
}
function ColocaTitulosDinamicosPorEmpresa($PRINCIPAL, $id_empresa, $seccion)
{
    $titulos = TitulosDinamicosPorEmpresaEnv($id_empresa, $seccion);
    foreach ($titulos as $tit) {
        $PRINCIPAL = str_replace($tit->etiqueta, utf8_encode($tit->titulo), $PRINCIPAL);
    }
    return ($PRINCIPAL);
}
function ListadoTotalCalibrador($html, $rut, $proceso_anual, $id_empresa, $id_proceso, $id_proceso_a_calibrar)
{
    $html                = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($rut), $html);
    $datos_evaluado_jefe = UsuarioEnBasePersonas($rut);
    $datos_usuario       = UsuarioEnBasePersonas($rut);
    $html                = str_replace("{NOMBRE_DEPENDIENTE}", utf8_encode($datos_usuario[0]->nombre), $html);
    $html                = str_replace("{PARAMETROS_EVAL}", Encodear3($ev->rut . ";" . $rut), $html);
    $entorno             = file_get_contents("views/sgd/sgd2_entorno_equipo_chilquinta_calibracion.html");
    $entorno             = str_replace("{TABLA_DATOS_USUARIO_SUPERIOR}", file_get_contents("views/sgd/tabla_datos_superior_usuario.html"), $entorno);
    $entorno             = ColocaDatosUsuario($entorno, $rut, "graficoFrecuenciaCompetencia");
    $entorno             = str_replace("{SECCION_GRAFICOS_CONSOLIDADOS}", file_get_contents("views/sgd/vista_consolidada_graficos.html"), $entorno);
    $entorno             = str_replace("{GRAFICO1.1}", ConsolidadoLineal("", $rut, $id_proceso_a_calibrar, $id_empresa), $entorno);
    $entorno             = str_replace("{GRAFICO1.2}", GraficoPorCompetenciasPorEvaluadorCalibrador("", $id_proceso_a_calibrar, $rut), $entorno);
    $evaluadores         = TraeEvaluadoresPorProcesoDadoCalibrador($rut, $id_proceso_a_calibrar);
    if (!$evaluadores) {
        $html = str_replace("{ENTORNO_LISTADO_COLABORADORES}", "
            <div class='row'>
            </div>
            ", $html);
    } else {
        $total_evaluados = "";
        $obj_fin         = 0;
        foreach ($evaluadores as $ev) {
            $row = file_get_contents("views/sgd/listado_colaboradores/row_colaboradores_calibracion.html");
            $total_evaluados .= ColocaDatosUsuario($row, $ev->rut);
            //COMENTADO PARA OPTIMIZAR 22-11-2015
            $total_evaluados = ColocaAvanceEvaluadorDadoLosFinalizados($total_evaluados, $ev->rut, $id_proceso_a_calibrar, $id_empresa);
            if ($id_empresa == 28) {
                $total_evaluados          = str_replace("{TABLA_RESUMEN1}", file_get_contents("views/sgd/informe/tabla_superior_resumen/tabla_resumen1_sinareacorp_dinamico_chilquinta.html"), $total_evaluados);
                $total_evaluados          = str_replace("{BOTON_EVALUACION_INDIVIDUAL}", file_get_contents("views/sgd/informe/tabla_superior_resumen/boton_eval_individual.html"), $total_evaluados);
                //Verifico si est? finalizada la evaluacion de este proceso
                $verifica_eval_finalizada = FinalizadoEvaluadoEvaluador($ev->rut, $rut, $id_proceso);
                if ($verifica_eval_finalizada) {
                    $total_evaluados = str_replace("{BOTON_VE_INFORME_POR_PROCESO}", file_get_contents("views/sgd/informe/tabla_superior_resumen/boton_ve_informe.html"), $total_evaluados);
                } else {
                    $total_evaluados = str_replace("{BOTON_VE_INFORME_POR_PROCESO}", "", $total_evaluados);
                }
                $total_evaluados = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($ev->rut), $total_evaluados);
                $total_evaluados = str_replace("{ID_PROCESO_ENCODEADO}", Encodear3($id_proceso), $total_evaluados);
            } else {
                $total_evaluados = str_replace("{TABLA_RESUMEN1}", file_get_contents("views/sgd/informe/tabla_superior_resumen/tabla_resumen1_sinareacorp_dinamico.html"), $total_evaluados);
            }
            //$total_evaluados=ArmaTemplareDeTablaResumen($total_evaluados, $proceso_anual, $id_empresa, $ev->perfil_evaluacion, $ev->rut, $rut);
            //Verifico si est? finalizado este evaluado en el proceso de objetivos
            $feedback_objetivos = TomoConocimientoEvaluado($ev->rut);
            if ($feedback_objetivos) {
                $obj_fin++;
            }
            //$total_evaluados = ColocaPonderaciones($total_evaluados, $ev->rut);
            $verifico_si_libero = EstadoAvanceLiberacionCalibracion($rut, $id_proceso_a_calibrar, $ev->rut);
            //if($verifico_si_libero[0]==0){
            if ($verifico_si_libero[0] == $verifico_si_libero[1]) {
                //$total_evaluados = str_replace("{BOTON_LIBERAR}","",$total_evaluados);
                $total_evaluados = str_replace("{BOTON_LIBERAR}", file_get_contents("views/sgd/listado_colaboradores/boton_liberar.html"), $total_evaluados);
                $total_evaluados = str_replace("{BOTON_VER_EVALUADOS_PARA_CALIBRAR}", file_get_contents("views/sgd/listado_colaboradores/boton_ve_colaboradores.html"), $total_evaluados);
            } else {
                $total_evaluados = str_replace("{BOTON_LIBERAR}", file_get_contents("views/sgd/listado_colaboradores/boton_liberar.html"), $total_evaluados);
                //aca debo verificar si la evaluacion de este evaluado est? finalizada o no.
                $total_evaluados = str_replace("{BOTON_VER_EVALUADOS_PARA_CALIBRAR}", file_get_contents("views/sgd/listado_colaboradores/boton_ve_colaboradores_para_calibrar.html"), $total_evaluados);
            }
            $total_evaluados = str_replace("{ID_PROCESO_CALIBRAR_ENCODEADO}", Encodear3($id_proceso_a_calibrar), $total_evaluados);
            $total_evaluados = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($ev->rut), $total_evaluados);
            $total_evaluados = str_replace("{RUT_EVALUADOR_ENCODEADO}", Encodear3($ev->rut), $total_evaluados);
            $total_evaluados = str_replace("{RUT_CALIBRADOR_ENCODEADO}", Encodear3($rut), $total_evaluados);
            $total_evaluados = str_replace("{ID_PROCESO_CALIBRAR}", Encodear3($id_proceso_a_calibrar), $total_evaluados);
            $total_evaluados = str_replace("{ID_PROCESO}", Encodear3($id_proceso), $total_evaluados);
            $total_evaluados = ObtieneResumenesNotasFinalesPorEvaluador($total_evaluados, $ev->rut, $id_proceso_a_calibrar);
        }
        $entorno = ObtieneResumenesNotasFinalesPorEvaluador($entorno, "", $id_proceso_a_calibrar, $rut);
        //aca calculo el porcentaje de avance de objetivos de todos los colaboradores.
        $entorno = str_replace("{POR_AVANCE_OBJ}", ($obj_fin * 100) / count($evaluados), $entorno);
        $entorno = str_replace("{POR_AVANCE_EV_EQUIPO}", 0, $entorno);
        $entorno = str_replace("{LISTADO_COLABORADORES}", ($total_evaluados), $entorno);
        $html    = str_replace("{ENTORNO_LISTADO_COLABORADORES}", ($entorno), $html);
    }
    return ($html);
}
function ColocaDecimalesNotasFinales($numero_decimales, $valor, $tipo)
{
    if ($numero_decimales > 0) {
        return (number_format($valor, $numero_decimales, ".", "."));
    } else {
        return (round($valor));
    }
}
function colocarArchivosDirectores($rut, $id_empresa)
{
    $verifica = VerificoEnTablaDeDirectores($rut, $id_empresa);
    if ($verifica) {
        $template = file_get_contents("views/pagina/descarga_documentos.html");
    } else {
        $template = "";
    }
    return ($template);
}
Function PorcentajeAvanceEvaluador($evaluador, $id_proceso)
{
    //$perfiles=TotalPerfilesDadoEvaluador1PorProceso($evaluador, $id_proceso);
    //for($i=0;$i<count($perfiles);$i++){
    //        $sql.=" perfil_evaluacion='".$perfiles[$i]->id_perfil_ev."'";
    //        if($perfiles[$i+1]->id_perfil_ev) $sql.=" or";
    //    }
    //    $total_paginas=count(TotalIdCompetencias($sql));
    //Obtengo la pagina que esta el evaluador
    //    $pagina_actual=SesionSGDSoloEvaluador($evaluador, $id_proceso);
    //    $porcentaje_avance[0]=FormatearPorcentajesSinDecimal(($pagina_actual[0]->pagina*100)/$total_paginas);
    //    return($porcentaje_avance);
}
function ColocaAvanceEvaluadorDadoLosFinalizados($PRINCIPAL, $evaluador, $id_proceso, $id_empresa, $origen, $arreglo_post)
{
    if ($arreglo_post["rutevaluador"])
        $evaluador = $arreglo_post["rutevaluador"];
    if ($arreglo_post["rutcalibrador"])
        $calibrador = $arreglo_post["rutcalibrador"];
    //traigo total de evaluadores
    if ($evaluador) {
        $evaluados = TraeEvaluadosDadoEvaluadorPorProceso2SinAe($evaluador, $id_proceso);
    } else if ($id_proceso) {
        $evaluados = TraeEvaluadosDadoEvaluadorPorProceso2SinAeSoloProceso($id_proceso, $arreglo_post);
    }
    $finaliza = 0;
    foreach ($evaluados as $eva) {
        $esta_finalizado = FinalizadoEvaluadoEvaluadorProProceso($eva->rut, $eva->evaluador, $eva->id_proceso);
        if ($esta_finalizado) {
            $finaliza++;
        }
    }
    //total evaluaciones
    $arreglo[0] = count($evaluados);
    $arreglo[1] = $finaliza;
    if ($origen == "admin") {
        $grafico = file_get_contents("../front/views/sgd/graficos/graficoTorta.html");
    } else {
        $grafico = file_get_contents("views/sgd/graficos/" . $id_empresa . "_graficoTorta.html");
    }
    if ($origen == "admin") {
        $grafico = str_replace("{PIECHART_SGD}", "graficoAdminAvance", $grafico);
    } else {
        $grafico = str_replace("{PIECHART_SGD}", $evaluador, $grafico);
    }
    $grafico       = str_replace("{DETIPO}", "evaluaciones realizadas", $grafico);
    $grafico       = str_replace("{TOTAL_LIBERADOS}", $finaliza, $grafico);
    $grafico       = str_replace("{TOTAL_PENDIENTES}", count($evaluados), $grafico);
    $grafico       = str_replace("{TOTAL_MENOS_LIBERADOS}", (count($evaluados) - $finaliza), $grafico);
    $datos_proceso = TraeProcesosDeEvaluacionPorEmpresaYDiProceso($id_empresa, $id_proceso);
    $grafico       = str_replace("{COLOR_GRAFICO_2}", $datos_proceso[0]->color_grafico_2, $grafico);
    $grafico       = str_replace("{TITULO_GRAFICO_2}", $datos_proceso[0]->titulo_grafico_2, $grafico);
    $PRINCIPAL     = str_replace("{GRAFICO_AVANCE_EVALUADOR}", $grafico, $PRINCIPAL);
    return ($PRINCIPAL);
}
function OptionDestinatariosPorUsuario($seleccionado, $rut, $id_empresa)
{
    if ($rut) {
        $destinatarios = DAtosDestinatariosPorUsuario($rut);
    } else {
        $destinatarios = TiposDestinatariosPorEmpresa($id_empresa);
    }
    foreach ($destinatarios as $unico) {
        if ($unico->tipo_destinatario == $seleccionado) {
            $options .= "<option selected value='" . $unico->tipo_destinatario . "'>" . $unico->nombre . "</option>";
        } else {
            $options .= "<option value='" . $unico->tipo_destinatario . "'>" . $unico->nombre . "</option>";
        }
    }
    return ($options);
}
function ListadoIngresoPlanesParaSeguimiento($evaluado, $evaluador, $id_plan)
{
    //$tiene_bitacora=TraeDatosPorBitacora($evaluado);
    $tiene_planes       = TraeDatosPorPlanes($evaluado);
    //VErifico si los planes estan finalizados
    $planes_finalizados = VerificaEstadoPlanes($evaluado);
    if ($tiene_planes) {
        foreach ($tiene_planes as $dato) {
            if ($dato->id == $id_plan) {
                $template .= file_get_contents("views/sgd/planes/row_plan_edicion.html");
                $template = str_replace("{OPTIONS_VALORES}", OptionsCompetenciasPorPerfil($evaluado->perfil_evaluacion, ""), $template);
                $template = str_replace("{OPTIONS_PLAZOS_POR_EMPRESA}", OptionsGenericoNombreDadoValoresPorEmpresa("tbl_planes_plazos", $dato->plazo, "nombre", "id", "order by orden asc", $_SESSION["id_empresa"]), $template);
            } else {
                if ($planes_finalizados) {
                    if ($evaluado <> $evaluador) {
                        $template .= file_get_contents("views/sgd/planes/row_plan_lectura_sin_editar.html");
                        if ($dato->jefe_sugiere) {
                            if ($dato->seguimiento_grado_cumplimiento) {
                                $template = str_replace("{BLOQUE_COMENTARIOS_JEFE}", file_get_contents("views/sgd/planes/bloque_comentarios_jefe_lectura.html") . file_get_contents("views/sgd/planes/bloque_seguimiento_por_plan_lectura.html"), $template);
                                $template = str_replace("{GRADO_CUMPLIMIENTO}", $dato->seguimiento_grado_cumplimiento, $template);
                                $template = str_replace("{COMENTARIO_CUMPLIMIENTO}", $dato->seguimiento_comentario, $template);
                            } else {
                                $template = str_replace("{BLOQUE_COMENTARIOS_JEFE}", file_get_contents("views/sgd/planes/bloque_comentarios_jefe_lectura.html") . file_get_contents("views/sgd/planes/bloque_seguimiento_por_plan.html"), $template);
                            }
                            if ($dato->jefe_sugiere == "si") {
                                $template = str_replace("{SUGIERE}", "La Jefatura acepta los planes", $template);
                            } else {
                                $template = str_replace("{SUGIERE}", "La Jefatura acepta con observaciones", $template);
                            }
                            $template = str_replace("{COMENTARIO}", $dato->jefe_comentario, $template);
                        } else {
                            $template = str_replace("{BLOQUE_COMENTARIOS_JEFE}", file_get_contents("views/sgd/planes/bloque_comentarios_jefe.html"), $template);
                        }
                        $template = str_replace("{ID_PLAN}", $dato->id, $template);
                        $template = str_replace("{RUT_EVALUADO}", $evaluado, $template);
                    } else {
                        $template .= file_get_contents("views/sgd/planes/row_plan_lectura_sin_editar.html");
                        if ($dato->jefe_sugiere) {
                            if ($dato->seguimiento_grado_cumplimiento) {
                                $template = str_replace("{BLOQUE_COMENTARIOS_JEFE}", file_get_contents("views/sgd/planes/bloque_comentarios_jefe_lectura.html") . file_get_contents("views/sgd/planes/bloque_seguimiento_por_plan_lectura.html"), $template);
                                $template = str_replace("{GRADO_CUMPLIMIENTO}", $dato->seguimiento_grado_cumplimiento, $template);
                                $template = str_replace("{COMENTARIO_CUMPLIMIENTO}", $dato->seguimiento_comentario, $template);
                            } else {
                                $template = str_replace("{BLOQUE_COMENTARIOS_JEFE}", file_get_contents("views/sgd/planes/bloque_comentarios_jefe_lectura.html"), $template);
                            }
                            if ($dato->jefe_sugiere == "si") {
                                $template = str_replace("{SUGIERE}", "La Jefatura acepta los planes", $template);
                            } else {
                                $template = str_replace("{SUGIERE}", "La Jefatura acepta con observaciones", $template);
                            }
                            $template = str_replace("{COMENTARIO}", $dato->jefe_comentario, $template);
                        } else {
                            $template = str_replace("{BLOQUE_COMENTARIOS_JEFE}", "", $template);
                        }
                    }
                } else {
                    if ($evaluado <> $evaluador) {
                        $template = file_get_contents("views/sgd/planes/row_plan_no_finalizado_por_evaluado.html");
                    } else {
                        $template .= file_get_contents("views/sgd/planes/row_plan_lectura.html");
                    }
                }
            }
            $template = str_replace("{COMPETENCIA}", utf8_encode($dato->nombre_competencia), $template);
            $template = str_replace("{ACTIVIDAD_A_DESARROLLAR}", $dato->actividad_desarrollar, $template);
            $template = str_replace("{RESULTADO_ESPERADO}", $dato->resultado_esperado, $template);
            $template = str_replace("{FECHA_INICIO}", formatearFechaCompleta($dato->fecha_inicio), $template);
            $template = str_replace("{FECHA_TERMINO}", formatearFechaCompleta($dato->fecha_termino), $template);
            $template = str_replace("{PLAZOS}", $dato->plazo_nombre, $template);
            $template = str_replace("{ID_PLANES_ENCODEADO}", Encodear3($dato->id), $template);
        }
        $arreglo[0] = "si";
        $arreglo[1] = $template;
    } else {
        if ($evaluado <> evaluador) {
            $template = file_get_contents("views/sgd/planes/row_plan_no_finalizado_por_evaluado.html");
        } else {
            $template = file_get_contents("views/sgd/planes/sin_planes.html");
        }
        $arreglo[0] = "no";
        $arreglo[1] = $template;
    }
    return ($arreglo);
}
function ListadoColaboradoresPlanesSeguimiento($html, $evaluador, $rut_evaluado, $id_plan)
{
    $evaluados = EvaluadosDadoEvaluador($evaluador);
    //Se muestran los objetivos individuales.
    if ($_SESSION["id_empresa"] == 28) {
        $total_html   = file_get_contents("views/sgd/planes/entorno_bloque_principal_chilquinta.html");
        $template_row = file_get_contents("views/sgd/planes/row_colaboradores_chilquinta.html");
    } else {
        $total_html   = file_get_contents("views/sgd/planes/entorno_bloque_principal.html");
        $template_row = file_get_contents("views/sgd/planes/row_colaboradores.html");
    }
    //Primero veo si es que hay registro en la tabla de sesion
    $row           = "";
    $ok_finalizado = 0;
    foreach ($evaluados as $evaluado) {
        $row .= $template_row;
        $objetivos_validados_por_validador = VerificaSiObjetivosEstanValidados($evaluado->evaluado);
        if ($evaluado->evaluado == $evaluador) {
            $row = ColocaDatosUsuario($row, $evaluado->evaluado, "sinmensaje");
        } else {
            $row = ColocaDatosUsuario($row, $evaluado->evaluado, "sinmensaje");
        }
        //$listado=ListadoIngresoPlanes($evaluado->evaluado, $evaluador, $id_plan, "jefe");
        $listado                    = ListadoIngresoPlanesParaSeguimiento($evaluado->evaluado, $evaluador, $id_plan, "jefe");
        $row                        = str_replace("{LISTADO_OBJETIVOS_A_EVALUAR}", $listado[1], $row);
        $row                        = str_replace("{BOTON_PLANES_INGRESA}", "", $row);
        $ponderaciones_bases        = DevuelvePonderacionesPorEvaluado($evaluado->evaluado);
        $verifica_evaluado_validado = VerificaSiObjetivosEstanAjustados($evaluado->evaluado);
        if ($rut_evaluado == $evaluado->evaluado && !$id_plan) {
            $row = str_replace("{FORMUARIO_BITACORA}", file_get_contents("views/sgd/planes/formulario.html"), $row);
            $row = str_replace("{OPTIONS_VALORES}", OptionsCompetenciasPorPerfil($evaluado->perfil_evaluacion, ""), $row);
            $row = str_replace("{OPTIONS_PLAZOS_POR_EMPRESA}", OptionsGenericoNombreDadoValoresPorEmpresa("tbl_planes_plazos", "", "nombre", "id", "order by orden asc", $_SESSION["id_empresa"]), $row);
        } else {
            $row = str_replace("{FORMUARIO_BITACORA}", "", $row);
        }
        $row          = str_replace("{RUT_ENCODEADO}", Encodear3($evaluado->evaluado), $row);
        $row          = str_replace("{RUT_EVALUADO}", ($evaluado->evaluado), $row);
        $total_planes = TraeDatosPorPlanes($evaluado->evaluado);
        $row          = str_replace("{X_PLANES}", count($total_planes), $row);
        $row          = str_replace("{BOTON_JEFE_VALIDA_OBJETIVOS}", "", $row);
        $row          = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($evaluado->evaluado), $row);
        //ACA veo si es que tiene comentarios de rechazo
        //ACA VEO PARA COLOCAR EL BOTON ENVIAR A VALIDACION
        if ($evaluado->evaluado == $evaluador) {
            if ($listado[0] == "si") {
                $plan_finalizado = VerificaEstadoPlanes($evaluado->evaluado);
                if ($plan_finalizado) {
                    $row = str_replace("{BOTON_VALIDACIONES_PLANES}", "", $row);
                } else {
                    $row = str_replace("{BOTON_VALIDACIONES_PLANES}", file_get_contents("views/sgd/planes/boton_envia_a_validar.html"), $row);
                    $row = str_replace("{RUT_USUARIO_ENCODEADO}", Encodear3($evaluado->evaluado), $row);
                }
            } else {
                $row = str_replace("{BOTON_VALIDACIONES_PLANES}", "", $row);
            }
        } else {
            $row = str_replace("{BOTON_VALIDACIONES_PLANES}", "", $row);
        }
    }
    $total_html = str_replace("{LISTADO_COLABORADORES}", ($row), $total_html);
    $html       = str_replace("{ENTORNO_LISTADO_EVALUACION}", ($total_html), $html);
    return ($html);
}
function ListadoIngresoPlanes($evaluado, $evaluador, $id_plan, $tipo, $id_proceso, $id_proceso_plan, $perfil_evaluacion)
{
    //print_R($_SESSION);
    $id_empresa         = $_SESSION["id_empresa"];
    $datos_proceso      = TraeProcesosDeEvaluacionDadoId($_SESSION["id_proceso"]);
    //$tiene_bitacora=TraeDatosPorBitacora($evaluado);
    //$tiene_planes=TraeDatosPorPlanes($evaluado);
    //$tiene_planes=TraeDatosPorPlanesPorProceso($evaluado, $datos_proceso[0]->id_proceso_a_evaluar);
    $tiene_planes       = TraeDatosPorPlanesPorProcesoPlan($evaluado, $id_proceso_plan);
    //VErifico si los planes estan finalizados
    //$planes_finalizados=VerificaEstadoPlanes($evaluado);
    $planes_finalizados = VerificaEstadoPlanesPorProcesoEmpresa($evaluado, $id_proceso_plan, $id_empresa);
    if ($tiene_planes) {
        foreach ($tiene_planes as $dato) {
            if ($dato->id == $id_plan) {
                $template .= file_get_contents("views/sgd/planes/row_plan_edicion.html");
                //$template = str_replace("{OPTIONS_VALORES}",OptionsCompetenciasPorPerfil($evaluado->perfil_evaluacion, ""),$template);
                $template = str_replace("{OPTIONS_VALORES}", OptionsCompetenciasDadoPerfil($perfil_evaluacion, $dato->id_competencia), $template);
                $template = str_replace("{OPTIONS_PLAZOS_POR_EMPRESA}", OptionsGenericoNombreDadoValoresPorEmpresa("tbl_planes_plazos", $dato->plazo, "nombre", "id", "order by orden asc", $_SESSION["id_empresa"]), $template);
            } else {
                if ($planes_finalizados) {
                    if ($evaluado <> $evaluador) {
                        $template .= file_get_contents("views/sgd/planes/row_plan_lectura_sin_editar.html");
                        if ($dato->jefe_sugiere) {
                            $template = str_replace("{BLOQUE_COMENTARIOS_JEFE}", file_get_contents("views/sgd/planes/bloque_comentarios_jefe_lectura.html"), $template);
                            if ($dato->jefe_sugiere == "si") {
                                $template = str_replace("{SUGIERE}", "La Jefatura acepta los planes", $template);
                            } else {
                                $template = str_replace("{SUGIERE}", "La Jefatura acepta con observaciones", $template);
                            }
                            $template = str_replace("{COMENTARIO}", $dato->jefe_comentario, $template);
                        } else {
                            $template = str_replace("{BLOQUE_COMENTARIOS_JEFE}", file_get_contents("views/sgd/planes/bloque_comentarios_jefe.html"), $template);
                            $template = str_replace("{ID_PLAN}", $dato->id, $template);
                            $template = str_replace("{RUT_EVALUADO}", $evaluado, $template);
                        }
                    } else {
                        //$template.=file_get_contents("views/sgd/planes/row_plan_lectura_sin_editar.html");
                        $template .= file_get_contents("views/sgd/planes/row_plan_lectura_con_grado_avance.html");
                        //$template = str_replace("{BLOQUE_COMENTARIOS_JEFE}","ddfdf",$template);
                        if ($dato->jefe_sugiere) {
                            $template = str_replace("{BLOQUE_COMENTARIOS_JEFE}", file_get_contents("views/sgd/planes/bloque_comentarios_jefe_lectura.html"), $template);
                            if ($dato->jefe_sugiere == "si") {
                                $template = str_replace("{SUGIERE}", "La Jefatura acepta los planes", $template);
                            } else {
                                $template = str_replace("{SUGIERE}", "La Jefatura acepta con observaciones", $template);
                            }
                            $template = str_replace("{COMENTARIO}", $dato->jefe_comentario, $template);
                        } else {
                            $template = str_replace("{BLOQUE_COMENTARIOS_JEFE}", "", $template);
                        }
                    }
                } else {
                    if ($evaluado <> $evaluador) {
                        $template = file_get_contents("views/sgd/planes/row_plan_no_finalizado_por_evaluado.html");
                    } else {
                        $template .= file_get_contents("views/sgd/planes/row_plan_lectura.html");
                    }
                }
            }
            //SEGUIMIENTO
            if ($dato->seguimiento_grado_cumplimiento && $dato->seguimiento_comentario) {
                $template = str_replace("{BLOQUE_SEGUIMIENTO}", file_get_contents("views/sgd/planes/28_bloque_seguimiento_lectura.html"), $template);
                $template = str_replace("{GRADO}", $dato->seguimiento_grado_cumplimiento, $template);
                $template = str_replace("{COMENTARIO_SEGUIMIENTO}", utf8_encode($dato->seguimiento_comentario), $template);
            } else {
                if ($evaluado == $evaluador) {
                    $template = str_replace("{BLOQUE_SEGUIMIENTO}", file_get_contents("views/sgd/planes/28_bloque_seguimiento.html"), $template);
                } else {
                    $template = str_replace("{BLOQUE_SEGUIMIENTO}", "", $template);
                }
            }
            $template = str_replace("{COMPETENCIA}", utf8_encode($dato->nombre_competencia), $template);
            $template = str_replace("{ACTIVIDAD_A_DESARROLLAR}", $dato->actividad_desarrollar, $template);
            $template = str_replace("{RESULTADO_ESPERADO}", $dato->resultado_esperado, $template);
            //$template = str_replace("{FECHA_INICIO}",formatearFechaCompleta($dato->fecha_inicio),$template);
            $template = str_replace("{FECHA_INICIO}", ($dato->fecha_inicio), $template);
            //$template = str_replace("{FECHA_TERMINO}",formatearFechaCompleta($dato->fecha_termino),$template);
            $template = str_replace("{FECHA_TERMINO}", ($dato->fecha_termino), $template);
            $template = str_replace("{PLAZOS}", $dato->plazo_nombre, $template);
            $template = str_replace("{ID_PLANES_ENCODEADO}", ($dato->id), $template);
            $template = str_replace("{ID_PROCESO_ENCODEADO}", Encodear3($id_proceso), $template);
            $template = str_replace("{ID_PROCESO_PLAN_ENCODEADO}", Encodear3($id_proceso_plan), $template);
        }
        $arreglo[0] = "si";
        $arreglo[1] = $template;
    } else {
        if ($evaluado <> evaluador) {
            $template = file_get_contents("views/sgd/planes/row_plan_no_finalizado_por_evaluado.html");
        } else {
            $template = file_get_contents("views/sgd/planes/sin_planes.html");
        }
        $arreglo[0] = "no";
        $arreglo[1] = $template;
    }
    return ($arreglo);
}
function OptionsCompetenciasPorPerfil($perfil, $seleccionado)
{
    $competencias = CompetenciasPorPerfilConNombre($perfil);
    foreach ($competencias as $unico) {
        $options .= "<option value='" . $unico->id_componente . "'>" . $unico->nombre_competencia . "</option>";
    }
    return (utf8_encode($options));
}
function ListadoColaboradoresPlanes($html, $evaluador, $rut_evaluado, $id_plan, $id_proceso, $id_proceso_plan)
{
    $id_empresa = $_SESSION["id_empresa"];
    //$evaluados=EvaluadosDadoEvaluador($evaluador);
    $evaluados  = EvaluadosDadoEvaluadorParaBitacoraPorProceso($evaluador, $id_proceso);
    //Se muestran los objetivos individuales.
    if ($_SESSION["id_empresa"] == 28) {
        $total_html   = file_get_contents("views/sgd/planes/entorno_bloque_principal_chilquinta.html");
        $template_row = file_get_contents("views/sgd/planes/row_colaboradores_chilquinta.html");
    } else {
        $total_html   = file_get_contents("views/sgd/planes/entorno_bloque_principal.html");
        $template_row = file_get_contents("views/sgd/planes/row_colaboradores.html");
    }
    //Primero veo si es que hay registro en la tabla de sesion
    $row           = "";
    $ok_finalizado = 0;
    foreach ($evaluados as $evaluado) {
        $row .= $template_row;
        if ($evaluado->evaluado == $evaluador) {
            $row = str_replace("{BOTON_PLANES_INGRESA}", file_get_contents("views/sgd/planes/boton_ingreso_formulario.html"), $row);
        } else {
            $row = str_replace("{BOTON_PLANES_INGRESA}", "", $row);
        }
        $objetivos_validados_por_validador = VerificaSiObjetivosEstanValidados($evaluado->evaluado);
        //$row=FormularioIngresaObjetivos($row, $evaluado->evaluado, $evaluador);
        if ($evaluado->evaluado == $evaluador) {
            $row = ColocaDatosUsuario($row, $evaluado->evaluado, "planes");
        } else {
            $row = ColocaDatosUsuario($row, $evaluado->evaluado, "sinmensaje");
        }
        //$valores_objetivos=ListadoObjetivosAValidar($evaluado->evaluado, $evaluador, $id_objetivo, "jefe");
        $listado                    = ListadoIngresoPlanes($evaluado->evaluado, $evaluador, $id_plan, "jefe", $id_proceso, $id_proceso_plan, $evaluado->perfil_evaluacion_competencias);
        $row                        = str_replace("{LISTADO_OBJETIVOS_A_EVALUAR}", $listado[1], $row);
        $ponderaciones_bases        = DevuelvePonderacionesPorEvaluado($evaluado->evaluado);
        $verifica_evaluado_validado = VerificaSiObjetivosEstanAjustados($evaluado->evaluado);
        if ($rut_evaluado == $evaluado->evaluado && !$id_plan) {
            $row = str_replace("{FORMUARIO_BITACORA}", file_get_contents("views/sgd/planes/formulario.html"), $row);
            //$row = str_replace("{OPTIONS_VALORES}",OptionsGenericoNombreDadoValoresPorEmpresa("tbl_bitacora_valores", "",  "valor", "id", "order by valor asc", $_SESSION["id_empresa"]),$row);
            //]Aca traigo las competencias de este perfil
            $row = str_replace("{OPTIONS_VALORES}", OptionsCompetenciasDadoPerfil($evaluado->perfil_evaluacion_competencias, ""), $row);
            $row = str_replace("{OPTIONS_PLAZOS_POR_EMPRESA}", OptionsGenericoNombreDadoValoresPorEmpresa("tbl_planes_plazos", "", "nombre", "id", "order by orden asc", $_SESSION["id_empresa"]), $row);
        } else if ($_SESSION["user_"] == $evaluado->evaluado) {
            $row = str_replace("{FORMUARIO_BITACORA}", file_get_contents("views/sgd/planes/formulario.html"), $row);
            //$row = str_replace("{OPTIONS_VALORES}",OptionsGenericoNombreDadoValoresPorEmpresa("tbl_bitacora_valores", "",  "valor", "id", "order by valor asc", $_SESSION["id_empresa"]),$row);
            //]Aca traigo las competencias de este perfil
            $row = str_replace("{OPTIONS_VALORES}", OptionsCompetenciasDadoPerfil($evaluado->perfil_evaluacion_competencias, ""), $row);
            $row = str_replace("{OPTIONS_PLAZOS_POR_EMPRESA}", OptionsGenericoNombreDadoValoresPorEmpresa("tbl_planes_plazos", "", "nombre", "id", "order by orden asc", $_SESSION["id_empresa"]), $row);
        } else {
            $row = str_replace("{FORMUARIO_BITACORA}", "", $row);
        }
        $row              = str_replace("{RUT_ENCODEADO}", Encodear3($evaluado->evaluado), $row);
        $row              = str_replace("{RUT_EVALUADO}", ($evaluado->evaluado), $row);
        //$total_planes=TraeDatosPorPlanes($evaluado->evaluado);
        $total_planes     = TraeDatosPorPlanesPorProcesoPlan($evaluado->evaluado, $id_proceso_plan);
        $row              = str_replace("{X_PLANES}", count($total_planes), $row);
        //$planes_validados=TraePlanesValidados($evaluado->evaluado);
        $planes_validados = TraePlanesValidadosPorProcesoPlan($evaluado->evaluado, $id_proceso_plan);
        $row              = str_replace("{X_VALIDADOS}", count($planes_validados), $row);
        $row              = str_replace("{X_NO_VALIDADOS}", count($total_planes) - count($planes_validados), $row);
        $row              = str_replace("{BOTON_JEFE_VALIDA_OBJETIVOS}", "", $row);
        $row              = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($evaluado->evaluado), $row);
        //ACA veo si es que tiene comentarios de rechazo
        //ACA VEO PARA COLOCAR EL BOTON ENVIAR A VALIDACION
        if ($evaluado->evaluado == $evaluador) {
            if ($listado[0] == "si") {
                //$plan_finalizado=VerificaEstadoPlanes($evaluado->evaluado);
                $plan_finalizado = VerificaEstadoPlanesPorProcesoEmpresa($evaluado->evaluado, $id_proceso_plan, $id_empresa);
                if ($plan_finalizado) {
                    $row = str_replace("{BOTON_VALIDACIONES_PLANES}", "", $row);
                } else {
                    $row = str_replace("{BOTON_VALIDACIONES_PLANES}", file_get_contents("views/sgd/planes/boton_envia_a_validar.html"), $row);
                    $row = str_replace("{RUT_USUARIO_ENCODEADO}", Encodear3($evaluado->evaluado), $row);
                }
            } else {
                $row = str_replace("{BOTON_VALIDACIONES_PLANES}", "", $row);
            }
        } else {
            $row = str_replace("{BOTON_VALIDACIONES_PLANES}", "", $row);
        }
    }
    $total_html = str_replace("{LISTADO_COLABORADORES}", ($row), $total_html);
    $html       = str_replace("{ENTORNO_LISTADO_EVALUACION}", ($total_html), $html);
    return ($html);
}
function ColocaMeGusta($id_objeto, $tipo_objeto, $id_empresa, $rut, $autor, $id_objeto_curso_megusta)
{
    $tiene_megusta = VerCantidadMeGustaPorObjetoYUsuario($id_objeto, $tipo_objeto, $id_empresa, $rut);
    if ($tiene_megusta or $autor) {
        $row              = file_get_contents("views/megusta/bloque_comentario_yamegusta.html");
        $cantidad_megusta = VerCantidadMeGustaPorObjeto($id_objeto, $tipo_objeto, $id_empresa);
        $row              = str_replace("{CANTIDAD_MEGUSTA}", count($cantidad_megusta), $row);
    } else {
        $row              = file_get_contents("views/megusta/bloque_comentario_megusta.html");
        $row              = str_replace("{ID_CONTENIDO}", ($id_objeto), $row);
        $row              = str_replace("{TIPO_OBJETO_MEGUSTA}", $tipo_objeto, $row);
        $row              = str_replace("{ID_OBJETO_MEGUSTA}", $_SESSION["id_objeto"], $row);
        $cantidad_megusta = VerCantidadMeGustaPorObjeto($id_objeto, $tipo_objeto, $id_empresa);
        $row              = str_replace("{CANTIDAD_MEGUSTA}", count($cantidad_megusta), $row);
    }
    return ($row);
}
function ColocaMeGustaApoyoInt($id_objeto, $tipo_objeto, $id_empresa, $rut, $autor, $id_objeto_curso_megusta)
{
    $tiene_megusta = VerInteraccionesPorObjetoYUsuario($id_objeto, $tipo_objeto, $id_empresa, $rut, "MEGUSTA");
    if ($tiene_megusta) {
        $row = file_get_contents("views/megusta/bloque_comentario_yamegusta_apoyo.html");
        //$cantidad_megusta=VerCantidadMeGustaPorObjeto($id_objeto, $tipo_objeto, $id_empresa);
        //$row = str_replace("{CANTIDAD_MEGUSTA}",count($cantidad_megusta),$row);
    } else {
        $row = file_get_contents("views/megusta/bloque_comentario_megusta_apoyo.html");
        $row = str_replace("{ID_CONTENIDO}", ($id_objeto), $row);
        $row = str_replace("{TIPO_OBJETO_MEGUSTA}", $tipo_objeto, $row);
        $row = str_replace("{ID_OBJETO_MEGUSTA}", $_SESSION["id_objeto"], $row);
        //$cantidad_megusta=VerCantidadMeGustaPorObjeto($id_objeto, $tipo_objeto, $id_empresa);
        //$row = str_replace("{CANTIDAD_MEGUSTA}",count($cantidad_megusta),$row);
    }
    return ($row);
}
function ColocaFavoritoInt($id_objeto, $tipo_objeto, $id_empresa, $rut, $autor, $id_objeto_curso_megusta)
{
    $tiene_favorita = VerInteraccionesPorObjetoYUsuario($id_objeto, $tipo_objeto, $id_empresa, $rut, "FAVORITA");
    if ($tiene_favorita) {
        $row = file_get_contents("views/megusta/bloque_comentario_yafavorita_apoyo.html");
        //$cantidad_megusta=VerCantidadMeGustaPorObjeto($id_objeto, $tipo_objeto, $id_empresa);
        //$row = str_replace("{CANTIDAD_MEGUSTA}",count($cantidad_megusta),$row);
    } else {
        $row = file_get_contents("views/megusta/bloque_comentario_favorita_apoyo.html");
        $row = str_replace("{ID_CONTENIDO}", ($id_objeto), $row);
        $row = str_replace("{TIPO_OBJETO_MEGUSTA}", $tipo_objeto, $row);
        $row = str_replace("{ID_OBJETO_MEGUSTA}", $_SESSION["id_objeto"], $row);
        //$cantidad_megusta=VerCantidadMeGustaPorObjeto($id_objeto, $tipo_objeto, $id_empresa);
        //$row = str_replace("{CANTIDAD_MEGUSTA}",count($cantidad_megusta),$row);
    }
    return ($row);
}
function ColocaPDFInt($id_objeto, $tipo_objeto, $id_empresa, $rut, $autor, $id_objeto_curso_megusta)
{
    $tiene_megusta = VerInteraccionesPorObjetoYUsuario($id_objeto, $tipo_objeto, $id_empresa, $rut, "PDF");
    if ($tiene_megusta or $autor) {
        $row = file_get_contents("views/megusta/bloque_comentario_pdf_apoyo.html");
        //$cantidad_megusta=VerCantidadMeGustaPorObjeto($id_objeto, $tipo_objeto, $id_empresa);
        $row = str_replace("{CANTIDAD_MEGUSTA}", count($cantidad_megusta), $row);
    } else {
        $row = file_get_contents("views/megusta/bloque_comentario_pdf_apoyo.html");
        $row = str_replace("{ID_CONTENIDO}", ($id_objeto), $row);
        $row = str_replace("{TIPO_OBJETO_MEGUSTA}", $tipo_objeto, $row);
        $row = str_replace("{ID_OBJETO_MEGUSTA}", $_SESSION["id_objeto"], $row);
        //$cantidad_megusta=VerCantidadMeGustaPorObjeto($id_objeto, $tipo_objeto, $id_empresa);
        $row = str_replace("{CANTIDAD_MEGUSTA}", count($cantidad_megusta), $row);
    }
    return ($row);
}
function MuestraSucursal($PRINCIPAL, $id_sucursal, $id_empresa)
{
    //con el ide de empresa e id de sucursal,traigo los campos a leer
    $campos = TraigoCamposParaSucursalPorEmpresa($id_empresa);
    /*$i=1;
    foreach($campos as $camp){
    $campos_valor.=$camp->campo." as ".$camp->nombrecampo;
    if($i<count($campos)){
    $campos_valor.=", ";
    }
    $i++;
    }
    */
    foreach ($campos as $camp) {
        $dato_a_mostrar = TraeCampoPorSucursalEmpresa($camp->campo, $id_sucursal, $id_empresa);
        $row .= file_get_contents("views/sucursales/row_datos.html");
        $row = str_replace("{NOMBRE_CAMPO}", $camp->nombrecampo, $row);
        if ($camp->veperfil) {
            $datos_usuario = UsuarioEnBasePersonas($dato_a_mostrar[0]->valor);
            $row           = str_replace("{VALOR_CAMPO}", "<a  href='?sw=veperfil&r=" . Encodear3($dato_a_mostrar[0]->valor) . "'>" . $datos_usuario[0]->nombre_completo . " </a>", $row);
        } else {
            $row = str_replace("{VALOR_CAMPO}", $dato_a_mostrar[0]->valor, $row);
        }
    }
    //traigo la coordenada X
    $coordenadaX = TraeCampoPorSucursalEmpresa("coordenadax_googlemap", $id_sucursal, $id_empresa);
    $coordenadaY = TraeCampoPorSucursalEmpresa("coordenaday_googlemap", $id_sucursal, $id_empresa);
    $PRINCIPAL   = str_replace("{COORX}", $coordenadaX[0]->valor, $PRINCIPAL);
    $PRINCIPAL   = str_replace("{ROW_DATOS}", utf8_encode($row), $PRINCIPAL);
    $PRINCIPAL   = str_replace("{COORY}", $coordenadaY[0]->valor, $PRINCIPAL);
    return ($PRINCIPAL);
}
function TransformaAlternativaAPuntaje($alternativa, $perfil, $id_empresa, $dimension)
{
    //echo "$alternativa, $perfil, $id_empresa, $dimension";
    $puntaje = ObtengoPuntajeDadoAlternativa($alternativa, $perfil, $id_empresa, $dimension);
    if ($puntaje) {
        $arreglo[0] = "";
        $arreglo[1] = $puntaje[0]->puntaje;
    } else {
        $arreglo[0] = "";
        $arreglo[1] = $alternativa;
    }
    return ($arreglo);
}
function TotalComponentesPorEvaluador($evaluador)
{
    $perfiles = TotalPerfilesDadoEvaluador1($evaluador);
    //Aca tengo todos los perfiles, con esto, obtengo todas las competencias.
    for ($i = 0; $i < count($perfiles); $i++) {
        $sql .= " perfil_evaluacion='" . $perfiles[$i]->id_perfil_ev . "'";
        if ($perfiles[$i + 1]->id_perfil_ev)
            $sql .= " or";
    }
    $componentes = TotalIdCompetencias($sql);
    $arreglo[0]  = count($componentes);
    $arreglo[1]  = $componentes;
    return ($arreglo);
}
function ObtieneNotaFinalCompetencias($perfil_evaluacion, $evaluado, $evaluador, $id_proceso)
{
    $dimensiones = ObtengoDimensionesDadoPerfil($perfil_evaluacion);
    foreach ($dimensiones as $dim) {
        //Ahora por cada dimension, traigo las competencias
        //$competencias=CompetenciasDadoDimension($dim->id_dimension);
        $competencias                    = CompetenciasDadoDimensionYPerfil($dim->id_dimension, $perfil_evaluacion);
        //echo count($competencias);exit;
        //echo "<br>";
        //$competencias=CompetenciasDadoDimensionYPerfil($dim->id_dimension, $datos_evaluado[0]->perfil_evaluacion);
        $cont_competencias_por_dimension = 0;
        $acum_comp                       = 0;
        foreach ($competencias as $comp) {
            //Promedio de respuestas por competencias
            //$prom_com=PromedioRespuestasComp($evaluado, $evaluador, $comp->id);
            $prom_com  = PromedioRespuestasCompPorProceso($evaluado, $evaluador, $comp->id, $id_proceso);
            //echo "promedio ".$prom_com[0]->nota_competencia."<br>";
            $acum_comp = $acum_comp + $prom_com[0]->nota_competencia;
        }
        //echo "<br>";
        //el promedio de esta dimension
        $acum_dimension = $acum_dimension + ($acum_comp / count($competencias));
        //echo "promedio dimension ".($acum_comp/count($competencias))."   ".$acum_comp." --- ".count($competencias)."  <br>";
    }
    //ACA VERIFICO SI LA EVAL ESTA FINALIZADA
    $finalizada_eval = FinalizadoEvaluadoEvaluador($evaluado, $evaluador, $id_proceso);
    if ($finalizada_eval) {
        $arreglo[0] = $acum_dimension / count($dimensiones);
        $arreglo[1] = "si";
    } else {
        $arreglo[0] = "";
        $arreglo[1] = "no";
    }
    return ($arreglo);
}
function ColocaAvanceSemaforosProcesoEvaluacionPorEvaluador($id_proceso, $id_etapa, $evaluador)
{
    //echo "idproceso  $id_proceso  , id etapa  $id_etapa ,evaluador  $evaluador <br>";
    $total_evaluados   = TraeEvaluadosDadoEvaluadorPorProceso2($evaluador, $id_proceso);
    $total_finalizados = FinalizadoEvaluadoEvaluadorProProcesoSoloEvaluador($evaluador, $id_proceso);
    $avance[0]         = (count($total_finalizados) * 100) / count($total_evaluados);
    if ($avance[0] == 100) {
        $avance[1] = '<span class="fa fa-check text-iconos fs14 mr10"></span>';
    } else {
        $avance[1] = '<span class="fa fa-circle-thin text-iconos fs14 mr10"></span>';
    }
    return ($avance);
}
Function VerificaFotoPersonalParaReporte($id_empresa)
{
    $total_usuarios = TotalUsuariosPorempresa($id_empresa);
    header("Content-Type: application/vnd.ms-excel");
    header("Content-Disposition: attachment; filename=reporte_fotos.xls");
    header("Pragma: no-cache");
    header("Expires: 0");
    echo "<table border='1'>
    <tr>
    <td>&nbsp;</td>
    <td>RUT</td>
    <td>NOMBRE</td>
    <td>APATERNO</td>
    <td>AMATERNO</td>
    <td>TIENE FOTO</td>";
    $i = 1;
    foreach ($total_usuarios as $datos_usuario) {
        $rut_completo      = $datos_usuario->rut_completo;
        $rut               = $datos_usuario->rut;
        $tiene_foto        = "no";
        $ruta              = "../front/img/personas/" . $rut;
        $ruta_rut_completo = "../front/img/personas/" . $rut_completo;
        if (file_exists($ruta . ".jpg")) {
            //$imagen=$ruta.".jpg";
            $tiene_foto = "si";
        } else if (file_exists($ruta . ".JPG")) {
            //$imagen=$ruta.".JPG";
            $tiene_foto = "si";
        } else if (file_exists($ruta . ".gif")) {
            //$imagen=$ruta.".gif";
            $tiene_foto = "si";
        } else if (file_exists($ruta_rut_completo . ".jpg")) {
            //$imagen=$ruta_rut_completo.".jpg";
            $tiene_foto = "si";
        } else if (file_exists($ruta_rut_completo . ".JPG")) {
            //$imagen=$ruta_rut_completo.".JPG";
            $tiene_foto = "si";
        } else if (file_exists($ruta_rut_completo . ".gif")) {
            //$imagen=$ruta_rut_completo.".gif";
            $tiene_foto = "si";
        }
        echo "<tr>
                <td>" . $i . "</td>
                <td>" . $datos_usuario->rut . "</td>
                <td>" . $datos_usuario->nombre . "</td>
                <td>" . $datos_usuario->apaterno . "</td>
                <td>" . $datos_usuario->amaterno . "</td>
                <td>" . $tiene_foto . "</td>
                </tr>";
        $i++;
    }
}
function EstadoMensajeria($id_comentario)
{
    //Veo si el id comentario, est? en la tabla de mensajes_respuestas, y el campo tipo_creador=1
    $mensaje_atendido = MensajeAtendidoPorAdmin($id_comentario);
    if ($mensaje_atendido) {
        $arreglo[0] = "Atendido";
        $arreglo[1] = '<span class="etiquetaEstadoAtendido">Atendido</span>';
    } else {
        $arreglo[0] = "Pendiente";
        $arreglo[1] = '<span class="etiquetaEstadoPendiente">Pendiente</span>';
    }
    return ($arreglo);
}
function IndicadoresEconomicos()
{
    //$apiUrl = 'http://mindicador.cl/api';
    //Es necesario tener habilitada la directiva allow_url_fopen para usar file_get_contents
    if (ini_get('allow_url_fopen')) {
        $json = file_get_contents($apiUrl);
    } else {
        //De otra forma utilizamos cURL
        $curl = curl_init($apiUrl);
        curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
        $json = curl_exec($curl);
        curl_close($curl);
    }
    $dailyIndicators = json_decode($json);
    echo 'El valor actual de la UF es $' . $dailyIndicators->uf->valor;
    echo 'El valor actual del D?lar observado es $' . $dailyIndicators->dolar->valor;
    echo 'El valor actual del D?lar acuerdo es $' . $dailyIndicators->dolar_intercambio->valor;
    echo 'El valor actual del Euro es $' . $dailyIndicators->euro->valor;
    echo 'El valor actual del IPC es ' . $dailyIndicators->ipc->valor;
    echo 'El valor actual de la UTM es $' . $dailyIndicators->utm->valor;
    echo 'El valor actual del IVP es $' . $dailyIndicators->ivp->valor;
    echo 'El valor actual del Imacec es ' . $dailyIndicators->imacec->valor;
}
function ColocaBloquePrincipalCategorias($PRINCIPAL, $id_empresa)
{
    $categorias = TraeCategoriasPorEmpresa($id_empresa);
    $i          = 1;
    foreach ($categorias as $Cat) {
        $row    = file_get_contents("views/biblioteca/lista_todas_categorias.html");
        $row    = str_replace("{CATEGORIA}", $Cat->categoria, $row);
        $row    = str_replace("{NOMBRE}", $Cat->categoria, $row);
        $row    = str_replace("{DESCRIPCION}", $Cat->descripcion, $row);
        $row    = str_replace("{FECHA}", $Cat->fecha, $row);
        $imagen = "";
        if ($Cat->imagen <> "") {
            $imagen = "<img src='img/" . $Cat->imagen . "' border=0>";
        }
        ;
        $row   = str_replace("{IMAGEN}", $imagen, $row);
        $total = Total_archivos_categoria($Cat->id);
        $row   = str_replace("{DETALLE}", " " . $total . "", $row);
        $row   = str_replace("{ID}", $Cat->id, $row);
        $total_html .= $row;
        if ($i == 2) {
            $i = 1;
            $total_html .= "<div class='row'></div>";
        } else {
            $i++;
        }
    }
    $PRINCIPAL = str_replace("{LISTADO_CATEGORIAS_PRINCIPALES}", $total_html, $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaBloqueUltimosDescargadosBiblio($PRINCIPAL, $id_empresa)
{
    //$archivos2=mas_descargados(3);
    $archivos2 = mas_descargadosPorEmpresa(3, $id_empresa);
    $entorno   = file_get_contents("views/biblioteca/entorno_ultimos_documentos_descargados.html");
    foreach ($archivos2 as $ar2) {
        $row2 = file_get_contents("views/biblioteca/ultimos3_archivos.html");
        $row2 = str_replace("{ICONO}", "<img src='img/iconos/" . $ar2->icono . ".png'>", $row2);
        $row2 = str_replace("{NOMBRE}", $ar2->titulo, $row2);
        $row2 = str_replace("{DESCRIPCION}", $ar2->descripcion, $row2);
        $row2 = str_replace("{IMAGEN}", $ar2->imagen, $row2);
        $row2 = str_replace("{FECHA}", $ar2->fecha, $row2);
        $row2 = str_replace("{DESCARGADO}", $ar2->descargado, $row2);
        $row2 = str_replace("{DETALLE}", $ar2->tamano, $row2);
        $row2 = str_replace("{DESCARGA}", "./archivos_biblioteca/" . $ar2->archivo, $row2);
        $row2 = str_replace("{ID}", $ar2->id, $row2);
        $total_html1 .= $row2;
    }
    //$html = str_replace("{LISTA2}",$total_html1,$html);
    $entorno   = str_replace("{LISTA_MAS_DESCARGADOS}", $total_html1, $entorno);
    $PRINCIPAL = str_replace("{BLOQUE_LOS_MAS_DESCARGADOS}", $entorno, $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaBloqueUltimosBiblio($PRINCIPAL, $id_empresa)
{
    $archivos = ultimos_archivosPorEmpresa(3, $id_empresa);
    $entorno  = file_get_contents("views/biblioteca/entorno_ultimos_documentos.html");
    foreach ($archivos as $ar) {
        $total_r++;
        $row = file_get_contents("views/biblioteca/ultimos3_archivos.html");
        $row = str_replace("{ICONO}", "<img src='img/iconos/" . $ar->icono . ".png'>", $row);
        $row = str_replace("{NOMBRE}", $ar->titulo, $row);
        $row = str_replace("{DESCRIPCION}", $ar->descripcion, $row);
        $row = str_replace("{IMAGEN}", $ar->imagen, $row);
        $row = str_replace("{FECHA}", $ar->fecha, $row);
        $row = str_replace("{DESCARGADO}", $ar->descargado, $row);
        $row = str_replace("{DETALLE}", $ar->tamano, $row);
        $row = str_replace("{DESCARGA}", "./archivos_biblioteca/" . $ar->archivo, $row);
        $row = str_replace("{ID}", $ar->id, $row);
        $total_html .= $row;
    }
    $entorno   = str_replace("{LISTA_ULTIMOS_DESCARGADOS}", $total_html, $entorno);
    $PRINCIPAL = str_replace("{BLOQUE_ULTIMOS_DOCUMENTOS}", $entorno, $PRINCIPAL);
    return ($PRINCIPAL);
}
function BloqueListadoEvaluadosEvalCompetencias($arreglo_evaluados, $evaluador, $id_componente, $id_pregunta, $id_proceso_anterior, $id_procceso, $comentario_obligatorio, $td_options, $template_comentario_por_pregunta)
{
    $total_evaluados_a_evaluar = 0;
    $total_evaluados_a_evaluar = 0;
    foreach ($arreglo_evaluados as $evaluado) {
        //Aca debo verificar si es que este evaluado, le corresponde ser evaluado por esta pregunta / competencia
        $verificaPReg = EvaluadoParaEstaPregunta($id_componente, $id_pregunta, $evaluado->evaluado, $evaluado->perfil_evaluacion);
        if ($verificaPReg == "si") {
            $total_evaluados_a_evaluar++;
            $row .= file_get_contents("views/sgd/evaluacion/" . $_SESSION["id_empresa"] . "_row_colaboradores_evaluacion_comp_dinamico.html");
            $row = str_replace("{SECCION_BLOQUE_COMENTARIO}", $template_comentario_por_pregunta, $row);
            $row = str_replace("{ROWSPAN_SI_TIENE_COMENTARIO}", $rowspan_tiene_comentario, $row);
            $row = str_replace("{NOMBRE_COMENTARIO}", "c" . $evaluado->evaluado . "-" . $id_pregunta, $row);
            $row = str_replace("{CAMPO_OBLIGATORIO}", $comentario_obligatorio, $row);
            $row = str_replace("{SECCION_INPUTS}", $td_options, $row);
            if ($id_proceso_anterior) {
                //Aca verifico si en esta pregunta, evaluado, evaluador, proceso, perfil, ya tiene respuesta anteriormente, si es asi, coloca estilo de color, sino replace con vacio
                $tiene_respuesta_proceso_anterior = TieneRespuestaCompetenciaProProceso($evaluado->evaluado, $evaluador, $id_pregunta, $id_proceso_anterior);
                if ($tiene_respuesta_proceso_anterior) {
                    //echo "{STYLO1".$tiene_respuesta_proceso_anterior[0]->respuesta."}";
                    $row = str_replace("{STYLO1" . $tiene_respuesta_proceso_anterior[0]->respuesta . "}", "backalt", $row);
                }
                for ($h = 1; $h <= 10; $h++) {
                    $row = str_replace("{STYLO1" . $h . "}", "", $row);
                }
            }
            $row        = str_replace("{SUBPERFIL_EVALUACION}", utf8_encode($evaluado->nombre_subperfil), $row);
            //$row=ColocaDatosUsuario($row, $evaluado->evaluado);
            $row        = ColocaDatosUsuarioSGD($row, $evaluado->evaluado, "", $evaluador, $id_procceso);
            $row        = str_replace("{NOMBRE_RADIO}", $evaluado->evaluado . "-" . $id_pregunta, $row);
            $row        = str_replace("{NOMBRE_RADIO_SOLO_PREGUNTA}", $id_pregunta, $row);
            //$tiene_resp=TieneRespuestaCompetencia($evaluado->evaluado, $evaluador, $id_componente);
            $row        = str_replace("{ID_PREGUNTA_AJAX}", $id_pregunta, $row);
            $row        = str_replace("{EVALUADO_AJAX}", $evaluado->evaluado, $row);
            $row        = str_replace("{EVALUADO_AJAX_ENCODEADO}", Encodear3($evaluado->evaluado), $row);
            //$tiene_resp=TieneRespuestaCompetencia($evaluado->evaluado, $evaluador, $id_pregunta);
            $tiene_resp = TieneRespuestaCompetenciaProProceso($evaluado->evaluado, $evaluador, $id_pregunta, $id_procceso);
            $row        = str_replace("{COMENTARIO_c" . $evaluado->evaluado . "-" . $id_pregunta . "}", utf8_encode($tiene_resp[0]->comentario), $row);
            $row        = str_replace("{SELECT" . $tiene_resp[0]->respuesta . "}", "checked", $row);
            $row        = str_replace("{SELECT1}", "", $row);
            $row        = str_replace("{SELECT1.5}", "", $row);
            $row        = str_replace("{SELECT2}", "", $row);
            $row        = str_replace("{SELECT2.3}", "", $row);
            $row        = str_replace("{SELECT2.7}", "", $row);
            $row        = str_replace("{SELECT3}", "", $row);
            $row        = str_replace("{SELECT3.3}", "", $row);
            $row        = str_replace("{SELECT3.7}", "", $row);
            $row        = str_replace("{SELECT4}", "", $row);
            $row        = str_replace("{SELECT4.5}", "", $row);
            $row        = str_replace("{SELECT5}", "", $row);
        }
    }
    //Listado de Evaluados a Evaluar
    $arreglo[0] = $row;
    //Cantidad de evaluados
    $arreglo[1] = $total_evaluados_a_evaluar;
    return ($arreglo);
}
function BloqueListadoObjetivoEspecificos($evaluado, $evaluador, $id_proceso, $id_empresa, $con_notas)
{
    if ($con_notas == "si") {
        if ($evaluado == $evaluador) {
            $template_row  = file_get_contents("views/sgd/informe/" . $id_empresa . "_row_informe1.html");
            $template_row1 = file_get_contents("views/sgd/informe/" . $id_empresa . "_row_informe1.1.html");
        } else {
            $template_row  = file_get_contents("views/sgd/informe/" . $id_empresa . "_row_informe1_con_ae.html");
            $template_row1 = file_get_contents("views/sgd/informe/" . $id_empresa . "_row_informe1.1_con_ae.html");
        }
    } elseif ($con_notas == "no") {
        $template_row  = file_get_contents("views/sgd/informe/row_informe1_sinnota.html");
        $template_row1 = file_get_contents("views/sgd/informe/row_informe1.1_sinnota.html");
    }
    //$objetivos=ObjetivosEspecificosConRespuestaEvaluadoEvaluadorProceso($evaluado, $evaluador, $id_proceso);
    if ($id_empresa == 43) {
        $objetivos = ObjetivosEspecificosConRespuestaEvaluadoEvaluadorProceso2SinTablaRespuesta($evaluado, $evaluador, $id_proceso);
    } else {
        $objetivos = ObjetivosEspecificosConRespuestaEvaluadoEvaluadorProceso2($evaluado, $evaluador, $id_proceso);
    }
    $contador_objetivos = 0;
    foreach ($objetivos as $ob) {
        $contador_objetivos++;
        if ($subtitulo_dimension_objetivos <> $ob->nombre_dimension) {
            $row2 .= $template_row;
            $row2 = str_replace("{NOMBRE}", $ob->nombre_dimension, $row2);
            $row2 = str_replace("{DESCRIPCION}", $ob->descripcion, $row2);
            //$promedio_por_dimension=PromedioPorDimensionObjetivos($evaluado, $evaluador, $ob->dimension, $id_proceso);
            if ($id_empresa == 43) {
                $promedio_por_dimension = ObtieneNotaObjetivosPorDimension($evaluado, $evaluador, $id_proceso, $ob->dimension);
            } else {
                $promedio_por_dimension = ObtieneNotaObjetivos($evaluado, $evaluador, $id_proceso, $ob->dimension);
            }
            //Aca obtengo la nota promedio de esta dimension
            $criterios_dimensiones = ObtenerCriterioPuntajeMatrizNotaFinal($promedio_por_dimension, $evaluado, "", "ind", $evaluador, $id_proceso);
            $row2                  = str_replace("{NOTA}", FormatearPorcentajesSinDecimal($promedio_por_dimension), $row2);
            $row2                  = str_replace("{ESTILO_ETIQUETA}", $criterios_dimensiones[2], $row2);
            $row2                  = str_replace("{ICONO}", $criterios_dimensiones[3], $row2);
            $row2                  = str_replace("{CRITERIO}", $criterios_dimensiones[0], $row2);
        }
        $acumulador_promedio_dimensiones = $acumulador_promedio_dimensiones + $ob->puntaje;
        $contador_obj++;
        $subtitulo_dimension_objetivos = $ob->nombre_dimension;
        //$row2.=file_get_contents("views/sgd/informe/row_informe1.1.html");
        $row2 .= $template_row1;
        $row2 = str_replace("{NOMBRE_1}", $ob->descripcion_objetivo, $row2);
        $row2 = str_replace("{PONDERACION_1}", $ob->ponderacion, $row2);
        $row2 = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($rut), $row2);
        $row2 = str_replace("{VALOR_NOTA_OBJ_PRECARGADA}", $ob->nota_ev, $row2);
        if ($obj->nota_descripcion) {
            $row2 = str_replace("{VALOR_NOTA_OBJ_PRECARGADA_DESC}", $ob->nota_descripcion, $row2);
        } else {
            $row2 = str_replace("{VALOR_NOTA_OBJ_PRECARGADA_DESC}", $ob->nota_ev, $row2);
        }
        $row2 = str_replace("{OPCION_ID_OBJ}", Encodear($evaluado) . "-" . Encodear($ob->id_objetivo_original), $row2);
        if ($ob->nota_descripcion) {
            $row2 = str_replace("{DESCRIPCION_1}", $ob->nota_descripcion, $row2);
        } else {
            $row2 = str_replace("{DESCRIPCION_1}", $ob->metrica, $row2);
        }
        $criterios = ObtenerCriterioPuntajeMatrizNotaFinal($ob->puntaje, $evaluado, "", "ind", $evaluador, $id_proceso);
        if ($ob->puntaje == 0) {
            $row2 = str_replace("{NOTA_1}", "No Aplica", $row2);
            $row2 = str_replace("{ESTILO_ETIQUETA_1}", "estilo_no_aplica", $row2);
            $row2 = str_replace("{ICONO_1}", "", $row2);
            $row2 = str_replace("{CRITERIO_1}", "", $row2);
        } else {
            $row2 = str_replace("{NOTA_1}", FormatearPorcentajesSinDecimal($ob->puntaje) . "", $row2);
            $row2 = str_replace("{ESTILO_ETIQUETA_1}", $criterios[2], $row2);
            $row2 = str_replace("{ICONO_1}", $criterios[3], $row2);
            $row2 = str_replace("{CRITERIO_1}", $criterios[0], $row2);
        }
        if ($ob->comentario) {
            $row2 = str_replace("{BLOQUE_COMENTARIO_POR_OBJETIVO}", file_get_contents("views/sgd/informe/" . $id_empresa . "_row_informe_comentario_por_objetivo.html"), $row2);
            $row2 = str_replace("{TIPO}", "", $row2);
            $row2 = str_replace("{COMENTARIO_POR_OBJETIVO}", utf8_encode($ob->comentario), $row2);
        } else {
            $row2 = str_replace("{BLOQUE_COMENTARIO_POR_OBJETIVO}", "", $row2);
        }
        $nota_ae      = ObjetivosEspecificosConRespuestaEvaluadoEvaluadorProceso2Objeto($evaluado, $evaluado, $id_proceso, $ob->id_objetivo_original);
        $criterios_ae = ObtenerCriterioPuntajeMatrizNotaFinal($nota_ae[0]->puntaje, $evaluado, "", "ind", $evaluado, $id_proceso);
        $row2         = str_replace("{NOTA_1_AE}", FormatearPorcentajesSinDecimal($nota_ae[0]->puntaje), $row2);
        $row2         = str_replace("{ESTILO_ETIQUETA_1_AE}", $criterios_ae[2], $row2);
        $row2         = str_replace("{ICONO_1_AE}", $criterios_ae[3], $row2);
        $row2         = str_replace("{CRITERIO_1_AE}", $criterios_ae[0], $row2);
        if ($nota_ae[0]->comentario) {
            $row2 = str_replace("{BLOQUE_COMENTARIO_POR_OBJETIVO_AE}", file_get_contents("views/sgd/informe/" . $id_empresa . "_row_informe_comentario_por_objetivo.html"), $row2);
            $row2 = str_replace("{TIPO}", "Autoevaluaci&oacute;n", $row2);
            $row2 = str_replace("{COMENTARIO_POR_OBJETIVO}", utf8_encode($nota_ae[0]->comentario), $row2);
        } else {
            $row2 = str_replace("{BLOQUE_COMENTARIO_POR_OBJETIVO_AE}", "", $row2);
        }
        //$row2 = str_replace("{COMENTARIO_POR_OBJETIVO_FORMULARIO}",$ob->comentario,$row2);
        //ESTE BLOQUE ES PARA LA ULTIMA DIMENSION
        if (count($objetivos) == $contador_objetivos) {
            $criterios_dimensiones = ObtenerCriterioPuntajeMatrizNotaFinal($nota_por_dimension, $evaluado, "", "ind");
            $row2                  = str_replace("{NOTA}", $nota_por_dimension, $row2);
            $row2                  = str_replace("{ESTILO_ETIQUETA}", $criterios_dimensiones[2], $row2);
            $row2                  = str_replace("{ICONO}", FormatearPorcentajesSinDecimal($criterios_dimensiones[3]), $row2);
            $row2                  = str_replace("{CRITERIO}", $criterios_dimensiones[0], $row2);
        }
    }
    return ($row2);
}
function ArmaTemplareDeTablaResumen($html, $id_proceso_anual, $id_empresa, $perfil_evaluacion, $evaluado, $rut, $muestra_boton_informe, $id_proceso_para_reportes_admin)
{
    //$id_proceso_para_reportes_admin -->se lo paso desde el admin, para los reportes de resultados
    //echo "$id_proceso_anual, $id_empresa, $perfil_evaluacion, $evaluado, $rut, $muestra_boton_informe, $id_proceso_para_reportes_admin";
    $porcentajes = TraePonderacionesPorPerfil($perfil_evaluacion);
    $contador    = 0;
    if ($porcentajes[0]->objetivos_empresa > 0) {
        $tr_items .= file_get_contents("views/sgd/informe/tabla_superior_resumen/tr_por_item.html");
        $tr_items = str_replace("{ITEM_PORCEN}", $porcentajes[0]->objetivos_empresa . "% Corporativo", $tr_items);
        $tr_valores .= file_get_contents("views/sgd/informe/tabla_superior_resumen/tr_valores_empresa.html");
        $contador++;
    }
    if ($porcentajes[0]->objetivos_area > 0) {
        $tr_items .= file_get_contents("views/sgd/informe/tabla_superior_resumen/tr_por_item.html");
        $tr_items = str_replace("{ITEM_PORCEN}", $porcentajes[0]->objetivos_area . "% Area", $tr_items);
        $tr_valores .= file_get_contents("views/sgd/informe/tabla_superior_resumen/tr_valores_area.html");
        $contador++;
    }
    if ($porcentajes[0]->objetivos_individuales > 0) {
        $tr_items .= file_get_contents("views/sgd/informe/tabla_superior_resumen/tr_por_item.html");
        $tr_items = str_replace("{ITEM_PORCEN}", $porcentajes[0]->objetivos_individuales . "% " . $porcentajes[0]->nombre_objetivos_individuales, $tr_items);
        $tr_valores .= file_get_contents("views/sgd/informe/tabla_superior_resumen/tr_valores_ind.html");
        $contador++;
    }
    if ($porcentajes[0]->competencias > 0) {
        $tr_items .= file_get_contents("views/sgd/informe/tabla_superior_resumen/tr_por_item.html");
        if ($id_empresa == 28) {
            $tr_items = str_replace("{ITEM_PORCEN}", $porcentajes[0]->nombre_competencias, $tr_items);
        } else {
            $tr_items = str_replace("{ITEM_PORCEN}", $porcentajes[0]->competencias . "% " . $porcentajes[0]->nombre_competencias, $tr_items);
        }
        $tr_valores .= file_get_contents("views/sgd/informe/tabla_superior_resumen/tr_valores_comp.html");
        $contador++;
    }
    if ($id_empresa == 28 or $id_empresa == 61) {
        $tr_items .= file_get_contents("views/sgd/informe/tabla_superior_resumen/tr_por_item.html");
        $tr_items = str_replace("{ITEM_PORCEN}", "Autoevaluacion", $tr_items);
        $tr_valores .= file_get_contents("views/sgd/informe/tabla_superior_resumen/tr_valores_ae.html");
        $contador++;
    }
    $html                = str_replace("{FILAS_DINAMICAS_DE_LOS_PORCENTAJES}", utf8_encode($tr_items), $html);
    $datos_proceso_anual = DatosProcesoAnual($id_proceso_anual, $id_empresa);
    //$procesos=ProcesosEvalPorProcesoAnual($datos_proceso_anual[0]->id);
    $procesos            = ProcesosEvalPorProcesoAnualParaTabla($datos_proceso_anual[0]->id, "evaluacion");
    $td_por_proceso      = "";
    if ($id_empresa == 28) {
        $row_template = file_get_contents("views/sgd/informe/tabla_superior_resumen/td_por_proceso_chilquinta.html");
    } else {
        $row_template = file_get_contents("views/sgd/informe/tabla_superior_resumen/td_por_proceso.html");
    }
    foreach ($procesos as $unico) {
        $td_por_proceso .= $row_template;
        if ($unico->evaluacion_individual == 1) {
            $td_por_proceso = str_replace("{BOTON_EVALUACION_INDIVIDUAL}", file_get_contents("views/sgd/informe/tabla_superior_resumen/boton_eval_individual.html"), $td_por_proceso);
        } else {
            $td_por_proceso = str_replace("{BOTON_EVALUACION_INDIVIDUAL}", "", $td_por_proceso);
        }
        //Por cada proceso, verifico si est? finalizado para este evaluado y evaluador, asi
        //veo si coloco o no el boton de Ver Informe
        if ($muestra_boton_informe == "no") {
            $td_por_proceso = str_replace("{BOTON_VE_INFORME_POR_PROCESO}", "", $td_por_proceso);
        } else {
            $proceso_finalizado = FinalizadoEvaluadoEvaluadorProProceso($evaluado, $rut, $unico->id_proceso);
            if ($proceso_finalizado) {
                if ($muestra_boton_informe == "no") {
                    $td_por_proceso = str_replace("{BOTON_VE_INFORME_POR_PROCESO}", "", $td_por_proceso);
                } else {
                    $td_por_proceso = str_replace("{BOTON_VE_INFORME_POR_PROCESO}", file_get_contents("views/sgd/informe/tabla_superior_resumen/boton_ve_informe.html"), $td_por_proceso);
                }
            } else {
                $td_por_proceso = str_replace("{BOTON_VE_INFORME_POR_PROCESO}", "", $td_por_proceso);
            }
        }
        $td_por_proceso = str_replace("{NOMBRE_PROCESO}", $unico->descripcion_proceso, $td_por_proceso);
        $td_por_proceso = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($evaluado), $td_por_proceso);
        $td_por_proceso = str_replace("{ID_PROCESO_ENCODEADO}", Encodear3($unico->id_proceso), $td_por_proceso);
        $td_por_proceso = str_replace("{FILAS_NOTAS_DINAMICAS}", $tr_valores, $td_por_proceso);
        //Ahora por cada proceso, lo paso por la funcion que coloca los datos
        if ($evaluado == $rut) {
            $datos_rel = ObtenerJefeRelPorProceso($evaluado, $unico->id_proceso);
            //$rut=$datos_rel[0]->evaluador;
        }
        $td_por_proceso = ColocaResultadosTablaReumen($td_por_proceso, $evaluado, $rut, $unico->id_proceso, $unico->id_proceso, $id_proceso_para_reportes_admin);
        if ($unico->nota_final == 1) {
            if ($id_proceso_para_reportes_admin) {
                if ($id_proceso_para_reportes_admin == $unico->id_proceso) {
                    $html = ColocaResultadosTablaReumen($html, $evaluado, $rut, $unico->id_proceso, $unico->id_proceso, $id_proceso_para_reportes_admin);
                }
            } else {
                $html = ColocaResultadosTablaReumen($html, $evaluado, $rut, $unico->id_proceso, $unico->id_proceso, $id_proceso_para_reportes_admin);
            }
        }
    }
    $html = str_replace("{COLUMNAS_DINAMICAS_DADA_CANTIDAD_PROCESOS}", utf8_encode($td_por_proceso), $html);
    return ($html);
}
function FuncionParaObtenerCalculoMientrasAvanzaPagina($html, $evaluador, $id_proceso_evaluacion, $id_empresa, $evaluado, $calibrador, $origen, $arreglo_post, $filtro1, $filtro2)
{
    if ($arreglo_post["rutevaluador"] && $arreglo_post["evaluador"])
        $evaluador = $arreglo_post["rutevaluador"];
    if ($arreglo_post["rutcalibrador"] && $arreglo_post["calibrador"])
        $calibrador = $arreglo_post["rutcalibrador"];
    //Lo que voy a hacer, es treaer el total de respuestas, con inner join de la tabla preguntas
    //Eso va a ser el total.
    //Sobre eso los categorizo
    if ($evaluado) {
        $respuestas_todas = TraigoRespuestasCrucePreguntasPorEvaluado($evaluador, $id_proceso_evaluacion, $evaluado);
    } else if ($calibrador) {
        //$respuestas_todas=TraigoRespuestasCrucePreguntasPorCalibrador($calibrador, $id_proceso_evaluacion);
        $respuestas_todas = TraigoRespuestasCrucePreguntasPorCalibradorSinAe($calibrador, $id_proceso_evaluacion);
    } else if ($evaluador) {
        //$respuestas_todas=TraigoRespuestasCrucePreguntas($evaluador, $id_proceso_evaluacion);
        $respuestas_todas = TraigoRespuestasCrucePreguntasSinAe($evaluador, $id_proceso_evaluacion);
    } else if ($id_proceso_evaluacion) {
        //$respuestas_todas=TraigoRespuestasCrucePreguntasSoloPorProceso($id_proceso_evaluacion);
        $respuestas_todas = TraigoRespuestasCrucePreguntasSoloPorProcesoSinAe($id_proceso_evaluacion, $filtro1, $filtro2, $arreglo_post);
    }
    //echo "total de respuestas ".count($respuestas_todas);
    //ahora traigo  los rangos de la tabla de matriz
    $registros                = DatosCriterioPorEmpresaTipo($id_empresa, "grafico_frecuencia");
    $datos_empresa            = DatosEmpresa($id_empresa);
    $datos_proceso_evaluacion = TraeProcesosDeEvaluacionPorEmpresaYDiProceso($id_empresa, $id_proceso_evaluacion);
    $contador_                = 1;
    foreach ($registros as $unico) {
        //print_r($unico);
        //echo "<br><br>";
        //_ahora por cada categoria, traigo la cantidad de respuestas, pasando como parametro
        //los rangos menores y mayores
        if ($evaluado) {
            //echo "1";
            $respuestas = TraigoRespuestasCrucePreguntasPorRangosMenorYMayorPorEvaluado($evaluador, $id_proceso_evaluacion, $unico->rangomenor, $unico->rangomayor, $evaluado);
        } else if ($calibrador) {
            //echo "2";
            $respuestas = TraigoRespuestasCrucePreguntasPorRangosMenorYMayorPorCalibrador($calibrador, $id_proceso_evaluacion, $unico->rangomenor, $unico->rangomayor);
        } else if ($evaluador) {
            //$respuestas=TraigoRespuestasCrucePreguntasPorRangosMenorYMayor($evaluador, $id_proceso_evaluacion, $unico->rangomenor, $unico->rangomayor);
            $respuestas = TraigoRespuestasCrucePreguntasPorRangosMenorYMayorSinAe($evaluador, $id_proceso_evaluacion, $unico->rangomenor, $unico->rangomayor);
        } else if ($id_proceso_evaluacion) {
            //$respuestas=TraigoRespuestasCrucePreguntasPorRangosMenorYMayorSoloPorProceso($id_proceso_evaluacion, $unico->rangomenor, $unico->rangomayor);
            $respuestas = TraigoRespuestasCrucePreguntasPorRangosMenorYMayorSoloPorProcesoSinAe($id_proceso_evaluacion, $unico->rangomenor, $unico->rangomayor, $arreglo_post);
        }
        //$datos.="['".$unico->criterio."', ".FormatearPorcentajesSinDecimal((100*count($respuestas))/count($respuestas_todas)).", ".$unico->requerido."]";
        $datos .= "['" . $unico->criterio . "', " . FormatearPorcentajesSinDecimal((100 * count($respuestas)) / count($respuestas_todas)) . "]";
        if ($contador_ < count($registros))
            $datos .= ",";
        $contador_++;
    }
    //echo "<br>";
    //            print_r($datos);
    //    echo "<br>";
    //echo $datos;
    if ($origen == "admin") {
        $template_grafico = file_get_contents("../front/views/sgd/graficos/barra_frecuenciaCompetencias.html");
    } else {
        $template_grafico = file_get_contents("views/sgd/graficos/barra_frecuenciaCompetencias.html");
    }
    $template_grafico = str_replace("{ARREGLO_DATOS}", $datos, $template_grafico);
    $template_grafico = str_replace("{TITULO_GRAFICO_1}", $datos_proceso_evaluacion[0]->titulo_grafico_1, $template_grafico);
    if ($datos_empresa[0]->color_grafico1) {
        $template_grafico = str_replace("{COLOR_GRAFICO}", $datos_empresa[0]->color_grafico1, $template_grafico);
    } else {
        $template_grafico = str_replace("{COLOR_GRAFICO}", "#009B1D", $template_grafico);
    }
    $html = str_replace("{GRAFICO}", $template_grafico, $html);
    return ($html);
}
function FuncionParaObtenerCalculoMientrasAvanzaPaginaBK($html, $evaluador, $id_proceso_evaluacion, $id_empresa)
{
    //Lo que voy a hacer, es treaer el total de respuestas, con inner join de la tabla preguntas
    //Eso va a ser el total.
    //Sobre eso los categorizo
    $respuestas       = TraigoRespuestasCrucePreguntas($evaluador, $id_proceso_evaluacion);
    $contador_arreglo = 0;
    foreach ($respuestas as $resp) {
        $valores                                = ObtenerCriterioPuntajeMatrizNotaFinal($resp->puntaje, $resp->evaluado, "", "grafico_frecuencia");
        //print_r($valores);echo "<br>";
        $arreglo[$contador_arreglo]["criterio"] = $valores[0];
        $arreglo[$contador_arreglo]["etiqueta"] = $valores[2];
        $arreglo[$contador_arreglo]["icono"]    = $valores[3];
        $arreglo[$contador_arreglo]["puntaje"]  = $valores[4];
        $contador_arreglo++;
        //exit;
    }
    //echo "<pre>";
    //print_r($arreglo[$contador_arreglo]);exit;
    foreach ($arreglo as $key => $row) {
        $aux[$key] = $row['puntaje'];
    }
    array_multisort($aux, SORT_ASC, $arreglo);
    $categoria    = "";
    //Aca traigo los criterios de la tabla matriz, pasandole el parametro grafico_frecuencia y el id de empresa
    $datos_matriz = TaigoDatosMatriz($id_empresa, "grafico_frecuencia");
    for ($i = 0; $i < count($arreglo); $i++) {
        $indice_arreglo_grafico = 0;
        foreach ($datos_matriz as $dat) {
            //echo $dat->criterio." ".$arreglo[$i]["criterio"];exit;
            if ($dat->criterio == $arreglo[$i]["criterio"]) {
                $arreglo_grafico[$indice_arreglo_grafico]["criterio"] = $arreglo[$i]["criterio"];
                $arreglo_grafico[$indice_arreglo_grafico]["cantidad"]++;
                continue;
            }
            $indice_arreglo_grafico++;
        }
    }
    for ($j = count($arreglo_grafico); $j < count($datos_matriz); $j++) {
        $arreglo_grafico[$j + 1]["criterio"] = $datos_matriz[$j]->criterio;
        $arreglo_grafico[$j + 1]["cantidad"] = 0;
    }
    //echo "<pre>";
    //print_r(($arreglo_grafico));exit;
    $template_grafico = file_get_contents("views/graficos/barra_frecuenciaCompetencias.html");
    for ($i = 1; $i <= count($arreglo_grafico); $i++) {
        $datos .= "['" . $arreglo_grafico[$i]['criterio'] . "', " . $arreglo_grafico[$i]['cantidad'] . ", 10]";
        if ($i < count($arreglo_grafico))
            $datos .= ",";
    }
    //echo "<pre>";
    //print_r($arreglo_grafico);exit;
    $template_grafico = str_replace("{ARREGLO_DATOS}", $datos, $template_grafico);
    $html             = str_replace("{GRAFICO}", $template_grafico, $html);
    return ($html);
}
function OptionsCategoriasValoresFormularios($id_Categoria, $id_empresa)
{
    $valores = TraigoValoresPorCategoria($id_Categoria, $id_empresa);
    foreach ($valores as $val) {
        $html .= "<option value=" . $val->id . ">" . $val->nombre . "</option>";
    }
    return (utf8_encode($html));
}
function BloqueBuscadorPersonasDirectorio($html, $id_empresa)
{
    $html = str_replace("{SECCION_BUSCA_PERSONAS_DIRECTORIO}", file_get_contents("views/buscador_personas/buscador.html"), $html);
    return ($html);
}
function buscacursosaprobadospornivel($id_orden_nivel, $rut, $id_empresa, $id_malla)
{
    //echo "<br>$id_orden_nivel,$rut, $id_empresa, $id_malla";
    $buscacursosaprobadospornivel_arreglos = buscacursosaprobadospornivel_data($id_orden_nivel, $rut, $id_empresa, $id_malla);
    //print_r($buscacursosaprobadospornivel_arreglos);
    foreach ($buscacursosaprobadospornivel_arreglos as $cursonivel) {
        //    echo "<br>$cursonivel->idcurso ";
        //    echo "$cursonivel->aprobado";
        if ($cursonivel->aprobado == 1) {
            $cursoaprobado++;
        }
    }
    return $cursoaprobado;
}
function MP_estadisticas_personales($PRINCIPAL, $rut, $id_empresa)
{
    $mp_estadisticas_personal = MP_buscaestadisticasPersonales($rut, $id_empresa);
    $PRINCIPAL                = str_replace("{MP_MIS_PUBLICACIONES}", $mp_estadisticas_personal[0]->MP_MIS_PUBLICACIONES, $PRINCIPAL);
    $PRINCIPAL                = str_replace("{MP_MIS_FAVORITAS}", $mp_estadisticas_personal[0]->MP_MIS_FAVORITAS, $PRINCIPAL);
    $PRINCIPAL                = str_replace("{MP_COMPARTIDA_CONMIGO}", $mp_estadisticas_personal[0]->MP_COMPARTIDA_CONMIGO, $PRINCIPAL);
    $PRINCIPAL                = str_replace("{MP_SIGUIENDO}", $mp_estadisticas_personal[0]->MP_SIGUIENDO, $PRINCIPAL);
    $PRINCIPAL                = str_replace("{MP_MESIGUEN}", $mp_estadisticas_personal[0]->MP_MESIGUEN, $PRINCIPAL);
    $PRINCIPAL                = str_replace("{MP_MIS_INTERESES}", $mp_estadisticas_personal[0]->MP_MIS_INTERESES, $PRINCIPAL);
    $PRINCIPAL                = str_replace("{MP_INSIGNIA}", $mp_estadisticas_personal[0]->MP_INSIGNIA, $PRINCIPAL);
    $PRINCIPAL                = str_replace("{ICONOINSIGNIA}", $mp_estadisticas_personal[0]->iconoinsignia, $PRINCIPAL);
    $PRINCIPAL                = str_replace("{BCICOINS}", $mp_estadisticas_personal[0]->bcicoins, $PRINCIPAL);
    return ($PRINCIPAL);
}
function MP_estadisticas_personalesv2($PRINCIPAL, $rut, $id_empresa)
{
    //echo "Rod 20231 $rut, $id_empresa";
    $ArregloEstadisticaMF = ComMp_BuscaNumTipo($rut, $id_empresa, "MISFAVORITAS");
    $ArregloEstadisticaCC = ComMp_BuscaNumTipo($rut, $id_empresa, "COMPARTIDASCONMIGO");
    $num_mf               = count($ArregloEstadisticaMF);
    $num_cc               = count($ArregloEstadisticaCC);
    $PRINCIPAL            = str_replace("{MP_COMPARTIDA_CONMIGO2}", $num_cc, $PRINCIPAL);
    $PRINCIPAL            = str_replace("{MP_MIS_FAVORITAS2}", $num_mf, $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocarDatosHomeBeFenCompetencias($PRINCIPAL, $rut, $id_empresa, $id_malla, $nivel, $mod, $template_comp)
{
    $id_malla_enc    = Encodear3($id_malla);
    //echo "<br>_ $rut, $id_empresa, malla $id_malla, <br>";
    $datos_curso     = TotalcursosPorUsuaroEmpresa($rut, $id_empresa, $id_malla);
    //print_r($datos_curso);
    $total_aprobados = 0;
    $datos_nivel     = TotalNivelPorUsuaroEmpresa($rut, $id_empresa, $id_malla);
    //print_r($datos_nivel);
    if ($nivel <> '') {
        $nivel = $nivel;
    } else {
        $id_nivel = $datos_nivel[0]->id_nivel;
        $nivel    = $datos_nivel[0]->idorden + 1;
        $mod      = 0;
    }
    $minivel           = $nivel;
    //echo "<br>minivel $minivelnivel $nivel, mod $mod, id nivel $id_nivel";
    //$cursosaprobados=buscacursosaprobadospornivel($nivel, $rut, $id_empresa, $id_malla);
    $nivelFinalizados  = NivelesFinalizados($rut, $id_empresa, $id_malla);
    $nivel_actual      = $nivelFinalizados[0]->cuenta + 1;
    $nivel_actual_real = $nivelFinalizados[0]->cuenta + 1;
    if ($template_comp == "Fn") {
        $nivel_actual = $minivel;
        $imagen_fondo = $buscaNivelRol[0]->imagenbackhome;
    }
    //echo "<br>imagen_fondo $imagen_fondo";
    $buscaNivelRol             = buscaNivelRol($rut, $id_empresa, $id_malla, $nivel_actual);
    //print_r($buscaNivelRol);
    $nivelPersonal             = $buscaNivelRol[0]->nivelnombre;
    $rolPersonal               = $buscaNivelRol[0]->descripcionRol;
    $id_curso_activo           = $buscaNivelRol[0]->idcurso_actual;
    $template_detalle_cursoCap = $buscaNivelRol[0]->template_detalle_cursoCap;
    $menu_activo               = $buscaNivelRol[0]->menuactivo;
    $nivel_activo              = $buscaNivelRol[0]->nivelactivo;
    $curso_activo              = $buscaNivelRol[0]->cursoactivo;
    if ($template_comp == "Fn") {
        $tipo_boton          = "nivelactivo";
        //echo "<br><br>nivelactivo<br>";
        //print_r($nivel_activo);
        $nivel_activos_array = explode(",", $nivel_activo);
        $acciontboton        = BuscaNivelAccionBoton($id_empresa, $nivel_activos_array[0], $tipo_boton);
        $CUADROnivel1        = utf8_encode($acciontboton[0]->boton);
        $acciontboton        = BuscaNivelAccionBoton($id_empresa, $nivel_activos_array[1], $tipo_boton);
        $CUADROnivel2        = utf8_encode($acciontboton[0]->boton);
        $acciontboton        = BuscaNivelAccionBoton($id_empresa, $nivel_activos_array[2], $tipo_boton);
        $CUADROnivel3        = utf8_encode($acciontboton[0]->boton);
        $acciontboton        = BuscaNivelAccionBoton($id_empresa, $nivel_activos_array[3], $tipo_boton);
        $CUADROnivel4        = utf8_encode($acciontboton[0]->boton);
    }
    // Imagen de fondo
    if ($template_comp == "") {
        $imagen_fondo         = $buscaNivelRol[0]->imagenbackhome;
        //echo "<br> For Each Menu<br>";
        $tipo_boton           = "menuactivo";
        //echo "<br><br>menuactivo<br>";
        //print_r($menu_activo);
        $menues_activos_array = explode(",", $menu_activo);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $menues_activos_array[0], $tipo_boton);
        $CUADRO1m             = utf8_encode($acciontboton[0]->boton);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $menues_activos_array[1], $tipo_boton);
        $CUADRO2m             = utf8_encode($acciontboton[0]->boton);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $menues_activos_array[2], $tipo_boton);
        $CUADRO3m             = utf8_encode($acciontboton[0]->boton);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $menues_activos_array[3], $tipo_boton);
        $CUADRO4m             = utf8_encode($acciontboton[0]->boton);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $menues_activos_array[4], $tipo_boton);
        $CUADROhm             = utf8_encode($acciontboton[0]->boton);
        //echo "<br> For Each Link Activo<br>";
        $tipo_boton           = "nivelactivo";
        //echo "<br><br>nivelactivo<br>";
        //print_r($nivel_activo);
        $nivel_activos_array  = explode(",", $nivel_activo);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $nivel_activos_array[0], $tipo_boton);
        $CUADROnivel1         = utf8_encode($acciontboton[0]->boton);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $nivel_activos_array[1], $tipo_boton);
        $CUADROnivel2         = utf8_encode($acciontboton[0]->boton);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $nivel_activos_array[2], $tipo_boton);
        $CUADROnivel3         = utf8_encode($acciontboton[0]->boton);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $nivel_activos_array[3], $tipo_boton);
        $CUADROnivel4         = utf8_encode($acciontboton[0]->boton);
    } else {
        $imagen_fondo = $buscaNivelRol[0]->imagenbackhometemplate;
        if ($imagen_fondo == "") {
            $imagen_fondo = $buscaNivelRol[0]->imagenbackhome;
        }
        $tipo_boton           = "menuactivo";
        //echo "<br><br>menuactivo<br>";
        //print_r($menu_activo);
        $menues_activos_array = explode(",", $menu_activo);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $menues_activos_array[0], $tipo_boton);
        //$CUADRO1m=utf8_encode($acciontboton[0]->boton);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $menues_activos_array[1], $tipo_boton);
        //$CUADRO2m=utf8_encode($acciontboton[0]->boton);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $menues_activos_array[2], $tipo_boton);
        //$CUADRO3m=utf8_encode($acciontboton[0]->boton);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $menues_activos_array[3], $tipo_boton);
        //$CUADRO4m=utf8_encode($acciontboton[0]->boton);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $menues_activos_array[4], $tipo_boton);
        $CUADROhm             = utf8_encode($acciontboton[0]->boton);
        $tipo_boton           = "cursoactivo";
        //echo "<br><br>cursoactivo<br>";
        //print_r($curso_activo);
        $curso_activos_array  = explode(",", $curso_activo);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $curso_activos_array[0], $tipo_boton);
        $CUADROcurso1         = utf8_encode($acciontboton[0]->boton);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $curso_activos_array[1], $tipo_boton);
        $CUADROcurso2         = utf8_encode($acciontboton[0]->boton);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $curso_activos_array[2], $tipo_boton);
        $CUADROcurso3         = utf8_encode($acciontboton[0]->boton);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $curso_activos_array[3], $tipo_boton);
        $CUADROcurso4         = utf8_encode($acciontboton[0]->boton);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $curso_activos_array[4], $tipo_boton);
        $CUADROcurso5         = utf8_encode($acciontboton[0]->boton);
    }
    //echo "<br>CUADROcurso1 ".$CUADROcurso1;
    //echo "<br>".$CUADROnivel2;
    //echo " <br>imagen_fondo $imagen_fondo";
    //echo "<br>Reemplazo cuadro1m ".$menues_activos_array[0];
    $PRINCIPAL       = str_replace("{IMAGEN_FONDO}", $imagen_fondo, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{CUADRO1m}", $CUADRO1m, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{CUADRO2m}", $CUADRO2m, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{CUADRO3m}", $CUADRO3m, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{CUADRO4m}", $CUADRO4m, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{CUADROhm}", $CUADROhm, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{CUADROnivel1}", $CUADROnivel1, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{CUADROnivel2}", $CUADROnivel2, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{CUADROnivel3}", $CUADROnivel3, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{CUADROnivel4}", $CUADROnivel4, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadro21a_ref}", $cuadro21a_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadro22a_ref}", $cuadro22a_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadro23a_ref}", $cuadro23a_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadro24a_ref}", $cuadro24a_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadro25a_ref}", $cuadro25a_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadro21b_ref}", $cuadro21b_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadro23b_ref}", $cuadro23b_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadro24b_ref}", $cuadro24b_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadro25b_ref}", $cuadro25b_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{CUADROcurso1}", $CUADROcurso1, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{CUADROcurso2}", $CUADROcurso2, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{CUADROcurso3}", $CUADROcurso3, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{CUADROcurso4}", $CUADROcurso4, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{CUADROcurso5}", $CUADROcurso5, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadroNivAG_ref}", $cuadroNivAG_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadroNivGMM_ref}", $cuadroNivGMM_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadroNivEJ_ref}", $cuadroNivEJ_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadroNivAD_ref}", $cuadroNivAD_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadro1mFN_ref}", $cuadro1mFN_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadro2mFN_ref}", $cuadro2mFN_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadro3mFN_ref}", $cuadro3mFN_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadrohmFN_ref}", $cuadrohmFN_ref, $PRINCIPAL);
    $PuntosYDesafios = buscapuntosydesafiospormallarut($rut, $id_empresa, $id_malla);
    //print_r($PuntosYDesafios[0]->puntosganados);
    //echo "16370";
    if ($PuntosYDesafios[0]->puntosganados > 0) {
        $puntosganados = $PuntosYDesafios[0]->puntosganados;
    } else {
        $puntosganados = 0;
    }
    if ($PuntosYDesafios[0]->desafiosganados > 0) {
        $desafiosganados = $PuntosYDesafios[0]->desafiosganados;
    } else {
        $desafiosganados = 0;
    }
    //echo "nivel personal $nivelPersonal ,   rol Personal $rolPersonal, $puntosganados, $desafiosganados";
    $PRINCIPAL                       = str_replace("{PUNTOSGANADOS}", $puntosganados, $PRINCIPAL);
    $PRINCIPAL                       = str_replace("{DESAFIOSGANADOS}", $desafiosganados, $PRINCIPAL);
    $CursosFinalizados_CursosTotales = buscaCursosFinalizados_Totales($rut, $id_empresa, $id_malla);
    foreach ($CursosFinalizados_CursosTotales as $CursoFinalizado_Curso) {
        if ($CursoFinalizado_Curso->estado == 1) {
            $imagen_activo .= "<img src='img/bci_comp_globo_amarillo.png'>";
        } elseif ($CursoFinalizado_Curso->estado === '0') {
            //echo "chau";
            $imagen_activo .= "<img src='img/bci_comp_globo_reprobado.png'>";
        } elseif ($CursoFinalizado_Curso->estado == NULL) {
            //echo "hola1";
            $imagen_inactivo .= "<img src='img/bci_comp_globo_bn.png'>";
        } elseif ($CursoFinalizado_Curso->estado == "") {
            //echo "hola2";
            $imagen_inactivo .= "<img src='img/bci_comp_globo_bn.png'>";
        } else {
            $imagen_inactivo .= "<img src='img/bci_comp_globo_bn.png'>";
        }
    }
    //echo "hola";
    //print_r($CursosFinalizados_CursosTotales);
    $total_niveles_Malla = TotalNivelesMalla($id_empresa, $id_malla);
    $TotalObjetos        = BuscaTotalOBjetosCursosIdMalla($id_empresa, $id_malla, $rut);
    //print_r($TotalObjetos);
    $procentaje_avance   = round(100 * $TotalObjetos[0]->cuentafinalizados / $TotalObjetos[0]->cuentaobjetostotales);
    //echo "<br>";
    //echo "hola";
    //print_r($total_niveles_Malla);
    //echo "<br>";
    //echo "hola";
    $PRINCIPAL           = str_replace("{GLOBOS_ACTIVOS_AMARILLOS}", $imagen_activo, $PRINCIPAL);
    $PRINCIPAL           = str_replace("{GLOBOS_INACTIVOS}", $imagen_inactivo, $PRINCIPAL);
    $PRINCIPAL           = str_replace("{MI_ROL}", $rolPersonal, $PRINCIPAL);
    $PRINCIPAL           = str_replace("{MI_NIVEL}", $nivelPersonal, $PRINCIPAL);
    $PRINCIPAL           = str_replace("{TOTAL_NIVEL}", $total_niveles_Malla[0]->cuenta, $PRINCIPAL);
    $PRINCIPAL           = str_replace("{BARRA_DE_AVANCE}", $procentaje_avance, $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocarDatosHomeBciCompetencias($PRINCIPAL, $rut, $id_empresa, $id_malla, $nivel, $mod, $template_comp)
{
    $id_malla_enc    = Encodear3($id_malla);
    //    echo "<br>_ $rut, $id_empresa, malla $id_malla, <br>";
    $datos_curso     = TotalcursosPorUsuaroEmpresa($rut, $id_empresa, $id_malla);
    //print_r($datos_curso);
    $total_aprobados = 0;
    //$id_malla="bci_comp";
    $datos_nivel     = TotalNivelPorUsuaroEmpresa($rut, $id_empresa, $id_malla);
    //print_r($datos_nivel);
    if ($nivel <> '') {
        $nivel = $nivel;
    } else {
        $id_nivel = $datos_nivel[0]->id_nivel;
        $nivel    = $datos_nivel[0]->idorden + 1;
        $mod      = 0;
    }
    $minivel           = $nivel;
    //echo "<br>minivel $minivelnivel $nivel, mod $mod, id nivel $id_nivel";
    //verifica MOD
    $cursosaprobados   = buscacursosaprobadospornivel($nivel, $rut, $id_empresa, $id_malla);
    $nivelFinalizados  = NivelesFinalizados($rut, $id_empresa, $id_malla);
    $nivel_actual      = $nivelFinalizados[0]->cuenta + 1;
    $nivel_actual_real = $nivelFinalizados[0]->cuenta + 1;
    //echo "finalizados $nivelFinalizados actual $nivel_actual";
    if ($template_comp <> '') {
        if ($template_comp == 1) {
            //echo $id_malla;
            if ($id_malla == "bci_comp_gmm" or $id_malla == "bci_comp_ag") {
                if ($nivel_actual > 6) {
                    $nivel_actual = 6;
                } else {
                    $nivel_actual = $nivel_actual;
                }
            }
            if ($id_malla == "bci_comp_ad" or $id_malla == "bci_comp_ej") {
                if ($nivel_actual > 5) {
                    $nivel_actual = 5;
                } else {
                    $nivel_actual = $nivel_actual;
                }
            }
        }
        if ($id_malla == "bci_comp_gmm" or $id_malla == "bci_comp_ag") {
            if ($nivel_actual > 6) {
                $nivel_actual = 7;
            } else {
                $nivel_actual = $nivel_actual;
            }
        }
    }
    if ($id_malla == "bci_comp_ad" or $id_malla == "bci_comp_ej") {
        if ($nivel_actual_real == 6) {
            $nivel_actual = 7;
        } else {
            $nivel_actual = $nivel_actual;
        }
    }
    if ($id_malla == "bci_comp_ad" or $id_malla == "bci_comp_ej") {
        if ($nivel_actual_real == 7) {
            $nivel_actual = 8;
        } else {
            $nivel_actual = $nivel_actual;
        }
    }
    if ($template_comp == "Fn") {
        $nivel_actual = $minivel;
        $imagen_fondo = $buscaNivelRol[0]->imagenbackhome;
    }
    //echo "<br>nivel_actual $nivel_actual";
    $buscaNivelRol             = buscaNivelRol($rut, $id_empresa, $id_malla, $nivel_actual);
    //print_r($buscaNivelRol);
    $nivelPersonal             = $buscaNivelRol[0]->nivelnombre;
    $rolPersonal               = $buscaNivelRol[0]->descripcionRol;
    $id_curso_activo           = $buscaNivelRol[0]->idcurso_actual;
    $template_detalle_cursoCap = $buscaNivelRol[0]->template_detalle_cursoCap;
    $menu_activo               = $buscaNivelRol[0]->menuactivo;
    $nivel_activo              = $buscaNivelRol[0]->nivelactivo;
    $curso_activo              = $buscaNivelRol[0]->cursoactivo;
    if ($template_comp == "Fn") {
        $tipo_boton          = "nivelactivo";
        //echo "<br><br>nivelactivo<br>";
        //print_r($nivel_activo);
        $nivel_activos_array = explode(",", $nivel_activo);
        $acciontboton        = BuscaNivelAccionBoton($id_empresa, $nivel_activos_array[0], $tipo_boton);
        $CUADROnivel1        = utf8_encode($acciontboton[0]->boton);
        $acciontboton        = BuscaNivelAccionBoton($id_empresa, $nivel_activos_array[1], $tipo_boton);
        $CUADROnivel2        = utf8_encode($acciontboton[0]->boton);
        $acciontboton        = BuscaNivelAccionBoton($id_empresa, $nivel_activos_array[2], $tipo_boton);
        $CUADROnivel3        = utf8_encode($acciontboton[0]->boton);
        $acciontboton        = BuscaNivelAccionBoton($id_empresa, $nivel_activos_array[3], $tipo_boton);
        $CUADROnivel4        = utf8_encode($acciontboton[0]->boton);
    }
    // Imagen de fondo
    if ($template_comp == "") {
        $imagen_fondo         = $buscaNivelRol[0]->imagenbackhome;
        //echo "<br> For Each Menu<br>";
        $tipo_boton           = "menuactivo";
        //echo "<br><br>menuactivo<br>";
        //print_r($menu_activo);
        $menues_activos_array = explode(",", $menu_activo);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $menues_activos_array[0], $tipo_boton);
        $CUADRO1m             = utf8_encode($acciontboton[0]->boton);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $menues_activos_array[1], $tipo_boton);
        $CUADRO2m             = utf8_encode($acciontboton[0]->boton);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $menues_activos_array[2], $tipo_boton);
        $CUADRO3m             = utf8_encode($acciontboton[0]->boton);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $menues_activos_array[3], $tipo_boton);
        $CUADRO4m             = utf8_encode($acciontboton[0]->boton);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $menues_activos_array[4], $tipo_boton);
        $CUADROhm             = utf8_encode($acciontboton[0]->boton);
        //echo "<br> For Each Link Activo<br>";
        $tipo_boton           = "nivelactivo";
        //echo "<br><br>nivelactivo<br>";
        //print_r($nivel_activo);
        $nivel_activos_array  = explode(",", $nivel_activo);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $nivel_activos_array[0], $tipo_boton);
        $CUADROnivel1         = utf8_encode($acciontboton[0]->boton);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $nivel_activos_array[1], $tipo_boton);
        $CUADROnivel2         = utf8_encode($acciontboton[0]->boton);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $nivel_activos_array[2], $tipo_boton);
        $CUADROnivel3         = utf8_encode($acciontboton[0]->boton);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $nivel_activos_array[3], $tipo_boton);
        $CUADROnivel4         = utf8_encode($acciontboton[0]->boton);
    } else {
        $imagen_fondo = $buscaNivelRol[0]->imagenbackhometemplate;
        if ($imagen_fondo == "") {
            $imagen_fondo = $buscaNivelRol[0]->imagenbackhome;
        }
        $tipo_boton           = "menuactivo";
        //echo "<br><br>menuactivo<br>";
        //print_r($menu_activo);
        $menues_activos_array = explode(",", $menu_activo);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $menues_activos_array[0], $tipo_boton);
        //$CUADRO1m=utf8_encode($acciontboton[0]->boton);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $menues_activos_array[1], $tipo_boton);
        //$CUADRO2m=utf8_encode($acciontboton[0]->boton);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $menues_activos_array[2], $tipo_boton);
        //$CUADRO3m=utf8_encode($acciontboton[0]->boton);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $menues_activos_array[3], $tipo_boton);
        //$CUADRO4m=utf8_encode($acciontboton[0]->boton);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $menues_activos_array[4], $tipo_boton);
        $CUADROhm             = utf8_encode($acciontboton[0]->boton);
        $tipo_boton           = "cursoactivo";
        //echo "<br><br>cursoactivo<br>";
        //print_r($curso_activo);
        $curso_activos_array  = explode(",", $curso_activo);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $curso_activos_array[0], $tipo_boton);
        $CUADROcurso1         = utf8_encode($acciontboton[0]->boton);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $curso_activos_array[1], $tipo_boton);
        $CUADROcurso2         = utf8_encode($acciontboton[0]->boton);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $curso_activos_array[2], $tipo_boton);
        $CUADROcurso3         = utf8_encode($acciontboton[0]->boton);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $curso_activos_array[3], $tipo_boton);
        $CUADROcurso4         = utf8_encode($acciontboton[0]->boton);
        $acciontboton         = BuscaNivelAccionBoton($id_empresa, $curso_activos_array[4], $tipo_boton);
        $CUADROcurso5         = utf8_encode($acciontboton[0]->boton);
    }
    //echo "<br>CUADROcurso1 ".$CUADROcurso1;
    //echo "<br>".$CUADROnivel2;
    //echo " <br>imagen_fondo $imagen_fondo";
    //echo "<br>Reemplazo cuadro1m ".$menues_activos_array[0];
    $PRINCIPAL       = str_replace("{IMAGEN_FONDO}", $imagen_fondo, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{CUADRO1m}", $CUADRO1m, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{CUADRO2m}", $CUADRO2m, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{CUADRO3m}", $CUADRO3m, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{CUADRO4m}", $CUADRO4m, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{CUADROhm}", $CUADROhm, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{CUADROnivel1}", $CUADROnivel1, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{CUADROnivel2}", $CUADROnivel2, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{CUADROnivel3}", $CUADROnivel3, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{CUADROnivel4}", $CUADROnivel4, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadro21a_ref}", $cuadro21a_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadro22a_ref}", $cuadro22a_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadro23a_ref}", $cuadro23a_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadro24a_ref}", $cuadro24a_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadro25a_ref}", $cuadro25a_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadro21b_ref}", $cuadro21b_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadro23b_ref}", $cuadro23b_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadro24b_ref}", $cuadro24b_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadro25b_ref}", $cuadro25b_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{CUADROcurso1}", $CUADROcurso1, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{CUADROcurso2}", $CUADROcurso2, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{CUADROcurso3}", $CUADROcurso3, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{CUADROcurso4}", $CUADROcurso4, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{CUADROcurso5}", $CUADROcurso5, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadroNivAG_ref}", $cuadroNivAG_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadroNivGMM_ref}", $cuadroNivGMM_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadroNivEJ_ref}", $cuadroNivEJ_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadroNivAD_ref}", $cuadroNivAD_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadro1mFN_ref}", $cuadro1mFN_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadro2mFN_ref}", $cuadro2mFN_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadro3mFN_ref}", $cuadro3mFN_ref, $PRINCIPAL);
    $PRINCIPAL       = str_replace("{cuadrohmFN_ref}", $cuadrohmFN_ref, $PRINCIPAL);
    $PuntosYDesafios = buscapuntosydesafiospormallarut($rut, $id_empresa, $id_malla);
    //print_r($PuntosYDesafios[0]->puntosganados);
    //echo "16370";
    if ($PuntosYDesafios[0]->puntosganados > 0) {
        $puntosganados = $PuntosYDesafios[0]->puntosganados;
    } else {
        $puntosganados = 0;
    }
    if ($PuntosYDesafios[0]->desafiosganados > 0) {
        $desafiosganados = $PuntosYDesafios[0]->desafiosganados;
    } else {
        $desafiosganados = 0;
    }
    //echo "nivel personal $nivelPersonal ,   rol Personal $rolPersonal";
    $PRINCIPAL                       = str_replace("{PUNTOSGANADOS}", $puntosganados, $PRINCIPAL);
    $PRINCIPAL                       = str_replace("{DESAFIOSGANADOS}", $desafiosganados, $PRINCIPAL);
    $CursosFinalizados_CursosTotales = buscaCursosFinalizados_Totales($rut, $id_empresa, $id_malla);
    //print_r($CursosFinalizados_CursosTotales);
    foreach ($CursosFinalizados_CursosTotales as $CursoFinalizado_Curso) {
        if ($CursoFinalizado_Curso->estado == 1) {
            $imagen_activo .= "<img src='img/bci_comp_globo_amarillo.png'>";
        } elseif ($CursoFinalizado_Curso->estado === '0') {
            //echo "chau";
            $imagen_activo .= "<img src='img/bci_comp_globo_reprobado.png'>";
        } elseif ($CursoFinalizado_Curso->estado == NULL) {
            //echo "hola1";
            $imagen_inactivo .= "<img src='img/bci_comp_globo_bn.png'>";
        } elseif ($CursoFinalizado_Curso->estado == "") {
            //echo "hola2";
            $imagen_inactivo .= "<img src='img/bci_comp_globo_bn.png'>";
        } else {
            $imagen_inactivo .= "<img src='img/bci_comp_globo_bn.png'>";
        }
    }
    $PRINCIPAL = str_replace("{GLOBOS_ACTIVOS_AMARILLOS}", $imagen_activo, $PRINCIPAL);
    $PRINCIPAL = str_replace("{GLOBOS_INACTIVOS}", $imagen_inactivo, $PRINCIPAL);
    $PRINCIPAL = str_replace("{MI_ROL}", $rolPersonal, $PRINCIPAL);
    $PRINCIPAL = str_replace("{MI_NIVEL}", $nivelPersonal, $PRINCIPAL);
    return ($PRINCIPAL);
}
function MuestraFormulario($id_categoria, $id_empresa, $rut)
{
    $datos_formulario = FormularioDadoIdCategoria($id_categoria, $id_empresa);
    $html             = file_get_contents("views/formularios/" . $datos_formulario[0]->template);
    $html             = str_replace("{TITULO1}", utf8_encode($datos_formulario[0]->nombre), $html);
    //$html = str_replace("{OPTIONS_CATEGORIAS_VALOR}",OptionsGenericoNombreDadoValoresPorEmpresa("tbl_salonfama_valores", "",  "nombre", "id", "order by nombre asc", $id_empresa),$html);
    $html             = str_replace("{OPTIONS_CATEGORIAS_VALOR}", OptionsCategoriasValoresFormularios($id_categoria, $id_empresa), $html);
    $html             = str_replace("{CASE}", $datos_formulario[0]->case, $html);
    $html             = str_replace("{ID_TIPO}", Encodear3($id_categoria), $html);
    $html             = str_replace("{RUT_BUENASPRACTICAS}", $rut, $html);
    return ($html);
}
function BloqueListadoConectate($html, $id_empresa, $id_categoria)
{
    $rut          = $_SESSION["user_"];
    //Traigo el listado publicados, dado
    //$datos=TraeListadoClasicos($id_empresa, "", "order by antiguedad desc");
    $datos        = TotalReconocimientosPorCategoria($id_categoria, $id_empresa);
    $html         = str_replace("{TITULO1}", utf8_encode($datos[0]->titulo_pagina), $html);
    $html         = str_replace("{ID_CATEGORIA_ENCODEADO}", Encodear3($id_categoria), $html);
    $html         = str_replace("{IMAGEN_FORM}", $datos[0]->imagen_form, $html);
    $html         = str_replace("{IMAGEN_FORM}", $datos[0]->imagen_form, $html);
    $html         = str_replace("{IMAGEN_INICIO_PAGINA}", $datos[0]->imagen_inicio_pagina, $html);
    $template_row = $datos[0]->template_row;
    $subtitulo    = "";
    //echo round($datos[0]->antiguedad/5);
    $subtitulo    = "";
    foreach ($datos as $unico) {
        if ($subtitulo <> $unico->nombre_valor) {
            $row .= file_get_contents("views/reconocimiento/subtitulo.html");
            $row       = str_replace("{TITULO}", $unico->nombre_valor, $row);
            $subtitulo = $unico->nombre_valor;
        } else {
            $subtitulo = $unico->nombre_valor;
        }
        $row .= file_get_contents("views/" . $template_row);
        $row = str_replace("{NOMBRE}", $unico->nombre . " " . $unico->apaterno . " " . $unico->amaterno, $row);
        $row = str_replace("{ANOS}", $unico->antiguedad, $row);
        $row = str_replace("{CARGO}", $unico->cargo, $row);
        $row = str_replace("{URL_PERSONA}", VerificaFotoPersonal($unico->rut), $row);
        $row = str_replace("{RUT_ENCODEADO}", Encodear3($unico->rut), $row);
        $row = str_replace("{VALOR_SITUACION}", ($unico->situacion), $row);
        $row = str_replace("{VALOR_ACCION}", ($unico->accion), $row);
        $row = str_replace("{VALOR_IMPACTO}", ($unico->impacto), $row);
        $row = str_replace("{FECHAPUBLICACION}", ($unico->fecha), $row);
        $row = str_replace("{VALOR_CONDUCTA}", ($unico->nombre_conducta_valor), $row);
        //$row = str_replace("{MEGUSTA}",file_get_contents("views/megusta/bloque_comentario_megusta.html"),$row);
        //$row = str_replace("{ID_CONTENIDO}",$unico->id,$row);
        $row = str_replace("{MEGUSTA}", ColocaMeGusta($unico->id, "id_salonfama_publicados", $id_empresa, $rut), $row);
        /*$tiene_megusta=VerCantidadMeGustaPorObjetoYUsuario($unico->id, "id_salonfama_publicados", $id_empresa, $rut);
        if($tiene_megusta){
        $row = str_replace("{MEGUSTA}",file_get_contents("views/megusta/bloque_comentario_yamegusta.html"),$row);
        $cantidad_megusta=VerCantidadMeGustaPorObjeto($unico->id, "id_salonfama_publicados", $id_empresa);
        $row = str_replace("{CANTIDAD_MEGUSTA}",count($cantidad_megusta),$row);
        }else{
        $row = str_replace("{MEGUSTA}",file_get_contents("views/megusta/bloque_comentario_megusta.html"),$row);
        $row = str_replace("{ID_CONTENIDO}",($unico->id),$row);
        $row = str_replace("{TIPO_OBJETO_MEGUSTA}","id_salonfama_publicados",$row);
        }
        */
    }
    $html = str_replace("{BLOQUE_LISTADO_CLASICOS}", utf8_Encode($row), $html);
    return ($html);
}
function BloqueListadoClasicos($html, $id_empresa)
{
    //Traigo el listado de usuarios para ver en Clasicos
    $datos       = TraeListadoClasicos($id_empresa, "", "order by antiguedad desc");
    $subtitulo   = "";
    //echo round($datos[0]->antiguedad/5);
    $valor_mayor = (round($datos[0]->antiguedad / 10) * 10);
    $valor_menor = $valor_mayor - 10;
    $row .= file_get_contents("views/clasicos/subtitulo.html");
    //$row = str_replace("{IMG_SUBTITULO}","clasicos_golden.jpg",$row);
    //echo "<br>";
    $row = str_replace("{NUMERO}", $valor_menor . " a " . $valor_mayor, $row);
    $j   = 0;
    foreach ($datos as $unico) {
        if ($unico->antiguedad >= $valor_menor && $unico->antiguedad < $valor_mayor) {
            //$valor_mayor=(round($unico->antiguedad/5)*5);
            //$valor_menor=$valor_mayor-5;
        } else {
            //echo $valor_menor;
            //echo "<br>";
            $row .= file_get_contents("views/clasicos/subtitulo.html");
            $valor_mayor = (round($unico->antiguedad / 10) * 10);
            $valor_menor = $valor_mayor - 10;
            if ($valor_menor == 20) {
                $row = str_replace("{IMG_SUBTITULO}", "clasicos_silver.jpg", $row);
            } elseif ($valor_menor == 10) {
                $row = str_replace("{IMG_SUBTITULO}", "clasicos_bronce.jpg", $row);
            }
            if ($valor_menor == 0)
                break;
            $row = str_replace("{NUMERO}", $valor_menor . " a " . $valor_mayor, $row);
        }
        if ($valor_menor == 30) {
            $row .= file_get_contents("views/clasicos/row_golden.html");
        } else if ($valor_menor == 20) {
            $row .= file_get_contents("views/clasicos/row_silver.html");
        } else if ($valor_menor == 10) {
            $row .= file_get_contents("views/clasicos/row_bronce.html");
        }
        $j++;
        if ($j == 2) {
            $row .= '<div class="row"></div>';
            $j = 0;
        }
        $row = str_replace("{NOMBRE}", $unico->nombre_persona . " " . $unico->apaterno . " " . $unico->amaterno, $row);
        $row = str_replace("{ANOS}", $unico->antiguedad, $row);
        $row = str_replace("{CARGO}", $unico->cargo, $row);
        $row = str_replace("{URL_PERSONA}", VerificaFotoPersonal($unico->rut), $row);
        $row = str_replace("{RUT_ENCODEADO}", Encodear3($unico->rut), $row);
    }
    $html = str_replace("{BLOQUE_LISTADO_CLASICOS}", utf8_Encode($row), $html);
    return ($html);
}
function BloqueClasicos($html, $id_empresa, $cantidad_registros)
{
    //Dada la empresa, traigo a todos los que estan en la tabla de salon de la fama
    $bloque = file_get_contents("views/salondelafama/bloquesalonfama.html");
    //Primero por traigo las categorias por la empresa
    if ($_SESSION["id_empresa"] == 22) {
        $row = file_get_contents("views/salondelafama/22_row_bloquesalonfama.html");
    } else {
        $row = file_get_contents("views/salondelafama/row_bloquesalonfama.html");
    }
    $row    = str_replace("{NOMBRE_CATEGORIA}", "Clasicos", $row);
    $row    = str_replace("{LOGO_CATEGORIA}", "logo_clasico.png", $row);
    $row    = str_replace("{DESCRIPCION_CATEGORIA}", $unico->descripcion, $row);
    //Por la categoria traigo la cantidad X de ganadores
    $row    = str_replace("{NOMBRE_PERSONAS}", $datos[0]->nombre_persona . " " . $datos[0]->apaterno . " " . $datos[0]->amaterno, $row);
    $row    = str_replace("{CARGO_PERSONAS}", $datos[0]->cargo, $row);
    $row    = str_replace("{URL_PERSONA}", VerificaFotoPersonal($datos[0]->rut), $row);
    $row    = str_replace("{RUT_ENCODEADO}", Encodear3($datos[0]->rut), $row);
    $row    = str_replace("{TEXTO1}", $datos[0]->texto1, $row);
    $row    = str_replace("{TEXTO2}", $datos[0]->texto2, $row);
    $row    = str_replace("{TEXTO3}", $datos[0]->texto3, $row);
    $row    = str_replace("{TEXTO4}", $datos[0]->texto4, $row);
    $row    = str_replace("{TEXTO5}", $datos[0]->texto5, $row);
    //$row=file_get_contents("views/salondelafama/bloquesalonfama.html");
    $bloque = str_replace("{LISTADO_SALON_FAMA}", utf8_encode($row), $bloque);
    $html   = str_replace("{BLOQUE_CLASICOS}", $bloque, $html);
    return ($html);
}
function ObtenerAnosDadoFecha($fecha)
{
    $dias = explode("-", $fecha, 3);
    $dias = mktime(0, 0, 0, $dias[1], $dias[0], $dias[2]);
    $edad = (int) ((time() - $dias) / 31556926);
    return $edad;
}
function BloqueBanners($html, $id_empresa)
{
    //Traigo los banner por empresa
    $total_banners = BannersPorEmpresa($id_empresa);
    if ($total_banners) {
        $html_banners = "";
        foreach ($total_banners as $banner) {
            if ($banner->icono) {
                $html_banners .= file_get_contents("views/banners/imagentexto_conicono.html");
                $html_banners = str_replace("{ICONO}", $banner->icono, $html_banners);
            } else {
                $html_banners .= file_get_contents("views/banners/" . $banner->template);
            }
            $html_banners = str_replace("{TEXTO}", utf8_encode($banner->texto), $html_banners);
            $html_banners = str_replace("{IMAGEN_IZQUIERDA}", $banner->imagen_izquierda, $html_banners);
        }
        $html = str_replace("{SECCION_BANNERS}", ($html_banners), $html);
    } else {
        $html = str_replace("{SECCION_BANNERS}", "", $html);
    }
    return ($html);
}
function ArmaBloqueComentariosPorEmpresa($PRINCIPAL, $id_empresa, $rut, $id_categoria, $id_comentario)
{
    //echo "$id_categoria $id_comentario";
    $categorias = CategoriasComentariosPorEmpresa($id_empresa);
    foreach ($categorias as $cat) {
        if ($id_categoria == $cat->id) {
            $formulario .= file_get_contents("views/comentarios/formulario_edicion.html");
            $datos_comentario = DatosComentarioPorId($id_comentario);
            $formulario       = str_replace("{COMENTARIO}", $datos_comentario[0]->comentario, $formulario);
            $formulario       = str_replace("{ID_COMENTARIO_ENCODEADO}", $id_comentario, $formulario);
        } else {
            $formulario .= file_get_contents("views/comentarios/formulario.html");
        }
        $formulario      = str_replace("{DESCRIPCION}", $cat->descripcion, $formulario);
        $formulario      = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($rut), $formulario);
        $comentarios     = ComentariosPorCategoria($cat->id);
        $html_comentario = "";
        if ($comentarios) {
            foreach ($comentarios as $comen) {
                $html_comentario .= file_get_contents("views/comentarios/row_comentario.html");
                $html_comentario = str_replace("{COMENTARIO}", $comen->comentario, $html_comentario);
                $html_comentario = str_replace("{FECHA}", FechaTipoSpa($comen->fecha), $html_comentario);
                $html_comentario = str_replace("{ID_COMENTARIO_ENCODEADO}", Encodear3($comen->id), $html_comentario);
            }
            $formulario = str_replace("{BLOQUE_COMENTARIOS_INGRESADOS}", $html_comentario, $formulario);
        } else {
            $formulario = str_replace("{BLOQUE_COMENTARIOS_INGRESADOS}", "", $formulario);
        }
        $formulario = str_replace("{ID_CATEGORIA_COMENTARIO_ENCODEADO}", Encodear3($cat->id), $formulario);
    }
    //Veo si tiene comentarios
    $PRINCIPAL = str_replace("{ENTORNO_COMENTARIOS}", utf8_encode($formulario), $PRINCIPAL);
    return ($PRINCIPAL);
}
function EvaluadoParaEstaPregunta($id_componente, $id_pregunta, $evaluado, $id_perfil)
{
    //$preguntas_por_encuesta=PreguntasPorCompetenciaPorPerfilEval($id_perfil);
    $preguntas_por_encuesta = PreguntasPorCompetenciaPorPerfilEvalParaValidar($id_perfil);
    $muestra                = "no";
    foreach ($preguntas_por_encuesta as $unico) {
        if ($unico->id == $id_pregunta) {
            $muestra = "si";
            continue;
        }
    }
    return ($muestra);
}
function ListadoIngresoBitacoras($evaluado, $evaluador, $id_bitacora, $tipo, $sgd_version)
{
    if ($_SESSION["id_empresa"] == 28) {
        $tiene_bitacora = TraeDatosPorBitacoraPorCompetencia($evaluado);
    } else {
        $tiene_bitacora = TraeDatosPorBitacora($evaluado);
    }
    if ($tiene_bitacora) {
        foreach ($tiene_bitacora as $dato) {
            if ($dato->id == $id_bitacora) {
                if ($sgd_version == 2) {
                    $template .= file_get_contents("views/sgd/bitacora/row_bitacora_edicion_chilquinta.html");
                } else {
                    $template .= file_get_contents("views/sgd/bitacora/row_bitacora_edicion.html");
                }
                $template = str_replace("{OPTIONS_VALORES}", OptionsGenericoNombreDadoValoresPorEmpresa("tbl_bitacora_valores", $dato->valor, "valor", "id", "order by valor asc", $_SESSION["id_empresa"]), $template);
                if ($dato->realizado == "si") {
                    $template = str_replace("{CHECKEDREALIZADOSI}", "checked", $template);
                    $template = str_replace("{CHECKEDREALIZADONO}", "", $template);
                    $template = str_replace("{STYLE_DISPLAY}", 'style="display: none"', $template);
                } else if ($dato->realizado == "no") {
                    $template = str_replace("{CHECKEDREALIZADONO}", "checked", $template);
                    $template = str_replace("{CHECKEDREALIZADOSI}", "", $template);
                } else {
                    $template = str_replace("{CHECKEDREALIZADONO}", "", $template);
                    $template = str_replace("{CHECKEDREALIZADOSI}", "", $template);
                }
            } else {
                if ($sgd_version == 2) {
                    $template .= file_get_contents("views/sgd/bitacora/row_bitacora_lectura_chilquinta.html");
                    if ($evaluado == $evaluador) {
                        $template = str_replace("{BOTON_MODIFICAR}", file_get_contents("views/sgd/bitacora/boton_modifica.html"), $template);
                    } else {
                        $template = str_replace("{BOTON_MODIFICAR}", "", $template);
                    }
                } else {
                    $template .= file_get_contents("views/sgd/bitacora/row_bitacora_lectura.html");
                }
            }
            $template = str_replace("{VALOR}", utf8_encode($dato->nombre_valor), $template);
            $template = str_replace("{TEXTO_ST}", $dato->texto_st, $template);
            $template = str_replace("{AUTOR}", utf8_encode($dato->nombre_completo), $template);
            $template = str_replace("{FECHA}", formatearFechaCompleta($dato->fecha), $template);
            $template = str_replace("{TEXTO_A}", $dato->texto_a, $template);
            $template = str_replace("{TEXTO_R}", $dato->texto_r, $template);
            if ($dato->realizado == "si") {
                $template = str_replace("{REALIZADO}", file_get_contents("views/sgd/bitacora/realizado_si.html"), $template);
                $template = str_replace("{LINEA_BLOQUE_NEGATIVO}", file_get_contents("views/sgd/bitacora/row_bitacora_lectura_bloque_positivo.html"), $template);
            } else {
                $template = str_replace("{REALIZADO}", file_get_contents("views/sgd/bitacora/realizado_no.html"), $template);
                $template = str_replace("{LINEA_BLOQUE_NEGATIVO}", file_get_contents("views/sgd/bitacora/row_bitacora_lectura_bloque_negativo.html"), $template);
            }
            //$template = str_replace("{REALIZADO}",$dato->realizado,$template);
            $template = str_replace("{TEXTO_AA}", $dato->texto_aa, $template);
            $template = str_replace("{TEXTO_AT}", $dato->texto_at, $template);
            $template = str_replace("{ID_BITACORA_ENCODEADA}", Encodear3($dato->id), $template);
            $template = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($evaluado), $template);
        }
    } else {
        $template = file_get_contents("views/sgd/bitacora/sin_objetivos.html");
    }
    return ($template);
}
function ListadoColaboradoresBitacora($html, $evaluador, $rut_evaluado, $id_bitacora, $sgd_version, $id_proceso)
{
    //$evaluados=EvaluadosDadoEvaluador($evaluador);
    //$evaluados=EvaluadosDadoEvaluadorParaBitacora($evaluador);
    $evaluados = EvaluadosDadoEvaluadorParaBitacoraPorProceso($evaluador, $id_proceso);
    //Se muestran los objetivos individuales.
    //if($_SESSION["id_empresa"]==28){
    if ($sgd_version == 2) {
        $total_html   = file_get_contents("views/sgd/bitacora/entorno_bloque_principal_chilquinta.html");
        $row_template = file_get_contents("views/sgd/bitacora/row_colaboradores_chilquinta.html");
        //$row_template=file_get_contents("views/sgd/bitacora/row_colaboradores.html");
    } else {
        $total_html   = file_get_contents("views/sgd/bitacora/entorno_bloque_principal.html");
        $row_template = file_get_contents("views/sgd/bitacora/row_colaboradores.html");
    }
    //Primero veo si es que hay registro en la tabla de sesion
    $row                           = "";
    $ok_finalizado                 = 0;
    $html                          = str_replace("{SECCION_EQUIPO_CONSOLIDADO}", file_get_contents("views/sgd/bitacora/vista_consolidada_equipo.html"), $html);
    $html                          = str_replace("{GRAFICO}", file_get_contents("views/sgd/graficos/graficoBarraBitacora.html"), $html);
    $total_positivas_por_evaluador = 0;
    $total_negativas_por_evaluador = 0;
    foreach ($evaluados as $evaluado) {
        $row .= $row_template;
        $objetivos_validados_por_validador = VerificaSiObjetivosEstanValidados($evaluado->evaluado);
        //$row=FormularioIngresaObjetivos($row, $evaluado->evaluado, $evaluador);
        $row                               = ColocaDatosUsuario($row, $evaluado->evaluado, "bitacora");
        //$valores_objetivos=ListadoObjetivosAValidar($evaluado->evaluado, $evaluador, $id_objetivo, "jefe");
        $valores_objetivos                 = ListadoIngresoBitacoras($evaluado->evaluado, $evaluador, $id_bitacora, "jefe", $sgd_version);
        $row                               = str_replace("{LISTADO_OBJETIVOS_A_EVALUAR}", $valores_objetivos, $row);
        $ponderaciones_bases               = DevuelvePonderacionesPorEvaluado($evaluado->evaluado);
        $verifica_evaluado_validado        = VerificaSiObjetivosEstanAjustados($evaluado->evaluado);
        if ($rut_evaluado == $evaluado->evaluado && !$id_bitacora) {
            if ($sgd_version == 2) {
                $row = str_replace("{FORMUARIO_BITACORA}", file_get_contents("views/sgd/bitacora/formulario_chilquinta.html"), $row);
                $row = str_replace("{OPTIONS_VALORES}", OptionsCompetenciasDadoPerfil($evaluado->perfil_evaluacion_competencias), $row);
            } else {
                $row = str_replace("{FORMUARIO_BITACORA}", file_get_contents("views/sgd/bitacora/formulario.html"), $row);
                $row = str_replace("{OPTIONS_VALORES}", OptionsGenericoNombreDadoValoresPorEmpresa("tbl_bitacora_valores", "", "valor", "id", "order by valor asc", $_SESSION["id_empresa"]), $row);
            }
        } else {
            $row = str_replace("{FORMUARIO_BITACORA}", "", $row);
        }
        $row                           = str_replace("{RUT_ENCODEADO}", Encodear3($evaluado->evaluado), $row);
        $row                           = str_replace("{RUT_EVALUADO}", ($evaluado->evaluado), $row);
        //Veo cuantas posotivas y cuantas negativas tiene
        $positivas                     = VerificaBitacorasPositivasNegativas($evaluado->evaluado, "si");
        $negativas                     = VerificaBitacorasPositivasNegativas($evaluado->evaluado, "no");
        $row                           = str_replace("{X_POSITIVAS}", count($positivas), $row);
        $row                           = str_replace("{X_NEGATIVAS}", count($negativas), $row);
        $total_positivas_por_evaluador = $total_positivas_por_evaluador + count($positivas);
        $total_negativas_por_evaluador = $total_negativas_por_evaluador + count($negativas);
        $row                           = str_replace("{CANTIDAD}", count($positivas) + count($negativas), $row);
        $row                           = str_replace("{BOTON_JEFE_VALIDA_OBJETIVOS}", "", $row);
        $row                           = str_replace("{TOTAL_SUMA_PONDERACION}", $valores_objetivos[1], $row);
        $row                           = str_replace("{PONDERACION_OBJETIVOS_INDIVIDUALES}", $ponderaciones_bases[2], $row);
        if ($valores_objetivos[1] == $ponderaciones_bases[2]) {
            $row = str_replace("{OK}", "OK", $row);
        } else {
            $row = str_replace("{OK}", "", $row);
        }
        $row = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($evaluado->evaluado), $row);
        if ($valores_objetivos[1] == $ponderaciones_bases[2]) {
            $ok_finalizado++;
        }
        //ACA veo si es que tiene comentarios de rechazo
        $comentarios           = ObtenerObjetivosDeRechazoUltimo($evaluado->evaluado);
        $comentarios_validador = "";
        foreach ($comentarios as $com) {
            $comentarios_validador .= $com->comentario . "<br>";
        }
        $row = str_replace("{COMENTARIOS_VALIDADOR}", $comentarios_validador, $row);
    }
    $total_total = ($total_negativas_por_evaluador + $total_positivas_por_evaluador);
    $html        = str_replace("{TOTAL_POSITIVAS}", ColocaDecimalesNotasFinales(0, ($total_positivas_por_evaluador * 100) / $total_total), $html);
    $html        = str_replace("{TOTAL_NEGATIVAS}", ColocaDecimalesNotasFinales(0, ($total_negativas_por_evaluador * 100) / $total_total), $html);
    $html        = str_replace("{TOTAL_POR_EVALUADOR}", $total_total, $html);
    $html        = str_replace("{TOTAL_EVALUADOR_POSITIVAS}", ($total_positivas_por_evaluador), $html);
    $html        = str_replace("{TOTAL_EVALUADOR_NEGATIVAS}", ($total_negativas_por_evaluador), $html);
    $total_html  = str_replace("{LISTADO_COLABORADORES}", ($row), $total_html);
    $html        = str_replace("{ENTORNO_LISTADO_EVALUACION}", ($total_html), $html);
    return ($html);
}
function ColocaBloqueMP3PorObjeto($id_objeto)
{
    //Veo si hay MP3 por Objeto
    $datos_objeto = DatosObjeto($id_objeto);
    $bloque_mp3   = "";
    if ($datos_objeto[0]->mp3) {
        $bloque_mp3 = file_get_contents("views/cursos/contenidos/entorno_bloque_mp3.html");
        $bloque_mp3 = str_replace("{URL_MP3}", $datos_objeto[0]->mp3, $bloque_mp3);
    }
    return ($bloque_mp3);
}
function ColocaBloqueComentariosPorObjeto($id_objeto, $rut, $pagina, $cantidad_por_pagina)
{
    //Veo si hay documentos por Objeto
    //$comentarios=ComentariosPorObjeto($id_objeto, $pagina, $cantidad_por_pagina);
    $comentarios        = ComentariosPorObjetoPaginado($id_objeto, $pagina, $cantidad_por_pagina);
    $bloque_comentarios = "";
    if ($comentarios) {
        $total = "";
        foreach ($comentarios as $unico) {
            $bloque_comentarios = file_get_contents("views/cursos/objetos/foro/bloque_comentario.html");
            $bloque_comentarios = str_replace("{URL_IMAGEN_PERSONA}", VerificaFotoPersonal($unico->rut), $bloque_comentarios);
            $bloque_comentarios = str_replace("{NOMBRE}", ($unico->nombre_persona), $bloque_comentarios);
            $bloque_comentarios = str_replace("{COMENTARIO}", ($unico->comentario), $bloque_comentarios);
            $bloque_comentarios = str_replace("{RUT_ENCODEADO_AUTOR_COMENTARIO}", Encodear3($unico->rut), $bloque_comentarios);
            $bloque_comentarios = str_replace("{FECHA}", FechaTipoSpa($unico->fecha . " " . $unico->hora), $bloque_comentarios);
            $tiene_megusta      = MegustaPorComentarioRut($unico->id, $rut);
            if ($unico->rut == $rut) {
                $bloque_comentarios = str_replace("{BLOQUE_MEGUSTA}", file_get_contents("views/cursos/objetos/foro/bloque_comentario_micomentario.html"), $bloque_comentarios);
            } else {
                if ($tiene_megusta) {
                    $bloque_comentarios = str_replace("{BLOQUE_MEGUSTA}", file_get_contents("views/cursos/objetos/foro/bloque_comentario_yamegusta.html"), $bloque_comentarios);
                } else {
                    $bloque_comentarios = str_replace("{BLOQUE_MEGUSTA}", file_get_contents("views/cursos/objetos/foro/bloque_comentario_megusta.html"), $bloque_comentarios);
                }
            }
            $bloque_comentarios             = str_replace("{ID_COMENTARIO}", $unico->id, $bloque_comentarios);
            $bloque_comentarios             = str_replace("{ID_COMENTARIO_MEGUSTA}", $unico->id, $bloque_comentarios);
            //Verifico si este comentario ya tiene un me gusta, si ya tiene, le muestro un bloque de me gusta,
            //sino el bloque de Yamegusta
            //Veo cuantos ME GUSTA tiene este comentario
            $cantidad_megusta_porcomentario = MegustaPorComentario($unico->id);
            $bloque_comentarios             = str_replace("{XMEGUSTA}", count($cantidad_megusta_porcomentario), $bloque_comentarios);
            $total .= $bloque_comentarios;
        }
    } else {
    }
    return (utf8_encode($total));
}






function MuestraResultadosPreguntaPorObjetoCheck($id_objeto, $id_pregunta, $rut)
{
    $entorno .= file_get_contents("views/cursos/contenidos/entorno_preguntas_respuesta_lectura.html");
    //TRaigo todas las posibles respuestas por cada una de las preguntas
    $alternativas     = AlternativasDadoGupoIdPregunta($id_pregunta);
    $datos_pregunta   = DatosPreguntaObjetoDadoId($id_pregunta);
    //Traigo el total de respuestas dado el id de la pregunta, y el id del objeto
    $total_respuestas = ObtenerRespuestasPreguntaPorObjetoPRegunta($id_objeto, $id_pregunta);
    $contador_arreglo = 0;
    foreach ($alternativas as $unico) {
        //$template.=file_get_contents("views/cursos/contenidos/row_bloque_pregunta_respuesta_lectura.html");
        //$template = str_replace("{ALTERNATIVA}",$unico->alternativa,$template);
        //Por cada alternativa y pregunta, veo cuantas respuestas hay...
        $cantt_respuestas                                       = ObtenerRespuestasPreguntaPorObjetoYTipo($id_objeto, $id_pregunta, $unico->id);
        //$template = str_replace("{PORCENTAJE}",FormatearPorcentajesSinDecimal(($cantt_respuestas[0]->total*100)/$total_respuestas[0]->total),$template);
        $arreglo_alternativas[$contador_arreglo]["alternativa"] = $unico->alternativa;
        $arreglo_alternativas[$contador_arreglo]["valor"]       = FormatearPorcentajesSinDecimal(($cantt_respuestas[0]->total * 100) / $total_respuestas[0]->total);
        $contador_arreglo++;
    }
    foreach ($arreglo_alternativas as $key => $row) {
        $aux[$key] = $row['valor'];
    }
    array_multisort($aux, SORT_DESC, $arreglo_alternativas);
    for ($i = 0; $i < count($arreglo_alternativas); $i++) {
        $template .= file_get_contents("views/cursos/contenidos/row_bloque_pregunta_respuesta_lectura.html");
        $template = str_replace("{ALTERNATIVA}", $arreglo_alternativas[$i]["alternativa"], $template);
        $template = str_replace("{PORCENTAJE}", $arreglo_alternativas[$i]["valor"], $template);
    }
    $entorno = str_replace("{LISTADO_RESPUESTAS_ALTERNATIVAS}", $template, $entorno);
    $entorno = str_replace("{PREGUNTA}", utf8_encode($datos_pregunta[0]->pregunta), $entorno);
    return ($entorno);
}
function MuestraResultadosPreguntaPorObjeto($id_objeto, $id_pregunta, $rut)
{
    $template                    = file_get_contents("views/cursos/contenidos/entorno_bloque_pregunta_respuesta.html");
    $datos_pregunta              = DatosPreguntaObjetoDadoId($id_pregunta);
    $template                    = str_replace("{PREGUNTA}", utf8_encode($datos_pregunta[0]->pregunta), $template);
    //Obtengo datos
    $alternativa1                = ObtenerRespuestasPreguntaPorObjetoYTipo($id_objeto, $id_pregunta, 1);
    $alternativa2                = ObtenerRespuestasPreguntaPorObjetoYTipo($id_objeto, $id_pregunta, 2);
    $alternativa3                = ObtenerRespuestasPreguntaPorObjetoYTipo($id_objeto, $id_pregunta, 3);
    $total                       = $alternativa1[0]->total + $alternativa2[0]->total + $alternativa3[0]->total;
    $arreglo[0]["color"]         = "sessions_red.png";
    $arreglo[0]["nota"]          = FormatearPorcentajesSinDecimal(($alternativa1[0]->total * 100) / $total);
    $arreglo[0]["color_grafico"] = "danger";
    $arreglo[1]["color"]         = "sessions_yellow.png";
    $arreglo[1]["nota"]          = FormatearPorcentajesSinDecimal(($alternativa2[0]->total * 100) / $total);
    $arreglo[1]["color_grafico"] = "yellow";
    $arreglo[2]["color"]         = "sessions_green.png";
    $arreglo[2]["nota"]          = FormatearPorcentajesSinDecimal(($alternativa3[0]->total * 100) / $total);
    $arreglo[2]["color_grafico"] = "success";
    foreach ($arreglo as $key => $row) {
        $aux[$key] = $row['nota'];
    }
    array_multisort($aux, SORT_DESC, $arreglo);
    for ($i = 0; $i < 3; $i++) {
        $alternativas_rows .= file_get_contents("views/cursos/contenidos/row_respuesta_pregunta1.html");
        $alternativas_rows = str_replace("{IMAGEN}", $arreglo[$i]["color"], $alternativas_rows);
        $alternativas_rows = str_replace("{NOTA}", $arreglo[$i]["nota"], $alternativas_rows);
        $alternativas_rows = str_replace("{COLOR_GRAFICO}", $arreglo[$i]["color_grafico"], $alternativas_rows);
    }
    $template = str_replace("{RESPUESTAS_PREGUNTA1}", $alternativas_rows, $template);
    //$template = str_replace("{NOTAAMARILLO}",FormatearPorcentajesSinDecimal(($alternativa2[0]->total*100)/$total),$template);
    //$template = str_replace("{NOTAVERDE}",FormatearPorcentajesSinDecimal(($alternativa3[0]->total*100)/$total),$template);
    return ($template);
}
function MuestraResultadosPreguntaPorObjeto4($id_objeto, $id_pregunta, $rut)
{
    $template                    = file_get_contents("views/cursos/contenidos/entorno_bloque_pregunta_respuesta4.html");
    //$datos_pregunta=PreguntaEncuestaParaTNT();
    $datos_pregunta              = PreguntaEncuestaParaPorEmpresa($_SESSION["id_empresa"]);
    $template                    = str_replace("{PREGUNTA}", utf8_encode($datos_pregunta[0]->pregunta), $template);
    //Obtengo datos
    $alternativa1                = ObtenerRespuestasPreguntaPorObjetoYTipo(0, $id_pregunta, 1);
    $alternativa2                = ObtenerRespuestasPreguntaPorObjetoYTipo(0, $id_pregunta, 2);
    $alternativa3                = ObtenerRespuestasPreguntaPorObjetoYTipo(0, $id_pregunta, 3);
    $alternativa4                = ObtenerRespuestasPreguntaPorObjetoYTipo(0, $id_pregunta, 4);
    $total                       = $alternativa1[0]->total + $alternativa2[0]->total + $alternativa3[0]->total + $alternativa4[0]->total;
    $arreglo[0]["color"]         = "Seguridad";
    $arreglo[0]["nota"]          = FormatearPorcentajesSinDecimal(($alternativa1[0]->total * 100) / $total);
    $arreglo[0]["color_grafico"] = "danger";
    $arreglo[1]["color"]         = "Salud";
    $arreglo[1]["nota"]          = FormatearPorcentajesSinDecimal(($alternativa2[0]->total * 100) / $total);
    $arreglo[1]["color_grafico"] = "yellow";
    $arreglo[2]["color"]         = "Recreacion";
    $arreglo[2]["nota"]          = FormatearPorcentajesSinDecimal(($alternativa3[0]->total * 100) / $total);
    $arreglo[2]["color_grafico"] = "success";
    $arreglo[3]["color"]         = "Financieros";
    $arreglo[3]["nota"]          = FormatearPorcentajesSinDecimal(($alternativa4[0]->total * 100) / $total);
    $arreglo[3]["color_grafico"] = "success";
    foreach ($arreglo as $key => $row) {
        $aux[$key] = $row['nota'];
    }
    array_multisort($aux, SORT_DESC, $arreglo);
    for ($i = 0; $i < 4; $i++) {
        //$alternativas_rows.=file_get_contents("views/cursos/contenidos/row_respuesta_pregunta".$datos_pregunta[0]->numero_template_pregunta.".html");
        $alternativas_rows .= file_get_contents("views/cursos/contenidos/row_respuesta_pregunta" . $datos_pregunta[0]->numero_template_pregunta . ".html");
        $alternativas_rows = str_replace("{ALTERNATIVA}", $arreglo[$i]["color"], $alternativas_rows);
        $alternativas_rows = str_replace("{NOTA}", $arreglo[$i]["nota"], $alternativas_rows);
        $alternativas_rows = str_replace("{COLOR_GRAFICO}", $arreglo[$i]["color_grafico"], $alternativas_rows);
    }
    $template = str_replace("{RESPUESTAS_PREGUNTA1}", $alternativas_rows, $template);
    //$template = str_replace("{NOTAAMARILLO}",FormatearPorcentajesSinDecimal(($alternativa2[0]->total*100)/$total),$template);
    //$template = str_replace("{NOTAVERDE}",FormatearPorcentajesSinDecimal(($alternativa3[0]->total*100)/$total),$template);
    return ($template);
}
function FormatearPorcentajesSinDecimal($valor)
{
    $valor = number_format($valor, 0, ",", ".");
    return ($valor);
}
function FormatearPorcentajes1Decimal($valor)
{
    $valor = number_format($valor, 1, ",", ".");
    return ($valor);
}
function ColocaBloquePreguntaPorObjeto($id_objeto, $rut, $tipo)
{
    //Veo si hay documentos por Objeto
    if ($_SESSION["id_empresa"] == 22) {
        //$pregunta=PreguntaEncuestaParaTNT();
        //$pregunta=PreguntaEncuestaParaPorEmpresa($_SESSION["id_empresa"]);
        //$tipo=$pregunta[0]->numero_template_pregunta;
        //$pregunta=PreguntaDadoIdObjeto(999, 2);
        $pregunta = PreguntaEncuestaParaPorEmpresa($_SESSION["id_empresa"]);
        $tipo     = $pregunta[0]->tipo;
    } else if ($_SESSION["id_empresa"] == 41) {
        //$pregunta=PreguntaEncuestaParaTNT();
        $pregunta = PreguntaEncuestaParaPorEmpresa($_SESSION["id_empresa"]);
        $tipo     = $pregunta[0]->numero_template_pregunta;
    } else {
        $pregunta = PreguntaDadoIdObjeto($id_objeto, $tipo);
        $tipo     = $pregunta[0]->tipo;
    }
    $bloque_archivos = "";
    if ($pregunta) {
        $tiene_respuesta = VerificaRespuestaPorPreguntaObjetoUsuario($id_objeto, $pregunta[0]->id, $rut);
        //si tiene respuesta
        if ($tiene_respuesta) {
            if ($tipo == 1) {
                $bloque_archivos = MuestraResultadosPreguntaPorObjeto($id_objeto, $pregunta[0]->id, $rut);
            } else if ($tipo == 2) {
                $bloque_archivos = MuestraResultadosPreguntaPorObjetoCheck($id_objeto, $pregunta[0]->id, $rut);
            } else if ($tipo == 3) {
                $bloque_archivos = MuestraResultadosPreguntaPorObjetoCheck($id_objeto, $pregunta[0]->id, $rut);
                //}else if($tipo==4){
            } else {
                $bloque_archivos = MuestraResultadosPreguntaPorObjeto4($id_objeto, $pregunta[0]->id, $rut);
            }
        } else {
            $bloque_archivos = file_get_contents("views/cursos/contenidos/entorno_bloque_pregunta" . $tipo . ".html");
            $bloque_archivos = str_replace("{PREGUNTA}", utf8_encode($pregunta[0]->pregunta), $bloque_archivos);
            $bloque_archivos = str_replace("{ID_PREGUNTA_ENCODEADA}", utf8_encode($pregunta[0]->id), $bloque_archivos);
            if ($tipo == 2) {
                //Coloco las alternativas
                $alternativas = AlternativasDadoGupoId($pregunta[0]->id_alternativas);
                foreach ($alternativas as $alt) {
                    $alternativas_html .= file_get_contents("views/cursos/contenidos/row_alternativa_pregunta_objeto.html");
                    $alternativas_html = str_replace("{ALTERNATIVA}", $alt->alternativa, $alternativas_html);
                    $alternativas_html = str_replace("{VALUE_CHECK}", $alt->id, $alternativas_html);
                }
                $bloque_archivos = str_replace("{TOTAL_ALTERNATIVAS}", count($alternativas), $bloque_archivos);
            } else if ($tipo == 3) {
                //Coloco las alternativas
                $alternativas = AlternativasDadoGupoId($pregunta[0]->id_alternativas);
                foreach ($alternativas as $alt) {
                    $alternativas_html .= file_get_contents("views/cursos/contenidos/row_alternativa_pregunta_objeto_radio.html");
                    $alternativas_html = str_replace("{ALTERNATIVA}", $alt->alternativa, $alternativas_html);
                    $alternativas_html = str_replace("{VALUE_CHECK}", $alt->id, $alternativas_html);
                    $alternativas_html = str_replace("{NAME}", $pregunta[0]->id, $alternativas_html);
                }
                $bloque_archivos = str_replace("{TOTAL_ALTERNATIVAS}", count($alternativas), $bloque_archivos);
            }
            $bloque_archivos = str_replace("{OPCIONES}", $alternativas_html, $bloque_archivos);
        }
    }
    return ($bloque_archivos);
}
function ColocaBloqueDocumentosPorObjeto($id_objeto)
{
    //Veo si hay documentos por Objeto
    $archivos        = ArchivosDadoIdObjeto($id_objeto);
    $bloque_archivos = "";
    if ($archivos) {
        $bloque_archivos = file_get_contents("views/cursos/contenidos/entorno_bloque_documentos.html");
        foreach ($archivos as $unico) {
            $row .= file_get_contents("views/cursos/contenidos/bloque_documento.html");
            $row = str_replace("{TITULO}", $unico->titulo, $row);
            $row = str_replace("{DESCRIPCION}", utf8_encode($unico->descripcion), $row);
            $row = str_replace("{DOCUMENTO_DESCARGA}", $unico->archivo, $row);
        }
        $bloque_archivos = str_replace("{ROWS_MATERIAL_APOYO}", $row, $bloque_archivos);
    }
    return ($bloque_archivos);
    /*
    $bloques_texto=BloqueCitaPorObjeto($id_objeto);
    $html_bloque="";
    if($bloques_texto){
    $html_bloque=file_get_contents("views/cursos/contenidos/entorno_bloque_cita.html");
    foreach($bloques_texto as $unico){
    $row.=file_get_contents("views/cursos/contenidos/bloque_cita.html");
    $row = str_replace("{TEXTO}",$unico->texto,$row);
    }
    //$html_bloque = str_replace("{ROWS}",$row, $html_bloque);
    $html_bloque = str_replace("{ROWS_CITA}",$row,$html_bloque);
    }else{
    }
    return(utf8_encode($html_bloque));*/
}
function MobileDetectFunction()
{
}
function ColocaBloqueCitasPorObjeto($id_objeto)
{
    $bloques_texto = BloqueCitaPorObjeto($id_objeto);
    $html_bloque   = "";
    if ($bloques_texto) {
        $html_bloque = file_get_contents("views/cursos/contenidos/entorno_bloque_cita.html");
        foreach ($bloques_texto as $unico) {
            $row .= file_get_contents("views/cursos/contenidos/bloque_cita.html");
            $row = str_replace("{TEXTO}", $unico->texto, $row);
        }
        //$html_bloque = str_replace("{ROWS}",$row, $html_bloque);
        $html_bloque = str_replace("{ROWS_CITA}", $row, $html_bloque);
    } else {
    }
    return (utf8_encode($html_bloque));
}
function ColocaBloqueTextosPorObjeto($id_objeto)
{
    $bloques_texto = BloqueTextoPorObjeto($id_objeto);
    $html_bloque   = "";
    if ($bloques_texto) {
        $html_bloque = file_get_contents("views/cursos/contenidos/entorno_bloque_texto.html");
        foreach ($bloques_texto as $unico) {
            $row .= file_get_contents("views/cursos/contenidos/bloque_texto.html");
            $row = str_replace("{TEXTO}", $unico->texto, $row);
        }
        //$html_bloque = str_replace("{ROWS}",$row, $html_bloque);
        $html_bloque = str_replace("{ROWS}", $row, $html_bloque);
    } else {
    }
    return (utf8_encode($html_bloque));
}
function colocarReconocimientosPorRut($PRINCIPAL, $id_empresa, $rut)
{
    $listado_reconocimientos = TotalReconocimientosPorRut($rut, $id_empresa);
    if ($listado_reconocimientos) {
        $PRINCIPAL = str_replace("{BLOQUE_RECONOCIMIENTOS}", file_get_contents("views/miperfil/bloque_mis_reconocimientos.html"), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_RECONOCIMIENTOS}", "", $PRINCIPAL);
    }
    foreach ($listado_reconocimientos as $unico) {
        $row .= file_get_contents("views/salondelafama/row_bloquesalonfama2.html");
        $row   = str_replace("{NOMBRE_CATEGORIA}", $unico->nombre_categoria, $row);
        $row   = str_replace("{LOGO_CATEGORIA}", $unico->imagen, $row);
        $row   = str_replace("{DESCRIPCION_CATEGORIA}", $unico->descripcion_categoria, $row);
        //Por la categoria traigo la cantidad X de ganadores
        $datos = ObtenerSalonPorCategoriaYEmpresa($id_empresa, $unico->id, 1);
        $row   = str_replace("{NOMBRE_PERSONAS}", $datos[0]->nombre_persona . " " . $datos[0]->apaterno . " " . $datos[0]->amaterno, $row);
        $row   = str_replace("{CARGO_PERSONAS}", $datos[0]->cargo, $row);
        $row   = str_replace("{URL_PERSONA}", VerificaFotoPersonal($datos[0]->rut), $row);
        $row   = str_replace("{RUT_ENCODEADO}", Encodear3($datos[0]->rut), $row);
        $row   = str_replace("{TEXTO1}", $datos[0]->texto1, $row);
        $row   = str_replace("{TEXTO2}", $datos[0]->texto2, $row);
        $row   = str_replace("{TEXTO3}", $datos[0]->texto3, $row);
        $row   = str_replace("{TEXTO4}", $datos[0]->texto4, $row);
        $row   = str_replace("{TEXTO5}", $datos[0]->texto5, $row);
    }
    $PRINCIPAL = str_replace("{LISTADO_RECONOCIMIENTOS}", utf8_encode($row), $PRINCIPAL);
    return ($PRINCIPAL);
}
function Noticias($PRINCIPAL, $tipo, $limit, $variable)
{
    if ($tipo == "1") {
        $template_row = file_get_contents("views/noticias/row_noticias_principales.html");
        if ($variable) {
            $noticias = TraeNoticiasPrincipalesPorGerencia($_SESSION["id_empresa"], $variable, $limit);
        } else {
            $noticias = TraeNoticiasPrincipales($_SESSION["id_empresa"], $variable, $limit);
        }
    } else if ($tipo == "sola") {
        $template_row = file_get_contents("views/noticias/row_noticias_1.html");
        $noticias     = TraeNoticiasSecundarias($_SESSION["id_empresa"], $limit);
    } else if ($tipo == "CATEGORIA_CONCURSO") {
        $template_row = file_get_contents("views/noticias/row_general_TREScolumnas.html");
        $noticias     = TraeNoticiasSecundariasCategoria($_SESSION["id_empresa"], $limit, 72);
    } else if ($tipo == "CATEGORIA_PRENSA") {
        $template_row = file_get_contents("views/noticias/row_general_TREScolumnas.html");
        $noticias     = TraeNoticiasSecundariasCategoria($_SESSION["id_empresa"], $limit, 71);
    } else if ($tipo == "2") {
        $template_row = file_get_contents("views/noticias/row_noticias_2.html");

        if($_SESSION["id_empresa"]==41){

            $noticias     = TraeNoticiasSecundariasSinConcurso($_SESSION["id_empresa"], $limit);
        }else{
            $noticias     = TraeNoticiasSecundarias($_SESSION["id_empresa"], $limit);
        }

    } else if ($tipo == "3") {
        $template_row = file_get_contents("views/noticias/row_noticias_terciarias.html");
        $noticias     = TraeNoticiasSecundarias($_SESSION["id_empresa"], $limit);
    } else if ($tipo == "4") {
        $template_row = file_get_contents("views/noticias/row_noticias_4.html");
        $noticias     = TraeNoticiasSecundarias($_SESSION["id_empresa"], $limit);
    } else if ($tipo == "53") {
        $template_row = file_get_contents("views/noticias/53_row_noticias_4.html");
        $noticias     = TraeNoticiasSecundarias($_SESSION["id_empresa"], $limit);
    } else if ($tipo == "5") {
        $template_row = file_get_contents("views/noticias/row_noticias_5.html");
        $noticias     = TraeNoticiasSecundarias($_SESSION["id_empresa"], $limit);
    } else if ($tipo == "6") {
        $template_row = file_get_contents("views/noticias/row_noticias_6.html");
        $noticias     = TraeNoticiasSecundarias($_SESSION["id_empresa"], $limit);
    } else if ($tipo == "7") {
        $template_row = file_get_contents("views/noticias/row_noticias_principales_7.html");
        if ($variable) {
            $noticias = TraeNoticiasPrincipalesPorGerencia($_SESSION["id_empresa"], $variable, $limit);
        } else {
            $noticias = TraeNoticiasPrincipales($_SESSION["id_empresa"], $variable, $limit);
        }
    } else if ($tipo == "8") {
        $template_row = file_get_contents("views/noticias/row_noticias_8.html");
        $noticias     = TraeNoticiasSecundarias($_SESSION["id_empresa"], $limit);
    } else if ($tipo == "9") {
        $template_row = file_get_contents("views/noticias/row_noticias_9.html");
        $noticias     = TraeNoticiasSecundarias($_SESSION["id_empresa"], $limit);
    } else if ($tipo == "principal_2columnas") {
        $template_row = file_get_contents("views/noticias/row_principal_DOScolumnas.html");
        $noticias     = TraeNoticiasSecundarias($_SESSION["id_empresa"], $limit);
    } else if ($tipo == "principal_DOScolumnas") {
        $template_row = file_get_contents("views/noticias/row_principal_DOScolumnas.html");
        $noticias     = TraeNoticiasPrincipales($_SESSION["id_empresa"], $limit);
    } else if ($tipo == "general_TREScolumnas") {
        $template_row = file_get_contents("views/noticias/row_general_TREScolumnas.html");
        $noticias     = TraeNoticiasSecundarias($_SESSION["id_empresa"], $limit);
    } else if ($tipo == "2columnas") {
        $template_row = file_get_contents("views/noticias/row_general_2columnas.html");
        $noticias     = TraeNoticiasSecundarias($_SESSION["id_empresa"], $limit);
    } else if ($tipo == "1columnabciprod") {
        $template_row = file_get_contents("views/noticias/row_1columnas_prod.html");
        $noticias     = TraeNoticiasSecundarias($_SESSION["id_empresa"], $limit);
    } else if ($tipo == "1columnasinhref") {
        $template_row = file_get_contents("views/noticias/row_1columnas_sinhref.html");
        $noticias     = TraeNoticiasSecundarias($_SESSION["id_empresa"], $limit);
    } else if ($tipo == "1columnasinhref_wide") {
        $template_row = file_get_contents("views/noticias/row_1columnas_sinhref_wide.html");
        $noticias     = TraeNoticiasSecundarias($_SESSION["id_empresa"], $limit);
    } else if ($tipo == "enFila") {
        $template_row = file_get_contents("views/noticias/row_enfila.html");
        $noticias     = TraeNoticiasSecundarias($_SESSION["id_empresa"], $limit);
    } else if ($tipo == "enFilaV2") {
        $template_row = file_get_contents("views/noticias/row_enfila_v2.html");
        $noticias     = TraeNoticiasSecundarias($_SESSION["id_empresa"], $limit);
    }
    //
    //print_r($noticias);
    foreach ($noticias as $not) {
        $row                 = $template_row;
        $TodoslosComentarios = TodosComentarios($not->id);
        //$row = str_replace("{PORTADA}",imagen_existe($not->portada),$row);
        if ($not->imagen_thumb) {
            $row = str_replace("{PORTADA}", "thum/" . $not->imagen_thumb, $row);
            $row = str_replace("{IMAGEN_NOTICIA}", "thum/" . $not->imagen_thumb, $row);
        } else {
            $row = str_replace("{PORTADA}", $not->portada, $row);
            $row = str_replace("{IMAGEN_NOTICIA}", $not->portada, $row);
        }
        $row         = str_replace("{TITULO}", $not->titulo, $row);
        $row         = str_replace("{FECHA}", FechaTipoSpa($not->fecha_creacion), $row);
        //$row = str_replace("{CONTENIDO_CORTO}",substr($not->contenido, 0, 100),$row);
        $row         = str_replace("{CONTENIDO_CORTO}", tokenTruncate($not->bajada, 245), $row);
        $row         = str_replace("{CONTENIDO_CORTO2}", tokenTruncate($not->bajada, 150), $row);
        $row         = str_replace("{ID_NOTICIA}", Encodear($not->id), $row);
        $row         = str_replace("{COMENTARIOS}", count($TodoslosComentarios), $row);
        $row         = str_replace("{CATEGORIA}", $not->nombre_categoria, $row);
        //datos autor
        $datos_autor = UsuarioEnBasePersonas($not->rut_creador);
        $row         = str_replace("{AUTOR}", $datos_autor[0]->nombre . " " . $datos_autor[0]->apaterno . " " . $datos_autor[0]->apaterno, $row);
        $total_html .= $row;
    }
    //echo $total_html;
    $PRINCIPAL = str_replace("{COLUMNAS_NOTICIAS_" . $tipo . "}", utf8_encode($total_html), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ComunidadObjeto($PRINCIPAL, $tipo, $id_objeto, $limit, $num, $lectura, $volver, $sinboton, $textoboton)
{
    //echo "$tipo, $id_objeto, $limit, $num, $lectura, $volver, $sinboton, $textoboton";
    if ($tipo == "opinion") {
        $template_row  = file_get_contents("views/comunidad/row_opinion_comunidad.html");
        //echo "hola";
        $datos_objetos = traeLineasObjetov($_SESSION["id_empresa"], $tipo, $id_objeto, $limit);
        //echo "chau";
    } else if ($tipo == "foto") {
        $template_row  = file_get_contents("views/comunidad/row_opinion_comunidad.html");
        $datos_objetos = traeLineasObjetov($_SESSION["id_empresa"], $tipo, $id_objeto, $limit);
    } else if ($tipo == "compromiso") {
        $template_row  = file_get_contents("views/comunidad/row_compromiso_comunidad.html");
        $datos_objetos = traeLineasObjetov($_SESSION["id_empresa"], $tipo, $id_objeto, $limit);
    }
    $titulo_objeto = traetituloObjeto($_SESSION["id_empresa"], $id_objeto);
    foreach ($datos_objetos as $dato_objeto) {
        $row         = $template_row;
        $row         = str_replace("{COMENTARIO}", $dato_objeto->comentario, $row);
        $row         = str_replace("{COMPROMISO}", $dato_objeto->compromiso, $row);
        $row         = str_replace("{META}", $dato_objeto->meta, $row);
        $row         = str_replace("{PLAN}", $dato_objeto->plan, $row);
        $datos_autor = UsuarioEnBasePersonas($dato_objeto->rut);
        $row         = str_replace("{AUTOR}", $datos_autor[0]->nombre_completo, $row);
        //datos autor
        $row         = str_replace("{URL_PERSONA}", VerificaFotoPersonal($dato_objeto->rut), $row);
        $total_html .= $row;
    }
    //echo $total_html;
    $PRINCIPAL = str_replace("{LISTA_OBJETO" . $num . "}", utf8_encode($total_html), $PRINCIPAL);
    $PRINCIPAL = str_replace("{OBJETO" . $num . "}", utf8_encode($titulo_objeto[0]->titulo_principal), $PRINCIPAL);
    $PRINCIPAL = str_replace("{DESCOBJETO" . $num . "}", utf8_encode($titulo_objeto[0]->descripcion), $PRINCIPAL);
    if ($sinboton <> 1) {
        $PRINCIPAL = str_replace("{BOTON" . $num . "}", file_get_contents("views/comunidad/row_boton_ingresa.html"), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BOTON" . $num . "}", "", $PRINCIPAL);
    }
    if ($lectura == 1) {
        $PRINCIPAL = str_replace("{LINK_OBJETO}", "?sw=contenido&i=" . Encodear3($id_objeto) . "&tt=1&checkin=1", $PRINCIPAL);
        $PRINCIPAL = str_replace("{TEXTOBOTON}", utf8_encode($textoboton), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{LINK_OBJETO}", "?sw=contenido&i=" . Encodear3($id_objeto) . "&checkin=1", $PRINCIPAL);
        $PRINCIPAL = str_replace("{TEXTOBOTON}", utf8_encode($textoboton), $PRINCIPAL);
    }
    /*
    if($lectura==1){
    $PRINCIPAL = str_replace("{LINK_OBJETO".$num."}","?sw=contenido&i=".Encodear3($id_objeto)."&tt=1&checkin=1",$PRINCIPAL);
    } else {
    $PRINCIPAL = str_replace("{LINK_OBJETO".$num."}","?sw=contenido&i=".Encodear3($id_objeto)."&checkin=1",$PRINCIPAL);
    }
    */
    return ($PRINCIPAL);
}
function FaqObjeto($PRINCIPAL, $rut, $id_empresa)
{
    $datos_mallapersona = buscamalla($rut, $id_empresa);
    //print_r($datos_mallapersona);
    $id_malla           = $datos_mallapersona[0]->id_malla;
    $template_row       = file_get_contents("views/faq/" . $id_empresa . "_row_faq.html");
    $datos_objetos      = traeLineasFaqs($id_empresa, $id_malla);
    //print_r($datos_objetos);
    foreach ($datos_objetos as $dato_objeto) {
        $row = $template_row;
        //$TodoslosComentarios=TodosComentarios($not->id);
        //$row = str_replace("{PORTADA}",imagen_existe($not->portada),$row);
        $row = str_replace("{NOMBREFAQ}", ($dato_objeto->faq_nombre), $row);
        $row = str_replace("{CONTENIDOFAQ}", ($dato_objeto->faq_contenido), $row);
        //datos autor
        $row = str_replace("{CATEGORIAFAQ}", utf8_decode($dato_objeto->categoria), $row);
        $row = str_replace("{IDFAQ}", $dato_objeto->id, $row);
        $total_html .= $row;
    }
    //echo $total_html;
    $PRINCIPAL = str_replace("{LISTA_FAQS}", utf8_encode($total_html), $PRINCIPAL);
    return ($PRINCIPAL);
}
function devuelveNombreMes($numero_mes)
{
    if ($numero_mes == "1") {
        return ("Enero");
    } else if ($numero_mes == "2") {
        return ("Febrero");
    } else if ($numero_mes == "3") {
        return ("Marzo");
    } else if ($numero_mes == "4") {
        return ("Abril");
    } else if ($numero_mes == "5") {
        return ("Mayo");
    } else if ($numero_mes == "6") {
        return ("Junio");
    } else if ($numero_mes == "7") {
        return ("Julio");
    } else if ($numero_mes == "8") {
        return ("Agosto");
    } else if ($numero_mes == "9") {
        return ("Septiembre");
    } else if ($numero_mes == "10") {
        return ("Octubre");
    } else if ($numero_mes == "11") {
        return ("Noviembre");
    } else if ($numero_mes == "12") {
        return ("Diciembre");
    }
}
function colocaIndicadores($PRINCIPAL, $variable, $id_empresa)
{
    //Traigo los registros de la tabla
    $indicadores = TraeIndicadores($id_empresa, $variable);
    foreach ($indicadores as $unico) {
        $grafico .= file_get_contents("views/graficos/sgd/barraslinea.html");
        $grafico         = str_replace("{NOMBRE_GRAFICO}", "Grafico" . $unico->id, $grafico);
        $grafico         = str_replace("{TITULO}", $unico->nombre, $grafico);
        $grafico         = str_replace("{x}", $unico->mes, $grafico);
        $grafico         = str_replace("{y1}", $unico->y1, $grafico);
        $grafico         = str_replace("{y2}", $unico->y2, $grafico);
        $grafico         = str_replace("{y3}", $unico->y3, $grafico);
        //Ahora por cada indicador, traigo la data
        $datos_indicador = DataPorIndicador($unico->id);
        $html_datos      = "";
        $i               = 1;
        foreach ($datos_indicador as $datos_unico) {
            //print_r($datos_unico);echo "<br>";
            $html_datos .= "['" . $datos_unico->x . "', " . $datos_unico->y1 . ", " . $datos_unico->y2 . ", " . $datos_unico->y3 . "]";
            if ($i < count($datos_indicador))
                $html_datos .= ",";
            $i++;
        }
        //echo "<br><br>";
        $grafico = str_replace("{ARREGLO_DATOS}", $html_datos, $grafico);
    }
    $PRINCIPAL = str_replace("{LISTADO_GRAFICOS}", $grafico, $PRINCIPAL);
    return ($PRINCIPAL);
}
function PaginacionSGDSoloEvaluadorPorPreguntas($evaluador, $pagina, $id_proceso)
{
    $perfiles_dado_evaluador = TotalPerfilesDadoEvaluador($evaluador);
    $total_paginas           = $perfiles_dado_evaluador[0]->cantidad_componentes + 1;
    $tiene_sesion            = SesionSGDSoloEvaluador($evaluador, $id_proceso);
    //total de paginas
    if ($tiene_sesion) {
        $pagina = $tiene_sesion[0]->pagina;
    } else {
        $pagina = 1;
    }
    $paginacion = '<div class="pagination_sgd"><ul>';
    for ($i = 1; $i <= $total_paginas; $i++) {
        if ($pagina == $i) {
            //$paginacion.="<span class='pagination_sgd_activo'>".$i."</span>";
            $paginacion .= '<li ><a class="pagination_sgd_activo">' . $i . '</a></li>';
        } else {
            //$paginacion.=$i;
            $paginacion .= '<li><a href="#">' . $i . '</a></li>';
        }
    }
    $paginacion .= '</ul></div>';
    return ($paginacion);
}
function PaginacionSGDPorPreguntasV2($evaluador, $pagina, $id_proceso, $total_paginas, $tiene_objetivos, $evaluado)
{
    //$perfiles_dado_evaluador=TotalPerfilesDadoEvaluador($evaluador);
    //$total_paginas=$perfiles_dado_evaluador[0]->cantidad_componentes+1;
    if ($tiene_objetivos == "si") {
        $total_paginas = $total_paginas + 1;
    } else {
        $total_paginas = $total_paginas;
    }
    if ($evaluado) {
        $tiene_sesion = SesionSGDSoloEvaluadorEvaluado($evaluador, $id_proceso, $evaluado);
    } else {
        $tiene_sesion = SesionSGDSoloEvaluador($evaluador, $id_proceso);
    }
    //total de paginas
    if ($tiene_sesion) {
        $pagina = $tiene_sesion[0]->pagina;
    } else {
        $pagina = 1;
    }
    if ($total_paginas > 10) {
        $paginacion = '<div class="col-md-4 pagination_sgd"><ul>';
        $mayor      = "no";
        for ($i = 1; $i <= $total_paginas; $i++) {
            if ($pagina == $i) {
                $paginacion .= '<li ><a class="pagination_sgd_activo_actual">' . $i . '</a></li>';
            } else if ($i == $pagina - 1 or $i == $pagina - 2) {
                $paginacion .= '<li><a class="pagination_sgd_activo" href="#">' . $i . '</a></li>';
            } else if ($i == $pagina + 1 or $i == $pagina + 2) {
                $paginacion .= '<li><a href="#">' . $i . '</a></li>';
            } else if ($i < $total_paginas && $mayor == "no") {
                $ultima_pagina = '<li><a href="#">de un total de ' . $total_paginas . '</a></li>';
                $mayor         = "si";
            }
            /*else if($pagina>$i){
            //$paginacion.='<li ><a class="pagination_sgd_activo" href="?sw=ev&p='.Encodear3($i).'">'.$i.'</a></li>';
            }else{
            //$paginacion.='<li><a href="#">'.$i.'</a></li>';
            }*/
        }
        $paginacion .= $ultima_pagina;
        $paginacion .= '</ul></div>';
        return ($paginacion);
    } else {
        $paginacion = '<div class="col-md-12 pagination_sgd"><ul>';
        for ($i = 1; $i <= $total_paginas; $i++) {
            if ($pagina == $i) {
                $paginacion .= '<li ><a class="pagination_sgd_activo_actual">' . $i . '</a></li>';
            } else if ($pagina > $i) {
                //$paginacion.='<li ><a class="pagination_sgd_activo" href="?sw=ev&p='.Encodear3($i).'">'.$i.'</a></li>';
                //$paginacion.='<li ><a class="pagination_sgd_activo" href="?sw=evind&ie='.Encodear3($evaluado).'&p='.Encodear3($i).'&pagi=1"> '.$i.'</a></li>';
                $paginacion .= '<li ><a class="pagination_sgd_activo" href="#"> ' . $i . '</a></li>';
            } else {
                $paginacion .= '<li><a href="#">' . $i . '</a></li>';
            }
        }
        $paginacion .= '</ul></div>';
        return ($paginacion);
    }
}
function EntornoEvaluacionListadoAlternativasDinamicas($html, $evaluador, $pagina, $id_empresa, $id_proceso, $evaluado_individual)
{
    if ($evaluado_individual) {
        $evaluados = EvaluadosDadoEvaluadorPorProcesoPorEvaluado($evaluador, $id_proceso, $evaluado_individual);
    } else {
        //$evaluados=EvaluadosDadoEvaluadorPorProceso($evaluador, $id_proceso);
        $evaluados = EvaluadosDadoEvaluadorPorProcesoSinAe($evaluador, $id_proceso);
    }
    $datos_proceso       = TraeProcesosDeEvaluacionPorEmpresaYDiProceso($id_empresa, $id_proceso);
    $id_proceso_anterior = $datos_proceso[0]->id_proceso_anterior;
    if ($evaluados) {
        if ($evaluado_individual) {
            $perfiles = TotalPerfilesDadoEvaluador1PorEvaluado($evaluador, $evaluado_individual, $id_proceso);
        } else {
            //$perfiles=TotalPerfilesDadoEvaluador1($evaluador);
            $perfiles = TotalPerfilesDadoEvaluador1PorProceso($evaluador, $id_proceso);
        }
        //Aca tengo todos los perfiles, con esto, obtengo todas las competencias.
        for ($i = 0; $i < count($perfiles); $i++) {
            $sql .= " perfil_evaluacion='" . $perfiles[$i]->id_perfil_ev . "'";
            if ($perfiles[$i + 1]->id_perfil_ev)
                $sql .= " or";
        }
        if ($evaluado_individual) {
            $componentes               = TotalIdCompetenciasIndividual($sql);
            //$entorno_eval_competencias=file_get_contents("views/sgd/evaluacion/entorno_individual_evaluacion_competencia.html");
            $entorno_eval_competencias = file_get_contents("views/sgd/evaluacion/" . $id_empresa . "_entorno_individual_evaluacion_competencia.html");
            if ($evaluado_individual == $evaluador) {
                $entorno_eval_competencias = str_replace("{TEXTO_COMENTARIO_POR_COMPETENCIA_INDIVIDUAL}", "Recuerda exponer situaciones concretas que validen tu autoevaluaci?n. Ser? importante para tu Supervisor conocer tu percepci?n al evaluarte.", $entorno_eval_competencias);
            } else {
                $entorno_eval_competencias = str_replace("{TEXTO_COMENTARIO_POR_COMPETENCIA_INDIVIDUAL}", "Recuerda que es importante retroalimentar a tu equipo! Tus observaciones pueden hacer la diferencia sobre c?mo se percibe el proceso de evaluaci?n. Recuerda ser lo m?s objetivo posible y relatar experiencias concretas!", $entorno_eval_competencias);
            }
            $entorno_eval_competencias = ColocaDatosUsuario($entorno_eval_competencias, $evaluado_individual);
            $verifico_eval_finalizada  = FinalizadoEvaluadoEvaluadorProProceso($evaluado_individual, $evaluador, $id_proceso);
            if ($verifico_eval_finalizada) {
                $html = str_replace("{VER_INFORME_INDIVIDUAL}", file_get_contents("views/sgd/evaluacion/boton_ver_informe.html"), $html);
                $html = str_replace("{ID_PROCESO_ENCODEADO}", Encodear3($id_proceso), $html);
                $html = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($evaluado_individual), $html);
            } else {
                $html = str_replace("{VER_INFORME_INDIVIDUAL}", "", $html);
            }
            if ($pagina > 1) {
                $entorno_eval_competencias = str_replace("{BOTON_ATRAS}", file_get_contents("views/sgd/evaluacion/boton_atras_eval_competencias.html"), $entorno_eval_competencias);
                if ($evaluado_individual == $evaluador) {
                    $entorno_eval_competencias = str_replace("{VISTA_AE}", "&ae=1", $entorno_eval_competencias);
                } else {
                    $entorno_eval_competencias = str_replace("{VISTA_AE}", "", $entorno_eval_competencias);
                }
                $total_html = str_replace("{BOTON_ATRAS}", file_get_contents("views/sgd/evaluacion/boton_atras_eval_competencias.html"), $total_html);
            } else {
                $entorno_eval_competencias = str_replace("{BOTON_ATRAS}", "", $entorno_eval_competencias);
                $total_html                = str_replace("{BOTON_ATRAS}", "", $total_html);
                $entorno_eval_competencias = str_replace("{VISTA_AE}", "", $entorno_eval_competencias);
            }
        } else {
            $componentes               = TotalIdCompetencias($sql);
            $total_html                = file_get_contents("views/sgd/evaluacion/" . $id_empresa . "_entorno_equipo_evaluacion_competencia.html");
            $entorno_eval_competencias = file_get_contents("views/sgd/evaluacion/" . $id_empresa . "_entorno_equipo_evaluacion_competencia.html");
            $html                      = str_replace("{VER_INFORME_INDIVIDUAL}", "", $html);
            if ($pagina > 1) {
                $entorno_eval_competencias = str_replace("{BOTON_ATRAS}", file_get_contents("views/sgd/evaluacion/boton_atras_eval_competencias.html"), $entorno_eval_competencias);
                $total_html                = str_replace("{BOTON_ATRAS}", file_get_contents("views/sgd/evaluacion/boton_atras_eval_competencias.html"), $total_html);
            } else {
                $entorno_eval_competencias = str_replace("{BOTON_ATRAS}", "", $entorno_eval_competencias);
                $total_html                = str_replace("{BOTON_ATRAS}", "", $total_html);
            }
        }
        if ($datos_proceso[0]->tiene_especificos == 1) {
            /****************************/
            /******************************/
            /********PARA CUANDO TIENE OBJETIVOS*/
            if ($pagina > 1) {
                /****************************/
                /******************************/
                /********PARA CUANDO NO TIENE OBJETIVOS*/
                /****************************************************************/
                //BLOQUE QUE VALIDA LA CANTIDAD DE RESPUESTAS POR PAGINA JAVASCRIPT
                /****************************************************************/
                //$total_html=file_get_contents("views/sgd/evaluacion/entorno_equipo_evaluacion_competencia.html");
                $total_html = $entorno_eval_competencias;
                if ($datos_proceso[0]->validacion_js_preguntas == 1) {
                    $total_html = str_replace("{BLOQUE_FUNCION_JAVASCRIPT_PARA_VALIDAR_CANTIDAD_ALTERNATIVAS}", file_get_contents("views/sgd/evaluacion/funcionValidaCantidadRespuestas.html"), $total_html);
                } else {
                    $total_html = str_replace("{BLOQUE_FUNCION_JAVASCRIPT_PARA_VALIDAR_CANTIDAD_ALTERNATIVAS}", file_get_contents("views/sgd/evaluacion/funcionNext.html"), $total_html);
                }
                //$total_html = str_replace("{TOTAL_EVALUADOS}",(count($evaluados)*60)/100,$total_html);
                //$total_html = str_replace("{TOTAL_TOTAL_EVALUADOS}",count($evaluados),$total_html);
                //$total_html = str_replace("{TOTAL_EVALUADOS_1_2}",(count($evaluados)*40)/100,$total_html);
                //$total_html = str_replace("{TOTAL_EVALUADOS_4_5}",(count($evaluados)*40)/100,$total_html);
                //Se muestran las competencias para evaluar.
                //echo "pagina $pagina <br>";
                //print_r($componentes);exit;
                //Aca verifico si la pagina actual es mayor a la cantidad de paginas//si es asi, lo tiro para afuera, e inserto registro de finalizado.
                if ($pagina > count($componentes) + 1) {
                    InsertaEvaluadorFinalizado($evaluador, $id_proceso);
                    //Aca ,por cada uno de los evaluados del evaluador, se inserta registro de finalizado evaluado evaluador
                    foreach ($evaluados as $evaluad) {
                        InsertaEvaluadoEvaluadorFinalizado($evaluad->evaluado, $evaluador, $id_proceso);
                    }
                    echo "<script>
                    location.href='?sw=sgd2&ip=" . Encodear3($id_proceso) . "';
                    </script>";
                    exit;
                }
                /////////////////*********************************/////////////////////////////
                //SECCION PARA ENCABEZADOS COMPETENCIAS
                //if($componentes[$pagina-1]->muestra_competencia==1){
                if ($componentes[$pagina - 2]->muestra_competencia == 1) {
                    $total_html = str_replace("{ENCABEZADO_COMPETENCIA}", file_get_contents("views/sgd/evaluacion/encabezado_competencia.html"), $total_html);
                    $total_html = str_replace("{COMPETENCIA}", utf8_encode($componentes[$pagina - 2]->nombre), $total_html);
                    $total_html = str_replace("{DESCRIPCION_COMPETENCIA}", utf8_encode($componentes[$pagina - 2]->descripcion_competencia), $total_html);
                } else {
                    $total_html = str_replace("{ENCABEZADO_COMPETENCIA}", "", $total_html);
                }
                /////////////////*********************************/////////////////////////////
                //SECCION PARA ENCABEZADO DIMENSIONES
                if ($componentes[$pagina - 2]->muestra_dimension == 1) {
                    $total_html = str_replace("{ENCABEZADO_DIMENSION}", file_get_contents("views/sgd/evaluacion/encabezado_dimension.html"), $total_html);
                    $total_html = str_replace("{DIMENSION}", utf8_encode($componentes[$pagina - 2]->nombre_dimension), $total_html);
                } else {
                    $total_html = str_replace("{ENCABEZADO_COMPETENCIA}", "", $total_html);
                    $total_html = str_replace("{ENCABEZADO_DIMENSION}", "", $total_html);
                }
                if ($componentes[$pagina - 2]->comentario_obligatorio == 1) {
                    $comentario_obligatorio = "required";
                } else {
                    $comentario_obligatorio = "";
                }
                $total_html                 = str_replace("{ID_ENCODEADO_COMPETENCIA}", $componentes[$pagina - 2]->id_componente, $total_html);
                $total_html                 = str_replace("{ID_COMPETENCIA}", $componentes[$pagina - 2]->id_componente, $total_html);
                $comentario_por_competencia = TieneComentarioPorCompetencia($evaluado_individual, $evaluador, $componentes[$pagina - 2]->id_componente, $id_empresa, $id_proceso);
                $total_html                 = str_replace("{COMENTARIO_POR_COMPETENCIA}", utf8_encode($comentario_por_competencia[0]->comentario), $total_html);
                if ($evaluado_individual) {
                    //Traigo las preguntas por la competencia
                    $preguntas = PreguntasPorCompetencia($componentes[$pagina - 2]->id_componente);
                    foreach ($preguntas as $preg) {
                        // echo "evaluado $evaluado_individual, evaluador $evaluador, idproceso $id_proceso, idpregunta ".$preg->id."<br>";
                        //Aca veo si para esta pregunta, este evaluado para este evaluador tiene respuesta
                        $tiene_respuesta = TieneRespuestaCompetenciaProProceso($evaluado_individual, $evaluador, $preg->id, $id_proceso);
                        $listado_preguntas .= file_get_contents("views/sgd/evaluacion/" . $id_empresa . "_row_pregunta_por_competencia.html");
                        $listado_preguntas = str_replace("{NOMBRE_PREGUNTA}", $preg->pregunta, $listado_preguntas);
                        $alternativas      = AlternativasDadoIdGrupo($preg->id_alternativa);
                        $td_options        = "";
                        foreach ($alternativas as $alt) {
                            $td .= file_get_contents("views/sgd/evaluacion/alternativa_encabezado.html");
                            $td                = str_replace("{DESCRIPCION_ALTERNATIVA}", utf8_encode($alt->alternativa), $td);
                            //Por cada alternativa, verifico si tiene m?s de una opcion
                            $mas_de_una_opcion = MasDeUnaOpcionPorAlternativa($alt->puntaje, $id_empresa, $id_proceso);
                            if ($mas_de_una_opcion) {
                                $td_options .= file_get_contents("views/sgd/evaluacion/alternativa_options_dinamico.html");
                                $options = "";
                                foreach ($mas_de_una_opcion as $unico) {
                                    $options .= file_get_contents("views/sgd/evaluacion/options_dinamico.html");
                                    $options    = str_replace("{VALUE}", $unico->valor_puntaje, $options);
                                    $td_options = str_replace("{ETIQUETA}", $unico->titulo_opciones, $td_options);
                                    $options    = str_replace("{SIGNO}", $unico->signo, $options);
                                    $options    = str_replace("{CHECK}", "{SELECT" . $unico->valor_puntaje . "} ", $options);
                                }
                                $td_options = str_replace("{SELECT" . $tiene_respuesta[0]->puntaje . "}", "checked", $td_options);
                                $options    = str_replace("{SELECT" . $tiene_respuesta[0]->puntaje . "}", "checked", $options);
                                $td_options = str_replace("{OPTIONS_}", $options, $td_options);
                            } else {
                                $td_options .= file_get_contents("views/sgd/evaluacion/alternativa_options.html");
                                if ($tiene_respuesta[0]->puntaje == $alt->puntaje) {
                                    $td_options = str_replace("{CHECK}", "checked='checked'", $td_options);
                                } else {
                                    $td_options = str_replace("{CHECK}", "", $td_options);
                                }
                                $td_options = str_replace("{VALUE}", $alt->puntaje, $td_options);
                                $td_options = str_replace("{SIGNO}", $unico->signo, $td_options);
                                //$td_options = str_replace("{CHECK}","{SELECT".$alt->puntaje."} ",$td_options);
                            }
                        }
                        $listado_preguntas = str_replace("{NIVELES_TD}", $td_options, $listado_preguntas);
                        $listado_preguntas = str_replace("{NOMBRE_RADIO}", $evaluado_individual . "-" . $preg->id, $listado_preguntas);
                        $listado_preguntas = str_replace("{NOMBRE_RADIO_SOLO_PREGUNTA}", $preg->id, $listado_preguntas);
                        $total_html        = str_replace("{NIVELES_TD}", ($td), $total_html);
                    }
                    $listado_preguntas          = str_replace("{NOMBRE_PREGUNTA}", $preg->pregunta, $listado_preguntas);
                    $total_html                 = str_replace("{LISTADO_PREGUNTAS_A_EVALUAR_POR_COMPETENCIAS}", utf8_encode($listado_preguntas), $total_html);
                    $total_html                 = str_replace("{EVALUADO_ENCODEADO}", Encodear3($evaluado_individual), $total_html);
                    $total_html                 = str_replace("{TOTAL_PREGUNTAS_A_RESPONDER}", count($preguntas), $total_html);
                    $comentario_por_competencia = TieneComentarioPorCompetencia($evaluado_individual, $evaluador, $componentes[$pagina - 1]->id_componente, $id_empresa, $id_proceso);
                    $total_html                 = str_replace("{COMENTARIO_POR_COMPETENCIA}", utf8_encode($comentario_por_competencia[0]->comentario), $total_html);
                } else {
                    //REPLACE PARA LA PREGUNTA
                    $total_html = str_replace("{NOMBRE_PREGUNTA}", utf8_encode($componentes[$pagina - 2]->pregunta), $total_html);
                    if ($componentes[$pagina - 2]->descripcion) {
                        $total_html = str_replace("{TOOLTIP_DESCRIPCION}", file_get_contents("views/sgd/evaluacion/tooltip_descripcion.html"), $total_html);
                    } else {
                        $total_html = str_replace("{TOOLTIP_DESCRIPCION}", "", $total_html);
                    }
                    $total_html   = str_replace("{DESCRIPCION_PREGUNTA}", utf8_encode($componentes[$pagina - 2]->descripcion), $total_html);
                    $total_html   = str_replace("{ID_PREGUNTA_ENCODEADA}", $componentes[$pagina - 2]->id_pregunta, $total_html);
                    $alternativas = AlternativasDadoIdGrupo($componentes[$pagina - 2]->id_alternativa);
                    //Esta codicion es para ver si es que tiene o no comentariop
                    //Si tiene, se coloca el encabezado
                    if ($componentes[$pagina - 2]->tiene_comentarios == 1) {
                        $template_comentario_por_pregunta = file_get_contents("views/sgd/evaluacion/comentario_por_pregunta.html");
                        //Este es para colocar el width dinamico
                        $rowspan_tiene_comentario         = "rowspan='2'";
                    } else {
                        //$total_html = str_replace("{SECCION_ENCABEADO_COMENTARIO}","",$total_html);
                        $template_comentario_por_pregunta = "";
                        $rowspan_tiene_comentario         = "";
                    }
                    $width_dinamico_options = FormatearPorcentajesSinDecimal(100 / (count($alternativas)));
                    foreach ($alternativas as $alt) {
                        $td .= file_get_contents("views/sgd/evaluacion/alternativa_encabezado.html");
                        $td                = str_replace("{DESCRIPCION_ALTERNATIVA}", $alt->alternativa, $td);
                        //Por cada alternativa, verifico si tiene m?s de una opcion
                        $mas_de_una_opcion = MasDeUnaOpcionPorAlternativa($alt->puntaje, $id_empresa, $id_proceso);
                        if ($mas_de_una_opcion) {
                            //exit("b");
                            $td_options .= file_get_contents("views/sgd/evaluacion/alternativa_options_dinamico.html");
                            $options = "";
                            foreach ($mas_de_una_opcion as $unico) {
                                //exit("c");
                                $options .= file_get_contents("views/sgd/evaluacion/options_dinamico.html");
                                $options    = str_replace("{VALUE}", $unico->valor_puntaje, $options);
                                $td_options = str_replace("{ETIQUETA}", $unico->titulo_opciones, $td_options);
                                $options    = str_replace("{SIGNO}", $unico->signo, $options);
                                $options    = str_replace("{CHECK}", "{SELECT" . $unico->valor_puntaje . "} ", $options);
                            }
                            $td_options = str_replace("{OPTIONS_}", $options, $td_options);
                        } else {
                            $td_options .= file_get_contents("views/sgd/evaluacion/alternativa_options.html");
                            $td_options = str_replace("{VALUE}", $alt->puntaje, $td_options);
                            $td_options = str_replace("{DESCRIPCION_ANTERNATIVA_2}", $alt->alternativa, $td_options);
                            $td_options = str_replace("{SIGNO}", $unico->signo, $td_options);
                            $td_options = str_replace("{CHECK}", "{SELECT" . $alt->puntaje . "} ", $td_options);
                        }
                    }
                    $total_html = str_replace("{NIVELES_TD}", utf8_encode($td), $total_html);
                    $html       = FuncionParaObtenerCalculoMientrasAvanzaPagina($html, $evaluador, $id_proceso, $id_empresa);
                    $row        = BloqueListadoEvaluadosEvalCompetencias($evaluados, $evaluador, $componentes[$pagina - 2]->id_componente, $componentes[$pagina - 2]->id_pregunta, $id_proceso_anterior, $id_proceso, $comentario_obligatorio, $td_options, $template_comentario_por_pregunta);
                    $total_html = str_replace("{LISTADO_COLABORADORES}", ($row[0]), $total_html);
                    $total_html = str_replace("{TOTAL_EVALUADOS}", ($row[1] * 60) / 100, $total_html);
                    $total_html = str_replace("{TOTAL_EVALUADOS_1_2}", ($row[1] * 40) / 100, $total_html);
                    $total_html = str_replace("{TOTAL_EVALUADOS_4_5}", ($row[1] * 40) / 100, $total_html);
                    $total_html = str_replace("{TOTAL_TOTAL_EVALUADOS}", $row[1], $total_html);
                    $total_html = str_replace("{WIDTH_DINAMICO_OPCIONES}", ($width_dinamico_options), $total_html);
                }
                $html = str_replace("{PAGINACION_EVALUACION}", PaginacionSGDPorPreguntasV2($evaluador, $pagina, $id_proceso, count($componentes), "no", $evaluado_individual), $html);
                $html = str_replace("{BARRA_PROGESS}", file_get_contents("views/sgd/evaluacion/barra_progress.html"), $html);
                if ($evaluado_individual) {
                    $porcentaje_avance = AvanceDeEvaluados($evaluador, $id_proceso, "", "", $datos_proceso[0]->id_proceso_anual, $evaluado_individual, "");
                } else {
                    $porcentaje_avance = AvanceDeEvaluados($evaluador, $id_proceso, "", "", $datos_proceso[0]->id_proceso_anual, "", "");
                }
                $html = str_replace("{VALOR_AVANCE}", FormatearPorcentajesSinDecimal($porcentaje_avance[0]), $html);
            } else {
                //Se muestran los objetivos individuales.
                $total_html = file_get_contents("views/sgd/evaluacion/" . $id_empresa . "_entorno_equipo_evaluacion.html");
                if ($_GET["ae"] == 1) {
                    $total_html = str_replace("{SOLO_AE}", "&ae=1", $total_html);
                } else {
                    $total_html = str_replace("{SOLO_AE}", "", $total_html);
                }
                //Primero veo si es que hay registro en la tabla de sesion
                $row = "";
                foreach ($evaluados as $evaluado) {
                    if ($_SESSION["id_empresa"] == 11 or $_SESSION["id_empresa"] == 66 or $_SESSION["id_empresa"] == 74) {
                        $row .= file_get_contents("views/sgd/evaluacion/" . $id_empresa . "_row_colaboradores_evaluacion.html");
                        $row = ColocaDatosUsuario($row, $evaluado->evaluado);
                        $row = str_replace("{LISTADO_OBJETIVOS_A_EVALUAR}", ListadoObjetivosEvaluacion($evaluado->evaluado, $evaluador, $id_proceso, $id_empresa), $row);
                    } else {
                        $row .= file_get_contents("views/sgd/evaluacion/row_colaboradores_evaluacion_dinamico.html");
                        $row = ColocaDatosUsuario($row, $evaluado->evaluado);
                        //$bloque_objetivos_especificos=BloqueListadoObjetivoEspecificos($evaluado->evaluado, $evaluador, $id_proceso, $id_empresa);
                        //$row = str_replace("{LISTADO_OBJETIVOS_A_EVALUAR}",ListadoObjetivosEvaluacion($evaluado->evaluado, $evaluador, $id_proceso),$row);
                        $row = str_replace("{LISTADO_OBJETIVOS_A_EVALUAR}", utf8_encode(BloqueListadoObjetivoEspecificos($evaluado->evaluado, $evaluador, $id_proceso, $id_empresa, "no")), $row);
                    }
                }
                $total_html = str_replace("{LISTADO_COLABORADORES}", ($row), $total_html);
                $total_html = str_replace("{GRAFICO}", "", $total_html);
            }
            $html = str_replace("{PAGINACION_EVALUACION}", PaginacionSGDPorPreguntasV2($evaluador, $pagina, $id_proceso, count($componentes), "si", $evaluado_individual), $html);
        } else {
            /****************************/
            /******************************/
            /********PARA CUANDO NO TIENE OBJETIVOS*/
            /****************************************************************/
            //BLOQUE QUE VALIDA LA CANTIDAD DE RESPUESTAS POR PAGINA JAVASCRIPT
            /****************************************************************/
            //$total_html=file_get_contents("views/sgd/evaluacion/entorno_equipo_evaluacion_competencia.html");
            $total_html = $entorno_eval_competencias;
            if ($datos_proceso[0]->validacion_js_preguntas == 1) {
                $total_html = str_replace("{BLOQUE_FUNCION_JAVASCRIPT_PARA_VALIDAR_CANTIDAD_ALTERNATIVAS}", file_get_contents("views/sgd/evaluacion/funcionValidaCantidadRespuestas.html"), $total_html);
            } else {
                $total_html = str_replace("{BLOQUE_FUNCION_JAVASCRIPT_PARA_VALIDAR_CANTIDAD_ALTERNATIVAS}", file_get_contents("views/sgd/evaluacion/" . $id_empresa . "_funcionNext.html"), $total_html);
            }
            //$total_html = str_replace("{TOTAL_EVALUADOS}",(count($evaluados)*60)/100,$total_html);
            //$total_html = str_replace("{TOTAL_TOTAL_EVALUADOS}",count($evaluados),$total_html);
            //$total_html = str_replace("{TOTAL_EVALUADOS_1_2}",(count($evaluados)*40)/100,$total_html);
            //$total_html = str_replace("{TOTAL_EVALUADOS_4_5}",(count($evaluados)*40)/100,$total_html);
            //Se muestran las competencias para evaluar.
            //Aca verifico si la pagina actual es mayor a la cantidad de paginas//si es asi, lo tiro para afuera, e inserto registro de finalizado.
            if ($pagina > count($componentes)) {
                InsertaEvaluadorFinalizado($evaluador, $id_proceso);
                //Aca ,por cada uno de los evaluados del evaluador, se inserta registro de finalizado evaluado evaluador
                foreach ($evaluados as $evaluad) {
                    InsertaEvaluadoEvaluadorFinalizado($evaluad->evaluado, $evaluador, $id_proceso);
                }
                echo "<script>
                    location.href='?sw=sgd2&ip=" . Encodear3($id_proceso) . "';
                    </script>";
                exit;
            }
            /////////////////*********************************/////////////////////////////
            //SECCION PARA ENCABEZADOS COMPETENCIAS
            if ($componentes[$pagina - 1]->muestra_competencia == 1) {
                $total_html = str_replace("{ENCABEZADO_COMPETENCIA}", file_get_contents("views/sgd/evaluacion/" . $id_empresa . "_encabezado_competencia.html"), $total_html);
                $total_html = str_replace("{COMPETENCIA}", utf8_encode($componentes[$pagina - 1]->nombre), $total_html);
                if (utf8_encode($componentes[$pagina - 1]->imagen_competencia)) {
                    $total_html = str_replace("{IMAGEN_COMPETENCIA}", "<img src='img/" . utf8_encode($componentes[$pagina - 1]->imagen_competencia) . "' width=90>", $total_html);
                } else {
                    $total_html = str_replace("{IMAGEN_COMPETENCIA}", "", $total_html);
                }
                $total_html = str_replace("{DESCRIPCION_COMPETENCIA}", utf8_encode($componentes[$pagina - 1]->descripcion_competencia), $total_html);
            } else {
                $total_html = str_replace("{ENCABEZADO_COMPETENCIA}", "", $total_html);
            }
            /////////////////*********************************/////////////////////////////
            //SECCION PARA ENCABEZADO DIMENSIONES
            if ($componentes[$pagina - 1]->muestra_dimension == 1) {
                $total_html = str_replace("{ENCABEZADO_DIMENSION}", file_get_contents("views/sgd/evaluacion/encabezado_dimension.html"), $total_html);
                $total_html = str_replace("{DIMENSION}", utf8_encode($componentes[$pagina - 1]->nombre_dimension), $total_html);
            } else {
                $total_html = str_replace("{ENCABEZADO_COMPETENCIA}", "", $total_html);
                $total_html = str_replace("{ENCABEZADO_DIMENSION}", "", $total_html);
            }
            if ($componentes[$pagina - 1]->comentario_obligatorio == 1) {
                $comentario_obligatorio = "required";
            } else {
                $comentario_obligatorio = "";
            }
            $total_html                 = str_replace("{ID_ENCODEADO_COMPETENCIA}", $componentes[$pagina - 1]->id_componente, $total_html);
            $total_html                 = str_replace("{ID_COMPETENCIA}", $componentes[$pagina - 1]->id_componente, $total_html);
            $comentario_por_competencia = TieneComentarioPorCompetencia($evaluado_individual, $evaluador, $componentes[$pagina - 1]->id_componente, $id_empresa, $id_proceso);
            $total_html                 = str_replace("{COMENTARIO_POR_COMPETENCIA}", utf8_encode($comentario_por_competencia[0]->comentario), $total_html);
            if ($evaluado_individual) {
                //Traigo las preguntas por la competencia
                $preguntas = PreguntasPorCompetencia($componentes[$pagina - 1]->id_componente);
                foreach ($preguntas as $preg) {
                    // echo "evaluado $evaluado_individual, evaluador $evaluador, idproceso $id_proceso, idpregunta ".$preg->id."<br>";
                    //Aca veo si para esta pregunta, este evaluado para este evaluador tiene respuesta
                    $tiene_respuesta = TieneRespuestaCompetenciaProProceso($evaluado_individual, $evaluador, $preg->id, $id_proceso);
                    $listado_preguntas .= file_get_contents("views/sgd/evaluacion/" . $id_empresa . "_row_pregunta_por_competencia.html");
                    $listado_preguntas = str_replace("{NOMBRE_PREGUNTA}", $preg->pregunta, $listado_preguntas);
                    $alternativas      = AlternativasDadoIdGrupo($preg->id_alternativa);
                    $td_options        = "";
                    foreach ($alternativas as $alt) {
                        $td .= file_get_contents("views/sgd/evaluacion/alternativa_encabezado.html");
                        $td                = str_replace("{DESCRIPCION_ALTERNATIVA}", utf8_encode($alt->alternativa), $td);
                        //Por cada alternativa, verifico si tiene m?s de una opcion
                        $mas_de_una_opcion = MasDeUnaOpcionPorAlternativa($alt->puntaje, $id_empresa, $id_proceso);
                        if ($mas_de_una_opcion) {
                            $td_options .= file_get_contents("views/sgd/evaluacion/alternativa_options_dinamico.html");
                            $options = "";
                            foreach ($mas_de_una_opcion as $unico) {
                                $options .= file_get_contents("views/sgd/evaluacion/options_dinamico.html");
                                $options    = str_replace("{VALUE}", $unico->valor_puntaje, $options);
                                $td_options = str_replace("{ETIQUETA}", $unico->titulo_opciones, $td_options);
                                $options    = str_replace("{SIGNO}", $unico->signo, $options);
                                $options    = str_replace("{CHECK}", "{SELECT" . $unico->valor_puntaje . "} ", $options);
                            }
                            $td_options = str_replace("{OPTIONS_}", $options, $td_options);
                        } else {
                            $td_options .= file_get_contents("views/sgd/evaluacion/alternativa_options.html");
                            if ($tiene_respuesta[0]->puntaje == $alt->puntaje) {
                                $td_options = str_replace("{CHECK}", "checked='checked'", $td_options);
                            } else {
                                $td_options = str_replace("{CHECK}", "", $td_options);
                            }
                            $td_options = str_replace("{VALUE}", $alt->puntaje, $td_options);
                            $td_options = str_replace("{DESCRIPCION_ANTERNATIVA_2}", $alt->alternativa, $td_options);
                            $td_options = str_replace("{SIGNO}", $unico->signo, $td_options);
                            //$td_options = str_replace("{CHECK}","{SELECT".$alt->puntaje."} ",$td_options);
                        }
                    }
                    $listado_preguntas = str_replace("{NIVELES_TD}", $td_options, $listado_preguntas);
                    $listado_preguntas = str_replace("{NOMBRE_RADIO}", $evaluado_individual . "-" . $preg->id, $listado_preguntas);
                    $listado_preguntas = str_replace("{NOMBRE_RADIO_SOLO_PREGUNTA}", $preg->id, $listado_preguntas);
                    $total_html        = str_replace("{NIVELES_TD}", ($td), $total_html);
                }
                $listado_preguntas          = str_replace("{NOMBRE_PREGUNTA}", $preg->pregunta, $listado_preguntas);
                $total_html                 = str_replace("{LISTADO_PREGUNTAS_A_EVALUAR_POR_COMPETENCIAS}", utf8_encode($listado_preguntas), $total_html);
                $total_html                 = str_replace("{EVALUADO_ENCODEADO}", Encodear3($evaluado_individual), $total_html);
                $total_html                 = str_replace("{TOTAL_PREGUNTAS_A_RESPONDER}", count($preguntas), $total_html);
                $comentario_por_competencia = TieneComentarioPorCompetencia($evaluado_individual, $evaluador, $componentes[$pagina - 1]->id_componente, $id_empresa, $id_proceso);
                $total_html                 = str_replace("{COMENTARIO_POR_COMPETENCIA}", utf8_encode($comentario_por_competencia[0]->comentario), $total_html);
            } else {
                //REPLACE PARA LA PREGUNTA
                $total_html = str_replace("{NOMBRE_PREGUNTA}", utf8_encode($componentes[$pagina - 1]->pregunta), $total_html);
                if ($componentes[$pagina - 1]->descripcion) {
                    $total_html = str_replace("{TOOLTIP_DESCRIPCION}", file_get_contents("views/sgd/evaluacion/tooltip_descripcion.html"), $total_html);
                } else {
                    $total_html = str_replace("{TOOLTIP_DESCRIPCION}", "", $total_html);
                }
                $total_html   = str_replace("{DESCRIPCION_PREGUNTA}", utf8_encode($componentes[$pagina - 1]->descripcion), $total_html);
                $total_html   = str_replace("{ID_PREGUNTA_ENCODEADA}", $componentes[$pagina - 1]->id_pregunta, $total_html);
                $alternativas = AlternativasDadoIdGrupo($componentes[$pagina - 1]->id_alternativa);
                //Esta codicion es para ver si es que tiene o no comentariop
                //Si tiene, se coloca el encabezado
                if ($componentes[$pagina - 1]->tiene_comentarios == 1) {
                    $template_comentario_por_pregunta = file_get_contents("views/sgd/evaluacion/comentario_por_pregunta.html");
                    //Este es para colocar el width dinamico
                    $rowspan_tiene_comentario         = "rowspan='2'";
                } else {
                    //$total_html = str_replace("{SECCION_ENCABEADO_COMENTARIO}","",$total_html);
                    $template_comentario_por_pregunta = "";
                    $rowspan_tiene_comentario         = "";
                }
                $width_dinamico_options = FormatearPorcentajesSinDecimal(100 / (count($alternativas)));
                foreach ($alternativas as $alt) {
                    $td .= file_get_contents("views/sgd/evaluacion/alternativa_encabezado.html");
                    $td                = str_replace("{DESCRIPCION_ALTERNATIVA}", $alt->alternativa, $td);
                    //Por cada alternativa, verifico si tiene m?s de una opcion
                    $mas_de_una_opcion = MasDeUnaOpcionPorAlternativa($alt->puntaje, $id_empresa, $id_proceso);
                    if ($mas_de_una_opcion) {
                        $td_options .= file_get_contents("views/sgd/evaluacion/alternativa_options_dinamico.html");
                        $options = "";
                        foreach ($mas_de_una_opcion as $unico) {
                            $options .= file_get_contents("views/sgd/evaluacion/options_dinamico.html");
                            $options    = str_replace("{VALUE}", $unico->valor_puntaje, $options);
                            $td_options = str_replace("{ETIQUETA}", $unico->titulo_opciones, $td_options);
                            $options    = str_replace("{SIGNO}", $unico->signo, $options);
                            $options    = str_replace("{CHECK}", "{SELECT" . $unico->valor_puntaje . "} ", $options);
                        }
                        $td_options = str_replace("{OPTIONS_}", $options, $td_options);
                    } else {
                        $td_options .= file_get_contents("views/sgd/evaluacion/alternativa_options.html");
                        $td_options = str_replace("{VALUE}", $alt->puntaje, $td_options);
                        $td_options = str_replace("{SIGNO}", $unico->signo, $td_options);
                        $td_options = str_replace("{CHECK}", "{SELECT" . $alt->puntaje . "} ", $td_options);
                    }
                }
                $total_html = str_replace("{NIVELES_TD}", utf8_encode($td), $total_html);
                $html       = FuncionParaObtenerCalculoMientrasAvanzaPagina($html, $evaluador, $id_proceso, $id_empresa);
                $row        = BloqueListadoEvaluadosEvalCompetencias($evaluados, $evaluador, $componentes[$pagina - 1]->id_componente, $componentes[$pagina - 1]->id_pregunta, $id_proceso_anterior, $id_proceso, $comentario_obligatorio, $td_options, $template_comentario_por_pregunta);
                $total_html = str_replace("{LISTADO_COLABORADORES}", ($row[0]), $total_html);
                $total_html = str_replace("{TOTAL_EVALUADOS}", ($row[1] * 60) / 100, $total_html);
                $total_html = str_replace("{TOTAL_EVALUADOS_1_2}", ($row[1] * 40) / 100, $total_html);
                $total_html = str_replace("{TOTAL_EVALUADOS_4_5}", ($row[1] * 40) / 100, $total_html);
                $total_html = str_replace("{TOTAL_TOTAL_EVALUADOS}", $row[1], $total_html);
                $total_html = str_replace("{WIDTH_DINAMICO_OPCIONES}", ($width_dinamico_options), $total_html);
            }
            $html = str_replace("{PAGINACION_EVALUACION}", PaginacionSGDPorPreguntasV2($evaluador, $pagina, $id_proceso, count($componentes), "no", $evaluado_individual), $html);
            $html = str_replace("{BARRA_PROGESS}", file_get_contents("views/sgd/evaluacion/barra_progress.html"), $html);
            if ($evaluado_individual) {
                $porcentaje_avance = AvanceDeEvaluados($evaluador, $id_proceso, "", "", $datos_proceso[0]->id_proceso_anual, $evaluado_individual, "");
            } else {
                $porcentaje_avance = AvanceDeEvaluados($evaluador, $id_proceso, "", "", $datos_proceso[0]->id_proceso_anual, "", "");
            }
            $html = str_replace("{VALOR_AVANCE}", FormatearPorcentajesSinDecimal($porcentaje_avance[0]), $html);
        }
    } else {
        $total_html = "<div>Proceso no Activado o no tiene evaluados</div>";
    }
    $html = str_replace("{ENTORNO_LISTADO_EVALUACION}", ($total_html), $html);
    return ($html);
}
function formatearFecha($valor_fecha)
{
    $dia = date("d", strtotime($valor_fecha));
    $mes = devuelveNombreMes(date("m", strtotime($valor_fecha)));
    return ($dia . " de " . $mes);
    //return($fecha2=date("d-m",strtotime($valor_fecha)));
}
function formatearFechaSmall($valor_fecha)
{
    $d = date("d", strtotime($valor_fecha));
    $m = date("m", strtotime($valor_fecha));
    $a = date("Y", strtotime($valor_fecha));
    return ($d . "-" . $m . "-" . $a);
    //return($fecha2=date("d-m",strtotime($valor_fecha)));
}
function formatearFechaCompleta($valor_fecha)
{
    $dia = date("d", strtotime($valor_fecha));
    $mes = devuelveNombreMes(date("m", strtotime($valor_fecha)));
    $ano = date("Y", strtotime($valor_fecha));
    //return($fecha2=date("d-m-Y",strtotime($valor_fecha)));
    return ($dia . " de " . $mes . " de " . $ano);
}
function ListadoMensajesPrincipalesAgente($PRINCIPAL, $rut, $id_empresa, $filtro_destinatario, $id_curso, $id_objeto, $vista_agente, $rut_agente)
{
    if ($rut_agente) {
        $mensajes = TotalMensajesPorRutEmpresaAgenteFiltroAgente($rut, $id_empresa, $rut_agente);
    } else {
        $mensajes = TotalMensajesPorRutEmpresaAgente($rut, $id_empresa);
    }
    //Coloca DAtos de Agente (Campo JEfe tbl_usuarios)
    $datos_agente     = DatosMiAgente($rut, $id_empresa);
    $PRINCIPAL        = str_replace("{NOMBRE_AGENTE}", $datos_agente[0]->nombre_completo, $PRINCIPAL);
    $PRINCIPAL        = str_replace("{CARGO_AGENTE}", $datos_agente[0]->cargo, $PRINCIPAL);
    $PRINCIPAL        = str_replace("{EMAIL_AGENTE}", $datos_agente[0]->email, $PRINCIPAL);
    $PRINCIPAL        = str_replace("{TELEFONO_AGENTE}", $datos_agente[0]->telefono, $PRINCIPAL);
    $PRINCIPAL        = str_replace("{URL_IMAGEN_AGENTE}", VerificaFotoPersonal($datos_agente[0]->jefe), $PRINCIPAL);
    $usuario_en_curso = CI_verificausuariocurso($rut, $id_curso, $id_empresa);
    if ($usuario_en_curso[0]->relator == 1) {
        $PRINCIPAL = str_replace("{BOTON_PREGUNTAR}", "", $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BOTON_PREGUNTAR}", file_get_contents("views/mensajeria/" . $id_empresa . "_boton_preguntar.html"), $PRINCIPAL);
    }
    if ($mensajes) {
        //print_r($mensajes);
        foreach ($mensajes as $unico) {
            if ($usuario_en_curso[0]->relator == 1) {
                $row .= file_get_contents("views/mensajeria/" . $id_empresa . "_row_mensaje_principal_relator.html");
                $row = str_replace("{BLOQUE_RESPUESTA_RAPIDA}", file_get_contents("views/mensajeria/" . $id_empresa . "_bloque_respuesta_rapida_usuario_relator.html"), $row);
                $row = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($id_objeto), $row);
                $row = str_replace("{ID_CURSO_ENCODEADO}", Encodear3($id_curso), $row);
            } else {
                if ($rut_agente) {
                    $row .= file_get_contents("views/mensajeria/" . $id_empresa . "_row_mensaje_principal_agente.html");
                    $row = str_replace("{RUT_AGENTE}", ($rut_agente), $row);
                } else {
                    $row .= file_get_contents("views/mensajeria/" . $id_empresa . "_row_mensaje_principal.html");
                }
                $row = str_replace("{BLOQUE_RESPUESTA_RAPIDA}", file_get_contents("views/mensajeria/" . $id_empresa . "_bloque_respuesta_rapida_usuario.html"), $row);
            }
            //print_r($unico);
            $row                   = str_replace("{ID_COMENTARIO}", $unico->id, $row);
            $row                   = str_replace("{ID_MENSAJE_ENCODEADO}", Encodear3($unico->id), $row);
            $row                   = str_replace("{NOMBRE_CREADOR}", $unico->nombre_creador . " " . $unico->apaterno . " " . $unico->amaterno, $row);
            $row                   = str_replace("{URL_PERSONA}", VerificaFotoPersonal($unico->rut_creador), $row);
            $row                   = str_replace("{NOMBRE_DESTINATARIO}", $unico->nombre_tipo_destinatario, $row);
            $row                   = str_replace("{ASUNTO}", $unico->nombre_titulo, $row);
            $row                   = str_replace("{MENSAJE}", utf8_encode($unico->mensaje), $row);
            $estado                = EstadoMensajeria($unico->id);
            $row                   = str_replace("{ESTADO}", $estado[1], $row);
            $row                   = str_replace("{FECHA}", formatearFechaCompleta($unico->fecha), $row);
            $row                   = str_replace("{CANTIDAD_RESPUESTAS}", ($unico->total_comen), $row);
            $respuesta_por_mensaje = RespuestasPorMensaje($unico->id);
            if ($respuesta_por_mensaje) {
                $row_resp = "";
                foreach ($respuesta_por_mensaje as $resp) {
                    $row_resp .= file_get_contents("views/mensajeria/" . $id_empresa . "_bloque_listado_respuesta.html");
                    $row_resp  = str_replace("{URL_PERSONA}", VerificaFotoPersonal($resp->rut_creador), $row_resp);
                    $row_resp  = str_replace("{RUT_USUARIO_ENCODEADO}", Encodear3($resp->rut_creador), $row_resp);
                    $row_resp  = str_replace("{NOMBRE}", ($resp->nombre) . " " . $resp->amaterno . " " . $resp->apaterno, $row_resp);
                    $row_resp  = str_replace("{CARGO}", $resp->cargo, $row_resp);
                    $row_resp  = str_replace("{MENSAJE_RESPUESTA}", utf8_encode($resp->mensaje), $row_resp);
                    $hora      = $resp->hora;
                    $nuevaHora = strtotime('-7 hour', strtotime($hora));
                    $nuevaHora = date('H:i:s', $nuevaHora);
                    $row_resp  = str_replace("{FECHA_RESPUESTA}", formatearFechaCompleta($resp->fecha), $row_resp);
                }
                $row = str_replace("{BLOQUE_LISTADO_RESPUESTAS}", $row_resp, $row);
            } else {
                $row = str_replace("{BLOQUE_LISTADO_RESPUESTAS}", "", $row);
            }
        }
        $PRINCIPAL = str_replace("{LISTADO_MENSAJES_PRINCIPALES}", $row, $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{LISTADO_MENSAJES_PRINCIPALES}", "No hay preguntas", $PRINCIPAL);
    }
    //Aca verifico si el usuario, con el rut, est? en el listado de los remitentes
    $es_admini_mensajeria = EsDestinatarioMensajeria($rut);
    if ($id_objeto && $id_curso) {
        //Aca veo si el usuario es relator de este curso, si es asi, le muestro el boton de responder
        $usuario_en_curso = CI_verificausuariocurso($rut, $id_curso, $id_empresa);
        if ($usuario_en_curso[0]->relator == 1) {
            $PRINCIPAL = str_replace("{BOTONERA_ADMINISTRACION}", file_get_contents("views/mensajeria/" . $id_empresa . "_botones_administracion.html"), $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{BOTONERA_ADMINISTRACION}", "", $PRINCIPAL);
        }
    } else if ($es_admini_mensajeria) {
        $PRINCIPAL = str_replace("{BOTONERA_ADMINISTRACION}", file_get_contents("views/mensajeria/" . $id_empresa . "_botones_administracion.html"), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BOTONERA_ADMINISTRACION}", "", $PRINCIPAL);
    }
    //$PRINCIPAL = str_replace("{OPTIONS_DESTINATARIOS}",OptionsGenericoNombreDadoValoresPorEmpresa("tbl_mensajes_destinatarios", "",  "nombre", "id", "order by nombre asc", $id_empresa, ""),$PRINCIPAL);
    $PRINCIPAL = str_replace("{OPTIONS_DESTINATARIOS}", OptionDestinatariosPorUsuario($filtro_destinatario, "", $id_empresa), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ListadoMensajesPrincipales($PRINCIPAL, $rut, $id_empresa, $filtro_destinatario, $id_curso, $id_objeto)
{
    if ($id_objeto && $id_curso) {
        $mensajes = TotalMensajesPorEmpresaCursoObjeto($id_empresa, $id_curso, $id_objeto);
    } else if ($filtro_destinatario) {
        $mensajes = TotalMensajesPorRutEmpresaPorTipoDestinatario($rut, $id_empresa, $filtro_destinatario);
    } else {
        $mensajes = TotalMensajesPorRutEmpresa($rut, $id_empresa);
    }
    $usuario_en_curso = CI_verificausuariocurso($rut, $id_curso, $id_empresa);
    if ($usuario_en_curso[0]->relator == 1) {
        $PRINCIPAL = str_replace("{BOTON_PREGUNTAR}", "", $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BOTON_PREGUNTAR}", file_get_contents("views/mensajeria/" . $id_empresa . "_boton_preguntar.html"), $PRINCIPAL);
    }
    if ($mensajes) {
        //print_r($mensajes);
        foreach ($mensajes as $unico) {
            if ($usuario_en_curso[0]->relator == 1) {
                $row .= file_get_contents("views/mensajeria/" . $id_empresa . "_row_mensaje_principal_relator.html");
                $row = str_replace("{BLOQUE_RESPUESTA_RAPIDA}", file_get_contents("views/mensajeria/" . $id_empresa . "_bloque_respuesta_rapida_usuario_relator.html"), $row);
                $row = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($id_objeto), $row);
                $row = str_replace("{ID_CURSO_ENCODEADO}", Encodear3($id_curso), $row);
            } else {
                $row .= file_get_contents("views/mensajeria/" . $id_empresa . "_row_mensaje_principal.html");
                $row = str_replace("{BLOQUE_RESPUESTA_RAPIDA}", file_get_contents("views/mensajeria/" . $id_empresa . "_bloque_respuesta_rapida_usuario.html"), $row);
            }
            //print_r($unico);
            $row                   = str_replace("{ID_COMENTARIO}", $unico->id, $row);
            $row                   = str_replace("{ID_MENSAJE_ENCODEADO}", Encodear3($unico->id), $row);
            $row                   = str_replace("{NOMBRE_CREADOR}", $unico->nombre_creador . " " . $unico->apaterno . " " . $unico->amaterno, $row);
            $row                   = str_replace("{URL_PERSONA}", VerificaFotoPersonal($unico->rut_creador), $row);
            $row                   = str_replace("{NOMBRE_DESTINATARIO}", $unico->nombre_tipo_destinatario, $row);
            $row                   = str_replace("{ASUNTO}", $unico->nombre_titulo, $row);
            $row                   = str_replace("{MENSAJE}", utf8_encode($unico->mensaje), $row);
            $estado                = EstadoMensajeria($unico->id);
            $row                   = str_replace("{ESTADO}", $estado[1], $row);
            $row                   = str_replace("{FECHA}", formatearFechaCompleta($unico->fecha), $row);
            $row                   = str_replace("{CANTIDAD_RESPUESTAS}", ($unico->total_comen), $row);
            $respuesta_por_mensaje = RespuestasPorMensaje($unico->id);
            if ($respuesta_por_mensaje) {
                $row_resp = "";
                foreach ($respuesta_por_mensaje as $resp) {
                    $row_resp .= file_get_contents("views/mensajeria/" . $id_empresa . "_bloque_listado_respuesta.html");
                    $row_resp  = str_replace("{URL_PERSONA}", VerificaFotoPersonal($resp->rut_creador), $row_resp);
                    $row_resp  = str_replace("{RUT_USUARIO_ENCODEADO}", Encodear3($resp->rut_creador), $row_resp);
                    $row_resp  = str_replace("{NOMBRE}", ($resp->nombre) . " " . $resp->amaterno . " " . $resp->apaterno, $row_resp);
                    $row_resp  = str_replace("{CARGO}", $resp->cargo, $row_resp);
                    $row_resp  = str_replace("{MENSAJE_RESPUESTA}", utf8_encode($resp->mensaje), $row_resp);
                    $hora      = $resp->hora;
                    $nuevaHora = strtotime('-7 hour', strtotime($hora));
                    $nuevaHora = date('H:i:s', $nuevaHora);
                    $row_resp  = str_replace("{FECHA_RESPUESTA}", formatearFechaCompleta($resp->fecha), $row_resp);
                }
                $row = str_replace("{BLOQUE_LISTADO_RESPUESTAS}", $row_resp, $row);
            } else {
                $row = str_replace("{BLOQUE_LISTADO_RESPUESTAS}", "", $row);
            }
        }
        $PRINCIPAL = str_replace("{LISTADO_MENSAJES_PRINCIPALES}", $row, $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{LISTADO_MENSAJES_PRINCIPALES}", "No hay preguntas", $PRINCIPAL);
    }
    //Aca verifico si el usuario, con el rut, est? en el listado de los remitentes
    $es_admini_mensajeria = EsDestinatarioMensajeria($rut);
    if ($id_objeto && $id_curso) {
        //Aca veo si el usuario es relator de este curso, si es asi, le muestro el boton de responder
        $usuario_en_curso = CI_verificausuariocurso($rut, $id_curso, $id_empresa);
        if ($usuario_en_curso[0]->relator == 1) {
            $PRINCIPAL = str_replace("{BOTONERA_ADMINISTRACION}", file_get_contents("views/mensajeria/" . $id_empresa . "_botones_administracion.html"), $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{BOTONERA_ADMINISTRACION}", "", $PRINCIPAL);
        }
    } else if ($es_admini_mensajeria) {
        $PRINCIPAL = str_replace("{BOTONERA_ADMINISTRACION}", file_get_contents("views/mensajeria/" . $id_empresa . "_botones_administracion.html"), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BOTONERA_ADMINISTRACION}", "", $PRINCIPAL);
    }
    //$PRINCIPAL = str_replace("{OPTIONS_DESTINATARIOS}",OptionsGenericoNombreDadoValoresPorEmpresa("tbl_mensajes_destinatarios", "",  "nombre", "id", "order by nombre asc", $id_empresa, ""),$PRINCIPAL);
    $PRINCIPAL = str_replace("{OPTIONS_DESTINATARIOS}", OptionDestinatariosPorUsuario($filtro_destinatario, "", $id_empresa), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ListadoMensajesPrincipalesParaResponder($PRINCIPAL, $rut, $id_empresa, $filtro_destinatario, $id_curso, $id_objeto)
{
    //Traigo el listado de los mensajes, filtrado por empresa y por RUT
    if ($id_objeto && $id_curso) {
        $mensajes = TotalMensajesPorEmpresaCursoObjeto($id_empresa, $id_curso, $id_objeto);
    } else if ($filtro_destinatario) {
        $mensajes = TotalMensajesPorRutDestinatarioPerfilado($rut, $id_empresa, $filtro_destinatario);
    } else {
        $mensajes = TotalMensajesPorRutDestinatario($rut, $id_empresa);
    }
    if ($mensajes) {
        foreach ($mensajes as $unico) {
            $row .= file_get_contents("views/mensajeria/row_mensaje_principal_admin.html");
            $row                   = str_replace("{BLOQUE_RESPUESTA_RAPIDA}", file_get_contents("views/mensajeria/bloque_respuesta_rapida.html"), $row);
            $row                   = str_replace("{ID_COMENTARIO}", $unico->id, $row);
            $row                   = str_replace("{NOMBRE_CREADOR}", $unico->nombre_creador . " " . $unico->apaterno . " " . $unico->amaterno, $row);
            $row                   = str_replace("{NOMBRE_DESTINATARIO}", $unico->nombre_tipo_destinatario, $row);
            $row                   = str_replace("{ASUNTO}", $unico->nombre_titulo, $row);
            $row                   = str_replace("{MENSAJE}", $unico->mensaje, $row);
            $row                   = str_replace("{FECHA}", formatearFechaCompleta($unico->fecha), $row);
            $estado                = EstadoMensajeria($unico->id);
            $row                   = str_replace("{ESTADO}", $estado[1], $row);
            $row                   = str_replace("{FECHA}", formatearFechaCompleta($unico->fecha), $row);
            $row                   = str_replace("{CANTIDAD_RESPUESTAS}", ($unico->total_comen), $row);
            $respuesta_por_mensaje = RespuestasPorMensaje($unico->id);
            if ($respuesta_por_mensaje) {
                $row_resp = "";
                foreach ($respuesta_por_mensaje as $resp) {
                    $row_resp .= file_get_contents("views/mensajeria/bloque_listado_respuesta.html");
                    $row_resp  = str_replace("{URL_PERSONA}", VerificaFotoPersonal($resp->rut_creador), $row_resp);
                    $row_resp  = str_replace("{RUT_USUARIO_ENCODEADO}", Encodear3($resp->rut_creador), $row_resp);
                    $row_resp  = str_replace("{NOMBRE}", ($resp->nombre) . " " . $resp->amaterno . " " . $resp->apaterno, $row_resp);
                    $row_resp  = str_replace("{CARGO}", $resp->cargo, $row_resp);
                    $row_resp  = str_replace("{MENSAJE_RESPUESTA}", $resp->mensaje, $row_resp);
                    $hora      = $resp->hora;
                    $nuevaHora = strtotime('-7 hour', strtotime($hora));
                    $nuevaHora = date('H:i:s', $nuevaHora);
                    $row_resp  = str_replace("{FECHA_RESPUESTA}", formatearFechaCompleta($resp->fecha) . "<br>" . $nuevaHora, $row_resp);
                }
                $row = str_replace("{BLOQUE_LISTADO_RESPUESTAS}", $row_resp, $row);
            } else {
                $row = str_replace("{BLOQUE_LISTADO_RESPUESTAS}", "", $row);
            }
        }
        $PRINCIPAL = str_replace("{LISTADO_MENSAJES_PRINCIPALES}", $row, $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{LISTADO_MENSAJES_PRINCIPALES}", "No posee mensajes enviados al Administrador para responder", $PRINCIPAL);
    }
    //Aca verifico si el usuario, con el rut, est? en el listado de los remitentes
    $es_admini_mensajeria = EsDestinatarioMensajeria($rut);
    if ($id_objeto && $id_curso) {
        //Aca veo si el usuario es relator de este curso, si es asi, le muestro el boton de responder
        $usuario_en_curso = CI_verificausuariocurso($rut, $id_curso, $id_empresa);
        if ($usuario_en_curso[0]->relator == 1) {
            $PRINCIPAL = str_replace("{BOTONERA_ADMINISTRACION}", file_get_contents("views/mensajeria/" . $id_empresa . "_botones_administracion.html"), $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{BOTONERA_ADMINISTRACION}", "", $PRINCIPAL);
        }
    } else if ($es_admini_mensajeria) {
        $PRINCIPAL = str_replace("{BOTONERA_ADMINISTRACION}", file_get_contents("views/mensajeria/botones_administracion.html"), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BOTONERA_ADMINISTRACION}", "", $PRINCIPAL);
    }
    $PRINCIPAL = str_replace("{OPTIONS_DESTINATARIOS_ADMIN}", OptionDestinatariosPorUsuario($filtro_destinatario, $rut, $id_empresa), $PRINCIPAL);
    //Bloque de las dem?s respuestas
    return ($PRINCIPAL);
}
function ColocaFormularioMensaje($PRINCIPAL, $id_empresa)
{
    $PRINCIPAL = str_replace("{OPTIONS_TIPO_MENSAJE}", OptionsGenericoNombreDadoValoresPorEmpresa("tbl_mensaje_tipo", "", "nombre", "id", "order by orden asc", $id_empresa), $PRINCIPAL);
    $PRINCIPAL = str_replace("{OPTIONS_TIPO_DESTINATARIO}", OptionsGenericoNombreDadoValoresPorEmpresa("tbl_mensajes_destinatarios", "", "nombre", "id", "order by nombre asc", $id_empresa), $PRINCIPAL);
    return ($PRINCIPAL);
}
function colocarColaboradoresPorRut($PRINCIPAL, $id_empresa, $rut)
{
    $listado_colaboradores = TotalUsuariosPorRutJefe($rut);
    if ($listado_colaboradores) {
        $PRINCIPAL = str_replace("{BLOQUE_COLABORADORES}", file_get_contents("views/miperfil/bloque_mis_colaboradores.html"), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_COLABORADORES}", "", $PRINCIPAL);
    }
    foreach ($listado_colaboradores as $unico) {
        $row .= file_get_contents("views/miperfil/row_colaboradores_miperfil.html");
        $row = str_replace("{NOMBRE}", $unico->nombre . " " . $unico->apaterno . " " . $unico->amaterno, $row);
        $row = str_replace("{CARGO}", $unico->cargo, $row);
        $row = str_replace("{FECHA_CUMPLEANOS}", formatearFecha($unico->fecha_nacimiento), $row);
        $row = str_replace("{URL_PERSONA}", VerificaFotoPersonal($unico->rut), $row);
        $row = str_replace("{RUT_ENCODEADO}", Encodear3($unico->rut), $row);
    }
    $PRINCIPAL = str_replace("{LISTADO_COLABORADORES_DIRECTOS}", utf8_encode($row), $PRINCIPAL);
    return ($PRINCIPAL);
}
function MuestraEvaluacionFeedback($id_evaluacion, $rut)
{
    $id_empresa               = $_SESSION["id_empresa"];
    //function MuestraEvaluacion($PRINCIPAL, $id_evaluacion, $rut){
    //ID_EVALUACION CORRESPONDE AL ID DEL OBJETO
    $datos_objeto             = DatosObjeto($id_evaluacion);
    $id_evaluacion_por_objeto = $datos_objeto[0]->id_evaluacion; //Id de la evaluacion. Este es el que se obtiene desde el campo id evaluacion de la tabla objeto
    $datos_evaluacion         = DatosEvaluacion($datos_objeto[0]->id_evaluacion);
    //Veo si est? en la tabla sesion esta evaluacion, y este usuario
    $tiene_sesion             = SesionEvaluacionContenidos($id_evaluacion, $rut);
    $total_preguntas          = PreguntasDadoEvaluacion($id_evaluacion_por_objeto);
    //ACA VALIDA SI ES QUE EL OBJETO, QUE CONTIENE ESTA EVALUACION, TIENE PREGUNTAS ALEATORIAS O NO.
    //SI NO TIENE ALEATORIAS, LAS MUESTRA TODAS
    if ($datos_objeto[0]->preguntas_aleatorias > 0) {
        //Asigno a una tabla,si es que no esta asignado obviamente. La cantidad que corresponda de preguntas, asociadas al rut, curso y objeto.
        $tiene_preguntas_asociadas = VerificaSiTienePReguntasAsociadasRandomicas($rut, $id_evaluacion_por_objeto, $datos_objeto[0]->id);
        if (count($tiene_preguntas_asociadas) == 0) {
            shuffle($total_preguntas);
            $vueltas = 1;
            foreach ($total_preguntas as $pre) {
                InsertoRegistroPreguntasAleatorias($rut, $id_evaluacion_por_objeto, $datos_objeto[0]->id, $vueltas, $pre->id, $datos_objeto[0]->id_curso);
                if ($vueltas == $datos_objeto[0]->preguntas_aleatorias)
                    break;
                $vueltas++;
            }
        }
        if ($tiene_sesion) {
            //echo "1.1<br>";
            $pagina             = $tiene_sesion[0]->pagina - 1;
            $pregunta           = PreguntaDeEvaluacionAleatorias($id_evaluacion_por_objeto, $pagina, $rut);
            //echo "views/cursos/evaluacion/".$pregunta[0]->template_pregunta_feedback;
            $PRINCIPAL          = FuncionesTransversales(file_get_contents("views/cursos/evaluacion/" . $pregunta[0]->template_pregunta_feedback));
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA}", ($pregunta[0]->pregunta), $PRINCIPAL);
            //Funcion para mostrar las alternativas
            $PRINCIPAL          = str_replace("{OPCIONES}", MuestraAlternativas($pregunta[0]->id_grupo_alternativas, $pregunta[0]->id), $PRINCIPAL);
            $PRINCIPAL          = str_replace("{ID_PREGUNTA_ENCODEADO}", Encodear3($pregunta[0]->id), $PRINCIPAL);
            $PRINCIPAL          = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($id_evaluacion), $PRINCIPAL);
            $PRINCIPAL          = str_replace("{URL_IMAGEN}", $pregunta[0]->url_archivo, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{NUMERO_PREGUNTA}", $pagina, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_BAJADA1}", $pregunta[0]->bajada1, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_BAJADA2}", $pregunta[0]->bajada2, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_BAJADA3}", $pregunta[0]->bajada3, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_BAJADA4}", $pregunta[0]->bajada4, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_REFUERZO1}", $pregunta[0]->refuerzo1, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_REFUERZO2}", $pregunta[0]->refuerzo2, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_REFUERZO3}", $pregunta[0]->refuerzo3, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_REFUERZO4}", $pregunta[0]->refuerzo4, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_REFUERZO5}", $pregunta[0]->refuerzo5, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_REFUERZO6}", $pregunta[0]->refuerzo6, $PRINCIPAL);
            $respuesta_correcta = ObtenerRespuestaDeUsuario($pregunta[0]->id, $rut);
            if ($respuesta_correcta[0]->correcta == "1") {
                $PRINCIPAL = str_replace("{RESULTADO}", "CORRECTO", $PRINCIPAL);
                $PRINCIPAL = str_replace("{CLASERESULTADO}", "feedbackcorrecto", $PRINCIPAL);
            } else {
                $PRINCIPAL = str_replace("{RESULTADO}", "INCORRECTO", $PRINCIPAL);
                $PRINCIPAL = str_replace("{CLASERESULTADO}", "feedbackincorrecto", $PRINCIPAL);
            }
        } else {
            $pagina = 1;
            //Ingreso el registro de la sesion con pagina 1
            InsertaRegistroTablaSesionEvaluacionContenido($rut, $id_evaluacion, $pagina);
            $pregunta           = PreguntaDeEvaluacionAleatorias($id_evaluacion_por_objeto, $pagina, $rut);
            $PRINCIPAL          = FuncionesTransversales(file_get_contents("views/cursos/evaluacion/" . $pregunta[0]->template_pregunta_feedback));
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA}", ($pregunta[0]->pregunta), $PRINCIPAL);
            //Funcion para mostrar las alternativas
            $PRINCIPAL          = str_replace("{OPCIONES}", MuestraAlternativas($pregunta[0]->id_grupo_alternativas, $pregunta[0]->id), $PRINCIPAL);
            $PRINCIPAL          = str_replace("{ID_PREGUNTA_ENCODEADO}", Encodear3($pregunta[0]->id), $PRINCIPAL);
            $PRINCIPAL          = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($id_evaluacion), $PRINCIPAL);
            $PRINCIPAL          = str_replace("{NUMERO_PREGUNTA}", $pagina, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_BAJADA1}", $pregunta[0]->bajada1, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_BAJADA2}", $pregunta[0]->bajada2, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_BAJADA3}", $pregunta[0]->bajada3, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_BAJADA4}", $pregunta[0]->bajada4, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_REFUERZO1}", $pregunta[0]->refuerzo1, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_REFUERZO2}", $pregunta[0]->refuerzo2, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_REFUERZO3}", $pregunta[0]->refuerzo3, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_REFUERZO4}", $pregunta[0]->refuerzo4, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_REFUERZO5}", $pregunta[0]->refuerzo5, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_REFUERZO6}", $pregunta[0]->refuerzo6, $PRINCIPAL);
            $respuesta_correcta = ObtenerRespuestaDeUsuario($pregunta[0]->id, $rut);
            if ($respuesta_correcta[0]->correcta == "1") {
                $PRINCIPAL = str_replace("{RESULTADO}", "CORRECTO", $PRINCIPAL);
                $PRINCIPAL = str_replace("{CLASERESULTADO}", "feedbackcorrecto", $PRINCIPAL);
            } else {
                $PRINCIPAL = str_replace("{RESULTADO}", "INCORRECTO", $PRINCIPAL);
                $PRINCIPAL = str_replace("{CLASERESULTADO}", "feedbackincorrecto", $PRINCIPAL);
            }
        }
    } else {
        if ($tiene_sesion) {
            //$pagina=$tiene_sesion[0]->pagina;
            $pagina             = $tiene_sesion[0]->pagina - 1;
            $pregunta           = PreguntaDeEvaluacion($id_evaluacion_por_objeto, $pagina);
            $PRINCIPAL          = FuncionesTransversales(file_get_contents("views/cursos/evaluacion/" . $pregunta[0]->template_pregunta_feedback));
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA}", ($pregunta[0]->pregunta), $PRINCIPAL);
            //Funcion para mostrar las alternativas
            $PRINCIPAL          = str_replace("{OPCIONES}", MuestraAlternativas($pregunta[0]->id_grupo_alternativas, $pregunta[0]->id), $PRINCIPAL);
            $PRINCIPAL          = str_replace("{ID_PREGUNTA_ENCODEADO}", Encodear3($pregunta[0]->id), $PRINCIPAL);
            $PRINCIPAL          = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($id_evaluacion), $PRINCIPAL);
            $PRINCIPAL          = str_replace("{URL_IMAGEN}", $pregunta[0]->url_archivo, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{NUMERO_PREGUNTA}", $pregunta[0]->orden, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_BAJADA1}", $pregunta[0]->bajada1, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_BAJADA2}", $pregunta[0]->bajada2, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_BAJADA3}", $pregunta[0]->bajada3, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_BAJADA4}", $pregunta[0]->bajada4, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_REFUERZO1}", $pregunta[0]->refuerzo1, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_REFUERZO2}", $pregunta[0]->refuerzo2, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_REFUERZO3}", $pregunta[0]->refuerzo3, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_REFUERZO4}", $pregunta[0]->refuerzo4, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_REFUERZO5}", $pregunta[0]->refuerzo5, $PRINCIPAL);
            $PRINCIPAL          = str_replace("{TEXTO_PREGUNTA_REFUERZO6}", $pregunta[0]->refuerzo6, $PRINCIPAL);
            $respuesta_correcta = ObtenerRespuestaDeUsuario($pregunta[0]->id, $rut);
            if ($respuesta_correcta[0]->correcta == "1") {
                $PRINCIPAL = str_replace("{RESULTADO}", "CORRECTO", $PRINCIPAL);
                $PRINCIPAL = str_replace("{CLASERESULTADO}", "feedbackcorrecto", $PRINCIPAL);
            } else {
                $PRINCIPAL = str_replace("{RESULTADO}", "INCORRECTO", $PRINCIPAL);
                $PRINCIPAL = str_replace("{CLASERESULTADO}", "feedbackincorrecto", $PRINCIPAL);
            }
        } else {
            $pagina   = 1;
            //obtengo la primera pregunta
            $pregunta = PreguntaDeEvaluacion($id_evaluacion_por_objeto, $pagina1);
            //Inserto en la tabla de sesion la pgina 1.
            InsertaRegistroTablaSesionEvaluacionContenido($rut, $id_evaluacion, "1");
            $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/evaluacion/" . $pregunta[0]->template_pregunta_feedback));
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA}", ($pregunta[0]->pregunta), $PRINCIPAL);
            //Funcion para mostrar las alternativas
            $PRINCIPAL = str_replace("{OPCIONES}", MuestraAlternativas($pregunta[0]->id_grupo_alternativas, $pregunta[0]->id), $PRINCIPAL);
            $PRINCIPAL = str_replace("{ID_PREGUNTA_ENCODEADO}", Encodear3($pregunta[0]->id), $PRINCIPAL);
            $PRINCIPAL = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($id_evaluacion), $PRINCIPAL);
            $PRINCIPAL = str_replace("{NUMERO_PREGUNTA}", $pregunta[0]->orden, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA1}", $pregunta[0]->bajada1, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA2}", $pregunta[0]->bajada2, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA3}", $pregunta[0]->bajada3, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA4}", $pregunta[0]->bajada4, $PRINCIPAL);
        }
    }
    //PAGINACION////////////
    if ($datos_objeto[0]->preguntas_aleatorias > 0) {
        $total_preguntas = VerificaSiTienePReguntasAsociadasRandomicas($rut, $id_evaluacion_por_objeto, $datos_objeto[0]->id);
    } else {
        $total_preguntas = PreguntasDadoEvaluacion($id_evaluacion_por_objeto);
    }
    $PRINCIPAL     = str_replace("{ENTORNO_PAGINACION}", ArmaPaginacionEvaluacion($total_preguntas, $pagina), $PRINCIPAL);
    $PRINCIPAL     = str_replace("{ID_PREGUNTA_ENCODEADO}", Encodear3($id_evaluacion_por_objeto), $PRINCIPAL);
    $PRINCIPAL     = str_replace("{NAME_FORMULARIO}", "FormRespuestas", $PRINCIPAL);
    $PRINCIPAL     = str_replace("{VALOR_BOTON}", "Guardar y Avanzar", $PRINCIPAL);
    $PRINCIPAL     = str_replace("{NOMBRE_EVALUACION}", $datos_evaluacion[0]->nombre_evaluacion, $PRINCIPAL);
    $PRINCIPAL     = str_replace("{NOMBRE_OBJETO}", $datos_evaluacion[0]->nombre_evaluacion, $PRINCIPAL);
    $datos_usuario = UsuarioEnBasePersonas($rut);
    $PRINCIPAL     = str_replace("{NOMBRE_USUARIO}", ($datos_usuario[0]->nombre_completo), $PRINCIPAL);
    $PRINCIPAL     = str_replace("{AVANCEEVALUACION_PREGUNTADOS}", "100", $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaDatosPerfil($PRINCIPAL, $rut)
{
	
		//echo "rut $rut";
    $PRINCIPAL             = str_replace("{FOTO_PERSONA}", VerificaFotoPersonal($rut), $PRINCIPAL);
    $datos_usuario         = DatosUsuarioLeftJefeDeTblUsuario($rut);
    //Datos JEfe
    $arreglo_rut_jefe      = explode("-", $datos_usuario[0]->jefe);
    $datos_personales_jefe = DatosUsuarioLeftJefeDeTblUsuario($arreglo_rut_jefe[0]);
    $PRINCIPAL             = str_replace("{NOMBRE}", utf8_encode($datos_usuario[0]->nombre . " " . $datos_usuario[0]->apaterno . " " . $datos_usuario[0]->amaterno), $PRINCIPAL);
    $PRINCIPAL             = str_replace("{CARGO}", utf8_encode($datos_usuario[0]->cargo), $PRINCIPAL);
    $PRINCIPAL             = str_replace("{GERENCIA}", utf8_encode($datos_usuario[0]->gerencia), $PRINCIPAL);
    $PRINCIPAL             = str_replace("{DIVISION}", utf8_encode($datos_usuario[0]->division), $PRINCIPAL);
    $PRINCIPAL             = str_replace("{CORREO}", $datos_usuario[0]->email, $PRINCIPAL);
    $PRINCIPAL             = str_replace("{RUT_ENCODEADO}", Encodear3($rut), $PRINCIPAL);
    if ($datos_usuario[0]->telefono) {
        $PRINCIPAL = str_replace("{ROW_TELEFONO}", file_get_contents("views/miperfil/row_telefono_miperfil.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{TELEFONO_FIJO}", $datos_usuario[0]->telefono, $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{ROW_TELEFONO}", "", $PRINCIPAL);
    }
    if ($datos_usuario[0]->celular) {
        if ($_SESSION["id_empresa"] == 41) {
            if ($rut == 6473776) {
                $PRINCIPAL = str_replace("{ROW_CELULAR}", "", $PRINCIPAL);
            } else {
                $PRINCIPAL = str_replace("{ROW_CELULAR}", file_get_contents("views/miperfil/row_celular_miperfil.html"), $PRINCIPAL);
                $PRINCIPAL = str_replace("{CELULAR}", $datos_usuario[0]->celular, $PRINCIPAL);
            }
        } else {
            $PRINCIPAL = str_replace("{ROW_CELULAR}", file_get_contents("views/miperfil/row_celular_miperfil.html"), $PRINCIPAL);
            $PRINCIPAL = str_replace("{CELULAR}", $datos_usuario[0]->celular, $PRINCIPAL);
        }
    } else {
        $PRINCIPAL = str_replace("{ROW_CELULAR}", "", $PRINCIPAL);
    }
    if ($datos_usuario[0]->anexo) {
        $PRINCIPAL = str_replace("{ROW_TELEFONO}", file_get_contents("views/miperfil/row_telefono_miperfil.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{TELEFONO_FIJO}", $datos_usuario[0]->anexo, $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{ROW_TELEFONO}", "", $PRINCIPAL);
    }
    if ($datos_usuario[0]->fecha_nacimiento) {
        $PRINCIPAL = str_replace("{ROW_CUMPLEANOS}", file_get_contents("views/miperfil/row_cumple_miperfil.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{CUMPLE}", formatearFecha($datos_usuario[0]->fecha_nacimiento), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{ROW_CUMPLEANOS}", "", $PRINCIPAL);
    }
    if ($datos_usuario[0]->jefe) {
        $PRINCIPAL = str_replace("{ROW_JEFE}", file_get_contents("views/miperfil/row_mi_jefe_miperfil.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{NOMBRE_JEFE}", "<a href='?sw=veperfil&r=" . Encodear3($datos_usuario[0]->jefe) . "'>" . utf8_encode($datos_personales_jefe[0]->nombre . " " . $datos_personales_jefe[0]->apaterno . " " . $datos_personales_jefe[0]->amaterno) . "</a>", $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{ROW_JEFE}", "", $PRINCIPAL);
    }
    if ($_SESSION["id_empresa"] == 41) {
        $PRINCIPAL = str_replace("{UBICACION}", utf8_encode($datos_usuario[0]->sucursal), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{UBICACION}", utf8_encode($datos_usuario[0]->ubicacion), $PRINCIPAL);
    }
    return ($PRINCIPAL);
}
function DetectaSistema()
{
    $tablet_browser = 0;
    $mobile_browser = 0;
    $body_class     = 'desktop';
    if (preg_match('/(tablet|ipad|playbook)|(android(?!.*(mobi|opera mini)))/i', strtolower($_SERVER['HTTP_USER_AGENT']))) {
        $tablet_browser++;
        $body_class = "tablet";
    }
    if (preg_match('/(up.browser|up.link|mmp|symbian|smartphone|midp|wap|phone|android|iemobile)/i', strtolower($_SERVER['HTTP_USER_AGENT']))) {
        $mobile_browser++;
        $body_class = "mobile";
    }
    if ((strpos(strtolower($_SERVER['HTTP_ACCEPT']), 'application/vnd.wap.xhtml+xml') > 0) or ((isset($_SERVER['HTTP_X_WAP_PROFILE']) or isset($_SERVER['HTTP_PROFILE'])))) {
        $mobile_browser++;
        $body_class = "mobile";
    }
    $mobile_ua     = strtolower(substr($_SERVER['HTTP_USER_AGENT'], 0, 4));
    $mobile_agents = array(
        'w3c ',
        'acs-',
        'alav',
        'alca',
        'amoi',
        'audi',
        'avan',
        'benq',
        'bird',
        'blac',
        'blaz',
        'brew',
        'cell',
        'cldc',
        'cmd-',
        'dang',
        'doco',
        'eric',
        'hipt',
        'inno',
        'ipaq',
        'java',
        'jigs',
        'kddi',
        'keji',
        'leno',
        'lg-c',
        'lg-d',
        'lg-g',
        'lge-',
        'maui',
        'maxo',
        'midp',
        'mits',
        'mmef',
        'mobi',
        'mot-',
        'moto',
        'mwbp',
        'nec-',
        'newt',
        'noki',
        'palm',
        'pana',
        'pant',
        'phil',
        'play',
        'port',
        'prox',
        'qwap',
        'sage',
        'sams',
        'sany',
        'sch-',
        'sec-',
        'send',
        'seri',
        'sgh-',
        'shar',
        'sie-',
        'siem',
        'smal',
        'smar',
        'sony',
        'sph-',
        'symb',
        't-mo',
        'teli',
        'tim-',
        'tosh',
        'tsm-',
        'upg1',
        'upsi',
        'vk-v',
        'voda',
        'wap-',
        'wapa',
        'wapi',
        'wapp',
        'wapr',
        'webc',
        'winw',
        'winw',
        'xda ',
        'xda-'
    );
    if (in_array($mobile_ua, $mobile_agents)) {
        $mobile_browser++;
    }
    if (strpos(strtolower($_SERVER['HTTP_USER_AGENT']), 'opera mini') > 0) {
        $mobile_browser++;
        //Check for tablets on opera mini alternative headers
        $stock_ua = strtolower(isset($_SERVER['HTTP_X_OPERAMINI_PHONE_UA']) ? $_SERVER['HTTP_X_OPERAMINI_PHONE_UA'] : (isset($_SERVER['HTTP_DEVICE_STOCK_UA']) ? $_SERVER['HTTP_DEVICE_STOCK_UA'] : ''));
        if (preg_match('/(tablet|ipad|playbook)|(android(?!.*mobile))/i', $stock_ua)) {
            $tablet_browser++;
        }
    }
    if ($tablet_browser > 0) {
        // Si es tablet has lo que necesites
        //print 'es tablet';
        $arreglo_return[0] = 1;
    } else if ($mobile_browser > 0) {
        // Si es dispositivo mobil has lo que necesites
        //print 'es un mobil';
        $arreglo_return[0] = 2;
    } else {
        // Si es ordenador de escritorio has lo que necesites
        // print 'es un ordenador de escritorio';
        $arreglo_return[0] = 3;
    }
    return ($arreglo_return);
}
function TransformarEscalaEncSatisParaGrafico($valor)
{
    $valor = ($valor * 100) / 5;
    return ($valor);
}
function ColocaBloqueUltimasTres($PRINCIPAL, $id_empresa)
{
    //Traigo el listado de Categorias por empresa
    $noticias = TRaigoUltimas3Noticias($id_empresa);
    $i        = 20;
    foreach ($noticias as $unico) {
        //$row.=file_get_contents("views/bloques/row_bloques_sin_visitas.html");
        $row .= file_get_contents("views/bloques/row_bloques_noticias_recientes.html");
        $row = str_replace("{NOMBRE}", $unico->titulo, $row);
        $row = str_replace("{ID_NOTICIA}", Encodear($unico->id), $row);
        $row = str_replace("{TOTAL_DE_CURSOS}", "", $row);
        $i++;
    }
    $PRINCIPAL = str_replace("{BLOQUE_ULTIMAS_TRES}", utf8_encode($row), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaBloqueNoticiasSimilares($PRINCIPAL, $id_empresa, $id_categoria)
{
    //Traigo el listado de Categorias por empresa
    $noticias = NoticiaPorIdConVistasPorCategoria($id_categoria, $id_empresa);
    $i        = 20;
    foreach ($noticias as $unico) {
        $row .= file_get_contents("views/bloques/row_bloques_sin_visitas.html");
        $row = str_replace("{NOMBRE}", $unico->titulo, $row);
        $row = str_replace("{TOTAL_DE_CURSOS}", $unico->total_visitas, $row);
        $i++;
    }
    $PRINCIPAL = str_replace("{BLOQUE_NOTICIAS_SIMILARES}", utf8_encode($row), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaBloqueMasVistas($PRINCIPAL, $id_empresa)
{
    //Traigo el listado de Categorias por empresa
    $noticias = TraigoNoticasMasVistas($id_empresa);
    $i        = 20;
    foreach ($noticias as $unico) {
        $row .= file_get_contents("views/bloques/row_bloques_noticias.html");
        $row = str_replace("{NOMBRE}", $unico->titulo, $row);
        $row = str_replace("{ID_NOTICIA_ENCODEADA}", Encodear($unico->id), $row);
        $row = str_replace("{TOTAL_DE_CURSOS}", $unico->visitas, $row);
        $i++;
    }
    $PRINCIPAL = str_replace("{BLOQUE_MAS_VISTAS}", utf8_encode($row), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaBloqueCategoriasNoticias($PRINCIPAL, $id_empresa)
{
    $datos_empresa = DatosEmpresa($id_empresa);
    if ($datos_empresa[0]->bloque_categorias_noticias_derecha == 1) {
        $PRINCIPAL = str_replace("{BLOQUE_CATEGORIAS_DERECHA}", "", $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_CATEGORIAS_DERECHA}", file_get_contents("views/noticias/bloque_derecho_categorias.html"), $PRINCIPAL);
    }
    //Traigo el listado de Categorias por empresa
    $categorias = CategoriasNoticiasPorEmpresa($id_empresa);
    foreach ($categorias as $cat) {
        $row .= file_get_contents("views/bloques/row_bloques_categorias.html");
        $row = str_replace("{NOMBRE}", $cat->categoria, $row);
        $row = str_replace("{ID_CATEGORIA_ENCODEADA}", Encodear3($cat->id), $row);
        $row = str_replace("{TOTAL_DE_CURSOS}", $cat->total_noticia, $row);
    }
    $PRINCIPAL = str_replace("{BLOQUE_CATEGORIAS}", utf8_encode($row), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocaMenuSecundario($PRINCIPAL, $id_empresa)
{
    //obtengo los menus nivel 1 dado el id de la empresa
    $menus_n1 = DatosMenuNivel1DadoEmpresa($id_empresa);
    $menu     = file_get_contents("views/menu_secundario/menu_secundario.html");
    foreach ($menus_n1 as $men) {
        //por cada uno de estos, traigo los menus n2
        $menus_n2 = DatosMenuNivel2DadoNivel1($men->id);
        if ($menus_n2) {
            $n1 .= file_get_contents("views/menu_secundario/li_n1_con_n2.html");
            $n2 = "";
            foreach ($menus_n2 as $mn2) {
                $n2 .= file_get_contents("views/menu_secundario/li_n2.html");
                $n2 = str_replace("{NOMBRE_N2}", $mn2->nombre, $n2);
                if ($mn2->id_mundo > 0) {
                    $var_mundo = "&idcom=" . Encodear3($mn2->id_mundo);
                } else {
                    $var_mundo = "";
                }
                if ($mn2->link <> 0) {
                    $n2 = str_replace("{HREF_N2}", "?sw=web&niv=2&i=" . Encodear3($mn2->id) . $var_mundo, $n2);
                } else {
                    $n2 = str_replace("{HREF_N2}", "#", $n2);
                }
            }
            $n1 = str_replace("{NOMBRE}", $men->nombre, $n1);
            $n1 = str_replace("{LISTADO_LI_N2}", ($n2), $n1);
            $n1 = str_replace("{SPAN_IMAGEN}", $men->icono, $n1);
        } else {
            $n1 .= file_get_contents("views/menu_secundario/li_n1.html");
            $n1 = str_replace("{NOMBRE}", "$men->nombre", $n1);
            $n1 = str_replace("{SPAN_IMAGEN}", $men->icono, $n1);
            if ($men->link <> 0) {
                $n1 = str_replace("{HREF_N1}", "?sw=web&niv=1&i=" . Encodear3($men->id) . "&idcom=" . Encodear3($men->id_comunidad), $n1);
            } else {
                if ($men->descripcion_link) {
                    $n1 = str_replace("{HREF_N1}", $men->descripcion_link, $n1);
                } else {
                    $n1 = str_replace("{HREF_N1}", "#", $n1);
                }
            }
        }
    }
    $menu      = str_replace("{LISTADO_LI}", $n1, $menu);
    $PRINCIPAL = str_replace("{MENU_SECUNDARIO}", utf8_encode($menu), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocarEntornoEquipo($PRINCIPAL, $rut_jefe, $modalidad)
{
    if ($modalidad == "todos") {
        $PRINCIPAL     = str_replace("{ENTORNO_EQUIPO}", file_get_contents("views/miequipo/entorno_equipo.html"), $PRINCIPAL);
        $colaboradores = EsJefe($rut_jefe);
        $template_row  = file_get_contents("views/miequipo/row_equipo.html");
    } elseif ($modalidad == "todoequipo") {
        $PRINCIPAL     = str_replace("{ENTORNO_EQUIPO_TODO}", file_get_contents("views/miequipo/entorno_lideres.html"), $PRINCIPAL);
        $colaboradores = EsJefe($rut_jefe);
        $template_row  = file_get_contents("views/miequipo/row_lideres.html");
    } elseif ($modalidad == "todoequipoExcel") {
        $PRINCIPAL     = file_get_contents("views/miequipo/entorno_lideres_excel.html");
        $colaboradores = EsJefe($rut_jefe);
        $template_row  = file_get_contents("views/miequipo/row_lideres_excel.html");
    } else if ($modalidad == "lideres") {
        $PRINCIPAL         = str_replace("{ENTORNO_EQUIPO_LIDERES}", file_get_contents("views/miequipo/entorno_lideres.html"), $PRINCIPAL);
        $colaboradores     = ListadoUsuariosLideres($rut_jefe);
        $template_row      = file_get_contents("views/miequipo/row_lideres.html");
        $template_SUB1_row = file_get_contents("views/miequipo/row_sub_lideres.html");
    }
    foreach ($colaboradores as $unico) {
        //echo "modalidad $modalidad unico ".$unico->total."<br>";
        if ($modalidad == "lideres" and $unico->total == 0 and $unico->lider <> "1") {
            continue;
        }
        $row .= $template_row;
        $row = str_replace("{NOMBRE_COMPLETO}", "<span class='pad_izquierda0'>" . $unico->nombre_completo . "</span>", $row);
        $row = str_replace("{RUT}", "<span class='pad_izquierda0'>" . $unico->rut_completo . "</span>", $row);
        $row = str_replace("{EMAIL}", "<span class='pad_izquierda0'>" . $unico->email . "</span>", $row);
        $row = str_replace("{RUT_JEFE}", "<span class='pad_izquierda0'>" . $unico->rut_jefe . "</span>", $row);
        $row = str_replace("{NOMBRE_JEFE}", "<span class='pad_izquierda0'>" . $unico->nombre_jefe . "</span>", $row);
        if ($unico->total == 0) {
            $row = str_replace("{PERFIL}", "", $row);
        } else {
            $row = str_replace("{PERFIL}", "<span class='fa fa-user-plus'>", $row);
        }
        if ($unico->cargo) {
            $row = str_replace("{CARGO}", $unico->cargo, $row);
        } else {
            $row = str_replace("{CARGO}", "Sin Cargo", $row);
        }
        if ($unico->gerencia) {
            $row = str_replace("{GERENCIA}", $unico->gerencia, $row);
        } else {
            $row = str_replace("{GERENCIA}", "Sin Gerencia", $row);
        }
        //Veo en cuanta
        //Veo en cuantas accione est? dado el rut del jefe y el rut del colaborador, independiente del id del objetivo
        $total_sugerencias = UsuariosPorSugerenciaJefeYColaborador($rut_jefe, $unico->rut);
        $row               = str_replace("{NUM_ACCIONES}", count($total_sugerencias), $row);
        //SUB 1 busca colaboradores abajo de cada linea
        if ($modalidad == "todos" OR $modalidad == "todoequipo" or $modalidad == "todoequipoExcel") {
            $colaboradoresSUB1 = EsJefe($unico->rut);
        } else if ($modalidad == "lideres") {
            $colaboradoresSUB1 = ListadoUsuariosLideres($unico->rut);
        }
        foreach ($colaboradoresSUB1 as $unicoSUB1) {
            if ($modalidad == "lideres" and $unicoSUB1->total == 0 and $unicoSUB1->lider <> "1") {
                continue;
            }
            $row_SUB1 .= $template_SUB1_row;
            $row_SUB1 = str_replace("{NOMBRE_COMPLETO}", $unicoSUB1->nombre_completo, $row_SUB1);
            $row_SUB1 = str_replace("{RUT}", $unicoSUB1->rut_completo, $row_SUB1);
            $row_SUB1 = str_replace("{EMAIL}", $unicoSUB1->email, $row_SUB1);
            $row_SUB1 = str_replace("{NOMBRE_JEFE}", $unicoSUB1->nombre_jefe, $row_SUB1);
            $row .= $template_row;
            $row = str_replace("{NOMBRE_COMPLETO}", " <span class='  pad_izquierda1'>" . $unicoSUB1->nombre_completo . "</span>", $row);
            $row = str_replace("{RUT}", " <span class='  pad_izquierda1'>" . $unicoSUB1->rut_completo . "</span>", $row);
            $row = str_replace("{EMAIL}", " <span class='  pad_izquierda1'>" . $unicoSUB1->email . "</span>", $row);
            $row = str_replace("{RUT_JEFE}", " <span class='  pad_izquierda1'>" . $unicoSUB1->rut_jefe . "</span>", $row);
            $row = str_replace("{NOMBRE_JEFE}", " <span class='  pad_izquierda1'>" . $unicoSUB1->nombre_jefe . "</span>", $row);
            if ($unicoSUB1->total == 0) {
                $row = str_replace("{PERFIL}", "", $row);
            } else {
                $row = str_replace("{PERFIL}", "<span class='fa fa-user-plus'>", $row);
            }
            if ($unico->cargo) {
                $row = str_replace("{CARGO}", $unicoSUB1->cargo, $row);
            } else {
                $row = str_replace("{CARGO}", "Sin Cargo", $row);
            }
            if ($unico->gerencia) {
                $row = str_replace("{GERENCIA}", $unicoSUB1->gerencia, $row);
            } else {
                $row = str_replace("{GERENCIA}", "Sin Gerencia", $row);
            }
            $total_sugerencias = UsuariosPorSugerenciaJefeYColaborador($rut_jefe, $unicoSUB1->rut);
            $row               = str_replace("{NUM_ACCIONES}", count($total_sugerencias), $row);
            //SUB 2 busca colaboradores abajo de cada linea
            if ($modalidad == "todos" OR $modalidad == "todoequipo" or $modalidad == "todoequipoExcel") {
                $colaboradoresSUB2 = EsJefe($unicoSUB1->rut);
            } else if ($modalidad == "lideres") {
                $colaboradoresSUB2 = ListadoUsuariosLideres($unicoSUB1->rut);
            }
            foreach ($colaboradoresSUB2 as $unicoSUB2) {
                if ($modalidad == "lideres" and $unicoSUB2->total == 0 and $unicoSUB2->lider <> "1") {
                    continue;
                }
                $row .= $template_row;
                $row = str_replace("{NOMBRE_COMPLETO}", " <span class=' pad_izquierda2'>" . $unicoSUB2->nombre_completo . "</span>", $row);
                $row = str_replace("{RUT}", " <span class=' pad_izquierda2'>" . $unicoSUB2->rut_completo . "</span>", $row);
                $row = str_replace("{EMAIL}", " <span class=' pad_izquierda2'>" . $unicoSUB2->email . "</span>", $row);
                $row = str_replace("{RUT_JEFE}", " <span class=' pad_izquierda2'>" . $unicoSUB2->rut_jefe . "</span>", $row);
                $row = str_replace("{NOMBRE_JEFE}", " <span class=' pad_izquierda2'>" . $unicoSUB2->nombre_jefe . "</span>", $row);
                if ($unicoSUB2->total == 0) {
                    $row = str_replace("{PERFIL}", "", $row);
                } else {
                    $row = str_replace("{PERFIL}", "<span class='fa fa-user-plus'>", $row);
                }
                if ($unicoSUB2->cargo) {
                    $row = str_replace("{CARGO}", $unicoSUB2->cargo, $row);
                } else {
                    $row = str_replace("{CARGO}", "Sin Cargo", $row);
                }
                if ($unicoSUB2->gerencia) {
                    $row = str_replace("{GERENCIA}", $unicoSUB2->gerencia, $row);
                } else {
                    $row = str_replace("{GERENCIA}", "Sin Gerencia", $row);
                }
                $total_sugerencias = UsuariosPorSugerenciaJefeYColaborador($rut_jefe, $unicoSUB2->rut);
                $row               = str_replace("{NUM_ACCIONES}", count($total_sugerencias), $row);
                //SUB 3 busca colaboradores abajo de cada linea
                if ($modalidad == "todos" OR $modalidad == "todoequipo" or $modalidad == "todoequipoExcel") {
                    $colaboradoresSUB3 = EsJefe($unicoSUB2->rut);
                } else if ($modalidad == "lideres") {
                    $colaboradoresSUB3 = ListadoUsuariosLideres($unicoSUB2->rut);
                }
                $colaboradoresSUB3 = EsJefe($unicoSUB2->rut);
                foreach ($colaboradoresSUB3 as $unicoSUB3) {
                    if ($modalidad == "lideres" and $unicoSUB3->total == 0 and $unicoSUB3->lider <> "1") {
                        continue;
                    }
                    $row .= $template_row;
                    $row = str_replace("{NOMBRE_COMPLETO}", " <span class=' pad_izquierda3'>" . $unicoSUB3->nombre_completo . "</span>", $row);
                    $row = str_replace("{RUT}", " <span class=' pad_izquierda3'>" . $unicoSUB3->rut_completo . "</span>", $row);
                    $row = str_replace("{EMAIL}", " <span class=' pad_izquierda3'>" . $unicoSUB3->email . "</span>", $row);
                    $row = str_replace("{RUT_JEFE}", " <span class=' pad_izquierda3'>" . $unicoSUB3->rut_jefe . "</span>", $row);
                    $row = str_replace("{NOMBRE_JEFE}", " <span class=' pad_izquierda3'>" . $unicoSUB3->nombre_jefe . "</span>", $row);
                    if ($unicoSUB3 > total == 0) {
                        $row = str_replace("{PERFIL}", "", $row);
                    } else {
                        $row = str_replace("{PERFIL}", "<span class='fa fa-user-plus'>", $row);
                    }
                    if ($unicoSUB3->cargo) {
                        $row = str_replace("{CARGO}", $unicoSUB3->cargo, $row);
                    } else {
                        $row = str_replace("{CARGO}", "Sin Cargo", $row);
                    }
                    if ($unicoSUB3->gerencia) {
                        $row = str_replace("{GERENCIA}", $unicoSUB3->gerencia, $row);
                    } else {
                        $row = str_replace("{GERENCIA}", "Sin Gerencia", $row);
                    }
                    $total_sugerencias = UsuariosPorSugerenciaJefeYColaborador($rut_jefe, $unicoSUB3->rut);
                    $row               = str_replace("{NUM_ACCIONES}", count($total_sugerencias), $row);
                    //SUB 4 busca colaboradores abajo de cada linea
                    if ($modalidad == "todos" OR $modalidad == "todoequipo" or $modalidad == "todoequipoExcel") {
                        $colaboradoresSUB4 = EsJefe($unicoSUB3->rut);
                    } else if ($modalidad == "lideres") {
                        $colaboradoresSUB4 = ListadoUsuariosLideres($unicoSUB3->rut);
                    }
                    $colaboradoresSUB4 = EsJefe($unicoSUB3->rut);
                    foreach ($colaboradoresSUB4 as $unicoSUB4) {
                        if ($modalidad == "lideres" and $unicoSUB4->total == 0 and $unicoSUB4->lider <> "1") {
                            continue;
                        }
                        $row .= $template_row;
                        $row = str_replace("{NOMBRE_COMPLETO}", " <span class=' pad_izquierda4'>" . $unicoSUB4->nombre_completo . "</span>", $row);
                        $row = str_replace("{RUT}", " <span class=' pad_izquierda4'>" . $unicoSUB4->rut_completo . "</span>", $row);
                        $row = str_replace("{EMAIL}", " <span class=' pad_izquierda4'>" . $unicoSUB4->email . "</span>", $row);
                        $row = str_replace("{RUT_JEFE}", " <span class=' pad_izquierda4'>" . $unicoSUB4->rut_jefe . "</span>", $row);
                        $row = str_replace("{NOMBRE_JEFE}", " <span class=' pad_izquierda4'>" . $unicoSUB4->nombre_jefe . "</span>", $row);
                        if ($unicoSUB4->total == 0) {
                            $row = str_replace("{PERFIL}", "", $row);
                        } else {
                            $row = str_replace("{PERFIL}", "<span class='fa fa-user-plus'>", $row);
                        }
                        if ($unicoSUB4->cargo) {
                            $row = str_replace("{CARGO}", $unicoSUB4->cargo, $row);
                        } else {
                            $row = str_replace("{CARGO}", "Sin Cargo", $row);
                        }
                        if ($unicoSUB4->gerencia) {
                            $row = str_replace("{GERENCIA}", $unicoSUB4->gerencia, $row);
                        } else {
                            $row = str_replace("{GERENCIA}", "Sin Gerencia", $row);
                        }
                        $total_sugerencias = UsuariosPorSugerenciaJefeYColaborador($rut_jefe, $unicoSUB4->rut);
                        $row               = str_replace("{NUM_ACCIONES}", count($total_sugerencias), $row);
                        //SUB 5 busca colaboradores abajo de cada linea
                        if ($modalidad == "todos" OR $modalidad == "todoequipo" or $modalidad == "todoequipoExcel") {
                            $colaboradoresSUB5 = EsJefe($unicoSUB4->rut);
                        } else if ($modalidad == "lideres") {
                            $colaboradoresSUB5 = ListadoUsuariosLideres($unicoSUB4->rut);
                        }
                        $colaboradoresSUB5 = EsJefe($unicoSUB4->rut);
                        foreach ($colaboradoresSUB5 as $unicoSUB5) {
                            if ($modalidad == "lideres" and $unicoSUB5->total == 0 and $unicoSUB5->lider <> "1") {
                                continue;
                            }
                            $row .= $template_row;
                            $row = str_replace("{NOMBRE_COMPLETO}", " <span class=' pad_izquierda5'>" . $unicoSUB5->nombre_completo . "</span>", $row);
                            $row = str_replace("{RUT}", " <span class=' pad_izquierda5'>" . $unicoSUB5->rut_completo . "</span>", $row);
                            $row = str_replace("{EMAIL}", " <span class=' pad_izquierda5'>" . $unicoSUB5->email . "</span>", $row);
                            $row = str_replace("{RUT_JEFE}", " <span class=' pad_izquierda5'>" . $unicoSUB5->rut_jefe . "</span>", $row);
                            $row = str_replace("{NOMBRE_JEFE}", " <span class=' pad_izquierda5'>" . $unicoSUB5->nombre_jefe . "</span>", $row);
                            if ($unicoSUB5->total == 0) {
                                $row = str_replace("{PERFIL}", "", $row);
                            } else {
                                $row = str_replace("{PERFIL}", "<span class='fa fa-user-plus'>", $row);
                            }
                            if ($unicoSUB5->cargo) {
                                $row = str_replace("{CARGO}", $unicoSUB5->cargo, $row);
                            } else {
                                $row = str_replace("{CARGO}", "Sin Cargo", $row);
                            }
                            if ($unicoSUB5->gerencia) {
                                $row = str_replace("{GERENCIA}", $unicoSUB5->gerencia, $row);
                            } else {
                                $row = str_replace("{GERENCIA}", "Sin Gerencia", $row);
                            }
                            $total_sugerencias = UsuariosPorSugerenciaJefeYColaborador($rut_jefe, $unicoSUB5->rut);
                            $row               = str_replace("{NUM_ACCIONES}", count($total_sugerencias), $row);
                        }
                    }
                }
            }
        }
    }
    if ($modalidad == "todoequipoExcel") {
        $PRINCIPAL = str_replace("{ROW_ENTORNO_EQUIPO}", ($row), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{ROW_ENTORNO_EQUIPO}", utf8_encode($row), $PRINCIPAL);
    }
    return ($PRINCIPAL);
}
function allSucursalesPorNombrePorEmpresa($buscar, $id_empresa)
{
    //$dataPersonas = allPersonasPorEmpresa($buscar, $id_empresa);
    $dataPersonas = allSucursalesPorEmpresa($buscar, $id_empresa);
    if ($dataPersonas) {
        foreach ($dataPersonas as $dataPersonas_aux) {
            echo utf8_encode($dataPersonas_aux->nombre) . " " . "|" . $dataPersonas_aux->id . "\n";
        }
    } else {
        $data = 'Sucursal inexistente';
    }
    return $data;
}
function allPersonasPorNombrePorEmpresa($buscar, $id_empresa, $rut)
{
    $datos_usuario = UsuarioEnBasePersonas($rut);
    //$dataPersonas = allPersonasPorEmpresa($buscar, $id_empresa);
    $dataPersonas  = allPersonasPorEmpresa($buscar, $id_empresa, $datos_usuario[0]->gerencia);
    if ($dataPersonas) {
        foreach ($dataPersonas as $dataPersonas_aux) {
            echo utf8_encode($dataPersonas_aux->nombre) . " " . utf8_encode($dataPersonas_aux->apaterno) . " " . utf8_encode($dataPersonas_aux->amaterno) . " " . "|" . $dataPersonas_aux->rut . "\n";
            //echo utf8_encode($dataPersonas_aux->nombre)."\n";
        }
    } else {
        $data = 'No Existe este nombre';
    }
    return $data;
}
function allPersonasPorNombrePorEmpresaMP($buscar, $id_empresa)
{
    //$dataPersonas = allPersonasPorEmpresa($buscar, $id_empresa);
    $dataPersonas = allPersonasPorEmpresaMP($buscar, $id_empresa);
    if ($dataPersonas) {
        foreach ($dataPersonas as $dataPersonas_aux) {
            echo utf8_encode($dataPersonas_aux->nombre) . " " . utf8_encode($dataPersonas_aux->apaterno) . " " . utf8_encode($dataPersonas_aux->amaterno) . " " . "|" . $dataPersonas_aux->rut . "\n";
            //echo utf8_encode($dataPersonas_aux->nombre)."\n";
        }
    } else {
        $data = 'No Existe este nombre, intenta nuevamente';
    }
    return $data;
}
function allArchivosBibliotecaPorEmpresaMP($buscar, $id_empresa)
{
    //$dataPersonas = allPersonasPorEmpresa($buscar, $id_empresa);
    $dataArchivos = allArchivosBibliotecaPorEmpresaMPDATA($buscar, $id_empresa);
    if ($dataArchivos) {
        foreach ($dataArchivos as $dataArchivo) {
            echo utf8_encode($dataArchivo->titulo) . " [" . utf8_encode($dataArchivo->NombreSubCat) . "]\n";
            //$data=$dataArchivo;
        }
    } else {
        $data = 'No Existen archivos con este nombre, intenta nuevamente';
    }
    return $data;
}
function allPersonasPorNombrePorEmpresaMP_GOPLAY($buscar, $id_empresa)
{
    //$dataPersonas = allPersonasPorEmpresa($buscar, $id_empresa);
    $dataPersonas = allPersonasPorEmpresaMP_GOPLAY($buscar, $id_empresa);
    if ($dataPersonas) {
        foreach ($dataPersonas as $dataPersonas_aux) {
            echo utf8_encode($dataPersonas_aux->nombre) . " " . utf8_encode($dataPersonas_aux->apaterno) . " " . utf8_encode($dataPersonas_aux->amaterno) . " " . "|" . $dataPersonas_aux->rut . "\n";
            //echo utf8_encode($dataPersonas_aux->nombre)."\n";
        }
    } else {
        $data = 'No Existe este nombre, intenta nuevamente';
    }
    return $data;
}
function allPersonasPorNombre($buscar)
{
    $dataPersonas = allPersonas($buscar);
    if ($dataPersonas) {
        foreach ($dataPersonas as $dataPersonas_aux) {
            echo utf8_encode($dataPersonas_aux->nombre_completo) . "|" . $dataPersonas_aux->rut . "\n";
        }
    } else {
        $data = 'No Existe este nombre';
    }
    return $data;
}
function ColocarDatosEncuesta($rut, $pagina, $id_empresa, $id_inscripcion, $tipo_alternativas, $id_objeto, $id_encuesta)
{
    $pagina_mayor = EncTraePaginaMayor($id_encuesta);
    $pagina_mayor = $pagina_mayor[0]->pagina_mayor;
    $datos_objeto = DatosObjeto($id_objeto);
    if ($id_objeto) {
        //Si viene un id de objeto, se muestra la encuesta asociada a este
        $datos_encuesta      = ObtenerEncuestaDadiIdObjeto($id_objeto);
        //print_r($datos_encuesta);
        //Verifico si la encuesta, con este objeto y con el rut, esta finalizada
        //$encuesta_finalizada=VerificoEncuestaFinalizada($datos_encuesta[0]->id, $id_empresa, $rut);
        $encuesta_finalizada = VerificoEncuestaFinalizadaConIDObjeto($datos_encuesta[0]->id, $id_empresa, $rut, $id_objeto);
        if ($encuesta_finalizada) {
            $PRINCIPAL = FuncionesTransversales(file_get_contents("views/encuesta/template_enc_sat_fin_generico.html"));
        } else {
            $PRINCIPAL = FuncionesTransversales(file_get_contents("views/encuesta/" . $datos_encuesta[0]->template . ""));
        }
    } else if ($id_encuesta && $id_inscripcion) {
        $datos_encuesta      = DDatosEncSatis($id_encuesta);
        //Aca verifico si esta finalizada la encuesta, por el rut, id encuesta
        $encuesta_finalizada = VerificoEncuestaFinalizadaPorInsc($datos_encuesta[0]->id, $id_empresa, $rut, $id_inscripcion);
        if ($encuesta_finalizada) {
            if ($id_empresa == 19) {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/encuesta/19_template_enc_sat_fin_generico.html"));
            } else {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/encuesta/template_enc_sat_fin_generico.html"));
            }
        } else {
            $PRINCIPAL = FuncionesTransversales(file_get_contents("views/encuesta/" . $datos_encuesta[0]->template . ""));
        }
    } else if ($id_encuesta) {
        $datos_encuesta      = DDatosEncSatis($id_encuesta);
        //Aca verifico si esta finalizada la encuesta, por el rut, id encuesta
        $encuesta_finalizada = VerificoEncuestaFinalizada($datos_encuesta[0]->id, $id_empresa, $rut);
        if ($encuesta_finalizada) {
            if ($id_empresa == 19) {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/encuesta/19_template_enc_sat_fin_generico.html"));
            } else {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/encuesta/template_enc_sat_fin_generico.html"));
            }
        } else {
            $PRINCIPAL = FuncionesTransversales(file_get_contents("views/encuesta/" . $datos_encuesta[0]->template . ""));
        }
    } else {
        //Por ahora, si no viene ID de Objeto, se muestra la que est? asociada a la empresa
        $datos_encuesta      = ObtenerEncuestaDadaEmpresa($id_empresa);
        //Verifico si la encuesta, con este usuario, de esta empresa est? finalizada o no.
        $encuesta_finalizada = VerificoEncuestaFinalizada($datos_encuesta[0]->id, $id_empresa, $rut);
        if ($encuesta_finalizada) {
            $PRINCIPAL = FuncionesTransversales(file_get_contents("views/encuesta/template_enc_sat_fin_generico.html"));
        } else {
            $PRINCIPAL = FuncionesTransversales(file_get_contents("views/encuesta/" . $datos_encuesta[0]->template . ""));
        }
    }
    if ($pagina == $pagina_mayor) {
        //$PRINCIPAL = str_replace("{BLOQUE_PREGUNTA_FINAL}",file_get_contents("views/encuesta/comentarios_finales.html"),$PRINCIPAL);
    } else {
        //$PRINCIPAL = str_replace("{BLOQUE_PREGUNTA_FINAL}","",$PRINCIPAL);
    }
    $PRINCIPAL = str_replace("{BLOQUE_PREGUNTA_FINAL}", "", $PRINCIPAL);
    $PRINCIPAL = str_replace("{TITULO}", $datos_encuesta[0]->titulo, $PRINCIPAL);
    $PRINCIPAL = str_replace("{DESCRIPCION}", $datos_encuesta[0]->descriptor, $PRINCIPAL);
    $PRINCIPAL = str_replace("{IMAGEHEADER}", $datos_encuesta[0]->imagenheader, $PRINCIPAL);
    $PRINCIPAL = str_replace("{ID_EMPRESA_ENCODEADA}", Encodear3($id_empresa), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($id_objeto), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ID_OBJETIVO_ENCODEADO}", Encodear3($id_objeto), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ID_INSCRIPCION_ENCODEADA}", Encodear3($id_inscripcion), $PRINCIPAL);
    //aca traigo las preguntas correspondientes
    $preguntas = EncTraigoPreguntasDadaPaginaIdEncuesta($datos_encuesta[0]->idencuesta, $pagina);
    $dimension = "";
    $muestra   = "si";
    //    print_r($preguntas);
    foreach ($preguntas as $preg) {
        $row_pregunta .= file_get_contents("views/encuesta/" . $preg->template);
        $template_opcion = file_get_contents("views/encuesta/" . $preg->template_opcion);
        if ($dimension <> $preg->iddimension) {
            if ($preg->visible == 1) {
                if ($muestra == "si") {
                    $row_pregunta = str_replace("{SUBTITULO}", file_get_contents("views/encuesta/subtitulo_solo.html"), $row_pregunta);
                    $muestra      = "no";
                } else {
                    $row_pregunta = str_replace("{SUBTITULO}", "", $row_pregunta);
                }
            } else {
                $row_pregunta = str_replace("{SUBTITULO}", file_get_contents("views/encuesta/subtitulo.html"), $row_pregunta);
            }
            //Aca traigo los encabezdos para las opciones por esta pregunta
            $opciones          = EncOpcionesDadoId($preg->idopcion);
            $html_enc_opciones = "";
            foreach ($opciones as $op) {
                $width = 100 / count($opciones);
                $html_enc_opciones .= file_get_contents("views/encuesta/td_encabezado.html");
                $html_enc_opciones = str_replace("{VALOR_WIDTH}", $width, $html_enc_opciones);
                $html_enc_opciones = str_replace("{VALOR_OPCION}", $op->opcion, $html_enc_opciones);
                //$html_enc_opciones.="<td width='".$width."%'>".$op->opcion."</td>";
            }
            $row_pregunta = str_replace("{TEXTO}", $preg->nombre_dimension, $row_pregunta);
            $row_pregunta = str_replace("{TD_CON_ENCABEZADOS}", $html_enc_opciones, $row_pregunta);
        } else {
            $row_pregunta = str_replace("{SUBTITULO}", "", $row_pregunta);
        }
        $dimension          = $preg->iddimension;
        $row_pregunta       = str_replace("{PREGUNTA1}", $preg->pregunta, $row_pregunta);
        $row_pregunta       = str_replace("{NUMERO_PREGUNTA}", $preg->idpregunta, $row_pregunta);
        //alternativas por cada pregunta
        $opciones           = EncOpcionesDadoId($preg->idopcion);
        $i                  = 1;
        $row_alternativa    = "";
        $row_Alternativa_td = "";
        //print_r($opciones);
        foreach ($opciones as $opc) {
            //$row_alternativa.=file_get_contents("views/encuesta/td_opciones_alternativas.html");
            //$row_alternativa = str_replace("{OPCION}","<input  type='radio' value='".$opc->puntaje."' name='".$preg->idpregunta."' id='".$preg->idpregunta."' class='radio1' >",$row_alternativa);
            //$row_alternativa = str_replace("{ALT_TEXTO}",$opc->opcion,$row_alternativa);
            $width_alt = 100 / count($opciones);
            $row_Alternativa_td .= file_get_contents("views/encuesta/td_opciones_alternativas.html");
            $row_Alternativa_td = str_replace("{WIDTH_ALT}", $width_alt, $row_Alternativa_td);
            $row_Alternativa_td = str_replace("{PUNTAJE_ALT}", $opc->puntaje, $row_Alternativa_td);
            $row_Alternativa_td = str_replace("{ENC_OPCION_TEXTO}", $opc->opcion, $row_Alternativa_td);
            $row_Alternativa_td = str_replace("{NAME_ALT}", $preg->idpregunta, $row_Alternativa_td);
            $row_Alternativa_td = str_replace("{ID_ALT}", $preg->idpregunta, $row_Alternativa_td);
            //$row_Alternativa_td.="<td width='".$width_alt."%'><input required style='opacity: 0; margin: 0px;' value='".$opc->puntaje."' name='".$preg->idpregunta."' id='".$preg->idpregunta."' class='radio1 checkator_source' type='radio'></td>";
            $i++;
        }
        $tiene_respuesta = TieneRespuestasPorPReguntaEncuesta($rut, $id_empresa, $id_objeto, $datos_encuesta[0]->idencuesta, $preg->idpregunta);
        //echo "<pre>";
        //print_r($tiene_respuesta);exit;
        if ($tiene_respuesta) {
            $row_Alternativa_td = str_replace("{CHECKED_ALTERNATIVA}_" . $tiene_respuesta[0]->respuesta . "}", "checked='checked'", $row_Alternativa_td);
            $row_Alternativa_td = str_replace("{CHECKED_ALTERNATIVA}_1}", "", $row_Alternativa_td);
            $row_Alternativa_td = str_replace("{CHECKED_ALTERNATIVA}_2}", "", $row_Alternativa_td);
            $row_Alternativa_td = str_replace("{CHECKED_ALTERNATIVA}_3}", "", $row_Alternativa_td);
            $row_Alternativa_td = str_replace("{CHECKED_ALTERNATIVA}_4}", "", $row_Alternativa_td);
            $row_Alternativa_td = str_replace("{CHECKED_ALTERNATIVA}_5}", "", $row_Alternativa_td);
            $row_Alternativa_td = str_replace("{CHECKED_ALTERNATIVA}_6}", "", $row_Alternativa_td);
            $row_Alternativa_td = str_replace("{CHECKED_ALTERNATIVA}_7}", "", $row_Alternativa_td);
        } else {
            $row_Alternativa_td = str_replace("{CHECKED_ALTERNATIVA}_1}", "", $row_Alternativa_td);
            $row_Alternativa_td = str_replace("{CHECKED_ALTERNATIVA}_2}", "", $row_Alternativa_td);
            $row_Alternativa_td = str_replace("{CHECKED_ALTERNATIVA}_3}", "", $row_Alternativa_td);
            $row_Alternativa_td = str_replace("{CHECKED_ALTERNATIVA}_4}", "", $row_Alternativa_td);
            $row_Alternativa_td = str_replace("{CHECKED_ALTERNATIVA}_5}", "", $row_Alternativa_td);
            $row_Alternativa_td = str_replace("{CHECKED_ALTERNATIVA}_6}", "", $row_Alternativa_td);
            $row_Alternativa_td = str_replace("{CHECKED_ALTERNATIVA}_7}", "", $row_Alternativa_td);
        }
        //$row_pregunta = str_replace("{ALTERNATIVAS}",$row_alternativa,$row_pregunta);
        $row_pregunta = str_replace("{TD_ALTERNATIVAS}", $row_Alternativa_td, $row_pregunta);
    }
    $row_pregunta .= "<br>" . file_get_contents("views/encuesta/comentarios_finales.html") . "<br>";
    $tiene_comentario          = TieneComentarioFinalEncSatisGeneral($rut, $id_empresa, $id_objeto, $datos_encuesta[0]->idencuesta);
    $row_pregunta              = str_replace("{COMENTARIO_FINAL}", $tiene_comentario[0]->comentario, $row_pregunta);
    //Aca veo si esta inscripcion, tiene relatores por sesion, si es asi, debiese traer las preguntas
    $relatores_por_inscripcion = TraeRelatoresPorInscripcion($id_empresa, $datos_objeto[0]->id_curso);
    //print_r($relatores_por_inscripcion);
    if ($relatores_por_inscripcion) {
        if ($datos_encuesta[0]->idencuesta == "13") {
            $preguntas = EncTraigoPreguntasParaRelatores();
        } else if ($datos_encuesta[0]->idencuesta == "6") {
            $preguntas = EncTraigoPreguntasParaRelatoresEnc6();
        }
        foreach ($relatores_por_inscripcion as $relator) {
            $dimension = "";
            foreach ($preguntas as $preg) {
                $row_preguntas_por_relator .= file_get_contents("views/encuesta/" . $preg->template);
                $template_opcion = file_get_contents("views/encuesta/" . $preg->template_opcion);
                if ($dimension <> $preg->iddimension) {
                    if ($preg->visible == 1) {
                        if ($muestra == "si") {
                            $row_preguntas_por_relator = str_replace("{SUBTITULO}", file_get_contents("views/encuesta/subtitulo_solo.html"), $row_preguntas_por_relator);
                            $muestra                   = "no";
                        } else {
                            $row_preguntas_por_relator = str_replace("{SUBTITULO}", "", $row_preguntas_por_relator);
                        }
                    } else {
                        $row_preguntas_por_relator = str_replace("{SUBTITULO}", file_get_contents("views/encuesta/subtitulo.html"), $row_preguntas_por_relator);
                    }
                    //Aca traigo los encabezdos para las opciones por esta pregunta
                    $opciones          = EncOpcionesDadoId($preg->idopcion);
                    $html_enc_opciones = "";
                    foreach ($opciones as $op) {
                        $width = 100 / count($opciones);
                        $html_enc_opciones .= file_get_contents("views/encuesta/td_encabezado.html");
                        $html_enc_opciones = str_replace("{VALOR_WIDTH}", $width, $html_enc_opciones);
                        $html_enc_opciones = str_replace("{VALOR_OPCION}", $op->opcion, $html_enc_opciones);
                        //$html_enc_opciones.="<td width='".$width."%'>".$op->opcion."</td>";
                    }
                    $row_preguntas_por_relator = str_replace("{TEXTO}", $preg->nombre_dimension, $row_preguntas_por_relator);
                    $row_preguntas_por_relator = str_replace("{TD_CON_ENCABEZADOS}", $html_enc_opciones, $row_preguntas_por_relator);
                } else {
                    $row_preguntas_por_relator = str_replace("{SUBTITULO}", "", $row_preguntas_por_relator);
                }
                $dimension                 = $preg->iddimension;
                $row_preguntas_por_relator = str_replace("{PREGUNTA1}", $preg->pregunta, $row_preguntas_por_relator);
                $row_preguntas_por_relator = str_replace("{NUMERO_PREGUNTA}", $preg->idpregunta, $row_preguntas_por_relator);
                //alternativas por cada pregunta
                $opciones                  = EncOpcionesDadoId($preg->idopcion);
                $i                         = 1;
                $row_alternativa           = "";
                $row_Alternativa_td        = "";
                //print_r($opciones);
                foreach ($opciones as $opc) {
                    //$row_alternativa.=file_get_contents("views/encuesta/td_opciones_alternativas.html");
                    //$row_alternativa = str_replace("{OPCION}","<input  type='radio' value='".$opc->puntaje."' name='".$preg->idpregunta."' id='".$preg->idpregunta."' class='radio1' >",$row_alternativa);
                    //$row_alternativa = str_replace("{ALT_TEXTO}",$opc->opcion,$row_alternativa);
                    $width_alt = 100 / count($opciones);
                    $row_Alternativa_td .= file_get_contents("views/encuesta/td_opciones_alternativas.html");
                    $row_Alternativa_td = str_replace("{WIDTH_ALT}", $width_alt, $row_Alternativa_td);
                    $row_Alternativa_td = str_replace("{PUNTAJE_ALT}", $opc->puntaje, $row_Alternativa_td);
                    $row_Alternativa_td = str_replace("{ENC_OPCION_TEXTO}", $opc->opcion, $row_Alternativa_td);
                    $row_Alternativa_td = str_replace("{NAME_ALT}", $preg->idpregunta . "_" . $relator->rut_relator, $row_Alternativa_td);
                    $row_Alternativa_td = str_replace("{RUT_RELATOR}", $relator->rut_relator, $row_Alternativa_td);
                    $row_Alternativa_td = str_replace("{ID_ALT}", $preg->idpregunta, $row_Alternativa_td);
                    //$row_Alternativa_td.="<td width='".$width_alt."%'><input required style='opacity: 0; margin: 0px;' value='".$opc->puntaje."' name='".$preg->idpregunta."' id='".$preg->idpregunta."' class='radio1 checkator_source' type='radio'></td>";
                    $i++;
                }
                $tiene_respuesta = TieneRespuestasPorPReguntaRelatorEncuesta($rut, $id_empresa, $id_objeto, $datos_encuesta[0]->idencuesta, $relator->rut_relator, $preg->idpregunta);
                if ($tiene_respuesta) {
                    $row_Alternativa_td = str_replace("{CHECKED_ALTERNATIVA}_" . $tiene_respuesta[0]->respuesta . "}", "checked='checked'", $row_Alternativa_td);
                    $row_Alternativa_td = str_replace("{CHECKED_ALTERNATIVA}_1}", "", $row_Alternativa_td);
                    $row_Alternativa_td = str_replace("{CHECKED_ALTERNATIVA}_2}", "", $row_Alternativa_td);
                    $row_Alternativa_td = str_replace("{CHECKED_ALTERNATIVA}_3}", "", $row_Alternativa_td);
                    $row_Alternativa_td = str_replace("{CHECKED_ALTERNATIVA}_4}", "", $row_Alternativa_td);
                    $row_Alternativa_td = str_replace("{CHECKED_ALTERNATIVA}_5}", "", $row_Alternativa_td);
                    $row_Alternativa_td = str_replace("{CHECKED_ALTERNATIVA}_6}", "", $row_Alternativa_td);
                    $row_Alternativa_td = str_replace("{CHECKED_ALTERNATIVA}_7}", "", $row_Alternativa_td);
                } else {
                    $row_Alternativa_td = str_replace("{CHECKED_ALTERNATIVA}_1}", "", $row_Alternativa_td);
                    $row_Alternativa_td = str_replace("{CHECKED_ALTERNATIVA}_2}", "", $row_Alternativa_td);
                    $row_Alternativa_td = str_replace("{CHECKED_ALTERNATIVA}_3}", "", $row_Alternativa_td);
                    $row_Alternativa_td = str_replace("{CHECKED_ALTERNATIVA}_4}", "", $row_Alternativa_td);
                    $row_Alternativa_td = str_replace("{CHECKED_ALTERNATIVA}_5}", "", $row_Alternativa_td);
                    $row_Alternativa_td = str_replace("{CHECKED_ALTERNATIVA}_6}", "", $row_Alternativa_td);
                    $row_Alternativa_td = str_replace("{CHECKED_ALTERNATIVA}_7}", "", $row_Alternativa_td);
                }
                $row_preguntas_por_relator = str_replace("{TD_ALTERNATIVAS}", $row_Alternativa_td, $row_preguntas_por_relator);
            }
            $row_preguntas_por_relator = str_replace("{NOMBRE_RELATOR}", $relator->nombre_relator, $row_preguntas_por_relator);
            $row_preguntas_por_relator .= "<br>" . file_get_contents("views/encuesta/comentarios_finales_2_preguntas.html") . "<br>";
            $tiene_comentario          = TieneComentarioFinalEncSatisPorRelator($rut, $id_empresa, $id_objeto, $datos_encuesta[0]->idencuesta, $relator->rut_relator);
            $row_preguntas_por_relator = str_replace("{CVALOR_COMENTARIO}", $tiene_comentario[0]->comentario, $row_preguntas_por_relator);
            $row_preguntas_por_relator = str_replace("{CVALOR_COMENTARIO2}", $tiene_comentario[0]->comentario2, $row_preguntas_por_relator);
            $row_preguntas_por_relator = str_replace("{RUT_RELATOR}", $relator->rut_relator, $row_preguntas_por_relator);
            $row_preguntas_por_relator .= "<br><br>";
        }
    }
    $PRINCIPAL = str_replace("{ID_ENCUESTA_ENCODEADA}", encodear3($datos_encuesta[0]->idencuesta), $PRINCIPAL);
    $PRINCIPAL = str_replace("{LISTADO_PREGUNTAS}", $row_pregunta . "<br><br>" . $row_preguntas_por_relator, $PRINCIPAL);
    $PRINCIPAL = str_replace("{BOTON}", file_get_contents("views/encuesta/boton_siguiente.html"), $PRINCIPAL);
    $PRINCIPAL = str_replace("{ACTION_ENC}", "?sw=savEncSat", $PRINCIPAL);
    return (utf8_encode($PRINCIPAL));
}
function DecodearConRut($valor)
{
    $arreglo    = explode("$", $valor);
    $arreglo[0] = Decodear3($arreglo[0]);
    $arreglo[1] = Decodear3($arreglo[1]);
    $arreglo[2] = Decodear3($arreglo[2]);
    $arreglo[3] = Decodear3($arreglo[3]);
    return ($arreglo);
}
function EncodearConRut($rut, $fecha_y_hora, $id_inscripcion)
{
    $datos_usuario = UsuarioEnBasePersonasCruceEmpresa2($rut);
    $id_empresa    = $datos_usuario[0]->idempresa;
    $tokem         = $datos_usuario[0]->tokem_validacion_externo;
    $valor         = Encodear3($rut) . "$" . Encodear3($tokem) . "$" . Encodear3($fecha_y_hora) . "$" . Encodear3($id_inscripcion);
    return ($valor);
}
function ColocaBotoneraDNC($html, $valor)
{
    //Seccion para colocar la botonera 1
    $rut  = $_SESSION["user_"];
    $html = str_replace("{BOTONERA_SUPERIOR_DNC}", file_get_contents("views/dnc/botonera_superior_dnc.html"), $html);
    if ($valor == 1) {
        $html = str_replace("{PESTANA1}", "active", $html);
        $html = str_replace("{PESTANA2}", "pasive", $html);
        $html = str_replace("{PESTANA3}", "pasive", $html);
        $html = str_replace("{PESTANA4}", "pasive", $html);
    } else if ($valor == 2) {
        $html = str_replace("{PESTANA1}", "pasive", $html);
        $html = str_replace("{PESTANA2}", "active", $html);
        $html = str_replace("{PESTANA3}", "pasive", $html);
        $html = str_replace("{PESTANA4}", "pasive", $html);
    } else if ($valor == 3) {
        $html = str_replace("{PESTANA1}", "pasive", $html);
        $html = str_replace("{PESTANA2}", "pasive", $html);
        $html = str_replace("{PESTANA3}", "active", $html);
        $html = str_replace("{PESTANA4}", "pasive", $html);
    } else if ($valor == 4) {
        $html = str_replace("{PESTANA1}", "pasive", $html);
        $html = str_replace("{PESTANA2}", "pasive", $html);
        $html = str_replace("{PESTANA3}", "pasive", $html);
        $html = str_replace("{PESTANA4}", "active", $html);
    }
    return ($html);
}
function PersonasIanctivasTemporalmente($PRINCIPAL, $evaluador)
{
    $personas_inactivas = TienePersonasInactivas($evaluador);
    if ($personas_inactivas) {
        $PRINCIPAL = str_replace("{BLOQUE_PERSONA_INACTIVAS}", file_get_contents("views/sgd/entorno_inactivos.html"), $PRINCIPAL);
        foreach ($personas_inactivas as $unico) {
            $row .= file_get_contents("views/sgd/row_colaboradores_inactivos.html");
            $row = ColocaDatosUsuario($row, $unico->evaluado);
        }
        $PRINCIPAL = str_replace("{LISTADO_EVALUADOS}", $row, $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_PERSONA_INACTIVAS}", "", $PRINCIPAL);
    }
    return ($PRINCIPAL);
}
function ObtenerDatosAvancesPorEvaluador($evaluador)
{
    $evaluados                    = EvaluadosDadoEvaluadorConDatosDeEvaluado($evaluador);
    $finalizado_individual_cont   = 0;
    $finalizado_validaciones_cont = 0;
    $finalizado_ajustes_cont      = 0;
    foreach ($evaluados as $eval) {
        $finalizado_individual = VerificaFinalizadoObjetivosIndividuales($eval->evaluado);
        if ($finalizado_individual)
            $finalizado_individual_cont++;
        $finalizado_ajustes = VerificaSiObjetivosEstanAjustados($eval->evaluado);
        if ($finalizado_ajustes)
            $finalizado_ajustes_cont++;
        $finalizado_validaciones = VerificaSiObjetivosEstanValidados($eval->evaluado);
        if ($finalizado_validaciones)
            $finalizado_validaciones_cont++;
    }
    //porcentaje proposicion Evaluados
    $arreglo[0] = number_format(($finalizado_individual_cont * 100) / count($evaluados), 0);
    //Porcentaje de finalizados ajustes
    $arreglo[1] = number_format(($finalizado_ajustes_cont * 100) / count($evaluados), 0);
    //Porcentaje de Validados
    $arreglo[2] = number_format(($finalizado_validaciones_cont * 100) / count($evaluados), 0);
    return ($arreglo);
}
function ColocaAvancesMiPerfil($PRINCIPAL, $evaluado)
{
    $finalizado_individual = VerificaFinalizadoObjetivosIndividuales($evaluado);
    if ($finalizado_individual) {
        $PRINCIPAL = str_replace("{POR_1}", "100%", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ICO_1}", '<span class="fa fa-check text-iconos fs14 mr10"></span>', $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{POR_1}", "0%", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ICO_1}", '<span class="fa fa-circle-thin text-iconos fs14 mr10"></span>', $PRINCIPAL);
    }
    $finalizado_ajustes = VerificaSiObjetivosEstanAjustados($evaluado);
    if ($finalizado_ajustes) {
        $PRINCIPAL = str_replace("{POR_2}", "100%", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ICO_2}", '<span class="fa fa-check text-iconos fs14 mr10"></span>', $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{POR_2}", "0%", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ICO_2}", '<span class="fa fa-circle-thin text-iconos fs14 mr10"></span>', $PRINCIPAL);
    }
    $finalizado_validaciones = VerificaSiObjetivosEstanValidados($evaluado);
    if ($finalizado_validaciones) {
        $PRINCIPAL = str_replace("{POR_3}", "100%", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ICO_3}", '<span class="fa fa-check text-iconos fs14 mr10"></span>', $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{POR_3}", "0%", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ICO_3}", '<span class="fa fa-circle-thin text-iconos fs14 mr10"></span>', $PRINCIPAL);
    }
    $finalizado_Feedback = TomoConocimientoEvaluado($evaluado);
    if ($finalizado_Feedback) {
        $PRINCIPAL = str_replace("{POR_4}", "100%", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ICO_4}", '<span class="fa fa-check text-iconos fs14 mr10"></span>', $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{POR_4}", "0%", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ICO_4}", '<span class="fa fa-circle-thin text-iconos fs14 mr10"></span>', $PRINCIPAL);
    }
    return ($PRINCIPAL);
}
function ColocaAvancesPorEvaluadorParaPestanaMisValidaciones($PRINCIPAL, $evaluador)
{
    //$evaluados=EvaluadosDadoEvaluadorConDatosDeEvaluado($evaluador);
    //$evaluados=EvaluadosDadoEvaluadorConDatosDeEvaluadoSinAe($evaluador);
    $evaluados                    = EvaluadosDadoEvaluadorConDatosDeEvaluadoSinAeParaPestanaMisValidaciones($evaluador);
    $finalizado_individual_cont   = 0;
    $finalizado_validaciones_cont = 0;
    $finalizado_ajustes_cont      = 0;
    $finalizado_feedback          = 0;
    $finalizado_feedback_cont     = 0;
    foreach ($evaluados as $eval) {
        $finalizado_individual = VerificaFinalizadoObjetivosIndividuales($eval->evaluado);
        if ($finalizado_individual)
            $finalizado_individual_cont++;
        $finalizado_ajustes = VerificaSiObjetivosEstanAjustados($eval->evaluado);
        if ($finalizado_ajustes)
            $finalizado_ajustes_cont++;
        $finalizado_validaciones = VerificaSiObjetivosEstanValidados($eval->evaluado);
        if ($finalizado_validaciones)
            $finalizado_validaciones_cont++;
        $finalizado_feedback = TomoConocimientoEvaluado($eval->evaluado);
        if ($finalizado_feedback)
            $finalizado_feedback_cont++;
    }
    $PRINCIPAL = str_replace("{POR_1}", number_format(($finalizado_individual_cont * 100) / count($evaluados), 0) . "%", $PRINCIPAL);
    if (number_format(($finalizado_individual_cont * 100) / count($evaluados), 0) == 100) {
        $PRINCIPAL = str_replace("{ICO_1}", '<span class="fa fa-check text-iconos fs14 mr10"></span>', $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{ICO_1}", '<span class="fa fa-circle-thin text-iconos fs14 mr10"></span>', $PRINCIPAL);
    }
    $PRINCIPAL = str_replace("{POR_2}", number_format(($finalizado_ajustes_cont * 100) / count($evaluados), 0) . "%", $PRINCIPAL);
    if (number_format(($finalizado_ajustes_cont * 100) / count($evaluados), 0) == 100) {
        $PRINCIPAL = str_replace("{ICO_2}", '<span class="fa fa-check text-iconos fs14 mr10"></span>', $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{ICO_2}", '<span class="fa fa-circle-thin text-iconos fs14 mr10"></span>', $PRINCIPAL);
    }
    $PRINCIPAL = str_replace("{POR_3}", number_format(($finalizado_validaciones_cont * 100) / count($evaluados), 0) . "%", $PRINCIPAL);
    if (number_format(($finalizado_validaciones_cont * 100) / count($evaluados), 0) == 100) {
        $PRINCIPAL = str_replace("{ICO_3}", '<span class="fa fa-check text-iconos fs14 mr10"></span>', $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{ICO_3}", '<span class="fa fa-circle-thin text-iconos fs14 mr10"></span>', $PRINCIPAL);
    }
    $PRINCIPAL = str_replace("{POR_4}", number_format(($finalizado_feedback_cont * 100) / count($evaluados), 0) . "%", $PRINCIPAL);
    if (number_format(($finalizado_feedback_cont * 100) / count($evaluados), 0) == 100) {
        $PRINCIPAL = str_replace("{ICO_4}", '<span class="fa fa-check text-iconos fs14 mr10"></span>', $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{ICO_4}", '<span class="fa fa-circle-thin text-iconos fs14 mr10"></span>', $PRINCIPAL);
    }
    return ($PRINCIPAL);
}
function ColocaAvancesPorEvaluador($PRINCIPAL, $evaluador, $id_proceso, $id_empresa, $desde_admin)
{
    //la variable desde_admin, es para cuando se llama desde el admin
    //$evaluados=EvaluadosDadoEvaluadorConDatosDeEvaluado($evaluador);
    //$evaluados=EvaluadosDadoEvaluadorConDatosDeEvaluadoSinAe($evaluador);
    $evaluados                    = EvaluadosDadoEvaluadorConDatosDeEvaluadoSinAePorProceso($evaluador, $id_proceso);
    $finalizado_individual_cont   = 0;
    $finalizado_validaciones_cont = 0;
    $finalizado_ajustes_cont      = 0;
    $finalizado_feedback          = 0;
    $finalizado_feedback_cont     = 0;
    //cantidad de textos por bitacora por evaluador
    $cantidad                     = CantidadBitacorasPorEvaluador($evaluador);
    foreach ($evaluados as $eval) {
        $finalizado_individual = VerificaFinalizadoObjetivosIndividuales($eval->evaluado);
        if ($finalizado_individual)
            $finalizado_individual_cont++;
        $finalizado_ajustes = VerificaSiObjetivosEstanAjustados($eval->evaluado);
        if ($finalizado_ajustes)
            $finalizado_ajustes_cont++;
        $finalizado_validaciones = VerificaSiObjetivosEstanValidados($eval->evaluado);
        if ($finalizado_validaciones)
            $finalizado_validaciones_cont++;
        $finalizado_feedback = TomoConocimientoEvaluado($eval->evaluado);
        if ($finalizado_feedback)
            $finalizado_feedback_cont++;
        $finalizado_ciclo_medio_1 = EstaFinalizadoEpata1($eval->evaluado, 42, 22);
        if ($finalizado_ciclo_medio_1)
            $finalizado_ciclo_1++;
        if ($finalizado_ciclo_medio_1[0]->comentario_evaluado && $finalizado_ciclo_medio_1[0]->comentario_evaluador) {
            $finalizado_ciclo_2++;
        }
    }
    $PRINCIPAL = str_replace("{POR_AVANCE_MEDIO_CICLO_1}", number_format(($finalizado_ciclo_1 * 100) / count($evaluados), 0) . "%", $PRINCIPAL);
    if (number_format(($finalizado_ciclo_1 * 100) / count($evaluados), 0) == 100) {
        $PRINCIPAL = str_replace("{ICO_AVANCE_MEDIO_CICLO_1}", '<span class="fa fa-check text-iconos fs14 mr10"></span>', $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{ICO_AVANCE_MEDIO_CICLO_1}", '<span class="fa fa-circle-thin text-iconos fs14 mr10"></span>', $PRINCIPAL);
    }
    $PRINCIPAL = str_replace("{POR_AVANCE_MEDIO_CICLO_2}", number_format(($finalizado_ciclo_2 * 100) / count($evaluados), 0) . "%", $PRINCIPAL);
    if (number_format(($finalizado_ciclo_2 * 100) / count($evaluados), 0) == 100) {
        $PRINCIPAL = str_replace("{ICO_AVANCE_MEDIO_CICLO_2}", '<span class="fa fa-check text-iconos fs14 mr10"></span>', $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{ICO_AVANCE_MEDIO_CICLO_2}", '<span class="fa fa-circle-thin text-iconos fs14 mr10"></span>', $PRINCIPAL);
    }
    $PRINCIPAL  = str_replace("{POR_1}", number_format(($finalizado_individual_cont * 100) / count($evaluados), 0) . "%", $PRINCIPAL);
    $arreglo[0] = number_format(($finalizado_individual_cont * 100) / count($evaluados), 0);
    if (number_format(($finalizado_individual_cont * 100) / count($evaluados), 0) == 100) {
        $PRINCIPAL = str_replace("{ICO_1}", '<span class="fa fa-check text-iconos fs14 mr10"></span>', $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{ICO_1}", '<span class="fa fa-circle-thin text-iconos fs14 mr10"></span>', $PRINCIPAL);
    }
    $PRINCIPAL = str_replace("{POR_2}", number_format(($finalizado_ajustes_cont * 100) / count($evaluados), 0) . "%", $PRINCIPAL);
    if (number_format(($finalizado_ajustes_cont * 100) / count($evaluados), 0) == 100) {
        $PRINCIPAL = str_replace("{ICO_2}", '<span class="fa fa-check text-iconos fs14 mr10"></span>', $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{ICO_2}", '<span class="fa fa-circle-thin text-iconos fs14 mr10"></span>', $PRINCIPAL);
    }
    $arreglo[1] = number_format(($finalizado_validaciones_cont * 100) / count($evaluados), 0);
    $PRINCIPAL  = str_replace("{POR_3}", number_format(($finalizado_validaciones_cont * 100) / count($evaluados), 0) . "%", $PRINCIPAL);
    if (number_format(($finalizado_validaciones_cont * 100) / count($evaluados), 0) == 100) {
        $PRINCIPAL = str_replace("{ICO_3}", '<span class="fa fa-check text-iconos fs14 mr10"></span>', $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{ICO_3}", '<span class="fa fa-circle-thin text-iconos fs14 mr10"></span>', $PRINCIPAL);
    }
    $PRINCIPAL = str_replace("{POR_4}", number_format(($finalizado_feedback_cont * 100) / count($evaluados), 0) . "%", $PRINCIPAL);
    if (number_format(($finalizado_feedback_cont * 100) / count($evaluados), 0) == 100) {
        $PRINCIPAL = str_replace("{ICO_4}", '<span class="fa fa-check text-iconos fs14 mr10"></span>', $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{ICO_4}", '<span class="fa fa-circle-thin text-iconos fs14 mr10"></span>', $PRINCIPAL);
    }
    $total_descargas = OBJETIVOS_InformesDescargadosPorEvaluadorProcesoEmpresa($evaluador, $id_proceso, $id_empresa);
    $PRINCIPAL       = str_replace("{AVANCE_DESCARGA_INFORMES}", number_format((count($total_descargas) * 100) / count($evaluados), 0) . "%", $PRINCIPAL);
    $arreglo[2]      = number_format((count($total_descargas) * 100) / count($evaluados), 0);
    if (number_format((count($total_descargas) * 100) / count($evaluados), 0) == 100) {
        $PRINCIPAL = str_replace("{ICO_AVANCE_DESCARGA_INFORMES}", '<span class="fa fa-check text-iconos fs14 mr10"></span>', $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{ICO_AVANCE_DESCARGA_INFORMES}", '<span class="fa fa-circle-thin text-iconos fs14 mr10"></span>', $PRINCIPAL);
    }
    $total_descargas             = OBJETIVOS_InformesDescargadosPorEvaluadorProcesoEmpresa($evaluador, $id_proceso, $id_empresa);
    $PRINCIPAL                   = str_replace("{CANTIDAD}", count($cantidad), $PRINCIPAL);
    //PROMEDIO AVANCE EVALUADOR
    $promedio_avance_fijacion    = ((($finalizado_individual_cont * 100) / count($evaluados)) + (($finalizado_validaciones_cont * 100) / count($evaluados)) + ((count($total_descargas) * 100) / count($evaluados))) / 3;
    $PRINCIPAL                   = str_replace("{AVANCE_TOTAL_FIJACION}", number_format($promedio_avance_fijacion, 0) . "%", $PRINCIPAL);
    //Promedio Avance Medio ciclo
    $promedio_avance_medio_ciclo = ((($finalizado_ciclo_1 * 100) / count($evaluados)) + (($finalizado_ciclo_2 * 100) / count($evaluados))) / 2;
    $PRINCIPAL                   = str_replace("{AVANCE_TOTAL_MEDIO_CICLO}", number_format($promedio_avance_medio_ciclo, 0) . "%", $PRINCIPAL);
    if ($desde_admin == "admin") {
        $arreglo[3] = $PRINCIPAL;
        $arreglo[4] = number_format($promedio_avance_fijacion, 0);
        $arreglo[5] = number_format($promedio_avance_medio_ciclo, 0);
        return ($arreglo);
    } else {
        return ($PRINCIPAL);
    }
}
function ObtenerRutaEvaluadoEvaluador($rut)
{
    $i               = 1;
    $datos_evaluador = UsuarioEnBasePersonas($rut);
    $ruta            = "<span class='DatosPersona'>" . $datos_evaluador[0]->nombre_completo . "</span>";
    while ($i == 1) {
        //obtengo el evaluador de la variable $rut
        $evaluador = ObtenerJefeRel2($rut);
        if ($evaluador) {
            $ruta .= " - <span class='DatosPersona'>" . $evaluador[0]->nombre_completo . "</span>";
            $rut = $evaluador[0]->rut;
        } else {
            $i = 2;
        }
    }
    return ($ruta);
}
function PorcentajeEvaluacion($evaluado, $evaluador)
{
    $finalizado = FinalizadoEvaluadoEvaluador($evaluado, $evaluador);
    if ($finalizado) {
        $porcentaje = "25";
    } else {
        $porcentaje = "0";
    }
    return ($porcentaje);
}
function CalculaNotaFinal($pond1, $pond2, $valor1, $valor2)
{
    if ($valor1 > 0 and $valor2 == 0) {
        $nota_final = $valor1;
    }
    if ($valor2 > 0 and $valor1 == 0) {
        $nota_final = $valor2;
    }
    if ($valor2 > 0 and $valor1 > 0) {
        $nota_final = (($pond1 / ($pond1 + $pond2)) * $valor1) + (($pond2 / ($pond1 + $pond2)) * $valor2);
    }
    //echo "<br>$pond1, $pond2, $valor1, $valor2 = $nota_final";
    return ($nota_final);
}
function ObtieneNotaObjetivos($evaluado, $evaluador, $id_proceso, $id_dimension)
{
    //echo $evaluado;
    //$objetivos=ObjetivosEspecificosConRespuesta($evaluado);
    //echo "$evaluado $evaluador $id_proceso $id_dimension";
    //echo "<br>";
    if ($id_dimension) {
        $objetivos  = ObjetivosEspecificosConRespuestaEvaluadoEvaluadorProcesoPorDimension($evaluado, $evaluador, $id_proceso, $id_dimension);
        $pond_total = $objetivos[0]->suma_ponderaciones_por_dimension;
    } else {
        $objetivos = ObjetivosEspecificosConRespuestaEvaluadoEvaluadorProceso($evaluado, $evaluador, $id_proceso);
        if ($_SESSION["id_empresa"] == 11 or $_SESSION["id_empresa"] == 30) {
            $pond_total = 30;
        } else {
            $pond_total = 100;
        }
    }
    $i = 0;
    foreach ($objetivos as $ob) {
        if ($ob->respuesta <> 0) {
            //if($_SESSION["id_empresa"]==11){
            $acumulador                 = $acumulador + (($ob->puntaje * $ob->ponderacion) / $pond_total);
            $acumulador_promedio_simple = $acumulador_promedio_simple + $ob->puntaje;
            $i++;
        }
    }
    $acumulador = $acumulador_promedio_simple / $i;
    return ($acumulador);
}
function ObtieneNotaObjetivosPorDimension($evaluado, $evaluador, $id_proceso, $id_dimension)
{
    $objetivos  = ObjetivosEspecificosConRespuestaEvaluadoEvaluadorProcesoPorDimensionSinTablaRespuesta($evaluado, $evaluador, $id_proceso, $id_dimension);
    $pond_total = $objetivos[0]->ponderacion_dimension;
    $i          = 1;
    foreach ($objetivos as $ob) {
        $i++;
        //$acumulador=$acumulador+(($ob->puntaje*$ob->ponderacion)/$pond_total);
        $acumulador = $acumulador + $ob->puntaje;
    }
    $acumulador = $acumulador / count($objetivos);
    return ($acumulador);
}
function ColocaResultadosTablaReumen($html, $evaluado, $evaluador, $id_proceso, $id_etapa_evaluacion, $id_proceso_desde_admin)
{
    //echo "<br>$evaluado, $evaluador, $id_proceso, $id_etapa_evaluacion<br>";
    $datos_eval_jefe = ObtenerJefeRelPorProceso($evaluado, $id_proceso);
    if ($evaluado == $evaluador) {
        //Traigo los datos de la Eval descendente
        //$datos_eval_jefe=ObtenerJefeRelPorProceso($evaluado, $id_proceso);
        //$evaluador=$datos_eval_jefe[0]->evaluador;
    }
    $datos_resumen                 = ResultadosFinales($evaluado, $evaluador, $id_proceso, $id_etapa_evaluacion);
    //echo "<pre>";
    //print_r($datos_resumen);
    $datos_proceso                 = TraeProcesosDeEvaluacionPorEmpresaYDiProceso($_SESSION["id_empresa"], $id_proceso);
    $decimales_para_reportes       = $datos_proceso[0]->decimales_puntajes;
    $rut_calibrador                = $datos_eval_jefe[0]->calibrador;
    //print_r($datos_resumen);
    //$nota_objetivo=ObtieneNotaObjetivos($evaluado, $evaluador, $id_proceso, "");
    //echo "$evaluado $evaluador $nota_objetivo <br><br><br>";
    //Verifico si esta evaluacion est? finalizada. Si es si, coloca el boton de ver informe, si no, Ver informe desactivado
    $finalizado_evaluado_evaluador = FinalizadoEvaluadoEvaluador($evaluado, $evaluador, $id_proceso);
    if ($finalizado_evaluado_evaluador) {
        $html = str_replace("{BOTON_VE_INFORME}", file_get_contents("views/sgd/informe/boton_ve_informe.html"), $html);
        $html = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($evaluado), $html);
        $html = str_replace("{ID_PROCESO_ENCODEADO}", Encodear3($id_proceso), $html);
    } else {
        $html = str_replace("{BOTON_VE_INFORME}", file_get_contents("views/sgd/informe/boton_ve_informe_inac.html"), $html);
    }
    //BOJETIVOS INDIVIDUALES
    //if($datos_resumen[1]){f
    //EL IF Es para cuando est? finalizada la evaluacion
    //if($datos_resumen[41]=="si"){
    if ($_SESSION["id_empresa"] <> 28) {
        if ($_SESSION["id_empresa"] == 43 or $_SESSION["id_empresa"] == 11 or $_SESSION["id_empresa"] == 41 or $_SESSION["id_empresa"] == 66) {
            //Este if se coloca para cuando tiene nota.
            if ($datos_resumen[31] or $_SESSION["id_empresa"] == 43) {
                //$html = str_replace("{RES_OBJ_IND}","<span class='etiquetaSGD  ".$datos_resumen[0]."'>".$datos_resumen[1]."</span>",$html);
                $html = str_replace("{ESTILO_OBJ_ESP_INT}", $datos_resumen[0], $html);
                $html = str_replace("{CRITERIO_OBJ_ESP_INT}", $datos_resumen[1], $html);
                //$html = str_replace("{NOTA_OBJ_ESP_INT}",round($datos_resumen[31])."% - ".round($datos_resumen[18])."%",$html);
                if ($_SESSION["id_empresa"] == 41) {
                    $html = str_replace("{NOTA_OBJ_ESP_INT}", ColocaDecimalesNotasFinales($decimales_para_reportes, $datos_resumen[31], "") . "", $html);
                } else {
                    //$html = str_replace("{NOTA_OBJ_ESP_INT}",round($datos_resumen[31])."%",$html);
                    $html = str_replace("{NOTA_OBJ_ESP_INT}", ColocaDecimalesNotasFinales(2, $datos_resumen[31], "") . "", $html);
                }
                $html = str_replace("{ICONO_OBJ_ESP_INT}", $datos_resumen[24], $html);
            } else {
                //$html = str_replace("{RES_OBJ_IND}","<span class='etiquetaSGD  etiquetaPrograma-pendiente'>Pendiente</span>",$html);
                $html = str_replace("{ESTILO_OBJ_ESP_INT}", "etiquetaPrograma-pendiente", $html);
                $html = str_replace("{CRITERIO_OBJ_ESP_INT}", "Pendiente", $html);
                $html = str_replace("{NOTA_OBJ_ESP_INT}", "", $html);
                $html = str_replace("{ICONO_OBJ_ESP_INT}", "", $html);
            }
        } else {
            //EL IF Es para cuando est? finalizada la evaluacion
            if ($datos_resumen[41] == "si") {
                //$html = str_replace("{RES_OBJ_IND}","<span class='etiquetaSGD  ".$datos_resumen[0]."'>".$datos_resumen[1]."</span>",$html);
                $html = str_replace("{ESTILO_OBJ_ESP_INT}", $datos_resumen[0], $html);
                $html = str_replace("{CRITERIO_OBJ_ESP_INT}", $datos_resumen[1], $html);
                //$html = str_replace("{NOTA_OBJ_ESP_INT}",round($datos_resumen[31])."% - ".round($datos_resumen[18])."%",$html);
                $html = str_replace("{NOTA_OBJ_ESP_INT}", round($datos_resumen[31]) . "%", $html);
                $html = str_replace("{ICONO_OBJ_ESP_INT}", $datos_resumen[24], $html);
            } else {
                //$html = str_replace("{RES_OBJ_IND}","<span class='etiquetaSGD  etiquetaPrograma-pendiente'>Pendiente</span>",$html);
                $html = str_replace("{ESTILO_OBJ_ESP_INT}", "etiquetaPrograma-pendiente", $html);
                $html = str_replace("{CRITERIO_OBJ_ESP_INT}", "Pendiente", $html);
                $html = str_replace("{NOTA_OBJ_ESP_INT}", "", $html);
                $html = str_replace("{ICONO_OBJ_ESP_INT}", "", $html);
            }
        }
    }
    //COMPETENCIAS
    //if($datos_resumen[32]>0){
    if ($datos_resumen[41] == "si" or $evaluado <> $evaluador) {
        //$html = str_replace("{RES_COMP}","<span class='etiquetaSGD  ".$datos_resumen[2]."'>".$datos_resumen[3]."</span>",$html);
        //Para cuando es Chilquinta, veo si el rut de la sesion, es igual o distinto al evaluador
        //Si es distinto, lo muestro no mas
        //
        if ($_SESSION["id_empresa"] == 28) {
            if ($_SESSION["user_"] == $evaluador or $id_proceso_desde_admin) {
                $html = str_replace("{ESTILO_COMP_ESPE_INT}", $datos_resumen[2], $html);
                $html = str_replace("{CRITERIO_COMP_ESPE_INT}", $datos_resumen[3], $html);
                //$html = str_replace("{NOTA_COMP_ESPE_INT}",round($datos_resumen[32])."% - ".round($datos_resumen[19])."%",$html);
                //$html = str_replace("{NOTA_COMP_ESPE_INT}",ColocaDecimalesNotasFinales($decimales_para_reportes, $datos_resumen[32], "")."%",$html);
                $html = str_replace("{NOTA_COMP_ESPE_INT}", ColocaDecimalesNotasFinales($decimales_para_reportes, $datos_resumen[32], "") . "", $html);
                $html = str_replace("{ICONO_COMP_ESPE_INT}", $datos_resumen[25], $html);
            } else {
                //Veo si est? liberado para el evaluado-evaluador-proceso
                $informe_liberado = TraeLiberadoEvaluadoEvaluadorProceso($evaluado, $evaluador, $id_proceso);
                if ($informe_liberado or $_SESSION["user_"] == $rut_calibrador) {
                    $html = str_replace("{ESTILO_COMP_ESPE_INT}", $datos_resumen[2], $html);
                    $html = str_replace("{CRITERIO_COMP_ESPE_INT}", $datos_resumen[3], $html);
                    //$html = str_replace("{NOTA_COMP_ESPE_INT}",round($datos_resumen[32])."% - ".round($datos_resumen[19])."%",$html);
                    //$html = str_replace("{NOTA_COMP_ESPE_INT}",ColocaDecimalesNotasFinales($decimales_para_reportes, $datos_resumen[32], "")."%",$html);
                    $html = str_replace("{NOTA_COMP_ESPE_INT}", ColocaDecimalesNotasFinales($decimales_para_reportes, $datos_resumen[32], "") . "", $html);
                    $html = str_replace("{ICONO_COMP_ESPE_INT}", $datos_resumen[25], $html);
                } else {
                    $html = str_replace("{ESTILO_COMP_ESPE_INT}", "etiquetaPrograma-pendiente", $html);
                    $html = str_replace("{CRITERIO_COMP_ESPE_INT}", "Pendiente", $html);
                    $html = str_replace("{NOTA_COMP_ESPE_INT}", "", $html);
                    $html = str_replace("{ICONO_COMP_ESPE_INT}", "", $html);
                }
            }
        } else {
            $html = str_replace("{ESTILO_COMP_ESPE_INT}", $datos_resumen[2], $html);
            $html = str_replace("{CRITERIO_COMP_ESPE_INT}", $datos_resumen[3], $html);
            //$html = str_replace("{NOTA_COMP_ESPE_INT}",round($datos_resumen[32])."% - ".round($datos_resumen[19])."%",$html);
            //$html = str_replace("{NOTA_COMP_ESPE_INT}",ColocaDecimalesNotasFinales($decimales_para_reportes, $datos_resumen[32], "")."%",$html);
            $html = str_replace("{NOTA_COMP_ESPE_INT}", ColocaDecimalesNotasFinales($decimales_para_reportes, $datos_resumen[32], "") . "", $html);
            $html = str_replace("{ICONO_COMP_ESPE_INT}", $datos_resumen[25], $html);
        }
    } else {
        $html = str_replace("{ESTILO_COMP_ESPE_INT}", "etiquetaPrograma-pendiente", $html);
        $html = str_replace("{CRITERIO_COMP_ESPE_INT}", "Pendiente", $html);
        $html = str_replace("{NOTA_COMP_ESPE_INT}", "", $html);
        $html = str_replace("{ICONO_COMP_ESPE_INT}", "", $html);
    }
    if ($id_empresa <> 28) {
        //if($datos_resumen[6]){
        if ($datos_resumen[41] == "si") {
            $html = str_replace("{NOTA_OBJ_COMP}", round($datos_resumen[6]) . "", $html);
            $html = str_replace("{CRITERIO_OBJ_ESP}", $datos_resumen[7], $html);
            $html = str_replace("{ICONO_COMP_ESPE}", $datos_resumen[9], $html);
            $html = str_replace("{ESTILO_COMP_ESPE}", $datos_resumen[8], $html);
        } else {
            $html = str_replace("{NOTA_OBJ_COMP}", "", $html);
            $html = str_replace("{CRITERIO_OBJ_ESP}", "Pendiente", $html);
            $html = str_replace("{ICONO_COMP_ESPE}", "", $html);
            $html = str_replace("{ESTILO_COMP_ESPE}", "etiquetaPrograma-pendiente", $html);
        }
        //    $html = str_replace("{ICONO_COMP_ESPE}",$datos_resumen[9],$html);
        //    $html = str_replace("{ESTILO_COMP_ESPE}",$datos_resumen[8],$html);
        //AREA//
        if ($datos_resumen[33] > 0) {
            $html = str_replace("{ESTILO_AREA_INT}", $datos_resumen[11], $html);
            $html = str_replace("{CRITERIO_AREA_INT}", $datos_resumen[10], $html);
            //$html = str_replace("{NOTA_AREA_INT}",round($datos_resumen[33])."% - ".round($datos_resumen[13])."%",$html);
            $html = str_replace("{NOTA_AREA_INT}", round($datos_resumen[33]), $html);
            $html = str_replace("{ICONO_AREA_INT}", $datos_resumen[12], $html);
        } else {
            $html = str_replace("{ESTILO_AREA_INT}", "etiquetaPrograma-pendiente", $html);
            $html = str_replace("{CRITERIO_AREA_INT}", "Pendiente", $html);
            $html = str_replace("{NOTA_AREA_INT}", "", $html);
            $html = str_replace("{ICONO_AREA_INT}", "", $html);
        }
        //EMPRESA - COORPORATIVOS
        if ($datos_resumen[34] > 0) {
            $html = str_replace("{ESTILO_CORP_INT}", $datos_resumen[15], $html);
            $html = str_replace("{CRITERIO_CORP_INT}", $datos_resumen[14], $html);
            //$html = str_replace("{NOTA_CORP_INT}",round($datos_resumen[34])."% - ".round($datos_resumen[17])."%",$html);
            $html = str_replace("{NOTA_CORP_INT}", round($datos_resumen[34]) . "", $html);
            $html = str_replace("{ICONO_CORP_INT}", $datos_resumen[16], $html);
        } else {
            $html = str_replace("{ESTILO_CORP_INT}", "etiquetaPrograma-pendiente", $html);
            $html = str_replace("{CRITERIO_CORP_INT}", "Pendiente", $html);
            $html = str_replace("{NOTA_CORP_INT}", "", $html);
            $html = str_replace("{ICONO_CORP_INT}", "", $html);
        }
        if ($datos_resumen[20]) {
            $html = str_replace("{CRITERIO_CORP_AREA}", $datos_resumen[21], $html);
            $html = str_replace("{ESTILO_CORP_AREA}", $datos_resumen[22], $html);
            $html = str_replace("{NOTA_CORP_AREA}", round($datos_resumen[20]) . "", $html);
            $html = str_replace("{ICONO_CORP_AREA}", $datos_resumen[23], $html);
        } else {
            $html = str_replace("{CRITERIO_CORP_AREA}", "etiquetaPrograma-pendiente", $html);
            $html = str_replace("{ESTILO_CORP_AREA}", "Pendiente", $html);
            $html = str_replace("{NOTA_CORP_AREA}", "", $html);
            $html = str_replace("{ICONO_CORP_AREA}", "", $html);
        }
        $html = str_replace("{ESTILO_COMP_ESPE_FINAL}", "etiquetaPrograma-pendiente", $html);
        $html = str_replace("{CRITERIO_COMP_ESPE_FINAL}", "Pendiente", $html);
        $html = str_replace("{NOTA_COMP_ESPE_FINAL}", "", $html);
        $html = str_replace("{ESTILO_OBJ_ESP_FINAL}", "etiquetaPrograma-pendiente", $html);
        $html = str_replace("{CRITERIO_OBJ_ESP_FINAL}", "Pendiente", $html);
        $html = str_replace("{NOTA_OBJ_ESP_FINAL}", "", $html);
        $html = str_replace("{ESTILO_AREA_FINAL}", "etiquetaPrograma-pendiente", $html);
        $html = str_replace("{CRITERIO_AREA_FINAL}", "Pendiente", $html);
        $html = str_replace("{NOTA_AREA_FINAL}", "", $html);
        $html = str_replace("{ESTILO_CORP_FINAL}", "etiquetaPrograma-pendiente", $html);
        $html = str_replace("{CRITERIO_CORP_FINAL}", "Pendiente", $html);
        $html = str_replace("{NOTA_CORP_FINAL}", "", $html);
    }
    $verifica_eval_finalizada = FinalizadoEvaluadoEvaluador($evaluado, $evaluador, $id_proceso);
    //if($verifica_eval_finalizada){
    //if($datos_resumen[27]){
    if ($datos_resumen[41] == "si") {
        //if($_SESSION["id_empresa"]<>41){
        //if($_SESSION["id_empresa"]<>411){
        //$html = str_replace("{NOTA_FINAL}",$datos_resumen[35]."% - ".$datos_resumen[27]."%",$html);
        //$html = str_replace("{NOTA_FINAL}",$datos_resumen[27]."%",$html);
        if ($_SESSION["id_empresa"] == 28) {
            if ($_SESSION["user_"] == $evaluador) {
                $html = str_replace("{NOTA_FINAL}", $datos_resumen[27] . "", $html);
                $html = str_replace("{CRITERIO_NOTA_FINAL}", $datos_resumen[28], $html);
                $html = str_replace("{ESTILO_NOTA_FINAL}", $datos_resumen[29], $html);
                $html = str_replace("{ICONO_NOTA_FINAL}", $datos_resumen[30], $html);
            } else {
                $informe_liberado = TraeLiberadoEvaluadoEvaluadorProceso($evaluado, $evaluador, $id_proceso);
                if ($informe_liberado or $id_proceso_desde_admin) {
                    $html = str_replace("{NOTA_FINAL}", $datos_resumen[27] . "", $html);
                    $html = str_replace("{CRITERIO_NOTA_FINAL}", $datos_resumen[28], $html);
                    $html = str_replace("{ESTILO_NOTA_FINAL}", $datos_resumen[29], $html);
                    $html = str_replace("{ICONO_NOTA_FINAL}", $datos_resumen[30], $html);
                } else {
                    $html = str_replace("{NOTA_FINAL}", "", $html);
                    $html = str_replace("{CRITERIO_NOTA_FINAL}", "Pendiente", $html);
                    $html = str_replace("{ESTILO_NOTA_FINAL}", "etiquetaPrograma-pendiente", $html);
                    $html = str_replace("{ICONO_NOTA_FINAL}", "", $html);
                }
            }
        } else {
            $html = str_replace("{NOTA_FINAL}", $datos_resumen[27] . "", $html);
            $html = str_replace("{CRITERIO_NOTA_FINAL}", $datos_resumen[28], $html);
            $html = str_replace("{ESTILO_NOTA_FINAL}", $datos_resumen[29], $html);
            $html = str_replace("{ICONO_NOTA_FINAL}", $datos_resumen[30], $html);
        }
        //}else{
        //    $html = str_replace("{NOTA_FINAL}","",$html);
        //    $html = str_replace("{CRITERIO_NOTA_FINAL}","Pendiente",$html);
        //    $html = str_replace("{ESTILO_NOTA_FINAL}","etiquetaPrograma-pendiente",$html);
        //    $html = str_replace("{ICONO_NOTA_FINAL}","",$html);
        //}
    } else {
        $html = str_replace("{NOTA_FINAL}", "", $html);
        $html = str_replace("{CRITERIO_NOTA_FINAL}", "Pendiente", $html);
        $html = str_replace("{ESTILO_NOTA_FINAL}", "etiquetaPrograma-pendiente", $html);
        $html = str_replace("{ICONO_NOTA_FINAL}", "", $html);
    }
    if ($datos_resumen[36]) {
        //$html = str_replace("{NOTA_COMP_ESPE_AE}",round($datos_resumen[36])."%",$html);
        //$html = str_replace("{NOTA_COMP_ESPE_AE}",ColocaDecimalesNotasFinales($decimales_para_reportes, $datos_resumen[36], "")."%",$html);
        $html = str_replace("{NOTA_COMP_ESPE_AE}", ColocaDecimalesNotasFinales($decimales_para_reportes, $datos_resumen[36], "") . "", $html);
        $html = str_replace("{CRITERIO_COMP_ESPE_AE}", $datos_resumen[39], $html);
        $html = str_replace("{ESTILO_COMP_ESPE_AE}", $datos_resumen[38], $html);
        $html = str_replace("{ICONO_COMP_ESPE_AE}", $datos_resumen[40], $html);
    } else {
        $html = str_replace("{NOTA_COMP_ESPE_AE}", "", $html);
        $html = str_replace("{CRITERIO_COMP_ESPE_AE}", "Pendiente", $html);
        $html = str_replace("{ESTILO_COMP_ESPE_AE}", "etiquetaPrograma-pendiente", $html);
        $html = str_replace("{ICONO_COMP_ESPE_AE}", "", $html);
    }
    return ($html);
}
function ListadoValidaObjetivosJefe($html, $evaluador, $id_objetivo, $sgd_version, $id_proceso)
{
    //En esta funcion traigo a todos los evaliados de este evaluador
    $evaluados = EvaluadosDadoEvaluador($evaluador);
    //Se muestran los objetivos individuales.
    if ($sgd_version == 2) {
        $total_html = file_get_contents("views/sgd/sgd_version2/entorno_equipo_valida_objetivos.html");
    } else {
        $total_html = file_get_contents("views/sgd/entorno_equipo_valida_objetivos.html");
    }
    //Primero veo si es que hay registro en la tabla de sesion
    $row           = "";
    $ok_finalizado = 0;
    foreach ($evaluados as $evaluado) {
        $verifica_finaliado = VerificaFinalizadoObjetivosIndividuales($evaluado->evaluado);
        if ($verifica_finaliado) {
            $row .= file_get_contents("views/sgd/row_colaboradores_valida_objetivos.html");
        } else {
        }
        $objetivos_validados_por_validador = VerificaSiObjetivosEstanValidados($evaluado->evaluado);
        if ($objetivos_validados_por_validador) {
            $row = str_replace("{FORMUARIO_FIJACION_OBJEIVOS_JEFE}", "", $row);
            $row = str_replace("{SECCION_COMENTARIOS}", "", $row);
        } else {
            $evaluado_enviado_a_validar = VerificaSiObjetivosEstanAjustados($evaluado->evaluado);
            if ($evaluado_enviado_a_validar) {
                $row = str_replace("{FORMUARIO_FIJACION_OBJEIVOS_JEFE}", file_get_contents("views/sgd/formulario_objetivos_jefe.html"), $row);
                $row = str_replace("{SECCION_COMENTARIOS}", file_get_contents("views/sgd/seccion_comentarios_validador.html"), $row);
            } else {
                $ultimo_comentario = ObtenerObjetivosDeRechazoUltimo($evaluado->evaluado);
                if ($ultimo_comentario) {
                    $row = str_replace("{FORMUARIO_FIJACION_OBJEIVOS_JEFE}", file_get_contents("views/sgd/formulario_objetivos_jefe.html"), $row);
                    $row = str_replace("{SECCION_COMENTARIOS}", file_get_contents("views/sgd/seccion_comentarios_validador.html"), $row);
                } else {
                    $row = str_replace("{FORMUARIO_FIJACION_OBJEIVOS_JEFE}", file_get_contents("views/sgd/formulario_objetivos_jefe.html"), $row);
                    $row = str_replace("{SECCION_COMENTARIOS}", "", $row);
                }
            }
        }
        $row                        = FormularioIngresaObjetivos($row, $evaluado->evaluado, $evaluador);
        $row                        = ColocaDatosUsuario($row, $evaluado->evaluado);
        $valores_objetivos          = ListadoObjetivosAValidar($evaluado->evaluado, $evaluador, $id_objetivo, "jefe", $id_proceso);
        $row                        = str_replace("{LISTADO_OBJETIVOS_A_EVALUAR}", $valores_objetivos[0], $row);
        $ponderaciones_bases        = DevuelvePonderacionesPorEvaluado($evaluado->evaluado, $id_proceso);
        $verifica_evaluado_validado = VerificaSiObjetivosEstanAjustados($evaluado->evaluado);
        /*if($verifica_evaluado_validado){
        $row = str_replace("{BOTON_JEFE_VALIDA_OBJETIVOS}",file_get_contents("views/sgd/boton_ve_objetivos.html"),$row);
        }else{
        $row = str_replace("{BOTON_JEFE_VALIDA_OBJETIVOS}",file_get_contents("views/sgd/boton_jefe_valida_objetivos.html"),$row);
        }*/
        if ($verifica_evaluado_validado) {
            $row = str_replace("{BOTON_VALIDA_INDIVIDUAL}", file_get_contents("views/sgd/boton_PDF_Objetivos.html"), $row);
        } else {
            if ($valores_objetivos[1] == $ponderaciones_bases[2]) {
                $row = str_replace("{BOTON_VALIDA_INDIVIDUAL}", file_get_contents("views/sgd/boton_jefe_envia_a_validar.html"), $row);
            } else {
                $row = str_replace("{BOTON_VALIDA_INDIVIDUAL}", "", $row);
            }
        }
        $row = str_replace("{BOTON_JEFE_VALIDA_OBJETIVOS}", "", $row);
        $row = str_replace("{TOTAL_SUMA_PONDERACION}", $valores_objetivos[1], $row);
        //$row = str_replace("{PONDERACION_OBJETIVOS_INDIVIDUALES}",$ponderaciones_bases[2],$row);
        $row = str_replace("{PONDERACION_OBJETIVOS_INDIVIDUALES}", 100, $row);
        if ($valores_objetivos[1] == $ponderaciones_bases[2]) {
            $row = str_replace("{OK}", "OK", $row);
        } else {
            $row = str_replace("{OK}", "", $row);
        }
        $row = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($evaluado->evaluado), $row);
        $row = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($evaluado->evaluado), $row);
        $row = str_replace("{RUT_EVALUADOR_ENCODEADO}", Encodear3($evaluador), $row);
        if ($valores_objetivos[1] == $ponderaciones_bases[2]) {
            $ok_finalizado++;
        }
    }
    $total_html = str_replace("{LISTADO_COLABORADORES}", ($row), $total_html);
    if ($ok_finalizado == count($evaluados)) {
        $ajustado = VerificaSiObjetivosEstanAjustadosEvaluador($evaluador);
        //if($ajustado){
        if (count($ajustado) == count($evaluados)) {
            $total_html = str_replace("{BOTON_ENVIA_A_VALIDAR_OBJETIVOS}", "", $total_html);
        } else {
            $total_html = str_replace("{BOTON_ENVIA_A_VALIDAR_OBJETIVOS}", file_get_contents("views/sgd/boton_envia_validacion_a_jefe_del_jefe.html"), $total_html);
        }
    } else {
        $total_html = str_replace("{BOTON_ENVIA_A_VALIDAR_OBJETIVOS}", file_get_contents("views/sgd/texto_no_enviar_a_validar.html"), $total_html);
    }
    $total_html = str_replace("{ID_PROCESO_ENCODEADO}", Encodear3($id_proceso), $total_html);
    $html       = str_replace("{ENTORNO_LISTADO_EVALUACION}", ($total_html), $html);
    return ($html);
}
function ListadoValidaJefeDelJefe($html, $evaluador, $id_objetivo)
{
    //En esta funcion traigo a todos los evaliados de este evaluador
    //$evaluados=EvaluadosDadoEvaluadorConDatosDeEvaluado($evaluador);
    $evaluados          = EvaluadosDadoEvaluadorConDatosDeEvaluadoSinAe($evaluador);
    //Se muestran los objetivos individuales.
    $total_html         = file_get_contents("views/sgd/validacion/entorno_listado.html");
    //Primero veo si es que hay registro en la tabla de sesion
    $row                = "";
    $ok_finalizado      = 0;
    $tiene_para_validar = 0;
    foreach ($evaluados as $evaluado) {
        //Verifico por cada uno, si tiene evaluados, solo si tiene, los muestro, sino aplico continue...
        $tiene_evaluados = TraeEvaluadosDadoEvaluadorSinAe($evaluado->evaluado);
        if (!$tiene_evaluados) {
            continue;
        }
        //en la siguente linea verifico si el evaluador finaliz? sus ajustes de objetivos propuesttos por el evaluado.
        $verifica_ajustes_jefe = VerificaSiObjetivosEstanAjustadosEvaluador($evaluado->evaluado);
        if ($verifica_ajustes_jefe) {
            $row .= file_get_contents("views/sgd/validacion/row_dependientes.html");
            $tiene_para_validar++;
        } else {
            $row .= file_get_contents("views/sgd/validacion/row_dependientes_no_finalizado.html");
            $row = ColocaDatosUsuario($row, $evaluado->evaluado, 1);
            continue;
        }
        //$row = str_replace("{FORMUARIO_FIJACION_OBJEIVOS_JEFE}",file_get_contents("views/sgd/formulario_objetivos_jefe.html"),$row);
        $row          = str_replace("{FORMUARIO_FIJACION_OBJEIVOS_JEFE}", "", $row);
        //$row=FormularioIngresaObjetivos($row, $evaluado->evaluado, $evaluador);
        $row          = ColocaDatosUsuario($row, $evaluado->evaluado, "");
        //
        //Por cada evaluado, traigo a sus evaluados, y los muestro.
        //$dependientes=EvaluadosDadoEvaluadorConDatosDeEvaluado($evaluado->evaluado);
        $dependientes = EvaluadosDadoEvaluadorConDatosDeEvaluadoYValidador($evaluado->evaluado, $evaluador);
        $dep_row      = "";
        foreach ($dependientes as $dep) {
            //Verifico si este evaluado ya esta validado
            $verifica_validado = VerificaSiObjetivosEstanValidados($dep->evaluado);
            if ($verifica_validado) {
                $dep_row .= file_get_contents("views/sgd/validacion/row_colaboradores_validado.html");
                $dep_row = str_replace("{SECCION_VALIDA_VALIDADOR}", file_get_contents("views/sgd/validacion/formulario_validado.html"), $dep_row);
            } else {
                $dep_row .= file_get_contents("views/sgd/validacion/row_colaboradores_a_validar.html");
                $dep_row = str_replace("{SECCION_VALIDA_VALIDADOR}", file_get_contents("views/sgd/validacion/formulario_para_validar.html"), $dep_row);
            }
            //Traigo el ultimo comentario ingresado por el validador
            $ultimo_comentario = ObtenerObjetivosDeRechazoUltimo($dep->evaluado);
            $dep_row           = str_replace("{ULTIMO_COMENTARIO_INGRESADO}", $ultimo_comentario[0]->comentario, $dep_row);
            $dep_row           = str_replace("{NOMBRE}", utf8_encode($dep->nombre), $dep_row);
            $dep_row           = str_replace("{CARGO}", utf8_encode($dep->cargo), $dep_row);
            $dep_row           = str_replace("{EVALUADO}", $dep->nombre, $dep_row);
            $dep_row           = str_replace("{IMAGEN_DEPENDIENTE}", VerificaFotoPersonal($dep->evaluado), $dep_row);
            $valores_objetivos = ListadoObjetivosAValidar($dep->evaluado, $evaluado->evaluado, "", "validador");
            $dep_row           = str_replace("{LISTADO_OBJETIVOS_EVALUADO}", $valores_objetivos[0], $dep_row);
            $dep_row           = str_replace("{RUT_EVALUADO}", $dep->evaluado, $dep_row);
        }
        $row = str_replace("{LISTADO_DEPENDIENTES}", ($dep_row), $row);
    }
    $total_html = str_replace("{LISTADO_COLABORADORES}", ($row), $total_html);
    if ($ok_finalizado == count($evaluados)) {
        $ajustado = VerificaSiObjetivosEstanAjustadosEvaluador($evaluador);
        if ($ajustado) {
            $total_html = str_replace("{BOTON_ENVIA_A_VALIDAR_OBJETIVOS}", "", $total_html);
        } else {
            $total_html = str_replace("{BOTON_ENVIA_A_VALIDAR_OBJETIVOS}", file_get_contents("views/sgd/boton_envia_validacion_a_jefe_del_jefe.html"), $total_html);
        }
    } else {
        $total_html = str_replace("{BOTON_ENVIA_A_VALIDAR_OBJETIVOS}", "", $total_html);
    }
    if ($tiene_para_validar > 0) {
        $total_html = str_replace("{BOTON_JEFE_JEFE_VALIDA}", file_get_contents("views/sgd/validacion/jefe_jefe_tiene_para_validar.html"), $total_html);
    } else {
        $total_html = str_replace("{BOTON_JEFE_JEFE_VALIDA}", "", $total_html);
    }
    $html = str_replace("{ENTORNO_LISTADO_EVALUACION}", ($total_html), $html);
    return ($html);
}
function ResultadosFinales($evaluado, $evaluador, $id_proceso, $id_etapa_eval)
{
    if ($_SESSION["id_empresa"] == 11) {
        $datos_evaluado = UsuarioEnBasePersonas($evaluado);
    } else {
        $datos_evaluado = UsuarioEnBasePersonasConRelacionEvaluadoEvaluador($evaluado, $evaluador, $id_proceso);
    }
    //$datos_evaluado=UsuarioEnBasePersonas($evaluado);
    //echo "<br><br>";
    $id_empresa    = $datos_evaluado[0]->id_empresa;
    $id_area       = $datos_evaluado[0]->id_area;
    $datos_proceso = TraeProcesosDeEvaluacionPorEmpresaYDiProceso($_SESSION["id_empresa"], $id_proceso);
    //print_r($datos_proceso);echo "<br><br>";
    if ($datos_proceso[0]->decimales_puntaje) {
    }
    $ponderaciones = TraePonderacionesPorPerfil($datos_evaluado[0]->perfil_evaluacion);
    if ($id_empresa <> 28) {
        //Nota Objetivo
        if ($id_empresa == 43) {
            $arreglo[18] = ObtieneNotaObjetivosSinTablaRespuesta($evaluado, $evaluador, $id_proceso, "");
        } else {
            $arreglo[18] = ObtieneNotaObjetivos($evaluado, $evaluador, $id_proceso, "");
        }
        //Funcion para traer los resultados individuales de la Evaluacion intermedia en objetivos especificos y Evaluacion de competencias
        $nota_objetivos = $arreglo[18];
        $dato1          = ObtenerCriterioPuntajeMatrizNotaFinal($nota_objetivos, $evaluado, 0, "ind", $evaluador, $id_proceso);
        //COMENTADO 23112015 $nota_objetivos=$dato1[1];
        //Esta corresponde a la etiqueta css del promedio de los objetivos individuales
        $arreglo[0]     = $dato1[2];
        //Para mostrar
        //Este corresponde al Criterio
        $arreglo[1]     = $dato1[0];
        $arreglo[24]    = $dato1[3];
        $arreglo[18]    = round($dato1[1], 2);
    }
    $datos_nota_final_competencia = ObtieneNotaFinalCompetencias($datos_evaluado[0]->perfil_evaluacion, $evaluado, $evaluador, $id_proceso);
    $res_final                    = $datos_nota_final_competencia[0];
    $eval_finalizada              = $datos_nota_final_competencia[1];
    $dato2                        = ObtenerCriterioPuntajeMatrizNotaFinal($res_final, $evaluado, "", "comp", $evaluador, $id_proceso);
    $arreglo[19]                  = $res_final;
    $arreglo[19]                  = round($dato2[1], 2);
    //Esta corresponde a la etiqueta css de la nota final
    $arreglo[2]                   = $dato2[2];
    //Este corresponde al Criterio
    $arreglo[3]                   = $dato2[0];
    //ICONO
    $arreglo[25]                  = $dato2[3];
    //Icono Objetio especifico
    $arreglo[4]                   = $dato1[3];
    $arreglo[5]                   = $dato2[3];
    $arreglo[6]                   = round(CalculaNotaFinal($ponderaciones[0]->objetivos_individuales, $ponderaciones[0]->competencias, round($nota_objetivos, 2), round($res_final, 2)), 2);
    $dato3                        = ObtenerCriterioPuntajeMatriz($arreglo[6], $evaluado, 0);
    //Criterio nota final
    $arreglo[7]                   = $dato3[0];
    //Etiqueta CSS
    $arreglo[8]                   = $dato3[2];
    //Icono
    $arreglo[9]                   = $dato3[3];
    if ($arreglo[6] == 0) {
        //Criterio nota final
        $arreglo[7] = "Pendiente";
        //Etiqueta CSS
        $arreglo[8] = "etiquetaPrograma-pendiente";
        //Icono
        $arreglo[9] = "fa fa-circle-o";
    }
    if ($id_empresa <> 28) {
        //print_r($arreglo);
        //DATOS DEL AREA
        //dado el id del area, obtengo,
        $nota_area          = ObtengoUltimaNotaObjetivoArea($id_area, $id_empresa, $id_proceso);
        $datos_area         = ObtenerCriterioPuntajeMatrizNotaFinal($nota_area[0]->nota_area, $evaluado, "", "area", $evaluador, $id_proceso);
        $nota_area          = $datos_area[1];
        //Criterio Nota Area
        $arreglo[10]        = $datos_area[0];
        //Etiqueta CSS Nota Area
        $arreglo[11]        = $datos_area[2];
        //Icono nota area
        $arreglo[12]        = $datos_area[3];
        //Nota Area
        $arreglo[13]        = $datos_area[1];
        //OBJETIVOS EMPRESA
        $nota_empresa       = ObtengoUltimaNotaObjetivoEmpresa($id_empresa, $id_proceso);
        //$datos_empresa=ObtenerCriterioPuntajeMatriz($nota_empresa[0]->promedio_objetivos_corporativos, $evaluado, 0);
        $datos_empresa      = ObtenerCriterioPuntajeMatrizNotaFinal($nota_empresa[0]->promedio_objetivos_corporativos, $evaluado, 0, "corp", $evaluador, $id_proceso);
        $nota_empresa       = $datos_empresa[1];
        //Criterio Nota Empresa
        $arreglo[14]        = $datos_empresa[0];
        //Etiqueta CSS Nota Empresa
        $arreglo[15]        = $datos_empresa[2];
        //Icono nota Empresa
        $arreglo[16]        = $datos_empresa[3];
        //Nota Empresa
        $arreglo[17]        = $datos_empresa[1];
        //Nota Final entre Nota Objetivo Empresa y Objetivo Area
        $arreglo[20]        = CalculaNotaFinal($ponderaciones[0]->objetivos_area, $ponderaciones[0]->objetivos_empresa, $arreglo[13], $arreglo[17]);
        $datos_empresa_area = ObtenerCriterioPuntajeMatrizNotaFinal($arreglo[20], $evaluado, "", "corp", $evaluador, $id_proceso);
        //Criterio
        $arreglo[21]        = $datos_empresa_area[0];
        //etiqueta css
        $arreglo[22]        = $datos_empresa_area[2];
        //icono
        $arreglo[23]        = $datos_empresa_area[3];
        /*0
        echo $ponderaciones[0]->objetivos_area." ".$datos_area[1]." area<br>";
        echo $ponderaciones[0]->objetivos_empresa." ".$datos_empresa[1]." empresa<br>";
        echo $ponderaciones[0]->objetivos_individuales." ".$nota_objetivos." ind<br>";
        echo $ponderaciones[0]->competencias." ".$res_final." comp<br><br>";
        exit;*/
    }
    // CALCULO FINAL
    if ($nota_objetivos <> '') {
        $nota_final = (($ponderaciones[0]->objetivos_area * $datos_area[1]) / 100) + (($ponderaciones[0]->objetivos_empresa * $datos_empresa[1]) / 100) + (($nota_objetivos * $ponderaciones[0]->objetivos_individuales) / 100) + (($res_final * $ponderaciones[0]->competencias) / 100);
    }
    //if($evaluado=="17528702") {
    //echo "<br>$evaluado nota_objetivos $nota_objetivos, comp $res_final nota $nota_final";    }
    if ($nota_objetivos == '') {
        $nota_final = (($ponderaciones[0]->objetivos_area * $datos_area[1]) / 100) + (($ponderaciones[0]->objetivos_empresa * $datos_empresa[1]) / 100) + (($nota_objetivos * $ponderaciones[0]->objetivos_individuales) / 100) + (($res_final * 100 / 100));
    }
    //echo $nota_objetivos." ".$res_final."<br>";
    $arreglo[27]                  = ColocaDecimalesNotasFinales($datos_proceso[0]->decimales_puntajes, $nota_final, "");
    $datos_nota_final             = ObtenerCriterioPuntajeMatrizNotaFinal($arreglo[27], $evaluado, 0, "nota_final", $evaluador, $id_proceso);
    //echo "<br><br>";
    //Criterio
    $arreglo[28]                  = $datos_nota_final[0];
    //Etiqueta CSS Nota Empresa
    $arreglo[29]                  = $datos_nota_final[2];
    //Icono nota Empresa
    $arreglo[30]                  = $datos_nota_final[3];
    //Valor a mostar para objetivos especificos
    $arreglo[31]                  = $dato1[4];
    //Valor a mostar para competencias
    //$arreglo[32]=$dato2[4];
    $arreglo[32]                  = ColocaDecimalesNotasFinales($datos_proceso[0]->decimales_puntajes, $dato2[4], "");
    //print_r($datos_proceso);
    //Valor a mostar para area
    $arreglo[33]                  = $datos_area[4];
    //Valor a mostar para corporativos
    $arreglo[34]                  = $datos_empresa[4];
    //Nota final con datos a mostrar, y no con datos dfe campo puntaje
    $nota_final_con_datos_puntaje = (($ponderaciones[0]->objetivos_area * $arreglo[33]) / 100) + (($ponderaciones[0]->objetivos_empresa * $arreglo[34]) / 100) + (($arreglo[31] * $ponderaciones[0]->objetivos_individuales) / 100) + (($arreglo[32] * $ponderaciones[0]->competencias) / 100);
    //Nota final calculado con campo valor a mostrar
    $arreglo[35]                  = round($nota_final_con_datos_puntaje);
    $acum_dimension               = 0;
    $dimensiones                  = ObtengoDimensionesDadoPerfil($datos_evaluado[0]->perfil_evaluacion);
    //AUTOEVALUACION //OJOOO ESTO DEBE SER CON LA FUNCION QUE DEVUELVE LA NOTA FINAL
    foreach ($dimensiones as $dim) {
        //Ahora por cada dimension, traigo las competencias
        //$competencias=CompetenciasDadoDimension($dim->id_dimension);
        $competencias                    = CompetenciasDadoDimensionYPerfil($dim->id_dimension, $datos_evaluado[0]->perfil_evaluacion);
        //$competencias=CompetenciasDadoDimensionYPerfil($dim->id_dimension, $datos_evaluado[0]->perfil_evaluacion);
        $cont_competencias_por_dimension = 0;
        $acum_comp                       = 0;
        foreach ($competencias as $comp) {
            //Promedio de respuestas por competencias
            //$prom_com=PromedioRespuestasComp($evaluado, $evaluador, $comp->id);
            $prom_com  = PromedioRespuestasCompPorProceso($evaluado, $evaluado, $comp->id, $id_proceso);
            //echo "promedio ".$prom_com[0]->nota_competencia."<br>";
            $acum_comp = $acum_comp + $prom_com[0]->nota_competencia;
        }
        //el promedio de esta dimension
        $acum_dimension = $acum_dimension + ($acum_comp / count($competencias));
        //echo "promedio dimension ".($acum_comp/count($competencias))."   ".$acum_comp." --- ".count($competencias)."  <br>";
    }
    //ACA VERIFICO SI LA EVAL ESTA FINALIZADA
    $finalizada_eval_ae = FinalizadoEvaluadoEvaluador($evaluado, $evaluado, $id_proceso);
    if ($finalizada_eval_ae) {
        $res_final_ae = $acum_dimension / count($dimensiones);
    } else {
        $res_final_ae = "";
    }
    //echo $evaluado." ".count($dimensiones)."<br>";
    $dato_ae     = ObtenerCriterioPuntajeMatrizNotaFinal($res_final_ae, $evaluado, "", "comp", $evaluador, $id_proceso);
    $arreglo[36] = $res_final_ae;
    $arreglo[37] = $dato_ae[1];
    //print_r($dato2);
    //Esta corresponde a la etiqueta css de la nota final
    $arreglo[38] = $dato_ae[2];
    //Este corresponde al Criterio
    $arreglo[39] = $dato_ae[0];
    //ICONO
    $arreglo[40] = $dato_ae[3];
    $arreglo[41] = $eval_finalizada;
    return ($arreglo);
}
function InformeIndividualEval($html, $evaluado, $evaluador, $id_proceso, $id_empresa, $feedback, $pdf)
{
    //La variable feedback, es para cuando se ve el informe completo, desde la vista del evaluado.
    //echo "evaluado $evaluado, evaluador $evaluador, id_proceso, $id_proceso";
    $datos_proceso_evaluacion = TraeProcesosDeEvaluacionPorEmpresaYDiProceso($id_empresa, $id_proceso);
    $decimales_para_proceso   = $datos_proceso_evaluacion[0]->decimales_puntajes;
    //$datos_evaluado=UsuarioEnBasePersonas($evaluado);
    $datos_evaluado           = UsuarioEnBasePersonasConRelacionEvaluadoEvaluador($evaluado, $evaluador, $id_proceso);
    //Bloque Resumen Superior
    if ($id_empresa == 43) {
        $template_top = file_get_contents("views/sgd/informe/tabla_superior_informe_eval.html");
    } else if ($evaluado == $_SESSION["user_"]) {
        $template_top = file_get_contents("views/sgd/informe/" . $id_empresa . "_tabla_superior_informe_ae.html");
    } else {
        if ($pdf == "si") {
            $template_top = file_get_contents("views/sgd/informe/PDF_tabla_superior_informe.html");
        } else {
            $template_top = file_get_contents("views/sgd/informe/" . $id_empresa . "_tabla_superior_informe.html");
        }
    }
    //$total_evaluados.=ColocaDatosUsuario($template_top, $evaluado, "", $evaluador, $id_proceso);
    $total_evaluados .= ColocaDatosUsuarioSGD($template_top, $evaluado, "", $evaluador, $id_proceso);
    $total_evaluados = str_replace("{TABLA_RESUMEN1}", file_get_contents("views/sgd/informe/tabla_superior_resumen/tabla_resumen1_sinareacorp_dinamico.html"), $total_evaluados);
    //$total_evaluados=ArmaTemplareDeTablaResumen($total_evaluados, $_SESSION["ano_proceso_anual"], $id_empresa, $datos_evaluado[0]->perfil_evaluacion, $evaluado, $evaluador, "no");
    $total_evaluados = ArmaTemplareDeTablaResumen($total_evaluados, $_SESSION["ano_proceso_anual"], $id_empresa, $datos_evaluado[0]->perfil_evaluacion, $evaluado, $evaluador, "no");
    //exit;
    $html            = str_replace("{BLOQUE_RESUMEN_EVALUADO}", $total_evaluados, $html);
    $html            = str_replace("{PASOS}", "", $html);
    //Bloque de detalle por competencias
    //echo "evaluado $evaluado evaluador $evaluador";
    //$competencias=CompetenciasDadoPerfil($datos_evaluado[0]->perfil_evaluacion, $evaluado, $evaluador);
    $competencias    = CompetenciasDadoPerfilPorProceso($datos_evaluado[0]->perfil_evaluacion, $evaluado, $evaluador, $id_proceso);
    $html            = str_replace("{NOMBRE_INFORME_EVALUACION}", utf8_encode($datos_proceso_evaluacion[0]->titulo_informes_proceso), $html);
    $html            = str_replace("{GRAFICOROLES}", file_get_contents("views/sgd/graficos/" . $id_empresa . "_graficoRoles.html"), $html);
    $html            = str_replace("{GRAFICODETERMINANTES}", file_get_contents("views/sgd/graficos/" . $id_empresa . "_graficoDeterminantes.html"), $html);
    //Aca pregunto si es que se muestra o no el promedio de las competencias.
    if ($datos_proceso_evaluacion[0]->muestra_promedio_competencias == 1) {
        $row                      = file_get_contents("views/sgd/informe/row_informe1_comp.html");
        $row                      = str_replace("{NOMBRE}", "Promedio por Competencias", $row);
        $nota_final_competencias  = ObtieneNotaFinalCompetencias($datos_evaluado[0]->perfil_evaluacion, $evaluado, $evaluador, $id_proceso);
        //$criterios_nota_final=ObtenerCriterioPuntajeMatrizNotaFinal($nota_final_competencias[0], $evaluado, "", "comp");
        $criterios_nota_final     = ObtenerCriterioPuntajeMatrizNotaFinal($nota_final_competencias[0], $evaluado, "", "comp", $evaluador, $id_proceso);
        $row                      = str_replace("{NOMBRE}", "Promedio por Competencias", $row);
        $row                      = str_replace("{ESTILO_ETIQUETA}", $criterios_nota_final[2], $row);
        $row                      = str_replace("{ICONO}", $criterios_nota_final[3], $row);
        $row                      = str_replace("{CRITERIO}", $criterios_nota_final[0], $row);
        //$row = str_replace("{NOTA}",FormatearPorcentajesSinDecimal($nota_final_competencias[0])."%",$row);
        $row                      = str_replace("{NOTA}", FormatearPorcentajesSinDecimal($nota_final_competencias[0]) . "", $row);
        $template_row_competencia = file_get_contents("views/sgd/informe/row_informe1_comp_v2.html");
    } else {
        //BLOQUE PARA PROMEDIO DE LA COMPETENCIA
        if ($feedback == "feedback") {
            $template_row_competencia = file_get_contents("views/sgd/informe/row_informe1_comp_con_ae.html");
        } else if ($datos_proceso_evaluacion[0]->muestra_ae_evaluacion == 1 && $evaluado <> $_SESSION["user_"]) {
            if ($pdf == "pdf") {
                $template_row_competencia = file_get_contents("views/sgd/informe/row_informe1_comp_con_ae_PDF.html");
            } else {
                if ($_GET["mae"] == 1) {
                    $template_row_competencia = file_get_contents("views/sgd/informe/" . $id_empresa . "_row_informe1_comp.html");
                } else {
                    $template_row_competencia   = file_get_contents("views/sgd/informe/" . $id_empresa . "_row_informe1_comp_con_ae.html");
                    $template_solo_competencias = file_get_contents("views/sgd/informe/row_informe1_comp_con_ae.html");
                }
            }
        } else if ($datos_proceso_evaluacion[0]->muestra_ae_evaluacion == 2) {
            $template_row_competencia = file_get_contents("views/sgd/informe/row_informe1_comp_eval.html");
        } else {
            if ($_GET["veEval"] == 1) {
                $template_row_competencia   = file_get_contents("views/sgd/informe/" . $id_empresa . "_row_informe1_comp_con_ae.html");
                $template_solo_competencias = file_get_contents("views/sgd/informe/row_informe1_comp_con_ae.html");
            } else {
                $template_row_competencia = file_get_contents("views/sgd/informe/" . $id_empresa . "_row_informe1_comp.html");
            }
            //$template_row_competencia=file_get_contents("views/sgd/informe/row_informe1_comp.html");
        }
    }
    $i                                  = 0;
    $contador_graficos_por_competencias = 1;
    foreach ($competencias as $com) {
        //$row.=file_get_contents("views/sgd/informe/row_informe1_comp.html");
        $row .= $template_row_competencia;
        $criterios                         = ObtenerCriterioPuntajeMatrizNotaFinal($com->nota_promedio, $evaluado, "", "comp", $evaluador, $id_proceso);
        $row                               = str_replace("{NOMBRE}", $com->nombre_componente, $row);
        //$matriz_competencias[$i]["nombre"]=$com->sigla;
        $matriz_competencias[$i]["nombre"] = $com->nombre_componente;
        $row                               = str_replace("{DESCRIPCION}", $com->descripcion_componente, $row);
        $row                               = str_replace("{PONDERACION}", "", $row);
        $row                               = str_replace("{ESTILO_ETIQUETA}", $criterios[2], $row);
        $row                               = str_replace("{ICONO}", $criterios[3], $row);
        $row                               = str_replace("{CRITERIO}", $criterios[0], $row);
        //$row = str_replace("{NOTA}",FormatearPorcentajesSinDecimal($com->nota_promedio)."%",$row);
        //$row = str_replace("{NOTA}",ColocaDecimalesNotasFinales($decimales_para_proceso, $com->nota_promedio, $tipo)."%",$row);
        $row                               = str_replace("{NOTA}", ColocaDecimalesNotasFinales($decimales_para_proceso, $com->nota_promedio, $tipo) . "", $row);
        //Bloque para cuando es solo la competencia
        $row_solo_competencia .= $template_solo_competencias;
        $row_solo_competencia = str_replace("{NOMBRE}", $com->nombre_componente, $row_solo_competencia);
        $row_solo_competencia = str_replace("{DESCRIPCION}", $com->descripcion_componente, $row_solo_competencia);
        $row_solo_competencia = str_replace("{PONDERACION}", "", $row_solo_competencia);
        $row_solo_competencia = str_replace("{ESTILO_ETIQUETA}", $criterios[2], $row_solo_competencia);
        $row_solo_competencia = str_replace("{ICONO}", $criterios[3], $row_solo_competencia);
        $row_solo_competencia = str_replace("{CRITERIO}", $criterios[0], $row_solo_competencia);
        $row_solo_competencia = str_replace("{NOTA}", ColocaDecimalesNotasFinales($decimales_para_proceso, $com->nota_promedio, $tipo) . "", $row_solo_competencia);
        $arreglo_para_grafico_promedio_competencias .= round($com->nota_promedio, 2);
        $arreglo_para_grafico_promedio_competencias_texto .= '"' . $com->sigla . '" ';
        if ($contador_graficos_por_competencias < count($competencias)) {
            $arreglo_para_grafico_promedio_competencias .= ", ";
            $arreglo_para_grafico_promedio_competencias_texto .= ", ";
        }
        $contador_graficos_por_competencias++;
        //$matriz_competencias[$i]["nota"]=($com->nota_promedio);
        $matriz_competencias[$i]["nota"] = ($com->nota_promedio);
        $tiene_resultados                = CALCULA_TieneResultadosPorCometencciaCalculados($evaluado, $evaluador, $id_proceso, $com->id);
        if ($tiene_resultados) {
            //Actualiza
            CALCULA_ActualizaResultadosCalculados($evaluado, $evaluador, $datos_evaluado[0]->calibrador, $id_proceso, $com->id_componente, $com->nota_promedio, $criterios[0], $datos_evaluado[0]->perfil_evaluacion, $datos_evaluado[0]->subperfil);
        } else {
            //Inserta
            CALCULA_InsertaResultadosCalculados($evaluado, $evaluador, $datos_evaluado[0]->calibrador, $id_proceso, $com->id_componente, $com->nota_promedio, $criterios[0], $datos_evaluado[0]->perfil_evaluacion, $datos_evaluado[0]->subperfil);
        }
        if ($evaluado == $evaluador) {
            $datos_resumen_nota_final = ResultadosFinales($evaluado, $evaluado, $id_proceso, $id_etapa_evaluacion);
            ActualizaNotaFinalTablaFinalizados($evaluado, $evaluado, $id_proceso, $datos_resumen_nota_final[19], $datos_resumen_nota_final[3]);
        } else {
            $datos_resumen_nota_final = ResultadosFinales($evaluado, $evaluador, $id_proceso, $id_etapa_evaluacion);
            ActualizaNotaFinalTablaFinalizados($evaluado, $evaluador, $id_proceso, $datos_resumen_nota_final[19], $datos_resumen_nota_final[3]);
        }
        //AE
        //BLOQUE PARA MOSTRAR NOTAS AE
        $competencias_ae      = CompetenciasDadoPerfilPorCompetencia($datos_evaluado[0]->perfil_evaluacion, $evaluado, $evaluado, $com->id_competencia);
        $competencias_ae      = CompetenciasDadoPerfilPorCompetenciaPorProceso($datos_evaluado[0]->perfil_evaluacion, $evaluado, $evaluado, $com->id_competencia, $id_proceso);
        $criterios_ae         = ObtenerCriterioPuntajeMatrizNotaFinal($competencias_ae[0]->nota_promedio, $evaluado, "", "comp", $evaluador, $id_proceso);
        $row                  = str_replace("{ESTILO_ETIQUETA_AE}", $criterios_ae[2], $row);
        $row                  = str_replace("{ICONO_AE}", $criterios_ae[3], $row);
        $row                  = str_replace("{CRITERIO_AE}", $criterios_ae[0], $row);
        $row                  = str_replace("{NOTA_AE}", ColocaDecimalesNotasFinales($decimales_para_proceso, $competencias_ae[0]->nota_promedio, $tipo) . "", $row);
        //SECCION PARA ROLES / COMPETENCIAS
        $row_solo_competencia = str_replace("{ESTILO_ETIQUETA_AE}", $criterios_ae[2], $row_solo_competencia);
        $row_solo_competencia = str_replace("{ICONO_AE}", $criterios_ae[3], $row_solo_competencia);
        $row_solo_competencia = str_replace("{CRITERIO_AE}", $criterios_ae[0], $row_solo_competencia);
        $row_solo_competencia = str_replace("{NOTA_AE}", ColocaDecimalesNotasFinales($decimales_para_proceso, $competencias_ae[0]->nota_promedio, $tipo) . "", $row_solo_competencia);
        $arreglo_grafico_determinantes_valor .= $competencias_ae[0]->nota_promedio;
        $matriz_competencias[$i]["nota_ae"] = ($competencias_ae[0]->nota_promedio);
        $i++;
        //Por cada competencia veo si tiene mas de una pregunta ,si es asi, las muestra, con la
        //Respuesta correspondiente
        if ($com->muestra_preguntas_informe == 1) {
            $preguntas_por_competencias = PreguntasPorCompetenciaConRespuesta($com->id_competencia, $evaluado, $evaluador, $id_proceso);
            $row_preg                   = "";
            //echo "$evaluado $evaluador <br>";
            foreach ($preguntas_por_competencias as $preg_uni) {
                if ($feedback == "feedback") {
                    //$template_row_competencia=file_get_contents("views/sgd/informe/row_informe1_comp_con_ae.html");
                    $row_preg .= file_get_contents("views/sgd/informe/row_informe1.1_comp_con_ae.html");
                    //}else if($datos_proceso_evaluacion[0]->muestra_ae_evaluacion==1 && $evaluado<>$_SESSION["user_"]){
                } else if ($datos_proceso_evaluacion[0]->muestra_ae_evaluacion == 1 && $evaluado <> $_SESSION["user_"]) {
                    if ($pdf == "pdf") {
                        $row_preg .= file_get_contents("views/sgd/informe/row_informe1.1_comp_con_ae_PDF.html");
                    } else {
                        //$row_preg.=file_get_contents("views/sgd/informe/row_informe1.1_comp_con_ae.html");
                        if ($_GET["mae"] == 1) {
                            $row_preg .= file_get_contents("views/sgd/informe/" . $id_empresa . "_row_informe1.1_comp.html");
                            $row_comentario_por_pregunta = file_get_contents("views/sgd/informe/" . $id_empresa . "_row_informe_comentario_por_pregunta.html");
                        } else {
                            $row_preg .= file_get_contents("views/sgd/informe/" . $id_empresa . "_row_informe1.1_comp_con_ae.html");
                            $row_comentario_por_pregunta = file_get_contents("views/sgd/informe/" . $id_empresa . "_row_informe_comentario_por_pregunta_con_ae.html");
                        }
                    }
                } else if ($datos_proceso_evaluacion[0]->muestra_ae_evaluacion == 2) {
                    $row_preg .= file_get_contents("views/sgd/informe/row_informe1.1_comp_eval.html");
                } else {
                    if ($_GET["veEval"] == 1) {
                        $row_preg .= file_get_contents("views/sgd/informe/" . $id_empresa . "_row_informe1.1_comp_con_ae.html");
                        $row_comentario_por_pregunta = file_get_contents("views/sgd/informe/" . $id_empresa . "_row_informe_comentario_por_pregunta_con_ae.html");
                    } else {
                        //$row_preg.=file_get_contents("views/sgd/informe/row_informe1.1_comp.html");
                        $row_preg .= file_get_contents("views/sgd/informe/" . $id_empresa . "_row_informe1.1_comp.html");
                        $row_comentario_por_pregunta = file_get_contents("views/sgd/informe/" . $id_empresa . "_row_informe_comentario_por_pregunta.html");
                    }
                }
                $row_preg               = str_replace("{NOMBRE_1}", $preg_uni->pregunta . "", $row_preg);
                $row_preg               = str_replace("{DESCRIPCION_1}", "", $row_preg);
                $row_preg               = str_replace("{PONDERACION_1}", "", $row_preg);
                $criterios_detalle_preg = ObtenerCriterioPuntajeMatrizNotaFinal($preg_uni->puntaje, $evaluado, "", "comp", $evaluador, $id_proceso);
                $row_preg               = str_replace("{ESTILO_ETIQUETA_1}", $criterios_detalle_preg[2], $row_preg);
                $row_preg               = str_replace("{ICONO_1}", $criterios_detalle_preg[3], $row_preg);
                $row_preg               = str_replace("{CRITERIO_1}", $criterios_detalle_preg[0], $row_preg);
                //$row_preg = str_replace("{NOTA_1}",FormatearPorcentajesSinDecimal($preg_uni->puntaje)."%",$row_preg);
                //$row_preg = str_replace("{NOTA_1}",FormatearPorcentajesSinDecimal($preg_uni->puntaje)."",$row_preg);
                $row_preg               = str_replace("{NOTA_1}", ColocaDecimalesNotasFinales($decimales_para_proceso, $preg_uni->puntaje, $tipo) . "", $row_preg);
                ${"coontador_variable_dinamica" . $preg_uni->descripcion}++;
                //    echo ${"coontador_variable_dinamica".$preg_uni->descripcion}."<br>";
                //$arreglo_notas_por_descripcion[$preg_uni->id_determinante][${"coontador_variable_dinamica".$preg_uni->descripcion}][$preg_uni->id]=$preg_uni->puntaje;
                $arreglo_notas_por_descripcion[$preg_uni->id_determinante][$preg_uni->id] = $preg_uni->puntaje;
                //PARA AE
                $preguntas_por_competencias_ae                                            = PreguntasPorCompetenciaConRespuestaPorPregunta($com->id_competencia, $evaluado, $evaluado, $id_proceso, $preg_uni->id);
                $criterios_detalle_preg_ae                                                = ObtenerCriterioPuntajeMatrizNotaFinal($preguntas_por_competencias_ae[0]->puntaje, $evaluado, "", "comp", $evaluador, $id_proceso);
                $row_preg                                                                 = str_replace("{ESTILO_ETIQUETA_1_AE}", $criterios_detalle_preg_ae[2], $row_preg);
                $row_preg                                                                 = str_replace("{ICONO_1_AE}", $criterios_detalle_preg_ae[3], $row_preg);
                $row_preg                                                                 = str_replace("{CRITERIO_1_AE}", $criterios_detalle_preg_ae[0], $row_preg);
                //$row_preg = str_replace("{NOTA_1_AE}",FormatearPorcentajesSinDecimal($preguntas_por_competencias_ae[0]->puntaje)."",$row_preg);
                $row_preg                                                                 = str_replace("{NOTA_1_AE}", ColocaDecimalesNotasFinales($decimales_para_proceso, $preguntas_por_competencias_ae[0]->puntaje, $tipo) . "", $row_preg);
                //$row_preg = str_replace("{PORCENTAJEEVALPREGUNTA}",round(25*$preguntas_por_competencias_ae[0]->puntaje-25)."",$row_preg);
                $row_preg                                                                 = str_replace("{PORCENTAJEEVALPREGUNTA}", round(20 * $preguntas_por_competencias_ae[0]->puntaje) . "", $row_preg);
                $row_preg                                                                 = str_replace("{VALORPORCENTAJE}", ColocaDecimalesNotasFinales($decimales_para_proceso, $preguntas_por_competencias_ae[0]->puntaje, $tipo) . "", $row_preg);
                $row_preg                                                                 = str_replace("{ESTILO_ETIQUETA_1_AE}", $criterios_detalle_preg_ae[2], $row_preg);
                if ($preg_uni->comentario) {
                    //$row_preg = str_replace("{BLOQUE_COMENTARIO_POR_PREGUNTA}",file_get_contents("views/sgd/informe/".$id_empresa."_row_informe_comentario_por_pregunta.html"),$row_preg);
                    $row_preg = str_replace("{BLOQUE_COMENTARIO_POR_PREGUNTA}", $row_comentario_por_pregunta, $row_preg);
                    $row_preg = str_replace("{COMENTARIO_POR_PREGUNTA}", $preg_uni->comentario, $row_preg);
                } else {
                    $row_preg = str_replace("{BLOQUE_COMENTARIO_POR_PREGUNTA}", "", $row_preg);
                }
                if ($preguntas_por_competencias_ae[0]->comentario) {
                    $row_preg = str_replace("{BLOQUE_COMENTARIO_POR_PREGUNTA_AE}", $row_comentario_por_pregunta, $row_preg);
                    $row_preg = str_replace("{COMENTARIO_POR_PREGUNTA}", $preguntas_por_competencias_ae[0]->comentario, $row_preg);
                } else {
                    $row_preg = str_replace("{BLOQUE_COMENTARIO_POR_PREGUNTA_AE}", "", $row_preg);
                }
            }
        }
        $row .= $row_preg;
        //Aca si es PDF, verifico si tiene cometarios por competencias, si es asi, traigo los comentarios por competencia de ae y jefe, y si estan, concateno template
        $tiene_comentario_desc = TieneComentarioPorCompetencia($evaluado, $evaluador, $com->id_competencia, $id_empresa, $id_proceso);
        if ($tiene_comentario_desc) {
            $row .= file_get_contents("views/sgd/informe/row_informe_comentarios_por_competencias_PDF.html");
            $row = str_replace("{TIPO_COMENTARIO}", "Comentario Evaluaci&oacute;n", $row);
            $row = str_replace("{COMENTARIO}", $tiene_comentario_desc[0]->comentario, $row);
        }
        //print_r($tiene_comentario_desc);
        $tiene_comentario_ae = TieneComentarioPorCompetencia($evaluado, $evaluado, $comp->id_competencia, $id_empresa, $id_proceso);
        if ($tiene_comentario_ae) {
            $row .= file_get_contents("views/sgd/informe/row_informe_comentarios_por_competencias_PDF.html");
            $row = str_replace("{TIPO_COMENTARIO}", "Comentario Autoevaluaci&oacute;n", $row);
            $row = str_replace("{COMENTARIO}", $tiene_comentario_ae[0]->comentario, $row);
        }
    }
    //echo "<pre>";
    //print_r(($arreglo_notas_por_descripcion));
    //Traigo el total de los determinantes por empresa
    $total_determinantes    = TotalDeterminantes($id_empresa);
    $contador_determinantes = 1;
    foreach ($total_determinantes as $determinante) {
        //print_r(($arreglo_notas_por_descripcion[$determinante->id]));
        $acumulador_por_determinantes = 0;
        //for($l=1;$l<=count($arreglo_notas_por_descripcion[$determinante->id]);$l++){
        //$acumulador_por_determinantes++;
        //Traigo las preguntas por Determinantes
        $preguntas_por_determinante   = TraigoPreguntasPorDeterminantesEmpresa($determinante->id, $id_empresa);
        $acumulador_por_determinantes = 0;
        $suma_notas                   = 0;
        foreach ($preguntas_por_determinante as $preg_det) {
            //echo $preg_det->id;
            $acumulador_por_determinantes++;
            //echo $arreglo_notas_por_descripcion[$determinante->id][$preg_det->id];
            $suma_notas = $suma_notas + $arreglo_notas_por_descripcion[$determinante->id][$preg_det->id];
        }
        //echo $determinante->id." suma ".$suma_notas." contador ".$acumulador_por_determinantes."<br>";
        $promedio_determinantes = $suma_notas / $acumulador_por_determinantes;
        $row_dete .= file_get_contents("views/sgd/informe/row_informe_determinante.html");
        $row_dete                = str_replace("{NOMBRE}", utf8_encode($determinante->determinante), $row_dete);
        $criterios_determinantes = ObtenerCriterioPuntajeMatrizNotaFinal($promedio_determinantes, $evaluado, "", "comp", $evaluador, $id_proceso);
        $row_dete                = str_replace("{ESTILO_ETIQUETA}", $criterios_determinantes[2], $row_dete);
        $row_dete                = str_replace("{ICONO}", $criterios_determinantes[3], $row_dete);
        $row_dete                = str_replace("{CRITERIO}", $criterios_determinantes[0], $row_dete);
        $row_dete                = str_replace("{NOTA}", ColocaDecimalesNotasFinales($decimales_para_proceso, $promedio_determinantes, $tipo) . "", $row_dete);
        $arreglo_para_grafico_determinantes .= $promedio_determinantes;
        //$arreglo_para_grafico_determinantes_nombres.='"'.utf8_encode($determinante->determinante).'"';
        $arreglo_para_grafico_determinantes_nombres .= "'" . utf8_encode($determinante->sigla) . "'";
        if ($contador_determinantes < count($total_determinantes)) {
            $arreglo_para_grafico_determinantes .= ",";
            $arreglo_para_grafico_determinantes_nombres .= ",";
        }
        $contador_determinantes++;
        //}
    }
    //echo $arreglo_para_grafico_determinantes_nombres;
    //echo $arreglo_para_grafico_determinantes;
    //$html = str_replace("{ARREGLO_VALORES_DETERMINANTES}",$arreglo_para_grafico_determinantes,$html);
    //$html = str_replace("{ARREGLO_NOMBRE_DETERMINANTES}",$arreglo_para_grafico_determinantes_nombres,$html);
    $html = colocaGraficoPromedioPorDeterminantes($html, $evaluador, $id_proceso, $evaluado);
    //exit;
    $html = str_replace("{LISTADO_COMPETENCIAS}", utf8_encode($row), $html);
    $html = str_replace("{LISTADO_SOLO_COMPETENCIAS}", utf8_encode($row_solo_competencia), $html);
    for ($j = 1; $j <= count($arreglo_notas_por_descripcion); $j++) {
        //$row_dete.=file_get_contents("views/sgd/informe/row_informe_determinante.html");
    }
    //$html = str_replace("{LISTADO_DETERMINANTES}",utf8_encode($row_dete),$html);
    //OBJETIVOS ESPECIFICOS
    //Aca se especifican el detalle de los objetivos especificos
    //$objetivos=ObjetivosEspecificosConRespuesta($evaluado);
    $bloque_listado_objetivos_especificos = BloqueListadoObjetivoEspecificos($evaluado, $evaluador, $id_proceso, $id_empresa, "si");
    if ($bloque_listado_objetivos_especificos) {
        $html = str_replace("{BLOQUE_ESPECIFICOS}", file_get_contents("views/sgd/informe/" . $id_empresa . "_entorno_informe_bloque_objetivos.html"), $html);
        $html = str_replace("{LISTADO_OBJETIVOS}", utf8_encode($bloque_listado_objetivos_especificos), $html);
    } else {
        $html = str_replace("{BLOQUE_ESPECIFICOS}", "", $html);
    }
    //Objetivos Empresa
    $objetivos_empresa = ObjetivosDeEmpresaConNota($datos_evaluado[0]->id_empresa, $id_proceso);
    if ($objetivos_empresa) {
        $html = str_replace("{BLOQUE_COORPORATIVOS}", file_get_contents("views/sgd/informe/entorno_informe_bloque_corporativo.html"), $html);
        foreach ($objetivos_empresa as $ob) {
            //$row3.=file_get_contents("views/sgd/informe/row_informe1_desactivado.html");
            $row3 .= file_get_contents("views/sgd/informe/row_informe1.html");
            $row3   = str_replace("{NOMBRE}", $ob->descripcion_objetivo, $row3);
            $row3   = str_replace("{PONDERACION}", "30%", $row3);
            $row3   = str_replace("{DESCRIPCION}", "", $row3);
            $datos3 = ObtenerCriterioPuntajeMatrizNotaFinal($ob->nota, $evaluado, "", "corp", $evaluador, $id_proceso);
            $row3   = str_replace("{NOTA}", FormatearPorcentajesSinDecimal($ob->nota) . "%", $row3);
            $row3   = str_replace("{ESTILO_ETIQUETA}", $datos3[2], $row3);
            $row3   = str_replace("{CRITERIO}", $datos3[0], $row3);
            $row3   = str_replace("{ICONO}", $datos3[3], $row3);
        }
        $html = str_replace("{LISTADO_OBJETIVOS_CORPORATIVOS}", utf8_encode($row3), $html);
    } else {
        $html = str_replace("{BLOQUE_COORPORATIVOS}", "", $html);
    }
    //OBJETIVOS AREA
    $datos_usuario  = UsuarioEnBasePersonasInnerArea($evaluado);
    //con el id del area, y el id de la empresa, traigo los datos de los objetivos de area
    $objetivos_area = DatosObjetivosAreaConNota($datos_usuario[0]->id_area, $datos_usuario[0]->id_empresa, $id_proceso);
    if ($objetivos_area) {
        $html = str_replace("{BLOQUE_AREA}", file_get_contents("views/sgd/informe/entorno_informe_bloque_area.html"), $html);
        foreach ($objetivos_area as $objar) {
            //$row4.=file_get_contents("views/sgd/informe/row_informe1_desactivado.html");
            $row4 .= file_get_contents("views/sgd/informe/row_informe1.html");
            $row4   = str_replace("{NOMBRE}", $objar->descripcion_objetivo, $row4);
            $row4   = str_replace("{PONDERACION}", "30%", $row4);
            $row4   = str_replace("{DESCRIPCION}", "", $row4);
            $datos4 = ObtenerCriterioPuntajeMatrizNotaFinal($objar->nota, $evaluado, "", "area");
            $row4   = str_replace("{NOTA}", FormatearPorcentajesSinDecimal($objar->nota), $row4);
            $row4   = str_replace("{ESTILO_ETIQUETA}", $datos4[2], $row4);
            $row4   = str_replace("{CRITERIO}", $datos4[0], $row4);
            $row4   = str_replace("{ICONO}", $datos4[3], $row4);
        }
        $html = str_replace("{LISTADO_OBJETIVOS_AREA}", utf8_encode($row4), $html);
    } else {
        $html = str_replace("{BLOQUE_AREA}", "", $html);
    }
    $datos_evaluacion_resultados  = ResultadosFinales($evaluado, $evaluador, $id_procesoo);
    $html                         = str_replace("{ESTILO_OBJIND}", $datos_evaluacion_resultados[0], $html);
    $html                         = str_replace("{ICONO_OBJIND}", $datos_evaluacion_resultados[4], $html);
    $html                         = str_replace("{CRITERIO_OBJETIVOS_IND}", $datos_evaluacion_resultados[1], $html);
    $html                         = str_replace("{ESTILO_COMP}", $datos_evaluacion_resultados[2], $html);
    $html                         = str_replace("{ICONO_COMP}", $datos_evaluacion_resultados[5], $html);
    $html                         = str_replace("{CRITERIO_COMPETENCIAS}", $datos_evaluacion_resultados[3], $html);
    //Graficos Individuales
    $html                         = str_replace("{GRAFICO_COMPETENCIAS}", GraficoPorCompetenciasPorEvaluadorCalibrador($evaluador, $id_proceso, "", $evaluado), $html);
    //Grafico de Ara?a
    $html                         = str_replace("{GRAFICO_ARANA}", GraficoArana($matriz_competencias), $html);
    //BLOQUE DE COMENTARIO FINAL DE LA EVALUACION
    $tiene_preguntas_finales_desc = TieneComentariosFinalesSGD($evaluado, $evaluador, $id_proceso);
    $tiene_preguntas_finales_ae   = TieneComentariosFinalesSGD($evaluado, $evaluado, $id_proceso);
    if ($tiene_preguntas_finales_desc or $tiene_preguntas_finales_ae) {
        if ($pdf == "pdf") {
            $html = str_replace("{BLOQUE_COMENTARIOS_FINALES}", file_get_contents("views/sgd/informe/entorno_comentarios_finales_PDF.html"), $html);
            $html = str_replace("{BLOQUE_COMENTARIOS_FINALES_AE}", file_get_contents("views/sgd/informe/entorno_comentarios_finales_ae_PDF.html"), $html);
        } else {
            $html = str_replace("{BLOQUE_COMENTARIOS_FINALES}", file_get_contents("views/sgd/informe/entorno_comentarios_finales.html"), $html);
            $html = str_replace("{BLOQUE_COMENTARIOS_FINALES_AE}", file_get_contents("views/sgd/informe/entorno_comentarios_finales_ae.html"), $html);
        }
        $html = str_replace("{COMENTARIO_FINAL_DESC}", utf8_encode($tiene_preguntas_finales_desc[0]->comentario), $html);
        $html = str_replace("{COMENTARIO_FINAL_AE}", utf8_encode($tiene_preguntas_finales_ae[0]->comentario), $html);
    } else {
        $html = str_replace("{BLOQUE_COMENTARIOS_FINALES}", "", $html);
    }
    if ($pdf = "pdf") {
        $html = str_replace("{BLOQUE_COMENTARIOS_POR_COMPETENCIAS}", "", $html);
        $html = str_replace("{BLOQUE_COMENTARIOS_POR_COMPETENCIAS_AE}", "", $html);
    } else {
        $html = str_replace("{BLOQUE_COMENTARIOS_POR_COMPETENCIAS}", file_get_contents("views/sgd/informe/entorno_comentarios_por_competencia.html"), $html);
        $html = str_replace("{BLOQUE_COMENTARIOS_POR_COMPETENCIAS_AE}", file_get_contents("views/sgd/informe/entorno_comentarios_por_competencia_ae.html"), $html);
    }
    //$comentarios_por_competencias_des=TieneComentarioPorCompetenciaEvaluadoEvaluador($evaluado, $evaluador, $id_empresa, $id_proceso);
    //print_r($comentarios_por_competencias_des);
    //echo "<br><br>";
    //$comentarios_por_competencias_ae=TieneComentarioPorCompetenciaEvaluadoEvaluador($evaluado, $evaluado, $id_empresa, $id_proceso);
    //print_r($comentarios_por_competencias_ae);
    //if($comentarios_por_competencias_des or $comentarios_por_competencias_ae){
    foreach ($competencias as $comp) {
        //echo "<br>".$comp->id_competencia;
        $tiene_comentario_desc = TieneComentarioPorCompetencia($evaluado, $evaluador, $comp->id_competencia, $id_empresa, $id_proceso);
        //print_r($tiene_comentario_desc);
        $tiene_comentario_ae   = TieneComentarioPorCompetencia($evaluado, $evaluado, $comp->id_competencia, $id_empresa, $id_proceso);
        if ($tiene_comentario_desc or $tiene_comentario_ae) {
            if ($tiene_comentario_ae) {
                $row_comentarios_competencia_ae .= file_get_contents("views/sgd/informe/row_comentarios_competencias_ae.html");
                $row_comentarios_competencia_ae = str_replace("{COMPETENCIA}", $comp->nombre_componente, $row_comentarios_competencia_ae);
                $row_comentarios_competencia_ae = str_replace("{COMENTARIO_AE_SOLO}", $tiene_comentario_ae[0]->comentario, $row_comentarios_competencia_ae);
            }
            $row_comentarios_competencia .= file_get_contents("views/sgd/informe/row_comentarios_competencias.html");
            $row_comentarios_competencia = str_replace("{COMPETENCIA}", $comp->nombre_componente, $row_comentarios_competencia);
            $row_comentarios_competencia = str_replace("{COMENTARIO_DESC}", $tiene_comentario_desc[0]->comentario, $row_comentarios_competencia);
            $row_comentarios_competencia = str_replace("{COMENTARIO_AE}", $tiene_comentario_ae[0]->comentario, $row_comentarios_competencia);
        }
    }
    $html = str_replace("{ROW_COMENTARIOS_POR_COMPETENCIA}", utf8_encode($row_comentarios_competencia), $html);
    $html = str_replace("{ROW_COMENTARIOS_POR_COMPETENCIA_AE}", utf8_encode($row_comentarios_competencia_ae), $html);
    //}else{
    //    $html = str_replace("{ROW_COMENTARIOS_POR_COMPETENCIA}","No se ingresaron comentarios",$html);
    //}
    $html = str_replace("{ARREGLO_DATOS_GRAFICO_COMPETENCIAS}", $arreglo_para_grafico_promedio_competencias, $html);
    $html = str_replace("{ETIQUETAS_GRAFICO_COMPETENCIAS}", $arreglo_para_grafico_promedio_competencias_texto, $html);
    return ($html);
}
function TransformarNotaRespuestaPuntaje($respuesta, $rut, $dimension, $tipo_calculo)
{
    //echo "$respuesta, $rut, $dimension id empres ";
    //echo $_SESSION["id_empresa"];
    //exit;
    $id_empresa    = $_SESSION["id_empresa"];
    $datos_usuario = UsuarioEnBasePersonas($rut);
    //echo $respuesta." ";
    if ($id_empresa == 434) {
        //$respuesta=(($respuesta*100)/5)*1.2;
        $respuesta = (($respuesta * 25) - 25) * 1.2;
        //echo $respuesta;
        //exit;
        $registros = DatosCriterio($datos_usuario[0]->id_empresa, $datos_usuario[0]->perfil_evaluacion, $dimension);
        foreach ($registros as $reg) {
            //if($respuesta>$reg->rangomenor and $respuesta<=$reg->rangomayor){
            if ($respuesta >= $reg->rangomenor and $respuesta < $reg->rangomayor) {
                $criterio      = $reg->criterio;
                $valor_mostrar = $reg->valor_mostrar;
                //if($reg->puntaje>=0){
                if (isset($reg->puntaje)) {
                    $puntaje = $reg->puntaje;
                } else {
                    $puntaje = $respuesta;
                    //echo $reg->puntaje;
                    //echo "$puntaje";
                }
                $etiqueta     = $reg->etiqueta;
                $icono_estado = $reg->icono_estado;
            }
        }
        $arreglo[0] = $criterio;
        $arreglo[1] = $puntaje;
        $arreglo[2] = $etiqueta;
        $arreglo[3] = $icono_estado;
        $arreglo[4] = $valor_mostrar;
        //print_r($arreglo);exit;
        return ($arreglo);
    } else {
        $registros = DatosCriterio($datos_usuario[0]->id_empresa, $datos_usuario[0]->perfil_evaluacion, $dimension);
        foreach ($registros as $reg) {
            //if($respuesta>$reg->rangomenor and $respuesta<=$reg->rangomayor){
            if ($respuesta >= $reg->rangomenor and $respuesta < $reg->rangomayor) {
                $criterio      = $reg->criterio;
                $valor_mostrar = $reg->valor_mostrar;
                //if($reg->puntaje>=0){
                if (isset($reg->puntaje)) {
                    $puntaje = $reg->puntaje;
                } else {
                    $puntaje = $respuesta;
                    echo $reg->puntaje;
                }
                $etiqueta     = $reg->etiqueta;
                $icono_estado = $reg->icono_estado;
            }
        }
        $arreglo[0] = $criterio;
        $arreglo[1] = $puntaje;
        $arreglo[2] = $etiqueta;
        $arreglo[3] = $icono_estado;
        $arreglo[4] = $valor_mostrar;
        return ($arreglo);
    }
}
function ObtenerCriterioPuntajeMatriz($respuesta, $rut, $dimension, $tipo_calculo)
{
    //echo "$respuesta, $rut, $dimension";exit;
    $id_empresa = $_SESSION["id_empre"];
    if ($id_empresa == 433) {
    } else {
        $datos_usuario = UsuarioEnBasePersonas($rut);
        $registros     = DatosCriterio($datos_usuario[0]->id_empresa, $datos_usuario[0]->perfil_evaluacion, $dimension);
        foreach ($registros as $reg) {
            //if($respuesta>$reg->rangomenor and $respuesta<=$reg->rangomayor){
            if ($respuesta >= $reg->rangomenor and $respuesta < $reg->rangomayor) {
                $criterio      = $reg->criterio;
                $valor_mostrar = $reg->valor_mostrar;
                //if($reg->puntaje>=0){
                if (isset($reg->puntaje)) {
                    $puntaje = $reg->puntaje;
                } else {
                    $puntaje = $respuesta;
                    echo $reg->puntaje;
                }
                $etiqueta     = $reg->etiqueta;
                $icono_estado = $reg->icono_estado;
            }
        }
        $arreglo[0] = $criterio;
        $arreglo[1] = $puntaje;
        $arreglo[2] = $etiqueta;
        $arreglo[3] = $icono_estado;
        $arreglo[4] = $valor_mostrar;
        return ($arreglo);
    }
}
function ObtenerCriterioPuntajeMatrizNotaFinal($respuesta, $rut, $dimension, $tipo_nota, $evaluador, $id_proceso)
{
    //echo "aca $respuesta, $rut, $dimension, $tipo_nota<br>";
    if ($_SESSION["id_empresa"] == 11) {
        $datos_usuario = UsuarioEnBasePersonas($rut);
    } else {
        if ($rut) {
            $datos_usuario = UsuarioEnBasePersonasConRelacionEvaluadoEvaluador($rut, $evaluador, $id_proceso);
        } else {
            $datos_usuario = UsuarioEnBasePersonasConRelacionEvaluadoEvaluadorSoloEvaluador($evaluador, $id_proceso);
        }
    }
    //$datos_usuario=UsuarioEnBasePersonas($rut);
    //$registros=DatosCriterio($datos_usuario[0]->id_empresa, $datos_usuario[0]->perfil_evaluacion, $dimension);
    $registros = DatosCriterioPorPerfil($datos_usuario[0]->id_empresa, $datos_usuario[0]->perfil_evaluacion, $tipo_nota, $dimension);
    if ($rut == "11492205") {
        //echo "<br><br>";
        //echo $respuesta;
    }
    if ($tipo_nota == "comp") {
        //echo "dimension ".$dimension." ".$rut. "  ".$respuesta." ->RES  ".$tipo_nota;echo "<br>";
        //print_r($registros);
        //echo "<br><br>";
    }
    foreach ($registros as $reg) {
        //if($respuesta>$reg->rangomenor and $respuesta<=$reg->rangomayor){
        if ($respuesta >= $reg->rangomenor and $respuesta < $reg->rangomayor) {
            //echo "<br>";echo $respuesta." ".$reg->rangomenor." ".$reg->rangomayor." <br>";exit;
            $criterio      = $reg->criterio;
            $valor_mostrar = $reg->valor_mostrar;
            //if($reg->puntaje>=0){
            if (isset($reg->puntaje)) {
                $puntaje = $reg->puntaje;
                //echo $reg->puntaje."<br>";
            } else {
                $puntaje = $respuesta;
                echo $reg->puntaje;
            }
            $etiqueta     = $reg->etiqueta;
            $icono_estado = $reg->icono_estado;
        }
    }
    $arreglo[0] = $criterio;
    $arreglo[1] = $puntaje;
    $arreglo[2] = $etiqueta;
    $arreglo[3] = $icono_estado;
    //$arreglo[4]=$valor_mostrar;
    $arreglo[4] = $respuesta;
    //print_r($arreglo);echo "<br><br>";exit;
    return ($arreglo);
}
function DevuelveDatosEval($evaluado, $evaluador, $id_pregunta)
{
    $datos_evaluado = UsuarioEnBasePersonas2($evaluado);
    //id perfil de evaluacion
    $arreglo[0]     = $datos_evaluado[0]->perfil_evaluacion;
    $datos_relacion = EvaluadosDadoEvaluadorEvaluado($evaluador, $evaluado);
    //subperfil
    $arreglo[1]     = $datos_relacion[0]->subperfil;
    //Id proceso
    $arreglo[2]     = $datos_relacion[0]->id_proceso;
    //id empresa
    $arreglo[3]     = $datos_evaluado[0]->id_empresa;
    $datos          = DatosDadoIDPregunta($id_pregunta);
    //id_dimension
    $arreglo[4]     = $datos[0]->id_dimension;
    //id componente
    $arreglo[5]     = $datos[0]->id_componente;
    return ($arreglo);
}
function DevuelveDatosEvalPorProceso($evaluado, $evaluador, $id_pregunta, $id_proceso)
{
    $datos_evaluado = UsuarioEnBasePersonas2PorProceso($evaluado, $id_proceso);
    //id perfil de evaluacion
    $arreglo[0]     = $datos_evaluado[0]->perfil_evaluacion;
    $datos_relacion = EvaluadosDadoEvaluadorEvaluado($evaluador, $evaluado);
    //subperfil
    $arreglo[1]     = $datos_relacion[0]->subperfil;
    //Id proceso
    $arreglo[2]     = $datos_relacion[0]->id_proceso;
    //id empresa
    $arreglo[3]     = $datos_evaluado[0]->id_empresa;
    $datos          = DatosDadoIDPregunta($id_pregunta);
    //id_dimension
    $arreglo[4]     = $datos[0]->id_dimension;
    //id componente
    $arreglo[5]     = $datos[0]->id_componente;
    return ($arreglo);
}
function PaginacionSGDSoloEvaluador($evaluador, $pagina)
{
    $perfiles_dado_evaluador = TotalPerfilesDadoEvaluador($evaluador);
    $total_paginas           = $perfiles_dado_evaluador[0]->cantidad_componentes + 1;
    $tiene_sesion            = SesionSGDSoloEvaluador($evaluador, 1);
    //total de paginas
    if ($tiene_sesion) {
        $pagina = $tiene_sesion[0]->pagina;
    } else {
        $pagina = 1;
    }
    $paginacion = '<div class="pagination_sgd"><ul>';
    for ($i = 1; $i <= $total_paginas; $i++) {
        if ($pagina == $i) {
            //$paginacion.="<span class='pagination_sgd_activo'>".$i."</span>";
            $paginacion .= '<li ><a class="pagination_sgd_activo">' . $i . '</a></li>';
        } else {
            //$paginacion.=$i;
            $paginacion .= '<li><a href="#">' . $i . '</a></li>';
        }
    }
    $paginacion .= '</ul></div>';
    return ($paginacion);
}
function PondObjetivos2($seleccionado)
{
    for ($i = 5; $i <= 90; $i++) {
        if ($seleccionado == "") {
            $options .= "<option value='" . $i . "'>" . $i . "%</option>";
        } else {
            if ($seleccionado == $i) {
                $options .= "<option value='" . $i . "' selected>" . $i . "%</option>";
            } else {
                $options .= "<option value='" . $i . "'>" . $i . "%</option>";
            }
        }
        $i = $i + 4;
    }
    return ($options);
}
function PondObjetivosa100($seleccionado)
{
    for ($i = 5; $i <= 100; $i++) {
        if ($seleccionado == "") {
            $options .= "<option value='" . $i . "'>" . $i . "%</option>";
        } else {
            if ($seleccionado == $i) {
                $options .= "<option value='" . $i . "' selected>" . $i . "%</option>";
            } else {
                $options .= "<option value='" . $i . "'>" . $i . "%</option>";
            }
        }
        $i = $i + 4;
    }
    return ($options);
}
function PondObjetivosa99($seleccionado)
{
    for ($i = 5; $i <= 99; $i++) {
        if ($seleccionado == "") {
            $options .= "<option value='" . $i . "'>" . $i . "%</option>";
        } else {
            if ($seleccionado == $i) {
                $options .= "<option value='" . $i . "' selected>" . $i . "%</option>";
            } else {
                $options .= "<option value='" . $i . "'>" . $i . "%</option>";
            }
        }
    }
    return ($options);
}
function PondObjetivos3($seleccionado)
{
    for ($i = 80; $i <= 120; $i++) {
        if ($seleccionado == "") {
            $options .= "<option value='" . $i . "'>" . $i . "%</option>";
        } else {
            if ($seleccionado == $i) {
                $options .= "<option value='" . $i . "' selected>" . $i . "%</option>";
            } else {
                $options .= "<option value='" . $i . "'>" . $i . "%</option>";
            }
        }
        $i = $i + 9;
    }
    return ($options);
}
function PondObjetivos($seleccionado)
{
    for ($i = 0; $i <= 125; $i++) {
        if ($seleccionado == "") {
            $options .= "<option value='" . $i . "'>" . $i . "%</option>";
        } else {
            if ($seleccionado == $i) {
                $options .= "<option value='" . $i . "' selected>" . $i . "%</option>";
            } else {
                $options .= "<option value='" . $i . "'>" . $i . "%</option>";
            }
        }
        $i = $i + 4;
    }
    return ($options);
}
function EntornoEvaluacionListado($html, $evaluador, $pagina, $id_proceso)
{
    //En esta funcion traigo a todos los evaliados de este evaluador
    $evaluados = EvaluadosDadoEvaluador($evaluador);
    if ($evaluados) {
        if ($pagina > 1) {
            $total_html = file_get_contents("views/sgd/evaluacion/entorno_equipo_evaluacion_competencia.html");
            //Se muestran las competencias para evaluar.
            $perfiles   = TotalPerfilesDadoEvaluador1($evaluador);
            //Aca tengo todos los perfiles, con esto, obtengo todas las competencias.
            for ($i = 0; $i < count($perfiles); $i++) {
                $sql .= " perfil_evaluacion='" . $perfiles[$i]->id_perfil_ev . "'";
                if ($perfiles[$i + 1]->id_perfil_ev)
                    $sql .= " or";
            }
            $componentes = TotalIdCompetencias($sql);
            if ($pagina > count($componentes) + 1) {
                InsertaEvaluadorFinalizado($evaluador, $id_proceso);
                //Aca ,por cada uno de los evaluados del evaluador, se inserta registro de finalizado evaluado evaluador
                foreach ($evaluados as $evaluad) {
                    InsertaEvaluadoEvaluadorFinalizado($evaluad->evaluado, $evaluador, $id_proceso);
                }
                echo "<script>
                            location.href='?sw=sgd2';
                    </script>";
                exit;
            }
            $total_html   = str_replace("{NOMBRE_COMPETENCIA}", utf8_encode($componentes[$pagina - 2]->nombre), $total_html);
            $total_html   = str_replace("{ID_ENCODEADO_COMPETENCIA}", $componentes[$pagina - 2]->id_componente, $total_html);
            $alternativas = AlternativasDadoIdGrupo($componentes[$pagina - 2]->id_alternativa);
            foreach ($alternativas as $alt) {
                $td .= file_get_contents("views/sgd/evaluacion/alternativa_encabezado.html");
                $td = str_replace("{DESCRIPCION_ALTERNATIVA}", $alt->alternativa, $td);
                //$td.='<td class="col-md-2 subtitulo_text_item_SGD borde_arribaabajoizquierdaderecha">'.$alt->alternativa.'</td>';
            }
            $total_html = str_replace("{NIVELES_TD}", utf8_encode($td), $total_html);
            foreach ($evaluados as $evaluado) {
                $row .= file_get_contents("views/sgd/evaluacion/row_colaboradores_evaluacion_comp.html");
                $row        = ColocaDatosUsuario($row, $evaluado->evaluado);
                $row        = str_replace("{NOMBRE_RADIO}", $evaluado->evaluado . "-" . $componentes[$pagina - 2]->id_componente, $row);
                $row        = str_replace("{NOMBRE_RADIO_SOLO_PREGUNTA}", $componentes[$pagina - 2]->id_componente, $row);
                $tiene_resp = TieneRespuestaCompetencia($evaluado->evaluado, $evaluador, $componentes[$pagina - 2]->id_componente);
                $row        = str_replace("{SELECT" . $tiene_resp[0]->respuesta . "}", "checked", $row);
            }
            $total_html = str_replace("{LISTADO_COLABORADORES}", ($row), $total_html);
        } else {
            //Se muestran los objetivos individuales.
            $total_html = file_get_contents("views/sgd/evaluacion/entorno_equipo_evaluacion.html");
            //Primero veo si es que hay registro en la tabla de sesion
            $row        = "";
            foreach ($evaluados as $evaluado) {
                $row .= file_get_contents("views/sgd/evaluacion/row_colaboradores_evaluacion.html");
                $row = ColocaDatosUsuario($row, $evaluado->evaluado);
                $row = str_replace("{LISTADO_OBJETIVOS_A_EVALUAR}", ListadoObjetivosEvaluacion($evaluado->evaluado, $evaluador), $row);
            }
            $total_html = str_replace("{LISTADO_COLABORADORES}", ($row), $total_html);
        }
        $html = str_replace("{PAGINACION_EVALUACION}", PaginacionSGDSoloEvaluador($evaluador, $pagina), $html);
    } else {
    }
    $html = str_replace("{ENTORNO_LISTADO_EVALUACION}", ($total_html), $html);
    return ($html);
}
function EntornoEvaluacion($html, $evaluado, $evaluador)
{
    //Objetivos Empresa
    $html = ColocaDatosUsuario($html, $evaluado);
    $html = MuestraObjetivos($html, $evaluado);
    $html = str_replace("{LISTADO_OBJETIVOS_INGRESADOS}", ListadoObjetivosIngresado($evaluado, $evaluador), $html);
    $html = str_replace("{SECCION_COMPETENCIAS}", MuestraListadoCompetencias($evaluado), $html);
    return ($html);
}
function ColocaDatosUsuario($html, $rut, $texto_mensaje, $rut_evaluador, $id_proceso, $pdf)
{
    if ($pdf == "pdf") {
        $html = str_replace("{SECCION_DATOS_USUARIO}", file_get_contents("views/sgd/datos_superior_usuario_pdf.html"), $html);
    } else {
        $html = str_replace("{SECCION_DATOS_USUARIO}", file_get_contents("views/sgd/datos_superior_usuario.html"), $html);
    }
    if ($rut_evaluador && $id_proceso) {
        $datos = DatosUsuarioConDatosEvaluadorPorProceso($rut, $rut_evaluador, $id_proceso);
        $html  = str_replace("{EVALUADOR}", utf8_encode($datos[0]->nombre_evaluador), $html);
    } else {
        $datos = DatosUsuarioLeftJefe($rut);
        if ($datos[0]->nombre_evaluador) {
            $html = str_replace("{EVALUADOR}", utf8_encode($datos[0]->nombre_evaluador), $html);
            $html = str_replace("{CARGO_EVALUADOR}", utf8_encode($datos[0]->cargo_evaluador), $html);
        } else {
            $html = str_replace("{EVALUADOR}", "Sin Evaluador", $html);
            $html = str_replace("{CARGO_EVALUADOR}", "Sin Evaluador", $html);
        }
    }
    //$html = str_replace("{SECCION_DATOS_USUARIO}",file_get_contents("views/sgd/datos_superior_usuario.html"),$html);
    if ($datos[0]->nombre_completo) {
        $html = str_replace("{NOMBRE_EVALUADO}", utf8_encode($datos[0]->nombre_completo), $html);
    } else if ($datos[0]->nombre && $datos[0]->apaterno && $datos[0]->amaterno) {
        $html = str_replace("{NOMBRE_EVALUADO}", utf8_encode($datos[0]->nombre) . " " . utf8_encode($datos[0]->apaterno) . " " . utf8_encode($datos[0]->amaterno), $html);
    } else if ($datos[0]->nombre) {
        $html = str_replace("{NOMBRE_EVALUADO}", utf8_encode($datos[0]->nombre), $html);
    }
    $html = str_replace("{NOMBRE}", utf8_encode($datos[0]->nombre_completo), $html);
    $html = str_replace("{CARGO_EVALUADO}", utf8_encode($datos[0]->cargo), $html);
    $html = str_replace("{CARGO}", utf8_encode($datos[0]->cargo), $html);
    $html = str_replace("{PERFIL_EVALUACION}", utf8_encode($datos[0]->nombre_perfil), $html);
    $html = str_replace("{IMAGEN_EVALUADO}", VerificaFotoPersonal($datos[0]->rut), $html);
    $html = str_replace("{IMG_FOTO}", VerificaFotoPersonal($datos[0]->rut), $html);
    if ($texto_mensaje == 1) {
        $html = str_replace("{MENSAJE}", file_get_contents("views/sgd/validacion/texto_no_validacion.html"), $html);
    } elseif ($texto_mensaje == 2) {
        $html = str_replace("{MENSAJE}", file_get_contents("views/sgd/texto_no_objetivos_jefe.html"), $html);
    } elseif ($texto_mensaje == "bitacora") {
        $html = str_replace("{MENSAJE}", file_get_contents("views/sgd/bitacora/boton_ingreso_formulario.html"), $html);
    } elseif ($texto_mensaje == "planes") {
        $html = str_replace("{MENSAJE}", file_get_contents("views/sgd/planes/boton_ingreso_formulario.html"), $html);
    } elseif ($texto_mensaje == "graficoFrecuenciaCompetencia ") {
        $html = str_replace("{MENSAJE}", "", $html);
    } elseif ($texto_mensaje == "sinmensaje") {
        $html = str_replace("{MENSAJE}", "", $html);
    } else {
        $html = str_replace("{MENSAJE}", "", $html);
    }
    //Verifico si el usuario es JEfe, si es asi, coloca boton Mi Equipo
    $es_evaluador = VerSiEsEvaluador($rut);
    if ($es_evaluador) {
        $html = str_replace("{EQUIPO}", '
                                            <a href="?sw=sgd2_e&er=' . Encodear3($rut) . '"><button class="btnver btn-gray btn-sm"><i class="fa fa-users pad_r"></i>Ver Equipo</button></a>', $html);
    } else {
        $html = str_replace("{EQUIPO}", "", $html);
    }
    if (file_exists("docs/dc/" . $rut . ".pdf")) {
        $html = str_replace("{DESCRIPCIONCARGO}", file_get_contents("views/sgd/boton_descripcion_cargo.html"), $html);
        $html = str_replace("{RUT}", $rut, $html);
    } else {
        $html = str_replace("{DESCRIPCIONCARGO}", "", $html);
    }
    return ($html);
}
function MuestraBotonCompetencias($html, $rut)
{
    $conocimiento_competencias = TomoConocimientoEvaluadoCompetencias($rut);
    if ($conocimiento_competencias) {
        $html = str_replace("{BOTON_COMPETENCIAS}", "", $html);
    } else {
        $aceptacion_objetivos = TomoConocimientoEvaluado($rut);
        if ($aceptacion_objetivos) {
            $html = str_replace("{BOTON_COMPETENCIAS}", file_get_contents("views/sgd/boton_conocimiento_comp.html"), $html);
        } else {
            $html = str_replace("{BOTON_COMPETENCIAS}", "", $html);
        }
    }
    return ($html);
}
function DevuelvePonderacionesPorEvaluado($rut, $id_proceso)
{
    //$datos_colaborador=UsuarioEnBasePersonas($rut);
    //$datos_colaborador=UsuarioEnBasePersonas($rut);
    $datos_colaborador = UsuarioEnBasePersonasConRelacionEvaluadoEvaluadorDadoEvaluado($rut, $id_proceso);
    $ponderaciones     = TraePonderacionesPorPerfil($datos_colaborador[0]->perfil_evaluacion);
    //Ponderacion Empresa
    $arreglo[0]        = $ponderaciones[0]->objetivos_empresa;
    //Ponderacion Area
    $arreglo[1]        = $ponderaciones[0]->objetivos_area;
    //Objetivos Individuales
    $arreglo[2]        = $ponderaciones[0]->objetivos_individuales;
    //Ponderacion Competencias
    $arreglo[3]        = $ponderaciones[0]->competencias;
    return ($arreglo);
}
function ColocaPonderaciones($html, $rut, $id_proceso)
{
    //$datos_colaborador=UsuarioEnBasePersonas($rut);
    $datos_colaborador = UsuarioEnBasePersonasConRelacionEvaluadoEvaluadorDadoEvaluado($rut, $id_proceso);
    $ponderaciones     = TraePonderacionesPorPerfil($datos_colaborador[0]->perfil_evaluacion);
    $html              = str_replace("{PONDERACION_OBJETIVOS_EMPRESA}", $ponderaciones[0]->objetivos_empresa . "%", $html);
    $html              = str_replace("{PONDERACION_OBJETIVOS_AREA}", $ponderaciones[0]->objetivos_area . "%", $html);
    $html              = str_replace("{PONDERACION_OBJETIVOS_INDIVIDUALES}", $ponderaciones[0]->objetivos_individuales . "%", $html);
    $html              = str_replace("{PONDERACION_COMPETENCIAS}", $ponderaciones[0]->competencias . "%", $html);
    return ($html);
}
function MuestraListadoCompetencias($rut, $id_proceso)
{
    $id_empresa        = $_SESSION["id_empresa"];
    $html              = file_get_contents("views/sgd/competencias/sgd3_entorno_componentes.html");
    //$datos_colaborador=UsuarioEnBasePersonas($rut);
    $datos_colaborador = UsuarioEnBasePersonasConRelacionEvaluadoEvaluadorDadoEvaluado($rut, $id_proceso);
    //Dado el perfil, traigo las competencias, prefuntas y alternativas
    //$matriz=TraeMatrizCompPregAlter($datos_colaborador[0]->perfil_evaluacion);
    //Dado el perfil, traigo las competencias
    $row               = "";
    $competencias      = CompetenciasDadoPerfil2($datos_colaborador[0]->perfil_evaluacion);
    foreach ($competencias as $comp_unica) {
        //Por cada competencia, coloco el encabezado, y traigo las preguntas de cada competencias
        $row .= file_get_contents("views/sgd/competencias/" . $id_empresa . "_row_vista_componentes.html");
        //$row = str_replace("{NOMBRE_COMPETENCIA}",$unico->nombre_componente,$row);
        $row                       = str_replace("{NOMBRE_COMPETENCIA}", $comp_unica->nombre_componente, $row);
        //Por cada competencia, traigo las preguntas
        $preguntas_por_competencia = PreguntasDadaCompetencia($comp_unica->id_componente);
        foreach ($preguntas_por_competencia as $preg) {
            $row .= file_get_contents("views/sgd/competencias/" . $id_empresa . "_row_vista_preguntas.html");
            if ($preg->descripcion) {
                $row = str_replace("{NOMBRE_PREGUNTA}", $preg->descripcion, $row);
            } else {
                $row = str_replace("{NOMBRE_PREGUNTA}", $preg->pregunta, $row);
            }
            //Por cada pregunta traigo las alternativas
            $alternativas = AlternativasDadoIdGrupo($preg->id_alternativa);
            $j            = 0;
            for ($i = 1; $i <= count($alternativas); $i++) {
                $row = str_replace("{ALT" . $i . "}", $alternativas[$i - 1]->alternativa, $row);
                $row = str_replace("{DESCRIPCION_ALT" . $i . "}", $alternativas[$i - 1]->descripcion, $row);
                $j++;
            }
        }
    }
    $html = str_replace("{LISTADO_COMPETENCIAS}", utf8_encode($row), $html);
    return ($html);
}
function ListadoTotalColaboradores($html, $rut, $proceso_anual, $id_empresa, $id_proceso, $tipo_sgd)
{
    //echo "$rut, $proceso_anual, $id_empresa, $id_proceso, $tipo_sgd";
    $datos_proceso_evaluacion = TraeProcesosDeEvaluacionDadoId($id_proceso);
    $id_proceso_anual         = $datos_proceso_evaluacion[0]->id_proceso_anual;
    $datos_proceso_anual      = DatosProcesoAnualPorId($id_proceso_anual);
    $html                     = str_replace("{ROW_PRIMER_JEFE}", file_get_contents("views/sgd/row_colaboradores.html"), $html);
    $html                     = ColocaDatosUsuario($html, $rut);
    //COMENTADO PARA OPTIMIZAR 22-11-2015
    //$html = str_replace("{TABLA_RESUMEN1}",file_get_contents("views/sgd/informe/tabla_resumen1.html"),$html);
    //COMENTADO PARA OPTIMIZAR 22-11-2015
    //$html = ColocaPonderaciones($html, $rut);
    $html                     = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($rut), $html);
    $datos_evaluado_jefe      = UsuarioEnBasePersonas($rut);
    //$html=ColocaResultadosTablaReumen($html, $rut, $datos_evaluado_jefe[0]->evaluador);
    //COMENTADO PARA OPTIMIZAR 22-11-2015
    //$total_evaluados=SemaforosEstadosObjetivos($total_evaluados, $ev->rut);
    $total_evaluados          = str_replace("{PARAMETROS_EVAL}", Encodear3($ev->rut . ";" . $rut), $total_evaluados);
    $datos_usuario            = UsuarioEnBasePersonas($rut);
    $html                     = str_replace("{NOMBRE_DEPENDIENTE}", utf8_encode($datos_usuario[0]->nombre), $html);
    $html                     = str_replace("{PARAMETROS_EVAL}", Encodear3($ev->rut . ";" . $rut), $html);
    if ($tipo_sgd == 2) {
        //$entorno=file_get_contents("views/sgd/sgd2_entorno_equipo_chilquinta.html");
        $entorno         = file_get_contents("views/sgd/" . $id_empresa . "_sgd2_entorno_equipo.html");
        $tiene_evaluados = TraeRelacionesSinAe($rut, $id_proceso);
        if ($tiene_evaluados) {
            /*if($id_empresa==43){
            $entorno = str_replace("{SECCION_EQUIPO_CONSOLIDADO}",file_get_contents("views/sgd/".$id_empresa."_vista_consolidada_equipo.html"),$entorno);
            }else{
            $entorno = str_replace("{SECCION_EQUIPO_CONSOLIDADO}",file_get_contents("views/sgd/vista_consolidada_equipo.html"),$entorno);
            }*/
            $entorno                            = str_replace("{SECCION_EQUIPO_CONSOLIDADO}", file_get_contents("views/sgd/" . $id_empresa . "_vista_consolidada_equipo.html"), $entorno);
            //aca debo validar si el evaluador tiene o no evaliuados finalizados, si es asi, muestra los graficos, si no, no.
            $evaluados_descendentes_finalizados = FinalizadoEvaluadorPorProcesoSinAe($rut, $id_proceso);
            if ($evaluados_descendentes_finalizados) {
                $entorno = str_replace("{SECCION_GRAFICOS_CONSOLIDADOS}", file_get_contents("views/sgd/" . $id_empresa . "_vista_consolidada_graficos.html"), $entorno);
                $entorno = str_replace("{GRAFICOROLES}", file_get_contents("views/sgd/graficos/" . $id_empresa . "_graficoRoles.html"), $entorno);
                $entorno = str_replace("{GRAFICODETERMINANTES}", file_get_contents("views/sgd/graficos/" . $id_empresa . "_graficoDeterminantes.html"), $entorno);
            } else {
                $entorno = str_replace("{SECCION_GRAFICOS_CONSOLIDADOS}", "", $entorno);
            }
            $entorno = str_replace("{GRAFICO1.1}", ConsolidadoLineal($rut, "", $id_proceso, $id_empresa), $entorno);
            $entorno = str_replace("{GRAFICO1.2}", GraficoPorCompetenciasPorEvaluadorCalibrador($rut, $id_proceso, ""), $entorno);
        } else {
            if ($id_empresa == 28) {
                $entorno = str_replace("{SECCION_EQUIPO_CONSOLIDADO}", file_get_contents("views/sgd/vista_consolidada_equipo.html"), $entorno);
                $entorno = str_replace("{SECCION_GRAFICOS_CONSOLIDADOS}", "", $entorno);
                $entorno = str_replace("{GRAFICO1.1}", "", $entorno);
                $entorno = str_replace("{GRAFICO1.2}", "", $entorno);
            } else {
                $entorno = str_replace("{SECCION_EQUIPO_CONSOLIDADO}", "", $entorno);
                $entorno = str_replace("{SECCION_GRAFICOS_CONSOLIDADOS}", "", $entorno);
            }
        }
    } else {
        $entorno = file_get_contents("views/sgd/sgd2_entorno_equipo.html");
    }
    //print_r($datos_proceso_anual);
    //valido, si es que este evaluador esta liberado para este proceso.
    //Si es asi, no muestro el boton Evaluar Equipo.
    $evaluador_liberado = TraeCantidadLiberadosPorEvaluador($rut, $id_proceso);
    if ($evaluador_liberado) {
        $entorno = str_replace("{BOTON_EVALUAR_EQUIPO}", "11", $entorno);
    } else {
        if ($datos_proceso_anual[0]->activo == 1) {
            $entorno = str_replace("{BOTON_EVALUAR_EQUIPO}", file_get_contents("views/sgd/" . $id_empresa . "_boton_evaluar_equipo.html"), $entorno);
        } else {
            $entorno = str_replace("{BOTON_EVALUAR_EQUIPO}", "222", $entorno);
        }
    }
    $entorno              = str_replace("{TABLA_DATOS_USUARIO_SUPERIOR}", file_get_contents("views/sgd/tabla_datos_superior_usuario.html"), $entorno);
    $entorno              = ColocaDatosUsuario($entorno, $rut, "graficoFrecuenciaCompetencia");
    //Aca valido si el evaluador termino sus evaluaciones, en tabla tbl_sgd_finalizados_evaluador.
    //$finalizado_evaluador=FinalizadoEvaluador($rut);
    $finalizado_evaluador = FinalizadoEvaluador($rut);
    if ($finalizado_evaluador) {
        $entorno = str_replace("{LINK_EVALUACION_EQUIPO}", "sgd2", $entorno);
    } else {
        $entorno = str_replace("{LINK_EVALUACION_EQUIPO}", "ev#pag", $entorno);
    }
    //Aca traigo ellistado total de los colaboradores
    //$evaluados=TraeEvaluadosDadoEvaluador($rut);
    //$evaluados=TraeEvaluadosDadoEvaluadorSinMiPerfil($rut);
    //$evaluados=TraeEvaluadosDadoEvaluadorPorProceso($rut);
    if ($id_empresa == 30 or $id_empresa == 11) {
        //$evaluados=TraeEvaluadosDadoEvaluadorPorProceso2($rut, 39);
        $evaluados = TraeEvaluadosDadoEvaluador($rut);
    } else {
        $evaluados = TraeEvaluadosDadoEvaluadorPorProceso2($rut, $id_proceso);
    }
    if (!$evaluados) {
        $html = str_replace("{ENTORNO_LISTADO_COLABORADORES}", "
            <div class='row'>
</div>
            ", $html);
    } else {
        $total_evaluados = "";
        $obj_fin         = 0;
        foreach ($evaluados as $ev) {
            if ($ev->rut == $ev->evaluador)
                continue;
            //COMENTADO PARA OPTIMIZAR 22-11-2015
            /*
            if($_SESSION["id_empresa"]==111){
            $row=file_get_contents("views/sgd/row_colaboradores.html");
            }else{
            $row=file_get_contents("views/sgd/listado_colaboradores/row_colaboradores_sin_evaluador.html");
            }*/
            if ($tipo_sgd == 2) {
                $row = file_get_contents("views/sgd/listado_colaboradores/" . $id_empresa . "_row_colaboradores_sin_evaluador.html");
            } else {
                $row = file_get_contents("views/sgd/listado_colaboradores/row_colaboradores_sin_evaluador.html");
            }
            //$total_evaluados.=ColocaDatosUsuario($row, $ev->rut);
            $total_evaluados .= ColocaDatosUsuarioSGD($row, $ev->rut, "", $rut, $id_proceso);
            //COMENTADO PARA OPTIMIZAR 22-11-2015
            /*
            if($_SESSION["id_empresa"]==111){
            $total_evaluados = str_replace("{TABLA_RESUMEN1}",file_get_contents("views/sgd/informe/tabla_resumen1.html"),$total_evaluados);
            }else
            {
            $total_evaluados = str_replace("{TABLA_RESUMEN1}",file_get_contents("views/sgd/informe/tabla_superior_resumen/tabla_resumen1_sinareacorp_dinamico.html"),$total_evaluados);
            $total_evaluados=ArmaTemplareDeTablaResumen($total_evaluados, $proceso_anual, $id_empresa, $ev->perfil_evaluacion, $ev->rut, $rut);
            }
            */
            //Veo si esta finalizada la Autoevaluacion, si es asi, muestro boton Ver Autoevaluacion
            $verifica_informe_ae = FinalizadoEvaluadoEvaluadorProProceso($ev->rut, $ev->rut, $ev->id_proceso);
            if ($verifica_informe_ae) {
                $total_evaluados = str_replace("{BOTON_VE_AE_}", file_get_contents("views/sgd/informe/tabla_superior_resumen/boton_ver_autoeval.html"), $total_evaluados);
            } else {
                $total_evaluados = str_replace("{BOTON_VE_AE_}", "adasd", $total_evaluados);
            }
            if ($tipo_sgd == 2) {
                $total_evaluados          = str_replace("{TABLA_RESUMEN1}", file_get_contents("views/sgd/informe/tabla_superior_resumen/tabla_resumen1_sinareacorp_dinamico_chilquinta.html"), $total_evaluados);
                $estado_liberado_feedback = LiberadoFeedbackLiberado($ev->rut, $ev->evaluador, $ev->calibrador, $ev->id_proceso, $id_empresa);
                $total_evaluados          = str_replace("{ETIQUETA_ESTADO}", $estado_liberado_feedback[0], $total_evaluados);
                //aca verifico de manera individual si es que fue liberado o no este evaluado
                if ($ev->rut == $ev->evaluador) {
                    $datos_relacion_jefatura = ObtenerJefeRelPorProceso($ev->rut, $id_proceso);
                    $evaluado_liberado       = TraeLiberadoEvaluadoEvaluadorCalibrador($ev->rut, $datos_relacion_jefatura[0]->evaluador, $datos_relacion_jefatura[0]->calibrador, $datos_relacion_jefatura[0]->id_proceso);
                } else {
                    $evaluado_liberado = TraeLiberadoEvaluadoEvaluadorCalibrador($ev->rut, $rut, $ev->calibrador, $ev->id_proceso);
                }
                $verifica_eval_finalizada = FinalizadoEvaluadoEvaluador($ev->rut, $rut, $ev->id_proceso);
                if ($evaluado_liberado) {
                    //$total_evaluados = str_replace("{BOTON_EVALUACION_INDIVIDUAL}","",$total_evaluados);
                    if ($verifica_eval_finalizada) {
                        $total_evaluados = str_replace("{BOTON_EVALUACION_INDIVIDUAL}", "", $total_evaluados);
                    } else {
                        if ($ev->rut == $ev->evaluador) {
                            $total_evaluados = str_replace("{BOTON_EVALUACION_INDIVIDUAL}", file_get_contents("views/sgd/informe/tabla_superior_resumen/boton_autoeval_individual.html"), $total_evaluados);
                        } else {
                            if ($id_empresa == 66) {
                                $total_evaluados = str_replace("{BOTON_EVALUACION_INDIVIDUAL}", "", $total_evaluados);
                            } else {
                                $total_evaluados = str_replace("{BOTON_EVALUACION_INDIVIDUAL}", file_get_contents("views/sgd/informe/tabla_superior_resumen/boton_eval_individual.html"), $total_evaluados);
                            }
                        }
                    }
                } else {
                    if ($datos_proceso_anual[0]->activo == 1) {
                        if ($ev->rut == $ev->evaluador) {
                            $total_evaluados = str_replace("{BOTON_EVALUACION_INDIVIDUAL}", file_get_contents("views/sgd/informe/tabla_superior_resumen/boton_autoeval_individual.html"), $total_evaluados);
                        } else {
                            if ($id_empresa == 66) {
                                $total_evaluados = str_replace("{BOTON_EVALUACION_INDIVIDUAL}", "", $total_evaluados);
                            } else {
                                $total_evaluados = str_replace("{BOTON_EVALUACION_INDIVIDUAL}", file_get_contents("views/sgd/informe/tabla_superior_resumen/boton_eval_individual.html"), $total_evaluados);
                            }
                        }
                    } else {
                        $total_evaluados = str_replace("{BOTON_EVALUACION_INDIVIDUAL}", "", $total_evaluados);
                    }
                }
                if ($ev->rut == $ev->evaluador) {
                    if ($evaluado_liberado) {
                        $total_evaluados = str_replace("{BOTON_FEEDBACK}", file_get_contents("views/sgd/boton_evalua_feedback.html"), $total_evaluados);
                    } else {
                        $total_evaluados = str_replace("{BOTON_FEEDBACK}", "", $total_evaluados);
                    }
                } else {
                    $total_evaluados = str_replace("{BOTON_FEEDBACK}", "", $total_evaluados);
                }
                //Verifico si est? finalizada la evaluacion de este proceso
                if ($verifica_eval_finalizada) {
                    if ($evaluado_liberado) {
                        if ($ev->rut == $ev->evaluador) {
                            $total_evaluados = str_replace("{BOTON_VE_INFORME_POR_PROCESO}", "", $total_evaluados);
                        } else {
                            $total_evaluados = str_replace("{BOTON_VE_INFORME_POR_PROCESO}", file_get_contents("views/sgd/informe/tabla_superior_resumen/boton_ve_informe.html"), $total_evaluados);
                        }
                    } else {
                        $total_evaluados = str_replace("{BOTON_VE_INFORME_POR_PROCESO}", file_get_contents("views/sgd/informe/tabla_superior_resumen/boton_ve_informe.html"), $total_evaluados);
                    }
                } else {
                    $total_evaluados = str_replace("{BOTON_VE_INFORME_POR_PROCESO}", "", $total_evaluados);
                }
                $total_evaluados = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($ev->rut), $total_evaluados);
                $total_evaluados = str_replace("{ID_PROCESO_ENCODEADO}", Encodear3($id_proceso), $total_evaluados);
                //Aca traigo la nota final de cadaevaluadopara acumular y mostrar en el resumen superior
                //$datos_resumen=ResultadosFinales($ev->rut, $rut, $id_proceso, "");
                //if($datos_resumen[27]>0){
                //    $acummulador_notas=$acummulador_notas+$datos_resumen[27];
                //    $contador++;
                //}
            } else {
                $total_evaluados = str_replace("{TABLA_RESUMEN1}", file_get_contents("views/sgd/informe/tabla_superior_resumen/tabla_resumen1_sinareacorp_dinamico.html"), $total_evaluados);
            }
            $total_evaluados    = ArmaTemplareDeTablaResumen($total_evaluados, $proceso_anual, $id_empresa, $ev->perfil_evaluacion, $ev->rut, $rut, "no");
            //Verifico si est? finalizado este evaluado en el proceso de objetivos
            $feedback_objetivos = TomoConocimientoEvaluado($ev->rut);
            if ($feedback_objetivos) {
                $obj_fin++;
            }
            //$total_evaluados = ColocaPonderaciones($total_evaluados, $ev->rut);
            $total_evaluados = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($ev->rut), $total_evaluados);
            //$total_evaluados=ColocaResultadosTablaReumen($total_evaluados, $ev->rut, $rut);
            $total_evaluados = SemaforosEstadosObjetivos($total_evaluados, $ev->rut, $_SESSION["ano_proceso_anual"]);
            //COMENTADO PARA OPTIMIZAR 22-11-2015
            //$total_evaluados = str_replace("{PARAMETROS_EVAL}",Encodear3($ev->rut.";".$rut),$total_evaluados);
        }
        $nota_final_evaluados = $acummulador_notas / $contador;
        /*
        if($nota_final_evaluados){
        $datos_nota_final_evaluados=ObtenerCriterioPuntajeMatrizNotaFinal($nota_final_evaluados, $rut, 0, "nota_final");
        $entorno = str_replace("{NOTA_FINAL}",ColocaDecimalesNotasFinales(2, $nota_final_evaluados),$entorno);
        $entorno = str_replace("{ESTILO_NOTA_FINAL}",$datos_nota_final_evaluados[2],$entorno);
        $entorno = str_replace("{ICONO_NOTA_FINAL}",$datos_nota_final_evaluados[3],$entorno);
        $entorno = str_replace("{CRITERIO_NOTA_FINAL}",$datos_nota_final_evaluados[0],$entorno);
        }else{
        $entorno = str_replace("{NOTA_FINAL}","",$entorno);
        $entorno = str_replace("{ESTILO_NOTA_FINAL}","etiquetaPrograma-pendiente",$entorno);
        $entorno = str_replace("{ICONO_NOTA_FINAL}","circle-icon-sgd-3",$entorno);
        $entorno = str_replace("{CRITERIO_NOTA_FINAL}","Pendiente",$entorno);
        }*/
        $entorno              = ObtieneResumenesNotasFinalesPorEvaluador($entorno, $rut, $id_proceso);
        //aca calculo el porcentaje de avance de objetivos de todos los colaboradores.
        $entorno              = str_replace("{POR_AVANCE_OBJ}", ($obj_fin * 100) / count($evaluados), $entorno);
        $entorno              = str_replace("{POR_AVANCE_EV_EQUIPO}", 0, $entorno);
        $entorno              = str_replace("{LISTADO_COLABORADORES}", ($total_evaluados), $entorno);
        $html                 = str_replace("{ENTORNO_LISTADO_COLABORADORES}", ($entorno), $html);
    }
    return ($html);
}
function SemaforosEstadosObjetivos($html, $rut, $proceso_anual)
{
    $id_empresa = $_SESSION["id_empresa"];
    if ($id_empresa == 28) {
        $tipo_semaforos = "";
    } else {
        $tipo_semaforos = "evaluacion";
    }
    $total_estados     = 7;
    $estado_finalizado = 0;
    $estados           = TraeDatosParaSemaforo($rut);
    $datos_evaluacion  = ObtenerJefeRel($rut);
    $semaforo_etapa_1  = 0;
    if ($proceso_anual) {
        //datosPRocesoAnual
        $datos_proceso_anual = DatosProcesoAnual($proceso_anual, $id_empresa);
        $procesos            = ProcesosEvalPorProcesoAnualParaTabla($datos_proceso_anual[0]->id, $tipo_semaforos);
        foreach ($procesos as $proc) {
            $template_etapas .= file_get_contents("views/sgd/listado_colaboradores/pasos/titulo.html");
            $etapas_por_proceso = EtapasPorProceso($proc->id_proceso);
            $template_etapas    = str_replace("{TITULO}", $proc->descripcion_proceso, $template_etapas);
            $template_etapas    = str_replace("{DESCRIPCION}", $proc->descripcion, $template_etapas);
            $template_etapas    = str_replace("{ETIQUETA_SEMAFORO}", $proc->etiqueta_semaforo, $template_etapas);
            foreach ($etapas_por_proceso as $eta) {
                $template_etapas .= file_get_contents("views/sgd/listado_colaboradores/pasos/etapa.html");
                $template_etapas = str_replace("{NOMBRE}", $eta->etapa, $template_etapas);
                $template_etapas = str_replace("{ETIQUETA_SEMAFORO}", $eta->etiqueta_semaforo, $template_etapas);
                $template_etapas = str_replace("{ID_ETAPA}", $eta->id, $template_etapas);
            }
            $template_etapas .= '<tr><td colspan="2" class="height12px"></td></tr>';
        }
        $html = str_replace("{PASOS}", utf8_encode($template_etapas), $html);
    } else {
        if ($estados[0]->dato_empresa_finalizado && $estados[0]->dato_area_finalizado) {
            $html = str_replace("{SEMAFORO1}", "fa fa-check text-iconos", $html);
            $estado_finalizado++;
            $semaforo_etapa_1++;
        } else {
            $html = str_replace("{SEMAFORO1}", "fa fa-circle-thin text-iconos", $html);
        }
        if ($estados[0]->dato_individual_finalizado) {
            $html = str_replace("{SEMAFORO2}", "fa fa-check text-iconos", $html);
            $estado_finalizado++;
            $semaforo_etapa_1++;
        } else {
            $html = str_replace("{SEMAFORO2}", "fa fa-circle-thin text-iconos", $html);
        }
        if ($estados[0]->dato_ajuste_jefatura) {
            $html = str_replace("{SEMAFORO3}", "fa fa-check text-iconos", $html);
            $estado_finalizado++;
            $semaforo_etapa_1++;
        } else {
            $html = str_replace("{SEMAFORO3}", "fa fa-circle-thin text-iconos", $html);
        }
        if ($estados[0]->dato_aceptacion_usuario) {
            $html = str_replace("{SEMAFORO5}", "fa fa-check text-iconos", $html);
            $html = str_replace("{SEMAFORO4}", "fa fa-check text-iconos", $html);
            $estado_finalizado++;
            $estado_finalizado++;
            $semaforo_etapa_1++;
            $semaforo_etapa_1++;
        } else {
            $html = str_replace("{SEMAFORO5}", "fa fa-circle-thin text-iconos", $html);
            $html = str_replace("{SEMAFORO4}", "fa fa-circle-thin text-iconos", $html);
        }
        if ($estados[0]->dato_aceptacion_competencias) {
            $html = str_replace("{SEMAFORO6}", "fa fa-check text-iconos", $html);
            $estado_finalizado++;
        } else {
            $html = str_replace("{SEMAFORO6}", "fa fa-circle-thin text-iconos", $html);
        }
    }
    if ($estados[0]->dato_ev_intermedia) {
        $html = str_replace("{SEMAFORO7}", "fa fa-check text-iconos", $html);
        $estado_finalizado++;
    } else {
        $html = str_replace("{SEMAFORO7}", "fa fa-circle-thin text-iconos", $html);
    }
    if ($estados[0]->dato_validacion_validador) {
        $html = str_replace("{SEMAFORO8}", "fa fa-check text-iconos", $html);
        $estado_finalizado++;
        $semaforo_etapa_1++;
    } else {
        $html = str_replace("{SEMAFORO8}", "fa fa-circle-thin text-iconos", $html);
    }
    $html = str_replace("{POR_AVANCE_OBJ}", number_format(($estado_finalizado * 100) / $total_estados, 0), $html);
    if ($semaforo_etapa_1 == 6) {
        $html = str_replace("{SEMAFOROETAPA1}", "circle-icon-sgd-rowcol etiquetaRowPrograma-terminado", $html);
    } else if ($semaforo_etapa_1 == 0) {
        $html = str_replace("{SEMAFOROETAPA1}", "circle-icon-sgd-rowcol etiquetaRowPrograma-pendiente", $html);
    } else {
        $html = str_replace("{SEMAFOROETAPA1}", "circle-icon-sgd-rowcol etiquetaRowPrograma-proceso", $html);
    }
    $html      = str_replace("{SEMAFOROETAPA2}", "circle-icon-sgd-rowcol etiquetaRowPrograma-pendiente", $html);
    $html      = str_replace("{SEMAFOROETAPA3}", "circle-icon-sgd-rowcol etiquetaRowPrograma-pendiente", $html);
    $por_mi_ev = PorcentajeEvaluacion($rut, $datos_evaluacion[0]->evaluador);
    $html      = str_replace("{POR_AVANCE_MI_EV}", $por_mi_ev, $html);
    return ($html);
}
function OptionsGenericoNombreDadoValores($tabla, $seleccionado, $campo_mostrar, $campo_valor, $order)
{
    $valores = ValorSelectDinaico2($tabla, $campo_mostrar, $campo_valor, $order);
    foreach ($valores as $val) {
        if ($val->id == $seleccionado) {
            $opciones .= "<option selected value='" . $val->id . "'>" . $val->nombre . "</option>";
        } else {
            $opciones .= "<option value='" . $val->id . "'>" . $val->nombre . "</option>";
        }
    }
    return (utf8_encode($opciones));
}
function OptionsGenericoNombreDadoValoresPorEmpresa($tabla, $seleccionado, $campo_mostrar, $campo_valor, $order, $id_empresa)
{
    if ($id_empresa) {
        $valores = ValorSelectDinaico2PorEmpresa($tabla, $campo_mostrar, $campo_valor, $order, $id_empresa);
    } else {
        $valores = ValorSelectDinaico2($tabla, $campo_mostrar, $campo_valor, $order);
    }
    foreach ($valores as $val) {
        if ($val->id == $seleccionado) {
            $opciones .= "<option selected value='" . $val->id . "'>" . $val->nombre . "</option>";
        } else {
            $opciones .= "<option value='" . $val->id . "'>" . $val->nombre . "</option>";
        }
    }
    return (utf8_encode($opciones));
}
function OptionsGenericoNombrePorEmpresa($tabla, $seleccionado, $id_empresa)
{
    $valores = ValorSelectDinaicoPorEmpresa($tabla, $id_empresa);
    foreach ($valores as $val) {
        if ($val->id == $seleccionado) {
            $opciones .= "<option selected value='" . $val->id . "'>" . $val->nombre . "</option>";
        } else {
            $opciones .= "<option value='" . $val->id . "'>" . $val->nombre . "</option>";
        }
    }
    return (utf8_encode($opciones));
}
function OptionsGenericoNombre($tabla, $seleccionado)
{
    $valores = ValorSelectDinaico($tabla);
    foreach ($valores as $val) {
        if ($val->id == $seleccionado) {
            $opciones .= "<option selected value='" . $val->id . "'>" . $val->nombre . "</option>";
        } else {
            $opciones .= "<option value='" . $val->id . "'>" . $val->nombre . "</option>";
        }
    }
    return (utf8_encode($opciones));
}
function OptionsGenerico($campo, $tabla, $seleccionado)
{
    $valores = SelectDistValor($campo, $tabla);
    foreach ($valores as $val) {
        if ($val->dato == $seleccionado) {
            $opciones .= "<option selected value='" . $val->dato . "'>" . $val->dato . "</option>";
        } else {
            $opciones .= "<option value='" . $val->dato . "'>" . $val->dato . "</option>";
        }
    }
    return (utf8_encode($opciones));
}
function OptionsProgramaPorEmpresa($seleccionado, $id_empresa)
{
    $valores = RelMallaProgramaPorEmpresa($id_empresa);
    foreach ($valores as $valor) {
        if ($valor->id_programa == $seleccionado) {
            $opciones .= "<option selected value='" . $valor->id_programa . "'>" . $valor->nombre_programa . "</option>";
        } else {
            $opciones .= "<option value='" . $valor->id_programa . "'>" . $valor->nombre_programa . "</option>";
        }
    }
    return ($opciones);
}
function OptionsGenericoPorEmpresa($campo, $tabla, $seleccionado, $id_empresa)
{
    if ($id_empresa) {
        $valores = SelectDistValorPorEmpresa($campo, $tabla, $id_empresa);
    } else {
        $valores = SelectDistValor($campo, $tabla);
    }
    foreach ($valores as $val) {
        if ($val->dato == $seleccionado) {
            $opciones .= "<option selected value='" . $val->dato . "'>" . $val->dato . "</option>";
        } else {
            $opciones .= "<option value='" . $val->dato . "'>" . $val->dato . "</option>";
        }
    }
    return (utf8_encode($opciones));
}
function ListadoObjetivosIngresado($rut, $fijador, $id_objetivo)
{
    $objetivos         = TraeObjetivosIndividualesDadoRut($rut);
    $listado_objetivos = "";
    if (count($objetivos) == 0) {
        $listado_objetivos .= file_get_contents("views/sgd/row_objetivos_individuales_no_tiene.html");
    } else {
        //Verifico si los objetivos individuales ya fueron enviados a validar a la jefatura
        //Si ya fue enviado, se muestrea template de row son boton de modificar, sino el que tiene boton de modificar
        $verifica_finalizado = VerificaFinalizadoObjetivosIndividuales($rut);
        if ($rut <> $fijador) {
            //verifico si esta revisado o no.
            $revisado = VerificaSiObjetivosEstanAjustados($rut);
            if ($revisado) {
                $row_template = file_get_contents("views/sgd/row_objetivos_individuales_lectura_jefatura.html");
            } else {
                //aca antes verifico si el rut fijador, es el mismo que el rut evaluador del evaluado.
                //Puede darse el caso de que no, para las visualizaciones en cascada, y en estos casos, debe mostrarse el row lectura
                $datos_evaluado = UsuarioEnBasePersonas($rut);
                if ($fijador == $datos_evaluado[0]->evaluador) {
                    $row_template = file_get_contents("views/sgd/row_objetivos_individuales_jefatura.html");
                } else {
                    $row_template = file_get_contents("views/sgd/row_objetivos_individuales_lectura_jefatura.html");
                }
            }
        } else {
            if ($verifica_finalizado) {
                $validado_jefe = VerificaSiObjetivosEstanAjustados($rut);
                if ($validado_jefe) {
                    $row_template = file_get_contents("views/sgd/row_objetivos_individuales_lectura.html");
                } else {
                    $row_template = file_get_contents("views/sgd/row_objetivos_individuales_lectura_sin_ponderacion.html");
                }
            } else {
                //Aca verifico si el evaluado es lo mismo que el evaluador
                $datos_jefe = ObtenerJefeRel($rut);
                if ($datos_jefe[0]->evaluador == $rut) {
                    $row_template = file_get_contents("views/sgd/row_objetivos_individuales.html");
                } else {
                    //$row_template=file_get_contents("views/sgd/row_objetivos_individuales.html");
                    $row_template = file_get_contents("views/sgd/row_objetivos_individuales_sin_pond.html");
                }
            }
        }
        foreach ($objetivos as $obj) {
            //Aca verifico si el id del objetivo que se envia como parametro, es igual al id del objetivo del ciclo, si es asi, coloco la fila para editar
            if ($id_objetivo == $obj->id) {
                $listado_objetivos .= file_get_contents("views/sgd/row_objetivos_individuales_editar_sinpond.html");
                $objetivos         = TraeObjetivosIndividualesDadoRut($rut);
                //$listado_objetivos = str_replace("{OPTIONS_DIMENSIONES}",OptionsGenericoNombre("tbl_objetivos_dimension", $obj->dimension),$listado_objetivos);
                $listado_objetivos = str_replace("{OPTIONS_DIMENSIONES}", OptionsGenericoNombreDadoValoresPorEmpresa("tbl_objetivos_dimension", $obj->dimension, "nombre", "id", "order by nombre asc", $_SESSION["id_empresa"]), $listado_objetivos);
                $listado_objetivos = str_replace("{OPTIONS_MESES}", OptionsGenerico("nombre", "tbl_meses", $obj->mes), $listado_objetivos);
                $listado_objetivos = str_replace("{OPTIONS_ANOS}", OptionsGenerico("nombre", "tbl_anos", $obj->ano), $listado_objetivos);
                $listado_objetivos = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($rut), $listado_objetivos);
                $listado_objetivos = str_replace("{ID_OBJETIVO_INDIVIDUAL_ENCODEADO}", Encodear3($obj->id), $listado_objetivos);
                //ACA COLOCO EL SELECT DEL FORMULARIO DE PRONDERACIONES INDIVIDUALES
                $options           = "";
                $datos_colaborador = UsuarioEnBasePersonas($rut);
                $ponderaciones     = TraePonderacionesPorPerfil($datos_colaborador[0]->perfil_evaluacion);
                $tope              = $ponderaciones[0]->objetivos_individuales;
                for ($i = 1; $i <= $tope; $i++) {
                    if ($i == $obj->ponderacion) {
                        $options .= "<option selected value='" . $i . "'>" . $i . "%</option>";
                    } else {
                        $options .= "<option value='" . $i . "'>" . $i . "%</option>";
                    }
                }
                $listado_objetivos = str_replace("{OPTIONS_PONDERACIONES}", $options, $listado_objetivos);
            } else {
                $listado_objetivos .= $row_template;
            }
            $listado_objetivos = str_replace("{DIMENSION}", $obj->nombre_dimension, $listado_objetivos);
            $listado_objetivos = str_replace("{OBJETIVO}", $obj->descripcion_objetivo, $listado_objetivos);
            $listado_objetivos = str_replace("{METRICA}", $obj->metrica, $listado_objetivos);
            $listado_objetivos = str_replace("{MES}", $obj->mes, $listado_objetivos);
            $listado_objetivos = str_replace("{ANO}", $obj->ano, $listado_objetivos);
            $listado_objetivos = str_replace("{PORCENTAJE}", $obj->ponderacion, $listado_objetivos);
            $listado_objetivos = str_replace("{ID_OBJETIVO_ENCODEADO}", Encodear3($obj->id), $listado_objetivos);
            $listado_objetivos = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($rut), $listado_objetivos);
        }
        //Aca verifico si est? aceptado o no por la jefatura, para colocar el semaforo de los objetivos.
        $listado_objetivos = SemaforosEstadosObjetivos($listado_objetivos, $rut);
    }
    return (utf8_encode($listado_objetivos));
}
function ListadoObjetivosAValidar($rut, $evaluador, $id_objetivo, $tipo, $id_proceso)
{
    $objetivos         = TraeObjetivosIndividualesDadoRut($rut);
    $listado_objetivos = "";
    foreach ($objetivos as $obj) {
        if ($id_objetivo == $obj->id) {
            $listado_objetivos .= file_get_contents("views/sgd/row_objetivos_individuales_validar_editar.html");
            $listado_objetivos = str_replace("{OPTIONS_DIMENSIONES}", OptionsGenericoNombre("tbl_objetivos_dimension", $obj->dimension), $listado_objetivos);
            $listado_objetivos = str_replace("{OPTIONS_MESES}", OptionsGenerico("nombre", "tbl_meses", $obj->mes), $listado_objetivos);
            $listado_objetivos = str_replace("{OPTIONS_ANOS}", OptionsGenerico("nombre", "tbl_anos", $obj->ano), $listado_objetivos);
            //ACA COLOCO EL SELECT DEL FORMULARIO DE PRONDERACIONES INDIVIDUALES
            $options           = "";
            //$datos_colaborador=UsuarioEnBasePersonas($rut);
            $datos_colaborador = UsuarioEnBasePersonasConRelacionEvaluadoEvaluadorDadoEvaluado($rut, $id_proceso);
            $ponderaciones     = TraePonderacionesPorPerfil($datos_colaborador[0]->perfil_evaluacion);
            //$tope=$ponderaciones[0]->objetivos_individuales;
            $tope              = 100;
            for ($i = 1; $i <= $tope; $i++) {
                //exit("asdf");
                if ($i == $obj->ponderacion) {
                    $options .= "<option selected value='" . $i . "'>" . $i . "%</option>";
                } else {
                    $options .= "<option value='" . $i . "'>" . $i . "%</option>";
                }
            }
            $listado_objetivos = str_replace("{OPTIONS_PONDERACIONES}", $options, $listado_objetivos);
        } else {
            if ($tipo == "jefe") {
                $validado = VerificaSiObjetivosEstanValidados($rut);
                if ($validado) {
                    $listado_objetivos .= file_get_contents("views/sgd/row_objetivos_individuales_validados.html");
                } else {
                    $listado_objetivos .= file_get_contents("views/sgd/row_objetivos_individuales_validar.html");
                }
            } else if ($tipo == "validador") {
                $listado_objetivos .= file_get_contents("views/sgd/validacion/row_objetivos_individuales_validador.html");
            }
        }
        //$listado_objetivos.=$row_template;
        $listado_objetivos     = str_replace("{ID_OBJETIVO_INDIVIDUAL_ENCODEADO}", Encodear3($obj->id), $listado_objetivos);
        $listado_objetivos     = str_replace("{ID_PROCESO_ENCODEADO}", Encodear3($id_proceso), $listado_objetivos);
        $listado_objetivos     = str_replace("{DIMENSION}", $obj->nombre_dimension, $listado_objetivos);
        $listado_objetivos     = str_replace("{OBJETIVO}", $obj->descripcion_objetivo, $listado_objetivos);
        $listado_objetivos     = str_replace("{METRICA}", $obj->metrica, $listado_objetivos);
        $listado_objetivos     = str_replace("{MES}", $obj->mes, $listado_objetivos);
        $listado_objetivos     = str_replace("{ANO}", $obj->ano, $listado_objetivos);
        $listado_objetivos     = str_replace("{PORCENTAJE}", $obj->ponderacion, $listado_objetivos);
        $acumulador_porcentaje = $acumulador_porcentaje + $obj->ponderacion;
        $listado_objetivos     = str_replace("{ID_OBJETIVO_ENCODEADO}", Encodear3($obj->id), $listado_objetivos);
        $listado_objetivos     = str_replace("{OPCION_ID_OBJ}", Encodear($rut) . "-" . Encodear($obj->id), $listado_objetivos);
        $listado_objetivos     = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($rut), $listado_objetivos);
        $listado_objetivos     = str_replace("{OPTIONS_OBJ}", PondObjetivos($obj->nota_ev), $listado_objetivos);
    }
    //Aca verifico si est? aceptado o no por la jefatura, para colocar el semaforo de los objetivos.
    $listado_objetivos = SemaforosEstadosObjetivos($listado_objetivos, $rut);
    $arreglo[0]        = utf8_encode($listado_objetivos);
    $arreglo[1]        = $acumulador_porcentaje;
    return ($arreglo);
}
function ListadoObjetivosEvaluacion($rut, $evaluador, $id_proceso, $id_empresa)
{
    //$objetivos=TraeObjetivosIndividualesDadoRut($rut);
    $objetivos         = TraeObjetivosIndividualesDadoRutEvaluadoEvaluadorIdProceso($rut, $evaluador, $id_proceso);
    $listado_objetivos = "";
    if ($objetivos) {
        foreach ($objetivos as $obj) {
            if ($obj->precargado == 1) {
                $row_template = file_get_contents("views/sgd/evaluacion/row_objetivos_individuales_evaluacion_precargado.html");
            } else {
                $row_template = file_get_contents("views/sgd/evaluacion/" . $id_empresa . "_row_objetivos_individuales_evaluacion.html");
            }
            $listado_objetivos .= $row_template;
            $listado_objetivos = str_replace("{DIMENSION}", $obj->nombre_dimension, $listado_objetivos);
            $listado_objetivos = str_replace("{OBJETIVO}", $obj->descripcion_objetivo, $listado_objetivos);
            $listado_objetivos = str_replace("{METRICA}", $obj->metrica, $listado_objetivos);
            $listado_objetivos = str_replace("{MES}", $obj->mes, $listado_objetivos);
            $listado_objetivos = str_replace("{ANO}", $obj->ano, $listado_objetivos);
            $listado_objetivos = str_replace("{PORCENTAJE}", $obj->ponderacion, $listado_objetivos);
            $listado_objetivos = str_replace("{ID_OBJETIVO_ENCODEADO}", Encodear3($obj->id), $listado_objetivos);
            $listado_objetivos = str_replace("{ID_OBJETIVO}", ($obj->id), $listado_objetivos);
            $listado_objetivos = str_replace("{OPCION_ID_OBJ}", Encodear($rut) . "-" . Encodear($obj->id), $listado_objetivos);
            $listado_objetivos = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($rut), $listado_objetivos);
            $listado_objetivos = str_replace("{RUT_EVALUADOR_ENCODEADO}", Encodear3($evaluador), $listado_objetivos);
            $listado_objetivos = str_replace("{ID_PROCESO_ENCODEADO}", Encodear3($id_proceso), $listado_objetivos);
            $listado_objetivos = str_replace("{VALOR_NOTA_OBJ_PRECARGADA}", $obj->nota_ev, $listado_objetivos);
            $listado_objetivos = str_replace("{COMENTARIO_OBJETIVO_INGRESADO}", $obj->comentario, $listado_objetivos);
            if ($obj->comentario) {
                $listado_objetivos = str_replace("{DISPLAY_NONE_COMENTARIO}", "", $listado_objetivos);
            } else {
                $listado_objetivos = str_replace("{DISPLAY_NONE_COMENTARIO}", 'style="display: none"', $listado_objetivos);
            }
            if ($obj->nota_descripcion) {
                $listado_objetivos = str_replace("{VALOR_NOTA_OBJ_PRECARGADA_DESC}", $obj->nota_descripcion, $listado_objetivos);
            } else {
                $listado_objetivos = str_replace("{VALOR_NOTA_OBJ_PRECARGADA_DESC}", $obj->nota_ev, $listado_objetivos);
            }
            //$listado_objetivos = str_replace("{OPTIONS_OBJ}",PondObjetivos($obj->nota_ev),$listado_objetivos);
            //$listado_objetivos = str_replace("{OPTIONS_OBJ}",PondObjetivos3($obj->nota),$listado_objetivos);
            $listado_objetivos = str_replace("{OPTIONS_OBJ}", PondObjetivos3($obj->alternativa_seleccionada), $listado_objetivos);
            $listado_objetivos = str_replace("{SELECTED_" . $obj->alternativa_seleccionada . "}", "selected='selected'", $listado_objetivos);
            $listado_objetivos = str_replace("{SELECTED_1}", "", $listado_objetivos);
            $listado_objetivos = str_replace("{SELECTED_2}", "", $listado_objetivos);
            $listado_objetivos = str_replace("{SELECTED_3}", "", $listado_objetivos);
            $listado_objetivos = str_replace("{SELECTED_4}", "", $listado_objetivos);
            $listado_objetivos = str_replace("{SELECTED_5}", "", $listado_objetivos);
            //Aca veo si hay respuestas
        }
        //Aca verifico si est? aceptado o no por la jefatura, para colocar el semaforo de los objetivos.
        $listado_objetivos = SemaforosEstadosObjetivos($listado_objetivos, $rut);
    } else {
        $listado_objetivos = file_get_contents("views/sgd/evaluacion/row_objetivos_individuales_evaluacion_no_tiene.html");
    }
    return (utf8_encode($listado_objetivos));
}
function FormularioEditaObjetivos($html, $rut, $fijador, $id_objetivo)
{
    $datos_objetivos   = TraeObjetivosIndividualesDadoIdObjetivo($id_objetivo);
    $html              = ColocaDatosUsuario($html, $rut);
    $html              = str_replace("{OPTIONS_DIMENSIONES}", OptionsGenericoNombreDadoValoresPorEmpresa("tbl_objetivos_dimension", "", "nombre", "id", "order by nombre asc", $_SESSION["id_empresa"]), $html);
    //$html = str_replace("{OPTIONS_DIMENSIONES}",OptionsGenericoNombreDadoValoresPorEmpresa("tbl_objetivos_dimension", $datos_objetivos[0]->dimension,  "nombre", "id", "order by nombre asc", $_SESSION["id_empresa"]),$html);
    $html              = str_replace("{OPTIONS_MESES}", OptionsGenerico("nombre", "tbl_meses", $datos_objetivos[0]->mes), $html);
    $html              = str_replace("{OPTIONS_ANOS}", OptionsGenerico("nombre", "tbl_anos", $datos_objetivos[0]->ano), $html);
    //$html = str_replace("{OPTIONS_PONDERACIONES}",OptionsGenerico("nombre", "tbl_ponderaciones", $datos_objetivos[0]->ponderacion),$html);
    //Funcion para mostrar listado deobjetivos ingresados
    $html              = str_replace("{LISTADO_OBJETIVOS_INGRESADOS}", ListadoObjetivosIngresado($rut, $fijador, $id_objetivo), $html);
    $html              = str_replace("{RUT_ENCODEADO}", Encodear3($rut), $html);
    $objetivos         = TraeObjetivosIndividualesDadoRut($rut);
    $html              = str_replace("{ROWSPAN}", count($objetivos) + 1, $html);
    $html              = str_replace("{ID_OBJETIVO_ENCODEADO}", Encodear3($id_objetivo), $html);
    $html              = str_replace("{VALUE_OBJETIVO}", utf8_encode($datos_objetivos[0]->descripcion_objetivo), $html);
    $html              = str_replace("{VALUE_METRICA}", utf8_encode($datos_objetivos[0]->metrica), $html);
    $ponderaciones     = TraePonderacionesPorPerfil($datos_colaborador[0]->perfil_evaluacion);
    //ACA COLOCO EL SELECT DEL FORMULARIO DE PRONDERACIONES INDIVIDUALES
    $options           = "";
    $datos_colaborador = UsuarioEnBasePersonas($rut);
    $ponderaciones     = TraePonderacionesPorPerfil($datos_colaborador[0]->perfil_evaluacion);
    $tope              = $ponderaciones[0]->objetivos_individuales;
    for ($i = 1; $i <= $tope; $i++) {
        if ($i == $datos_objetivos[0]->ponderacion) {
            $options .= "<option selected value='" . $i . "'>" . $i . "%</option>";
        } else {
            $options .= "<option value='" . $i . "'>" . $i . "%</option>";
        }
    }
    $html               = str_replace("{OPTIONS_PONDERACIONES}", $options, $html);
    $suma_ponderaciones = SumaPonderacionesPorRut($rut);
    //if($suma_ponderaciones[0]->suma_ponderaciones==$tope){
    //$html = str_replace("{BOTON_VALIDACION}",file_get_contents("views/sgd/boton_evaluador_valida.html"),$html);
    //$html = str_replace("{RUT_ENCODEADO}",Encodear3($rut),$html);
    //$html = str_replace("{NOMBRE}",utf8_encode($datos_colaborador[0]->nombre_completo),$html);
    //}else{
    //$html = str_replace("{BOTON_VALIDACION}",file_get_contents("views/sgd/texto_no_100.html"),$html);
    //}
    $html               = str_replace("{BOTON_VALIDACION}", "", $html);
    return ($html);
}
function FormularioIngresaObjetivos($html, $rut, $fijador, $pdf)
{
    $id_proceso        = $_SESSION["id_proceso"];
    //Datos Colaborador...
    //$datos_colaborador=UsuarioEnBasePersonas($rut);
    $datos_colaborador = UsuarioEnBasePersonasConRelacionEvaluadoEvaluador($rut, $fijador, $id_proceso);
    $datos_evaluacion  = ObtenerJefeRel($rut);
    /*$html = str_replace("{NOMBRE_EVALUADO}",utf8_encode($datos_colaborador[0]->nombre_completo),$html);
    $html = str_replace("{CARGO_EVALUADO}",utf8_encode($datos_colaborador[0]->cargo),$html);
    $html = str_replace("{PERFIL_EVALUACION}",utf8_encode($datos_colaborador[0]->perfil_evaluacion),$html);
    $html = str_replace("{CARGO_EVALUADO}",utf8_encode($datos_colaborador[0]->cargo),$html);
    $html = str_replace("{IMAGEN_EVALUADO}",VerificaFotoPersonal($datos_colaborador[0]->rut),$html);
    */
    $html              = ColocaDatosUsuario($html, $rut, "", "", "", $pdf);
    //$html = str_replace("{OPTIONS_DIMENSIONES}",OptionsGenericoNombre("tbl_objetivos_dimension", ""),$html);
    $html              = str_replace("{OPTIONS_DIMENSIONES}", OptionsGenericoNombreDadoValoresPorEmpresa("tbl_objetivos_dimension", "", "nombre", "id", "order by nombre asc", $_SESSION["id_empresa"]), $html);
    $html              = str_replace("{OPTIONS_MESES}", OptionsGenerico("nombre", "tbl_meses", ""), $html);
    $html              = str_replace("{OPTIONS_ANOS}", OptionsGenerico("nombre", "tbl_anos", ""), $html);
    //$html = str_replace("{OPTIONS_PONDERACIONES}",OptionsGenerico("nombre", "tbl_ponderaciones", ""),$html);
    //EN LA FUNCION ColocaPonderaciones, SE COLOCA EL SELECT DE LAS PONDERACIONES, YA QUE ESTE SE ARMA EN BASE A LA PONDERACION DE LOS OBJETIVOS INDIVIDUALES
    //Funcion para mostrar listado deobjetivos ingresados
    $html              = str_replace("{LISTADO_OBJETIVOS_INGRESADOS}", ListadoObjetivosIngresado($rut, $fijador), $html);
    $objetivos         = TraeObjetivosIndividualesDadoRut($rut);
    $html              = str_replace("{ROWSPAN}", count($objetivos) + 1, $html);
    //Aca valido la suma de los porcentajes.
    //Si es igual a 100%, muestroel boton, sino un mensaje.
    //ESTA OPCION ES PARA CUANDO LOS OBJETIVOS INGRESADOS DEBE SUMAR 100%
    /*$suma_ponderaciones=SumaPonderacionesPorRut($rut);
    if($suma_ponderaciones[0]->suma_ponderaciones==100){
    $html = str_replace("{BOTON_VALIDACION}",file_get_contents("views/sgd/boton_envia_a_jefe.html"),$html);
    }else{
    $html = str_replace("{BOTON_VALIDACION}",file_get_contents("views/sgd/texto_no_100.html"),$html);
    }
    */
    $ponderaciones     = TraePonderacionesPorPerfil($datos_colaborador[0]->perfil_evaluacion);
    //ACA COLOCO EL SELECT DEL FORMULARIO DE PRONDERACIONES INDIVIDUALES
    $options           = "";
    //$tope=$ponderaciones[0]->objetivos_individuales;
    $tope              = 100;
    for ($i = 1; $i <= $tope; $i++) {
        $options .= "<option value='" . $i . "'>" . $i . "%</option>";
    }
    $html               = str_replace("{OPTIONS_PONDERACIONES}", $options, $html);
    $suma_ponderaciones = SumaPonderacionesPorRut($rut);
    if ($suma_ponderaciones[0]->suma_ponderaciones == $tope) {
        $html = str_replace("{BOTON_VALIDACION}", file_get_contents("views/sgd/boton_envia_a_jefe.html"), $html);
    } else {
        $html = str_replace("{BOTON_VALIDACION}", file_get_contents("views/sgd/texto_no_100.html"), $html);
    }
    //coloca Ponderaciones
    //Aca verifico si el usuario indico si est? conforme o no.
    $evaluado_tomo_conoc = TomoConocimientoEvaluado($rut);
    if ($evaluado_tomo_conoc) {
        $html = str_replace("{TR_DINAMICO}", "", $html);
    } else {
        //$jefe_finalizo=VerificaSiObjetivosEstanAjustados($rut);
        $jefe_finalizo = VerificaSiObjetivosEstanValidados($rut);
        if ($jefe_finalizo) {
            //if($datos_evaluacion[0]->evaluado==$datos_evaluacion[0]->evaluador && $datos_evaluacion[0]->evaluador==$datos_evaluacion[0]->validador){
            if ($datos_evaluacion[0]->evaluado == $datos_evaluacion[0]->evaluador) {
                //$html = str_replace("{TR_DINAMICO}","",$html);
                $html = str_replace("{TR_DINAMICO}", file_get_contents("views/sgd/boton_conocimiento_obj.html"), $html);
            } else {
                $html = str_replace("{TR_DINAMICO}", file_get_contents("views/sgd/boton_conocimiento_obj.html"), $html);
            }
        } else {
            $html = str_replace("{TR_DINAMICO}", "", $html);
        }
    }
    //BOTON DE COMPETENCIAS
    $html = MuestraBotonCompetencias($html, $rut);
    $html = str_replace("{RUT_ENCODEADO}", Encodear3($rut), $html);
    return ($html);
}
function FormularioIngresaObjetivosSinPonderacion($html, $rut, $fijador, $pdf)
{
    //Datos Colaborador...
    $datos_colaborador = UsuarioEnBasePersonas($rut);
    /*$html = str_replace("{NOMBRE_EVALUADO}",utf8_encode($datos_colaborador[0]->nombre_completo),$html);
    $html = str_replace("{CARGO_EVALUADO}",utf8_encode($datos_colaborador[0]->cargo),$html);
    $html = str_replace("{PERFIL_EVALUACION}",utf8_encode($datos_colaborador[0]->perfil_evaluacion),$html);
    $html = str_replace("{CARGO_EVALUADO}",utf8_encode($datos_colaborador[0]->cargo),$html);
    $html = str_replace("{IMAGEN_EVALUADO}",VerificaFotoPersonal($datos_colaborador[0]->rut),$html);
    */
    $html              = ColocaDatosUsuario($html, $rut, "", "", "", $pdf);
    $html              = str_replace("{OPTIONS_DIMENSIONES}", OptionsGenericoNombreDadoValoresPorEmpresa("tbl_objetivos_dimension", "", "nombre", "id", "order by nombre asc", $_SESSION["id_empresa"]), $html);
    $html              = str_replace("{OPTIONS_MESES}", OptionsGenerico("nombre", "tbl_meses", ""), $html);
    $html              = str_replace("{OPTIONS_ANOS}", OptionsGenerico("nombre", "tbl_anos", ""), $html);
    //$html = str_replace("{OPTIONS_PONDERACIONES}",OptionsGenerico("nombre", "tbl_ponderaciones", ""),$html);
    //EN LA FUNCION ColocaPonderaciones, SE COLOCA EL SELECT DE LAS PONDERACIONES, YA QUE ESTE SE ARMA EN BASE A LA PONDERACION DE LOS OBJETIVOS INDIVIDUALES
    //Funcion para mostrar listado deobjetivos ingresados
    //$html = str_replace("{LISTADO_OBJETIVOS_INGRESADOS}",ListadoObjetivosIngresado($rut, $fijador),$html);
    $html              = str_replace("{LISTADO_OBJETIVOS_INGRESADOS}", ListadoObjetivosIngresado($rut, $fijador), $html);
    $objetivos         = TraeObjetivosIndividualesDadoRut($rut);
    $html              = str_replace("{ROWSPAN}", count($objetivos) + 1, $html);
    if (count($objetivos) > 0 and count($objetivos) < 7) {
        $html = str_replace("{BOTON_VALIDACION}", file_get_contents("views/sgd/boton_envia_a_jefe.html"), $html);
    } else {
        $html = str_replace("{BOTON_VALIDACION}", file_get_contents("views/sgd/texto_no_objetivos_min_max.html"), $html);
    }
    $ponderaciones       = TraePonderacionesPorPerfil($datos_colaborador[0]->perfil_evaluacion);
    //ACA COLOCO EL SELECT DEL FORMULARIO DE PRONDERACIONES INDIVIDUALES
    /*$options="";
    $tope=$ponderaciones[0]->objetivos_individuales;
    for($i=1;$i<=$tope;$i++){
    $options.="<option value='".$i."'>".$i."%</option>";
    }
    $suma_ponderaciones=SumaPonderacionesPorRut($rut);
    if($suma_ponderaciones[0]->suma_ponderaciones==$tope){
    $html = str_replace("{BOTON_VALIDACION}",file_get_contents("views/sgd/boton_envia_a_jefe.html"),$html);
    }else{
    $html = str_replace("{BOTON_VALIDACION}",file_get_contents("views/sgd/texto_no_100.html"),$html);
    }*/
    //coloca Ponderaciones
    //Aca verifico si el usuario indico si est? conforme o no.
    $evaluado_tomo_conoc = TomoConocimientoEvaluado($rut);
    if ($evaluado_tomo_conoc) {
        $html = str_replace("{TR_DINAMICO}", "", $html);
    } else {
        $jefe_finalizo = VerificaSiObjetivosEstanAjustados($rut);
        if ($jefe_finalizo) {
            $html = str_replace("{TR_DINAMICO}", file_get_contents("views/sgd/boton_conocimiento_obj.html"), $html);
        } else {
            $html = str_replace("{TR_DINAMICO}", "11111", $html);
        }
    }
    //BOTON DE COMPETENCIAS
    $html = MuestraBotonCompetencias($html, $rut);
    $html = str_replace("{RUT_ENCODEADO}", Encodear3($rut), $html);
    return ($html);
}
function FormularioRevisaObjetivosJefatura($html, $rut, $fijador)
{
    //Datos Colaborador...
    $datos_colaborador  = UsuarioEnBasePersonas($rut);
    //echo "$fijador ".$datos_colaborador[0]->evaluador;
    $html               = ColocaDatosUsuario($html, $rut);
    $html               = str_replace("{OPTIONS_DIMENSIONES}", OptionsGenericoNombre("tbl_objetivos_dimension", ""), $html);
    $html               = str_replace("{OPTIONS_MESES}", OptionsGenerico("nombre", "tbl_meses", ""), $html);
    $html               = str_replace("{OPTIONS_ANOS}", OptionsGenerico("nombre", "tbl_anos", ""), $html);
    //$html = str_replace("{OPTIONS_PONDERACIONES}",OptionsGenerico("nombre", "tbl_ponderaciones", ""),$html);
    //Funcion para mostrar listado deobjetivos ingresados
    $html               = str_replace("{LISTADO_OBJETIVOS_INGRESADOS}", ListadoObjetivosIngresado($rut, $fijador), $html);
    $objetivos          = TraeObjetivosIndividualesDadoRut($rut);
    $html               = str_replace("{ROWSPAN}", count($objetivos) + 1, $html);
    //Aca valido la suma de los porcentajes.
    //Si es igual a 100%, muestroel boton, sino un mensaje.
    $ponderaciones      = TraePonderacionesPorPerfil($datos_colaborador[0]->perfil_evaluacion);
    //ACA COLOCO EL SELECT DEL FORMULARIO DE PRONDERACIONES INDIVIDUALES
    $tope               = $ponderaciones[0]->objetivos_individuales;
    $suma_ponderaciones = SumaPonderacionesPorRut($rut);
    if ($suma_ponderaciones[0]->suma_ponderaciones == $tope) {
        $html = str_replace("{BOTON_VALIDACION}", file_get_contents("views/sgd/boton_evaluador_valida.html"), $html);
    } else {
        $html = str_replace("{BOTON_VALIDACION}", file_get_contents("views/sgd/texto_no_100.html"), $html);
    }
    $html    = str_replace("{RUT_ENCODEADO}", Encodear3($rut), $html);
    $html    = str_replace("{NOMBRE}", utf8_encode($datos_colaborador[0]->nombre_completo), $html);
    //ACA COLOCO EL SELECT DEL FORMULARIO DE PRONDERACIONES INDIVIDUALES
    $options = "";
    $tope    = $ponderaciones[0]->objetivos_individuales;
    for ($i = 1; $i <= $tope; $i++) {
        $options .= "<option value='" . $i . "'>" . $i . "%</option>";
    }
    $html = str_replace("{OPTIONS_PONDERACIONES}", $options, $html);
    return ($html);
}
function EstadosObjetivosPorUsuario($html, $rut)
{
    return ($html);
}
function VerificaObjetivoEmpresaFinalizado($rut, $id_empresa)
{
    $verifica_finalizado = VerificaObjetivoEmpresa($rut, $id_empresa);
    if ($verifica_finalizado) {
        $arreglo[0] = "1";
    } else {
        $arreglo[0] = "0";
    }
    return ($arreglo);
}
function ListadoObjetivosEmpresa($rut)
{
    $html              = file_get_contents("views/sgd/sgd3_objetivos_empresa.html");
    $datos_usuario     = UsuarioEnBasePersonasInnerArea($rut);
    //print_r($datos_usuario);
    $objetivos_empresa = ObjetivosDeEmpresa($datos_usuario[0]->id_empresa);
    //print_r($objetivos_empresa);
    if (count($objetivos_empresa) == 0) {
        $total = file_get_contents("views/sgd/row_objetivos_empresa_no_tiene.html");
    } else {
        $total = "";
        foreach ($objetivos_empresa as $obj) {
            $total .= file_get_contents("views/sgd/row_objetivos_empresa.html");
            $total = str_replace("{OBJETIVO_EMPRESA}", utf8_encode($obj->descripcion_objetivo), $total);
        }
    }
    //Con este veo si finaliz? o no los objetivos empresas
    $finalizado_objetivo_empresa = VerificaObjetivoEmpresa($rut, $datos_usuario[0]->id_empresa);
    if ($finalizado_objetivo_empresa) {
        $html  = str_replace("{BOTON_FINALIZA_EMPRESA}", file_get_contents("views/sgd/boton_ok_obj_empresa.html"), $html);
        $total = str_replace("{ESTILO_SEMAFORO}", "fa fa-check text-iconos", $total);
        $total = str_replace("{ESTILO_SEMAFORO_TR}", "tr_objetivos_activo ", $total);
    } else {
        $html  = str_replace("{BOTON_FINALIZA_EMPRESA}", file_get_contents("views/sgd/boton_pendiente.html"), $html);
        $html  = str_replace("{RUT_ENCODEADO}", Encodear3($rut), $html);
        $html  = str_replace("{ID_EMPRESA_ENCODEADA}", Encodear3($datos_usuario[0]->id_empresa), $html);
        $total = str_replace("{ESTILO_SEMAFORO}", "fa fa-circle-thin text-iconos", $total);
        $total = str_replace("{ESTILO_SEMAFORO_TR}", "tr_objetivos_pasivo ", $total);
    }
    $html = str_replace("{LISTADO_OBJETIVOS_EMPRESA}", $total, $html);
    return ($html);
}
function ListadoObjetivosArea($rut)
{
    $html           = file_get_contents("views/sgd/sgd3_objetivos_area.html");
    //Primero obtengo los datos del usuario, para traer el id del Area
    $datos_usuario  = UsuarioEnBasePersonasInnerArea($rut);
    //con el id del area, y el id de la empresa, traigo los datos de los objetivos de area
    $objetivos_area = DatosObjetivosArea($datos_usuario[0]->id_area, $datos_usuario[0]->id_empresa);
    if (count($objetivos_area) == 0) {
        $total = file_get_contents("views/sgd/row_objetivos_area_no_tiene.html");
        $total = str_replace("{AREA}", utf8_encode($datos_usuario[0]->nombre_area), $total);
    } else {
        foreach ($objetivos_area as $obj) {
            $total .= file_get_contents("views/sgd/row_objetivos_area.html");
            $total = str_replace("{AREA}", utf8_encode($obj->descripcion_objetivo), $total);
        }
    }
    //Aca verifico si es que fueron finalizados los objetivos de Area
    $objetivos_area_finalizado = VerificaFinalizadoObjetivosArea($rut, $datos_usuario[0]->id_area);
    if ($objetivos_area_finalizado) {
        $html  = str_replace("{BOTON_FINALIZA_OBJETIVOS_AREA}", file_get_contents("views/sgd/boton_ok_obj_area.html"), $html);
        $total = str_replace("{ESTILO_SEMAFORO}", "fa fa-check text-iconos", $total);
        $total = str_replace("{ESTILO_SEMAFORO_TR}", "tr_objetivos_activo ", $total);
    } else {
        $html  = str_replace("{BOTON_FINALIZA_OBJETIVOS_AREA}", file_get_contents("views/sgd/boton_pendiente_area.html"), $html);
        $html  = str_replace("{RUT_ENCODEADO}", Encodear3($rut), $html);
        $html  = str_replace("{ID_EMPRESA_ENCODEADA}", Encodear3($datos_usuario[0]->id_empresa), $html);
        $html  = str_replace("{ID_AREA_ENCODEADA}", Encodear3($datos_usuario[0]->id_area), $html);
        $total = str_replace("{ESTILO_SEMAFORO}", "fa fa-circle-thin text-iconos", $total);
        $total = str_replace("{ESTILO_SEMAFORO_TR}", "tr_objetivos_pasivo ", $total);
    }
    $html = str_replace("{LISTADO_OBJETIVOS_AREA}", $total, $html);
    return ($html);
}
function MuestraObjetivos($html, $rut, $id_proceso)
{
    if ($id_proceso) {
        $datos_usuario = UsuarioEnBasePersonasConRelacionEvaluadoEvaluadorDadoEvaluado($rut, $id_proceso);
    } else {
        $datos_usuario = UsuarioEnBasePersonasInnerArea($rut);
    }
    //Objetivos Empresa
    $listado_objetivos_empresa    = ListadoObjetivosEmpresa($rut);
    $html                         = str_replace("{BLOQUE_OBJETIVOS_EMPRESA}", $listado_objetivos_empresa, $html);
    //Verifico si esta finalizado los objetivos de empresa
    $objetivos_empresa_finalizado = VerificaObjetivoEmpresa($rut, $datos_usuario[0]->id_empresa);
    if ($objetivos_empresa_finalizado) {
        //Objetivos Area. Los muestro
        $listado_objetivos_area = ListadoObjetivosArea($rut);
        $html                   = str_replace("{BLOQUE_OBJETIVOS_AREA}", $listado_objetivos_area, $html);
    } else {
        //Objetivos Area. No los muestro hasta que se finalize.
        $html = str_replace("{BLOQUE_OBJETIVOS_AREA}", "", $html);
    }
    //Verifico si est? finalizado los objetivos del area.
    $objetivos_area_finalizado = VerificaFinalizadoObjetivosArea($rut, $datos_usuario[0]->id_area);
    if ($objetivos_area_finalizado) {
        $html = str_replace("{BLOQUE_OBJETIVOS_INDIVIDUALES}", "", $html);
    } else {
        $html = str_replace("{BLOQUE_OBJETIVOS_INDIVIDUALES}", "", $html);
    }
    return ($html);
}
function MuestaDatosEval($html, $rut, $rut_evaluador, $id_proceso)
{
    //Datos del usuario
    //$html=ColocaDatosUsuario($html, $rut, "", $rut_evaluador, $id_proceso);
    $html = ColocaDatosUsuarioSGD($html, $rut, "", $rut_evaluador, $id_proceso);
    return ($html);
}
//FUNCION PARA OBTENER DIFERENTES DATOS DE UN CURSO, DADO EL ID DEL CURSO Y EL RUT
function ObtenerNotaEstadoCursoDadoIdCursoRut($id_curso, $rut)
{
    //OBTENGO TODOS LOS DATOS DEL CURSO
    $objetos                   = ObjetosDadoCurso($id_curso, $rut);
    //EN ESTA VARIABLE ACUMULO EL TOTAL DE OBJETIVOS QUE TIENEN NOTA
    $total_notas               = 0;
    //EN ESTA VARIABLE ACUMULO LAS NOTAS
    $acum_notas                = 0;
    //EN ESTA VARIABLE ACUMULO EL TOTAL DE LOS OBJETOS QUE SE ENCUENTRAN FINALIZADOS
    $total_objetos_finalizados = 0;
    foreach ($objetos as $ob) {
        //CON ESTA CONDICION VEO SI EL OBJETOS TIENE NOTA DE FINALIZACION
        if ($ob->nota_objeto >= "0") {
            //INCREMENTO EL TOTAL DE OBJETOS CON NOTAS
            $total_notas++;
            //LA NOTA LA ACUMULO EN UNA VARIABLE, PARA DESPUES SACAR EL PROMEDIO DEL CURSO
            $acum_notas = $acum_notas + $ob->nota_objeto;
        }
        //CON ESTA CONDICION VERIFICO SI EL OBJETO EN CUESTION EST? FINALIZADO
        if ($ob->fecha_finalizacion) {
            //EN LA SIGUIENTE, ACUMULO LOS OBJETIVOS FINALIZADOS, PARA DESPUES COMPARAR SI ESTAN TODOS FINAIZADOS
            $total_objetos_finalizados++;
        }
    }
    //EN EL ARREGLO[0], GUARDO LA NOTA DEL CURSO, EN BASE A LAS EVALUACIONES FINALIZADAS.
    $arreglo[0] = number_format($acum_notas / $total_notas, 0);
    //ESTA FUNCION ME ENTREGA DE VUELTA SI EST? O NO APROBADA EN BASE A LA NOTA CALCULADA.
    $estado     = ApruebaReprueba($arreglo[0]);
    //PRIMERO VEO SI EL CONTADOR DE OBJETOS FINALIZADOS ESTA EN 0, SI ES ASI, ES PORQUE NO SE HA FINALIZADO NINGUN OBJETO, POR ENDE ESTA NO INICIADO
    if ($total_objetos_finalizados == 0) {
        $arreglo[1] = "no_iniciado";
        //CON LA SIGUIENTE,VEO SI ESQUE ES DIFERENTE A 0 EL TOTAL DE OBJETIVOS, PERO MENOR AL TOTAL DE OBJETOS, IMPLICA QUE ESTA EN PROCESO
    } else if ($total_objetos_finalizados < count($objetos)) {
        $arreglo[1] = "en_proceso";
        //CON LA SIGUIENTE SE ASUME QUE ESTAN TODOS FINALIZADOS, Y DEVUELTA ENTREGA "SI" EST? O "NO" APROBADO EL CURSO.
    } else {
        $arreglo[1] = $estado[2];
    }
    return ($arreglo);
}
//OJO, que la variable, arreglo_post, se est? enviando desde los filtros del administrador.
function ObtenerUsuariosDadoCurso($id_curso, $arreglo_post)
{
    //CON ESTA FUNCION OBTENGO EL LISTADO DE USUARIOS QUE ESTAN ASOCIADOS AL CURSO EN CUESTION
    //Primero obtengo las mallas del curso
    $mallas_dado_curso = ObtenerCargosDadoIdCurso($id_curso);
    //Con los datos de la tabla rel_malla, traigo a los usuarios
    $i                 = 0;
    $aprobados         = 0;
    $reprobados        = 0;
    foreach ($mallas_dado_curso as $valores) {
        //Con cada criterio, traigo los usuarios, y los voy guardando en un arreglo.
        //Traigo los usuarios
        $usuarios = TraeUsuariosDadoCriterio($valores->campo, $valores->cargo, $arreglo_post);
        foreach ($usuarios as $unico) {
            $arreglo_usurios[$i] = $unico->rut;
            $i++;
        }
    }
    $arreglo[0] = count($arreglo_usurios);
    for ($j = 0; $j < count($arreglo_usurios); $j++) {
        $aprueba_reprueba = ObtenerNotaEstadoCursoDadoIdCursoRut($id_curso, $arreglo_usurios[$j]);
        if ($aprueba_reprueba[1] == "si") {
            $aprobados++;
        } else if ($aprueba_reprueba[1] == "no") {
            $reprobados++;
        } else if ($aprueba_reprueba[1] == "no_iniciado") {
            $no_iniciados++;
        } else if ($aprueba_reprueba[1] == "en_proceso") {
            $en_proceso++;
        }
    }
    $arreglo[1] = $aprobados;
    $arreglo[2] = $reprobados;
    $arreglo[3] = $en_proceso;
    $arreglo[4] = $no_iniciados;
    return ($arreglo);
}
function TotalCursosPorUsuario($rut, $id_cargo, $id_empresa)
{
    //Dado el usuario, obtengo la malla, y su cantidad de programas.
    $datos_malla                  = ObtengoIdMalla($id_empresa, $id_cargo);
    $programas                    = ProgramasDadoMalla($datos_malla[0]->id_malla);
    $total_cursos                 = 0;
    $total_cursos_aprobados       = 0;
    $total_cursos_reprobados      = 0;
    $total_cursos_pendientes      = 0;
    $total_cursos_proceso         = 0;
    $acumulador_de_notas_de_curso = 0;
    foreach ($programas as $unico) {
        $datos_avance_porc_programa      = NotaPromedioProgramaDadoIdPrograma($rut, $unico->id);
        $total_cursos                    = $total_cursos + $datos_avance_porc_programa[3];
        $total_cursos_aprobados          = $total_cursos_aprobados + $datos_avance_porc_programa[4];
        $total_cursos_reprobados         = $total_cursos_reprobados + $datos_avance_porc_programa[5];
        $total_cursos_pendientes         = $total_cursos_pendientes + $datos_avance_porc_programa[6];
        $total_cursos_proceso            = $total_cursos_proceso + $datos_avance_porc_programa[7];
        $acumulador_de_notas_de_curso    = $acumulador_de_notas_de_curso + $datos_avance_porc_programa[8];
        $acumulador_de_total_notas_curso = $acumulador_de_total_notas_curso + $datos_avance_porc_programa[9];
    }
    //Total de Cursos por programa
    $arreglo_programa[0] = $total_cursos;
    $arreglo_programa[1] = $total_cursos_aprobados;
    $arreglo_programa[2] = $total_cursos_reprobados;
    $arreglo_programa[3] = $total_cursos_pendientes;
    $arreglo_programa[4] = $total_cursos_proceso;
    $arreglo_programa[5] = number_format($acumulador_de_notas_de_curso / $acumulador_de_total_notas_curso, 0);
    return ($arreglo_programa);
}
function DevuelveEstadoProgramaCursos($nota, $avance_programa, $id, $id_malla, $tipo)
{
    if ($tipo == "programa") {
        $nota_aprobacion = NotaAprobacionDadoMallaPrograma($id_malla, $id);
    } else if ($tipo == "curso") {
        $nota_aprobacion = DatosObjeto($id);
    }
    if ($avance_programa == 0) {
        $arreglo[0] = '<span class="fa fa-circle text-pendiente fs14 mr10"></span>&nbsp;<span class="etiquetaPrograma etiquetaPrograma-pendiente">Pendiente</span>';
        $arreglo[1] = "#777777";
        $arreglo[2] = "etiquetaPrograma-pendiente";
        $arreglo[3] = "txto1-pendiente";
    } else if ($avance_programa == 100) {
        if ($nota >= $nota_aprobacion[0]->nota_aprobacion) {
            $arreglo[0] = '<span class="fa fa-circle text-success fs14 mr10"></span>&nbsp;<span class="etiquetaPrograma etiquetaPrograma-aprobado">Aprobado</span>';
            $arreglo[1] = "#35d37d";
            $arreglo[2] = "etiquetaPrograma-aprobado";
            $arreglo[3] = "texto1-aprobado";
        } else {
            $arreglo[0] = '<span class="fa fa-circle text-danger fs14 mr10"></span>&nbsp;<span class="etiquetaPrograma etiquetaPrograma-reprobado">.Reprobado</span>';
            $arreglo[1] = "#ec6f5a";
            $arreglo[2] = "etiquetaPrograma-reprobado";
            $arreglo[3] = "texto1-reprobado";
        }
    } else {
        $arreglo[0] = '<span class="fa fa-circle text-warning fs14 mr10"></span>&nbsp;<span class="etiquetaPrograma etiquetaPrograma-proceso">En Proceso</span>';
        $arreglo[1] = "#f6bb42";
        $arreglo[2] = "etiquetaPrograma-proceso";
        $arreglo[3] = "texto1-proceso";
    }
    return ($arreglo);
}
function DevuelveEstadoPrograma($nota_programa, $avance_programa, $id_programa, $id_malla)
{
    $nota_programa_requerida = NotaAprobacionDadoMallaPrograma($id_malla, $id_programa);
    if ($avance_programa == 0) {
        $arreglo[0] = '<span class="fa fa-circle text-pendiente fs14 mr10"></span>&nbsp;<span class="etiquetaPrograma etiquetaPrograma-pendiente">Pendiente</span>';
        $arreglo[1] = "#777777";
        $arreglo[2] = "etiquetaPrograma-pendiente";
        $arreglo[3] = "txto1-pendiente";
    } else if ($avance_programa == 100) {
        if ($nota_programa >= $nota_programa_requerida[0]->nota_aprobacion) {
            $arreglo[0] = '<span class="fa fa-circle text-success fs14 mr10"></span>&nbsp;<span class="etiquetaPrograma etiquetaPrograma-aprobado">Aprobado</span>';
            $arreglo[1] = "#35d37d";
            $arreglo[2] = "etiquetaPrograma-aprobado";
            $arreglo[3] = "texto1-aprobado";
        } else {
            $arreglo[0] = '<span class="fa fa-circle text-danger fs14 mr10"></span>&nbsp;<span class="etiquetaPrograma etiquetaPrograma-reprobado">.Reprobado</span>';
            $arreglo[1] = "#ec6f5a";
            $arreglo[2] = "etiquetaPrograma-reprobado";
            $arreglo[3] = "texto1-reprobado";
        }
    } else {
        $arreglo[0] = '<span class="fa fa-circle text-warning fs14 mr10"></span>&nbsp;<span class="etiquetaPrograma etiquetaPrograma-proceso">En Proceso</span>';
        $arreglo[1] = "#f6bb42";
        $arreglo[2] = "etiquetaPrograma-proceso";
        $arreglo[3] = "texto1-proceso";
    }
    return ($arreglo);
}
function NotaPromedioProgramaDadoIdPrograma($rut, $id_programa)
{
    $cursos                              = CantidadCursosPorPrograma($id_programa);
    $total_cursos_fin                    = 0;
    $total_notas                         = 0;
    $acum_notas                          = 0;
    $acumulacion_tiempo                  = 0;
    $total_objetos_finalizados           = 0;
    $total_objetos                       = 0;
    $avance_general_malla                = 0;
    $acumulador_avance_por_curso         = 0;
    $total_cursos_aprobados              = 0;
    $total_cursos_reprobados             = 0;
    $total_cursos_pendientes             = 0;
    $total_cursos_proceso                = 0;
    //Con esta variable, voy acumulando la suma de las notas de los cursos
    $acumulador_notas_curso_por_programa = 0;
    //La siguiente varible, la ocupo para poder ir acumulando cuantos cursos voy a contar para sacar el promedio
    $total_cursos_para_promedio          = 0;
    foreach ($cursos as $cur) {
        $detalle_avance_curso = PorcentajeAvanceCurso($cur->id, $rut);
        //Ver si el curso est? aprobado
        if ($detalle_avance_curso[4] == 1) {
            $total_cursos_aprobados++;
            //Ver si el curso no est? aprobado
        } else if ($detalle_avance_curso[4] == 2) {
            $total_cursos_reprobados++;
            //Ver si el curso esta pendiente
        } else if ($detalle_avance_curso[4] == 3) {
            $total_cursos_pendientes++;
            //Ver si el curso est? en proceso
        } else if ($detalle_avance_curso[4] == 4) {
            $total_cursos_proceso++;
        }
        if ($detalle_avance_curso[3] >= "0") {
            $acumulador_notas_curso_por_programa = $acumulador_notas_curso_por_programa + $detalle_avance_curso[3];
            $total_cursos_para_promedio++;
        }
        $total_objetos_finalizados_por_curso = 0;
        $curso_fin                           = VErificaCursoFinalizado($cur->id, $rut);
        if ($curso_fin) {
            $total_cursos_fin++;
        }
        $objetos = ObjetosDadoCurso($cur->id, $rut);
        foreach ($objetos as $ob) {
            $total_objetos++;
            if ($ob->nota_objeto >= "0") {
                $total_notas++;
                $acum_notas = $acum_notas + $ob->nota_objeto;
            }
            if ($ob->fecha_finalizacion) {
                $total_objetos_finalizados++;
                $total_objetos_finalizados_por_curso++;
            }
        }
        //ACA debiese sacar el promedio de cada curso, e ir acumulando, para despues aplicar el porcentaje correspondiente
        $acumulador_avance_por_curso = $acumulador_avance_por_curso + (($total_objetos_finalizados_por_curso * 100) / count($objetos));
    }
    @$arreglo[0] = number_format($acum_notas / $total_notas, 0);
    @$arreglo[1] = number_format(($total_objetos_finalizados * 100) / $total_objetos, 0);
    //Porcentaje de Avance
    @$arreglo[2] = number_format($acumulador_avance_por_curso / count($cursos), 0);
    //Total de cursos por programa
    $arreglo[3] = count($cursos);
    //Total de cursos aprobados por programa
    $arreglo[4] = $total_cursos_aprobados;
    //Total de cursos reprobados por programa
    $arreglo[5] = $total_cursos_reprobados;
    //Total d cursos pendientes por programa
    $arreglo[6] = $total_cursos_pendientes;
    //Total de cursos en proceso
    $arreglo[7] = $total_cursos_proceso;
    //la suma de todos los promedios de los cursos
    $arreglo[8] = $acumulador_notas_curso_por_programa;
    //este contador es para que despues se pueda promediar las notas de los cursos
    $arreglo[9] = $total_cursos_para_promedio;
    return ($arreglo);
}
function ColocarSliderPorNoticia($PRINCIPAL, $id_empresa)
{
    //$todos=TraeSliders($id_empresa);
    //$todos=TraeSlidersOrderByDesc($id_empresa);
    //Traigo las noticias de la empresa, con el campo slider = 1
    $todos = TraeSlidersPorNoticias($id_empresa);
    $i     = 1;
    foreach ($todos as $uno) {
        $li .= file_get_contents("views/slider/row_li.html");
        $row .= file_get_contents("views/slider/row_sliders_noticias.html");
        //if($uno->slider_activo==1){
        if ($i == 1) {
            $row = str_replace("{ACTIVO}", "active", $row);
            $li  = str_replace("{CLASS_ACTIVO}", 'class="active"', $li);
        } else {
            $row = str_replace("{ACTIVO}", '', $row);
            $li  = str_replace("{CLASS_ACTIVO}", "", $li);
        }
        $i++;
        $row = str_replace("{IMAGEN_SLIDER}", $uno->imagen_slider, $row);
        $li  = str_replace("{NUMERO}", $uno->slider_activo - 1, $li);
        if ($uno->link_target_blank) {
            $row = str_replace("{TITULO}", "<a target='_blank'  href='" . $uno->link_target_blank . "'><span class='caption-title_href'>" . $uno->titulo . "</span></a>", $row);
        } else if ($uno->titulo && $uno->contenido) {
            $row = str_replace("{TITULO}", "<a  href='?sw=detnot&id=" . Encodear($uno->id) . "'><span class='caption-title_href'>" . $uno->titulo . "</span></a>", $row);
        } else {
            $row = str_replace("{TITULO}", $uno->titulo, $row);
        }
        $row = str_replace("{SUBTITULO}", $uno->bajada, $row);
    }
    $PRINCIPAL = str_replace("{SLIDERS_TODOS}", utf8_encode($row), $PRINCIPAL);
    $PRINCIPAL = str_replace("{LISTADO_LI}", $li, $PRINCIPAL);
    $PRINCIPAL = str_replace("{ENTORNO_SLIDER}", file_get_contents("views/slider/entorno.html"), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocarSlider($PRINCIPAL)
{
    $todos = TraeSliders($_SESSION["id_empresa"]);
    foreach ($todos as $uno) {
        $row .= file_get_contents("views/home/row_sliders.html");
        $row = str_replace("{ACTIVO}", $uno->activo, $row);
        $row = str_replace("{IMAGEN_SLIDER}", $uno->imagen, $row);
        $row = str_replace("{ALT_IMAGEN}", $uno->descripcion, $row);
        $row = str_replace("{TITULO}", $uno->titulo, $row);
        $row = str_replace("{SUBTITULO}", $uno->subtitulo, $row);
    }
    $PRINCIPAL = str_replace("{SLIDERS_TODOS}", utf8_encode($row), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocarSlider3($PRINCIPAL)
{
    $todos = TraeSliders($_SESSION["id_empresa"]);
    foreach ($todos as $uno) {
        $row .= file_get_contents("views/home/row_sliders3.html");
        $row = str_replace("{ACTIVO}", $uno->activo, $row);
        $row = str_replace("{IMAGEN_SLIDER}", $uno->imagen, $row);
        $row = str_replace("{ALT_IMAGEN}", $uno->descripcion, $row);
        $row = str_replace("{TITULO}", $uno->titulo, $row);
        $row = str_replace("{SUBTITULO}", $uno->subtitulo, $row);
    }
    $PRINCIPAL = str_replace("{SLIDERS_TODOS}", utf8_encode($row), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ColocarSlider2($PRINCIPAL)
{
    $todos = TraeSliders($_SESSION["id_empresa"]);
    foreach ($todos as $uno) {
        $row .= file_get_contents("views/home/row_sliders2.html");
        $row = str_replace("{ACTIVO}", $uno->activo, $row);
        $row = str_replace("{IMAGEN_SLIDER}", $uno->imagen, $row);
        $row = str_replace("{ALT_IMAGEN}", $uno->descripcion, $row);
        $row = str_replace("{TITULO}", $uno->titulo, $row);
        $row = str_replace("{SUBTITULO}", $uno->subtitulo, $row);
    }
    $PRINCIPAL = str_replace("{SLIDERS_TODOS}", utf8_encode($row), $PRINCIPAL);
    return ($PRINCIPAL);
}
function VerificaProgramaFinalizado($id_programa, $rut, $id_malla)
{
    //Primero verifico si el programa est? finalizado
    $programa_finalizado = VeProgramaFinalizado($id_programa, $rut);
    if ($programa_finalizado) {
    } else {
        //Traigo los niveles del programa, para verificar si est? finalizado o no, si es asi, inserto
        //el registro de programa finalizado
        $niveles          = NivelesDadoPrograma($id_programa);
        $nivel_finalizado = 0;
        if (count($niveles) > 0) {
            foreach ($niveles as $niv) {
                //Por cada uno verifico si est?n finalizados
                $verifica_nivel_finalizado = VerificaNivelFinalizadoDadoNivelPrograma($id_programa, $niv->id, $rut);
                if ($verifica_nivel_finalizado)
                    $nivel_finalizado++;
            }
            //Aca comparo, y si son iguales, inserto el registro de programa finalizado
            if ($nivel_finalizado == count($niveles)) {
                //Aca inserto el registro finalizado programa
                InsertaProgramaFinalizado($id_programa, $rut, $id_malla);
            }
        }
    }
}
function VerificaNivelFinalizado($id_nivel, $rut, $id_programa)
{
    $nivel_finalizado = VerificaNivelFinalizadoDadoNivelPrograma($id_programa, $id_nivel, $rut);
    if ($nivel_finalizado) {
    } else {
        //Traigo el total de cursos asociados a este nivel
        $total_cursos = CursosDadoNivel($id_nivel);
        foreach ($total_cursos as $curso_unico) {
            $curso_finalizado = VErificaCursoFinalizado($curso_unico->id, $rut);
            if ($curso_finalizado)
                $finalizado++;
        }
        if ($finalizado == count($total_cursos)) {
            //Inserto Finalizado
            InsertaNivelFinalizado($id_nivel, $rut, $id_programa);
        }
    }
}
function ArmaCronometro($id_curso, $id_evaluacion, $rut, $PRINCIPAL, $id_objeto, $id_inscripcion)
{

    $id_curso_encodeado=Encodear3($id_curso);
    $id_inscripcion_encodeado=Encodear3($id_inscripcion);
    $timestamp    = time();
    $datos_objeto = DatosObjeto($id_evaluacion);
    $id_objeto_encodeado=Encodear3($id_objeto);

    if ($datos_objeto[0]->currentorg) {
        $diff = strtotime($datos_objeto[0]->currentorg) - strtotime('TODAY'); //<-Time of countdown in seconds.  ie. 3600 = 1 hr. or 86400 = 1 day.
        //echo strtotime($datos_objeto[0]->currentorg) - strtotime('TODAY'); // 3600
    } else {
        $diff = 14400; //<-Time of countdown in seconds.  ie. 3600 = 1 hr. or 86400 = 1 day.
    }
    //MODIFICATION BELOW THIS LINE IS NOT REQUIRED.
    $hld_diff = $diff;
    if (isset($_SESSION['ts'])) {
        $slice = ($timestamp - $_SESSION['ts']);
        $diff  = $diff - $slice;
    }
    if (!isset($_SESSION['ts']) || $diff > $hld_diff || $diff < 0) {
        $diff           = $hld_diff;
        $_SESSION['ts'] = $timestamp;
    }
    //Below is demonstration of output.  Seconds could be passed to Javascript.
    $diff; //$diff holds seconds less than 3600 (1 hour);
    $hours   = floor($diff / 3600) . ' : ';
    $diff    = $diff % 3600;
    $minutes = floor($diff / 60) . ' : ';
    $diff    = $diff % 60;
    $seconds = $diff;
    //echo '<div id="timmer"></div>';
    //$PRINCIPAL = str_replace("{TIMMER}","<div id='strclock'></div><input type='text' readonly id='cronometro' name='cronometro'>",$PRINCIPAL);
?>
<?php
    $js_cronometro = '
<script type="text/javascript">
var hour = ' . floor($hours) . ';
var min = ' . floor($minutes) . ';
var sec = ' . floor($seconds) . ';

var id_curso ="'.$id_curso.'";
var id_inscripcion ="'.$id_inscripcion.'";
var id_objeto ="'.$id_objeto.'";

function doSubmit() {
//btn_submit is the name of the SUBMIT button in the form
document.f1.btn_submit.click();
}
function countdown() {
if(sec <= 0 && min > 0) {
sec = 59;
min -= 1;
}
else if(min <= 0 && sec <= 0) {
min = 0;
sec = 0;
}
else {
sec -= 1;
}
if(min <= 0 && hour > 0) {
min = 59;
hour -= 1;
}
var pat = /^[0-9]{1}$/;
sec = (pat.test(sec) == true) ? "0"+sec : sec;
min = (pat.test(min) == true) ? "0"+min : min;
hour = (pat.test(hour) == true) ? "0"+hour : hour;
document.getElementById("strclock").innerHTML = hour+":"+min+":"+sec;
document.getElementById("cronometro").value= hour+":"+min+":"+sec;
setTimeout("countdown()",1000);
//AUTO SUBMIT
if(min == 00 && sec ==00  ){
    alert("Tiempo agotado");
    location.href="?sw=detalle_cursoCap_exit";
}
}
countdown();
</script>
';
?>
<!------- JAVA SCRIPT--------->
<?php
    echo utf8_encode($PRINCIPAL);
    $_SESSION["objeto_exit"]=$id_objeto;
    $_SESSION["inscripcion_exit"]=$id_inscripcion;
    $_SESSION["curso_exit"]=$id_curso;


    echo $js_cronometro;
    //print_r($_SESSION);



}
Function VerificaFotoPersonal($rut)
{
    //Debo traer los datos del usuario, para ver si la foto esta con guion
    if ($_SESSION["id_empresa"] == 28) {
        $datos_usuario     = UsuarioEnBasePersonas($rut);
        $numero_sap        = $datos_usuario[0]->codigo_sap;
        $rut               = $numero_sap;
        $rut_completo      = $numero_sap;
        $ruta              = "img/personas/28/" . $rut;
        $ruta_rut_completo = "img/personas/28/" . $rut_completo;
    } else if ($_SESSION["id_empresa"] == 43) {
        $dv                = getRutDV($rut);
        $rut_completo      = $rut . "-" . $dv;
        $ruta              = "img/personas/" . $rut;
        $ruta_rut_completo = "img/personas/" . $rut_completo;
    } else if ($_SESSION["id_empresa"] == 41) {
        $datos_usuario     = UsuarioEnBasePersonas($rut);
        $rut_completo      = $datos_usuario[0]->rut_completo;
        $ruta              = "../Carpeta_Fotos/" . $rut;
        $ruta_rut_completo = "../Carpeta_Fotos/" . $rut_completo;
    } else {
        $datos_usuario     = UsuarioEnBasePersonas($rut);
        $rut_completo      = $datos_usuario[0]->rut_completo;
        $ruta              = "img/personas/" . $rut;
        $ruta_rut_completo = "img/personas/" . $rut_completo;
    }
    if ($datos_usuario[0]->avatar) {
        if ($_SESSION["id_empresa"] == 59) {
            $imagen = $datos_usuario[0]->avatar;
        } else if (substr($datos_usuario[0]->avatar, 0, 4) == "http") {
            $imagen = $datos_usuario[0]->avatar;
            //echo "<br> imagen $imagen";
            if (checkRemoteFile($imagen) == 1) {
                $imagen = $imagen;
                //echo "<br> file exist $imagen";
            } else {
                $imagen = "img/sinfoto.png";
            }
            //echo "<br> imagen $imagen";
        } else {
            $imagen = "img/avatars/" . $_SESSION["id_empresa"] . "/" . $datos_usuario[0]->avatar;
        }
    }
    if ($datos_usuario[0]->avatar) {
        if ($_SESSION["id_empresa"] == 59) {
            $imagen = $datos_usuario[0]->avatar;
        } else if (substr($datos_usuario[0]->avatar, 0, 4) == "http") {
            $imagen = $datos_usuario[0]->avatar;
            //echo "<br> imagen $imagen";
            if (checkRemoteFile($imagen) == 1) {
                $imagen = $imagen;
                //echo "<br> file exist $imagen";
            } else {
                $imagen = "img/sinfoto.png";
            }
        } else {
            $imagen = "img/avatars/" . $_SESSION["id_empresa"] . "/" . $datos_usuario[0]->avatar;
        }
        //echo "<br> imagen $imagen";
    } else {
        if (file_exists($ruta . ".jpg")) {
            $imagen = $ruta . ".jpg";
        } else if (file_exists($ruta . ".JPG")) {
            $imagen = $ruta . ".JPG";
        } else if (file_exists($ruta . ".gif")) {
            $imagen = $ruta . ".gif";
        } else if (file_exists($ruta_rut_completo . ".jpg")) {
            $imagen = $ruta_rut_completo . ".jpg";
        } else if (file_exists($ruta_rut_completo . ".JPG")) {
            $imagen = $ruta_rut_completo . ".JPG";
        } else if (file_exists($ruta_rut_completo . ".gif")) {
            $imagen = $ruta_rut_completo . ".gif";
        } else {
            $imagen = "img/sinfoto.png";
        }
    }
    // avatar biografia
    //echo "<br><br>imagen $imagen rut $rut<br><br>";
    if ($imagen == "img/sinfoto.png" or $imagen == "img/personas/.jpg") {
        //echo "..avatar biografia rut $rut";
        $biografia = TraeDatosBiografiayUsuario($rut, $_SESSION["id_empresa"]);
        //print_r($biografia);



       if ($biografia[0]->miavatar <> '') {

                $imagen_def1 = "multimedia/" . ($biografia[0]->miavatar);
                    if (file_exists($imagen_def1)) {

                    $imagen=$imagen_def1;
                    //echo "<br>$rut El fichero $imagen_def1 existe. Avatar";
                }

                if($imagen==''){

                    $imagen_def2 = "multimedia/" . Encodear3($datos_usuario[0]->rut_completo) . ".jpg";
                        if (file_exists($imagen_def2)) {
                        $imagen=$imagen_def2;

                        //echo "<br>$rut El fichero $imagen_def2 existe. Default";
                    }
                }


        } else {
                    //echo "hola";


                    $imagen_def2 = "multimedia/" . Encodear3($datos_usuario[0]->rut_completo) . ".jpg";
                    //echo "imagen_def2 $imagen_def2";
                    if (file_exists($imagen_def2)) {
                    $imagen=$imagen_def2;

                    //echo "<br>$rut No Hay Avatar El fichero $imagen_def2 existe. Default";
                }

        }
        //echo "<br><br>imagen $imagen<br><br>";
    }
    //ultimo revision
    //echo $datos_usuario[0]->avatar;44
    //echo $datos_usuario[0]->avatar;
    //echo "<br>imagen $imagen";exit();
    return ($imagen);
}
function checkRemoteFile($url)
{
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    // don't download content
    curl_setopt($ch, CURLOPT_NOBODY, 1);
    curl_setopt($ch, CURLOPT_FAILONERROR, 1);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    if (curl_exec($ch) !== FALSE) {
        $valor = 1;
    } else {
        $valor = 0;
    }
    //echo $valor; exit();
    return $valor;
}
function ObtenerBrecha($valor, $requerido)
{
    if ($valor >= $requerido) {
        $arreglo[0] = "fa fa-circle text-success fs14 mr10";
        $arreglo[1] = "etiquetaAcreditacion etiquetaAcreditacion-acreditada";
        $arreglo[2] = "Acreditada";
        $arreglo[3] = "si";
    } else if ($valor < $requerido) {
        $arreglo[0] = "fa fa-circle text-warning fs14 mr10";
        $arreglo[1] = "etiquetaAcreditacion etiquetaAcreditacion-proceso";
        $arreglo[2] = "Brecha Media";
        $arreglo[3] = "no";
    }
    //ROJO
    //etiquetaAcreditacion etiquetaAcreditacion-noacreditada
    //fa fa-circle text-danger fs14 mr10
    return ($arreglo);
}
function CategoriaColoresResultadosEvalConductas($valor)
{
    if ($valor == 1) {
        $arreglo[0] = "etiqueta etiqueta-nivel0";
        $arreglo[1] = "Nulo";
    } else if ($valor == 2) {
        $arreglo[0] = "etiqueta etiqueta-nivel1";
        $arreglo[1] = "Inicial";
    } else if ($valor == 3) {
        $arreglo[0] = "etiqueta etiqueta-nivel2";
        $arreglo[1] = "Medio";
    } else if ($valor == 4) {
        $arreglo[0] = "etiqueta etiqueta-nivel3";
        $arreglo[1] = "Alto";
    }
    return ($arreglo);
}
function MuestraResultadosEvaluacionConducta($PRINCIPAL, $evaluador, $evaluado)
{
    $datos_evaluado     = UsuarioEnBasePersonas($evaluado);
    $cargo              = utf8_encode($datos_evaluado[0]->cargo);
    $PRINCIPAL          = str_replace("{NOMBRE}", $datos_evaluado[0]->nombre_completo, $PRINCIPAL);
    $PRINCIPAL          = str_replace("{GERENCIA}", $datos_evaluado[0]->gerencia, $PRINCIPAL);
    $PRINCIPAL          = str_replace("{CARGO}", $cargo, $PRINCIPAL);
    $PRINCIPAL          = str_replace("{FOTO_COLABORADOR}", VerificaFotoPersonal($datos_evaluado[0]->rut), $PRINCIPAL);
    $objetivos          = ListadoObjetivosDnc2($evaluador, $cargo);
    $requerido          = 3;
    $cantidad_conductas = 0;
    $certificadas       = 0;
    foreach ($objetivos as $obj) {
        $respuesta = TieneRegistroRespuestaEvConduccta($evaluado, $evaluador, $obj->id);
        if ($obj->conducta1) {
            $cantidad_conductas++;
            $row .= file_get_contents("views/dnc/row_dnc6.html");
            $row              = str_replace("{NOMBRE_CONDUCTA}", $obj->conducta1, $row);
            $rangos           = CategoriaColoresResultadosEvalConductas($respuesta[0]->nota_c1);
            $row              = str_replace("{CLASS_NIVEL}", $rangos[0], $row);
            $row              = str_replace("{NIVEL}", $rangos[1], $row);
            $rangos_requerido = CategoriaColoresResultadosEvalConductas($requerido);
            $row              = str_replace("{CLASS_NIVEL_REQUERIDO}", $rangos_requerido[0], $row);
            $row              = str_replace("{NIVEL_REQUERIDO}", $rangos_requerido[1], $row);
            //Brecha
            $brecha           = ObtenerBrecha($respuesta[0]->nota_c1, $requerido);
            $row              = str_replace("{BRECHA_ICONO}", $brecha[0], $row);
            $row              = str_replace("{BRECHA_COLOR}", $brecha[1], $row);
            $row              = str_replace("{BRECHA}", $brecha[2], $row);
            if ($brecha[3] == "si")
                $certificadas++;
        }
        if ($obj->conducta2) {
            $cantidad_conductas++;
            $row .= file_get_contents("views/dnc/row_dnc6.html");
            $row              = str_replace("{NOMBRE_CONDUCTA}", $obj->conducta2, $row);
            $rangos           = CategoriaColoresResultadosEvalConductas($respuesta[0]->nota_c2);
            $row              = str_replace("{CLASS_NIVEL}", $rangos[0], $row);
            $row              = str_replace("{NIVEL}", $rangos[1], $row);
            $rangos_requerido = CategoriaColoresResultadosEvalConductas($requerido);
            $row              = str_replace("{CLASS_NIVEL_REQUERIDO}", $rangos_requerido[0], $row);
            $row              = str_replace("{NIVEL_REQUERIDO}", $rangos_requerido[1], $row);
            //Brecha
            $brecha           = ObtenerBrecha($respuesta[0]->nota_c2, $requerido);
            $row              = str_replace("{BRECHA_ICONO}", $brecha[0], $row);
            $row              = str_replace("{BRECHA_COLOR}", $brecha[1], $row);
            $row              = str_replace("{BRECHA}", $brecha[2], $row);
            if ($brecha[3] == "si")
                $certificadas++;
        }
        if ($obj->conducta3) {
            $cantidad_conductas++;
            $row .= file_get_contents("views/dnc/row_dnc6.html");
            $row              = str_replace("{NOMBRE_CONDUCTA}", $obj->conducta3, $row);
            $rangos           = CategoriaColoresResultadosEvalConductas($respuesta[0]->nota_c3);
            $row              = str_replace("{CLASS_NIVEL}", $rangos[0], $row);
            $row              = str_replace("{NIVEL}", $rangos[1], $row);
            $rangos_requerido = CategoriaColoresResultadosEvalConductas($requerido);
            $row              = str_replace("{CLASS_NIVEL_REQUERIDO}", $rangos_requerido[0], $row);
            $row              = str_replace("{NIVEL_REQUERIDO}", $rangos_requerido[1], $row);
            //Brecha
            $brecha           = ObtenerBrecha($respuesta[0]->nota_c3, $requerido);
            $row              = str_replace("{BRECHA_ICONO}", $brecha[0], $row);
            $row              = str_replace("{BRECHA_COLOR}", $brecha[1], $row);
            $row              = str_replace("{BRECHA}", $brecha[2], $row);
            if ($brecha[3] == "si")
                $certificadas++;
        }
    }
    $PRINCIPAL = str_replace("{LISTADO_CONDUCTAS_EVALUADAS}", utf8_encode($row), $PRINCIPAL);
    $PRINCIPAL = str_replace("{CANTIDAD_CONDUCTAS}", $cantidad_conductas, $PRINCIPAL);
    $PRINCIPAL = str_replace("{CANTIDAD_ACREDITADAS}", $certificadas, $PRINCIPAL);
    return ($PRINCIPAL);
}
function SelectNiveleDebilidadEvalConducta($seleccionado)
{
    $alternativas = TraeDebilidadAlternativaEvConducta();
    $opciones     = "";
    foreach ($alternativas as $alt) {
        if ($alt->valor == $seleccionado) {
            $opciones .= "<option selected value='" . $alt->valor . "'>" . $alt->valor . "</option>";
        } else {
            $opciones .= "<option value='" . $alt->valor . "'>" . $alt->valor . "</option>";
        }
    }
    return ($opciones);
}
function SelectNiveleEvalConducta($seleccionado)
{
    $alternativas = TraeNivelesAlternativaEvConducta();
    $opciones     = "";
    foreach ($alternativas as $alt) {
        if ($alt->puntaje == $seleccionado) {
            $opciones .= "<option selected value='" . $alt->puntaje . "'>" . $alt->valor . "</option>";
        } else {
            $opciones .= "<option value='" . $alt->puntaje . "'>" . $alt->valor . "</option>";
        }
    }
    return ($opciones);
}
function ListadoConductasEvaluado($PRINCIPAL, $jefe, $evaluado)
{
    $datos_evaluado = UsuarioEnBasePersonas($evaluado);
    $cargo          = utf8_encode($datos_evaluado[0]->cargo);
    $PRINCIPAL      = str_replace("{NOMBRE}", $datos_evaluado[0]->nombre_completo, $PRINCIPAL);
    $PRINCIPAL      = str_replace("{FOTO_COLABORADOR}", VerificaFotoPersonal($datos_evaluado[0]->rut), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{GERENCIA}", $datos_evaluado[0]->gerencia, $PRINCIPAL);
    $PRINCIPAL      = str_replace("{CARGO}", $cargo, $PRINCIPAL);
    //Dado el cargo, traigo los objetivos de ests.
    //$objetivos=ListadoObjetivosDncDadoCargo($cargo);
    $objetivos      = ListadoObjetivosDnc2($jefe, $cargo);
    foreach ($objetivos as $obj) {
        if ($obj->conducta1) {
            $row .= file_get_contents("views/dnc/row_dnc5.html");
            $tiene_registro = TieneRegistroRespuestaEvConduccta($evaluado, $jefe, $obj->id);
            $row            = str_replace("{OPCIONES_NIVEL_EVALUACION}", SelectNiveleEvalConducta($tiene_registro[0]->nota_c1), $row);
            $row            = str_replace("{OPCIONES_DEBILIDAD_ALTERNATIVA}", SelectNiveleDebilidadEvalConducta($tiene_registro[0]->debilidad_c1), $row);
            $row            = str_replace("{NOMBRE_CONDUCTA}", $obj->conducta1, $row);
            $row            = str_replace("{NUMERO_CONDUCTA}", "1", $row);
        }
        if ($obj->conducta2) {
            $row .= file_get_contents("views/dnc/row_dnc5.html");
            $row = str_replace("{OPCIONES_NIVEL_EVALUACION}", SelectNiveleEvalConducta($tiene_registro[0]->nota_c2), $row);
            $row = str_replace("{OPCIONES_DEBILIDAD_ALTERNATIVA}", SelectNiveleDebilidadEvalConducta($tiene_registro[0]->debilidad_c2), $row);
            $row = str_replace("{NOMBRE_CONDUCTA}", $obj->conducta2, $row);
            $row = str_replace("{NUMERO_CONDUCTA}", "2", $row);
            $row = str_replace("SELECT_" . $obj->id . "_2_" . $tiene_registro[0]->nota_c2 . "", "selected", $row);
        }
        if ($obj->conducta3) {
            $row .= file_get_contents("views/dnc/row_dnc5.html");
            $row = str_replace("{OPCIONES_NIVEL_EVALUACION}", SelectNiveleEvalConducta($tiene_registro[0]->nota_c3), $row);
            $row = str_replace("{OPCIONES_DEBILIDAD_ALTERNATIVA}", SelectNiveleDebilidadEvalConducta($tiene_registro[0]->debilidad_c3), $row);
            $row = str_replace("{NOMBRE_CONDUCTA}", $obj->conducta3, $row);
            $row = str_replace("{NUMERO_CONDUCTA}", "3", $row);
            $row = str_replace("SELECT_" . $obj->id . "_3_" . $tiene_registro[0]->nota_c3 . "", "selected", $row);
        }
        $row = str_replace("{ID_OBJETIVO}", $obj->id, $row);
    }
    $PRINCIPAL = str_replace("{EVALUADO_ENCODEADO}", Encodear3($evaluado), $PRINCIPAL);
    $PRINCIPAL = str_replace("{EVALUADOR_ENCODEADO}", Encodear3($jefe), $PRINCIPAL);
    $PRINCIPAL = str_replace("{CARGO_ENCODEADO}", Encodear3($cargo), $PRINCIPAL);
    $PRINCIPAL = str_replace("{LISTADO_CONDUCTAS}", utf8_encode($row), $PRINCIPAL);
    return ($PRINCIPAL);
}
function VerificaEvaluacionFinalizadaConducta($evaluado, $evaluador)
{
    $fin = EvaluacionFinConducta($evaluado, $evaluador);
    if ($fin) {
        $arreglo[0] = "fa fa-circle text-success fs14 mr10";
        $arreglo[1] = "Terminado";
        $arreglo[2] = file_get_contents("views/dnc/dnc4_boton_edita.html");
        $arreglo[3] = "si";
    } else {
        $arreglo[0] = "fa fa-circle text-danger fs14 mr10";
        $arreglo[1] = "Pendiente";
        $arreglo[2] = file_get_contents("views/dnc/dnc4_boton_ingresa.html");
        $arreglo[3] = "no";
    }
    return ($arreglo);
}
function ListadoColaboradoresPorJefe($PRINCIPAL, $jefe)
{
    $listado_colaboradores = EsJefe($jefe);
    $total_finalizados     = 0;
    foreach ($listado_colaboradores as $col) {
        $row .= file_get_contents("views/dnc/row_dnc4.html");
        $row    = str_replace("{NOMBRE}", $col->nombre_completo, $row);
        $row    = str_replace("{GERENCIA}", $col->gerencia, $row);
        $row    = str_replace("{CARGO}", $col->cargo, $row);
        $row    = str_replace("{FOTO_COLABORADOR}", VerificaFotoPersonal($col->rut), $row);
        $estado = VerificaEvaluacionFinalizadaConducta($col->rut, $jefe);
        if ($estado[3] == "si") {
            $total_finalizados++;
            $row = str_replace("{ETIQUETA_NOTA}", "Medio", $row);
            $row = str_replace("{CLASE_ETIQUETA_NOTA}", "etiqueta etiqueta-nivel2", $row);
        } else {
            $row = str_replace("{ETIQUETA_NOTA}", "", $row);
            $row = str_replace("{CLASE_ETIQUETA_NOTA}", "", $row);
        }
        $row = str_replace("{ICONO}", $estado[0], $row);
        $row = str_replace("{ESTADO}", $estado[1], $row);
        $row = str_replace("{OPCIONES}", $estado[2], $row);
        $row = str_replace("{EVALUADO_ENCODEADO}", Encodear3($col->rut), $row);
    }
    //Porcentaje_final=($total_finalizados*100)/count($listado_colaboradores);
    $PRINCIPAL = str_replace("{PORCENTAJE_AVANCE}", number_format(($total_finalizados * 100) / count($listado_colaboradores), 0), $PRINCIPAL);
    $PRINCIPAL = str_replace("{LISTADO_COLABORADORES}", utf8_encode($row), $PRINCIPAL);
    $PRINCIPAL = str_replace("{CANTIDAD_COLABORADORES}", count($listado_colaboradores), $PRINCIPAL);
    return ($PRINCIPAL);
}
function detect()
{
    $browser         = array(
        "IE",
        "OPERA",
        "MOZILLA",
        "NETSCAPE",
        "FIREFOX",
        "SAFARI",
        "CHROME"
    );
    $os              = array(
        "WIN",
        "MAC",
        "LINUX"
    );
    # definimos unos valores por defecto para el navegador y el sistema operativo
    $info['browser'] = "OTHER";
    $info['os']      = "OTHER";
    # buscamos el navegador con su sistema operativo
    foreach ($browser as $parent) {
        $s       = strpos(strtoupper($_SERVER['HTTP_USER_AGENT']), $parent);
        $f       = $s + strlen($parent);
        $version = substr($_SERVER['HTTP_USER_AGENT'], $f, 15);
        $version = preg_replace('/[^0-9,.]/', '', $version);
        if ($s) {
            $info['browser'] = $parent;
            $info['version'] = $version;
        }
    }
    # obtenemos el sistema operativo
    foreach ($os as $val) {
        if (strpos(strtoupper($_SERVER['HTTP_USER_AGENT']), $val) !== false)
            $info['os'] = $val;
    }
    # devolvemos el array de valores
    return $info;
}
function ValidarSesion($ambiente, $id_empresas, $url_front)
{
    //echo "ValidarSesion<br> ";
    //print_r($_SESSION);
    //sleep(5);
    if ($_SESSION["user_"]) {
        //Tiene session
        //Veo si el usuario esta en la base
        $existe_usuario_en_la_base = $datos_usuario = UsuarioEnBasePersonas($_SESSION["user_"]);

             if (!$existe_usuario_en_la_base) {
                $PRINCIPAL        = FuncionesTransversales(file_get_contents("" . $url_front . "/front/views/home/login.html"));
                $token_fecha_hora = Encodear3(date("Y-m-d") . " " . date("H:i:s"));
                $PRINCIPAL        = str_replace("{TOKEN_FECHA_HORA}", $token_fecha_hora, $PRINCIPAL);
                session_start();
                $_SESSION["token"] = $token_fecha_hora;
                echo $PRINCIPAL;
                exit;
            } else {
                if ($existe_usuario_en_la_base[0]->vigencia == "1") {
                    $PRINCIPAL        = FuncionesTransversales(file_get_contents("" . $url_front . "/front/views/home/login.html"));
                    $token_fecha_hora = Encodear3(date("Y-m-d") . " " . date("H:i:s"));
                    $PRINCIPAL        = str_replace("{TOKEN_FECHA_HORA}", $token_fecha_hora, $PRINCIPAL);
                    session_start();
                    $_SESSION["token"] = $token_fecha_hora;
                    echo $PRINCIPAL;
                    exit;
                }
            }



        if ($ambiente == "detnot") {
            InsertaLogSistema($_SESSION["user_"], $ambiente, $id_empresas, Decodear($_GET["id"]), "", "", "", "");
        } else if ($ambiente == "GuardaLogVideoVisto") {
            InsertaLogSistema($_SESSION["user_"], $ambiente . "_" . $_POST["tipo_video"], $id_empresas, "", "", "", "", "");
        } else if ($ambiente == "veperfil") {
            $rut = $_POST["buscarRut"];
            if (!$rut) {
                $rut = Decodear3($_GET["r"]);
            }
            InsertaLogSistema($_SESSION["user_"], $ambiente, $id_empresas, $rut, "", "", "", "");
        } else if ($ambiente == "biblioteca") {
            InsertaLogSistema($_SESSION["user_"], $ambiente, $id_empresas, $_GET["id"], $_GET["p"], "", "", "");
        } else if ($ambiente == "detalle_cursoCap") {
            InsertaLogSistema($_SESSION["user_"], $ambiente, $id_empresas, Decodear3($_GET["idc"]), "", "", "", "");
        } else if ($ambiente == "contenido") {
            InsertaLogSistema($_SESSION["user_"], $ambiente, $id_empresas, Decodear3($_GET["i"]), "", "", "", "");
        } else if ($ambiente == "web") {
            //InsertaLogSistema($_SESSION["user_"], $ambiente, $id_empresas, "", "", $_GET["i"], $_GET["i"], $_GET["niv"]);
            InsertaLogSistema($_SESSION["user_"], $ambiente, $id_empresas, $_GET["id"], $_GET["p"], "", ($_GET["niv"]), Decodear3($_GET["i"]));
        } else {
            InsertaLogSistema($_SESSION["user_"], $ambiente, $id_empresas, "", "", "", "", "");
        }
    } else {
        if ($ambiente <> "CreateNewUser" && $ambiente <> "LogEmail" && $ambiente <> "entrada_inscripcion" && $ambiente <> "entrada_inscripcion_anonima"  && $ambiente <> "entrada" && $ambiente <> "entradacl" && $ambiente <> "entradaclg" && $ambiente <> "entradaLdap" && $ambiente <> "registerac" && $ambiente <> 'chpex' && $ambiente <> 'listMejIVPH' && $ambiente <> "homeEncuesta" && $ambiente <> "help" && $ambiente <> "autoLoginRel" && $ambiente <> "SF" && $ambiente <> "go_save_data_ext" && $ambiente <> "RegistraRelator" 
        
        && $ambiente <> "checkUser" 
        && $ambiente <> "logext" 
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        && $ambiente <> "checkUserLosAndes" && $ambiente <> "checkUserTaylor" && $ambiente <> "checkUserExt" && $ambiente <> "checkUserExterno" && $ambiente <> "checkUserBci" && $ambiente <> "CheckValRec" && $ambiente <> "regis" && $ambiente <> "oco" && $ambiente <> "entradac" && $ambiente <> "sendSolicitud" && $ambiente <> "sendClave" && $ambiente <> "iex") {
            if ($ambiente == "logwatts") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "loguss") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_uss.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logwattsv2") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_wattsv2.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logen") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_en.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logind") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_indumotora.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logtnt") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_tnt.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logtaylor") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/22_login_taylor.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logips") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_ips.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logutem") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_utem.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logsky") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_sky.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logpotbci") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_latam.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logbci") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_bci.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logtannerext") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_tanner_ext.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logbci_vota") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_bci_vota.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logbci_ci") {
                //$texto2="logbci_ci";
                //$texto=Encodear3($texto2);
                //echo "$texto2";
                //echo "<br>";
                //echo "$texto";
                //exit();
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_bci_checkin.html"));
                echo $PRINCIPAL;
                exit;
            }


            else if ($ambiente == "login_ext") {
                //unset($_SESSION);
                //session_start(); $_SESSION = array(); if (isset($_COOKIE[session_name()])) {    setcookie(session_name(), '', time()-42000, '/'); } session_destroy();
                //$ambiente=($_GET["ambiente"]);
                //$im=($_GET["im"]);
                //exit();
                //$PRINCIPAL=FuncionesTransversales(file_get_contents("views/home/login_ext.html"));
                //echo $PRINCIPAL;
                unset($_SESSION);
                session_start();
                $_SESSION = array();
                if (isset($_COOKIE[session_name()])) {
                    setcookie(session_name(), '', time() - 42000, '/');
                }
                session_destroy();
                $ambiente  = ($_GET["ambiente"]);
                $im        = ($_GET["im"]);
                $id_mp     = ($_GET["id_mp"]);
                                $sess     = ($_GET["sess"]);

                $PRINCIPAL = FuncionesTransversales(file_get_contents("" . $url_front . "/front/views/home/login_ext.html"));
                $PRINCIPAL = str_replace("{AMBIENTE}", $ambiente, $PRINCIPAL);
                $PRINCIPAL = str_replace("{IM}", $im, $PRINCIPAL);
                $PRINCIPAL = str_replace("{ID_MP}", $id_mp, $PRINCIPAL);
                                $PRINCIPAL = str_replace("{SESS}", $sess, $PRINCIPAL);

                echo $PRINCIPAL;
            }


            else if ($ambiente == "login_externo") {
                //unset($_SESSION);
                //session_start(); $_SESSION = array(); if (isset($_COOKIE[session_name()])) {    setcookie(session_name(), '', time()-42000, '/'); } session_destroy();
                //$ambiente=($_GET["ambiente"]);
                //$im=($_GET["im"]);
                //exit();
                //$PRINCIPAL=FuncionesTransversales(file_get_contents("views/home/login_ext.html"));
                //echo $PRINCIPAL;
                unset($_SESSION);
                session_start();
                $_SESSION = array();
                if (isset($_COOKIE[session_name()])) {
                    setcookie(session_name(), '', time() - 42000, '/');
                }
                session_destroy();
    $ambiente=($_GET["ambiente"]);
    $im=($_GET["im"]);
    $id_mp=($_GET["id_mp"]);
    $amb=($_GET["amb"]);
    $idcat=($_GET["idcat"]);
    $idc=($_GET["idc"]);
    $site=($_GET["site"]);
    $linkext=($_GET["linkext"]);

                $PRINCIPAL = FuncionesTransversales(file_get_contents("" . $url_front . "/front/views/home/login_externo.html"));
    $PRINCIPAL = str_replace("{AMBIENTE}", $ambiente, $PRINCIPAL);
    $PRINCIPAL = str_replace("{IM}", $im, $PRINCIPAL);
    $PRINCIPAL = str_replace("{ID_MP}", $id_mp, $PRINCIPAL);
    $PRINCIPAL = str_replace("{AMB}", $amb, $PRINCIPAL);
    $PRINCIPAL = str_replace("{IDCAT}", $idcat, $PRINCIPAL);
    $PRINCIPAL = str_replace("{IDC}", $idc, $PRINCIPAL);
    $PRINCIPAL = str_replace("{SITE}", $site, $PRINCIPAL);
    $PRINCIPAL = str_replace("{LINKEXT}", $linkext, $PRINCIPAL);
    $PRINCIPAL = str_replace("{SESS}", $sess, $PRINCIPAL);

                echo utf8_encode($PRINCIPAL);
            }

             else if ($ambiente == "logbci_gp") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/67_login.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logbci_norm") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/69_login.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logbci_reci") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/70_login.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logbci_escuela") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/70_login_escuela.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logbci_lid") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/71_login.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logbchile") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/72_login.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logbci_edfin") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/72_login_bci_edfin.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logbci_cir") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_bci_checkin_relator.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logbci_ffvv") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/62_login_ffvv.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "enviar_password") {
                $alert = "";
                //print_r($_POST);
                if ($_POST["email"] <> '') {
                    $arreglo = buscar_email_clave($_POST["email"]);
                    //VERIRFICA SI EMAIL EXISTE... Y BUSCO CLAVE
                    //print_r($arreglo); sleep(5);


                    $id_empresa=$arreglo[0]->id_empresa;

                    //print_r($arreglo); sleep(5);
                    if ($arreglo[0]->rut <> '' and $arreglo[0]->email <> '' and $arreglo[0]->clave <> '' and $arreglo[0]->id_empresa<>'') {


    $datosusuario            =mp_buscaDATOSPERSONAS($arreglo[0]->rut, $arreglo[0]->id_empresa);


                    if($arreglo[0]->id_empresa=='78'){

        $url_front="https://www.masconectadosbch.cl";
        $url_base="https://www.masconectadosbch.cl";
        $from="notificaciones@masconectadosbch.cl";
        $nombrefrom="M?s Conectados BCH";
        $tipo="text/html";
        $titulo1="";
        $url=$url_base;
        $texto_url="Ir a M?s Conectados BCH";
        $logo="https://masconectadosbch.cl/front/img/bch_logo_conectados_trans.jpg";
        $texto4="masconectadosbch.cl";

$titulo1="Tu clave";
$subject=" Tu clave";
$subtitulo1=utf8_encode($datosusuario[0]->nombre_completo).", tu clave para ingresar es<br><br> ".utf8_encode($arreglo[0]->clave)."";

$texto1="";

$texto2="";

$texto3="";
$texto4="<strong>Departamento Entrenamiento y Formaci?n<br>Divisi?n Personas y Organizaci?n<br>Banco de Chile</strong>";

$tipomensaje="Email_ValidacionPostulacion_usuario";
$rut=$datosusuario[0]->rut;
$key=$datosusuario[0]->rut;
$to=$datosusuario[0]->email;

//echo "jefe to $to";

//$to="rod@gop.cl";
$url=$url_base;


$nombreto=utf8_encode($datosusuario[0]->nombre_completo);
SendGrid_Email($to, $nombreto, $from, $nombrefrom, $tipo, $subject, $titulo1,$subtitulo1,$texto1,$url,$texto_url, $texto2, $texto3, $texto4, $logo, $id_empresa, $url, $tipomensaje, $rut, $key, "");


}
if($arreglo[0]->id_empresa=='62'){

        $url_front="https://www.mimundo.cl";
        $url_base="https://www.mimundo.cl";
        $from="notificaciones@mimundo.cl";
        $nombrefrom="Mi Mundo Tanner";
        $tipo="text/html";
        $titulo1="";
        $url=$url_base;
        $texto_url="Ir a Mi Mundo Tanner";
        $logo="https://www.mimundo.cl/front/img/tan_mundo_logo.png";
        $texto4="Mi Mundo Tanner";

$titulo1="Tu clave para Mi Mundo Tanner";
$subject=" Tu clave para Mi Mundo Tanner";
$subtitulo1=utf8_encode($datosusuario[0]->nombre_completo).", tu clave para ingresar a Mi Mundo Tanner es:<br><br> ".utf8_encode($arreglo[0]->clave)."";
$texto1="";
$texto2="";
$texto3="";
$texto4="<strong>Mi Mundo Tanner</strong>";
$tipomensaje="Email_ValidacionPostulacion_usuario";
$rut=$datosusuario[0]->rut;
$key=$datosusuario[0]->rut;
$to=$datosusuario[0]->email;
$url=$url_base;
$nombreto=utf8_encode($datosusuario[0]->nombre_completo);
SendGrid_Email($to, $nombreto, $from, $nombrefrom, $tipo, $subject, $titulo1,$subtitulo1,$texto1,$url,$texto_url, $texto2, $texto3, $texto4, $logo, $id_empresa, $url, $tipomensaje, $rut, $key, "");



}

if($arreglo[0]->id_empresa=='61'){

        $url_front="https://www.personasrf.cl";
        $url_base="https://www.personasrf.cl";
        $from="notificaciones@personasrf.cl";
        $nombrefrom="PersonasRF";
        $tipo="text/html";
        $titulo1="";
        $url=$url_base;
        $texto_url="Ir a PersonasRF";
        $logo="https://www.personasrf.cl/front/img/logo_empresa/rf_logoretail-Financiero-Scotiabank-Cencosud_transparent.png";
        $texto4="PersonasRF";

$titulo1="Tu clave para PersonasRF";
$subject=" Tu clave para PersonasRF";
$subtitulo1=utf8_encode($datosusuario[0]->nombre_completo).", tu clave para ingresar a PersonasRF es ".utf8_encode($arreglo[0]->clave)."";
$texto1="";
$texto2="";
$texto3="";
$texto4="<strong>PersonasRF</strong>";
$tipomensaje="Email_OlvidoClave";
$rut=$datosusuario[0]->rut;
$key=$datosusuario[0]->rut;
$to=$datosusuario[0]->email;

$url=$url_base;
$template="template_notificacion_general";

$nombreto=utf8_encode($datosusuario[0]->nombre_completo);
SendGrid_Email($to, $nombreto, $from, $nombrefrom, $tipo, $subject, $titulo1,$subtitulo1,$texto1,$url,$texto_url, $texto2, $texto3, $texto4, $logo, $id_empresa, $url, $tipomensaje, $rut, $key, $template);



}

                    echo '<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css">
                <br><br><br><div class="alert alert-success" role="alert">
             <center> Clave fue enviada exitosamente a tu Correo Corporativo.</center>
            </div>';



                        sleep(2);
                        echo "<script>location.href='../';</script>";



                    }

                    elseif ($arreglo[0]->rut <> '' and $arreglo[0]->email <> '' and $arreglo[0]->clave == '') {
                        $alert = "<div class='alert alert-danger' role='alert'>No tienes clave creada</div>";
                        sleep(5);
                        echo "<script>location.href='?sw=login';</script>";
                    } else {
                        $alert = "<div class='alert alert-danger' role='alert'>Credenciales Incorrectas</div>";
                        sleep(5);
                        echo "<script>location.href='?sw=login';</script>";
                    }
                }
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/gen_envia_password.html"));
                $PRINCIPAL = str_replace("{ALERTA}", $alert, $PRINCIPAL);
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logbci_com_mp") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_bci_com_mp.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logbci_capacitacion") {
                $PRINCIPAL        = FuncionesTransversales(file_get_contents("views/home/login_bci_capacitacion.html"));
                $token_fecha_hora = Encodear3(date("Y-m-d") . " " . date("H:i:s"));
                $PRINCIPAL        = str_replace("{TOKEN_FECHA_HORA}", $token_fecha_hora, $PRINCIPAL);
                session_start();
                $_SESSION["token"] = $token_fecha_hora;
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logbci_capacitacion_id") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_bci_capacitacion_id.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logbci_product") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_bci_productivizate.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logbci_mp") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_bci_mp.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logtabancura") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_tabancura.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logsantafe") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_santafe.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logminvest") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_minvest.html"));
                echo $PRINCIPAL;
                exit;
            }


            else if ($ambiente == "logminvestt") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_minvest_tecnico.html"));
                echo $PRINCIPAL;
                exit;
            }


            else if ($ambiente == "logminvestc") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_minvest_comercial.html"));
                echo $PRINCIPAL;
                exit;
            }



            else if ($ambiente == "loglp") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_lp.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logbci_viaje") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_bci_viaje.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logbci_revG") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_bci_revG.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "log_los_andes_gracias") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_los_andes_gracias.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "log_los_andes_google_G") {
                unset($_SESSION);
                session_start();
                $_SESSION = array();
                if (isset($_COOKIE[session_name()])) {
                    setcookie(session_name(), '', time() - 42000, '/');
                }
                session_destroy();
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/75_login_los_andes_google.html"));
                echo $PRINCIPAL;
            } else if ($ambiente == "logbci_sessions") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_bci_sessions.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logsamsonite") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_samsonite.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logrfsgd") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_rfsgd.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logrfgud") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_rf_gud.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "log_rf_callcenter") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_rf_callcenter.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "login_dncrf") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_dncrf.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logrf") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_rf.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logbci_rev2") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_bci_rev2.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logbci_escuela") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/71_login_escuela.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logbci_rev") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_bci_rev.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "log_los_andes_google") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/75_login_los_andes_google.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "log_taylor_google") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/22_login_taylor.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "log_taylor_google2") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/22_login_taylor_G.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "log_taylor_google_logincorrecto") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/22_login_taylor_G.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "log_taylor_google_G") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/22_login_taylor_G.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logtransbank") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_transbank.html"));
                $PRINCIPAL = str_replace("{ID_EMPRESA_ENCODEADA}", Encodear3(58), $PRINCIPAL);
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "log_vf") {
                session_start();
                $tokem     = NoCSRF::generate('tokem');
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_vf.html"));
                //$tokem_login=date("Y-m-d")." ".date("H:i:s");
                $PRINCIPAL = str_replace("{TOKEM_LOGIN}", $tokem, $PRINCIPAL);
                //$_SESSION["tokem_login"]=encodear3($tokem_login);
                //print_r($_SESSION);
                echo $PRINCIPAL;
                exit;
            }
            else if ($ambiente == "log_educacion_financiera_ext") {
                session_start();
                $tokem     = NoCSRF::generate('tokem');
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_bci_educacion_financiera_ext.html"));
                //$tokem_login=date("Y-m-d")." ".date("H:i:s");
                $PRINCIPAL = str_replace("{TOKEM_LOGIN}", $tokem, $PRINCIPAL);
                //$_SESSION["tokem_login"]=encodear3($tokem_login);
                //print_r($_SESSION);
                echo $PRINCIPAL;
                exit;
            }
            else if ($ambiente == "logwom_academy") {
                session_start();
                $tokem     = NoCSRF::generate('tokem');
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_wom_academy.html"));
                //$tokem_login=date("Y-m-d")." ".date("H:i:s");
                $PRINCIPAL = str_replace("{TOKEM_LOGIN}", $tokem, $PRINCIPAL);
                //$_SESSION["tokem_login"]=encodear3($tokem_login);
                //print_r($_SESSION);
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logbestadobeme") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_bestadobeme.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logbestadorrll") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_bestadorrll.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logbe_fen") {
                echo "    <script>         location.href='../gurupagorut/front/?sw=com_mp_home';     </script>";
                exit;
            } else if ($ambiente == "logesachs") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_esachs.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logultramarv2") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_ultramarv2.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logultramarv2_form") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_ultramarv2_form.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logultramarv2_form_ldap") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_ultramarv2_form_ldap.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "loggopartners") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_gopartners.html"));
                echo $PRINCIPAL;
                exit;
            }
            else if ($ambiente == "log_encuestas") {
                    //print_r($_GET);
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_gopartners.html"));
                $PRINCIPAL = str_replace("{ID_ENC}", $_GET["id_enc"], $PRINCIPAL);

                $array_encuesta=datos_Encuesta_front_lb($_GET["id_enc"]);
                    //print_r($array_encuesta);
                    $PRINCIPAL = str_replace("{AMBIENTE}", $ambiente, $PRINCIPAL);
        $PRINCIPAL = str_replace("{IMAGEN}",        utf8_encode($array_encuesta[0]->imagensuperior), $PRINCIPAL);
        $PRINCIPAL = str_replace("{IMAGEN_BACKGROUND}",        utf8_encode($array_encuesta[0]->imageninferior), $PRINCIPAL);
        $PRINCIPAL = str_replace("{TITULO}",        utf8_encode($array_encuesta[0]->titulo), $PRINCIPAL);
        $PRINCIPAL = str_replace("{DESCRIPCION}",   utf8_encode($array_encuesta[0]->descripcion), $PRINCIPAL);
        $PRINCIPAL = str_replace("{DATOS}",         utf8_encode($array_encuesta[0]->bajada_texto), $PRINCIPAL);

if($array_encuesta[0]->imagenlogo<>""){
    $boton="<span class='badge badge-info'>Encuesta Desactiva</span>";

}   else {
    $boton="<center><button class='button button-3d button-info nomargin' type='submit'>?Quiero Contestar!</button></center>";
}
        $PRINCIPAL = str_replace("{BOTON_INGRESAR}",   $boton, $PRINCIPAL);

                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logwom") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_wom.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logsisteco") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_sisteco.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logstc") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_stc.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logfalabella") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_falabella.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "lograbobank") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_rabobank.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logbestado") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_bestado.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logsparta") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_sparta.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logcmpc") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_cmpc.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "loggw") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_gw.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logbtgpactual") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_btgpactual.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logsiga") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_siga.html"));
                $PRINCIPAL = str_replace("{ID_EMPRESA_ENCODEADA}", Encodear3(27), $PRINCIPAL);
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logcompasscollege") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_compasscollege.html"));
                $PRINCIPAL = str_replace("{TOK_ENCODEADA}", Encodear3("Fr45GDs"), $PRINCIPAL);
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logcompass") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_compass.html"));
                $PRINCIPAL = str_replace("{TOK_ENCODEADA}", Encodear3("Fr45GDs"), $PRINCIPAL);
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logchilquinta") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_chilquinta.html"));
                $PRINCIPAL = str_replace("{TOK_ENCODEADA}", Encodear3("Fr45GDs"), $PRINCIPAL);
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logsg") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_sg.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logcial") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_cial.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logmasisa") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_masisa.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logsonda") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_sonda.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logcorpvida") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_corpvida.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logbsa") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_bsa.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "login_rfsgd") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_rfsgd.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "login_rf") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_rf.html"));
                $tokem     = NoCSRF::generate('tokem');
                $PRINCIPAL = str_replace("{TOKEM_LOGIN}", $tokem, $PRINCIPAL);
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logintime") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_intime.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logultramar") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_ultramar.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logturbus") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_turbus.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logemiliana") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_emiliana.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logskberge") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_skberge.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logminvestBK") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_minvest.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "logust") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_ust.html"));
                echo $PRINCIPAL;
                exit;
            } else if ($ambiente == "log_imperial") {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/home/login_imperial.html"));
                echo $PRINCIPAL;
                exit;
            } else {
                //echo "aca";
                session_start();
                $_SESSION = array();
                if (isset($_COOKIE[session_name()])) {
                    setcookie(session_name(), '', time() - 42000, '/');
                }
                session_destroy();
                $PRINCIPAL        = FuncionesTransversales(file_get_contents("" . $url_front . "/front/views/home/login.html"));
                $token_fecha_hora = Encodear3(date("Y-m-d") . " " . date("H:i:s"));
                $PRINCIPAL        = str_replace("{TOKEN_FECHA_HORA}", $token_fecha_hora, $PRINCIPAL);
                session_start();
                $_SESSION["token"] = $token_fecha_hora;
                echo $PRINCIPAL;
                exit;
            }
        } else {
        }
    }
}
function PorcentajeAvanceIngresoObjetivosPorJefe($rut)
{
    $total_cargos      = count(ListadoCargosDistinct($rut));
    $total_finalizados = count(ListadoCargosFinalizadosPorJefe($rut));
    $porcentaje        = ($total_finalizados * 100) / $total_cargos;
    return (number_format($porcentaje, 0));
}
function ListadoObjetivosDnc($rut, $cargo, $html, $PRINCIPAL)
{
    $objetivos = ListadoObjetivosDnc2($rut, utf8_decode($cargo));
    if ($objetivos) {
        foreach ($objetivos as $obj) {
            $row .= file_get_contents("views/dnc/row_objetivos.html");
            $row = str_replace("{OBJETIVO}", utf8_encode($obj->objetivo), $row);
            $row = str_replace("{CONDUCTA1}", utf8_encode($obj->conducta1), $row);
            $row = str_replace("{CONDUCTA2}", utf8_encode($obj->conducta2), $row);
            $row = str_replace("{CONDUCTA3}", utf8_encode($obj->conducta3), $row);
            $row = str_replace("{ID_OBJETIVO_ENCODEADO}", Encodear3($obj->id), $row);
            $row = str_replace("{RUT_JEFE_ENCODEADO}", Encodear3($rut), $row);
            $row = str_replace("{CARGO_ENCODEADO}", Encodear3($cargo), $row);
        }
        $html = str_replace("{LISTA_OBJETIVOS}", ($row), $html);
    } else {
        //$html=file_get_contents("views/dnc/entorno_objetivos_ingresados_sin_finalizar.html");
        $html = "";
        //$html = str_replace("{LISTA_OBJETIVOS}","<tr><td colspan='4'>No existen objetivos ingresados para el cargo ".$cargo."</td></tr>",$html);
        $html = str_replace("{LISTA_OBJETIVOS}", "", $html);
    }
    $PRINCIPAL = str_replace("{ENTORNO_LISTADO_OBJETIVOS}", ($html), $PRINCIPAL);
    $PRINCIPAL = str_replace("{CARGO_ENCODEADO}", Encodear3($cargo), $PRINCIPAL);
    $PRINCIPAL = str_replace("{JEFE_ENCODEADO}", Encodear3($rut), $PRINCIPAL);
    $PRINCIPAL = str_replace("{CARGO}", ($cargo), $PRINCIPAL);
    return ($PRINCIPAL);
}
function FormularioObjetivoEdicion($PRINCIPAL, $rut, $id_cargo, $cargo)
{
    $PRINCIPAL      = str_replace("{CARGO}", ($cargo), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{ID_CARGO_ENCODEADO}", Encodear3($id_cargo), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{CARGO_ENCODEADO}", Encodear3($cargo), $PRINCIPAL);
    //Para el caaso cuando es edicion
    $datos_objetivo = DatosObjetivoDncDadoId($id_cargo);
    $PRINCIPAL      = str_replace("{OBJETIVO}", utf8_encode($datos_objetivo[0]->objetivo), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{CONDUCTA1}", utf8_encode($datos_objetivo[0]->conducta1), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{CONDUCTA2}", utf8_encode($datos_objetivo[0]->conducta2), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{CONDUCTA3}", utf8_encode($datos_objetivo[0]->conducta3), $PRINCIPAL);
    return ($PRINCIPAL);
}
function FormularioObjetivo($PRINCIPAL, $rut, $cargo)
{
    $PRINCIPAL   = str_replace("{CARGO}", ($cargo), $PRINCIPAL);
    $PRINCIPAL   = str_replace("{CARGO_ENCODEADO}", Encodear3($cargo), $PRINCIPAL);
    $PRINCIPAL   = str_replace("{JEFE_ENCODEADO}", Encodear3($rut), $PRINCIPAL);
    //aca muestro el listado de los cumplimientos agrupados en dimensiones
    $dimensiones = TotalDimensionesDeCumplimientoDnc();
    foreach ($dimensiones as $dimen) {
        $entorno .= file_get_contents("views/dnc/entorno_cumplimientos_dimension.html");
        $entorno         = str_replace("{CLASE_DIMENSION}", $dimen->css, $entorno);
        $entorno         = str_replace("{NOMBRE_DIMENSION}", $dimen->dimension, $entorno);
        $entorno         = str_replace("{DESCRIPCION_DIMENSION}", $dimen->descripcion, $entorno);
        $comportamientos = ComportamientoDadoDimension($dimen->id);
        $i               = 1;
        $filas           = "";
        foreach ($comportamientos as $comp) {
            if ($i == 1) {
                $filas .= "<tr>";
            }
            $filas .= '<td class="textos_compo bg_accion" width="50%"><span class="color_celeste"><i class="fa fa-arrow-circle-o-right padRight10px" title="' . $comp->descripcion . '" style="cursor: pointer;"></i></span>' . $comp->comportamiento . '</td>';
            if ($i == 2) {
                $filas .= "</tr>";
                $i = 0;
            }
            $i++;
        }
        $entorno = str_replace("{LISTADO_CUMPLIMIENTOS}", $filas, $entorno);
    }
    $PRINCIPAL = str_replace("{TABLA_CUMPLIMIENTOS_EJEMPLO}", utf8_encode($entorno), $PRINCIPAL);
    return ($PRINCIPAL);
}
function EstadoDncJefeCargo($rut, $cargo)
{
    $verifica_finalizado = VerificaDNCFinalizado($rut, $cargo);
    if ($verifica_finalizado) {
        $estado[0] = "fa fa-circle text-success fs14 mr10";
        $estado[1] = "Terminado";
        $estado[2] = file_get_contents("views/dnc/opciones_edita.html");
    } else {
        $estado[0] = "fa fa-circle text-danger fs14 mr10";
        $estado[1] = "Pendiente";
        $estado[2] = file_get_contents("views/dnc/opciones_ingresa.html");
    }
    return ($estado);
}
function ListadoCargosPorJefe($PRINCIPAL, $rut)
{
    //con el rut del jefe, busco con un select distinct el listado de los cargos que tiene bajo su dependencia
    $cargos = ListadoCargosDistinct($rut);
    foreach ($cargos as $unico) {
        $row .= file_get_contents("views/dnc/row_dnc2.html");
        $row    = str_replace("{NOMBRE_CARGO}", utf8_encode($unico->cargo), $row);
        $row    = str_replace("{CANTIDAD_COLABORADORES}", $unico->numero_colaboradores, $row);
        $row    = str_replace("{RUT_JEFE}", $rut, $row);
        $Estado = EstadoDncJefeCargo($rut, utf8_encode($unico->cargo));
        $row    = str_replace("{OPCIONES}", $Estado[2], $row);
        $row    = str_replace("{ESTADO_CARGO}", $Estado[1], $row);
        $row    = str_replace("{COLOR_ESTADO}", $Estado[0], $row);
        $row    = str_replace("{CARGO_ENCODEADO}", Encodear3(utf8_encode($unico->cargo)), $row);
    }
    $PRINCIPAL                     = str_replace("{LISTADO_CARGOS}", ($row), $PRINCIPAL);
    $PRINCIPAL                     = str_replace("{PORCENTAJE_AVANCE}", PorcentajeAvanceIngresoObjetivosPorJefe($rut), $PRINCIPAL);
    $total_colaboradores           = count(EsJefe($rut));
    $PRINCIPAL                     = str_replace("{CANTIDAD_COLABORADORES}", $total_colaboradores, $PRINCIPAL);
    $cantidad_objetivos_ingresados = count(DatosObjetivoDncDadoJefe($rut));
    $PRINCIPAL                     = str_replace("{CANTIDAD_OBJETIVOS_DEFINIDOS}", $cantidad_objetivos_ingresados, $PRINCIPAL);
    $PRINCIPAL                     = str_replace("{CANTIDAD_CARGOS}", count($cargos), $PRINCIPAL);
    return ($PRINCIPAL);
}
function MuestraDatosCurso($PRINCIPAL, $id_curso)
{
    $total_objetos = count(ObjetosDadoCursoSoloId($id_curso));
    $datos_curso   = DetalleCurso($id_curso);
    $PRINCIPAL     = str_replace("{NOMBRE_CURSO}", utf8_encode($datos_curso[0]->nombre), $PRINCIPAL);
    $PRINCIPAL     = str_replace("{DESCRIPCION_CURSO}", utf8_encode($datos_curso[0]->descripcion), $PRINCIPAL);
    $PRINCIPAL     = str_replace("{CANTIDAD_MODULOS}", $total_objetos, $PRINCIPAL);
    $PRINCIPAL     = str_replace("{ID_CURSO_ENCODEADO}", Encodear3($id_curso), $PRINCIPAL);
    return ($PRINCIPAL);
}
////CHIS COMIENZA
$directorio_noticias = '../front/img/noticias/';
function NoticiasPrincipales($html, $variable)
{
    //Traigo las noticias
    if ($variable) {
        //$noticias=TraeNoticiasPrincipalesPorGerencia($_SESSION["id_empresa"], $variable);
        $noticias     = TraeNoticiasPrincipalesPorComunidad($_SESSION["id_empresa"], $variable);
        $row_template = file_get_contents("views/noticias/row_noticias_principales_comunidad.html");
    } else {
        $noticias     = TraeNoticiasPrincipales($_SESSION["id_empresa"], $variable);
        $row_template = file_get_contents("views/noticias/row_noticias_principales.html");
    }
    $total_html = "";
    foreach ($noticias as $not) {
        $row                 = $row_template;
        $TodoslosComentarios = TodosComentarios($not->id);
        $row                 = str_replace("{PORTADA}", imagen_existe($not->portada), $row);
        $row                 = str_replace("{TITULO}", $not->titulo, $row);
        $row                 = str_replace("{FECHA}", FechaTipoSpa($not->fecha_creacion), $row);
        //$row = str_replace("{CONTENIDO_CORTO}",substr($not->contenido, 0, 100),$row);
        $row                 = str_replace("{CONTENIDO_CORTO}", $not->bajada, $row);
        $row                 = str_replace("{ID_NOTICIA}", Encodear($not->id), $row);
        $row                 = str_replace("{COMENTARIOS}", count($TodoslosComentarios), $row);
        $row                 = str_replace("{CATEGORIA}", $not->nombre_categoria, $row);
        $row                 = str_replace("{IMAGEN_NOTICIA}", $not->portada, $row);
        //datos autor
        $datos_autor         = UsuarioEnBasePersonas($not->rut_creador);
        $row                 = str_replace("{AUTOR}", $datos_autor[0]->nombre . " " . $datos_autor[0]->apaterno . " " . $datos_autor[0]->apaterno, $row);
        $total_html .= $row;
    }
    //echo $total_html; exit;
    $html = str_replace("{COLUMNAS_NOTICIAS_PRINCIPALES}", utf8_encode($total_html), $html);
    $html = str_replace("{COLUMNAS_NOTICIAS_general_CUATRO_MUNDO}", utf8_encode($total_html), $html);
    //ACA COLOCO LAS NOTICIAS QUE SON PRINCIPALES
    return ($html);
}
function NoticiasPrincipalesCom($html, $variable)
{
    //Traigo las noticias
    if ($variable) {
        //$noticias=TraeNoticiasPrincipalesPorGerencia($_SESSION["id_empresa"], $variable);
        //$noticias=TraeNoticiasPrincipalesPorComunidad($_SESSION["id_empresa"], $variable);
        $row_template = file_get_contents("views/noticias/row_noticias_principales_comunidad.html");
    } else {
        $noticias     = TraeNoticiasPrincipalesCom($_SESSION["id_empresa"], $variable);
        $row_template = file_get_contents("views/noticias/row_noticias_principales.html");
    }
    $total_html = "";
    foreach ($noticias as $not) {
        $row                 = $row_template;
        $TodoslosComentarios = TodosComentarios($not->id);
        $row                 = str_replace("{PORTADA}", imagen_existe($not->portada), $row);
        $row                 = str_replace("{TITULO}", $not->titulo, $row);
        $row                 = str_replace("{FECHA}", FechaTipoSpa($not->fecha_creacion), $row);
        //$row = str_replace("{CONTENIDO_CORTO}",substr($not->contenido, 0, 100),$row);
        $row                 = str_replace("{CONTENIDO_CORTO}", $not->bajada, $row);
        $row                 = str_replace("{ID_NOTICIA}", Encodear($not->id), $row);
        $row                 = str_replace("{COMENTARIOS}", count($TodoslosComentarios), $row);
        $row                 = str_replace("{CATEGORIA}", $not->nombre_categoria, $row);
        $row                 = str_replace("{IMAGEN_NOTICIA}", $not->portada, $row);
        //datos autor
        $datos_autor         = UsuarioEnBasePersonas($not->rut_creador);
        $row                 = str_replace("{AUTOR}", $datos_autor[0]->nombre . " " . $datos_autor[0]->apaterno . " " . $datos_autor[0]->apaterno, $row);
        $total_html .= $row;
    }
    //echo $total_html; exit;
    $html = str_replace("{COLUMNAS_NOTICIAS_general_CUATRO_MUNDO}", utf8_encode($total_html), $html);
    //ACA COLOCO LAS NOTICIAS QUE SON PRINCIPALES
    return ($html);
}
function NoticiasSecundarias($html)
{
    //Traigo las noticias
    $noticias   = TraeNoticiasSecundarias($_SESSION["id_empresa"]);
    $total_html = "";
    foreach ($noticias as $not) {
        $row                 = file_get_contents("views/noticias/row_noticias_secundarias.html");
        $TodoslosComentarios = TodosComentarios($not->id);
        $row                 = str_replace("{PORTADA}", imagen_existe($not->portada), $row);
        $row                 = str_replace("{TITULO}", $not->titulo, $row);
        $row                 = str_replace("{FECHA}", FechaTipoSpa($not->fecha_creacion), $row);
        //$row = str_replace("{CONTENIDO_CORTO}",substr($not->contenido, 0, 100),$row);
        $row                 = str_replace("{CONTENIDO_CORTO}", $not->bajada, $row);
        $row                 = str_replace("{ID_NOTICIA}", Encodear($not->id), $row);
        $row                 = str_replace("{COMENTARIOS}", count($TodoslosComentarios), $row);
        $row                 = str_replace("{CATEGORIA}", $not->nombre_categoria, $row);
        $row                 = str_replace("{IMAGEN_NOTICIA}", $not->portada, $row);
        //datos autor
        $datos_autor         = UsuarioEnBasePersonas($not->rut_creador);
        $row                 = str_replace("{AUTOR}", $datos_autor[0]->nombre . " " . $datos_autor[0]->apaterno . " " . $datos_autor[0]->apaterno, $row);
        $total_html .= $row;
    }
    //echo $total_html; exit;
    $html = str_replace("{COLUMNAS_NOTICIAS_SECUNDARIAS}", utf8_encode($total_html), $html);
    //ACA COLOCO LAS NOTICIAS QUE SON PRINCIPALES
    return ($html);
}
function NoticiasTerciarias($html)
{
    //Traigo las noticias
    $noticias   = TraeNoticiasSecundarias($_SESSION["id_empresa"]);
    $total_html = "";
    foreach ($noticias as $not) {
        $row                 = file_get_contents("views/noticias/row_noticias_terciarias.html");
        $TodoslosComentarios = TodosComentarios($not->id);
        $row                 = str_replace("{PORTADA}", imagen_existe($not->portada), $row);
        $row                 = str_replace("{TITULO}", $not->titulo, $row);
        $row                 = str_replace("{FECHA}", FechaTipoSpa($not->fecha_creacion), $row);
        //$row = str_replace("{CONTENIDO_CORTO}",substr($not->contenido, 0, 100),$row);
        $row                 = str_replace("{CONTENIDO_CORTO}", $not->bajada, $row);
        $row                 = str_replace("{ID_NOTICIA}", Encodear($not->id), $row);
        $row                 = str_replace("{COMENTARIOS}", count($TodoslosComentarios), $row);
        $row                 = str_replace("{CATEGORIA}", $not->nombre_categoria, $row);
        $row                 = str_replace("{IMAGEN_NOTICIA}", $not->portada, $row);
        //datos autor
        $datos_autor         = UsuarioEnBasePersonas($not->rut_creador);
        $row                 = str_replace("{AUTOR}", $datos_autor[0]->nombre . " " . $datos_autor[0]->apaterno . " " . $datos_autor[0]->apaterno, $row);
        $total_html .= $row;
    }
    //echo $total_html; exit;
    $html = str_replace("{COLUMNAS_NOTICIAS_TERCIARIAS}", utf8_encode($total_html), $html);
    //ACA COLOCO LAS NOTICIAS QUE SON PRINCIPALES
    return ($html);
}
function BloqueBloqueBannerDinamico($html, $id_empresa, $rut)
{
    //Aca verifico si el usuario dijo no quiero ver o no mas el banner
    $vio_banner = VioBanner($rut, $id_empresa);
    if ($vio_banner) {
        $html = str_replace("{BANNER_DINAMICO}", "", $html);
        $html = str_replace("{FUNCION_ONLOAD}", "", $html);
    } else {
        $html = str_replace("{FUNCION_ONLOAD}", 'onload="SimularBoton();"', $html);
        $html = str_replace("{BANNER_DINAMICO}", file_get_contents("views/home/" . $id_empresa . "_banner_inicial.html"), $html);
    }
    return ($html);
}
function BloqueBloqueBannerDinamicoViajeBciFFVV($html, $id_empresa, $rut)
{
    //Aca verifico si el usuario dijo no quiero ver o no mas el banner
    $vio_banner = VioBanner($rut, $id_empresa);
    if ($vio_banner) {
        $html = str_replace("{BANNER_DINAMICO}", "", $html);
        $html = str_replace("{FUNCION_ONLOAD}", "", $html);
    } else {
        $html = str_replace("{FUNCION_ONLOAD}", 'onload="SimularBoton();"', $html);
        $html = str_replace("{BANNER_DINAMICO}", file_get_contents("views/home/" . $id_empresa . "_banner_inicial.html"), $html);
    }
    return ($html);
}
function BloqueFooterContenido($html)
{
    $row  = file_get_contents("views/footer_contenido/footer_contenido.html");
    $html = str_replace("{BLOQUEFOOTERCONTENIDO}", $row, $html);
    return ($html);
}
function BloqueLinks($html, $id_empresa)
{
    //traigo los links de interes de esta empresa
    $links = LinksInteresPorEmpresa($id_empresa);
    if ($links) {
        $i              = 1;
        $contador_total = 0;
        $entorno        = file_get_contents("views/link_interes/" . $id_empresa . "_entorno_links_interes.html");
        foreach ($links as $unico) {
            $contador_total++;
            if ($i == 1) {
                $rows .= "<div class='row'>";
            }
            if ($unico->link) {
                if ($unico->imagen) {
                    $rows .= file_get_contents("views/link_interes/" . $id_empresa . "_row_links_interes_conlink_imagen.html");
                } else {
                    $rows .= file_get_contents("views/link_interes/" . $id_empresa . "_row_links_interes_conlink.html");
                }
                $rows = str_replace("{LINK}", $unico->link, $rows);
                $rows = str_replace("{IMAGEN}", $unico->imagen, $rows);
                $rows = str_replace("{ID_LINK_ENCODEADO}", Encodear3($unico->id), $rows);
            } else {
                $rows .= file_get_contents("views/link_interes/" . $id_empresa . "_row_links_interes.html");
            }
            $rows = str_replace("{NOMBRE_LINK}", $unico->nombre, $rows);
            $rows = str_replace("{ICONO}", $unico->icono, $rows);
            $rows = str_replace("{DESCRIPCION}", $unico->descripcion, $rows);
            $i++;
            if ($i == 4 && $contador_total <> count($links)) {
                $rows .= "</div>";
                $i = 1;
            }
            if ($contador_total == count($links)) {
                $rows .= "</div>";
            }
        }
        $entorno = str_replace("{BLOQUE_LINKS}", utf8_encode($rows), $entorno);
        //$html = str_replace("{BLOQUE_LINKS}",utf8_encode($rows),$entorno);
        $html    = str_replace("{BLOQUE_LINKS_INTERES}", ($entorno), $html);
    } else {
        $html = str_replace("{BLOQUE_LINKS_INTERES}", "", $html);
    }
    /*$row=file_get_contents("views/links/bloque_links.html");
    $html = str_replace("{BLOQUE_LINKS}",$row,$html);
    */
    return ($html);
}
/*function BloqueLinksInteres($html){
$row=file_get_contents("views/links/bloque_links_interes.html");
$html = str_replace("{BLOQUE_LINKS_INTERES}",$row,$html);
return($html);
}
*/
function BloqueDocumentos($html)
{
    $row  = file_get_contents("views/biblioteca/bloque_ultimos_docs_home.html");
    $html = str_replace("{COLUMNAS_ULTIMOS_DOCUMENTOS}", $row, $html);
    return ($html);
}
function BloqueFotos($html, $id_empresa)
{
    $row      = file_get_contents("views/galeria/bloque_ultimas_fotos_home.html");
    //traigo las ultimas fotos
    //$archivos=TraeUltimasFotosSubidas(6);
    $archivos = TraeUltimasFotosSubidasPorEmpresa(6, $id_empresa);
    foreach ($archivos as $unico) {
        $imagen .= file_get_contents("views/galeria/row_bloque_ultimas_fotos_home.html");
        if ($unico->tipo == "video") {
            $imagen = str_replace("{IMAGEN}", $unico->archivo, $imagen);
            $imagen = str_replace("{IMAGEN2}", "video.jpg", $imagen);
        } else {
            $imagen = str_replace("{IMAGEN2}", $unico->archivo, $imagen);
            $imagen = str_replace("{IMAGEN}", $unico->archivo, $imagen);
        }
    }
    $row  = str_replace("{ROW_ULTIMAS_FOTOS}", $imagen, $row);
    $html = str_replace("{COLUMNAS_ULTIMAS_FOTOS}", $row, $html);
    return ($html);
}
function BloqueMiniSalonFama($html, $id_empresa)
{
    $ano        = 2015;
    //Dada la empresa, traigo a todos los que estan en la tabla de salon de la fama
    $bloque     = file_get_contents("views/salondelafama/bloquesalonfama.html");
    //Primero por traigo las categorias por la empresa
    $categorias = CategoriasSalonDeLaFamaPorEmpresaTipoBanners($id_empresa, 1);
    foreach ($categorias as $unico) {
        //Boton Propuesta
        if ($unico->tabla_usuarios == 1) {
            if ($id_empresa == 22) {
                $row .= file_get_contents("views/salondelafama/22_row_bloquesalonfama.html");
            } else {
                $row .= file_get_contents("views/salondelafama/row_bloquesalonfama.html");
            }
            $datos = TraeListadoClasicos($id_empresa, 1, "ORDER BY RAND()");
            $row   = str_replace("{TEXTO1}", $datos[0]->antiguedad . " a&ntilde;os en nuestra empresa.", $row);
            $row   = str_replace("{CATEGORIA_SALON}", "", $row);
            $row   = str_replace("{RESULTADO}", $datos[0]->antiguedad . " a&ntilde;os en nuestra empresa.", $row);
            $row   = str_replace("{BOTON_VER_DETALLE}", file_get_contents("views/salondelafama/boton_ver_detalle.html"), $row);
            $row   = str_replace("{ENVIRONMENT_BOTON}", $unico->environment_boton, $row);
            $row   = str_replace("{ID_CATEGORIA_SALON_FAMA_ENCODEADO}", Encodear3($unico->id), $row);
        } else {
            //$datos=ObtenerSalonPorCategoriaYEmpresa($id_empresa, $unico->id, 1);
            $datos = ObtenerSalonPorCategoriaYEmpresaPorAno($id_empresa, $unico->id, 1, $ano);
            if ($datos) {
                $row .= file_get_contents("views/salondelafama/row_bloquesalonfama.html");
            } else {
                $row .= file_get_contents("views/salondelafama/row_bloquesalonfama_sin.html");
            }
            if ($unico->ve_boton == 1) {
                $row = str_replace("{BOTON_VER_DETALLE}", file_get_contents("views/salondelafama/boton_ver_detalle.html"), $row);
                $row = str_replace("{ENVIRONMENT_BOTON}", $unico->environment_boton, $row);
                $row = str_replace("{ID_CATEGORIA_SALON_FAMA_ENCODEADO}", Encodear3($unico->id), $row);
            } else {
                $row = str_replace("{BOTON_VER_DETALLE}", "", $row);
            }
            if ($unico->proceso_anterior) {
                $row = str_replace("{BOTON_PROPUESTA}", file_get_contents("views/salondelafama/boton_dinamico.html"), $row);
                $row = str_replace("{VALUE}", "Ver " . $unico->proceso_anterior, $row);
                $row = str_replace("{CASE_BOTON_DINAMICO}", "?sw=listadoSalon&an=" . $unico->proceso_anterior . "&itip=" . Encodear3($unico->id), $row);
            }
            $row = str_replace("{TEXTO1}", $datos[0]->texto1, $row);
            $row = str_replace("{CATEGORIA_SALON}", $datos[0]->nombre_valor, $row);
            $row = str_replace("{RESULTADO}", $datos[0]->impacto, $row);
        }
        if ($unico->boton_propuesta == 1 && count($datos) > 0) {
            $row = str_replace("{BOTON_PROPUESTA}", file_get_contents("views/salondelafama/boton_ver_propuesta.html"), $row);
            $row = str_replace("{ID_CATEGORIA_ENCODEADO}", Encodear3($unico->id), $row);
        } else {
            $row = str_replace("{BOTON_PROPUESTA}", "", $row);
        }
        $row = str_replace("{NOMBRE_PERSONAS}", $datos[0]->nombre_persona . " " . $datos[0]->apaterno . " " . $datos[0]->amaterno . "<br>" . $datos[0]->ubicacion, $row);
        $row = str_replace("{CARGO_PERSONAS}", $datos[0]->cargo, $row);
        $row = str_replace("{URL_PERSONA}", VerificaFotoPersonal($datos[0]->rut), $row);
        $row = str_replace("{RUT_ENCODEADO}", Encodear3($datos[0]->rut), $row);
        $row = str_replace("{NOMBRE_CATEGORIA}", $unico->nombre, $row);
        $row = str_replace("{LOGO_CATEGORIA}", $unico->imagen, $row);
        $row = str_replace("{DESCRIPCION_CATEGORIA}", $unico->descripcion, $row);
        $row = str_replace("{TEXTO2}", $datos[0]->texto2, $row);
        $row = str_replace("{TEXTO3}", $datos[0]->texto3, $row);
        $row = str_replace("{TEXTO4}", $datos[0]->texto4, $row);
        $row = str_replace("{TEXTO5}", $datos[0]->texto5, $row);
    }
    //$row=file_get_contents("views/salondelafama/bloquesalonfama.html");
    $bloque = str_replace("{LISTADO_SALON_FAMA}", utf8_encode($row), $bloque);
    $html   = str_replace("{BLOQUE_MINISALONFAMA}", $bloque, $html);
    return ($html);
}
function BloqueTips($html)
{
    $row  = file_get_contents("views/bloques/bloquetipsseguridad.html");
    $html = str_replace("{BLOQUE_TIPS_SEGURIDAD}", $row, $html);
    return ($html);
}
function BloqueMiniBuenasPracticas($html, $id_empresa)
{
    $rut        = $_SESSION["user_"];
    //Aca en primer lugar veo si es que hay buenas practicas para esta empresa
    $categorias = CategoriasSalonDeLaFamaPorEmpresaTipoBanners($id_empresa, 2);
    if ($categorias) {
        //El entorno de los bloques de buenas practicas
        $entorno = file_get_contents("views/buenas_practicas/index.html");
        foreach ($categorias as $unico) {
            $datos = ObtenerSalonPorCategoriaYEmpresa($id_empresa, $unico->id, 1);
            if ($datos) {
                $row .= file_get_contents("views/" . $unico->template_row);
                $row .= file_get_contents("views/buenas_practicas/boton_vermas.html");
            } else {
                $entorno = file_get_contents("views/buenas_practicas/index_sin.html");
                $row .= file_get_contents("views/buenas_practicas/row2_sin.html");
                //$row.=file_get_contents("views/buenas_practicas/boton_vermas.html");
            }
            $row = str_replace("{ID_CATEGORIA_ENCODEADA}", Encodear3($unico->id), $row);
            $row = str_replace("{NOMBRE}", utf8_encode($datos[0]->nombre_persona) . " " . utf8_encode($datos[0]->apaterno) . " " . utf8_encode($datos[0]->amaterno), $row);
            $row = str_replace("{CARGO}", utf8_encode($datos[0]->cargo), $row);
            $row = str_replace("{URL_PERSONA}", VerificaFotoPersonal($datos[0]->rut), $row);
            $row = str_replace("{RUT_ENCODEADO}", Encodear3($datos[0]->rut), $row);
            $row = str_replace("{TEXTO1}", $datos[0]->texto1, $row);
            $row = str_replace("{TEXTO2}", $datos[0]->texto2, $row);
            $row = str_replace("{TEXTO3}", $datos[0]->texto3, $row);
            $row = str_replace("{TEXTO4}", $datos[0]->texto4, $row);
            $row = str_replace("{TEXTO5}", $datos[0]->texto5, $row);
            $row = str_replace("{VALOR_SITUACION}", utf8_encode($datos[0]->situacion), $row);
            $row = str_replace("{VALOR_ACCION}", utf8_encode($datos[0]->accion), $row);
            $row = str_replace("{VALOR_IMPACTO}", utf8_encode($datos[0]->impacto), $row);
            $row = str_replace("{FECHAPUBLICACION}", utf8_encode($datos[0]->fecha), $row);
            //Debo verificar, si para este usuario, ya tiene el megusta con este contenido
            $row = str_replace("{MEGUSTA}", ColocaMeGusta($datos[0]->id, "id_salonfama_publicados", $id_empresa, $rut), $row);
        }
        $entorno = str_replace("{BLOQUE_MINIBUENASPRACTICAS}", $row, $entorno);
        //$html = str_replace("{BLOQUE_MINIBUENASPRACTICAS}",$row,$html);
        $html    = str_replace("{BLOQUE_BUENAS_PRACTICAS}", $entorno, $html);
    } else {
        $html = str_replace("{BLOQUE_BUENAS_PRACTICAS}", "", $html);
    }
    $html = str_replace("{IMAGEN_INICIO_PAGINA}", $categorias[0]->imagen_inicio_pagina, $html);
    $html = str_replace("{TITULO}", utf8_encode($categorias[0]->titulo_listado), $html);
    $html = str_replace("{ID_CATEGORIA_ENCODEADO}", Encodear3($categorias[0]->id), $html);
    return ($html);
}
function BloqueMiniBuenasPracticas2($html)
{
    $row  = file_get_contents("views/bloques/bloquebuenaspracticas2.html");
    $html = str_replace("{BLOQUE_MINIBUENASPRACTICAS2}", $row, $html);
    return ($html);
}
function BloqueCumpleanos($html, $id_empresa)
{
    //$row=file_get_contents("views/bloques/bloquecumpleanos.html");
    //$html = str_replace("{BLOQUE_CUMPLEANOS}",$row,$html);
    //Cumplea?os por dia
    $cumpleanos = ObtenerCumpleanosPorDiaPorEmpresa($id_empresa);
    if ($cumpleanos) {
        foreach ($cumpleanos as $unico) {
            if ($id_empresa == 22) {
                $row .= file_get_contents("views/cumpleanos/22_row_bloquecumpleanos.html");
            } else {
                $row .= file_get_contents("views/cumpleanos/row_bloquecumpleanos.html");
            }
            if ($unico->nombre_completo) {
                $row = str_replace("{NOMBRE}", $unico->nombre_completo . "<br>" . $unico->ubicacion, $row);
            } else {
                $row = str_replace("{NOMBRE}", $unico->nombre_completo . "<br>" . $unico->ubicacion, $row);
            }
            $row = str_replace("{RUT_ENCODEADO}", Encodear3($unico->rut), $row);
            $row = str_replace("{CARGO}", $unico->cargo, $row);
            $row = str_replace("{FECHA_CUMPLEANOS}", formatearFecha($unico->fecha_nacimiento), $row);
            $row = str_replace("{UBICACION}", $unico->ubicacion, $row);
            $row = str_replace("{URL_PERSONA}", VerificaFotoPersonal($unico->rut), $row);
        }
    } else {
        //Veo si hay cumplea?os en el mes
        $cumpleanos_mes = ObtenerCumpleanosPorMesPorEmpresa($id_empresa, 4);
        foreach ($cumpleanos_mes as $unico) {
            if ($id_empresa == 22) {
                $row .= file_get_contents("views/cumpleanos/22_row_bloquecumpleanos.html");
            } else {
                $row .= file_get_contents("views/cumpleanos/row_bloquecumpleanos.html");
            }
            if (!$unico->nombre) {
                $row = str_replace("{NOMBRE}", $unico->nombre_completo, $row);
            } else {
                $row = str_replace("{NOMBRE}", $unico->nombre_completo, $row);
            }
            $row = str_replace("{RUT_ENCODEADO}", Encodear3($unico->rut), $row);
            $row = str_replace("{UBICACION}", "Ubicaion:" . $unico->ubicacion, $row);
            $row = str_replace("{CARGO}", $unico->cargo, $row);
            $row = str_replace("{FECHA_CUMPLEANOS}", formatearFecha($unico->fecha_nacimiento), $row);
            $row = str_replace("{URL_PERSONA}", VerificaFotoPersonal($unico->rut), $row);
        }
    }
    $html = str_replace("{BLOQUE_CUMPLEANOS}", utf8_Encode($row), $html);
    $html = str_replace("{MES_ENCODEADO}", Encodear3(date(m)), $html);
    return ($html);
}
function BloqueCumpleanosPorMes($html, $id_empresa)
{
    //$row=file_get_contents("views/bloques/bloquecumpleanos.html");
    //$html = str_replace("{BLOQUE_CUMPLEANOS}",$row,$html);
    //Cumplea?os por dia
    //Veo si hay cumplea?os en el mes
    $cumpleanos_mes = ObtenerCumpleanosPorMesPorEmpresaTodos($id_empresa, "");
    foreach ($cumpleanos_mes as $unico) {
        $row .= file_get_contents("views/cumpleanos/row_bloquecumpleanos.html");
        $row = str_replace("{NOMBRE}", $unico->nombre_completo, $row);
        $row = str_replace("{RUT_ENCODEADO}", Encodear3($unico->rut), $row);
        $row = str_replace("{CARGO}", $unico->cargo, $row);
        $row = str_replace("{FECHA_CUMPLEANOS}", formatearFecha($unico->fecha_nacimiento), $row);
        $row = str_replace("{URL_PERSONA}", VerificaFotoPersonal($unico->rut), $row);
    }
    $html = str_replace("{BLOQUE_LISTADO_CUMPLE_MES}", utf8_Encode($row), $html);
    return ($html);
}
function BloqueNuevosIngresos($html, $variable, $id_empresa)
{
    $row      = file_get_contents("views/bloques/bloquenuevosingresos.html");
    //Aca traigo 2 nuevos ingresos aleatorios
    //$usuarios=ObtieneMovimientosNuevosIngresos("1", "2", $variable);
    $usuarios = ObtieneMovimientosNuevosIngresosPorEmpresa("1", "2", $variable, $id_empresa);
    if ($variable) {
        $template_fila = file_get_contents("views/nuevos_ingresos/row_bloquenuevosingresos_por_gerencia.html");
    } else {
        $template_fila = file_get_contents("views/nuevos_ingresos/row_bloquenuevosingresos.html");
    }
    foreach ($usuarios as $unico) {
        //$fila.=file_get_contents("views/nuevos_ingresos/row_bloquenuevosingresos.html");
        $fila .= $template_fila;
        $fila = str_replace("{CARGO_A}", $unico->cargo_a, $fila);
        $fila = str_replace("{GERENCIA_A}", $unico->gerencia_a, $fila);
        $fila = str_replace("{CARGO_DE}", $unico->cargo_de, $fila);
        $fila = str_replace("{NOMBRE}", $unico->nombre . " " . $unico->apaterno . " " . $unico->amaterno . "<br>" . $unico->ubicacion, $fila);
        $fila = str_replace("{GERENCIA}", $unico->gerencia, $fila);
        $fila = str_replace("{URL_PERSONA}", VerificaFotoPersonal($unico->rut), $fila);
        $fila = str_replace("{RUT_ENCODEADO}", Encodear3($unico->rut), $fila);
    }
    $html = str_replace("{BLOQUE_NUEVOS_INGRESOS}", utf8_encode($fila), $html);
    return ($html);
}
function BloqueMovimientosInternos($html, $variable, $id_empresa, $limit)
{
    $row = file_get_contents("views/bloques/bloquemovimientosinternos.html");
    if ($limit) {
        $limite = $limit;
    } else {
        $limite = "";
    }
    //$usuarios=ObtieneMovimientosNuevosIngresos("2", $limite, $variable);
    $usuarios = ObtieneMovimientosNuevosIngresosPorEmpresa("2", $limite, $variable, $id_empresa);
    if ($variable) {
        $template_fila = file_get_contents("views/nuevos_ingresos/row_bloquenuevosingresos_por_gerencia.html");
    } else {
        $template_fila = file_get_contents("views/movimientos_internos/row_bloquemovimientosinternos.html");
    }
    $i = 1;
    foreach ($usuarios as $unico) {
        //$fila.=file_get_contents("views/movimientos_internos/row_bloquemovimientosinternos.html");
        $fila .= $template_fila;
        $fila = str_replace("{CARGO_A}", $unico->cargo_a, $fila);
        $fila = str_replace("{CARGO_DE}", $unico->cargo_de, $fila);
        $fila = str_replace("{NOMBRE}", $unico->nombre . " " . $unico->apaterno . " " . $unico->amaterno, $fila);
        $fila = str_replace("{RUT_ENCODEADO}", Encodear3($unico->rut), $fila);
        $fila = str_replace("{GERENCIA_A}", $unico->gerencia_a, $fila);
        $fila = str_replace("{GERENCIA_DE}", $unico->gerencia_de, $fila);
        $fila = str_replace("{URL_PERSONA}", VerificaFotoPersonal($unico->rut), $fila);
        if ($variable) {
            if ($i == 3) {
                $i = 1;
                $fila .= "<div class='row'></div>";
            } else {
                $i++;
            }
        }
    }
    $html = str_replace("{BLOQUE_MOVIMIENTOS_INTERNOS}", utf8_encode($fila), $html);
    return ($html);
}
function ListadoNoticias($html, $id_empresa, $id_categoria, $pagina)
{
    //cantidad de noticias por pagina
    $cantidad_por_pagina = 12;
    //Traigo las noticias
    if ($id_categoria > 0) {
        //$noticias=TraeNoticiasPorCategoria($id_empresa, $id_categoria);
        $noticias = TraeNoticiasPorCategoriaTodas($id_empresa, $id_categoria, $pagina, $cantidad_por_pagina);
    } else {
        $noticias = TraeNoticias($id_empresa, $pagina, $cantidad_por_pagina);
    }
    if ($noticias) {
        $total_html   = "";
        $contador_row = 1;
        foreach ($noticias as $not) {
            $row                 = file_get_contents("views/noticias/row_noticia.html");
            $TodoslosComentarios = TodosComentarios($not->id);
            $row                 = str_replace("{PORTADA}", imagen_existe($not->portada), $row);
            $row                 = str_replace("{TITULO}", $not->titulo, $row);
            $row                 = str_replace("{FECHA}", FechaTipoSpa($not->fecha_creacion), $row);
            //$row = str_replace("{CONTENIDO_CORTO}",substr($not->contenido, 0, 100),$row);
            $row                 = str_replace("{CONTENIDO_CORTO}", $not->bajada, $row);
            $row                 = str_replace("{ID_NOTICIA}", Encodear($not->id), $row);
            $row                 = str_replace("{COMENTARIOS}", count($TodoslosComentarios), $row);
            $row                 = str_replace("{CATEGORIA}", $not->nombre_categoria, $row);
            $datos_rut_creador   = UsuarioEnBasePersonas($not->rut_creador);
            $row                 = str_replace("{AUTOR}", $datos_rut_creador[0]->nombre . " " . $datos_rut_creador[0]->apaterno . " " . $datos_rut_creador[0]->amaterno, $row);
            $total_html .= $row;
            if ($contador_row == 3) {
                $total_html .= "<div class='row'></div>";
                $contador_row = 0;
            }
            $contador_row++;
        }
        //echo $total_html; exit;
        $html = str_replace("{LISTADO_NOTICIAS}", utf8_encode($total_html), $html);
    } else {
        $html = str_replace("{LISTADO_NOTICIAS}", file_get_contents("views/noticias/row_sin_noticia.html"), $html);
    }
    //ACA COLOCO LAS NOTICIAS QUE SON PRINCIPALES
    //PAGINACION DE NOTICIAS
    $html = str_replace("{PAGINACION_NOTICIAS}", ColocaPaginacionDeNoticias($pagina, $id_empresa, $cantidad_por_pagina, $id_categoria), $html);
    return ($html);
}
function ListadoNoticiasBK($html)
{
    //Traigo las noticias
    $noticias   = TraeNoticias();
    $total_html = "";
    foreach ($noticias as $not) {
        $row = file_get_contents("views/noticias/row_noticia.html");
        $row = str_replace("{PORTADA}", imagen_existe($not->portada), $row);
        $row = str_replace("{TITULO}", $not->titulo, $row);
        $row = str_replace("{FECHA}", FechaTipoSpa($not->fecha_creacion), $row);
        $row = str_replace("{CONTENIDO_CORTO}", substr($not->contenido, 0, 100), $row);
        $row = str_replace("{ID_NOTICIA}", Encodear($not->id), $row);
        $total_html .= $row;
    }
    //echo $total_html; exit;
    $html = str_replace("{LISTADO_NOTICIAS}", $total_html, $html);
    return ($html);
}
function DetalleNoticia($html, $id_noticia, $id_empresa)
{
    $rut             = $_SESSION["user_"];
    //$detalle_noticia=NoticiaPorId($id_noticia);
    $detalle_noticia = NoticiaPorIdConVistas($id_noticia, $id_empresa);
    if ($detalle_noticia[0]->ve_comentarios == 1) {
        $html = str_replace("{BLOQUE_COMENTARIOS}", "", $html);
    } else {
        $html = str_replace("{BLOQUE_COMENTARIOS}", file_get_contents("views/noticias/single_bloque_comentarios.html"), $html);
        $html = str_replace("{IDNOTICIA}", $id_noticia, $html);
    }
    if ($detalle_noticia[0]->nombre_video) {
        $html = str_replace("{BLOQUE_VIDEO}", file_get_contents("views/noticias/single_bloque_video.html"), $html);
        $html = str_replace("{NOMBRE_VIDEO}", $detalle_noticia[0]->nombre_video, $html);
        $html = str_replace("{ID_NOTICIA}", $id_noticia, $html);
    } else {
        $html = str_replace("{BLOQUE_VIDEO}", "", $html);
    }
    if ($detalle_noticia[0]->id_galeria) {
        $html = str_replace("{BLOQUE_GALERIA}", file_get_contents("views/noticias/single_bloque_galeria.html"), $html);
        $html = str_replace("{ID_GALERIA}", $detalle_noticia[0]->id_galeria, $html);
    } else {
        $html = str_replace("{BLOQUE_GALERIA}", "", $html);
    }
    if ($detalle_noticia[0]->id_biblioteca) {
        $html = str_replace("{BLOQUE_BIBLIOTECA}", file_get_contents("views/noticias/single_bloque_biblioteca.html"), $html);
        $html = str_replace("{ID_BIBLIOTECA}", $detalle_noticia[0]->id_galeria, $html);
    } else {
        $html = str_replace("{BLOQUE_BIBLIOTECA}", "", $html);
    }
    if ($detalle_noticia[0]->doc1) {
        $html = str_replace("{BLOQUE_DOCUMENTO1}", file_get_contents("views/noticias/single_bloque_documento.html"), $html);
        $html = str_replace("{NOMBRE_DOCUMENTO}", $detalle_noticia[0]->doc1, $html);
        $html = str_replace("{TEXTO_DOCUMENTO}", utf8_encode($detalle_noticia[0]->descripcion_doc1), $html);
    } else {
        $html = str_replace("{BLOQUE_DOCUMENTO1}", "", $html);
    }
    if ($detalle_noticia[0]->doc2) {
        $html = str_replace("{BLOQUE_DOCUMENTO2}", file_get_contents("views/noticias/single_bloque_documento.html"), $html);
        $html = str_replace("{NOMBRE_DOCUMENTO}", $detalle_noticia[0]->doc2, $html);
        $html = str_replace("{TEXTO_DOCUMENTO}", utf8_encode($detalle_noticia[0]->descripcion_doc2), $html);
    } else {
        $html = str_replace("{BLOQUE_DOCUMENTO2}", "", $html);
    }
    if ($detalle_noticia[0]->doc3) {
        $html = str_replace("{BLOQUE_DOCUMENTO3}", file_get_contents("views/noticias/single_bloque_documento.html"), $html);
        $html = str_replace("{NOMBRE_DOCUMENTO}", $detalle_noticia[0]->doc3, $html);
        $html = str_replace("{TEXTO_DOCUMENTO}", utf8_encode($detalle_noticia[0]->descripcion_doc3), $html);
    } else {
        $html = str_replace("{BLOQUE_DOCUMENTO3}", "", $html);
    }
    if ($detalle_noticia[0]->doc4) {
        $html = str_replace("{BLOQUE_DOCUMENTO4}", file_get_contents("views/noticias/single_bloque_documento.html"), $html);
        $html = str_replace("{NOMBRE_DOCUMENTO}", $detalle_noticia[0]->doc4, $html);
        $html = str_replace("{TEXTO_DOCUMENTO}", utf8_encode($detalle_noticia[0]->descripcion_doc4), $html);
    } else {
        $html = str_replace("{BLOQUE_DOCUMENTO4}", "", $html);
    }
    if ($detalle_noticia[0]->doc5) {
        $html = str_replace("{BLOQUE_DOCUMENTO5}", file_get_contents("views/noticias/single_bloque_documento.html"), $html);
        $html = str_replace("{NOMBRE_DOCUMENTO}", $detalle_noticia[0]->doc5, $html);
        $html = str_replace("{TEXTO_DOCUMENTO}", utf8_encode($detalle_noticia[0]->descripcion_doc5), $html);
    } else {
        $html = str_replace("{BLOQUE_DOCUMENTO5}", "", $html);
    }
    $TraerVotos = TraerVotos('tbl_noticias_likes', $id_noticia);
    $ExisteVoto = ExisteVoto('tbl_noticias_likes', $_SESSION["user_"], $id_noticia);
    if ($ExisteVoto) {
        $tegusta = 'a ti y ' . count($TraerVotos) . ' personas les gusta esto';
    } else {
        $tegusta = 'a ' . count($TraerVotos) . ' personas les gusta esto';
    }
    $html          = str_replace("{IDNOTICIA_ENCODEADA}", Encodear($id_noticia), $html);
    $html          = str_replace("{VISTO}", $detalle_noticia[0]->total_visitas, $html);
    $html          = str_replace("{TITULO}", utf8_encode($detalle_noticia[0]->titulo), $html);
    $html          = str_replace("{BAJADA}", utf8_encode($detalle_noticia[0]->bajada), $html);
    $html          = str_replace("{CONTENIDO}", utf8_encode($detalle_noticia[0]->contenido), $html);
    $html          = str_replace("{CATEGORIA}", utf8_encode($detalle_noticia[0]->nombre_categoria), $html);
    $html          = str_replace("{PERFIL}", utf8_encode($detalle_noticia[0]->perfil), $html);
    $html          = str_replace("{TAG}", SepararTag($detalle_noticia[0]->tag), $html);
    $html          = str_replace("{PORTADA}", imagen_existe($detalle_noticia[0]->portada), $html);
    $html          = str_replace("{LIKE}", $tegusta, $html);
    $html          = str_replace("{FECHA}", FechaTipoSpa($detalle_noticia[0]->fecha_creacion), $html);
    $html          = str_replace("{MEGUSTA}", ColocaMeGusta($id_noticia, "id_noticia", $id_empresa, $rut), $html);
    //Datos del Creador
    $datos_creador = UsuarioEnBasePersonas($detalle_noticia[0]->rut_creador);
    $html          = str_replace("{AUTOR}", $datos_creador[0]->nombre . " " . $datos_creador[0]->apaterno . " " . $datos_creador[0]->amaterno, $html);
    $html          = str_replace("{IDUSUARIO}", $_SESSION['user_'], $html);
    //galeria
    if ($detalle_noticia[0]->galeria) {
        global $directorio_galerias;
        $galeria = '';
        $dir     = $directorio_galerias . $detalle_noticia[0]->galeria . '/'; //nombre de la carpeta, carpeta global de galerias concatenada a nombre galeria
        $images  = glob("$dir{*.gif,*.jpg,*.png}", GLOB_BRACE);
        foreach ($images as $v) {
            $galeria .= '
    <a href="' . $v . '" data-lightbox="image-1" data-title="' . $detalle_noticia[0]->titulo . '">
    <img src="' . $v . '" border="0" style="width:150px;float:left;margin:10px;"  data-lightbox="roadtrip"/>
    </a>';
        }
        $html = str_replace("{GALERIA}", $galeria, $html);
    } else {
        $html = str_replace("{GALERIA}", '', $html);
    }
    $Comentarios      = TodosComentarios($id_noticia);
    $todoscomentarios = '';
    $i                = '';
    foreach ($Comentarios as $com) {
        $row           = file_get_contents("views/noticias/row_comentario.html");
        $NombreUsuario = UsuarioEnBasePersonas($com->id_usuario);
        $nombre        = $NombreUsuario[0]->nombre_completo;
        $row           = str_replace("{COMENTARIO}", $com->comentario, $row);
        $row           = str_replace("{FECHA}", FechaTipoSpa($com->fecha), $row);
        $row           = str_replace("{NOMBRE}", utf8_encode($nombre), $row);
        $row           = str_replace("{URL_FOTO_PERSONA}", ColocaImagenVerificaAvatar($com->id_usuario), $row);
        $todoscomentarios .= $row;
        $i++;
    }
    $html = str_replace("{COMENTARIOS}", $todoscomentarios, $html);
    $html = str_replace("{TOTALCOMENTARIOS}", $i, $html);
    return ($html);
}
function DetalleNoticiaBK($html, $id_noticia)
{
    $detalle_noticia  = NoticiaPorId($id_noticia);
    $html             = str_replace("{TITULO}", $detalle_noticia[0]->titulo, $html);
    $html             = str_replace("{CONTENIDO}", $detalle_noticia[0]->contenido, $html);
    $html             = str_replace("{CATEGORIA}", $detalle_noticia[0]->categoria, $html);
    $html             = str_replace("{PERFIL}", $detalle_noticia[0]->perfil, $html);
    $html             = str_replace("{TAG}", SepararTag($detalle_noticia[0]->tag), $html);
    $html             = str_replace("{PORTADA}", imagen_existe($detalle_noticia[0]->portada), $html);
    $html             = str_replace("{LIKE}", $detalle_noticia[0]->like, $html);
    $html             = str_replace("{FECHA}", FechaTipoSpa($detalle_noticia[0]->fecha_creacion), $html);
    $html             = str_replace("{IDUSUARIO}", $_SESSION['user_'], $html);
    $Comentarios      = TodosComentarios($id_noticia);
    $todoscomentarios = '';
    $i                = '';
    foreach ($Comentarios as $com) {
        $row           = file_get_contents("views/noticias/row_comentario.html");
        $NombreUsuario = UsuarioEnBasePersonas($com->id_usuario);
        $nombre        = $NombreUsuario[0]->nombre_completo;
        $row           = str_replace("{COMENTARIO}", $com->comentario, $row);
        $row           = str_replace("{FECHA}", FechaTipoSpa($com->fecha), $row);
        $row           = str_replace("{NOMBRE}", $nombre, $row);
        $todoscomentarios .= $row;
        $i++;
    }
    $html = str_replace("{COMENTARIOS}", $todoscomentarios, $html);
    $html = str_replace("{TOTALCOMENTARIOS}", $i, $html);
    return ($html);
}
function imagen_existe($imagen)
{
    global $directorio_noticias;
    $imagenexiste = $directorio_noticias . $imagen;
    $comprobacion = $directorio_noticias . 'noticiapordefecto.jpg';
    if (file_exists($imagenexiste)) {
        $comprobacion = $imagenexiste;
    }
    return $comprobacion;
}
function FechaTipoFeibu($datetime)
{
    $datetime = round((time() - strtotime($datetime)) / 60);
    if ($datetime < 1)
        return 'Hace unos segundos.';
    if ($datetime == 1)
        return 'Hace un minuto aproximadamente.';
    if ($datetime < 60)
        return 'Hace ' . $datetime . ' minutos.';
    if ($datetime >= 60) {
        $datetime = round($datetime / 60);
        if ($datetime == 1)
            return 'Hace una hora aproximadamente.';
        if ($datetime < 24)
            return 'Hace ' . $datetime . ' horas.';
        if ($datetime >= 24) {
            $datetime = round($datetime / 24);
            if ($datetime == 1)
                return 'Hace un dia aproximadamente.';
            if ($datetime < 7)
                return 'Hace ' . $datetime . ' dias.';
            if ($datetime >= 7) {
                $datetime = round($datetime / 7);
                if ($datetime == 1)
                    return 'Hace una semana aproximadamente.';
                if ($datetime < 4)
                    return 'Hace mas de una semana';
                else {
                    if ($_SESSION["id_empresa"] == 41) {
                        return '';
                    } else {
                        return 'Hace mas de un mes';
                    }
                }
            }
        }
    }
}
function FechaTipoSpa($datetime)
{
    $originalDate = $datetime;
    $newDate      = date("d-m-Y", strtotime($originalDate));
    return $newDate;
}
function SepararTag($tag)
{
    $valor_array = explode(',', $tag);
    $html        = '';
    foreach ($valor_array as $llave => $valores) {
        $html .= '<a href="#" rel="tag">' . $valores . '</a>';
    }
    return utf8_encode($html);
}
////FIN CHIS
function ObtenerCategoriaEvalJefe($nota, $requerido)
{
    $color_bajo   = "#e44c41";
    $color_cumple = "#88cd2a";
    $color_alto   = "#6adcfa";
    if ($nota < $requerido) {
        $arreglo[0] = "Bajo";
        $arreglo[1] = $color_bajo;
    } else if ($nota == $requerido) {
        $arreglo[0] = "Cumple";
        $arreglo[1] = $color_cumple;
    } else if ($nota > $requerido) {
        $arreglo[0] = "Sobre";
        $arreglo[1] = $color_alto;
    }
    if ($requerido <= 2) {
        $arreglo[2] = $color_bajo;
        $arreglo[3] = "Bajo";
    } else if ($requerido == 3) {
        $arreglo[2] = $color_cumple;
        $arreglo[3] = "Cumple";
    } else if ($requerido > 3) {
        $arreglo[2] = $color_alto;
        $arreglo[3] = "Sobre";
    }
    //Porcentaje
    return ($arreglo);
}
function MuestraInformeEvaluacionJefatura($PRINCIPAL, $id_programa, $evaluado, $evaluador)
{
    //traigo las respuestas de las conductas de este programa, que fueron evaluadas.
    $respuestas = TieneRespuestasEvaluacionJefeCrucePRogramas($evaluado, $evaluador, $id_programa);
    $conductas  = "";
    foreach ($respuestas as $resp) {
        $conductas .= file_get_contents("views/equipo/informe/row_conductas.html");
        $conductas       = str_replace("{NOMBRE_CONDUCTA}", $resp->nombre_conducta, $conductas);
        $valor_respuesta = ObtenerCategoriaEvalJefe($resp->respuesta, $resp->requerido);
        $conductas       = str_replace("{RESULTADO_RESPUESTA}", $valor_respuesta[0], $conductas);
        $conductas       = str_replace("{COLOR1}", $valor_respuesta[1], $conductas);
        $conductas       = str_replace("{COLOR2}", $valor_respuesta[2], $conductas);
        $conductas       = str_replace("{REQUERIDO}", $valor_respuesta[3], $conductas);
    }
    $PRINCIPAL        = str_replace("{LISTADO_CONDUCTAS_EVALUADAS}", $conductas, $PRINCIPAL);
    // Obtengo Comentarios de la Evaluacion de la JEfatura
    $comentarios_eval = TieneComentarioEvaluacionJefe($evaluado, $evaluador, $id_programa);
    $PRINCIPAL        = str_replace("{COMENTARIOS_MEJORA}", utf8_encode($comentarios_eval[0]->comentario), $PRINCIPAL);
    return ($PRINCIPAL);
}
function MuestraEvaluacionJefe($PRINCIPAL, $rut_evaluado, $rut_evaluador, $id_programa)
{
    $datos_programa               = DatosPrograma($id_programa);
    $alternativas                 = AlternativasDadoIdPrograma($datos_programa[0]->id_grupo_alternativa);
    $encabezado_html_alternativas = "";
    foreach ($alternativas as $alt) {
        $encabezado_html_alternativas .= '<div class="col-md-1 col-sm-1 subtitulo_skill' . $alt->estilo . '">' . utf8_encode($alt->alternativa) . '</div>';
    }
    //Con el id del programa, obtengo las conductas.
    $conductas = ObtenerConductasPorPrograma($id_programa);
    $preguntas = "";
    foreach ($conductas as $cond) {
        $preguntas .= file_get_contents("views/equipo/row_pregunta.html");
        $preguntas = str_replace("{NOMBRE_PREGUNTA}", $cond->nombre, $preguntas);
        //Aca traigo las alternativas dado el programa.
        $alter     = "";
        foreach ($alternativas as $alt) {
            //Verifico, si para este evaluado, evaluador, conducta y programa tieme respuesta, si es asi, muestro el template con la alternativa chequeada.
            $tiene_respuesta = TieneRespuestasEvaluacionJefe($rut_evaluado, $rut_evaluador, $cond->id, $id_programa);
            if ($alt->puntaje == $tiene_respuesta[0]->respuesta) {
                //if($tiene_respuesta){
                $alter .= file_get_contents("views/equipo/alternativa_pregunta_eval_jefe_seleccionada.html");
            } else {
                $alter .= file_get_contents("views/equipo/alternativa_pregunta_eval_jefe.html");
            }
            if ($alt->puntaje == $cond->requerido) {
                $alter = str_replace("{STILO_REQUERIDO}", " color_requerido", $alter);
            } else {
                $alter = str_replace("{STILO_REQUERIDO}", "", $alter);
            }
            $alter = str_replace("{VALUE}", $alt->puntaje, $alter);
        }
        $preguntas = str_replace("{OPTIONS_PREGUNTA_EVALUACION_JEFE}", $alter, $preguntas);
        $preguntas = str_replace("{ID_PREGUNTA_ENCODEADO}", $cond->id, $preguntas);
    }
    //Veo si tiene comentarios de la evaluacion de la jefatura
    $comentario_eval = TieneComentarioEvaluacionJefe($rut_evaluado, $rut_evaluador, $id_programa);
    $PRINCIPAL       = str_replace("{VALUE_MEJORA}", utf8_encode($comentario_eval[0]->comentario), $PRINCIPAL);
    //$PRINCIPAL = str_replace("{VALUE_MEJORA}",$comentario_eval[0]->comentario,$PRINCIPAL);
    $PRINCIPAL       = str_replace("{LISTADO_PREGUNTAS}", utf8_encode($preguntas), $PRINCIPAL);
    $PRINCIPAL       = str_replace("{EVALUADO_ENCODEADO}", Encodear3($rut_evaluado), $PRINCIPAL);
    $PRINCIPAL       = str_replace("{ID_PROGRAMA_ENCODEADO}", Encodear3($id_programa), $PRINCIPAL);
    $PRINCIPAL       = str_replace("{ENCABEZADO_OPCIONES_EVAL_JEFE}", ($encabezado_html_alternativas), $PRINCIPAL);
    return ($PRINCIPAL);
}
function MiEquipo($PRINCIPAL, $rut)
{
    //Verificar si es jefe, si es que lo es, viene el listado de colaboradores.
    $es_jefe = EsJefe($rut);
    if ($es_jefe) {
        $colaborador = "";
        foreach ($es_jefe as $col) {
            $colaborador .= file_get_contents("views/equipo/row_colaboradores.html");
            $colaborador        = str_replace("{NOMBRE}", $col->nombre_completo, $colaborador);
            $colaborador        = str_replace("{RUT_EVALUADO_ENCODEADO}", Encodear3($col->rut), $colaborador);
            $colaborador        = str_replace("{CARGO}", $col->cargo, $colaborador);
            $colaborador        = str_replace("{RUT}", $col->rut, $colaborador);
            $colaborador        = str_replace("{GERENCIA}", $col->gerencia, $colaborador);
            $colaborador        = str_replace("{FOTO_PERSONA}", "img/personas/" . $col->rut . ".jpg", $colaborador);
            $colaborador        = str_replace("{FECHA_INGRESO}", $col->fecha_ingreso, $colaborador);
            $mallas_por_empresa = MallasPorEmpresa($col->id_empresa);
            //Con el criterio malla, me indica si tiene o no asignada la malla encontrada para el usuario
            $criterio_malla     = VerificaCriterioMalla($mallas_por_empresa[0]->campo, $mallas_por_empresa[0]->valor, $col->rut, $col->id_empresa);
            if ($criterio_malla) {
                //Con la malla, traigo cuales son los programas.
                $programas = ProgramasDadoMallaTraeEvaluacionesJefe($mallas_por_empresa[0]->id_malla);
                if ($programas) {
                    //aca recorro el arreglo de programas.
                    //Cada uno de estos corresponde a las evaluaciones que el jefe debe realizar sobre el evaluado.
                    $evaluaciones_ver = "";
                    foreach ($programas as $prog) {
                        $evaluaciones_ver .= 'Programa: ' . $prog->nombre . ': <input type="button" value="Acceder"   onClick="location.href=\'?sw=evJef&ie=' . Encodear3($col->rut) . '&i=' . Encodear3($prog->id) . ' \' " ><br>';
                    }
                    //$evaluaciones_ver="si";
                } else {
                    $evaluaciones_ver = "No posee evaluaciones asocidas a los programas de su malla";
                }
            } else {
                $evaluaciones_ver = "No posee evaluaciones asocidas a los programas de su malla";
            }
            $colaborador = str_replace("{EVALUACIONES}", $evaluaciones_ver, $colaborador);
        }
        $PRINCIPAL = str_replace("{LISTADOS_COLABORADORES_EQUIPO}", $colaborador, $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{LISTADOS_COLABORADORES_EQUIPO}", file_get_contents("views/equipo/no_es_jefe.html"), $PRINCIPAL);
    }
    return ($PRINCIPAL);
}
function segundos_tiempo($segundos)
{
    $minutos    = $segundos / 60;
    $horas      = floor($minutos / 60);
    $minutos2   = $minutos % 60;
    $segundos_2 = $segundos % 60 % 60 % 60;
    if ($minutos2 < 10)
        $minutos2 = '0' . $minutos2;
    if ($segundos_2 < 10)
        $segundos_2 = '0' . $segundos_2;
    if ($segundos < 60) {
        /* segundos */
        $resultado = round($segundos) . ' Segundos';
    } elseif ($segundos > 60 && $segundos < 3600) {
        /* minutos */
        $resultado = $minutos2 . ':' . $segundos_2 . ' Minutos';
    } else {
        /* horas */
        $resultado = $horas . ':' . $minutos2 . ':' . $segundos_2 . ' Horas';
    }
    return $resultado;
}
function ArmaPaginacionEvaluacion($total_preguntas, $pagina_actual)
{
    $html       = "";
    $i          = 1;
    $paginacion = '<div class="pagination_sgd"><ul>';
    foreach ($total_preguntas as $preg) {
        if ($pagina_actual == $i) {
            $paginacion .= '<li ><a class="pagination_sgd_activo">' . $i . '</a></li>';
        } else {
            $paginacion .= '<li><a href="#">' . $i . '</a></li>';
        }
        $i++;
    }
    $paginacion .= '</ul></div>';
    return ($paginacion);
}
function ObtenerNotaDeEvaluacion($id_objeto, $rut)
{
    $respuestas  = RespuestasDadoRutObjeto($rut, $id_objeto);
    $correctas   = 0;
    $incorrectas = 0;
    foreach ($respuestas as $res) {
        if ($res->correcta == "1") {
            $correctas++;
        } else {
            $incorrectas++;
        }
    }
    $nota_eval = (100 * $correctas) / count($respuestas);
    return ($nota_eval);
}
function PorcentajeCursos($id_nivel, $rut)
{
    //Obtengo el total de los cursos dado el nivel
    $total_cursos = CursosDadoNivel($id_nivel);
    $finalizado   = 0;
    foreach ($total_cursos as $cur) {
        $verifica = VErificaCursoFinalizado($cur->id, $rut);
        if ($verifica) {
            $finalizado++;
        }
    }
    return (($finalizado * 100) / count($total_cursos));
}
function TotalParticipantes()
{
    //Con el id de empresa y el id de Malla,
    $criterio       = CriterioMallaPorEmpresaMalla($_SESSION["id_empresa"], $_SESSION["malla"]);
    $total_personas = PersonasDadoCriterio($criterio[0]->campo, $criterio[0]->valor);
    return (count($total_personas));
}
function PorcentajeAvanceCurso($id_curso, $rut)
{
    //en el indice 4 del arreglo, se dejaran 4 estados, para saber si esta aprobado, reprobado, no iniciado o incompleto
    //1=Aprobado
    //2=Reprobado
    //3=Pendiente
    //4=Incompleto
    //INDICE 0 = ESTADO + PROMEDIO DE NOTA
    //INDICE 1 = PORCENTAJE DE AVANCE
    //INDICE 2 = DEDO PARA ARRIBA
    //INDICE 3 = NOTA CURSO
    //INDICE 4 = ESTADO
    //INDICE 5 = COLOR DE ESTADO
    //INDICE 6 = BACKGROUND
    //INDICE 7 = COLOR DEL TEXTO
    //Obtengo los objetos del curso
    $total_objetos             = count(ObjetosDadoCurso($id_curso, $rut));
    //Obtenho el total de los cursos finalizados
    $total_objetos_finalizados = count(ObjetosFinalizadosDadoCursoYRut($id_curso, $rut));
    //si tiene objetos, entro al siguiente IF
    if ($total_objetos > 0) {
        //Si est?n todos finalizados
        if ($total_objetos == $total_objetos_finalizados) {
            //Aca en vez de mostrar Completo, debo mostrar si est? aprobado o reprobado.
            //Obtengo la nota del curso, en base a los objetos finalizados.
            $promedio_curso     = PromedioDeEvaluacionesDadoCursoYRut($id_curso, $rut);
            //en la siguiente funcion, paso como parametro la nota del curso, y devuelta me devuelve iconos, estados, colores, etc.
            $aprobado_reprobado = ApruebaReprueba($promedio_curso[0]->promedio_nota_curso);
            //En la siguiente arreglo[0], concateno el estado m?s la nota del curso
            $arreglo[0]         = $aprobado_reprobado[3] . " " . $promedio_curso[0]->promedio_nota_curso . "%";
            $arreglo[1]         = "100";
            //en la sigguiente, es para colocar el dedo arriba o no colocar dedo.
            if ($aprobado_reprobado[2] == "si") {
                $arreglo[2] = 'class="fa fa-thumbs-o-up text-success fontsize20"';
                $arreglo[4] = 1;
                $arreglo[5] = "#35d37d";
                $arreglo[6] = "etiquetaPrograma-aprobado";
                $arreglo[7] = "texto1-aprobado";
            } else if ($aprobado_reprobado[2] == "no") {
                $arreglo[4] = 2;
                $arreglo[5] = "#ec6f5a";
                $arreglo[6] = "etiquetaPrograma-reprobado";
                $arreglo[7] = "texto1-reprobado";
            } else {
                $arreglo[0] = '<span class="etiquetaAprobadoReprobado etiquetaAprobadoReprobado-aprobado">Finalizado</span>';
                $arreglo[5] = "#35d37d";
                $arreglo[6] = "etiquetaPrograma-aprobado";
                $arreglo[7] = "texto1-aprobado";
            }
            $arreglo[3] = $promedio_curso[0]->promedio_nota_curso;
        } else {
            $porcentaje_avance = number_format(((100 * $total_objetos_finalizados) / $total_objetos), 0);
            $promedio_curso    = PromedioDeEvaluacionesDadoCursoYRut($id_curso, $rut);
            $arreglo[3]        = $promedio_curso[0]->promedio_nota_curso;
            if ($porcentaje_avance == "0") {
                $arreglo[0] = '<span class="fa fa-circle text-pendiente fs14 mr10"></span><span class="etiquetaAprobadoReprobado etiquetaAprobadoReprobado-pendiente">Pendiente</span>';
                $arreglo[1] = $porcentaje_avance;
                $arreglo[4] = 3;
                $arreglo[5] = "#777777";
                $arreglo[6] = "etiquetaPrograma-pendiente";
                $arreglo[7] = "txto1-pendiente";
            } else {
                $arreglo[0] = '<span class="fa fa-circle text-warning fs14 mr10"></span><span class="etiquetaAprobadoReprobado etiquetaAprobadoReprobado-proceso">En Proceso</span>';
                $arreglo[1] = $porcentaje_avance;
                $arreglo[4] = 4;
                $arreglo[5] = "#f6bb42";
                $arreglo[6] = "etiquetaPrograma-proceso";
                $arreglo[7] = "texto1-proceso";
            }
        }
    } else {
        $arreglo[0] = "Pendiente";
        $arreglo[1] = "0";
        $arreglo[4] = 3;
        $arreglo[5] = "#777777";
        $arreglo[6] = "etiquetaPrograma-pendiente";
        $arreglo[7] = "txto1-pendiente";
    }
    return ($arreglo);
}
function BarraNavegacion($PRINCIPAL, $seccion)
{
    //echo "_";
    $datos_usuario = UsuarioEnBasePersonas($_SESSION["user_"]);
    //exit;
    if ($seccion == "malla") {
        $PRINCIPAL = str_replace("{BARRA_NAVEGACION_BUSCADOR}", file_get_contents("views/menu_navegacion/navegacion_1.html"), $PRINCIPAL);
    } else if ($seccion == "listado_categorias") {
        $PRINCIPAL = str_replace("{BARRA_NAVEGACION_BUSCADOR}", file_get_contents("views/menu_navegacion/navegacion_2.html"), $PRINCIPAL);
    } else if ($seccion == "listado_cursos") {
        $PRINCIPAL = str_replace("{BARRA_NAVEGACION_BUSCADOR}", file_get_contents("views/menu_navegacion/navegacion_3.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_PROGRAMA_ENCODEADO}", Encodear3(Decodear($_SESSION["programa"])), $PRINCIPAL);
    } else if ($seccion == "detalle_curso") {
        $niveles = NivelesDadoPrograma(decodear($_SESSION["programa"]));
        if (count($niveles) == 1) {
            $PRINCIPAL = str_replace("{BARRA_NAVEGACION_BUSCADOR}", file_get_contents("views/menu_navegacion/navegacion_4_sin_nivel.html"), $PRINCIPAL);
        } else if (count($niveles) == 0) {
            $PRINCIPAL = str_replace("{BARRA_NAVEGACION_BUSCADOR}", file_get_contents("views/menu_navegacion/navegacion_solo_nombre.html"), $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{BARRA_NAVEGACION_BUSCADOR}", file_get_contents("views/menu_navegacion/navegacion_4.html"), $PRINCIPAL);
        }
        $PRINCIPAL = str_replace("{ID_PROGRAMA_ENCODEADO}", Encodear3(Decodear($_SESSION["programa"])), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_NIVEL_ENCODEADO}", Encodear3(Decodear($_SESSION["nivel"])), $PRINCIPAL);
    } else if ($seccion == "fineval") {
        //$PRINCIPAL = str_replace("{BARRA_NAVEGACION_BUSCADOR}",file_get_contents("views/menu_navegacion/navegacion_5.html"),$PRINCIPAL);
        $PRINCIPAL = str_replace("{BARRA_NAVEGACION_BUSCADOR}", file_get_contents("views/menu_navegacion/navegacion_informe.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_PROGRAMA_ENCODEADO}", Encodear3(Decodear($_SESSION["programa"])), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_NIVEL_ENCODEADO}", Encodear3(Decodear($_SESSION["nivel"])), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_CURSO_ENCODEADO}", Encodear3(Decodear($_SESSION["nivel"])), $PRINCIPAL);
    } else if ($seccion == "contenido") {
        $PRINCIPAL = str_replace("{BARRA_NAVEGACION_BUSCADOR}", file_get_contents("views/menu_navegacion/navegacion__contenido.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_PROGRAMA_ENCODEADO}", Encodear3(Decodear($_SESSION["programa"])), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_NIVEL_ENCODEADO}", Encodear3(Decodear($_SESSION["nivel"])), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_CURSO_ENCODEADO}", Encodear3(Decodear($_SESSION["nivel"])), $PRINCIPAL);
    } else if ($seccion == "evaluacion") {
        $PRINCIPAL = str_replace("{BARRA_NAVEGACION_BUSCADOR}", file_get_contents("views/menu_navegacion/navegacion__evaluacion.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_PROGRAMA_ENCODEADO}", Encodear3(Decodear($_SESSION["programa"])), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_NIVEL_ENCODEADO}", Encodear3(Decodear($_SESSION["nivel"])), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_CURSO_ENCODEADO}", Encodear3(Decodear($_SESSION["nivel"])), $PRINCIPAL);
    } else if ($seccion == "intro_eval") {
        $PRINCIPAL = str_replace("{BARRA_NAVEGACION_BUSCADOR}", file_get_contents("views/menu_navegacion/navegacion__evaluacion.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_PROGRAMA_ENCODEADO}", Encodear3(Decodear($_SESSION["programa"])), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_NIVEL_ENCODEADO}", Encodear3(Decodear($_SESSION["nivel"])), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_CURSO_ENCODEADO}", Encodear3(Decodear($_SESSION["nivel"])), $PRINCIPAL);
    } else if ($seccion == "evJef") {
        $PRINCIPAL = str_replace("{BARRA_NAVEGACION_BUSCADOR}", file_get_contents("views/menu_navegacion/navegacion_eval_jefe.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_PROGRAMA_ENCODEADO}", Encodear3(Decodear($_SESSION["programa"])), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_NIVEL_ENCODEADO}", Encodear3(Decodear($_SESSION["nivel"])), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_CURSO_ENCODEADO}", Encodear3(Decodear($_SESSION["nivel"])), $PRINCIPAL);
    } else if ($seccion == "informeEvalJ") {
        $PRINCIPAL = str_replace("{BARRA_NAVEGACION_BUSCADOR}", file_get_contents("views/menu_navegacion/navegacion_eval_jefe.html"), $PRINCIPAL);
    } else if ($seccion == "noticias") {
        $PRINCIPAL = str_replace("{BARRA_NAVEGACION_BUSCADOR}", file_get_contents("views/menu_navegacion/navegacion_salir.html"), $PRINCIPAL);
    } else if ($seccion == "help") {
        $PRINCIPAL = str_replace("{BARRA_NAVEGACION_BUSCADOR}", file_get_contents("views/menu_navegacion/navegacion_help.html"), $PRINCIPAL);
    } else if ($seccion == "sendSolicitud") {
        $PRINCIPAL = str_replace("{BARRA_NAVEGACION_BUSCADOR}", file_get_contents("views/menu_navegacion/navegacion_help.html"), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BARRA_NAVEGACION_BUSCADOR}", file_get_contents("views/menu_navegacion/navegacion_salir.html"), $PRINCIPAL);
    }
    if ($datos_usuario[0]->nombre && $datos_usuario[0]->apaterno && $datos_usuario[0]->amaterno) {
        //$PRINCIPAL = str_replace("{NOMBRE_COLABORADOR}",utf8_encode($datos_usuario[0]->nombre),$PRINCIPAL);
        $PRINCIPAL = str_replace("{NOMBRE_COLABORADOR}", utf8_encode($datos_usuario[0]->nombre . " " . $datos_usuario[0]->apaterno . " " . $datos_usuario[0]->amaterno), $PRINCIPAL);
    } else if ($datos_usuario[0]->nombre_completo) {
        $PRINCIPAL = str_replace("{NOMBRE_COLABORADOR}", utf8_encode($datos_usuario[0]->nombre_completo), $PRINCIPAL);
    } else if ($datos_usuario[0]->nombre) {
        $PRINCIPAL = str_replace("{NOMBRE_COLABORADOR}", utf8_encode($datos_usuario[0]->nombre), $PRINCIPAL);
    }
    $datos_malla    = DatosMalla($_SESSION["malla"]);
    $PRINCIPAL      = str_replace("{MALLA}", utf8_encode($datos_malla[0]->nombre), $PRINCIPAL);
    $datos_programa = DatosPrograma(Decodear($_SESSION["programa"]));
    $PRINCIPAL      = str_replace("{PROGRAMA}", utf8_encode($datos_programa[0]->nombre), $PRINCIPAL);
    $datos_empresa  = DatosEmpresa($_SESSION["id_empresa"]);
    $PRINCIPAL      = str_replace("{CASE_HOME}", $datos_empresa[0]->case_home, $PRINCIPAL);
    if ($seccion <> $datos_empresa[0]->case_home) {
        $PRINCIPAL = str_replace("{SECCION_VOLVER}", file_get_contents("views/menu_navegacion/seccion_volver.html"), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{SECCION_VOLVER}", "", $PRINCIPAL);
    }
    return ($PRINCIPAL);
}
function ColoresYRangos($valor)
{
    if ($valor < 40) {
        $arreglo[0] = "Bajo";
        $arreglo[1] = "e44c41";
        $arreglo[2] = $valor;
    } else {
        $arreglo[0] = "Alto";
        $arreglo[1] = "88cd2a";
        $arreglo[2] = $valor;
    }
    return ($arreglo);
}
function VerificaFinalizaCurso($id_curso, $rut)
{
    $objetos_dado_curso                 = count(ObjetosDadoCursoCruceNota($id_curso, $rut));
    $objetos_finalizados_dado_curso_rut = ObjetosFinalizadosDadoCursoYRut($id_curso, $rut);
    if ($objetos_dado_curso == count($objetos_finalizados_dado_curso_rut)) {
        //Inserto registro en tabla de curso Finalizado
        InsertaCursoFinalizado($id_curso, $rut);
        //Como aca ya se que todos los objetos est?n finalizados, calculo la nota de del curso, con las notas de los objetos.
        //Aca actualizo
    }
}
function ObtieneIdDadoIdObjeto($id_objeto)
{
    $arreglo[0]   = $id_objeto;
    $datos_objeto = DatosObjeto($arreglo[0]);
    $arreglo[1]   = $datos_objeto[0]->id_curso;
    print_r($arreglo);
}
function ApruebaReprueba($nota)
{
    //1 reprobado
    //2 aprobado
    //3 no iniciado
    if ($nota == 0) {
        //$arreglo[0]="reprobado";
        //$arreglo[1]="reprobado_informe.png";
        //$arreglo[2]="no";
        //$arreglo[3]='<span class="etiquetaAprobadoReprobado etiquetaAprobadoReprobado-reprobado">Reprobado</span>';
        //$arreglo[4]='txtnotareprobada';
        //$arreglo[5]='3';//reprobado
        //Modificado para WATTS
        $arreglo[0] = 'Finalizado';
        $arreglo[1] = "aprobado_informe.png";
        $arreglo[2] = "si";
        $arreglo[3] = '<span class="etiquetaAprobadoReprobado etiquetaAprobadoReprobado-aprobado">Finalizado</span>';
        $arreglo[4] = 'feedbackcorrecto';
        $arreglo[5] = '3'; //No iniciado
        return ($arreglo);
    } else if (!$nota) {
        $arreglo[0] = 'Finalizado';
        $arreglo[1] = "aprobado_informe.png";
        $arreglo[2] = "si";
        $arreglo[3] = '<span class="etiquetaAprobadoReprobado etiquetaAprobadoReprobado-aprobado">Finalizado</span>';
        $arreglo[4] = 'feedbackcorrecto';
        $arreglo[5] = '3'; //No iniciado
    } else {
        if ($nota >= 60) {
            $arreglo[0] = 'aprobado';
            $arreglo[1] = "aprobado_informe.png";
            $arreglo[2] = "si";
            $arreglo[3] = '<span class="etiquetaAprobadoReprobado etiquetaAprobadoReprobado-aprobado">Aprobado</span>';
            $arreglo[4] = 'feedbackcorrecto';
            $arreglo[5] = '2'; //aprobado
            return ($arreglo);
        } else {
            $arreglo[0] = "reprobado";
            $arreglo[1] = "reprobado_informe.png";
            $arreglo[2] = "no";
            $arreglo[3] = '<span class="etiquetaAprobadoReprobado etiquetaAprobadoReprobado-reprobado">Reprobado</span>';
            $arreglo[4] = 'feedbackincorrecto';
            $arreglo[5] = '1'; //reprobado
            return ($arreglo);
        }
    }
}
function MuestraInformeIndividual($PRINCIPAL, $rut, $id_objeto, $tipo)
{
    //Obtengo datos del objeto
    $datos_objeto = DatosObjeto($id_objeto);
    $datos_curso  = DatosCurso($datos_objeto[0]->id_curso);
    //print_r($datos_curso);
    //print_r($datos_objeto);
    if ($datos_objeto[0]->preguntas_aleatorias > 0) {
        $datos_preguntas = PreguntasDadoIdObjetoaleatorio($id_objeto, $rut);
    } else {
        $datos_preguntas = PreguntasDadoIdObjeto($id_objeto);
    }
    $PRINCIPAL       = str_replace("{NOMBRE_OBJETO}", utf8_encode($datos_objeto[0]->titulo), $PRINCIPAL);
    $datos_usuario   = UsuarioEnBasePersonas($rut);
    $PRINCIPAL       = str_replace("{NOMBRE_USUARIO}", utf8_encode($datos_usuario[0]->nombre_completo), $PRINCIPAL);
    $total_preguntas = "";
    $i               = 1;
    $correctas       = 0;
    foreach ($datos_preguntas as $preg) {
        $total_preguntas .= file_get_contents("views/cursos/informe/" . $_SESSION["id_empresa"] . "_row_informe_eval_preguntas.html");
        $total_preguntas   = str_replace("{N}", $i, $total_preguntas);
        $total_preguntas   = str_replace("{PREGUNTA}", $preg->pregunta, $total_preguntas);
        //Verifico si la respuesta que ingreso el usuario para eta pregunta es correcta o no
        $respuesta_usuario = ObtenerRespuestaDeUsuario($preg->id, $rut);
        //print_r($respuesta_usuario);
        if ($preg->tipo == 7) {
            $total_preguntas = str_replace("{TURESPUESTA}", $respuesta_usuario[0]->comentarios, $total_preguntas);
        } else {
            $total_preguntas = str_replace("{TURESPUESTA}", $respuesta_usuario[0]->alternativa, $total_preguntas);
        }
        if ($respuesta_usuario[0]->correcta == "1") {
            $total_preguntas = str_replace("{COLOR_FONDO}", "color_aprobado_text", $total_preguntas);
            $total_preguntas = str_replace("{ICONO_INFORME_PREGUNTAS}", "fas fa-check-square", $total_preguntas);
            $total_preguntas = str_replace("{TIPOALERT}", "alert-success", $total_preguntas);
            if (file_exists("views/cursos/informe/" . $_SESSION["id_empresa"] . "_row_respuesta_correcta.html")) {
                $total_preguntas = str_replace("{RESPUESTA_CORRECTA}", file_get_contents("views/cursos/informe/" . $_SESSION["id_empresa"] . "_row_respuesta_correcta.html"), $total_preguntas);
            } else {
                $total_preguntas = str_replace("{RESPUESTA_CORRECTA}", file_get_contents("views/cursos/informe/row_respuesta_correcta.html"), $total_preguntas);
            }
            $total_preguntas = str_replace("{TIPOALERT}", "alert-success", $total_preguntas);
            //echo "<br>".$preg->refuerzo1." correcta ".$respuesta_usuario[0]->alternativa_correcta;
            if ($preg->refuerzo1 == "") {
                $preg->refuerzo1 = $respuesta_usuario[0]->alternativa_correcta;
            } else {
                $preg->refuerzo1 = $preg->refuerzo1;
            }
            $total_preguntas = str_replace("{FEEDBACK}", $preg->refuerzo1, $total_preguntas);
            $correctas++;
        } else {
            $total_preguntas = str_replace("{COLOR_FONDO}", "color_reprobado_text", $total_preguntas);
            $total_preguntas = str_replace("{ICONO_INFORME_PREGUNTAS}", "far fa-times-circle", $total_preguntas);
            if ($_SESSION["id_empresa"] <> 57) {
                if (file_exists("views/cursos/informe/" . $_SESSION["id_empresa"] . "_row_respuesta_correcta.html")) {
                   $total_preguntas = str_replace("{RESPUESTA_CORRECTA}", file_get_contents("views/cursos/informe/" . $_SESSION["id_empresa"] . "_row_respuesta_correcta.html"), $total_preguntas);
                } else {
                    $total_preguntas = str_replace("{RESPUESTA_CORRECTA}", file_get_contents("views/cursos/informe/row_respuesta_correcta.html"), $total_preguntas);
                }
                $total_preguntas = str_replace("{TIPOALERT}", "alert-danger", $total_preguntas);
                if ($preg->refuerzo2 == "") {
                    $preg->refuerzo2 = $respuesta_usuario[0]->alternativa_correcta;
                } else {
                    $preg->refuerzo2 = $preg->refuerzo2;
                }
                $total_preguntas = str_replace("{FEEDBACK}", $preg->refuerzo2, $total_preguntas);
            } else {
                $total_preguntas = str_replace("{RESPUESTA_CORRECTA}", file_get_contents("views/cursos/informe/" . $_SESSION["id_empresa"] . "_row_respuesta_correcta.html"), $total_preguntas);
            }
            $total_preguntas   = str_replace("{CORRECTA}", $respuesta_usuario[0]->alternativa_correcta, $total_preguntas);
            $total_preguntas   = str_replace("{PUNTOS}", round($respuesta_usuario[0]->puntaje), $total_preguntas);
            $total_suma_puntos = $total_suma_puntos + round($respuesta_usuario[0]->puntaje);
        }
        $i++;
    }
    //NotaFinal
    //echo "correctas $correctas";
    //echo "<br>";

    $nota_final     = ($correctas * 100) / count($datos_preguntas);
    $id_evaluacion  = $datos_objeto[0]->id_evaluacion;
    $puntos_a_sumar = ($datos_objeto[0]->puntos * $nota_final) / 100;
    if ($datos_objeto[0]->nota_aprobacion>0) {
        //echo $nota_final." nota final con nota aprobacion";
        if ($nota_final >= $datos_objeto[0]->nota_aprobacion) {
            //$PRINCIPAL=FuncionesTransversales(file_get_contents("views/cursos/informe/51_pantalla_final_evaluacion_correcto.html"));
            //print_r($datos_objeto);
            //echo "hola12";
            if ($datos_objeto[0]->checkin == 1) {
                //    echo "cua 13";
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/informe/" . $_SESSION["id_empresa"] . "_pantalla_final_evaluacion_correcto_checkin.html"));
                $estilo_alerta_aprobacion == "alert-success";
            } else {
                //certificacion
                if ($datos_curso[0]->scoid == "CERTIFICACION") {
                    $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/informe/" . $_SESSION["id_empresa"] . "_pantalla_final_evaluacion_certificacion.html"));
                } else {
                    //echo "correcto";
                    $resultado_estado = "correcto";
                    $PRINCIPAL        = FuncionesTransversales(file_get_contents("views/cursos/informe/" . $_SESSION["id_empresa"] . "_pantalla_final_evaluacion_correcto.html"));
                    if ($datos_objeto[0]->linkabrir == 2) {
                        $PRINCIPAL = str_replace("{BLOQUE_NOTA_PUNTAJE_FINAL}", "", $PRINCIPAL);
                    }
                }
                $estadoaprobado = "si";
                $estilo_alerta_aprobacion == "alert-success";
            }
            //Medallas
           if ($nota_final == 100) {            $medallas = $datos_objeto[0]->medallas;} else {$medallas = 0;}
        } else {
            if ($datos_objeto[0]->checkin == 1) {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/informe/" . $_SESSION["id_empresa"] . "_pantalla_final_evaluacion_incorrecto_checkin.html"));
                $estilo_alerta_aprobacion == "";
            } else {
                //certificacion
                if ($datos_curso[0]->scoid == "CERTIFICACION") {
                    //echo "1.1";
                    $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/informe/" . $_SESSION["id_empresa"] . "_pantalla_final_evaluacion_certificacion.html"));
                } else {
                    //echo "1.2";
                    $resultado_estado = "incorrecto";
                    //echo "incorrecto";
                    $PRINCIPAL        = FuncionesTransversales(file_get_contents("views/cursos/informe/" . $_SESSION["id_empresa"] . "_pantalla_final_evaluacion_incorrecto.html"));
                    if ($datos_objeto[0]->linkabrir == 2) {
                        $PRINCIPAL = str_replace("{BLOQUE_NOTA_PUNTAJE_FINAL}", "", $PRINCIPAL);
                    }
                }
                $estilo_alerta_aprobacion == "";
            }
            $medallas = "0";
        }
    } else {
        //echo "hola13";
        //echo $nota_final." nota final sin nota aprobacion";
        if ($nota_final == 100) {
            //print_r($datos_objeto);
            //echo "26145";
            //$PRINCIPAL=FuncionesTransversales(file_get_contents("views/cursos/informe/51_pantalla_final_evaluacion_correcto.html"));
            if ($datos_objeto[0]->checkin == 1) {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/informe/" . $_SESSION["id_empresa"] . "_pantalla_final_evaluacion_correcto_checkin.html"));
                $estilo_alerta_aprobacion == "alert-success";
            } else {
                if ($datos_curso[0]->scoid == "CERTIFICACION") {
                    $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/informe/" . $_SESSION["id_empresa"] . "_pantalla_final_evaluacion_certificacion.html"));
                 }else{
                    $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/informe/" . $_SESSION["id_empresa"] . "_pantalla_final_evaluacion_correcto.html"));
                 }
                $estilo_alerta_aprobacion == "alert-success";
            }
            //Medallas
            $medallas = $datos_objeto[0]->medallas;
        } else if ($nota_final >= 0 and $nota_final < 100) {
            //print_r($datos_objeto);
            //echo "26156";
            if ($datos_objeto[0]->checkin == 1) {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/informe/" . $_SESSION["id_empresa"] . "_pantalla_final_evaluacion_incorrecto_checkin.html"));
                $estilo_alerta_aprobacion == "";
            } else {
                if ($datos_curso[0]->scoid == "CERTIFICACION") {
                    $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/informe/" . $_SESSION["id_empresa"] . "_pantalla_final_evaluacion_certificacion.html"));
                } else {
                    $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/informe/" . $_SESSION["id_empresa"] . "_pantalla_final_evaluacion_incorrecto.html"));
                }
                $estilo_alerta_aprobacion == "";
            }
            $medallas = "0";
        }
    }
    //
    if ($datos_objeto[0]->titulo_principal <> '' and $resultado_estado == "correcto") {
        $texto_titulo = utf8_encode($datos_objeto[0]->titulo_principal);
    } elseif ($datos_objeto[0]->titulo_principal == '' and $resultado_estado == "correcto") {
        $texto_titulo = "Muy bien, lo hiciste excelente";
    } elseif ($datos_objeto[0]->bajada_principal <> '' and $resultado_estado == "incorrecto") {
        $texto_titulo = utf8_encode($datos_objeto[0]->bajada_principal);
    } elseif ($datos_objeto[0]->bajada_principal == '' and $resultado_estado == "incorrecto") {
        $texto_titulo = "Ups!, no lograste una puntuaci?n perfecta...";
    }
    //echo "resultado_estado $resultado_estado,texto_titulo $texto_titulo";
    if ($tipo == "muestra_detalle_preguntas") {
        $PRINCIPAL = str_replace("{BLOQUE_DETALLE_PREGUNTA}", file_get_contents("views/cursos/informe/" . $_SESSION["id_empresa"] . "_pantalla_final_evaluacion_bloque_detalle_preguntas.html"), $PRINCIPAL);
        if ($datos_objeto[0]->linkabrir == 2 or $datos_objeto[0]->linkabrir == 1) {
            $PRINCIPAL = str_replace("{LISTADO_PREGUNTAS}", "", $PRINCIPAL);
        }
    } else if ($tipo == "reprobado") {
        $PRINCIPAL = str_replace("{BLOQUE_DETALLE_PREGUNTA}", file_get_contents("views/cursos/informe/" . $_SESSION["id_empresa"] . "_pantalla_final_evaluacion_bloque_reintenta_trivia.html"), $PRINCIPAL);
        if ($datos_objeto[0]->linkabrir == 2 or $datos_objeto[0]->linkabrir == 1) {
            $PRINCIPAL = str_replace("{LISTADO_PREGUNTAS}", "", $PRINCIPAL);
        }
    } else {
    }
    if ($datos_objeto[0]->observaciones == "no_muestra_nota_trivia") {
        $PRINCIPAL = str_replace("{BLOQUE_NOTA_PUNTAJE_FINAL}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{TITULO}", $texto_titulo, $PRINCIPAL);
    } else if ($datos_objeto[0]->observaciones) {
        if ($estadoaprobado == "si") {
            $PRINCIPAL = str_replace("{BLOQUE_NOTA_PUNTAJE_FINAL}", "", $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{BLOQUE_NOTA_PUNTAJE_FINAL}", utf8_encode($datos_objeto[0]->observaciones), $PRINCIPAL);
        }
        $PRINCIPAL = str_replace("{TITULO}", $texto_titulo, $PRINCIPAL);
    } else {



      if ($datos_objeto[0]->linkabrir == 2) {

       $PRINCIPAL = str_replace("{BLOQUE_NOTA_PUNTAJE_FINAL}", "", $PRINCIPAL);
      } else {

      $PRINCIPAL = str_replace("{BLOQUE_NOTA_PUNTAJE_FINAL}", file_get_contents("views/cursos/informe/" . $_SESSION["id_empresa"] . "_pantalla_final_evaluacion_bloque_puntaje.html"), $PRINCIPAL);
      }
        $PRINCIPAL = str_replace("{ESTILO_ALERTA_NOTA_FINAL_TRIVIA}", $estilo_alerta_aprobacion, $PRINCIPAL);
        $PRINCIPAL = str_replace("{TITULO}", $texto_titulo, $PRINCIPAL);



    }
    //GamificacionPuntos($rut, $_SESSION["id_empresa"], $id_objeto, $datos_objeto[0]->id_curso, $malla, $puntos_a_sumar, $medallas);
    if ($datos_objeto[0]->tipo_objeto == 7 and $_SESSION["id_empresa"] == 72) {
        GAMIFICACIONInsertaPuntosPorObjeto($rut, $id_objeto, $datos_objeto[0]->id_curso, $_SESSION["id_empresa"], $total_suma_puntos, $medallas);
    } else {
        if ($datos_objeto[0]->scoid == "medallas_por_nota") {
            $medallas = ($datos_objeto[0]->medallas * $nota_final) / 100;
        }
        GAMIFICACIONInsertaPuntosPorObjeto($rut, $id_objeto, $datos_objeto[0]->id_curso, $_SESSION["id_empresa"], $puntos_a_sumar, $medallas);
    }
    $tiene_consolidado_puntos = GAMIFICACIONTienePuntosAcumuladosPorRutEmpresa($rut, $_SESSION["id_empresa"]);
    GAMIFICACIONActualizarDatosConsolidados($rut, $_SESSION["id_empresa"], "", $tiene_consolidado_puntos[0]->nivel);
    $tiene_puntos_acumulados_actualizados = GAMIFICACIONTienePuntosAcumuladosPorRutEmpresa($rut, $_SESSION["id_empresa"]);
    $PRINCIPAL                            = str_replace("{PORCENTAJE_NOTA}", number_format($nota_final, 0), $PRINCIPAL);
    //echo "nota_final $nota_final";
    $PRINCIPAL                            = str_replace("{NOTA_CONVERTIDA_DESDE_PORCENTAJE}", ColocaNotaConvertidaTrivia($nota_final), $PRINCIPAL);
    $PRINCIPAL                            = str_replace("{IMAGEN_POSTERIOR_POSITIVA}", $datos_objeto[0]->imagen_posterior_positivo, $PRINCIPAL);
    $PRINCIPAL                            = str_replace("{TEXTO_POSITIVO}", utf8_encode($datos_objeto[0]->texto_posterior_positivo), $PRINCIPAL);
    $PRINCIPAL                            = str_replace("{IMAGEN_POSTERIOR_NEGATIVO}", $datos_objeto[0]->imagen_posterior_negativo, $PRINCIPAL);
    $PRINCIPAL                            = str_replace("{TEXTO_NEGATIVO}", utf8_encode($datos_objeto[0]->texto_posterior_negativo), $PRINCIPAL);
    $PRINCIPAL                            = str_replace("{TOTAL_SUMA_PUNTAJES}", $total_suma_puntos, $PRINCIPAL);
    $PRINCIPAL                            = str_replace("{TOTAL_CORRECTAS}", $correctas, $PRINCIPAL);
    $PRINCIPAL                            = str_replace("{TOTAL_PREGUNTAS}", count($datos_preguntas), $PRINCIPAL);
    $PRINCIPAL                            = str_replace("{PORCENTAJE_APROBACION}", $datos_objeto[0]->nota_aprobacion, $PRINCIPAL);
    //$PRINCIPAL = str_replace("{PUNTOS}",$tiene_puntos_acumulados_actualizados[0]->puntos,$PRINCIPAL);
    $PRINCIPAL                            = str_replace("{PUNTOS}", ColocaDecimalesNotasFinales(0, $puntos_a_sumar), $PRINCIPAL);
    //$PRINCIPAL = str_replace("{MEDALLAS}",$tiene_puntos_acumulados_actualizados[0]->medallas,$PRINCIPAL);
    $PRINCIPAL                            = str_replace("{MEDALLAS}", $datos_objeto[0]->medallas, $PRINCIPAL);
    $PRINCIPAL                            = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($datos_objeto[0]->id), $PRINCIPAL);
    $dato_aprueba_reprueba                = ApruebaReprueba($nota_final);
    $PRINCIPAL                            = str_replace("{ESTADO_NOTA_FINAL}", $dato_aprueba_reprueba[0], $PRINCIPAL);
    $PRINCIPAL                            = str_replace("{NOMBRE_IMAGEN}", $dato_aprueba_reprueba[1], $PRINCIPAL);
    $PRINCIPAL                            = str_replace("{LISTADO_PREGUNTAS}", utf8_encode($total_preguntas), $PRINCIPAL);
    $PRINCIPAL                            = str_replace("{ESTILO_NOTA_FINAL}", $dato_aprueba_reprueba[4], $PRINCIPAL);
    //////////////*****************************
    /////////////////////////////////////////
    /////////////////SECCION PARA EL LISTADO DE CONDUCTAS
    $programa                             = Decodear($_SESSION["programa"]);
    $conductas                            = ObtenerConductasPorPrograma($programa);
    $total_conductas                      = "";
    if ($conductas) {
        foreach ($conductas as $cond) {
            $total_conductas .= file_get_contents("views/cursos/informe/row_informe_eval_conductas.html");
            //por cada conducta, veo las pregutnas
            $respuestas_por_conducta = RespuestasDadoConductas($rut, $cond->id, $id_evaluacion);
            $correcta                = 0;
            $incorrecta              = 0;
            foreach ($respuestas_por_conducta as $res_con) {
                if ($res_con->correcta == "1") {
                    $correcta++;
                } else {
                    $incorrecta++;
                }
            }
            $nota            = (100 * $correcta) / count($respuestas_por_conducta);
            $coloresyrangos  = ColoresYRangos($nota);
            //print_r($coloresyrangos);
            $total_conductas = str_replace("{PORCENTAJE}", $coloresyrangos[2], $total_conductas);
            $total_conductas = str_replace("{COLOR}", $coloresyrangos[1], $total_conductas);
            $total_conductas = str_replace("{CATEGORIA}", $coloresyrangos[0], $total_conductas);
            $total_conductas = str_replace("{NOMBRE_CONDUCTA}", utf8_encode($cond->nombre), $total_conductas);
        }
    } else {
        $PRINCIPAL = str_replace("{SECCION_CONDUCTAS}", "", $PRINCIPAL);
    }
    $PRINCIPAL = str_replace("{LISTADO_CONDUCTAS}", $total_conductas, $PRINCIPAL);
    //ObtieneIdDadoIdObjeto($id_objeto);
    return ($PRINCIPAL);
}
function MuestraAlternativas($id_grupo_alternativas, $id_pregunta, $id_objeto, $rut, $numero_intento)
{
    //echo " <br>$numero_intento numero intento<br> rut $rut <br>";
    $datos_objeto = DatosObjeto($id_objeto);
    $alternativas = AlternativasDadoId($id_grupo_alternativas);
    if ($datos_objeto[0]->urlmoodle == 2) {
        shuffle($alternativas);
    } else if ($datos_objeto[0]->urlmoodle == 3) {
        $arreglo_alternativas_cortados = array_slice($alternativas, 0, count($alternativas) - 1);
        //print_r($arreglo_alternativas_cortados);
        shuffle($arreglo_alternativas_cortados);
        $alternativas_aux                             = $arreglo_alternativas_cortados;
        $alternativas_aux[(count($alternativas) - 1)] = $alternativas[(count($alternativas) - 1)];
        $alternativas                                 = $alternativas_aux;
    }
    if ($alternativas[0]->imagen) {
        $opciones = "<table width='100%'><tr>";
        foreach ($alternativas as $alt) {
            $opciones .= "<tr><td>
    <a href='?sw=savanswG&" . ($id_pregunta) . "=" . Encodear($alt->id) . "&idp={ID_PREGUNTA_ENCODEADO}&ido={ID_OBJETO_ENCODEADO}'>
    <img width='100%' src='" . $alt->imagen . "'>
    </a>
    <br><br></td></tr>";
        }
        $opciones .= "</table>";
    } else {
        foreach ($alternativas as $alt) {
            //$opciones.="<input style='opacity: 0; margin: 0px;' class='radio1 checkator_source'  name='".Encodear($id_pregunta)."' type='radio' value='".Encodear($alt->id)."' required='required'> ".$alt->alternativa."</input><br><br>";
            $opciones .= file_get_contents("views/cursos/evaluacion/opcion_alternativa.html");
            $opciones = str_replace("{NOMBRE_OPTION}", Encodear($id_pregunta), $opciones);
            $opciones = str_replace("{VALUE_OPTION}", Encodear($alt->id), $opciones);
            $opciones = str_replace("{ALTERNATIVA_DESCRIPCION}", $alt->alternativa, $opciones);

            $tiene_alte=TieneRespuestaPorObjetiAlternativaPreguntaRut($rut, $id_objeto, $id_pregunta, $alt->id, $numero_intento);
if($tiene_alte){
$opciones = str_replace("{CHECKED}", "checked", $opciones);
}else{
$opciones = str_replace("{CHECKED}", "", $opciones);
}

        }
    }
    return ($opciones);
}
function MuestraEvaluacion($id_evaluacion, $rut, $id_objeto, $numero_intento, $nuevo_intento_por_imparticion)
{


    //function MuestraEvaluacion($PRINCIPAL, $id_evaluacion, $rut){
    //ID_EVALUACION CORRESPONDE AL ID DEL OBJETO
    $datos_objeto             = DatosObjeto($id_evaluacion);
    $id_evaluacion_por_objeto = $datos_objeto[0]->id_evaluacion; //Id de la evaluacion. Este es el que se obtiene desde el campo id evaluacion de la tabla objeto
    $datos_evaluacion         = DatosEvaluacion($datos_objeto[0]->id_evaluacion);
    //Veo si est? en la tabla sesion esta evaluacion, y este usuario
    if ($datos_evaluacion[0]->descripcion <> '') {
        $contexto_descripcion = '<div class="lms_backcolor">
    <div class="panel panel-default" data-toggle="panel-collapse" data-open="true">
    <section class="panel bordes">
    <div class="panel-body panel-gray ">    ' . $datos_evaluacion[0]->descripcion . '</div>
    </section></div></div>';
    }
    $tiene_sesion    = SesionEvaluacionContenidos($id_evaluacion, $rut);
    $total_preguntas = PreguntasDadoEvaluacion($id_evaluacion_por_objeto);
    //ACA VALIDA SI ES QUE EL OBJETO, QUE CONTIENE ESTA EVALUACION, TIENE PREGUNTAS ALEATORIAS O NO.
    //SI NO TIENE ALEATORIAS, LAS MUESTRA TODAS
    if ($datos_objeto[0]->preguntas_aleatorias > 0) {
        //Asigno a una tabla,si es que no esta asignado obviamente. La cantidad que corresponda de preguntas, asociadas al rut, curso y objeto.
        $tiene_preguntas_asociadas = VerificaSiTienePReguntasAsociadasRandomicas($rut, $id_evaluacion_por_objeto, $datos_objeto[0]->id);
        if (count($tiene_preguntas_asociadas) == 0) {
            shuffle($total_preguntas);
            $vueltas = 1;
            foreach ($total_preguntas as $pre) {
                InsertoRegistroPreguntasAleatorias($rut, $id_evaluacion_por_objeto, $datos_objeto[0]->id, $vueltas, $pre->id, $datos_objeto[0]->id_curso);
                if ($vueltas == $datos_objeto[0]->preguntas_aleatorias)
                    break;
                $vueltas++;
            }
        }
        if ($tiene_sesion) {
            $pagina   = $tiene_sesion[0]->pagina;
            $pregunta = PreguntaDeEvaluacionAleatorias($id_evaluacion_por_objeto, $pagina, $rut, $datos_objeto[0]->id);
            if ($_SESSION["id_empresa"] == 51) {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/evaluacion/51_" . $pregunta[0]->template_pregunta));
            } elseif ($_SESSION["id_empresa"] == 52) {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/evaluacion/52_" . $pregunta[0]->template_pregunta));
            } elseif ($_SESSION["id_empresa"] == 59) {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/evaluacion/59_" . $pregunta[0]->template_pregunta));
            } elseif ($_SESSION["id_empresa"] == 61) {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/evaluacion/61_" . $pregunta[0]->template_pregunta));
            } elseif ($_SESSION["id_empresa"] == 63) {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/evaluacion/63_" . $pregunta[0]->template_pregunta));
            } elseif ($_SESSION["id_empresa"] == 65) {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/evaluacion/65_" . $pregunta[0]->template_pregunta));
            } elseif ($_SESSION["id_empresa"] == 72) {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/evaluacion/72_" . $pregunta[0]->template_pregunta));
            } else {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/evaluacion/" . $_SESSION["id_empresa"] . "_" . $pregunta[0]->template_pregunta));
                //echo "views/cursos/evaluacion/".$_SESSION["id_empresa"]."_".$pregunta[0]->template_pregunta;
            }
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA}", ($pregunta[0]->pregunta), $PRINCIPAL);
            //Funcion para mostrar las alternativas
            $PRINCIPAL = str_replace("{OPCIONES}", MuestraAlternativas($pregunta[0]->id_grupo_alternativas, $pregunta[0]->id, $datos_objeto[0]->id, $rut, $numero_intento), $PRINCIPAL);
            $PRINCIPAL = str_replace("{ID_PREGUNTA_ENCODEADO}", Encodear3($pregunta[0]->id), $PRINCIPAL);
            $PRINCIPAL = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($id_evaluacion), $PRINCIPAL);
            $PRINCIPAL = str_replace("{URL_IMAGEN}", $pregunta[0]->url_archivo, $PRINCIPAL);
            $PRINCIPAL = str_replace("{NUMERO_PREGUNTA}", $pagina, $PRINCIPAL);
            $PRINCIPAL = str_replace("{DESCRIPCION_EVALUACION}", $contexto_descripcion, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA1}", $pregunta[0]->bajada1, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA2}", $pregunta[0]->bajada2, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA3}", $pregunta[0]->bajada3, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA4}", $pregunta[0]->bajada4, $PRINCIPAL);
            //echo $pagina;
            if ($pagina > 1) {
                $PRINCIPAL = str_replace("{BOTON_ATRAS_Y_GUARDAR}", file_get_contents("views/cursos/evaluacion/boton_volver_atras.html"), $PRINCIPAL);
            } else {
                $PRINCIPAL = str_replace("{BOTON_ATRAS_Y_GUARDAR}", "", $PRINCIPAL);
            }
        } else {
            $pagina = 1;
            //Ingreso el registro de la sesion con pagina 1
            InsertaRegistroTablaSesionEvaluacionContenido($rut, $id_evaluacion, $pagina);
            $pregunta = PreguntaDeEvaluacionAleatorias($id_evaluacion_por_objeto, $pagina, $rut, $datos_objeto[0]->id);
            if ($_SESSION["id_empresa"] == 51) {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/evaluacion/51_" . $pregunta[0]->template_pregunta));
            } elseif ($_SESSION["id_empresa"] == 52) {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/evaluacion/52_" . $pregunta[0]->template_pregunta));
            } elseif ($_SESSION["id_empresa"] == 59) {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/evaluacion/59_" . $pregunta[0]->template_pregunta));
            } elseif ($_SESSION["id_empresa"] == 61) {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/evaluacion/61_" . $pregunta[0]->template_pregunta));
            } elseif ($_SESSION["id_empresa"] == 63) {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/evaluacion/63_" . $pregunta[0]->template_pregunta));
            } elseif ($_SESSION["id_empresa"] == 65) {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/evaluacion/65_" . $pregunta[0]->template_pregunta));
            } elseif ($_SESSION["id_empresa"] == 72) {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/evaluacion/72_" . $pregunta[0]->template_pregunta));
            } else {
                $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/evaluacion/" . $_SESSION["id_empresa"] . "_" . $pregunta[0]->template_pregunta));
            }
            //$PRINCIPAL=FuncionesTransversales(file_get_contents("views/cursos/evaluacion/".$pregunta[0]->template_pregunta));
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA}", ($pregunta[0]->pregunta), $PRINCIPAL);
            //Funcion para mostrar las alternativas
            $PRINCIPAL = str_replace("{OPCIONES}", MuestraAlternativas($pregunta[0]->id_grupo_alternativas, $pregunta[0]->id, $datos_objeto[0]->id, $rut, $numero_intento), $PRINCIPAL);
            $PRINCIPAL = str_replace("{ID_PREGUNTA_ENCODEADO}", Encodear3($pregunta[0]->id), $PRINCIPAL);
            $PRINCIPAL = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($id_evaluacion), $PRINCIPAL);
            $PRINCIPAL = str_replace("{NUMERO_PREGUNTA}", $pagina, $PRINCIPAL);
            $PRINCIPAL = str_replace("{URL_IMAGEN}", $pregunta[0]->url_archivo, $PRINCIPAL);
            $PRINCIPAL = str_replace("{DESCRIPCION_EVALUACION}", $contexto_descripcion, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA1}", $pregunta[0]->bajada1, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA2}", $pregunta[0]->bajada2, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA3}", $pregunta[0]->bajada3, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA4}", $pregunta[0]->bajada4, $PRINCIPAL);
            //echo $pagina;
            if ($pagina > 1) {
                $PRINCIPAL = str_replace("{BOTON_ATRAS_Y_GUARDAR}", file_get_contents("views/cursos/evaluacion/boton_volver_atras.html"), $PRINCIPAL);
            } else {
                $PRINCIPAL = str_replace("{BOTON_ATRAS_Y_GUARDAR}", "", $PRINCIPAL);
            }
        }
    } else {
        //exit("1");
        if ($tiene_sesion) {
            $pagina    = $tiene_sesion[0]->pagina;
            $pregunta  = PreguntaDeEvaluacion($id_evaluacion_por_objeto, $pagina);
            $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/evaluacion/" . $_SESSION["id_empresa"] . "_" . $pregunta[0]->template_pregunta));
            //$PRINCIPAL=FuncionesTransversales(file_get_contents("views/cursos/evaluacion/$id_empresa_".$pregunta[0]->template_pregunta));
            //echo "views/cursos/evaluacion/$id_empresa_".$pregunta[0]->template_pregunta;
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA}", ($pregunta[0]->pregunta), $PRINCIPAL);
            //Funcion para mostrar las alternativas
            $PRINCIPAL = str_replace("{OPCIONES}", MuestraAlternativas($pregunta[0]->id_grupo_alternativas, $pregunta[0]->id, $datos_objeto[0]->id, $rut, $numero_intento), $PRINCIPAL);
            $PRINCIPAL = str_replace("{ID_PREGUNTA_ENCODEADO}", Encodear3($pregunta[0]->id), $PRINCIPAL);
            $PRINCIPAL = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($id_evaluacion), $PRINCIPAL);
            $PRINCIPAL = str_replace("{URL_IMAGEN}", $pregunta[0]->url_archivo, $PRINCIPAL);
            $PRINCIPAL = str_replace("{NUMERO_PREGUNTA}", $pregunta[0]->orden, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA1}", $pregunta[0]->bajada1, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA2}", $pregunta[0]->bajada2, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA3}", $pregunta[0]->bajada3, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA4}", $pregunta[0]->bajada4, $PRINCIPAL);
            $PRINCIPAL = str_replace("{DESCRIPCION_EVALUACION}", $contexto_descripcion, $PRINCIPAL);
            //echo $pagina;
            if ($pagina > 1) {
                $PRINCIPAL = str_replace("{BOTON_ATRAS_Y_GUARDAR}", file_get_contents("views/cursos/evaluacion/boton_volver_atras.html"), $PRINCIPAL);
            } else {
                $PRINCIPAL = str_replace("{BOTON_ATRAS_Y_GUARDAR}", "", $PRINCIPAL);
            }
        } else {
            $pagina   = 1;
            //obtengo la primera pregunta
            $pregunta = PreguntaDeEvaluacion($id_evaluacion_por_objeto, $pagina);
            //Inserto en la tabla de sesion la pgina 1.
            InsertaRegistroTablaSesionEvaluacionContenido($rut, $id_evaluacion, "1");
            //$PRINCIPAL=FuncionesTransversales(file_get_contents("views/cursos/evaluacion/$id_empresa_".$pregunta[0]->template_pregunta));
            $PRINCIPAL = FuncionesTransversales(file_get_contents("views/cursos/evaluacion/" . $_SESSION["id_empresa"] . "_" . $pregunta[0]->template_pregunta));
            //$PRINCIPAL=FuncionesTransversales(file_get_contents("views/cursos/evaluacion/".$_SESSION["id_empresa"]."_".$pregunta[0]->template_pregunta));
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA}", ($pregunta[0]->pregunta), $PRINCIPAL);
            //Funcion para mostrar las alternativas
            $PRINCIPAL = str_replace("{OPCIONES}", MuestraAlternativas($pregunta[0]->id_grupo_alternativas, $pregunta[0]->id, $datos_objeto[0]->id, $rut, $numero_intento), $PRINCIPAL);
            $PRINCIPAL = str_replace("{ID_PREGUNTA_ENCODEADO}", Encodear3($pregunta[0]->id), $PRINCIPAL);
            $PRINCIPAL = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($id_evaluacion), $PRINCIPAL);
            $PRINCIPAL = str_replace("{NUMERO_PREGUNTA}", $pregunta[0]->orden, $PRINCIPAL);
            $PRINCIPAL = str_replace("{URL_IMAGEN}", $pregunta[0]->url_archivo, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA1}", $pregunta[0]->bajada1, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA2}", $pregunta[0]->bajada2, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA3}", $pregunta[0]->bajada3, $PRINCIPAL);
            $PRINCIPAL = str_replace("{TEXTO_PREGUNTA_BAJADA4}", $pregunta[0]->bajada4, $PRINCIPAL);
            $PRINCIPAL = str_replace("{DESCRIPCION_EVALUACION}", $contexto_descripcion, $PRINCIPAL);
            //echo $pagina;
            if ($pagina > 1) {
                $PRINCIPAL = str_replace("{BOTON_ATRAS_Y_GUARDAR}", file_get_contents("views/cursos/evaluacion/boton_volver_atras.html"), $PRINCIPAL);
            } else {
                $PRINCIPAL = str_replace("{BOTON_ATRAS_Y_GUARDAR}", "", $PRINCIPAL);
            }
        }
    }
    //PAGINACION////////////
    if ($datos_objeto[0]->preguntas_aleatorias > 0) {
        $total_preguntas = VerificaSiTienePReguntasAsociadasRandomicas($rut, $id_evaluacion_por_objeto, $datos_objeto[0]->id);
    } else {
        $total_preguntas = PreguntasDadoEvaluacion($id_evaluacion_por_objeto);
    }
    $PRINCIPAL     = str_replace("{ENTORNO_PAGINACION}", ArmaPaginacionEvaluacion($total_preguntas, $pagina), $PRINCIPAL);
    $PRINCIPAL     = str_replace("{ID_PREGUNTA_ENCODEADO}", Encodear3($id_evaluacion_por_objeto), $PRINCIPAL);
    $PRINCIPAL     = str_replace("{NAME_FORMULARIO}", "FormRespuestas", $PRINCIPAL);
    $PRINCIPAL     = str_replace("{VALOR_BOTON}", "Guardar y Avanzar", $PRINCIPAL);
    $PRINCIPAL     = str_replace("{NOMBRE_EVALUACION}", $datos_evaluacion[0]->nombre_evaluacion, $PRINCIPAL);
    $PRINCIPAL     = str_replace("{NOMBRE_OBJETO}", $datos_evaluacion[0]->nombre_evaluacion, $PRINCIPAL);
    $PRINCIPAL     = str_replace("{DESCRIPCION_EVALUACION}", $contexto_descripcion, $PRINCIPAL);
    $datos_usuario = UsuarioEnBasePersonas($rut);
    $PRINCIPAL     = str_replace("{NOMBRE_USUARIO}", ($datos_usuario[0]->nombre_completo), $PRINCIPAL);
    return ($PRINCIPAL);
}
function EstadoObjeto($id_objeto, $rut)
{
    $estado_objeto = VerObjetoFinalizado($id_objeto, $rut);
    if ($estado_objeto) {
        $arreglo[0] = "completo.png";
        $arreglo[1] = "si";
    } else {
        $arreglo[0] = "pendiente.png";
        $arreglo[1] = "no";
    }
    return ($arreglo);
}
function MuestraContenido($PRINCIPAL, $id_objeto, $rut)
{
    $datos_usuario = UsuarioEnBasePersonas($rut);
    $PRINCIPAL     = str_replace("{NOMBRE_USUARIO}", utf8_encode($datos_usuario[0]->nombre_completo), $PRINCIPAL);
    //Traigo los datos del Objetos
    $datos_objeto  = DatosObjeto($id_objeto);
    if ($datos_objeto[0]->extension_objeto) {
        //CAMPOS PARA SESSIONS
        //Esto quiere decir que tiene algun tipo de extension el objeto
        $datos_extension = DatosExtensionDeObjeto($datos_objeto[0]->extension_objeto);
        $deviceipad      = strtolower($_SERVER[""]);
        $deviceipod      = strtolower($_SERVER[""]);
        //$datos_navegador=DetectaSistema();
        $datos_navegador = MobileDetectFunction();
        //Si es PC
        if ($datos_navegador[0] == 3) {
            //$template_objeto=file_get_contents($datos_extension[0]->template);
            $template_objeto = ($datos_extension[0]->template);
            //$template_objeto = str_replace("{URL_OBJETO_LINK}",$datos_objeto[0]->url_objeto,$template_objeto);
            $PRINCIPAL       = str_replace("{BLOQUE_OBJETO}", file_get_contents($template_objeto), $PRINCIPAL);
            //$PRINCIPAL = str_replace("{BLOQUE_OBJETO}",$template_objeto,$PRINCIPAL);
            $PRINCIPAL       = str_replace("{URL_OBJETO}", $datos_extension[0]->template, $PRINCIPAL);
            $PRINCIPAL       = str_replace("{BLOQUE_OBJETO}", $template_objeto, $PRINCIPAL);
            $PRINCIPAL       = str_replace("{NOMBRE_DOCUMENTO}", $datos_objeto[0]->url_objeto, $PRINCIPAL);
            $PRINCIPAL       = str_replace("{NOMBRE_VIDEO_MP4}", $datos_objeto[0]->url_objeto, $PRINCIPAL);
            $PRINCIPAL       = str_replace("{URL_OBJETO_LINK}", $datos_objeto[0]->url_objeto, $PRINCIPAL);
            $PRINCIPAL       = str_replace("{EXTENSION_OBJETO}", $datos_objeto[0]->duracion_video, $PRINCIPAL);
        }
        //Si es Tablet
        else if ($datos_navegador[0] == 1) {
            $template_objeto = file_get_contents($datos_extension[0]->template_android);
            $PRINCIPAL       = str_replace("{BLOQUE_OBJETO}", $template_objeto, $PRINCIPAL);
            $PRINCIPAL       = str_replace("{NOMBRE_DOCUMENTO}", $datos_objeto[0]->url_objeto, $PRINCIPAL);
            $PRINCIPAL       = str_replace("{NOMBRE_VIDEO_MP4}", $datos_objeto[0]->url_objeto, $PRINCIPAL);
            $PRINCIPAL       = str_replace("{URL_OBJETO_LINK}", $datos_objeto[0]->url_objeto, $PRINCIPAL);
            $PRINCIPAL       = str_replace("{EXTENSION_OBJETO}", $datos_objeto[0]->duracion_video, $PRINCIPAL);
        }
        //Si es Mobile
        else if ($datos_navegador[0] == 2) {
            if (strstr($_SERVER['HTTP_USER_AGENT'], 'iPhone') || strstr($_SERVER['HTTP_USER_AGENT'], 'iPod')) {
                $template_objeto = file_get_contents($datos_extension[0]->template_iphone);
            } else {
                $template_objeto = file_get_contents($datos_extension[0]->template_android);
            }
            $PRINCIPAL = str_replace("{BLOQUE_OBJETO}", $template_objeto, $PRINCIPAL);
            $PRINCIPAL = str_replace("{NOMBRE_DOCUMENTO}", $datos_objeto[0]->url_objeto, $PRINCIPAL);
            $PRINCIPAL = str_replace("{NOMBRE_VIDEO_MP4}", $datos_objeto[0]->url_objeto, $PRINCIPAL);
            $PRINCIPAL = str_replace("{URL_OBJETO_LINK}", $datos_objeto[0]->url_objeto, $PRINCIPAL);
            $PRINCIPAL = str_replace("{EXTENSION_OBJETO}", $datos_objeto[0]->duracion_video, $PRINCIPAL);
        }
        //PARA SESSIONS
        $PRINCIPAL = str_replace("{TITULO}", utf8_encode($datos_objeto[0]->titulo), $PRINCIPAL);
        $PRINCIPAL = str_replace("{TEXTO_BAJADA}", utf8_encode($datos_objeto[0]->texto_bajada), $PRINCIPAL);
        $PRINCIPAL = str_replace("{BAJADA}", utf8_encode($datos_objeto[0]->bajada), $PRINCIPAL);
        $PRINCIPAL = str_replace("{URL_VIDEO}", utf8_encode($datos_objeto[0]->video), $PRINCIPAL);
        $PRINCIPAL = str_replace("{TRANSCRIPCION}", utf8_encode($datos_objeto[0]->transcripcion), $PRINCIPAL);
        if ($datos_objeto[0]->rut_relator) {
            $PRINCIPAL = str_replace("{BLOQUE_RELATOR}", file_get_contents("views/cursos/contenidos/bloque_relator_con_link.html"), $PRINCIPAL);
            $PRINCIPAL = str_replace("{RUT_RELATOR_ENCODEADO}", Encodear3($datos_objeto[0]->rut_relator), $PRINCIPAL);
        } else {
            $PRINCIPAL = str_replace("{BLOQUE_RELATOR}", file_get_contents("views/cursos/contenidos/bloque_relator_sin_link.html"), $PRINCIPAL);
        }
        $PRINCIPAL = str_replace("{BIO_RELATOR}", utf8_encode($datos_objeto[0]->bio_relator), $PRINCIPAL);
        $PRINCIPAL = str_replace("{URL_IMAGEN_RELATOR}", utf8_encode($datos_objeto[0]->foto_relator), $PRINCIPAL);
        $PRINCIPAL = str_replace("{URL_MIPERFIL}", VerificaFotoPersonal($rut), $PRINCIPAL);
        //Bloque con textos
        $PRINCIPAL = str_replace("{RESUMEN_EJECUTIVO}", ColocaBloqueTextosPorObjeto($datos_objeto[0]->id), $PRINCIPAL);
        //Bloque con citas
        $PRINCIPAL = str_replace("{ENTORNO_CITA}", ColocaBloqueCitasPorObjeto($datos_objeto[0]->id), $PRINCIPAL);
        //BLOQUE MP3
        $PRINCIPAL = str_replace("{ENTORNO_DOCUMENTOS}", ColocaBloqueDocumentosPorObjeto($datos_objeto[0]->id), $PRINCIPAL);
        //Bloque para Documentos
        $PRINCIPAL = str_replace("{ENTORNO_MP3}", ColocaBloqueMP3PorObjeto($datos_objeto[0]->id), $PRINCIPAL);
        //Bloque para Pregunta
        $PRINCIPAL = str_replace("{ENTORNO_PREGUNTA}", ColocaBloquePreguntaPorObjeto($datos_objeto[0]->id, $rut, 1), $PRINCIPAL);
        //Bloque para Pregunta
        $PRINCIPAL = str_replace("{ENTORNO_PREGUNTA_UNICA_POR_OBJETO}", ColocaBloquePreguntaPorObjetoUnicaRadio($datos_objeto[0]->id, $rut, 1), $PRINCIPAL);
        //Bloque para Comentarios - Post
        $PRINCIPAL = str_replace("{LISTADO_COMENTARIOS}", ColocaBloqueComentariosPorObjeto($datos_objeto[0]->id, $rut), $PRINCIPAL);
        //Bloque para Pregunta 2
        $PRINCIPAL = str_replace("{ENTORNO_PREGUNTA_2}", ColocaBloquePreguntaPorObjeto($datos_objeto[0]->id, $rut, 2), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_OBJETO}", file_get_contents("views/cursos/contenidos/bloque_iframe.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{URL_OBJETO}", $datos_objeto[0]->url, $PRINCIPAL);
        $PRINCIPAL = str_replace("{EXTENSION_OBJETO}", $datos_objeto[0]->duracion_video, $PRINCIPAL);
    }
    //Dado la extension del objeto, traigo el template a utilizar por el tipo de objeto.
    $PRINCIPAL         = str_replace("{NOMBRE_OBJETO}", utf8_encode($datos_objeto[0]->titulo), $PRINCIPAL);
    $PRINCIPAL         = str_replace("{NUMERO_OBJETO}", ($datos_objeto[0]->orden), $PRINCIPAL);
    //Seccion del Cronometro
    $PRINCIPAL         = BarraNavegacion($PRINCIPAL, "contenido");
    $PRINCIPAL         = str_replace("{CRONOMETRO_PARA_CONTENIDOS}", file_get_contents("views/cursos/contenidos/cronometro.html"), $PRINCIPAL);
    //Verifico si esta finalizado o no este objetos
    $objeto_finalizado = VerObjetoFinalizado($id_objeto, $rut);
    if ($objeto_finalizado) {
        $PRINCIPAL = str_replace("{BOTON_VOLVER}", file_get_contents("views/cursos/contenidos/boton_volver_curso.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_CURSO_ENCODEADO_VOLVER}", Encodear3($datos_objeto[0]->id_curso), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($id_objeto), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ENVBOTON}", "backcont", $PRINCIPAL);
        $PRINCIPAL = str_replace("{BOTON_FINALIZAR}", file_get_contents("views/cursos/contenidos/boton_siguiente_curso.html"), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BOTON_FINALIZAR}", file_get_contents("views/cursos/contenidos/boton_finaliza_curso.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_OBJETIVO_ENCODEADO}", Encodear3($id_objeto), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ENVBOTON}", "fincont", $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($id_objeto), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_CURSO_ENCODEADO}", Encodear3($datos_objeto[0]->id_curso), $PRINCIPAL);
        $PRINCIPAL = str_replace("{BOTON_VOLVER}", file_get_contents("views/cursos/contenidos/boton_volver_curso.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_CURSO_ENCODEADO_VOLVER}", Encodear3($datos_objeto[0]->id_curso), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($id_objeto), $PRINCIPAL);
        $PRINCIPAL = str_replace("{ENVBOTON}", "backcont", $PRINCIPAL);
    }
    return ($PRINCIPAL);
}
function ListadoObjetos($PRINCIPAL, $id_curso, $rut, $tipo)
{
    $objetos                     = ObjetosDadoCurso($id_curso, $rut);
    $detalle_curso               = DetalleCursoConSumaNavegacionPorObjeto($id_curso);
    $datos_usuario_cruce_empresa = UsuarioEnBasePersonasCruceEmpresa2($rut);
    $PRINCIPAL                   = str_replace("{DESCRIPCION}", utf8_encode($detalle_curso[0]->descripcion), $PRINCIPAL);
    $PRINCIPAL                   = str_replace("{DESCRIPCION_CURSO}", utf8_encode($detalle_curso[0]->descripcion), $PRINCIPAL);
    $PRINCIPAL                   = str_replace("{FECHAS}", $detalle_curso[0]->fecha_inicio . " - " . $detalle_curso[0]->fecha_finalizacion, $PRINCIPAL);
    $PRINCIPAL                   = str_replace("{DESCRIPCION_CURSO}", utf8_encode($detalle_curso[0]->descripcion), $PRINCIPAL);
    $porcentaje_avance_curso     = PorcentajeAvanceCurso($id_curso, $rut);
    $PRINCIPAL                   = str_replace("{ETIQUETA_FONDO_ESTADO}", $porcentaje_avance_curso[6], $PRINCIPAL);
    $PRINCIPAL                   = str_replace("{COLOR_ESTADO}", $porcentaje_avance_curso[5], $PRINCIPAL);
    $PRINCIPAL                   = str_replace("{PORCENTAJE_AVANCE}", $porcentaje_avance_curso[1], $PRINCIPAL);
    $PRINCIPAL                   = str_replace("{COMPLETO_INCOMPLETO}", $porcentaje_avance_curso[0], $PRINCIPAL);
    $PRINCIPAL                   = str_replace("{METODOLOGIA}", utf8_encode($detalle_curso[0]->nombre_modalidad), $PRINCIPAL);
    $PRINCIPAL                   = str_replace("{BAJADA_CURSO}", utf8_encode($detalle_curso[0]->bajada), $PRINCIPAL);
    $PRINCIPAL                   = str_replace("{IMAGEN}", utf8_encode($detalle_curso[0]->imagen), $PRINCIPAL);
    if ($detalle_curso[0]->imagen) {
        $PRINCIPAL = str_replace("{BLOQUE_IMAGEN_CURSO}", file_get_contents("views/cursos/template_imagen_curso.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{IMG_IMAGEN_CURSO}", "img/logos_cursos/" . $detalle_curso[0]->imagen, $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_IMAGEN_CURSO}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{IMG_IMAGEN_CURSO}", "img/img_curso.jpg", $PRINCIPAL);
    }
    //con esta funcion, pasando el rut y el id del curso, me devuelve los minutos navegados
    $navegacion_por_curso = SumaNavegacionesDadoRutYCurso($rut, $id_curso);
    $PRINCIPAL            = str_replace("{MINUTOS_NAVEGADOS}", $navegacion_por_curso[0]->total_tiempo, $PRINCIPAL);
    $PRINCIPAL            = str_replace("{MINUTOS_TOTAL_POR_CURSO}", $detalle_curso[0]->suma_total_tiempo, $PRINCIPAL);
    $total_html           = "";
    if (count($objetos) == 0) {
        echo "
    <script>
    alert('Este curso no posee objetos asociados');
    location.href='?sw=" . $datos_usuario_cruce_empresa[0]->case_home . "';
    </script>";
        exit;
    }
    foreach ($objetos as $unico) {
        //Primero verifico si la anterior esta finalizada y todo esto solo si es mayor a 1
        if ($unico->orden > 1) {
            //Ahora verifico que la anterior est? finalizada, sino lo est?, muestro el template de lectura
            //primero obtengo el anterior
            $objeto_anterior     = DatosObjetoDadoRutCursoyOrden($id_curso, $unico->orden - 1);
            //Ahora veo si el anterior esta finalizado, junto al rut del usuario
            $final_objt_anterior = ObjetoFinalizadoDadoIdYRut($rut, $objeto_anterior[0]->id);
            if ($final_objt_anterior) {
                $ve_si_esta_finalizada = VerObjetoFinalizado($unico->id, $rut);
                if ($ve_si_esta_finalizada) {
                    $fila = file_get_contents("views/cursos/row_objeto_finalizado.html");
                } else {
                    $fila = file_get_contents("views/cursos/row_objeto.html");
                }
            } else {
                $fila = file_get_contents("views/cursos/row_objeto_desactivado.html");
            }
        } else {
            $ve_si_esta_finalizada = VerObjetoFinalizado($unico->id, $rut);
            if ($ve_si_esta_finalizada) {
                $fila = file_get_contents("views/cursos/row_objeto_finalizado.html");
            } else {
                $fila = file_get_contents("views/cursos/row_objeto.html");
            }
        }
        if ($tipo == "sessions") {
            $fila = file_get_contents("views/cursos/row_objeto_sessions.html");
        }
        if ($unico->tipo_de_objeto == "3") {
            $fila = str_replace("{TIEMPOMODULO_O_NUM_PREGUNTAS}", $unico->duracion_video, $fila);
        } else if ($unico->tipo_de_objeto == "5") {
            $fila = str_replace("{TIEMPOMODULO_O_NUM_PREGUNTAS}", "<b>Cantidad Preguntas: " . $unico->total_preguntas_por_objeto . "</b>", $fila);
        }
        $fila   = str_replace("{TIEMPOMODULO_O_NUM_PREGUNTAS}", "", $fila);
        $fila   = str_replace("{NOMBRE_OBJETO}", $unico->titulo, $fila);
        $fila   = str_replace("{TIPO_OBJETO}", $unico->tipo_objeto, $fila);
        $fila   = str_replace("{CLASE_ICONO}", $unico->icono, $fila);
        $fila   = str_replace("{BAJADA1}", $unico->bajada, $fila);
        $fila   = str_replace("{BAJADA2}", $unico->texto_bajada, $fila);
        $fila   = str_replace("{IMAGEN_MODULO}", $unico->imagen, $fila);
        $fila   = str_replace("{IMAGEN_MODULO_DINAMICO}", $unico->imagen, $fila);
        $fila   = str_replace("{AMBIENTE}", $unico->ambiente, $fila);
        $fila   = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($unico->id), $fila);
        $estado = EstadoObjeto($unico->id, $rut);
        //Estados
        if ($estado[1] == "si") {
            $total_finalizados++;
        }
        $fila = str_replace("{ICONO_ESTADO}", $estado[0], $fila);
        if ($unico->total_tiempo) {
            $fila = str_replace("{TIEMPO_NAVEGACION}", "<i class='fa fa-clock-o'></i>&nbsp;" . $unico->total_tiempo, $fila);
        } else if ($unico->nota_objeto >= "0") {
            $aprobado_reprobado = ApruebaReprueba($unico->nota_objeto);
            $fila               = str_replace("{TIEMPO_NAVEGACION}", "<img width='20%' src='img/" . $aprobado_reprobado[1] . "'>
    <span ><br><b>Nota: " . number_format($unico->nota_objeto, 0) . "%</b></span>
    ", $fila);
        } else {
            $fila = str_replace("{TIEMPO_NAVEGACION}", "", $fila);
        }
        if ($unico->nota_objeto >= "0") {
            $total_notas++;
            $acum_notas = $acum_notas + $unico->nota_objeto;
        }
        $total_html .= $fila;
    }
    if ($total_notas > 0) {
        $PRINCIPAL = str_replace("{PROMEDIO_NOTAS_POR_CURSO}", number_format($acum_notas / $total_notas, 0), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{PROMEDIO_NOTAS_POR_CURSO}", "0", $PRINCIPAL);
    }
    $porcentaje_avance_curso = (100 * $total_finalizados) / count($objetos);
    $PRINCIPAL               = str_replace("{PORCENTAJE_AVANCE_CURSO}", number_format($porcentaje_avance_curso, 0), $PRINCIPAL);
    $PRINCIPAL               = str_replace("{LISTADO_OBJETOS}", utf8_encode($total_html), $PRINCIPAL);
    $detalle_curso           = DetalleCurso($id_curso);
    $PRINCIPAL               = str_replace("{NOMBRE_CURSO}", utf8_encode($detalle_curso[0]->nombre), $PRINCIPAL);
    $PRINCIPAL               = str_replace("{CANTIDAD_OBJETOS}", count($objetos), $PRINCIPAL);
    //Total NAvegacion por Curso.
    $navegacion_por_curso    = SumaNavegacionesDadoRutYCurso($rut, $id_curso);
    $PRINCIPAL               = str_replace("{TOTAL_NAVEGACION_CURSO}", $navegacion_por_curso[0]->total_tiempo, $PRINCIPAL);
    return ($PRINCIPAL);
}
function ListadoObjetosCapacitacion($PRINCIPAL, $id_curso, $rut, $tipo, $id_inscripcion, $id_empresa, $id_template, $back_home, $im, $id_programa, $id_nivel, $vista, $id_inscripcion_usuario, $dia, $solo_video)
{

    //echo "$id_curso, $rut, $tipo, $id_inscripcion";

    if ($vista == "") {
        //busca orden den curso
        $arr_curso = DatosCursoTodos($id_curso);
        if ($arr_curso[0]->numero_identificador == "ORDENPORESTADO") {
            $vista = 2; //vista 2 por estado
        } else {
            $vista = 1;
        }
    }
    //PARAMETROS_AUTOEVAL_SGD
    $objetos          = ObjetosDadoCursoOrden($id_curso, $rut, $vista, $dia);
    $detalle_curso    = DetalleCursoConSumaNavegacionPorObjeto($id_curso);
    $estado_por_curso = CAPACITACION_ObtenerEstadoAvanceCurso($rut, $id_curso, "", $id_empresa);
    $avances          = ColocaAvanceCursoPorPuntosDeObjetos($PRINCIPAL, $id_curso, $rut, $id_empresa);
    $PRINCIPAL        = $avances[0];
    if ($id_template <> '') {
        $template = "_" . $id_template;
    } else {
        $template = "";
    }
    if ($id_inscripcion) {
    } else {
        //Verifico si tiene registro o no  tiene registro en la tabla inscripcion_cierre
        $tiene_cierre_curso = TieneInscripcionCierreDadoRutYCursoEmpresa($rut, $id_curso, $id_empresa);
        if (!$tiene_cierre_curso) {
            InsertarInsripcionCierre($rut, $id_curso, $id_empresa);
        }
    }
    //Estado de Curso, dado la tabla inscripcion cierre
    $estado_curso                = CAPACITACION_ObtenerEstadoAvanceCurso($rut, $id_curso, $id_inscripcion, $id_empresa);
    $PRINCIPAL                   = str_replace("{ID_CURSO_ENCODEADO}", Encodear3($id_curso), $PRINCIPAL);
    $PRINCIPAL                   = str_replace("{ESTADO_CURSO}", $estado_por_curso[0], $PRINCIPAL);
    $PRINCIPAL                   = str_replace("{PORCENTAJE_AVANCE_CURSO_2}", $estado_por_curso[4], $PRINCIPAL);
    $PRINCIPAL                   = str_replace("{ESTADO_DE_CURSO}", $estado_por_curso[0], $PRINCIPAL);
    $PRINCIPAL                   = str_replace("{PORCENTAJE_AVANCE_CURSO}", $estado_curso[4], $PRINCIPAL);
    $PRINCIPAL                   = str_replace("{TIEMPO_NAVEGADO_POR_CURSO}", $estado_curso[5], $PRINCIPAL);
    $datos_usuario_cruce_empresa = UsuarioEnBasePersonasCruceEmpresa2($rut);
    $PRINCIPAL                   = str_replace("{DESCRIPCION}", utf8_encode($detalle_curso[0]->descripcion), $PRINCIPAL);
    $PRINCIPAL                   = str_replace("{textodescripcion}", utf8_encode($detalle_curso[0]->descripcion), $PRINCIPAL);
    $PRINCIPAL                   = str_replace("{DESCRIPCION_CURSO}", utf8_encode($detalle_curso[0]->descripcion), $PRINCIPAL);
    $PRINCIPAL                   = str_replace("{DESCRIPTOR_CURSO}", utf8_encode($detalle_curso[0]->descriptor), $PRINCIPAL);
    $PRINCIPAL                   = str_replace("{FECHAS}", $detalle_curso[0]->fecha_inicio . " - " . $detalle_curso[0]->fecha_finalizacion, $PRINCIPAL);
    $PRINCIPAL                   = str_replace("{DESCRIPCION_CURSO}", utf8_encode($detalle_curso[0]->descripcion), $PRINCIPAL);
    $porcentaje_avance_curso     = PorcentajeAvanceCurso($id_curso, $rut);
    $PRINCIPAL                   = str_replace("{ETIQUETA_FONDO_ESTADO}", $porcentaje_avance_curso[6], $PRINCIPAL);
    $PRINCIPAL                   = str_replace("{COLOR_ESTADO}", $porcentaje_avance_curso[5], $PRINCIPAL);
    $PRINCIPAL                   = str_replace("{PORCENTAJE_AVANCE}", $porcentaje_avance_curso[1], $PRINCIPAL);
    $PRINCIPAL                   = str_replace("{COMPLETO_INCOMPLETO}", $porcentaje_avance_curso[0], $PRINCIPAL);
    $PRINCIPAL                   = str_replace("{METODOLOGIA}", utf8_encode($detalle_curso[0]->nombre_modalidad), $PRINCIPAL);
    $PRINCIPAL                   = str_replace("{BAJADA_CURSO}", utf8_encode($detalle_curso[0]->bajada), $PRINCIPAL);
    $PRINCIPAL                   = str_replace("{IMAGEN}", utf8_encode($detalle_curso[0]->imagen), $PRINCIPAL);
    $PRINCIPAL                   = str_replace("{IMAGEN_BACK}", utf8_encode($detalle_curso[0]->imagen_back), $PRINCIPAL);
    $PRINCIPAL                   = str_replace("{NOMBRE_CURSO}", utf8_encode($detalle_curso[0]->nombre), $PRINCIPAL);
    //echo $detalle_curso[0]->imagen;
    if ($detalle_curso[0]->imagen) {
        $PRINCIPAL = str_replace("{BLOQUE_IMAGEN_CURSO}", file_get_contents("views/cursos/template_imagen_curso.html"), $PRINCIPAL);
        $PRINCIPAL = str_replace("{IMG_IMAGEN_CURSO}", "img/logos_cursos/" . $detalle_curso[0]->imagen, $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{BLOQUE_IMAGEN_CURSO}", "", $PRINCIPAL);
        $PRINCIPAL = str_replace("{IMG_IMAGEN_CURSO}", "img/img_curso.jpg", $PRINCIPAL);
    }
    //con esta funcion, pasando el rut y el id del curso, me devuelve los minutos navegados
    $navegacion_por_curso = SumaNavegacionesDadoRutYCurso($rut, $id_curso);
    $PRINCIPAL            = str_replace("{MINUTOS_NAVEGADOS}", $navegacion_por_curso[0]->total_tiempo, $PRINCIPAL);
    $PRINCIPAL            = str_replace("{MINUTOS_TOTAL_POR_CURSO}", $detalle_curso[0]->suma_total_tiempo, $PRINCIPAL);
    $total_html           = "";
    $total_htmlya         = "";
    $total_htmlno         = "";
    if (count($objetos) == 0) {
        echo "<script>alert('Este curso no posee objetos asociados');location.href='?sw=" . $datos_usuario_cruce_empresa[0]->case_home . "';</script>";
        exit;
    }
    foreach ($objetos as $unico) {



    //echo "<br>pasa por todo la rel $id_curso $id_inscripcion $rut ".$unico->id;

    $arr=BuscaRelIdInscripcionCursoObjeto($id_curso, $id_inscripcion, $unico->id);
    //print_r($arr);

     if($arr[0]->fecha_inicio<>''){         $unico->fecha_inicio=$arr[0]->fecha_inicio;}
     if($arr[0]->fecha_termino<>''){     $unico->fecha_termino=$arr[0]->fecha_termino;}
     if($arr[0]->hora_inicio<>''){     $unico->hora_inicio=$arr[0]->hora_inicio;}
     if($arr[0]->hora_termino<>''){     $unico->hora_termino=$arr[0]->hora_termino;}

        if ($unico->fecha_inicio <> '' OR $unico->fecha_termino <> '' OR $unico->hora_inicio <> '' OR $unico->hora_termino <> '') {
            $fecha_actual = date("Y-m-d");
            $hora_actual  = date("H:i:s");
            if ($unico->fecha_inicio == "") {
                $unico->fecha_inicio = "1900-01-01";
            }
            if ($unico->fecha_termino == "") {
                $unico->fecha_termino = "2200-01-01";
            }
            if ($unico->hora_inicio == "") {
                $unico->hora_inicio = "00:01";
            }
            if ($unico->hora_termino == "") {
                $unico->hora_termino = "23:59";
            }
            //echo $unico->id;
            //echo "<br>";echo "fecha inicio ".$unico->fecha_inicio."<br>";
            //echo "fecha termino ".$unico->fecha_termino."<br>";
            //echo "imagen actual ".$unico->imagen."<br>";
            //echo "FECHA actual ".$fecha_actual."<br><br>";
            //echo "hora actual ".$hora_actual."<br>";
            //echo "hora inicio ".$unico->hora_inicio."<br>";
            //echo "hora termino ".$unico->hora_termino."<br>";
            $mensaje_objeto = "";
            $accede_modulo  = 0;
            if ($fecha_actual < $unico->fecha_inicio) {
$mensaje_objeto .= "El modulo se encuentra desactivado. La fecha de aplicaci&oacute;n es el " . $unico->fecha_inicio." y el horario de activaci&oacute;n es entre las ".$unico->hora_inicio." y ".$unico->termino."";

                $accede_modulo = 1;
            } else if ($fecha_actual > $unico->fecha_termino) {
$mensaje_objeto .= "El modulo se encuentra desactivado. La fecha de aplicaci&oacute;n es el " . $unico->fecha_inicio." y el horario de activaci&oacute;n es entre las ".$unico->hora_inicio." y ".$unico->termino."";                $accede_modulo = 1;
            } else if ($fecha_actual >= $unico->fecha_inicio && $fecha_actual <= $unico->fecha_termino) {
                if ($fecha_actual == $unico->fecha_inicio and $fecha_actual <> $unico->fecha_termino) {
                    //    echo "es hoy inicio";
                    if ($hora_actual < $unico->hora_inicio) {
$mensaje_objeto .= "El modulo se encuentra desactivado. La fecha de aplicaci&oacute;n es el " . $unico->fecha_inicio." y el horario de activaci&oacute;n es entre las ".$unico->hora_inicio." y ".$unico->termino."";                        $accede_modulo = 1;
                    }
                } elseif ($fecha_actual == $unico->fecha_termino and $fecha_actual <> $unico->fecha_inicio) {
                    if ($hora_actual > $unico->hora_termino) {
$mensaje_objeto .= "El modulo se encuentra desactivado. La fecha de aplicaci&oacute;n es el " . $unico->fecha_inicio." y el horario de activaci&oacute;n es entre las ".$unico->hora_inicio." y ".$unico->termino."";                        $accede_modulo = 1;
                    }
                } elseif ($fecha_actual == $unico->fecha_termino and $fecha_actual == $unico->fecha_inicio) {
                        //echo "es hoy termino e iniciohora ahora es ".$hora_actual." hora termino ".$unico->hora_termino." hora inicio".$unico->hora_inicio;
                    if ($hora_actual < $unico->hora_inicio) {
$mensaje_objeto .= "El modulo se encuentra desactivado. La fecha de aplicaci&oacute;n es el " . $unico->fecha_inicio." y el horario de activaci&oacute;n es entre las ".$unico->hora_inicio." y ".$unico->termino."";                        $accede_modulo = 1;
                    }
                    if ($hora_actual > $unico->hora_termino) {
$mensaje_objeto .= "El modulo se encuentra desactivado. La fecha de aplicaci&oacute;n es el " . $unico->fecha_inicio." y el horario de activaci&oacute;n es entre las ".$unico->hora_inicio." y ".$unico->termino."";                        $accede_modulo = 1;
                    }

                } else {
                    //$mensaje_objeto .= "<br> El Modulo Activo";
                    $accede_modulo = 0;
                }
            }
        }



        //echo $mensaje_objeto;
        //Primero verifico si la anterior esta finalizada y todo esto solo si es mayor a 1
        if ($unico->orden > 1) {
            //Ahora verifico que la anterior est? finalizada, sino lo est?, muestro el template de lectura
            //primero obtengo el anterior
            $objeto_anterior     = DatosObjetoDadoRutCursoyOrden($id_curso, $unico->orden - 1);
            //Ahora veo si el anterior esta finalizado, junto al rut del usuario
            $final_objt_anterior = ObjetoFinalizadoDadoIdYRut($rut, $objeto_anterior[0]->id);
            //Si el objeto anterior esta finalizado
            if ($final_objt_anterior) {
                $ve_si_esta_finalizada = VerObjetoFinalizado($unico->id, $rut);
                if ($ve_si_esta_finalizada) {
                    if ($unico->idmoodleNO) {
                        //$fila=file_get_contents("views/c ursos/".$id_empresa."_row_objeto_finalizado_moodle".$template.".html");
                    } else {
                        $tiene_accion_pendiente = TieneAccionesPEndientes($rut, $id_empresa, $unico->id_curso, $unico->id);
                        if ($tiene_accion_pendiente) {
                            if ($tiene_accion_pendiente[0]->estado == 2) {
                                $fila           = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto_finalizado_reprobado" . $template .$solo_video. ".html");
                                $img_transicion = $id_empresa . "_obj_reprobado.jpg";
                            } else if ($tiene_accion_pendiente[0]->estado === "0") {
                                //echo $unico->id;
                                $fila           = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto_en_proceso" . $template .$solo_video. ".html");
                                $img_transicion = $id_empresa . "_obj_en_proceso.jpg";
                            } else if ($tiene_accion_pendiente[0]->estado == 1) {
                                $fila           = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto_finalizado" . $template .$solo_video. ".html");
                                $img_transicion = $id_empresa . "_obj_finalizado.jpg";
                            }
                        } else {
                            $fila           = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto_finalizado" . $template .$solo_video. ".html");
                            $img_transicion = $id_empresa . "_obj_finalizado.jpg";
                        }
                    }
                } else {
                    if ($unico->idmoodleNO) {
                        $fila                             = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto_moodle" . $template .$solo_video. ".html");
                        $datos_del_curso_en_moodle        = ObtenerDatosMoodle($arreglo_datos_curso, $HTML, $bloque, $unico->id_scorm);
                        $porcentaje_Avance_de_Este_modulo = $datos_del_curso_en_moodle[0];
                        if ($porcentaje_Avance_de_Este_modulo == "100") {
                            //IngresoObjetoFinalizado($rut, $unico->id, $tiempo_navegado, "", "", $unico->id_curso);
                            //VerificaFinalizaCurso($unico->id_curso, $rut);
                            //CAPACITACIONActualizarDatosCierre($unico->id_curso, $rut, $id_empresa, $navegacion_por_curso[0]->total_tiempo);
                        }
                    } else {
                        //Aca Veo si este objeto esta en la tabla tbl_lms_acciones_pendientes con estado 0, para este objeto, para este cuso y para esta empresa.
                        //Si es asi, muestro el estado amarillo
                        //si no el desactivado
                        $tiene_accion_pendiente = TieneAccionesPEndientes($rut, $id_empresa, $unico->id_curso, $unico->id);
                        if ($tiene_accion_pendiente) {
                            if ($tiene_accion_pendiente[0]->estado == 0) {
                                $fila = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto_en_proceso" . $template .$solo_video. ".html");
                            } else {
                                $fila = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto" . $template .$solo_video. ".html");
                            }
                        } else {
                            //Voy a verificar si para este rut, empresa curso y objeto, esta en la tabla de tareas
                            //$fila=file_get_contents("views/cursos/".$id_empresa."_row_objeto.html");
                            $objeto_finalizado_pero_pendiente = VerificaObjetoNoFinalizadoPendiente($rut, $id_empresa, $unico->id_curso, $unico->id);
                            if ($objeto_finalizado_pero_pendiente) {
                                $fila = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto_finalizado_pendiente" . $template .$solo_video. ".html");
                            } else {
                                $fila = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto" . $template .$solo_video. ".html");
                                $fila = str_replace("{PARAMETROS_AUTOEVAL_SGD}", "ie=" . Encodear3($rut) . "&ip=" . Encodear3(120) . "&ae=1", $fila);
                            }
                        }
                    }
                }
            } else {
                $ve_si_esta_finalizada = VerObjetoFinalizado($unico->id, $rut);
                if ($ve_si_esta_finalizada) {
                    $fila = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto_finalizado" . $template .$solo_video. ".html");
                } else {
                    $objeto_anterior                           = DatosObjetoDadoRutCursoyOrden($id_curso, $unico->orden - 1);
                    $id_objeto_anterior                        = $objeto_anterior[0]->id;
                    $objeto_anterior_finalizado_pero_pendiente = VerificaObjetoNoFinalizadoPendiente($rut, $id_empresa, $objeto_anterior[0]->id_curso, $objeto_anterior[0]->id);
                    if ($objeto_anterior_finalizado_pero_pendiente) {
                        $fila = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto" . $template .$solo_video. ".html");
                    } else {
                        if ($unico->cm == "SIEMPREACTIVO") {
                            $fila = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto" . $template .$solo_video. ".html");
                            //echo "DESCACTIVO pero activo";
                        } else {
                            $fila = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto_desactivado" . $template .$solo_video. ".html");
                            //    echo "DESCACTIVO";
                        }
                    }
                    //Ahora veo si el anterior esta finalizado, junto al rut del usuario
                    //$final_objt_anterior=ObjetoFinalizadoDadoIdYRut($rut, $objeto_anterior[0]->id);
                }
            }
            if ($unico->extension_objeto == "zip") {
                $fila = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto_zip" . $template .$solo_video. ".html");
            }
        } else {
            $ve_si_esta_finalizada = VerObjetoFinalizado($unico->id, $rut);
            if ($ve_si_esta_finalizada) {
                //echo $unico->id;
                $tiene_accion_pendiente = TieneAccionesPEndientes($rut, $id_empresa, $unico->id_curso, $unico->id);
                if ($tiene_accion_pendiente) {
                    //if($tiene_accion_pendiente[0]->estado==0){
                    if ($tiene_accion_pendiente[0]->estado == 1) {
                        //echo "aa<br>";
                        //$fila=file_get_contents("views/cursos/".$id_empresa."_row_objeto_en_proceso".$template.".html");
                        $fila = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto_finalizado" . $template .$solo_video. ".html");
                    } else if ($tiene_accion_pendiente[0]->estado === "0") {
                        //echo "bb<br>";
                        $fila = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto_en_proceso" . $template .$solo_video. ".html");
                    } else {
                        //echo "cc<br>";
                        $fila = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto" . $template .$solo_video. ".html");
                    }
                } else {
                    //echo "dd<br>";
                    $fila = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto_finalizado" . $template .$solo_video. ".html");
                }
            } else {
                if ($unico->idmoodleNO) {
                    $fila                             = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto_moodle" . $template .$solo_video. ".html");
                    $datos_del_curso_en_moodle        = ObtenerDatosMoodle($arreglo_datos_curso, $HTML, $bloque, $unico->id_scorm);
                    $porcentaje_Avance_de_Este_modulo = $datos_del_curso_en_moodle[0];
                    if ($porcentaje_Avance_de_Este_modulo == "100") {
                        //IngresoObjetoFinalizado($rut, $unico->id, $tiempo_navegado, "", "", $unico->id_curso);
                        //VerificaFinalizaCurso($unico->id_curso, $rut);
                        //CAPACITACIONActualizarDatosCierre($unico->id_curso, $rut, $id_empresa, $navegacion_por_curso[0]->total_tiempo);
                    }
                } else {
                    //si est? en la tabla de tbl_objetos_no_finalizados, coloco row similar al de finalizado
                    $objeto_finalizado_pero_pendiente = VerificaObjetoNoFinalizadoPendiente($rut, $id_empresa, $unico->id_curso, $unico->id);
                    if ($objeto_finalizado_pero_pendiente) {
                        $fila = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto_finalizado_pendiente" . $template .$solo_video. ".html");
                    } else {
                        $fila = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto" . $template .$solo_video. ".html");
                    }
                }
            }
            if ($unico->extension_objeto == "zip") {
                $fila = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto_zip" . $template .$solo_video. ".html");
            }
        }
        if($unico->tipo_de_objeto==3){
            $fila = str_replace("{ICONO_BP}", file_get_contents("views/cursos/" . $id_empresa . "_icono_bp_video.html"), $fila);
        }else if($unico->tipo_de_objeto==5){
            $fila = str_replace("{ICONO_BP}", file_get_contents("views/cursos/" . $id_empresa . "_icono_bp_trivia.html"), $fila);
        }
        $fila = str_replace("{URL_OBJETO_DIRECTO}", $unico->url_objeto, $fila);
        if (($unico->opcional == 1 or $unico->opcional == 2) and $unico->extension_objeto <> 25) {
            $fila = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto" . $template .$solo_video. ".html");
        }
        if ($accede_modulo == 1) {
            $fila = file_get_contents("views/cursos/" . $id_empresa . "_row_objeto_desactivado" . $template .$solo_video. ".html");
        }
        $fila = str_replace("{MENSAJE_ACTIVACION_TIEMPO}", $mensaje_objeto, $fila);
        if ($unico->tipo_de_objeto == "3") {
            $fila = str_replace("{TIEMPOMODULO_O_NUM_PREGUNTAS}", $unico->duracion_video, $fila);
        } else if ($unico->tipo_de_objeto == "5") {
            $fila = str_replace("{TIEMPOMODULO_O_NUM_PREGUNTAS}", "<b>Cantidad Preguntas: " . $unico->total_preguntas_por_objeto . "</b>", $fila);
        }
        $fila = str_replace("{TIEMPOMODULO_O_NUM_PREGUNTAS}", "", $fila);
        $fila = str_replace("{NOMBRE_OBJETO}", $unico->titulo, $fila);
        $fila = str_replace("{TIPO_OBJETO}", $unico->tipo_objeto, $fila);
        $fila = str_replace("{CLASE_ICONO}", $unico->icono, $fila);
        $fila = str_replace("{BAJADA1}", $unico->bajada, $fila);
        $fila = str_replace("{BAJADA2}", $unico->texto_bajada, $fila);
        $fila = str_replace("{TEXTO_BAJADA}", $unico->texto_bajada, $fila);
        if ($unico->imagen == "") {
            $unico->imagen = "bci_icon_cont.png";
        } else {
            $unico->imagen = $unico->imagen;
        }



        if($id_inscripcion){
            $fila   = str_replace("{PARAMETROS_AUTOEVAL_SGD}", "&ii=".Encodear3($id_inscripcion)."", $fila);
        }else{
            $fila   = str_replace("{PARAMETROS_AUTOEVAL_SGD}", "", $fila);
        }



        $fila   = str_replace("{IMAGEN_MODULO}", "img/" . $unico->imagen, $fila);
        $fila   = str_replace("{IMAGEN_MODULO_ACTIVO}", "img/" . $unico->imagen . "_activo.png", $fila);
        $fila   = str_replace("{IMAGEN_MODULO_PASIVO}", "img/" . $unico->imagen . "_desactivo.png", $fila);
        $fila   = str_replace("{IMAGEN_MODULO_VISTO}", "img/" . $unico->imagen . "_visto.png", $fila);
        $fila   = str_replace("{IMAGEN_TRANSICION_FINALIZADO}", "img/" . $id_empresa . "_obj_finalizado.jpg", $fila);
        $fila   = str_replace("{IMAGEN_TRANSICION_EN_PROCESO}", "img/" . $id_empresa . "_obj_en_proceso.jpg", $fila);
        $fila   = str_replace("{IMAGEN_TRANSICION_NO_INICIADO}", "img/" . $id_empresa . "_obj_no_iniciado.jpg", $fila);
        //echo $unico->imagen;
        $fila   = str_replace("{IMAGEN_MODULO_DINAMICO}", "" . $unico->imagen, $fila);
        $fila   = str_replace("{IMAGEN_TEXTOMODULO}", $unico->imagentexto, $fila);
        $fila   = str_replace("{PORC_AVANC}", $porcentaje_Avance_de_Este_modulo . "%", $fila);
        $fila   = str_replace("{AMBIENTE}", $unico->ambiente, $fila);
        $fila   = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($unico->id), $fila);
        $fila   = str_replace("{ID_OBJETO}", ($unico->id), $fila);
        $fila   = str_replace("{RUT_MOODLE}", $rut, $fila);
        $fila   = str_replace("{PASS_MOODLE}", "Gop.123456", $fila);
        $fila   = str_replace("{ID_MOODLE}", $unico->idmoodle, $fila);
        $fila   = str_replace("{CURRENTORG}", $unico->currentorg, $fila);
        $fila   = str_replace("{SCOID}", $unico->scoid, $fila);
        $fila   = str_replace("{CM}", $unico->cm, $fila);
        $fila   = str_replace("{ACTION}", $unico->urlmoodle, $fila);
        $estado = EstadoObjeto($unico->id, $rut);
        //Estados
        if ($estado[1] == "si") {
            $total_finalizados++;
        }
        $fila = str_replace("{ICONO_ESTADO}", $estado[0], $fila);
        if ($unico->total_tiempo) {
            $fila = str_replace("{TIEMPO_NAVEGACION}", "<i class='fa fa-clock-o'></i>&nbsp;" . $unico->total_tiempo, $fila);
        } else if ($unico->nota_objeto >= "0") {
            $aprobado_reprobado = ApruebaReprueba($unico->nota_objeto);
            $fila               = str_replace("{TIEMPO_NAVEGACION}", "<img width='20%' src='img/" . $aprobado_reprobado[1] . "'>
    <span ><br><b>Nota: " . number_format($unico->nota_objeto, 0) . "%</b></span>
    ", $fila);
        } else {
            $fila = str_replace("{TIEMPO_NAVEGACION}", "", $fila);
        }
        if ($unico->nota_objeto >= "0") {
            $total_notas++;
            $acum_notas = $acum_notas + $unico->nota_objeto;
        }
        $total_html .= $fila;
        $total_htmlyatitulo = "";
        if ($unico->cm == "yarealizados") {
            $total_htmlya .= $fila;
            $total_htmlyatitulo = "<BR><SMALL><SPAN class='blanco'>Cursos ya realizados</SPAN></SMALL><br>    <div class='panel panel-default paper-shadow' data-z='0.5'>
    <div class='panel-body'>";
        }
        if ($unico->cm <> "yarealizados") {
            $total_htmlno .= $fila;
        }
    }
    if ($total_notas > 0) {
        $PRINCIPAL = str_replace("{PROMEDIO_NOTAS_POR_CURSO}", number_format($acum_notas / $total_notas, 0), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{PROMEDIO_NOTAS_POR_CURSO}", "0", $PRINCIPAL);
    }
    $porcentaje_avance_curso = (100 * $total_finalizados) / count($objetos);
    $PRINCIPAL               = str_replace("{PORCENTAJE_AVANCE_CURSO}", number_format($porcentaje_avance_curso, 0), $PRINCIPAL);
    $PRINCIPAL               = str_replace("{LISTADO_OBJETOS_NO_REALIZADOS}", utf8_encode($total_htmlno), $PRINCIPAL);
    $PRINCIPAL               = str_replace("{TITULO_OBJETOS_YA_REALIZADOS}", utf8_encode($total_htmlyatitulo), $PRINCIPAL);
    $PRINCIPAL               = str_replace("{LISTADO_OBJETOS_YA_REALIZADOS}", utf8_encode($total_htmlya), $PRINCIPAL);
    $PRINCIPAL               = str_replace("{LISTADO_OBJETOS".$dia."}", utf8_encode($total_html), $PRINCIPAL);
    $detalle_curso           = DetalleCurso($id_curso);
    $PRINCIPAL               = str_replace("{NOMBRE_CURSO}", utf8_encode($detalle_curso[0]->nombre), $PRINCIPAL);
    $PRINCIPAL               = str_replace("{CANTIDAD_OBJETOS}", count($objetos), $PRINCIPAL);
    //Total NAvegacion por Curso.
    $navegacion_por_curso    = SumaNavegacionesDadoRutYCurso($rut, $id_curso);
    $PRINCIPAL               = str_replace("{TOTAL_NAVEGACION_CURSO}", $navegacion_por_curso[0]->total_tiempo, $PRINCIPAL);
    return ($PRINCIPAL);
}
function ListadoCursos($PRINCIPAL, $id_nivel, $rut, $id_programa, $tipo)
{
    $id_empresa = $_SESSION["id_empresa"];
    if ($tipo == "sessions") {
        $fila_template = file_get_contents("views/cursos/row_curso_sessions.html");
    } else if ($tipo == "listado") {
        $fila_template = file_get_contents("views/cursos/row_curso_listado.html");
    } else {
        $fila_template = file_get_contents("views/cursos/row_curso.html");
    }
    //traigo listado de cursos dado el id del nivel
    $cursos                          = CursosDadoNivel($id_nivel);
    $total_html                      = "";
    //Con esta variable, voy acumulando el porcentaje por cada curso, para despues colocarlo a modo general
    $porcentaje_general_total_cursos = 0;
    $certificacion                   = 0;
    foreach ($cursos as $unico) {
        //Aca hay una excepci?n,
        //Lo que hago es ver si el curso tiene solo 1 objeto, adem?s, si es solo 1 objeto, que es del tipo evaluaci?n
        //muestro otro template del row curso, sin imagen.
        $objetos = ObjetosDadoCurso($unico->id, $rut);
        if ($unico->certificacion == 1) {
            $subtitulo = file_get_contents("views/cursos/subtitulo_certificacion.html");
        } else {
            $subtitulo = "";
        }
        if ($unico->certificacion == 1) {
            $fila         = $subtitulo . file_get_contents("views/cursos/row_curso_listado_sin_imagen_certificacion.html");
            $datos_objeto = ObjetosDadoCurso($unico->id, $rut);
            $fila         = str_replace("{ID_OBJETO_ENCODAEADO}", Encodear3($datos_objeto[0]->id), $fila);
        } else {
            $fila = $subtitulo . $fila_template;
        }
        //$fila=$fila_template;
        $fila = str_replace("{NOMBRE_CURSO}", $unico->nombre, $fila);
        $fila = str_replace("{DESCRIPCION_CURSO}", $unico->descripcion, $fila);
        $fila = str_replace("{BAJADA_CURSO}", $unico->bajada, $fila);
        $fila = str_replace("{LOGO_CURSO}", $unico->imagen, $fila);
        $fila = str_replace("{METODOLOGIA}", $unico->tipo_metodologia, $fila);
        $fila = str_replace("{ID_CURSO_ENCODAEADO}", Encodear(Encodear(Encodear($unico->id))), $fila);
        if ($unico->fecha_inicio == "0000-00-00" && $unico->fecha_finalizacion == "0000-00-00") {
            $fila = str_replace("{FECHAS}", file_get_contents("views/cursos/curso_sin_fechas.html"), $fila);
        } else {
            $fila = str_replace("{FECHAS}", file_get_contents("views/cursos/curso_fechas.html"), $fila);
            $fila = str_replace("{FECHA_INICIO}", $unico->fecha_inicio, $fila);
            $fila = str_replace("{FECHA_TERMINO}", $unico->fecha_finalizacion, $fila);
        }
        //Porcentaje de Avance de Curso, en base a los objetos de este que se encuentran finalizado
        //Debo entregar el id de Curso y Rut
        //indice 1, entrga el porcentaje de avance.
        //indice 2, muestra el dedo hacia arriba en caso de que est? aprobado
        $porcentaje_avance_curso         = PorcentajeAvanceCurso($unico->id, $rut);
        $fila                            = str_replace("{PORsCENTAJE_AVANCE}", $porcentaje_avance_curso[1], $fila);
        $porcentaje_general_total_cursos = $porcentaje_general_total_cursos + $porcentaje_avance_curso[1];
        $fila                            = str_replace("{COMPLETO_INCOMPLETO}", $porcentaje_avance_curso[0], $fila);
        $fila                            = str_replace("{CLASS_DEDO}", $porcentaje_avance_curso[2], $fila);
        $fila                            = str_replace("{COLOR_ESTADO}", $porcentaje_avance_curso[5], $fila);
        $fila                            = str_replace("{ETIQUETA_FONDO_ESTADO}", $porcentaje_avance_curso[6], $fila);
        //Obtengo el total de participantes por este curso.
        //Para eso, con los datos de sesion, puedo obtener ese valor
        //Totalobjetos por cursos
        $fila                            = str_replace("{NUMEROOBJETOS}", $unico->total_objetos, $fila);
        $fila                            = str_replace("{MINUTOS}", $unico->total_suma_tiempos_objetos, $fila);
        //Acaobtengo la suma de las navegaciones de este curso
        $navegacion_por_curso            = SumaNavegacionesDadoRutYCurso($rut, $unico->id);
        $fila                            = str_replace("{MINUTOS_NAVEGADOS}", $navegacion_por_curso[0]->total_tiempo, $fila);
        //Nota promedio del Curso
        $nota_promedio_curso             = PromedioDeEvaluacionesDadoCursoYRut($unico->id, $rut);
        $aprobado_reprobado              = ApruebaReprueba($nota_promedio_curso[0]->promedio_nota_curso);
        $fila                            = str_replace("{NOTA_CURSO}", $nota_promedio_curso[0]->promedio_nota_curso, $fila);
        if ($unico->imagen) {
            $fila = str_replace("{BLOQUE_IMAGEN_CURSO}", file_get_contents("views/cursos/template_imagen_curso.html"), $fila);
            $fila = str_replace("{IMG_IMAGEN_CURSO}", "img/logos_cursos/" . $unico->imagen, $fila);
            } else {
            $fila = str_replace("{BLOQUE_IMAGEN_CURSO}", "", $fila);
            $fila = str_replace("{IMG_IMAGEN_CURSO}", "img/img_curso.jpg", $fila);
        }
        $fila = str_replace("{CANTIDAD_PARTICIPANTES}", TotalParticipantes(), $fila);
        $total_html .= $fila;
    }
    $PRINCIPAL     = str_replace("{LISTADO_CURSOS}", utf8_encode($total_html), $PRINCIPAL);
    $detalle_nivel = DetalleNivel($id_nivel);
    //Aca se muestra el titulo del Nivel.
    //SI este programa tiene solo 1 nivel, se muestra el nombre del programa
    $niveles       = NivelesDadoPrograma($id_programa);
    if (count($niveles) == 1) {
        $datos_programa = DatosPrograma($id_programa);
        $PRINCIPAL      = str_replace("{NOMBRE_NIVEL}", utf8_encode($datos_programa[0]->nombre), $PRINCIPAL);
        $PRINCIPAL      = str_replace("{DESCRIPCION}", utf8_encode($datos_programa[0]->descripcion), $PRINCIPAL);
        $PRINCIPAL      = str_replace("{LOGO_PROGRAMA}", utf8_encode($datos_programa[0]->archivo), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{NOMBRE_NIVEL}", utf8_encode($detalle_nivel[0]->nombre), $PRINCIPAL);
    }
    $PRINCIPAL       = str_replace("{CANTIDAD_CURSOS}", count($cursos), $PRINCIPAL);
    //Aca obtengo el porcentaje de Avance de todos los cursos. Para esto, veo cuantos cursos hay finalizados, y cuantos son en total.
    //$PRINCIPAL = str_replace("{PORCENTAJE_AVANCE_CURSOS}",number_format(PorcentajeCursos($id_nivel, $rut), 1)."",$PRINCIPAL);
    $PRINCIPAL       = str_replace("{PORCENTAJE_AVANCE_CURSOS}", number_format($porcentaje_general_total_cursos / count($cursos), 0) . "", $PRINCIPAL);
    //Promedio de notas
    //$promedio_notas=SumaDeNotasObjetosFinalizados($rut);
    $promedio_notas  = SumaDeNotasObjetosFinalizadosYNivel($rut, $id_nivel);
    $PRINCIPAL       = str_replace("{PROMEDIO_NOTA}", number_format($promedio_notas[0]->promedio_notas_finales, 0), $PRINCIPAL);
    //Navegacion
    //$navegacion=SumaNavegacionesDadoRut($rut);
    $navegacion      = SumaNavegacionesDadoRutYNivel($rut, $id_nivel);
    $PRINCIPAL       = str_replace("{TOTAL_NAVEGACION}", $navegacion[0]->total_tiempo, $PRINCIPAL);
    //SECCION DE CERTIFICACIONES
    //Traigo las certificaciones de este programa
    $certificaciones = CertificacionesPorPrograma($id_programa);
    $fila_cert       = "";
    foreach ($certificaciones as $cert) {
        $fila_cert .= file_get_contents("views/cursos/row_curso_listado_sin_imagen.html");
        $fila_cert      = str_replace("{NOMBRE_CURSO}", $cert->nombre, $fila_cert);
        $fila_cert      = str_replace("{ID_CERTIFICACION_ENCODEADO}", Encodear3($cert->id_encuesta), $fila_cert);
        $fila_cert      = str_replace("{ID_CURSO_ENCODAEADO}", "", $fila_cert);
        //Por cada una de las encuestas veo si estan o no finalizadas
        $enc_finalizada = VerificoEncuestaFinalizada($cert->id_encuesta, $id_empresa, $rut);
        if ($enc_finalizada) {
            $fila_cert = str_replace("{COMPLETO_INCOMPLETO}", "<span class='fa fa-circle text-pendiente fs14 mr10 etiquetaAprobadoReprobado-aprobado'></span><span class='etiquetaAprobadoReprobado etiquetaAprobadoReprobado-aprobado'>Finalizado</span>", $fila_cert);
        } else {
            $fila_cert = str_replace("{COMPLETO_INCOMPLETO}", "<span class='fa fa-circle text-pendiente fs14 mr10 etiquetaAprobadoReprobado-pendiente'><span class='etiquetaAprobadoReprobado etiquetaAprobadoReprobado-pendiente'>Pendiente</span>", $fila_cert);
        }
    }
    $PRINCIPAL = str_replace("{LISTADO_CERTIFICACION}", utf8_encode($fila_cert), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ListadoNiveles($PRINCIPAL, $id_programa)
{
    $usuario    = $_SESSION["user_"];
    $id_empresa = $_SESSION["id_empresa"];
    //obtengo el listado de niveles dado el programa.
    $niveles    = NivelesDadoPrograma($id_programa);
    $total_html = "";
    if (count($niveles) == 0) {
        echo "
    <script>
    alert('El programa seleccionado no tiene cursos asociados');
    location.href='?sw=malla';
    </script>";
        exit;
    }
    foreach ($niveles as $unico) {
        $fila             = file_get_contents("views/cursos/row_categoria.html");
        $fila             = str_replace("{NOMBRE}", utf8_encode($unico->nombre), $fila);
        $cursos_por_nivel = CursosDadoNivel($unico->id);
        $fila             = str_replace("{DESCRIPCION}", $unico->descripcion, $fila);
        $fila             = str_replace("{CANTIDAD_CURSOS}", count($cursos_por_nivel), $fila);
        $fila             = str_replace("{TUTOR}", $unico->nombre_completo, $fila);
        $fila             = str_replace("{ID_CURSO_ENCODEADO}", Encodear(Encodear(Encodear($unico->id))), $fila);
        $porcentaje       = PorcentajeCursos($unico->id, $_SESSION["user_"]);
        if ($porcentaje) {
            $fila = str_replace("{PORCENTAJE_AVANCE}", $porcentaje, $fila);
        } else {
            $fila = str_replace("{PORCENTAJE_AVANCE}", 0, $fila);
        }
        $total_html .= $fila;
    }
    $PRINCIPAL      = str_replace("{LISTADO_NIVELES}", utf8_encode($total_html), $PRINCIPAL);
    $PRINCIPAL      = str_replace("{CANTIDAD_NIVELES}", count($niveles), $PRINCIPAL);
    $datos_programa = DatosPrograma($id_programa);
    $PRINCIPAL      = str_replace("{NOMBRE_PROGRAMA}", utf8_encode($datos_programa[0]->nombre), $PRINCIPAL);
    return ($PRINCIPAL);
}
function ListadoProgramas($PRINCIPAL, $datos_rel_malla)
{
    $usuario        = $_SESSION["user_"];
    $id_empresa     = $_SESSION["id_empresa"];
    //Si el usuario, coincide con los datos, le muestro la malla
    //echo "cantidad de mallas por empresa ".count($datos_rel_malla);
    //NUEVVVOOOO
    $si_corresponde = 0;
    foreach ($datos_rel_malla as $datos_rel) {
        $criterio_malla = VerificaCriterioMalla($datos_rel->campo, $datos_rel->valor, $usuario, $id_empresa);
        if ($criterio_malla) {
            $id_malla[$si_corresponde] = $datos_rel->id_malla;
            $si_corresponde++;
        }
    }
    //echo $si_corresponde;
    if ($si_corresponde > 1) {
        echo "
    <script>
    alert('Este cargo posee mas de una malla');
    location.href='?sw=home';
    </script>";
        exit;
    } else if ($si_corresponde == 0) {
        echo "
    <script>
    alert('Este cargo no posee malla asociada');
    location.href='?sw=home';
    </script>";
        exit;
    }
    //FIN NUEVOOOO
    //$id_malla=$datos_rel_malla[0]->id_malla;
    //$criterio_malla=VerificaCriterioMalla($datos_rel_malla[0]->campo, $datos_rel_malla[0]->valor, $usuario, $id_empresa);
    $id_malla          = $id_malla[0];
    $_SESSION["malla"] = $id_malla;
    //echo "<br> id malla ".$id_malla;
    //if($criterio_malla){
    if ($si_corresponde == 1) {
        //Obtengo por la malla, el total de programas
        $programas   = ProgramasDadoMalla($id_malla);
        //echo $id_malla;
        $datos_malla = DatosMalla($id_malla);
        if ($datos_malla[0]->sessions == 1) {
            $id_programa = $programas[0]->id;
            $niveles     = NivelesDadoPrograma($id_programa);
            //echo "cantidad niveles ".count($niveles);
            //Para el caso que solo exista 1 nivel, pasa directo al listado de cursos
            if (count($niveles) == 1) {
                $id_nivel = $niveles[0]->id;
                VerificaNivelFinalizado($id_nivel, $usuario, $id_programa);
                $_SESSION["nivel"] = Encodear($id_nivel);
                $PRINCIPAL         = ListadoCursos(FuncionesTransversales(file_get_contents("views/cursos/listado_cursos_sessions.html")), $id_nivel, $usuario, $id_programa, "sessions");
                $PRINCIPAL         = str_replace("{DESCRIPCION_PROGRAMA}", utf8_encode($programas[0]->descripcion), $PRINCIPAL);
                $PRINCIPAL         = BarraNavegacion($PRINCIPAL, "listado_cursos");
                $PRINCIPAL         = ColocaMenuSecundario($PRINCIPAL, $_SESSION["id_empresa"]);
                echo $PRINCIPAL;
                exit;
            }
        }
        $total_filas = "";
        foreach ($programas as $unico) {
            $fila                                 = file_get_contents("views/cursos/row_programa.html");
            $fila                                 = str_replace("{NOMBRE}", $unico->nombre, $fila);
            $fila                                 = str_replace("{LOGO_PROGRAMA}", $unico->archivo, $fila);
            $fila                                 = str_replace("{DESCRIPCION}", $unico->descripcion, $fila);
            $fila                                 = str_replace("{ID_PROGRAMA_ENCODEADO}", Encodear(Encodear(Encodear($unico->id))), $fila);
            //Cursos por Programa
            $total_cursos_por_programa            = CantidadCursosPorPrograma($unico->id);
            //Tiempo de duracion, dado el id del programa
            $duracion_cursos_por_programa         = DuracionCursosPorPrograma($unico->id);
            //Cantidad de cursos finalizados por programa
            $total_cursos_por_programa_finalizado = CantidadCursosPorProgramaFinalizadosPorUsuario($unico->id, $usuario);
            $total_cursos_fin                     = 0;
            $notas_promedio                       = NotaPromedioProgramaDadoIdPrograma($usuario, $unico->id);
            $fila                                 = str_replace("{CANTIDAD_CURSOS}", count($total_cursos_por_programa), $fila);
            //$fila = str_replace("{PORCENTAJE_AVANCE_CURSOS}",number_format(($total_cursos_fin*100)/count($total_cursos_por_programa), 0),$fila);
            $fila                                 = str_replace("{CANTIDAD_CURSOS_FINALIZADOS}", count($total_cursos_por_programa_finalizado), $fila);
            $fila                                 = str_replace("{SUMA_NAVEGACION_CURSOS}", ($duracion_cursos_por_programa[0]->total_suma_tiempos_objetos), $fila);
            $fila                                 = str_replace("{PORCENTAJE_AVANCE_CURSOS}", $notas_promedio[2], $fila);
            if ($notas_promedio[0]) {
                $fila = str_replace("{PROMEDIO_NOTAS_POR_CURSO}", $notas_promedio[0] . "%", $fila);
            } else {
                $fila = str_replace("{PROMEDIO_NOTAS_POR_CURSO}", "- ", $fila);
            }
            $total_navegacionprograma = totalNavegacionDadoProgramaRut($unico->id, $usuario);
            $fila                     = str_replace("{NAVEGACION_TOTAL_CURSOS}", $total_navegacionprograma[0]->total_tiempo, $fila);
            //ACA VERIFICO, DANDO COMO PARAMETRO EL ID DEL PROGRAMA
            VerificaProgramaFinalizado($unico->id, $usuario, $id_malla);
            $estado_programa = DevuelveEstadoPrograma($notas_promedio[0], $notas_promedio[2], $unico->id, $id_malla);
            //$estado_programa=DevuelveEstadoProgramaCursos($notas_promedio[0], $notas_promedio[2], $unico->id, $id_malla, "programa");
            $fila            = str_replace("{COLOR_ESTADO}", $estado_programa[1], $fila);
            $fila            = str_replace("{ETIQUETA_COLOR_ESTADO}", $estado_programa[2], $fila);
            $fila            = str_replace("{TEXTO_ESTADO_COLOR}", $estado_programa[3], $fila);
            $fila            = str_replace("{ETIQUETA_TEXTO_ESTADO}", $estado_programa[0], $fila);
            //En este peque?o parrafo, se  colocan los listados de los programas, mas su estado.
            $total_filas .= $fila;
            $filas_programas_brechas .= file_get_contents("views/cursos/row_programa_brecha.html");
            $filas_programas_brechas   = str_replace("{NOMBRE}", $unico->nombre, $filas_programas_brechas);
            //Funcion que obtiene el estado del programa.
            $filas_programas_brechas   = str_replace("{ETIQUETA}", $estado_programa[0], $filas_programas_brechas);
            //Aca acumulo los avances de los programas,para posteriormente sacar el promedio de la malla
            $acumulador_avances_cursos = $acumulador_avances_cursos + $notas_promedio[2];
        }
        $PRINCIPAL = str_replace("{POR_AVANCE_MALLA}", number_format($acumulador_avances_cursos / count($programas), 0), $PRINCIPAL);
        $PRINCIPAL = str_replace("{LIST_PROGR_BRECHAS}", utf8_encode($filas_programas_brechas), $PRINCIPAL);
        $PRINCIPAL = str_replace("{LISTADO_PROGRAMAS}", utf8_encode($total_filas), $PRINCIPAL);
        $PRINCIPAL = str_replace("{NUMERO_PROGRAMAS}", count($programas), $PRINCIPAL);
    } else {
        $PRINCIPAL = str_replace("{LISTADO_PROGRAMAS}", "No existen programas asociados a tu cargo", $PRINCIPAL);
        $PRINCIPAL = str_replace("{LISTADO_PROGRAMAS_BRECHAS}", "No existen programas asociados a tu cargo", $PRINCIPAL);
    }
    //ACA Veo el porcentaje de avance de las mallas, utilizando los datos que aparecen en tbl_programas_finalizados
    //$programas_finalizados=VeProgramaFinalizadoPorMalla($id_malla, $usuario);
    //$PRINCIPAL = str_replace("{POR_AVANCE_MALLA}",number_format((count($programas_finalizados)*100)/count($programas), 0),$PRINCIPAL);
    return ($PRINCIPAL);
}
function my_simple_crypt_encodear($string)
{
    // you may change these values to your own
    $secret_key     = 'JVvlenf593ld0fgptu58gjd03';
    $secret_iv      = 'gp2017gp!encriptacion______!iwuio';
    $output         = false;
    $encrypt_method = "AES-256-CBC";
    $key            = hash('sha256', $secret_key);
    $iv             = substr(hash('sha256', $secret_iv), 0, 16);
    $output         = base64_encode(openssl_encrypt($string, $encrypt_method, $key, 0, $iv));
    return $output;
}
function my_simple_crypt_decodear($string)
{
    // you may change these values to your own
    $secret_key     = 'JVvlenf593ld0fgptu58gjd03';
    $secret_iv      = 'gp2017gp!encriptacion______!iwuio';
    $output         = false;
    $encrypt_method = "AES-256-CBC";
    $key            = hash('sha256', $secret_key);
    $iv             = substr(hash('sha256', $secret_iv), 0, 16);
    $output         = openssl_decrypt(base64_decode($string), $encrypt_method, $key, 0, $iv);
    return $output;
}
function Encodear3($valor)
{
    //$valor=Encodear(Encodear(Encodear($valor)));
    $valor = my_simple_crypt_encodear($valor, 'e');
    return ($valor);
}
function Encodear($valor)
{
    $valor = base64_encode(base64_encode(base64_encode($valor)));
    return ($valor);
}
function Decodear3($valor)
{
    //$valor=Decodear(Decodear(Decodear($valor)));
    //print_r($valor);
    $valor = my_simple_crypt_decodear($valor, 'd');
    return ($valor);
}
function Decodear($valor)
{
    $valor = base64_decode(base64_decode(base64_decode($valor)));
    return ($valor);
}
function FuncionesTransversales($html)
{
    $environment_sw               = $_GET["sw"];
    $rut                          = $_SESSION["user_"];
    $datos_proceso                = DatosProceso();
    $datos_empresa                = DatosEmpresa($_SESSION["id_empresa"]);
    $rut_sesion                   = $_SESSION["user_"];
    $id_empresa                   = $_SESSION["id_empresa"];
    $datos_usuario                = UsuarioEnBasePersonas($rut_sesion, "");
    //print_r($datos_usuario);
    $html                         = str_replace("{FECHAHOY}", formatearFechaCompleta(date("Y-m-d")), $html);
    $html                         = str_replace("{NOMBRE_USUARIO}", $datos_usuario[0]->nombre_completo, $html);
    $html                         = str_replace("{RUT_USUARIO_LOGUEADO}", $datos_usuario[0]->rut, $html);
    $id_tema                      = $_SESSION["tema"];
    $rand                         = rand(1, 4);
    $html = str_replace("{RANDOM}", $rand , $html);

    //MENU SUPERIOR
    //primero veo si tiene menu nivel 0, si es si,muestro el template menu_superior_dinamico.html
    $tiene_menu_superior_dinamico = MenuNivel0PorEmpresa($_SESSION["id_empresa"], $id_tema);
    if ($tiene_menu_superior_dinamico) {
        if (file_exists("views/menu/" . $_SESSION["id_empresa"] . "_menu_superior_dinamico.html")) {
            $html = str_replace("{MENU_SUPERIOR}", file_get_contents("views/menu/" . $_SESSION["id_empresa"] . "_menu_superior_dinamico.html"), $html);
        } else {
            $html = str_replace("{MENU_SUPERIOR}", file_get_contents("views/menu/menu_superior_dinamico.html"), $html);
        }
        foreach ($tiene_menu_superior_dinamico as $unico) {
            //echo "<br>".$unico->nombre." - menu solo jefe ".$unico->solojefe;
            if ($unico->modal == 1) {
                $row_pestanas_dinamicas .= file_get_contents("views/menu/opciones_menu_dinamico_modal.html");
                $row_pestanas_dinamicas = str_replace("{BLOQUE_VENTANA_MODAL}", file_get_contents("views/pagina/" . $unico->pagina), $row_pestanas_dinamicas);
                $row_pestanas_dinamicas = str_replace("{ID}", $unico->id, $row_pestanas_dinamicas);
            } else if ($unico->blank == 1) {
                $row_pestanas_dinamicas .= file_get_contents("views/menu/opciones_menu_dinamico_blank.html");
            } else {
                if ($unico->solojefe == 1) {
                    $esjefe            = EsJefetblUsuario($rut, $id_empresa);
                    $esjefeResponsable = EsJefeResponsabletblUsuario($rut, $id_empresa);
                    $esliderEjecutivo  = EsLiderEjecutivotblUsuario($rut, $id_empresa);
                    //echo "<br>solo jefe 1 esjefe $esjefe esjefeResponsable $esjefeResponsable esliderEjecutivo $esliderEjecutivo .";
                    if ($esjefe >= 1) {
                        $row_pestanas_dinamicas .= file_get_contents("views/menu/opciones_menu_dinamico.html");
                    } else if ($esjefeResponsable >= 1) {
                        $row_pestanas_dinamicas .= file_get_contents("views/menu/opciones_menu_dinamico.html");
                    }
                } elseif ($unico->solojefe == 2) {
                    $esjefe            = EsJefetblUsuario($rut, $id_empresa);
                    $esjefeResponsable = EsJefeResponsabletblUsuario($rut, $id_empresa);
                    $esliderEjecutivo  = EsLiderEjecutivotblUsuario($rut, $id_empresa);
                    //echo "<br>solo jefe 2 esjefe $esjefe esjefeResponsable $esjefeResponsable esliderEjecutivo $esliderEjecutivo .";
                    if ($esliderEjecutivo >= 1) {
                        $row_pestanas_dinamicas .= file_get_contents("views/menu/opciones_menu_dinamico.html");
                    }
                } else {
                    $row_pestanas_dinamicas .= file_get_contents("views/menu/opciones_menu_dinamico.html");
                }
            }
            $row_pestanas_dinamicas = str_replace("{NOMBRE}", $unico->nombre, $row_pestanas_dinamicas);

            $row_pestanas_dinamicas = str_replace("{ICONO}", $unico->icono, $row_pestanas_dinamicas);
            $row_pestanas_dinamicas = str_replace("{A_AHREF}", $unico->descripcion_link, $row_pestanas_dinamicas);
            $row_pestanas_dinamicas = str_replace("{RUT_ENCODEADO}", Encodear3($rut_sesion), $row_pestanas_dinamicas);
        }
        $html = str_replace("{PESTANAS_DINAMICAS}", $row_pestanas_dinamicas, $html);
    } else {
        if ($datos_empresa[0]->template_menu_superior) {
            $html = str_replace("{MENU_SUPERIOR}", file_get_contents("views/menu/" . $datos_empresa[0]->template_menu_superior . ""), $html);
        } else {
            $html = str_replace("{MENU_SUPERIOR}", file_get_contents("views/menu/menu_superior.html"), $html);
        }
    }
    $html = str_replace("{IMAGEN_BANNER_FORM_CONTRATO}", $datos_empresa[0]->imagen_banner_form_contacto, $html);
    if ($datos_empresa[0]->template_footer) {
        $html = str_replace("{BLOQUEFOOTERCONTENIDO}", file_get_contents("views/footer_contenido/" . $datos_empresa[0]->template_footer . ""), $html);
    } else {
        $html = str_replace("{BLOQUEFOOTERCONTENIDO}", "", $html);
    }
    $html = str_replace("{IMAGEN_BANNER_FORM_CONTRATO}", $datos_empresa[0]->imagen_banner_form_contacto, $html);
    //MENU INFERIOR
    if ($datos_empresa[0]->template_menu_inferior) {
        $html = str_replace("{MENU_INFERIOR}", file_get_contents("views/menu/" . $datos_empresa[0]->template_menu_inferior . ""), $html);
    } else {
        $html = str_replace("{MENU_INFERIOR}", file_get_contents("views/menu/menu_inferior.html"), $html);
    }
    //$html = str_replace("{MENU_SECUNDARIO}",file_get_contents("views/menu_secundario/menu_secundario.html"),$html);
    //$html = str_replace("{MENU_INFERIOR}",file_get_contents("views/menu/menu_inferior.html"),$html);
    $html                  = str_replace("{FOOTER}", file_get_contents("views/footer.html"), $html);
    $html                  = str_replace("{MENU_DETALLE_CURSOS}", file_get_contents("views/cursos/menu_detalle_curso.html"), $html);
    //$html = str_replace("{LOGO}",file_get_contents("views/logo.html"),$html);
    $datos_empresa_holding = DatosEmpresaHolding($datos_usuario[0]->nombre_empresa_holding);
    if ($_SESSION["logo"]) {
        $html = str_replace("{ARCHIVO}", $_SESSION["logo"], $html);
    } else {
        if ($datos_empresa_holding[0]->imagen) {
            $html = str_replace("{ARCHIVO}", $datos_empresa_holding[0]->imagen, $html);
        } else {
            $html = str_replace("{ARCHIVO}", $datos_empresa[0]->archivo, $html);
        }
    }


    $html = str_replace("{HEAD}", file_get_contents("views/head.html"), $html);

    $html = str_replace("{HEAD_DINAMICO}",     file_get_contents("views/head/" . $id_empresa . "_head.html"), $html);
    $html = str_replace("{MENU_DINAMICO}",     file_get_contents("views/menu/" . $id_empresa . "_menu_principal.html"), $html);
    $html = str_replace("{FOOTER_DINAMICO}",file_get_contents("views/head/" . $id_empresa . "_footer.html"), $html);
    $html = str_replace("{PERFIL_DINAMICO}",file_get_contents("views/menu/" . $id_empresa . "_perfil_principal.html"), $html);
    $esjefe            = EsJefeLidertblUsuario($rut, $id_empresa);
    //print_r($esjefe);

    if($esjefe>0 or $rut=="10033383" or $rut=="15720101" or $rut=="bchile"  ){
        $html = str_replace("{MENU_DINAMICO_BOTON_MI_EQUIPO}","
        <li><a href='?sw=mi_equipo_lider'><button class='btn btn-outline'>Mi Equipo</button></a></li>", $html);
         $html = str_replace("{MENU_DINAMICO_BOTON_MI_EQUIPO2}","
        <li><a href='?sw=mi_equipo_lider'>Mi Equipo</a></li>", $html);
    } else {
        $html = str_replace("{MENU_DINAMICO_BOTON_MI_EQUIPO}","", $html);
        $html = str_replace("{MENU_DINAMICO_BOTON_MI_EQUIPO2}","", $html);
    }
    if($id_empresa=="83"){
            if($esjefe>0 or $esjefeResponsabl>0 or $esliderEjecutivo>0){

                    $boton_miequipo_vista_LG='
                            <li>
                                <center><a href="?sw=mi_equipo_vista&amp;p=principal">  <img src="img/botonera_superior_v2_03.png" width="64px"></a></center><a href="?sw=mi_equipo_vista&amp;p=principal"></a>
                            </li>';
                    $boton_miequipo_vista_SM='<a href="?sw=mi_equipo_vista&p=principal">Equipo</a>  ';

                    $html = str_replace("{MI_EQUIPO_VISTA_LG}",$boton_miequipo_vista_LG, $html);
                    $html = str_replace("{MI_EQUIPO_VISTA_SM}",$boton_miequipo_vista_SM, $html);
        } else {
                    $html = str_replace("{MI_EQUIPO_VISTA_LG}","", $html);
                    $html = str_replace("{MI_EQUIPO_VISTA_SM}","", $html);    }
    }
    if($id_empresa=="52"){

          //echo "<br>menu 52";
          $malla="wa_exp";
          $array_es_UsuarioMalla=BuscaUsuariosInscripcionUsuariosMalla($rut, $malla, $id_empresa);
          if($array_es_UsuarioMalla[0]->id_curso<>''){
                        $html = str_replace("{MENU_DINAMICO_BOTON_MIS_CURSOS}"," <li><a href='?sw=curso_por_secciones'>Mis Cursos</a></li>", $html);

          }  else {
                        $html = str_replace("{MENU_DINAMICO_BOTON_MIS_CURSOS}","", $html);

          }
                          //print_r($array_es_UsuarioMalla);

    }


    if($esjefe>0 or $esjefeResponsabl>0 or $esliderEjecutivo>0){
                            if($id_empresa=="62"){
                                    $boton_miequipo_vista='<a href="?sw=mi_equipo_vista&amp;p=principal" class="button button-border  button-fill button-yellow"><span>Mi Equipo</span></a>';
                            }
                            $html = str_replace("{MI_EQUIPO_VISTA}",$boton_miequipo_vista, $html);
        } else {            $html = str_replace("{MI_EQUIPO_VISTA}","", $html);
    }



        $html = str_replace("{MENU_DINAMICO_BOTON_PERSONAS}","
        <li><a href='?sw=personas'><button class='btn btn-outline'>
        #BuscaPersonas</button></a> </li>", $html);

            $html = str_replace("{MENU_DINAMICO_BOTON_AGRADECE}","
        <li><a href='?sw=home_agradecer'><button class='btn btn-outline'>
        Agradecer</button></a> </li>", $html);





    if($rut=="10033383" or $rut=="15720101" or $rut=="bchile" or $rut=="16886519"     or $rut=="12881018"
       or $rut=="11730748" or $rut=="12881018"  or $rut=="13057471"     or $rut=="15329782"  or $rut=="15720101"){
        $html = str_replace("{MENU_DINAMICO_BOTON_RECONOCE}","
        <li><a href='?sw=home_reconocer'><button class='btn btn-outline'>
        Reconocer</button></a> </li>", $html);

        $html = str_replace("{MENU_DINAMICO_BOTON_RECONOCE_LANDING}","
        <li><a href='?sw=home_reconocer_landing'><button class='btn btn-outline'>
        Reconocer</button></a> </li>", $html);

        $html = str_replace("{MENU_DINAMICO_BOTON_COLABORA}","
        <li><a href='?sw=home_colaboracion'><button class='btn btn-outline'>
        Colaboraci?n</button></a> </li>", $html);

        $html = str_replace("{MENU_DINAMICO_BOTON_COMUNIDAD}","", $html);

        $html = str_replace("{MENU_DINAMICO_BOTON_COMUNIDAD}","
        <li><a href='?sw=com_mp_personal'><button class='btn btn-outline'>
        Comunidad</button></a></li>", $html);

    } else {
       $html = str_replace("{MENU_DINAMICO_BOTON_RECONOCE}","
        <li><a href='?sw=home_reconocer'><button class='btn btn-outline'>
        Reconocer</button></a> </li>", $html);

        $html = str_replace("{MENU_DINAMICO_BOTON_RECONOCE_LANDING}","
        <li><a href='?sw=home_reconocer_landing'><button class='btn btn-outline'>
        Reconocer</button></a> </li>", $html);
        $html = str_replace("{MENU_DINAMICO_BOTON_COMUNIDAD}","", $html);
    }


    $html = str_replace("{MENU_DINAMICO_BOTON_RECONOCE}","", $html);
 //SGD

$Usua=DatosUsuario_($rut, $id_empresa);
      if($Usua[0]->division=="Division Personas y Organizacion" ){
        $html = str_replace("{MENU_DINAMICO_BOTON_SGD}","<li><a href='?sw=evaluacion_integral'><button class='btn btn-outline'>
        Evaluaci&oacute;n Integral</button></a></li>", $html);

    } else {
        $html = str_replace("{MENU_DINAMICO_BOTON_SGD}","<li><a href='?sw=evaluacion_integral'><button class='btn btn-outline'>
        Evaluaci&oacute;n Integral</button></a></li>", $html);
    }




    $rut  = $_SESSION["user_"];
    if ($_SESSION["css"]) {
        $html = str_replace("{STYLE_DINAMICO}", "empresa/" . $_SESSION["css"], $html);
    } else {
        if ($datos_empresa_holding[0]->css) {
            $html = str_replace("{STYLE_DINAMICO}", "empresa/" . $datos_empresa_holding[0]->css, $html);
        } else if ($datos_empresa[0]->css_nombre) {
            $html = str_replace("{STYLE_DINAMICO}", "empresa/" . $datos_empresa[0]->css_nombre, $html);
        } else {
            $html = str_replace("{STYLE_DINAMICO}", "style.css", $html);
        }
    }
    //Aca Hago dinamico losbotones SGD y CURSOS
    if ($datos_empresa[0]->cursos == 1) {
        $html = str_replace("{PESTANAS_CURSOS}", file_get_contents("views/pestana_cursos.html"), $html);
    } else {
        $html = str_replace("{PESTANAS_CURSOS}", "", $html);
    }
    if ($datos_empresa[0]->sgd == 1) {
        $html = str_replace("{PESTANAS_SGD}", file_get_contents("views/pestana_sgd.html"), $html);
    } else {
        $html = str_replace("{PESTANAS_SGD}", "", $html);
    }
    if ($datos_empresa[0]->dnc == 1) {
        $html = str_replace("{PESTANAS_DNC}", file_get_contents("views/pestana_dnc.html"), $html);
    } else {
        $html = str_replace("{PESTANAS_DNC}", "", $html);
    }
    if ($datos_empresa[0]->noticias == 1) {
        $html = str_replace("{PESTANAS_NOTICIAS}", file_get_contents("views/pestana_noticias.html"), $html);
    } else {
        $html = str_replace("{PESTANAS_NOTICIAS}", "", $html);
    }
    if ($datos_empresa[0]->home == 1) {
        $html = str_replace("{PESTANAS_HOME}", file_get_contents("views/pestana_home.html"), $html);
    } else {
        $html = str_replace("{PESTANAS_HOME}", "", $html);
    }
    if ($datos_empresa[0]->biblioteca == 1) {
        $html = str_replace("{PESTANAS_BIBLIOTECA}", file_get_contents("views/pestana_biblioteca.html"), $html);
    } else {
        $html = str_replace("{PESTANAS_BIBLIOTECA}", "", $html);
    }
    if ($datos_empresa[0]->galeria == 1) {
        $html = str_replace("{PESTANAS_GALERIA}", file_get_contents("views/pestana_galeria.html"), $html);
    } else {
        $html = str_replace("{PESTANAS_GALERIA}", "", $html);
    }
    if ($datos_empresa[0]->pestana_dinamica) {
        $html    = str_replace("{PESTANA_DINAMICA}", file_get_contents("views/pestana_generico.html"), $html);
        $arreglo = explode("*", $datos_empresa[0]->pestana_dinamica);
        $html    = str_replace("{NOMBRE_PESTANA}", $arreglo[0], $html);
        $html    = str_replace("{LINK_PESTANA_GENERICA}", $arreglo[1], $html);
    } else {
        $html = str_replace("{PESTANA_DINAMICA}", "", $html);
    }
    $html = str_replace("{COLOR_PRIMARIO}", $datos_empresa[0]->color_primario, $html);
    if ($_SESSION["link_salir"]) {
        $html = str_replace("{LINK_SALIR}", "?sw=" . $_SESSION["link_salir"], $html);
    } else {
        $html = str_replace("{LINK_SALIR}", "../../" . $datos_empresa[0]->link_salir, $html);
    }
    $html   = str_replace("{HEAD}", file_get_contents("views/head.html"), $html);
    $html   = str_replace("{TITULO_PAGINA}", utf8_encode($datos_empresa[0]->titulo_pagina), $html);
    $html   = str_replace("{ICO}", $datos_empresa[0]->ico, $html);
    $html   = str_replace("{CASE_HOME}", $datos_empresa[0]->case_home, $html);
    $html   = str_replace("{SALON_FAMA}", file_get_contents("views/cursos/salonfama.html"), $html);
    //Dado la variable sw enviada por get, hago replace a TITULO_PARRAFO
    $titulo = ObtenertituloCase($environment_sw);
    $html   = str_replace("{TITULO_PARRAFO}", utf8_encode($titulo[0]->titulo), $html);
    //print_r($datos_usuario[0]->nombre_empresa_holding);
    //con el nombre empresa holding, veo si tiene logo
    $html   = str_replace("{LOGO_EMPRESA}", utf8_encode($datos_empresa[0]->archivo), $html);
    return ($html);
}
function ColocaBotonera1($html, $estado)
{
    //Seccion para colocar la botonera 1
    $rut          = $_SESSION["user_"];
    //$es_validador=EsValidador($rut);
    $es_validador = EsValidador2($rut);
    if ($es_validador) {
        if ($_SESSION["id_empresa"] == "11") {
            $html = str_replace("{BOTONERA1}", file_get_contents("views/sgd/botonera_1_validador.html"), $html);
        } else {
            if ($_SESSION["id_empresa"] == 43) {
                $html = str_replace("{BOTONERA1}", file_get_contents("views/sgd/botonera_1_turbus.html"), $html);
            } else {
                $html = str_replace("{BOTONERA1}", file_get_contents("views/sgd/botonera1/botonera_1_dinamica.html"), $html);
            }
        }
    } else {
        $tiene_evaluados = EvaluadosDadoEvaluador($rut);
        if ($tiene_evaluados) {
            if ($_SESSION["id_empresa"] == 28) {
                $html = str_replace("{BOTONERA1}", file_get_contents("views/sgd/botonera_1_chilquinta.html"), $html);
            } else if ($_SESSION["id_empresa"] == 433) {
                $html = str_replace("{BOTONERA1}", file_get_contents("views/sgd/botonera_1_turbus.html"), $html);
            } else {
                $html = str_replace("{BOTONERA1}", file_get_contents("views/sgd/botonera_1.html"), $html);
            }
        } else {
            $html = str_replace("{BOTONERA1}", file_get_contents("views/sgd/botonera_1_sin_col.html"), $html);
        }
    }
    $html = FuncionesTransversales($html);
    if ($estado == 1) {
        $html = str_replace("{ESTADO1}", "active", $html);
    } else if ($estado == 2) {
        $html = str_replace("{ESTADO2}", "active", $html);
    } else if ($estado == 3) {
        $html = str_replace("{ESTADO3}", "active", $html);
    } else if ($estado == 4) {
        $html = str_replace("{ESTADO4}", "active", $html);
    }
    $html = str_replace("{ESTADO1}", "pasive", $html);
    $html = str_replace("{ESTADO2}", "pasive", $html);
    $html = str_replace("{ESTADO3}", "pasive", $html);
    $html = str_replace("{ESTADO4}", "pasive", $html);
    return ($html);
}
function ColocaBotonera2($html, $estado_pestana, $id_proceso)
{
    $id_empresa          = $_SESSION["id_empresa"];
    $rut_session         = $_SESSION["user_"];
    $estado_pestana      = trim($estado_pestana);
    $datos_empresa       = DatosEmpresa($id_empresa);
    $sgd_version         = $datos_empresa[0]->sgd_version;
    //Esta botonera ser? por empresa, por cada empresa, traigo todos los procesos de eval
    //$procesos_evaluacion=ProcesosEvalPorEmpresa($id_empresa);
    $procesos_evaluacion = ProcesosEvalPorEmpresaPorAno($id_empresa, $_SESSION["id_proceso_anual"]);
    //Seccion para colocar la botonera 1
    //$rut=$_SESSION["user_"];
    //$tiene_evaluados=EvaluadosDadoEvaluador($rut);
    //$html = str_replace("{BOTONERA_2}",file_get_contents("views/sgd/botonera_2.html"),$html);
    //if($id_empresa==28){
    if ($sgd_version == 2) {
        if ($id_empresa == 22) {
            $html = str_replace("{BOTONERA_2}", file_get_contents("views/sgd/botonera2/botonera_dinamica_sin_bitacora.html"), $html);
        } else if ($id_empresa == 41) {
            $html = str_replace("{BOTONERA_2}", file_get_contents("views/sgd/botonera2/41_botonera_dinamica.html"), $html);
        } else if ($id_empresa == 43) {
            $html = str_replace("{BOTONERA_2}", file_get_contents("views/sgd/botonera2/41_botonera_dinamica.html"), $html);
        } else if ($id_empresa == 30) {
            $html = str_replace("{BOTONERA_2}", file_get_contents("views/sgd/botonera2/30_ botonera_dinamica.html"), $html);
        } else if ($id_empresa == 66) {
            $html = str_replace("{BOTONERA_2}", file_get_contents("views/sgd/botonera2/66_botonera_dinamica.html"), $html);
        } else if ($id_empresa == 74) {
            $html = str_replace("{BOTONERA_2}", file_get_contents("views/sgd/botonera2/74_botonera_dinamica.html"), $html);
        } else if ($id_empresa == 61) {
            $html = str_replace("{BOTONERA_2}", file_get_contents("views/sgd/botonera2/61_botonera_dinamica.html"), $html);
        } else {
            $html = str_replace("{BOTONERA_2}", file_get_contents("views/sgd/botonera2/botonera_dinamica_chilquinta.html"), $html);
        }
    } else {
        $html = str_replace("{BOTONERA_2}", file_get_contents("views/sgd/botonera2/botonera_dinamica.html"), $html);
    }
    if ($estado_pestana == "bitacora") {
        $html = str_replace("{ESTADOBITACORA}", "botonera_activo", $html);
    } else {
        $html = str_replace("{ESTADOBITACORA}", "botonera_pasivo", $html);
    }
    if ($estado_pestana == "homeHistoricos") {
        $html = str_replace("{ESTADOHISTORICOS}", "botonera_activo", $html);
    } else {
        $html = str_replace("{ESTADOHISTORICOS}", "botonera_pasivo", $html);
    }
    //Aca veo los procesos de evaluacion que tiene esta empresa, y los coloco dinamicamente en las botonera
    //$procesos_evaluacion=TraeProcesosDeEvaluacionPorEmpresa($id_empresa);
    $datos_proceso_anual = DatosProcesoAnualPorId($_SESSION["id_proceso_anual"]);
    if ($datos_proceso_anual[0]->activo == 0) {
        //$html = str_replace("{PROCESOS_EVALUACION}","<td width='70%'></td>",$html);
    }
    if ($procesos_evaluacion) {
        //$html = str_replace("{PROCESOS_EVALUACION}","si tiene",$html);
        foreach ($procesos_evaluacion as $proceso) {
            if ($proceso->calibracion == "si") {
                //Verifico si el usuario es calibrador, solo si es calibrador, se le muestra esta pesta?a
                $es_calibrador = TraeEvaluadoresPorProcesoDadoCalibrador($rut_session, $proceso->id_proceso_a_calibrar);
                if (!$es_calibrador) {
                    continue;
                }
            }
            $pestanas_evaluaciones .= file_get_contents("views/sgd/botonera2/pestanas_dinamica.html");
            if ($proceso->environment) {
                $pestanas_evaluaciones = str_replace("{TEMPALTE_HREF_TITULO}", file_get_contents("views/sgd/botonera2/pestanas_dinamica_link.html"), $pestanas_evaluaciones);
            } else {
                $pestanas_evaluaciones = str_replace("{TEMPALTE_HREF_TITULO}", file_get_contents("views/sgd/botonera2/pestanas_dinamica_alert.html"), $pestanas_evaluaciones);
                $pestanas_evaluaciones = str_replace("{TEXTO_ALERT}", utf8_encode($proceso->mensaje_alert), $pestanas_evaluaciones);
            }
            $pestanas_evaluaciones = str_replace("{NOMBRE_PROCESO_EVALUACION}", utf8_encode($proceso->descripcion_proceso), $pestanas_evaluaciones);
            $pestanas_evaluaciones = str_replace("{ENVIRONMENT_POR_PROCESO}", ($proceso->environment), $pestanas_evaluaciones);
            $pestanas_evaluaciones = str_replace("{ID_PROCESO_ENCODEADO}", Encodear3($proceso->id_proceso), $pestanas_evaluaciones);
            $pestanas_evaluaciones = str_replace("{ID_PROCESO}", $proceso->id_proceso, $pestanas_evaluaciones);
            if ($id_proceso == $proceso->id_proceso) {
                $pestanas_evaluaciones = str_replace("{ESTADO" . $proceso->id_proceso . "}", "botonera_activo", $pestanas_evaluaciones);
            } else {
                $pestanas_evaluaciones = str_replace("{ESTADO" . $proceso->id_proceso . "}", "botonera_pasivo", $pestanas_evaluaciones);
            }
            //Traigo las etapas por proceso,
            $etapas     = EtapasPorProceso($proceso->id_proceso);
            $etapas_row = "";
            foreach ($etapas as $etapa_unica) {
                $etapas_row .= file_get_contents("views/sgd/botonera2/etapas_por_proceso.html");
                $etapas_row = str_replace("{NOMBRE_PROCESO}", $etapa_unica->etapa, $etapas_row);
                $etapas_row = str_replace("{ETIQUETA_ICONO}", $etapa_unica->etiqueta_icono, $etapas_row);
                $etapas_row = str_replace("{ETIQUETA_PORCENTAJE}", $etapa_unica->etiqueta_porcentaje, $etapas_row);
                $etapas_row = str_replace("{ID_ETAPA}", $etapa_unica->id, $etapas_row);
                if ($etapa_unica->codigo == "evaluacion") {
                    $avance     = ColocaAvanceSemaforosProcesoEvaluacionPorEvaluador($proceso->id_proceso, $etapa_unica->id, $rut_session);
                    $etapas_row = str_replace("{POR_" . $etapa_unica->id . "}", FormatearPorcentajesSinDecimal($avance[0]) . "%", $etapas_row);
                    $etapas_row = str_replace("{ICO_" . $etapa_unica->id . "}", $avance[1], $etapas_row);
                } else {
                }
            }
            $pestanas_evaluaciones = str_replace("{LISTADO_ETAPAS}", utf8_encode($etapas_row), $pestanas_evaluaciones);
        }
        $html = str_replace("{PROCESOS_EVALUACION}", $pestanas_evaluaciones, $html);
    } else {
        $html = str_replace("{PROCESOS_EVALUACION}", "", $html);
    }
    /*if($estado=='bitacora'){
    $html = str_replace("{ESTADOBITACORA}","botonera_activo",$html);
    }*/
    /*
     * else if($estado=="sgdchilquinta"){
     $html = str_replace("{ESTADO_INICIO}","botonera_activo",$html);
     }else if($estado=="homePlanes"){
     $html = str_replace("{ESTADO_PLANES}","botonera_activo",$html);
     }
     * */
    $html                 = str_replace("{ESTADO_INICIO}", "botonera_pasivo", $html);
    $html                 = str_replace("{ESTADO_PLANES}", "botonera_pasivo", $html);
    //Link para pesta?a de evaluacion intermedia
    $finalizado_evaluador = FinalizadoEvaluador($rut_session);
    if ($finalizado_evaluador) {
        $html = str_replace("{LINK_EVALUACION_EQUIPO}", "sgd2", $html);
    } else {
        $html = str_replace("{LINK_EVALUACION_EQUIPO}", "ev", $html);
    }
    //Seccion para colcoar el combobox de los historicos
    //Dada la empresa, traigo los procesos de evaluacion
    $procesos_eval      = ProcesosEvalPorEmpresaYTipoEvaluacion($id_empresa);
    $options_historicos = "";
    if ($id_empresa == 28) {
        foreach ($procesos_eval as $ev) {
            //Por cada proceso de evaluacion, veo si el Rut de la session, se encuentra dentro de ese proceso
            $id_proceso_evaluacion = $ev->id_proceso;
            $esta_en_proceso       = UsuarioSeEncuentraEnProcesoEvaluacion($_SESSION["user_"], $id_proceso_evaluacion);
            if ($esta_en_proceso) {
                //if($id_proceso==$ev->id_proceso){
                if ($_SESSION["ano_proceso_anual"] == $ev->ano) {
                    $options_historicos .= "<option selected value='" . Encodear3($ev->id_proceso) . "'>" . $ev->titulo_informes_proceso . "</option>";
                } else {
                    $options_historicos .= "<option value='" . Encodear3($ev->id_proceso) . "'>" . $ev->titulo_informes_proceso . "</option>";
                }
            }
        }
        $html = str_replace("{OPTIONS_PROCESOS}", $options_historicos, $html);
    }
    return ($html);
}
function ColocaBotoneraEntornoValidacion($html, $estado)
{
    //Seccion para colocar la botonera 1
    //$rut=$_SESSION["user_"];
    //$tiene_evaluados=EvaluadosDadoEvaluador($rut);
    $html = str_replace("{BOTONERA_2}", file_get_contents("views/sgd/botonera_validacion.html"), $html);
    if ($estado == 1) {
        $html = str_replace("{ESTADO11}", "botonera_activo", $html);
    } else if ($estado == 2) {
        $html = str_replace("{ESTADO22}", "botonera_active", $html);
    } else if ($estado == 3) {
        $html = str_replace("{ESTADO33}", "botonera_active", $html);
    } else if ($estado == 4) {
        $html = str_replace("{ESTADO44}", "botonera_active", $html);
    }
    $html = str_replace("{ESTADO11}", "botonera_pasivo", $html);
    $html = str_replace("{ESTADO22}", "botonera_pasivo", $html);
    $html = str_replace("{ESTADO33}", "botonera_pasivo", $html);
    $html = str_replace("{ESTADO44}", "botonera_pasivo", $html);
    return ($html);
}
function ColocaBotonera2MiPerfil($html, $estado)
{
    //Seccion para colocar la botonera 1
    //$rut=$_SESSION["user_"];
    //$tiene_evaluados=EvaluadosDadoEvaluador($rut);
    $html = str_replace("{BOTONERA_2}", file_get_contents("views/sgd/botonera_2_miperfil.html"), $html);
    if ($_SESSION["id_empresa"] == 30) {
        $html = str_replace("{ID_PROCESO_ENCODEADO}", Encodear3(39), $html);
    }
    if ($estado == 1) {
        $html = str_replace("{ESTADO11}", "botonera_activo", $html);
    } else if ($estado == 2) {
        $html = str_replace("{ESTADO22}", "botonera_active", $html);
    } else if ($estado == 3) {
        $html = str_replace("{ESTADO33}", "botonera_active", $html);
    } else if ($estado == 4) {
        $html = str_replace("{ESTADO44}", "botonera_active", $html);
    }
    $html = str_replace("{ESTADO11}", "botonera_pasivo", $html);
    $html = str_replace("{ESTADO22}", "botonera_pasivo", $html);
    $html = str_replace("{ESTADO33}", "botonera_pasivo", $html);
    $html = str_replace("{ESTADO44}", "botonera_pasivo", $html);
    return ($html);
}
function EnviaCorreoMensajeria($tipo_correo, $emisor, $id_empresa, $destinatario, $mensaje, $tipo_mensaje)
{
    $datos_template_correo = ObtengoTipoCorreoPorProcesoEmpresa($id_empresa, $tipo_correo);
    $datos_destinatario    = UsuarioEnBasePersonas($destinatario);
    //print_r($datos_destinatario);exit;
    $datos_emisor          = UsuarioEnBasePersonas($emisor);
    $template_correo       = file_get_contents("views/correos/" . $datos_template_correo[0]->template);
    $template_correo       = str_replace("{TITULO1}", $datos_template_correo[0]->titulo1, $template_correo);
    $template_correo       = str_replace("{TITULO2}", $datos_template_correo[0]->titulo2, $template_correo);
    $template_correo       = str_replace("{TEXTO1}", $datos_template_correo[0]->texto1, $template_correo);
    $template_correo       = str_replace("{TEXTO2}", $datos_template_correo[0]->texto2, $template_correo);
    $template_correo       = str_replace("{TEXTOLINK}", $datos_template_correo[0]->textolink, $template_correo);
    $template_correo       = str_replace("{TEXTO3}", $datos_template_correo[0]->texto3, $template_correo);
    $template_correo       = str_replace("{TEXTO4}", $datos_template_correo[0]->texto4, $template_correo);
    $template_correo       = str_replace("{TEXTOFOOTER1}", $datos_template_correo[0]->textofooter1, $template_correo);
    $template_correo       = str_replace("{TEXTOFOOTER2}", $datos_template_correo[0]->textofooter2, $template_correo);
    $template_correo       = str_replace("{NOMBREUSUARIO}", utf8_encode($datos_emisor[0]->nombre) . " " . utf8_encode($datos_emisor[0]->apaterno) . " " . utf8_encode($datos_emisor[0]->amaterno), $template_correo);
    $template_correo       = str_replace("{texto_mensaje}", utf8_encode($mensaje), $template_correo);
    $asunto_mensaje        = TraeAsuntoDeMensaje($tipo_mensaje);
    $template_correo       = str_replace("{ASUNTO}", utf8_encode($asunto_mensaje[0]->nombre), $template_correo);
    $template_correo       = str_replace("{asunto}", utf8_encode($asunto_mensaje[0]->nombre), $template_correo);
    $datos_empresa         = DatosEmpresa($id_empresa);
    $mail                  = new PHPMailer;
    //Tell PHPMailer to use SMTP
    $mail->isSMTP(); //Enable SMTP debugging
    // 0 = off (for production use)
    // 1 = client messages
    // 2 = client and server messages
    $mail->SMTPDebug   = 1;
    //Ask for HTML-friendly debug output
    $mail->Debugoutput = 'error_log';
    //Set the hostname of the mail server
    $mail->Host        = $datos_empresa[0]->server;
    //Set the SMTP port number - likely to be 25, 465 or 587
    $mail->Port        = 25;
    //Whether to use SMTP authentication
    $mail->SMTPAuth    = true;
    //Username to use for SMTP authentication
    $mail->Username    = $datos_empresa[0]->envio_correos;
    //Password to use for SMTP authentication
    $mail->Password    = $datos_empresa[0]->envio_correos_pass;
    //Set who the message is to be sent from
    $mail->setFrom($datos_empresa[0]->envio_correos, $datos_empresa[0]->envio_correos);
    //Set an alternative reply-to address
    //$mail->addReplyTo('replyto@example.com', 'First Last');
    //Set who the message is to be sent to
    $mail->addAddress($datos_destinatario[0]->email, $datos_destinatario[0]->nombre_completo);
    //$mail->addAddress("daniel@gop.cl", $datos_destinatario[0]->nombre_completo);
    //$mail->addAddress("rod@gop.cl", $datos_destinatario[0]->nombre_completo);
    $mail->AddBCC("backup@sgd.cl", "BCC: " . $datos_destinatario[0]->nombre_completo);
    //Set the subject line
    $mail->Subject = "Nuevo mensaje en Plataforma TNT";
    //Read an HTML message body from an external file, convert referenced images to embedded,
    //convert HTML into a basic plain-text alternative body
    $mail->msgHTML($template_correo, dirname(__FILE__));
    //Replace the plain text body with one created manually
    $mail->AltBody = 'Si no puedes visualizar este correo ....';
    //Attach an image file
    //$mail->addAttachment('images/phpmailer_mini.png');
    //send the message, check for errors
    if (!$mail->send()) {
        //echo "Mailer Error: " . $mail->ErrorInfo;
    } else {
        //echo "Message sent!";
    }
    //exit;
}
function EnviaCorreoLinkAcceso($correo_para, $nombre_para, $tokem, $id_template_correo, $tipo_correo, $id_empresa)
{
    if ($tipo_correo) {
        $datos_template_correo = ObtengoTipoCorreoPorTipoEmpresa($tipo_correo, $id_empresa);
    } else {
        $datos_template_correo = ObtengoTipoCorreoPorId($id_template_correo);
    }
    $template_correo = file_get_contents("views/correos/" . $datos_template_correo[0]->template);
    $template_correo = str_replace("{TITULO1}", $datos_template_correo[0]->titulo1, $template_correo);
    $template_correo = str_replace("{TITULO2}", $datos_template_correo[0]->titulo2, $template_correo);
    $template_correo = str_replace("{TEXTO2}", $datos_template_correo[0]->texto2, $template_correo);
    $template_correo = str_replace("{TEXTOLINK}", $datos_template_correo[0]->textolink, $template_correo);
    $template_correo = str_replace("{TEXTO3}", $datos_template_correo[0]->texto3, $template_correo);
    $template_correo = str_replace("{TEXTO4}", $datos_template_correo[0]->texto4, $template_correo);
    $template_correo = str_replace("{TEXTOFOOTER1}", $datos_template_correo[0]->textofooter1, $template_correo);
    $template_correo = str_replace("{TEXTOFOOTER2}", $datos_template_correo[0]->textofooter2, $template_correo);
    $link_acceso     = "http://plataformagop.ngd.cl/front/index.php?sw=chpex&tok=" . Encodear3($tokem) . "";
    $template_correo = str_replace("{LINK_CON_PARAMETROS}", $link_acceso, $template_correo);
    $mail            = new PHPMailer;
    //Set who the message is to be sent from
    $mail->setFrom($datos_template_correo[0]->from_correo, $datos_template_correo[0]->from);
    //Set an alternative reply-to address
    //$mail->addReplyTo('replyto@example.com', 'First Last');
    //Set who the message is to be sent to
    $mail->addAddress($correo_para, $nombre_para);
    //$mail->addAddress('dpezoa@gmail.com', $datos_usuario[0]->nombre_completo);
    $mail->AddBCC("backup@sgd.cl", "BCC: " . $nombre_para);
    //Set the subject line
    $mail->Subject = $datos_template_correo[0]->asunto;
    //Read an HTML message body from an external file, convert referenced images to embedded,
    //convert HTML into a basic plain-text alternative body
    $mail->msgHTML($template_correo, dirname(__FILE__));
    //Replace the plain text body with one created manually
    $mail->AltBody = 'Alt Body';
    //Attach an image file
    //$mail->addAttachment('img/Prop_Intranet_TNT.docx');
    //send the message, check for errors
    if (!$mail->send()) {
        echo "Mailer Error: " . $mail->ErrorInfo;
    } else {
        //echo "Message sent!";
    }
    //exit;
}
function EnviarCorreos($rut, $tipo, $rut_jefe)
{
    $tipo_correo   = ObtengoTipoCorreo($tipo);
    $datos_usuario = UsuarioEnBasePersonas($rut);
    $plantilla     = $tipo_correo[0]->texto;
    $plantilla     = str_replace("{NOMBRE_USUARIO}", htmlentities($datos_usuario[0]->nombre_completo), $plantilla);
    if ($tipo == "1") {
        $clave     = VerificaClaveAccesoSoloRut($rut);
        $plantilla = str_replace("{CLAVE}", htmlentities($clave[0]->clave), $plantilla);
    }
    if ($tipo == 3) {
        $datos_jefe = UsuarioEnBasePersonas($rut_jefe);
        $plantilla  = str_replace("{NOMBRE_JEFE}", htmlentities($datos_jefe[0]->nombre_completo), $plantilla);
    }
    //echo $plantilla;
    $mail = new PHPMailer;
    //Set who the message is to be sent from
    $mail->setFrom($tipo_correo[0]->from_correo, $tipo_correo[0]->from);
    //Set an alternative reply-to address
    //$mail->addReplyTo('replyto@example.com', 'First Last');
    //Set who the message is to be sent to
    //$mail->addAddress($datos_usuario[0]->email, $datos_usuario[0]->nombre_completo);
    $mail->addAddress('dpezoa@gmail.com', $datos_usuario[0]->nombre_completo);
    $mail->AddBCC("backup@sgd.cl", "BCC: " . $datos_usuario[0]->nombre_completo);
    //Set the subject line
    $mail->Subject = $tipo_correo[0]->titulo;
    //Read an HTML message body from an external file, convert referenced images to embedded,
    //convert HTML into a basic plain-text alternative body
    $mail->msgHTML($plantilla, dirname(__FILE__));
    //Replace the plain text body with one created manually
    $mail->AltBody = 'Alt Body';
    //Attach an image file
    //$mail->addAttachment('img/Prop_Intranet_TNT.docx');
    //send the message, check for errors
    if (!$mail->send()) {
        echo "Mailer Error: " . $mail->ErrorInfo;
    } else {
        //echo "Message sent!";
    }
    //exit;
}
function EnviarCorreosPruebas($rut, $template, $id_template_correo, $id_inscripcion)
{
    $datos_usuario           = UsuarioEnBasePersonas($rut);
    $detalle_correo_template = DatosDeCorreoDadoId($id_template_correo);
    $subject                 = $detalle_correo_template[0]->asunto;
    $datos_empresa           = DatosEmpresa($datos_usuario[0]->id_empresa);
    $fecha_y_hora            = date("Y-m-d") . " " . date("H:i:s");
    $parametros              = EncodearConRut($rut, $fecha_y_hora, $id_inscripcion);
    $template                = str_replace("{PARAMETROS}", $parametros, $template);
    $template                = str_replace("{PARAMETROIDPRIVADO}", $datos_usuario[0]->idprivado, $template);
    InsertoRegistroEnvioCorreo($rut, Encodear($rut) . "$" . Encodear($fecha_y_hora), $id_inscripcion);
    $mail = new PHPMailer;
    //Tell PHPMailer to use SMTP
    $mail->isSMTP();
    //Enable SMTP debugging
    // 0 = off (for production use)
    // 1 = client messages
    // 2 = client and server messages
    $mail->SMTPDebug   = 0;
    //Ask for HTML-friendly debug output
    $mail->Debugoutput = 'error_log';
    //Set the hostname of the mail server
    $mail->Host        = $datos_empresa[0]->server;
    //Set the SMTP port number - likely to be 25, 465 or 587
    $mail->Port        = 25;
    //Whether to use SMTP authentication
    $mail->SMTPAuth    = true;
    //Username to use for SMTP authentication
    $mail->Username    = $datos_empresa[0]->envio_correos;
    //Password to use for SMTP authentication
    $mail->Password    = $datos_empresa[0]->envio_correos_pass;
    //Set who the message is to be sent from
    $mail->setFrom($datos_empresa[0]->envio_correos, $datos_empresa[0]->envio_correos);
    //Set an alternative reply-to address
    //$mail->addReplyTo('replyto@example.com', 'First Last');
    //Set who the message is to be sent to
    $mail->addAddress($datos_usuario[0]->email, $datos_usuario[0]->nombre_completo);
    $mail->AddBCC("backup@sgd.cl", "BCC: " . $datos_usuario[0]->nombre_completo);
    //Set the subject line
    $mail->Subject = $subject;
    //Read an HTML message body from an external file, convert referenced images to embedded,
    //convert HTML into a basic plain-text alternative body
    $mail->msgHTML($template, dirname(__FILE__));
    //Replace the plain text body with one created manually
    $mail->AltBody = 'Si no puedes visualizar este correo ....';
    //Attach an image file
    //$mail->addAttachment('images/phpmailer_mini.png');
    //send the message, check for errors
    if (!$mail->send()) {
        //echo "Mailer Error: " . $mail->ErrorInfo;
    } else {
        //echo "Message sent!";
    }
}
function EnviarCorreosPruebasPorProceso($rut, $template, $id_template_correo, $id_proceso, $renvio)
{
    //$datos_usuario=UsuarioEnBasePersonas($rut);
    if ($renvio == "si") {
        $datos_usuario = DatosEnvioCorreoPorProcesoReenvio($rut, $id_proceso);
    } else {
        $datos_usuario = DatosEnvioCorreoPorProceso($rut, $id_proceso);
    }
    $detalle_correo_template = DatosDeCorreoDadoId($id_template_correo);
    $subject                 = $detalle_correo_template[0]->asunto;
    $datos_empresa           = DatosEmpresa(53);
    $fecha_y_hora            = date("Y-m-d") . " " . date("H:i:s");
    $parametros              = EncodearConRut($rut, $fecha_y_hora, $id_inscripcion);
    $template                = str_replace("{PARAMETROS}", $parametros, $template);
    $template                = str_replace("{PARAMETROIDPRIVADO}", $datos_usuario[0]->idprivado, $template);
    $template                = str_replace("{PARAMETROIDPRIVADOSINENCODEAR}", $rut, $template);
    InsertoRegistroEnvioCorreo($rut, Encodear($rut) . "$" . Encodear($fecha_y_hora), "", $id_proceso);
    $mail = new PHPMailer;
    //Tell PHPMailer to use SMTP
    $mail->isSMTP();
    //Enable SMTP debugging
    // 0 = off (for production use)
    // 1 = client messages
    // 2 = client and server messages
    $mail->SMTPDebug   = 0;
    //Ask for HTML-friendly debug output
    $mail->Debugoutput = 'error_log';
    //Set the hostname of the mail server
    $mail->Host        = $datos_empresa[0]->server;
    //Set the SMTP port number - likely to be 25, 465 or 587
    $mail->Port        = 25;
    //Whether to use SMTP authentication
    $mail->SMTPAuth    = true;
    //Username to use for SMTP authentication
    $mail->Username    = $datos_empresa[0]->envio_correos;
    //Password to use for SMTP authentication
    $mail->Password    = $datos_empresa[0]->envio_correos_pass;
    //Set who the message is to be sent from
    if ($_SESSION["id_empresa"] == 57) {
        $mail->setFrom("soporte@sgd.cl", "Escuela Watt's Industrial");
    } else {
        $mail->setFrom("soporte@sgd.cl", "soporte@sgd.cl");
    }
    //Set an alternative reply-to address
    //$mail->addReplyTo('replyto@example.com', 'First Last');
    //Set who the message is to be sent to
    $mail->addAddress($datos_usuario[0]->email, $datos_usuario[0]->nombre_completo);
    $mail->AddBCC("backup@sgd.cl", $datos_usuario[0]->nombre_completo);
    //Set the subject line
    $mail->Subject = $subject;
    //Read an HTML message body from an external file, convert referenced images to embedded,
    //convert HTML into a basic plain-text alternative body
    $mail->msgHTML($template, dirname(__FILE__));
    //Replace the plain text body with one created manually
    $mail->AltBody = 'Si no puedes visualizar este correo ....';
    //Attach an image file
    //$mail->addAttachment('images/phpmailer_mini.png');
    //send the message, check for errors
    if (!$mail->send()) {
        echo "Mailer Error: " . $mail->ErrorInfo;
    } else {
        echo "Message sent!";
    }
}
function EnviarCorreosPruebasgmail($rut, $template)
{
    $datos_usuario = UsuarioEnBasePersonas($rut);
    $datos_empresa = DatosEmpresa($datos_usuario[0]->id_empresa);
    $fecha_y_hora  = date("Y-m-d") . " " . date("H:i:s");
    $parametros    = EncodearConRut($rut, $fecha_y_hora, "");
    $template      = str_replace("{PARAMETROS}", $parametros, $template);
    InsertoRegistroEnvioCorreo($rut, Encodear($rut) . "$" . Encodear($fecha_y_hora));
    /**
     * This example shows settings to use when sending via Google's Gmail servers.
     */
    //SMTP needs accurate times, and the PHP time zone MUST be set
    //This should be done in your php.ini, but this is how to do it if you don't have access to that
    date_default_timezone_set('Etc/UTC');
    //Create a new PHPMailer instance
    $mail = new PHPMailer;
    //Tell PHPMailer to use SMTP
    $mail->isSMTP();
    //Enable SMTP debugging
    // 0 = off (for production use)
    // 1 = client messages
    // 2 = client and server messages
    $mail->SMTPDebug   = 0;
    //Ask for HTML-friendly debug output
    $mail->Debugoutput = 'html';
    $mail->Host        = 'smtp.gmail.com';
    $mail->Port        = 587;
    $mail->SMTPSecure  = 'tls';
    $mail->SMTPAuth    = true;
    $mail->Username    = "androidgopcl@gmail.com";
    $mail->Password    = "30072015";
    $mail->setFrom('David Pizarro');
    $mail->addAddress($datos_usuario[0]->email, $datos_usuario[0]->nombre_completo);
    $mail->Subject = 'PHPMailer GMail SMTP test';
    $mail->msgHTML($template, dirname(__FILE__));
    $mail->AltBody = 'This is a plain-text message body';
    //    $mail->addAttachment('images/phpmailer_mini.png');
    if (!$mail->send()) {
        echo "Mailer Error: " . $mail->ErrorInfo;
    } else {
        echo "Message sent!";
    }
}
function EnviaCorreoPrueba($rut, $template)
{
    //Traigo los datos del usuario
    $datos_usuario = UsuarioEnBasePersonas($rut);
    //Traigo los datos de la empresa
    $datos_empresa = DatosEmpresa($datos_usuario[0]->id_empresa);
    $fecha_y_hora  = date("Y-m-d") . " " . date("H:i:s");
    $parametros    = EncodearConRut($rut, $fecha_y_hora, "");
    $template      = str_replace("{PARAMETROS}", $parametros, $template);
    //guardo Registro de envio de Correos
    InsertoRegistroEnvioCorreo($rut, Encodear($rut) . "$" . Encodear($fecha_y_hora));
    $mail = new PHPMailer;
    //Set who the message is to be sent from
    $mail->setFrom("binvenidos@alasrf.cl", "Bienvenidos");
    //Set an alternative reply-to address
    //$mail->addReplyTo('replyto@example.com', 'First Last');
    //Set who the message is to be sent to
    //$mail->addAddress($datos_usuario[0]->email, $datos_usuario[0]->nombre_completo);
    $mail->addAddress($datos_usuario[0]->email, $datos_usuario[0]->nombre_completo);
    //$mail->addAddress("daniel@gop.cl", $datos_usuario[0]->nombre_completo);
    //$mail->AddBCC("rod@gop.cl","BCC: ".$datos_usuario[0]->nombre_completo);
    $mail->AddBCC("daniel@gop.cl", $datos_usuario[0]->nombre_completo);
    //Set the subject line
    //$mail->Subject = "Necesitamos tu apoyo fecha".date("Y-m-d")."', hora='".date("H:i:s");
    $mail->Subject = "Prueba de Correo Fecha " . date("Y-m-d") . "  hora=" . date("H:i:s");
    //Read an HTML message body from an external file, convert referenced images to embedded,
    //convert HTML into a basic plain-text alternative body
    $mail->msgHTML($template, dirname(__FILE__));
    //Replace the plain text body with one created manually
    $mail->AltBody = 'Si no puedes visualizar este correo ....';
    //Attach an image file
    //$mail->addAttachment('img/Prop_Intranet_TNT.docx');
    //send the message, check for errors
    if (!$mail->send()) {
        echo "Mailer Error: " . $mail->ErrorInfo;
    } else {
        //echo "Message sent!";
    }
}
////FUNCIONES PARA BIBLIOTECA Y GALERIAS
//BIBLIOTECA FRONT
function biblioteca_principal($html)
{
    $SUBcategorias = TraeTodasSubcategorias();
    foreach ($SUBcategorias as $SubCat) {
        $row       = file_get_contents("views/biblioteca/lista_todas_subcategorias.html");
        $row       = str_replace("{SUBCATEGORIA}", $SubCat->categoria, $row);
        $row       = str_replace("{DESCRIPCION}", $SubCat->descripcion, $row);
        $row       = str_replace("{DETALLE}", Total_archivos($SubCat->id), $row);
        $row       = str_replace("{ID}", $SubCat->id, $row);
        $row       = str_replace("{NSUBCAT}", $SubCat->categoria, $row);
        $Categoria = TraeCategoria($SubCat->id_categoria);
        $row       = str_replace("{NCAT}", $Categoria[0]->categoria, $row);
        $row       = str_replace("{IDCAT}", $SubCat->id_categoria, $row);
        $total_html .= $row;
    }
    $html       = str_replace("{LISTA}", $total_html, $html);
    $categorias = TraeCategorias();
    foreach ($categorias as $Cat) {
        $row = file_get_contents("views/biblioteca/lista_menu_categorias.html");
        $row = str_replace("{CATEGORIA}", $Cat->categoria, $row);
        $row = str_replace("{ID}", $Cat->id, $row);
        $total_html2 .= $row;
    }
    $html = str_replace("{OLMENU}", '<li class="active">Todas</li>', $html);
    $html = str_replace("{LISTA_CATEGORIAS}", $total_html2, $html);
    $html = str_replace("{TOTAL_AR}", "", $html);
    return ($html);
}
function biblioteca_subcategoria($html, $id, $ncat, $id_empresa, $id_comunidad)
{
    if ($id_comunidad) {
        $SUBcategorias = TraeSubCategoriasPorComunidad($id_comunidad, $id_empresa);
    } else {
        $SUBcategorias = TraeSubcategorias($id);
    }
    $i = 1;
    foreach ($SUBcategorias as $SubCat) {
        $row = file_get_contents("views/biblioteca/lista_todas_subcategorias.html");
        $row = str_replace("{SUBCATEGORIA}", $SubCat->categoria, $row);
        $row = str_replace("{DESCRIPCION}", $SubCat->descripcion, $row);
        $row = str_replace("{DETALLE}", Total_archivos($SubCat->id), $row);
        $row = str_replace("{ID}", $SubCat->id, $row);
        $row = str_replace("{IMAGEN}", $SubCat->imagen, $row);
        $row = str_replace("{FECHA}", $SubCat->fecha, $row);
        $row = str_replace("{NSUBCAT}", $SubCat->categoria, $row);
        $row = str_replace("{NCAT}", $ncat, $row);
        $row = str_replace("{IDCAT}", $id, $row);
        $total_html .= $row;
        if ($i == 2) {
            $i = 1;
            $total_html .= "<div class='row'></div>";
        } else {
            $i++;
        }
    }
    $html       = str_replace("{LISTA}", $total_html, $html);
    //$categorias=TraeCategorias();
    $categorias = TraeCategoriasPorEmpresa($id_empresa);
    foreach ($categorias as $Cat) {
        $row   = file_get_contents("views/biblioteca/lista_menu_categorias.html");
        $total = Total_archivos_categoria($Cat->id);
        $row   = str_replace("{TOTAL}", " (" . $total . ")", $row);
        $row   = str_replace("{CATEGORIA}", $Cat->categoria, $row);
        $row   = str_replace("{ID}", $Cat->id, $row);
        $total_html2 .= $row;
    }
    $html      = str_replace("{TITULO}", $ncat, $html);
    $categoria = TraeCategoria($id);
    $html      = str_replace("{FECHA}", $categoria[0]->fecha, $html);
    $html      = str_replace("{CDESCRIPCION}", $categoria[0]->descripcion, $html);
    $html      = str_replace("{VISITAS}", cuenta_visita("categoria", $id) . " Visitas", $html);
    $html      = str_replace("{OLMENU}", '<li class="active">' . $ncat . '</li>', $html);
    $html      = str_replace("{LISTA_CATEGORIAS}", $total_html2, $html);
    guarda_log_biblioteca("visita", $id, "1", "Categoria");
    $html = str_replace("{TOTAL_AR}", "", $html);
    return ($html);
}
function biblioteca_archivos($html, $id, $nsubcat, $ncat, $id_cat, $id_empresa)
{
    $rut           = $_SESSION["user_"];
    $datos_empresa = DatosEmpresa($id_empresa);
    $total_html    = "";
    $total_r       = "";
    //echo "hola $nsubcat,$ncat,$id_cat,$html,$id";
    //$archivos=TraeArchivos($id);
    $archivos      = TraeArchivosConOrden($id);
    foreach ($archivos as $ar) {
        $total_r++;
        //echo "<br>hoa ".$ar->titulo;
        if ($ar->link) {
            $row = file_get_contents("views/biblioteca/" . $id_empresa . "_lista_archivos_con_link.html");
        } else {
            if ($datos_empresa[0]->visualiza_megusta_biblioteca == 1) {
                $row = file_get_contents("views/biblioteca/" . $id_empresa . "_lista_archivos_sin_megusta.html");
            } else {
                $row = file_get_contents("views/biblioteca/" . $id_empresa . "_lista_archivos_row.html");
            }
        }
        $row          = str_replace("{ICONO}", "<img style='width:32px;height:32px;' src='img/iconos/" . $ar->icono . ".png'>", $row);
        $row          = str_replace("{NOMBRE}", utf8_encode($ar->titulo), $row);
        $row          = str_replace("{IMAGEN}", utf8_encode($ar->imagen), $row);
        $row          = str_replace("{FECHA}", utf8_encode($ar->fecha), $row);
        $row          = str_replace("{MEGUSTA}", ColocaMeGusta($ar->id, "id_archivo_biblioteca", $id_empresa, $rut), $row);
        $row          = str_replace("{DESCRIPCION}", utf8_encode($ar->descripcion), $row);
        $row          = str_replace("{DESCARGADO}", $ar->descargado, $row);
        $row          = str_replace("{DETALLE}", $ar->tamano, $row);
        //$row = str_replace("{DESCARGA}","funciones/descargar.php?file=".$ar->archivo."&id=".$ar->id."&name=".utf8_encode($ar->titulo).".".utf8_encode($ar->icono),$row);
        $row          = str_replace("{DESCARGA}", "?sw=DescargaArchivoBibliolist&file=" . $ar->archivo . "&id=" . $ar->id . "&name=" . utf8_encode($ar->titulo) . "." . utf8_encode($ar->icono), $row);
        $row          = str_replace("{LINK_BIBLIO}", $ar->link, $row);
        $row          = str_replace("{ID}", $ar->id, $row);
        $NombreCat    = $ar->NombreSubCat;
        $NombreSubCat = $ar->NombreCat;
        $total_html .= $row;
    }
    $html       = str_replace("{LISTA}", $total_html, $html);
    //$categorias=TraeCategorias();
    $categorias = TraeCategoriasPorEmpresa($id_empresa);
    foreach ($categorias as $Cat) {
        $row   = file_get_contents("views/biblioteca/lista_menu_categorias.html");
        $total = Total_archivos_categoria($Cat->id);
        $row   = str_replace("{TOTAL}", " (" . $total . ")", $row);
        $row   = str_replace("{CATEGORIA}", utf8_encode($Cat->categoria), $row);
        $row   = str_replace("{ID}", $Cat->id, $row);
        $total_html2 .= $row;
    }
    $html = str_replace("{LISTA_CATEGORIAS}", $total_html2, $html);
    $html = str_replace("{SUBCATEGORIA}", utf8_encode($NombreCat), $html);
    $html = str_replace("{CATEGORIA}", utf8_encode($NombreSubCat), $html);
    if ($total_r == 0) {
        $html = str_replace("{TOTAL_AR}", "No hay archivos", $html);
    } else {
        if ($total_r == 1) {
            $html = str_replace("{TOTAL_AR}", "Hay un total de " . $total_r . " archivo", $html);
        } else {
            $html = str_replace("{TOTAL_AR}", "Hay un total de " . $total_r . " archivos", $html);
        }
    }
    $html      = str_replace("{TITULO}", utf8_encode($nsubcat), $html);
    $categoria = TraeCategoria($id);
    $html      = str_replace("{CDESCRIPCION}", utf8_encode($categoria[0]->descripcion), $html);
    guarda_log_biblioteca("visita", $id, "1", "Subcategoria");
    $html = str_replace("{OLMENU}", '<li><a href="?sw=biblioteca&p=subcategoria&id=' . $id_cat . '&ncat=' . $ncat . '">' . $ncat . '</a></li><li class="active">' . $nsubcat . '</li>', $html);
    return ($html);
}
function biblioteca_archivos_busqueda($html, $buscar, $id_empresa)
{
    $total_html = "";
    $total_r    = "";
    //$archivos=TraeArchivos_busqueda($buscar);
    $archivos   = TraeArchivos_busquedaPorEmpresa($buscar, $id_empresa);
    foreach ($archivos as $ar) {
        $total_r++;
        $row = file_get_contents("views/biblioteca/lista_archivos.html");
        $row = str_replace("{ICONO}", "<img src='img/iconos/" . $ar->icono . ".png'>", $row);
        $row = str_replace("{NOMBRE}", $ar->titulo, $row);
        $row = str_replace("{DESCRIPCION}", $ar->descripcion, $row);
        $row = str_replace("{DETALLE}", $ar->tamano, $row);
        $row = str_replace("{IMAGEN}", $ar->imagen, $row);
        $row = str_replace("{FECHA}", $ar->fecha, $row);
        $row = str_replace("{DESCARGADO}", $ar->descargado, $row);
        $row = str_replace("{DESCARGA}", "./archivos_biblioteca/" . $ar->archivo, $row);
        $row = str_replace("{ID}", $ar->id, $row);
        $total_html .= $row;
    }
    $html       = str_replace("{LISTA}", $total_html, $html);
    //$categorias=TraeCategorias();
    $categorias = TraeCategoriasPorEmpresa($id_empresa);
    foreach ($categorias as $Cat) {
        $row   = file_get_contents("views/biblioteca/lista_menu_categorias.html");
        $row   = str_replace("{CATEGORIA}", $Cat->categoria, $row);
        $row   = str_replace("{ID}", $Cat->id, $row);
        $total = Total_archivos_categoria($Cat->id);
        $row   = str_replace("{TOTAL}", " (" . $total . ")", $row);
        $total_html2 .= $row;
    }
    if ($total_r == 0) {
        $html = str_replace("{TOTAL_AR}", "No hay archivos", $html);
    } else {
        if ($total_r == 1) {
            $html = str_replace("{TOTAL_AR}", "Hay un total de " . $total_r . " archivo", $html);
        } else {
            $html = str_replace("{TOTAL_AR}", "Hay un total de " . $total_r . " archivos", $html);
        }
    }
    $html = str_replace("{LISTA_CATEGORIAS}", $total_html2, $html);
    return ($html);
}

function biblioteca_inicio($html, $id_empresa)
{
    $total_html = "";
    $total_r    = "";
    $archivos   = ultimos_archivosPorEmpresa(3, $id_empresa);
    foreach ($archivos as $ar) {
        $total_r++;
        $row = file_get_contents("views/biblioteca/ultimos3_archivos.html");
        $row = str_replace("{ICONO}", "<img src='img/iconos/" . $ar->icono . ".png'>", $row);
        $row = str_replace("{NOMBRE}", $ar->titulo, $row);
        $row = str_replace("{DESCRIPCION}", $ar->descripcion, $row);
        $row = str_replace("{IMAGEN}", $ar->imagen, $row);
        $row = str_replace("{FECHA}", $ar->fecha, $row);
        $row = str_replace("{DESCARGADO}", $ar->descargado, $row);
        $row = str_replace("{DETALLE}", $ar->tamano, $row);
        $row = str_replace("{DESCARGA}", "./archivos_biblioteca/" . $ar->archivo, $row);
        $row = str_replace("{ID}", $ar->id, $row);
        $total_html .= $row;
    }
    $html      = str_replace("{LISTA1}", $total_html, $html);
    //$archivos2=mas_descargados(3);
    $archivos2 = mas_descargadosPorEmpresa(3, $id_empresa);
    foreach ($archivos2 as $ar2) {
        $row2 = file_get_contents("views/biblioteca/ultimos3_archivos.html");
        $row2 = str_replace("{ICONO}", "<img src='img/iconos/" . $ar2->icono . ".png'>", $row2);
        $row2 = str_replace("{NOMBRE}", $ar2->titulo, $row2);
        $row2 = str_replace("{DESCRIPCION}", $ar2->descripcion, $row2);
        $row2 = str_replace("{IMAGEN}", $ar2->imagen, $row2);
        $row2 = str_replace("{FECHA}", $ar2->fecha, $row2);
        $row2 = str_replace("{DESCARGADO}", $ar2->descargado, $row2);
        $row2 = str_replace("{DETALLE}", $ar2->tamano, $row2);
        $row2 = str_replace("{DESCARGA}", "./archivos_biblioteca/" . $ar2->archivo, $row2);
        $row2 = str_replace("{ID}", $ar2->id, $row2);
        $total_html1 .= $row2;
        //echo $ar2->imagen;
    }
    $html       = str_replace("{LISTA2}", $total_html1, $html);
    //$categorias=TraeCategorias();
    $categorias = TraeCategoriasPorEmpresa($id_empresa);
    foreach ($categorias as $Cat) {
        $row3  = file_get_contents("views/biblioteca/lista_menu_categorias.html");
        $row3  = str_replace("{CATEGORIA}", $Cat->categoria, $row3);
        $total = Total_archivos_categoria($Cat->id);
        $row3  = str_replace("{TOTAL}", " (" . $total . ")", $row3);
        $row3  = str_replace("{ID}", $Cat->id, $row3);
        $total_html2 .= $row3;
    }
    $html = str_replace("{LISTA_CATEGORIAS}", $total_html2, $html);
    return ($html);
}

function biblioteca_inicio_full($html, $id_empresa)
{
    $total_html = "";
    $total_r    = "";
     $categorias = TraeCategoriasPorEmpresa($id_empresa);
    foreach ($categorias as $Cat) {
        $row3  = file_get_contents("views/biblioteca/".$id_empresa."_lista_menu_categorias.html");
        $row3  = str_replace("{CATEGORIA}", $Cat->categoria, $row3);
        $total = Total_archivos_categoria($Cat->id);
        $row3  = str_replace("{TOTAL}", " (" . $total . ")", $row3);
        $row3  = str_replace("{ID}", $Cat->id, $row3);
        $total_html2 .= $row3;
    }
    $html = str_replace("{LISTA_CATEGORIAS}", $total_html2, $html);
    return ($html);
}

//FIN MODULO BIBLIOTECA
//INICIO GALERIA FRONT
function galeria_inicio($html, $id_empresa)
{
    $rut        = $_SESSION["user_"];
    $total_html = "";
    $total_r    = "";
    //$archivos=ultimos_archivos_galeria(6);
    $archivos   = ultimos_archivos_galeriaPorEmpresa(6, $id_empresa);
    foreach ($archivos as $ar) {
        $total_r++;
        $row = file_get_contents("views/galeria/ultimos3_archivos.html");
        $row = str_replace("{DESCRIPCION}", $ar->descripcion, $row);
        if ($ar->tipo == "video") {
            $figura = "<a  onclick='vista_galeria(" . $ar->id . ")' class='fancybox fancybox.iframe ratio' href='funciones/galeria/video.php?video=" . $ar->archivo . "' ><img src='img/galeria/video.png' alt='" . $ar->descripcion . "' class='img_responsive'/></a>";
            $row    = file_get_contents("views/galeria/ultimos3_archivos_video.html");
        } else {
            $figura = '<a href="galeria/' . $ar->archivo . '" title="' . $ar->descripcion . '" onclick="vista_galeria(' . $ar->id . ')"  data-gallery><img src="galeria/' . $ar->archivo . '""></a>';
        }
        $row    = str_replace("{FIGURA}", $figura, $row);
        $row    = str_replace("{IMAGEN}", "galeria/" . $ar->archivo, $row);
        $row    = str_replace("{ARCHIVO}", $img, $row);
        $row    = str_replace("{FECHA}", $ar->fecha, $row);
        $vistas = ($ar->vistas == 1) ? "" : ""; //plural
        $row    = str_replace("{VISTAS}", "<span class='megusta_link'>  <i class='fa fa-eye'></i></span> " . $ar->vistas . " " . $vistas, $row);
        //$megusta=crea_megusta($ar->id,"1");
        //$row = str_replace("{MEGUSTA}",$megusta." ".$ar->megusta,$row);
        $row    = str_replace("{MEGUSTA}", ColocaMeGusta($ar->id, "id_imagen_galeria", $id_empresa, $rut), $row);
        $row    = str_replace("{RATING}", crea_Estrellas($ar->id), $row);
        $row    = str_replace("{ID}", $ar->id, $row);
        $total_html .= $row;
    }
    $html      = str_replace("{LISTA1}", $total_html, $html);
    //$archivos2=mas_vistos_galeria(6);
    $archivos2 = mas_vistos_galeriaPorEmpresa(6, $id_empresa);
    $i         = 1;
    foreach ($archivos2 as $ar2) {
        $row2 = file_get_contents("views/galeria/ultimos3_archivos.html");
        $row2 = str_replace("{DESCRIPCION}", $ar2->descripcion, $row2);
        if ($ar2->tipo == "video") {
            $figura = "
    <a onclick='vista_galeria(" . $ar->id . ")' class='fancybox fancybox.iframe' href='funciones/galeria/video.php?video=" . $ar->archivo . "'  ><img src='img/galeria/video.png' alt='" . $ar2->descripcion . "' style='width:247px;height:149px;'/>
    </a>";
        } else {
            $figura = "<a href='galeria/" . $ar2->archivo . "' title='" . $ar2->descripcion . "' data-fancybox-group='gallery-bssb' class='fancybox' data-toggle='modal' data-target='#bannerformmodal'><img src='galeria/" . $ar2->archivo . "' alt='" . $ar2->descripcion . "' style='width:247px;height:149px;'/></a>";
        }
        $row2    = str_replace("{FIGURA}", $figura, $row2);
        $row2    = str_replace("{ARCHIVO}", $img, $row2);
        $row2    = str_replace("{IMAGEN}", "galeria/" . $ar->archivo, $row);
        $row2    = str_replace("{FECHA}", $ar2->fecha, $row2);
        $vistas  = ($ar2->vistas == 1) ? "vez" : "veces"; //plural
        //$row = str_replace("{VISTAS}","<span class='megusta_link'>  <i class='fa fa-eye'></i></span> ".$ar->vistas." ".$vistas,$row);
        $megusta = crea_megusta($ar2->id, "1");
        //$row2 = str_replace("{MEGUSTA}",$megusta." ".$ar2->megusta,$row2);
        $row2    = str_replace("{MEGUSTA}", ColocaMeGusta($ar2->id, "id_imagen_galeria", $id_empresa, $rut), $row2);
        $row2    = str_replace("{VISTAS}", "<span class='megusta_link'>  <i class='fa fa-eye'></i></span> " . $ar->vistas . " " . $vistas, $row2);
        $row2    = str_replace("{RATING}", crea_Estrellas($ar2->id), $row2);
        $row2    = str_replace("{ID}", $ar2->id, $row2);
        $total_html1 .= $row2;
        if ($i == 3) {
            $i = 1;
            $total_html1 .= "<div class='row'></div>";
        } else {
            $i++;
        }
    }
    $html       = str_replace("{LISTA2}", $total_html1, $html);
    //$categorias=TraeCarpetas();
    $categorias = TraeCarpetasPorEmpresa($id_empresa);
    foreach ($categorias as $Cat) {
        $row3  = file_get_contents("views/galeria/lista_menu_categorias.html");
        $row3  = str_replace("{CATEGORIA}", $Cat->categoria, $row3);
        $total = Total_archivos_galeria($Cat->id);
        $row3  = str_replace("{TOTAL}", " (" . $total . ")", $row3);
        $row3  = str_replace("{ID}", $Cat->id, $row3);
        $total_html2 .= $row3;
    }
    $html = str_replace("{LISTA_CATEGORIAS}", $total_html2, $html);
    return ($html);
}
function galeria_subcategoria($html, $id, $ncat, $id_empresa, $total_columnas)
{
    $i             = 1;
    $rut           = $_SESSION["user_"];
    //$SUBcategorias=TraeSubCarpetas($id);
    $SUBcategorias = TraeSubCarpetasPerfiladas($id, $rut);
    foreach ($SUBcategorias as $SubCat) {
        //Por cada sub categoria, veo dado el mundo, si pertenece al mundo del usuario actual
        //echo $SubCat->id_mundo."<br>";
        //Traigo los datos dado el id del mundo
        $datos_mundo = DatosPorIdDeMundo($SubCat->id_mundo);
        //Con el dato del mundo al que pertenece esta ategoria, verifico si el usuario tambien pertenece a este mundo
        if ($datos_mundo) {
            //Verifico en la tabla usuario, entregando el rut del usuario, y los campos para el filtro del mundo
            $verifico_usuario_mundo = VerificaUsuarioMundo($rut, $datos_mundo[0]->campo, $datos_mundo[0]->valor, $datos_mundo[0]->operador_logico);
        }
        $row = file_get_contents("views/galeria/lista_todas_subcategorias.html");
        $row = str_replace("{SUBCATEGORIA}", $SubCat->categoria, $row);
        $row = str_replace("{DESCRIPCION}", $SubCat->descripcion, $row);
        $row = str_replace("{DETALLE}", Total_imagenes($SubCat->id), $row);
        $row = str_replace("{ID}", $SubCat->id, $row);
        $row = str_replace("{IMAGEN}", $SubCat->imagen, $row);
        $row = str_replace("{FECHA}", $SubCat->fecha, $row);
        $row = str_replace("{NSUBCAT}", $SubCat->categoria, $row);
        $row = str_replace("{NCAT}", $ncat, $row);
        $row = str_replace("{IDCAT}", $id, $row);
        $total_html .= $row;
        if ($i == $total_columnas) {
            $i = 1;
            $total_html .= "<div class='row'></div>";
        } else {
            $i++;
        }
    }
    $html       = str_replace("{LISTA}", $total_html, $html);
    //$categorias=TraeCarpetas();
    $categorias = TraeCarpetasPorEmpresa($id_empresa);
    foreach ($categorias as $Cat) {
        $row   = file_get_contents("views/galeria/lista_menu_categorias.html");
        $total = Total_archivos_galeria($Cat->id);
        $row   = str_replace("{TOTAL}", " (" . $total . ")", $row);
        $row   = str_replace("{CATEGORIA}", $Cat->categoria, $row);
        $row   = str_replace("{ID}", $Cat->id, $row);
        $total_html2 .= $row;
    }
    $html      = str_replace("{TITULO}", $ncat, $html);
    //$categoria=TraeCarpeta($id);
    $categoria = TraeCarpetasPorEmpresa($id, $id_empresa);
    $html      = str_replace("{FECHA}", $categoria[0]->fecha, $html);
    $html      = str_replace("{CDESCRIPCION}", $categoria[0]->descripcion, $html);
    $html      = str_replace("{VISITAS}", cuenta_visita("categoria", $id) . " Visitas", $html);
    $html      = str_replace("{OLMENU}", '<li class="active">' . $ncat . '</li>', $html);
    $html      = str_replace("{LISTA_CATEGORIAS}", $total_html2, $html);
    guarda_log_galeria("visita", $id, "1", "Album");
    $html = str_replace("{TOTAL_AR}", "", $html);
    return ($html);
}
function galeria_archivos($html, $id, $nsubcat, $ncat, $id_cat, $id_empresa)
{
    $rut        = $_SESSION["user_"];
    $total_html = "";
    $total_r    = "";
    $archivos   = TraeArchivosGaleria($id);
    $i          = 1;
    foreach ($archivos as $ar) {
        $row = file_get_contents("views/galeria/lista_archivos.html");
        $row = str_replace("{DESCRIPCION}", $ar->descripcion, $row);
        if ($ar->tipo == "video") {
            $row    = file_get_contents("views/galeria/lista_archivos_video.html");
            $figura = "<a  onclick='vista_galeria(" . $ar->id . ")' class='fancybox fancybox.iframe' href='funciones/galeria/video.php?video=" . $ar->archivo . "' >
    <img src='img/galeria/video.png' alt='" . $ar->descripcion . "' style='width:247px;height:149px;'/></a>";
        } else {
            //$figura="<a  onclick='vista_galeria(".$ar->id.")'  href='galeria/".$ar->archivo."' title='".$ar->descripcion."' data-fancybox-group='gallery-bssb' class='fancybox ratio' data-toggle='modal' data-target='#bannerformmodal'><img src='galeria/".$ar->archivo."' alt='".$ar->descripcion."'  class='thumbnail img-responsive'/></a>";
            //$figura="<a  onclick='vista_galeria(".$ar->id.")'  href='#' title='".$ar->descripcion."'  data-toggle='modal' data-target='#bannerformmodal'><img src='galeria/".$ar->archivo."' alt='".$ar->descripcion."'  class='thumbnail img-responsive'/></a>";
            //$figura='<a href="#" onclick="vista_galeria('.$ar->id.')" title="'.$ar->descripcion.'" data-toggle="modal" data-target="#bannerformmodal"><img src="galeria/'.$ar->archivo.'" class="thumbnail img-responsive"></a>';
            //$figura='<a href="galeria/'.$ar->archivo.'" onclick="vista_galeria('.$ar->id.')"  title="'.$ar->descripcion.'" data-gallery=""><img src="galeria/'.$ar->archivo.'"></a>';
            $figura = '<a href="galeria/' . $ar->archivo . '" title="' . $ar->descripcion . '" onclick="vista_galeria(' . $ar->id . ')"  data-gallery>
    <img  class="img_r" src="galeria/' . $ar->archivo . '"></a>';
        }
        $row     = str_replace("{FIGURA}", $figura, $row);
        $row     = str_replace("{ARCHIVO}", $img, $row);
        $row     = str_replace("{IMAGEN}", "galeria/" . $ar->archivo, $row);
        $row     = str_replace("{FECHA}", $ar->fecha, $row);
        $vistas  = ($ar->vistas == 1) ? "vez" : "veces"; //plural
        $row     = str_replace("{VISTAS}", "<span class='megusta_link'>  <i class='fa fa-eye'></i></span> " . $ar->vistas . " " . $vistas, $row);
        $megusta = crea_megusta($ar->id, "1");
        //$row = str_replace("{MEGUSTA}",$megusta." ".$ar->megusta,$row);
        $row     = str_replace("{MEGUSTA}", ColocaMeGusta($ar->id, "id_imagen_galeria", $id_empresa, $rut), $row);
        $row     = str_replace("{RATING}", crea_Estrellas($ar->id), $row);
        $row     = str_replace("{ID}", $ar->id, $row);
        $total_html .= $row;
        if ($i == 3) {
            $i = 1;
            $total_html .= "<div class='row'></div>";
        } else {
            $i++;
        }
    }
    $html       = str_replace("{LISTA}", '<ul class="list-unstyled">' . $total_html . '</ul>', $html);
    //$categorias=TraeCarpetas();
    $categorias = TraeCarpetasPorEmpresa($id_empresa);
    foreach ($categorias as $Cat) {
        $row   = file_get_contents("views/galeria/lista_menu_categorias.html");
        $total = Total_archivos_galeria($Cat->id);
        $row   = str_replace("{TOTAL}", " (" . $total . ")", $row);
        $row   = str_replace("{CATEGORIA}", $Cat->categoria, $row);
        $row   = str_replace("{ID}", $Cat->id, $row);
        $total_html2 .= $row;
    }
    $html = str_replace("{LISTA_CATEGORIAS}", $total_html2, $html);
    if ($total_r == 0) {
        $html = str_replace("{TOTAL_AR}", "No hay archivos", $html);
    } else {
        if ($total_r == 1) {
            $html = str_replace("{TOTAL_AR}", "Hay un total de " . $total_r . " archivo", $html);
        } else {
            $html = str_replace("{TOTAL_AR}", "Hay un total de " . $total_r . " archivos", $html);
        }
    }
    $html      = str_replace("{TITULO}", $nsubcat, $html);
    $categoria = TraeCarpeta($id);
    $html      = str_replace("{CDESCRIPCION}", $categoria[0]->descripcion, $html);
    guarda_log_galeria("visita", $id, "1", "ALBUM");
    $html = str_replace("{OLMENU}", '<li><a href="?sw=galeria&p=subcategoria&id=' . $id_cat . '&ncat=' . $ncat . '">' . $ncat . '</a></li><li class="active">' . $nsubcat . '</li>', $html);
    return ($html);
}
function crea_Estrellas($id)
{
    $html    = "";
    $tamanos = 16;
    $archivo = TraeArchivoGaleria($id);
    foreach ($archivo as $AR) {
        $cuenta = 0;
        if ($AR->votos > 0)
            $cuenta = $AR->valoracion / $AR->votos;
        $votado = Consulta_voto_usuario($AR->id, $_SESSION["user_"]);
        if ($votado >= 1) {
            $votado  = "ul_voted";
            $votado2 = "class='voted'";
        } else {
            $votado  = "";
            $votado2 = "";
        }
        $html .= "<ul class='stars stars-" . $tamanos . " " . $votado . "' data-value='" . $cuenta . "' data-votes='" . $AR->votos . "' data-id='" . $AR->id . "' data-rut='" . $_SESSION["user_"] . "'>";
        $html .= "<li " . $votado2 . " data-vote='1'>1</li>";
        $html .= "<li " . $votado2 . " data-vote='2'>2</li>";
        $html .= "<li " . $votado2 . " data-vote='3'>3</li>";
        $html .= "<li " . $votado2 . " data-vote='4'>4</li>";
        $html .= "<li " . $votado2 . " data-vote='5'>5</li>";
        if ($cuenta > 0) {
            $maximo_posible = 5 * $AR->votos;
            $porciento      = $AR->valoracion * 100 / $maximo_posible;
            $html .= "<div class='voted_percent votes-" . $tamanos . "' style='width:" . $porciento . "%'></div>";
        } else {
            $html .= "<div class='voted_percent votes-" . $tamanos . "' style='width:0%'></div>";
        }
        $html .= "<span data-txtoriginal='$cuenta/5 en " . $AR->votos . " votos'>" . $AR->votos . " votos</span></ul>";
    }
    return ($html);
}
function crea_megusta($id)
{
    if (Consulta_megusta_usuario($id, $_SESSION["user_"]) >= "1") {
        $megusta = "megusta2";
        $btn     = "yanomegusta(\"" . $id . "\",\"" . $_SESSION["user_"] . "\")";
    } else {
        $megusta = "megusta1";
        $btn     = "megusta(\"" . $id . "\",\"" . $_SESSION["user_"] . "\")";
    }
    return "<span class='megusta_linkVistgo'>  <i class='fa fa-thumbs-o-up'></i></span>";
}
function tokenTruncate($text, $length)
{
    $length = abs((int) $length);
    if (strlen($text) > $length) {
        $text = preg_replace("/^(.{1,$length})(\s.*|$)/s", '\\1...', $text);
    }
    return ($text);
}
function BloqueFotosSliderDestacadas($html, $id_empresa)
{
    $row      = file_get_contents("views/galeria/bloque_fotos_destacadas.html");
    $archivos = TraeFotosDestacadasPorEmpresa(6, $id_empresa);
    foreach ($archivos as $unico) {
        $i++;
        $imagen .= file_get_contents("views/galeria/row_bloque_slider_fotos_destacadas.html");
        if ($i == 1) {
            $imagen = str_replace("{ACTIVO}", "active", $imagen);
        } else {
            $imagen = str_replace("{ACTIVO}", '', $imagen);
        }
        $imagen = str_replace("{IMAGEN}", $unico->archivo, $imagen);
        $imagen = str_replace("{AUTOR}", $unico->nombre_completo, $imagen);
    }
    $row  = str_replace("{ROW_5_FOTOS_DESTACADAS}", $imagen, $row);
    $html = str_replace("{ROW_FOTOS_DESTACADAS}", $row, $html);
    return ($html);
}
function BloqueAtencion($id_empresa, $rut)
{
    $arreglo_id_malla = ObtenerDatosRelMallaUsuarioDadoRut($rut, $id_empresa);
    //echo "ola ";
    //print_r($arreglo_id_malla);
    $atencion         = "";
    if ($arreglo_id_malla[0]->id_malla == "bciviajem5_ecb") {
        $atencion = "<br><br><strong><span class='blanco'>
    ?Hay Nuevo documento en Biblioteca: Rol del Ejecutivo Bci!</strong></span>";
    }
    //echo "atencion $atencion";
    return ($atencion);
}
function Tipsganados($rut, $id_empresa)
{
    $arreglo_tips = ObtenerTipsGanados($rut, $id_empresa);
    foreach ($arreglo_tips as $arreglo_tip) {
        $lista_tips .= "<div><blockquote><p>" . utf8_encode($arreglo_tip->tip) . "</p>
    <p>" . utf8_encode($arreglo_tip->masinfo) . "</p></blockquote></div><hr>";
    }
    return ($lista_tips);
}
function CI_busca_codigo_post($buscacodigo, $id_empresa)
{
    $buscacodigo = CI_buscacodigo($buscacodigo, $id_empresa);
    if (empty($buscacodigo)) {
        return ("vacio");
    } else {
        return ($buscacodigo);
    }
}
function mp_tag_cloud($id_empresa)
{
    $row  = file_get_contents("views/mejorespracticas/mp_tagcloud.html");
    $tags = TraeTagCloudPorEmpresa($id_empresa);
    //print_r($tags);
    foreach ($tags as $tag) {
        $mptag .= $tag->tag . ",";
    }
    echo $mptag;
    exit();
    foreach ($tags as $tag) {
        $i++;
        $mptag .= file_get_contents("views/galeria/row_mp_tagcloud.html");
        $imagen = str_replace("{TAGNAME}", $tag->tagname, $mptag);
        $imagen = str_replace("{TAGNUM}", $tag->tagcuenta, $mptag);
    }
    $row  = str_replace("{CADA_TAG}", $mptag, $row);
    $html = str_replace("{TAG_CLOUD}", $row, $html);
    return ($html);
}
function RANKINGCheckin($PRINCIPAL, $rut, $id_objeto, $id_curso, $id_empresa)
{
    $cuentaParticipantes_array       = ci_cuentapart($id_curso, $id_empresa);
    $cuentaParticipantes             = count($cuentaParticipantes_array);
    $cuentaTriviasFinalizadoas_array = ci_cuentapartEvaluacion($id_objeto, $id_empresa);
    $cuentaTriviasFinalizadoas       = count($cuentaTriviasFinalizadoas_array);
    $Ranking_Participantes           = ci_RankEvaluacion($id_objeto, $id_empresa);
    //echo "hola $cuentaTriviasFinalizadoas>=$cuentaParticipantes";
    if ($cuentaTriviasFinalizadoas >= $cuentaParticipantes) {
        foreach ($Ranking_Participantes as $Ranking_Participante) {
            $i++;
            $mprankingCI .= file_get_contents("views/cursos/informe/" . $id_empresa . "_row_listado_ranking_trivia.html");
            $mprankingCI = str_replace("{NOMBRE_COMPLETO}", $Ranking_Participante->nombre_completo, $mprankingCI);
            $mprankingCI = str_replace("{CARGO}", $Ranking_Participante->cargo, $mprankingCI);
            $mprankingCI = str_replace("{NOTA}", $Ranking_Participante->nota, $mprankingCI);
            $mprankingCI = str_replace("{URL_PERSONA}", VerificaFotoPersonal($Ranking_Participante->rut), $mprankingCI);
        }
    } else {
        $info        = "<div class='alert alert-danger' role='alert'>
    <span class='glyphicon glyphicon-exclamation-sign' aria-hidden='true'></span>
    Ranking Pendiente<br><br>Han finalizado la trivia $cuentaTriviasFinalizadoas de $cuentaParticipantes
    </div>";
        $mprankingCI = file_get_contents("views/cursos/informe/" . $id_empresa . "_row_listado_ranking_trivia_pendientes.html");
        $mprankingCI = str_replace("{INFO}", $info, $mprankingCI);
    }
    $PRINCIPAL = str_replace("{RANKINGCHECKIN}", $mprankingCI, $PRINCIPAL);
    return $PRINCIPAL;
}
function CheckinlistaCursosCheck($rut, $id_empresa)
{
    $listaCursos     = ListaCursosChecking($rut, $id_empresa);
    $bloque_archivos = "";
    $cuenta          = count($listaCursos);
    if ($cuenta > 0) {
        foreach ($listaCursos as $listaCurso) {
            //echo "<pre>";
            //print_r($listaCurso);
            $checkin_existe_enc_satisf = checkin_valida_enc_satisf_data($listaCurso->id_inscripcion, $rut, $id_empresa);
            //echo "<pre>";
            //print_r($checkin_existe_enc_satisf);
            if ($checkin_existe_enc_satisf[0]->cuenta >= 1) {
                //echo "<br>1";
                $color_estado = "<span class='mt-action-dot progress-bar-success'></span>";
            } else {
                //echo "<br>0";
                $color_estado = "<span class='mt-action-dot progress-bar-danger'></span>";
            }
            //echo $color_estado;
            if ($listaCurso->relator == 0) {
                $tipocolaborador = "Asistente";
            } else {
                $tipocolaborador = "Relator";
            }
            $bloque_archivos .= file_get_contents("views/checkin/CI_lista_cursos_check.html");
            $bloque_archivos = str_replace("{CODIGO_CURSO}", $listaCurso->id_inscripcion, $bloque_archivos);
            $bloque_archivos = str_replace("{VR_ICON_ESTADO}", $color_estado, $bloque_archivos);
            $bloque_archivos = str_replace("{NOMBRE_CURSO}", utf8_encode($listaCurso->nombrecurso), $bloque_archivos);
            $bloque_archivos = str_replace("{FECHAINICIO}", utf8_encode($listaCurso->fecha_inicio), $bloque_archivos);
            $bloque_archivos = str_replace("{FECHATERMINO}", utf8_encode($listaCurso->fecha_finalizacion), $bloque_archivos);
            $bloque_archivos = str_replace("{DIRECCITIPOCOLABORADOR}", utf8_encode($listaCurso->lugar_ejecucion), $bloque_archivos);
            $bloque_archivos = str_replace("{TIPOCOLABORADOR}", utf8_encode($tipocolaborador), $bloque_archivos);
        }
    } else {
        $bloque_archivos = file_get_contents("views/checkin/CI_lista_cursos_check_nada.html");
    }
    return ($bloque_archivos);
}
function lms_busca_puntos_reportes($rut, $id_empresa)
{
    //echo "$rut, $id_empresa";
    $lista_puntos_reportes_data = lms_busca_puntos_reportes_data($rut, $id_empresa);
    //print_r($lista_puntos_reportes_data);
    //exit();
    foreach ($lista_puntos_reportes_data as $lista_punto_reportes_data) {
        $bloque_puntos_lms_reportes .= file_get_contents("views/integracion/" . $id_empresa . "_row_puntos_lms_reportes.html");
        $bloque_puntos_lms_reportes = str_replace("{PROGRAMA_PUNTOS_REPORTES}", utf8_encode($lista_punto_reportes_data->programa), $bloque_puntos_lms_reportes);
        $bloque_puntos_lms_reportes = str_replace("{NUM_PUNTOS_REPORTES}", $lista_punto_reportes_data->sumapuntos, $bloque_puntos_lms_reportes);
        $bloque_puntos_lms_reportes = str_replace("{FECHA_PUNTOS_REPORTES}", utf8_encode($lista_punto_reportes_data->fecha_termino), $bloque_puntos_lms_reportes);
        $sumapuntos                 = $sumapuntos + $lista_punto_reportes_data->sumapuntos;
    }
    $arreglo[0] = $bloque_puntos_lms_reportes;
    $arreglo[1] = $sumapuntos;
    return $arreglo;
}
function genMonth_Text($m)
{
    switch ($m) {
        case 01:
            $month_text = "Enero";
            break;
        case 02:
            $month_text = "Febrero";
            break;
        case 03:
            $month_text = "Marzo";
            break;
        case 04:
            $month_text = "Abril";
            break;
        case 05:
            $month_text = "Mayo";
            break;
        case 06:
            $month_text = "Junio";
            break;
        case 07:
            $month_text = "Julio";
            break;
        case 08:
            $month_text = "Agosto";
            break;
        case 09:
            $month_text = "Septiembre";
            break;
        case 10:
            $month_text = "Octubre";
            break;
        case 11:
            $month_text = "Noviembre";
            break;
        case 12:
            $month_text = "Diciembre";
            break;
    }
    return ($month_text);
}
function lms_busca_cursos_realizados($rut, $id_empresa)
{
    //echo "$rut, $id_empresa";
    $lista_cursos_reportes_data = lms_busca_cursos_realizados_data($rut, $id_empresa);
    foreach ($lista_cursos_reportes_data as $lista_curso_reportes_data) {
        if ($lista_curso_reportes_data->status == "Elearning") {
            $bloque_cursos_lms_reportes = str_replace("{CURSO}", utf8_encode($lista_curso_reportes_data->programa), $bloque_cursos_lms_reportes);
            $bloque_cursos_lms_reportes = str_replace("{ENC_CURSO}", Encodear3(utf8_encode($lista_curso_reportes_data->programa)), $bloque_cursos_lms_reportes);
            $bloque_cursos_lms_reportes = str_replace("{ICO}", "<i class='icon-screen-desktop icons'></i> Online", $bloque_cursos_lms_reportes);
        }
        if ($lista_curso_reportes_data->status == "Presencial") {
            $bloque_cursos_lms_reportes = str_replace("{CURSO}", utf8_encode($lista_curso_reportes_data->curso), $bloque_cursos_lms_reportes);
            $bloque_cursos_lms_reportes = str_replace("{ENC_CURSO}", Encodear3(utf8_encode($lista_curso_reportes_data->curso)), $bloque_cursos_lms_reportes);
            $bloque_cursos_lms_reportes = str_replace("{ICO}", "<i class='icon-notebook icons'></i> Presencial", $bloque_cursos_lms_reportes);
        }
        $bloque_cursos_lms_reportes .= file_get_contents("views/integracion/" . $id_empresa . "_row_cursos_lms_reportes.html");
        $bloque_cursos_lms_reportes = str_replace("{HORAS}", utf8_encode($lista_curso_reportes_data->horas), $bloque_cursos_lms_reportes);
        if ($lista_curso_reportes_data->asistencia == "100%") {
            $boton_diploma              = "<a href='?sw=diploma&name={ENC_NOMBRE}&course={ENC_CURSO}&program={ENC_PROGRAMA}&month={ENC_MESTERMINO}&year={ENC_ANNOTERMINO}&hour={ENC_HORAS}' target='_blank' class='btn btn-info btn-sm'> <span class='blanco'> <i class='icon-screen-tablet icons'></i> Descargar Certificado </span> </a>";
            $bloque_cursos_lms_reportes = str_replace("{ANNOTERMINO}", utf8_encode($lista_curso_reportes_data->anno_termino), $bloque_cursos_lms_reportes);
            $bloque_cursos_lms_reportes = str_replace("{MESTERMINO}", utf8_encode(genMonth_Text($lista_curso_reportes_data->mes_termino)), $bloque_cursos_lms_reportes);
            $bloque_cursos_lms_reportes = str_replace("{ICOCAL}", "<i class='icon-calendar icons'></i>", $bloque_cursos_lms_reportes);
        } else {
            $boton_diploma              = "<SMALL>Curso Incompleto</SMALL>";
            $bloque_cursos_lms_reportes = str_replace("{ANNOTERMINO}", "", $bloque_cursos_lms_reportes);
            $bloque_cursos_lms_reportes = str_replace("{MESTERMINO}", "", $bloque_cursos_lms_reportes);
            $bloque_cursos_lms_reportes = str_replace("{ICOCAL}", "", $bloque_cursos_lms_reportes);
        }
        $bloque_cursos_lms_reportes = str_replace("{DIPLOMA}", $boton_diploma, $bloque_cursos_lms_reportes);
        $bloque_cursos_lms_reportes = str_replace("{ENC_NOMBRE}", Encodear3(utf8_encode($lista_curso_reportes_data->nombre)), $bloque_cursos_lms_reportes);
        $bloque_cursos_lms_reportes = str_replace("{ENC_ANNOTERMINO}", Encodear3(utf8_encode($lista_curso_reportes_data->anno_termino)), $bloque_cursos_lms_reportes);
        $bloque_cursos_lms_reportes = str_replace("{ENC_MESTERMINO}", Encodear3(genMonth_Text($lista_curso_reportes_data->mes_termino)), $bloque_cursos_lms_reportes);
        $bloque_cursos_lms_reportes = str_replace("{ENC_HORAS}", Encodear3($lista_curso_reportes_data->horas), $bloque_cursos_lms_reportes);
    }
    $arreglo[0] = $bloque_cursos_lms_reportes;
    return $arreglo;
}
function array_sort_by(&$arrIni, $col, $order = SORT_ASC)
{
    $arrAux = array();
    foreach ($arrIni as $key => $row) {
        $arrAux[$key] = is_object($row) ? $arrAux[$key] = $row->$col : $row[$col];
        $arrAux[$key] = strtolower($arrAux[$key]);
    }
    array_multisort($arrAux, $order, $arrIni);
}
function Lista_cursos_por_programa($rut, $id_empresa, $id_programa_bbdd, $id_malla)
{

    if($id_empresa==78){
        $malla_dado_progama=BuscaIdmallaDadoProgramaRut_Prd($rut, $id_empresa, $id_programa_bbdd);
        //print_r($malla_dado_progama);
    }
    $listaProgramas = List_cursos_programa($rut, $id_empresa, $id_programa_bbdd, $id_malla);
    //print_r($listaProgramas);
    $plantilla      = "detalle_cursoCap";
    foreach ($listaProgramas as $listaPrograma) {
        $bloque_archivos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_programa_interno.html");
        $bloque_archivos = str_replace("{PROGRAMA_NOMBRE}", utf8_encode($listaPrograma->nombre), $bloque_archivos);
        $bloque_archivos = str_replace("{AVANCE_PROGRAMA}", $listaPrograma->avance, $bloque_archivos);
        $bloque_archivos = str_replace("{RESULTADO_FINAL}", $listaPrograma->resultado_final, $bloque_archivos);
        $bloque_archivos = str_replace("{ID_PROGRAMA_SLIDE}", $listaPrograma->id_programa . $listaPrograma->rut, $bloque_archivos);
        $bloque_archivos = str_replace("{ID_MALLA}", utf8_encode($listaPrograma->id), $bloque_archivos);
        $bloque_archivos = str_replace("{IDC_ENCODEADO}", Encodear3($listaPrograma->id), $bloque_archivos);
        $bloque_archivos = str_replace("{ID_MALLA_ENCODEADO}", Encodear3($listaPrograma->id_malla), $bloque_archivos);
        $bloque_archivos = str_replace("{FOCO_PROGRAMA}", $listaPrograma->foco, $bloque_archivos);
        $bloque_archivos = str_replace("{ID_FOCO}", $listaPrograma->id_foco, $bloque_archivos);
        $bloque_archivos = str_replace("{CODIGO_FOCO}", $listaPrograma->id_foco, $bloque_archivos);
        $bloque_archivos = str_replace("{IMAGEN_PROGRAMA}", $listaPrograma->imagen, $bloque_archivos);
        $bloque_archivos = str_replace("{DESCRIPCION_PROGRAMA}", utf8_encode($listaPrograma->descripcion_programa), $bloque_archivos);
        //$bloque_archivos = str_replace("{DESCRIPTOR_NOMBRE}",utf8_encode($listaPrograma->descriptor_nombre),$bloque_archivos);
        $bloque_archivos = str_replace("{URL_PROGRAMA}", utf8_encode($listaPrograma->url_programa), $bloque_archivos);
        $bloque_archivos = str_replace("{TEMPLATE}", $plantilla, $bloque_archivos);
        $bloque_archivos = str_replace("{RESULTADO_PROGRAMA_1A7}", "-", $bloque_archivos);
        $cuenta_cursos++;
        $suma_Avance = $suma_Avance + $listaPrograma->avance;
        if ($listaPrograma->avance >= 100) {
            $cuenta_finalizados++;
        }
    }
    $promedio   = round($suma_Avance / $cuenta_cursos);
    $arreglo[0] = $bloque_archivos;
    $arreglo[1] = $promedio;
    $arreglo[2] = $cuenta_cursos;
    $arreglo[3] = $cuenta_finalizados;
    $arreglo[4] = $malla_dado_progama[0]->id_malla;
    return $arreglo;
}

function lms_cursos_especiales($rut, $id_empresa,$tipo, $estado, $modalidad){
    //echo "lms_cursos_especiales";
    $listaProgramas  = lms_integracion_lista_cursos_especiales($rut, $id_empresa, $tipo, $estado, $modalidad);
    $bloque_archivos = "";

        //print_r($listaProgramas);
        foreach ($listaProgramas as $listaPrograma) {

        //veo si el curso esta asociado a una malla que no sea la malla Elearning_por_fechas
        $existe_en_otra_malla=VerificoCursoModalidad4EnOtraMalla($listaPrograma->id_curso, $id_empresa);
        if($existe_en_otra_malla){
            continue;
        }
        $template = $listaPrograma->template;
        $plantilla = "detalle_cursoCap";


                        //echo "<br><br>foreach";


        $mensaje_objeto="";
                        $fecha_actual      = date("Y-m-d");
                        $hora_actual       = date("H:i:s");
                       //// echo "fecha actual $fecha_actual, hora actual $hora_actual <br>";
                       //// echo $listaPrograma->hora_inicioT."<br>";
                       //// echo $listaPrograma->hora_terminoT."<br>";
                       //// echo $listaPrograma->fecha_inicioT."<br>";
                       /// echo $listaPrograma->fecha_terminoT."<br>";



                        if ($fecha_actual < $listaPrograma->fecha_inicioT) {
                        //echo "FT1";
        $bloque_archivos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_programa_interno_especial_desactivo.html");
$mensaje_objeto="";
$mensaje_objeto .= "El modulo se encuentra desactivado. La fecha de aplicaci&oacute;n es el " . $listaPrograma->fecha_inicioT." y el horario de activaci&oacute;n es entre las ".$listaPrograma->hora_inicioT." y ".$listaPrograma->hora_terminoT."";

                            $row_curso = str_replace("{MENSAJE_}", $mensaje_objeto, $row_curso);


                       } else if ($fecha_actual > $listaPrograma->fecha_terminoT) {
                        //echo "FT2";
$mensaje_objeto="";
        $bloque_archivos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_programa_interno_especial_desactivo.html");
$mensaje_objeto .= "El modulo se encuentra desactivado. La fecha de aplicaci&oacute;n es el " . $listaPrograma->fecha_inicioT." y el horario de activaci&oacute;n es entre las ".$listaPrograma->hora_inicioT." y ".$listaPrograma->hora_terminoT."";
                            $row_curso = str_replace("{MENSAJE_}", $mensaje_objeto, $row_curso);

                        } else if ($fecha_actual >= $listaPrograma->fecha_inicioT && $fecha_actual <= $listaPrograma->fecha_terminoT) {
                        //echo "FT3";
                                    if ($fecha_actual == $listaPrograma->fecha_inicioT and $fecha_actual <> $listaPrograma->fecha_terminoT) {
                                    //echo "FT4";
                                        //echo "es hoy inicio";

                                        //echo "<br>$hora_actual < hora inicio ".$listaPrograma->hora_inicioT;
                                        if ($hora_actual < $listaPrograma->hora_inicioT) {
                $bloque_archivos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_programa_interno_especial_desactivo.html");
$mensaje_objeto="";
$mensaje_objeto .= "El modulo se encuentra desactivado. La fecha de aplicaci&oacute;n es el " . $listaPrograma->fecha_inicioT." y el horario de activaci&oacute;n es entre las ".$listaPrograma->hora_inicioT." y ".$listaPrograma->hora_terminoT."";
                                            $row_curso = str_replace("{MENSAJE_}", $mensaje_objeto, $row_curso);
                                        } elseif($hora_actual >= $listaPrograma->hora_inicioT) {
                $bloque_archivos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_programa_interno_especial.html");
                                            $mensaje_objeto = "";;
                                            $row_curso = str_replace("{MENSAJE_}", $mensaje_objeto, $row_curso);
                                        }



                                    } elseif ($fecha_actual == $listaPrograma->fecha_terminoT and $fecha_actual <> $listaPrograma->fecha_inicioT) {
                                    //echo "FT5";

                                    if ($hora_actual > $listaPrograma->hora_terminoT) {

                $bloque_archivos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_programa_interno_especial_desactivo.html");
$mensaje_objeto="";
$mensaje_objeto .= "El modulo se encuentra desactivado. La fecha de aplicaci&oacute;n es el " . $listaPrograma->fecha_inicioT." y el horario de activaci&oacute;n es entre las ".$listaPrograma->hora_inicioT." y ".$listaPrograma->hora_terminoT."";
                                            $row_curso = str_replace("{MENSAJE_}", $mensaje_objeto, $row_curso);
                                        } elseif($hora_actual <= $listaPrograma->hora_terminoT) {

                $bloque_archivos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_programa_interno_especial.html");
                                            $mensaje_objeto = "";
                                            $row_curso = str_replace("{MENSAJE_}", $mensaje_objeto, $row_curso);



                                    } elseif ($fecha_actual == $listaPrograma->fecha_terminoT and $fecha_actual == $listaPrograma->fecha_inicioT) {
                                        //echo "es hoy termino e iniciohora ahora es ".$hora_actual." hora termino ".$unico->hora_termino." hora inicio".$unico->hora_inicio;
                                        if ($hora_actual > $listaPrograma->hora_terminoT or $hora_actual < $listaPrograma->hora_inicioT) {
                $bloque_archivos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_programa_interno_especial_desactivo.html");
$mensaje_objeto="";
$mensaje_objeto .= "El modulo se encuentra desactivado. La fecha de aplicaci&oacute;n es el " . $listaPrograma->fecha_inicioT." y el horario de activaci&oacute;n es entre las ".$listaPrograma->hora_inicioT." y ".$listaPrograma->hora_terminoT."";
                                            $row_curso = str_replace("{MENSAJE_}", $mensaje_objeto, $row_curso);
                                        }

                                    }


                                    } else {
                                    //echo "FT6";


                                    if ($hora_actual >= $listaPrograma->hora_inicioT and $hora_actual <= $listaPrograma->hora_terminoT) {

                            $bloque_archivos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_programa_interno_especial.html");
                                            $mensaje_objeto = "";
                                            $row_curso = str_replace("{MENSAJE_}", $mensaje_objeto, $row_curso);
                                        } else {
                                        //echo "FT8";
                            $bloque_archivos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_programa_interno_especial_desactivo.html");
$mensaje_objeto="";
$mensaje_objeto .= "El modulo se encuentra desactivado. La fecha de aplicaci&oacute;n es el " . $listaPrograma->fecha_inicioT." y el horario de activaci&oacute;n es entre las ".$listaPrograma->hora_inicioT." y ".$listaPrograma->hora_terminoT."";
                                            $row_curso = str_replace("{MENSAJE_}", $mensaje_objeto, $row_curso);


                                        }


                                    //echo "activo";

                                    }





                        } else {
                        //echo "FT9";
                        $bloque_archivos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_programa_interno_especial.html");

                        }


        //echo "$mensaje_objeto";

        $Array_Avance=BuscaAvanceIdCursoActualizaReportes($rut, $listaPrograma->id_curso, $id_empresa);
        //print_r($Array_Avance);




        $bloque_archivos = str_replace("{MENSAJE_}", $mensaje_objeto, $bloque_archivos);

        $bloque_archivos = str_replace("{PROGRAMA_NOMBRE}", utf8_encode($listaPrograma->nombre_curso), $bloque_archivos);
        $bloque_archivos = str_replace("{AVANCE_PROGRAMA}",     ($Array_Avance[0]->avance),     $bloque_archivos);
        $bloque_archivos = str_replace("{RESULTADO_FINAL}",     ($Array_Avance[0]->nota),     $bloque_archivos);
        $bloque_archivos = str_replace("{ID_PROGRAMA_SLIDE}", $listaPrograma->id_programa . $listaPrograma->rut, $bloque_archivos);
        $bloque_archivos = str_replace("{ID_MALLA}", utf8_encode($listaPrograma->id), $bloque_archivos);
        $bloque_archivos = str_replace("{ID_MALLA_ENCODEADO}", "", $bloque_archivos);
        $bloque_archivos = str_replace("{ID_CURSO_ENCODEADO}", Encodear3($listaPrograma->id_curso)."&idinsc=".Encodear3($listaPrograma->id_inscripcion), $bloque_archivos);

        $bloque_archivos = str_replace("{FECHA_INICIO_T}",     ($listaPrograma->fecha_inicioT),     $bloque_archivos);
        $bloque_archivos = str_replace("{FECHA_TERMINO_T}",     ($listaPrograma->fecha_terminoT),     $bloque_archivos);
        $bloque_archivos = str_replace("{HORA_INICIO_T}", ($listaPrograma->hora_inicioT),     $bloque_archivos);
        $bloque_archivos = str_replace("{HORA_TERMINO_T}",     ($listaPrograma->hora_terminoT),     $bloque_archivos);

        $bloque_archivos = str_replace("{IMAGEN_PROGRAMA}", $listaPrograma->imagen_curso, $bloque_archivos);
        $bloque_archivos = str_replace("{DESCRIPCION_PROGRAMA}", utf8_encode($listaPrograma->descripcion_curso), $bloque_archivos);
        $bloque_archivos = str_replace("{URL_PROGRAMA}", utf8_encode($listaPrograma->url_programa), $bloque_archivos);
        $bloque_archivos = str_replace("{TEMPLATE}", $plantilla, $bloque_archivos);
        $bloque_archivos = str_replace("{RESULTADO_PROGRAMA_1A7}", "-", $bloque_archivos);

        }

    $arreglo[0]              = $bloque_archivos;
    $promedio_avance_general = round($acumula_avance / $cuenta_programas);
    return ($arreglo);
}


function lms_integracion_programas_estado($rut, $id_empresa, $vista, $estado)
{

    //echo "<br> $rut, $id_empresa, $vista, $estado";


    if ($vista == "opcional") {
        $filtrodata = "opcional";
    } else {
        $filtrodata = "";
    }

 $cuenta_programas=0;


    //$start = round(microtime(true) * 1000);

    $listaProgramas  = lms_integracion_lista_programas($rut, $id_empresa, $id_programa_bbdd, $filtrodata, $estado);

    //echo "<pre>";     print_r($listaProgramas);

    /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_1 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);    */


    //print_r($listaProgramas);
    //array_sort_by($listaProgramas, "avance_malla", $order = SORT_ASC);
    $bloque_archivos = "";
    $cuenta          = count($listaProgramas);
    if ($cuenta > 0) {
        foreach ($listaProgramas as $listaPrograma) {

            if($listaPrograma->id_malla=="e_p_f"){
                continue;
            }

    if($estado=="FINALIZADO"){
        if($listaPrograma->avance_malla<100){ continue; }
    } elseif($estado=="PENDIENTE"){
        if($listaPrograma->avance_malla>=100){ continue; }
    }




    /*        $time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_02 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);    */

            //print_r($listaPrograma);
            $html_objetos = "";
            if ($vista == "equipo") {
                $bloque_archivos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_programa_vista_equipo.html");
            } else if ($vista == "detalle") {
                $bloque_archivos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_programa_vista_detalle.html");
            } else if ($listaPrograma->bbdd_host) {
                //Aca verifico si este usuario esta en la base y host remoto
                INTEGRACION_VerificaUsuarioEnOtraBase($rut, $listaPrograma->bbdd_host, $listaPrograma->bbdd_database, $listaPrograma->bbdd_username, $listaPrograma->bbdd_password, $listaPrograma->id_malla, $listaPrograma->id_empresa_programa);
            } else {
            }
            if ($vista == "" or $vista == "opcional") {
                if ($listaPrograma->url_programa <> '') {
                    $bloque_archivos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_programa.html");
                } else {
                    $bloque_archivos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_programa_interno.html");
                }
            }

    /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_03 : $time_elapsed<br><br>"; */



    //echo "<br> BBDD HOST ".$listaPrograma->bbdd_host;
    /*echo "<br> id_programa  ".$listaPrograma->id_programa;*/





                /*$start = round(microtime(true) * 1000);    */
                $avanceProgramaArrCursos = BuscaAvgCierreCurso($listaPrograma->id_malla, $id_empresa, $listaPrograma->rut);

                /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
                $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
                echo "<br>Int_1 : $time_elapsed<br><br>";
                $start = round(microtime(true) * 1000);        */
                //print_r($avanceProgramaArrCursos);
                $sumaavancecursos        = 0;
                $cuentaavancecursos      = 0;
                foreach ($avanceProgramaArrCursos as $avanceProgramaArrCurso) {
                    $sumaavancecursos = $sumaavancecursos + $avanceProgramaArrCurso->avance;
                    $cuentaavancecursos++;
                }

                /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
                $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
                echo "<br>Int_2 : $time_elapsed<br><br>";
                $start = round(microtime(true) * 1000);    */

                if ($cuentaavancecursos > 0) {
                    $avanceProgramaArrInscripcionCierre = round($sumaavancecursos / $cuentaavancecursos);
                } else {
                    $avanceProgramaArrInscripcionCierre = 0;
                }
                /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
                $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
                echo "<br>Int_3 : $time_elapsed<br><br>"; */
                /*$start = round(microtime(true) * 1000);        */
                //cho "<br>";
                //echo "<br><br><br>hay dif Internos ->".$listaPrograma->nombre_programa."<br>".$avanceProgramaArr[0]->avancePrograma.", avance ".$listaPrograma->avance_malla." - ".$avanceProgramaArrInscripcionCierre;

                //echo "<br>avanceProgramaArrInscripcionCierre $avanceProgramaArrInscripcionCierre <> listaPrograma->avance_malla ".$listaPrograma->avance_malla;

                if ($avanceProgramaArrInscripcionCierre <> $listaPrograma->avance_malla) {
                    //echo "<br>hay dif Internos 2 ->".$listaPrograma->nombre_programa."<br>".$avanceProgramaArr[0]->avancePrograma." avance ".$listaPrograma->avance_malla;
                    //print_r($listaPrograma);
                    GuardaDatosTablaReporte2017RutPrograma($listaPrograma->rut, $listaPrograma->id_programa);
                    $avance_temporal_array       = CalcularAvanceDatosTablaReporte2017RutPrograma($listaPrograma->rut, $listaPrograma->id_programa);
                    $listaPrograma->avance_malla = $avance_temporal_array[0]->avance;
                }

                //echo "<br>avanceProgramaArrInscripcionCierre $avanceProgramaArrInscripcionCierre <> listaPrograma->avance_malla ".$listaPrograma->avance_malla;

                /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
                $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
                echo "<br>Int_4 : $time_elapsed<br><br>";
                $start = round(microtime(true) * 1000);    */



                /*$objetos = TraigoObjetosDadoRutYMalla($listaPrograma->rut, $listaPrograma->id_malla, $id_objeto);
                foreach ($objetos as $obj) {
                    //print_r($obj); exit();
                    if ($obj->extension_objeto == 23) {
                        $html_objetos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_objetos_desafios.html");
                        $verifica_accion_pendiente = VerificaDesafioEnAccionesPendientes($rut, $id_empresa, $obj->id_curso, $obj->id_objeto);
                        if ($verifica_accion_pendiente[0]->estado === "0") {
                            //pendiente de validacion
                            $html_objetos = str_replace("{ICONO_ESTADO_DESAFIO}", "<img src='img/lms_icons_enproceso.png' width='20px'>", $html_objetos);
                            $html_objetos = str_replace("{VER_DESAFIO}", '<a href="?sw=contenido&i={ID_OBJETO_ENCODEADO}&rc={RUT_COLABORADOR_ENCODEADO}&checkin=1">Ver Desafio</a>', $html_objetos);
                        } else if ($verifica_accion_pendiente[0]->estado === "1") {
                            //Validado
                            $html_objetos = str_replace("{ICONO_ESTADO_DESAFIO}", "<img src='img/lms_icons_aprobado.jpg' width='20px'>", $html_objetos);
                            $html_objetos = str_replace("{VER_DESAFIO}", '<a href="?sw=contenido&i={ID_OBJETO_ENCODEADO}&rc={RUT_COLABORADOR_ENCODEADO}&checkin=1">Ver Desafio</a>', $html_objetos);
                        } else if (count($verifica_accion_pendiente) < 1) {
                            //No se a enviado a validar
                            $html_objetos = str_replace("{ICONO_ESTADO_DESAFIO}", "<img src='img/lms_icons_noiniciado.jpg' width='20px'>", $html_objetos);
                            $html_objetos = str_replace("{VER_DESAFIO}", '', $html_objetos);
                        }
                    } else {
                        $html_objetos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_objetos.html");
                    }
                    //VerificaDesafioEnAccionesPendientes($rut_colaborador, $id_empresa, $id_curso, $id_objeto);
                    $html_objetos                = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($obj->id_objeto), $html_objetos);
                    $html_objetos                = str_replace("{ID_CURSO_ENCODEADO}", Encodear3($obj->id_curso), $html_objetos);
                    $html_objetos                = str_replace("{RUT_COLABORADOR_ENCODEADO}", Encodear3($rut), $html_objetos);
                    $html_objetos                = str_replace("{OBJETO_NOMBRE}", utf8_encode($obj->nombre_objeto), $html_objetos);
                    $html_objetos                = str_replace("{NOTA_OBJETO}", utf8_encode($obj->nota), $html_objetos);
                    $html_objetos                = str_replace("{NOTA_OBJETO_1A7}", ColocaNotaConvertidaTrivia(utf8_encode($obj->nota)), $html_objetos);
                    $html_objetos                = str_replace("{ID_OBJETO_SLIDE}", $obj->id_objeto . $listaPrograma->rut, $html_objetos);
                    $listado_preguntas_De_Trivia = MuestraInformeIndividualDesdeVistaJefe($listaPrograma->rut, $obj->id_objeto);
                    $html_objetos                = str_replace("{LISTADO_PREGUINTAS_DE_TRIVIA}", $listado_preguntas_De_Trivia, $html_objetos);
                    //echo ColocaNotaConvertidaTrivia(utf8_encode($obj->nota))."<br>";
                    $nota_objeto_seleccionado    = (utf8_encode($obj->nota));
                }


                */
                //echo "aca";
                //echo $html_objetos;
                $bloque_archivos = str_replace("{ROW_LISTADO_OBJETOS_TRIVIAS}", $html_objetos, $bloque_archivos);
                $bloque_archivos = str_replace("{ROW_LISTADO_OBJETOS_TRIVIASV2}", $html_objetos, $bloque_archivos);





/*    $start = round(microtime(true) * 1000);    */
            $template = $listaPrograma->template;
            if ($template <> '') {
                $plantilla = $template;
            } else {
                $plantilla = "malla3";
            }
            /*
            echo "<br>".$listaPrograma->nombre_programa;
            echo "<br>".$avanceProgramaArrCursos[0]->certificacion;
            echo "<br>".$avanceProgramaArrCursos[0]->estadodescripcion;
            */
            if ($avanceProgramaArrCursos[0]->certificacion == 1) {
                $bloque_archivos = str_replace("{PROGRAMA_NOMBRE}", utf8_encode($listaPrograma->nombre_programa), $bloque_archivos);
                if ($avanceProgramaArrCursos[0]->estadodescripcion == "Aprueba" or $avanceProgramaArrCursos[0]->estadodescripcion == "APROBADO") {
                    $labelcolor = "success";
                }
                if ($avanceProgramaArrCursos[0]->estadodescripcion == "Reprueba" or $avanceProgramaArrCursos[0]->estadodescripcion == "REPROBADO") {
                    $labelcolor = "danger";
                }
                $RESULTADO_cert  = " <span class='label label-" . $labelcolor . "'><span class='blanco'>" . $avanceProgramaArrCursos[0]->nota . "% " . $avanceProgramaArrCursos[0]->estadodescripcion . "</span></span>";
                $bloque_archivos = str_replace("{RESULTADO_FINAL}", "", $bloque_archivos);
                $bloque_archivos = str_replace("{AVANCE_PROGRAMA}", $avanceProgramaArrCursos[0]->nota, $bloque_archivos);
            } else {
                $bloque_archivos = str_replace("{PROGRAMA_NOMBRE}", utf8_encode($listaPrograma->nombre_programa), $bloque_archivos);
                $bloque_archivos = str_replace("{RESULTADO_FINAL}", "", $bloque_archivos);
                if (utf8_encode($listaPrograma->avance_malla)) {
                    $bloque_archivos = str_replace("{AVANCE_PROGRAMA}", utf8_encode(round($listaPrograma->avance_malla)), $bloque_archivos);
                } else {
                    $bloque_archivos = str_replace("{AVANCE_PROGRAMA}", "0", $bloque_archivos);
                }
            }

    /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_5 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);        /**/
            $bloque_archivos = str_replace("{ID_PROGRAMA_SLIDE}", $listaPrograma->id_programa . $listaPrograma->rut, $bloque_archivos);
            $bloque_archivos = str_replace("{ID_MALLA}", utf8_encode($listaPrograma->id_malla), $bloque_archivos);
            $bloque_archivos = str_replace("{ID_MALLA_ENCODEADO}", Encodear3($listaPrograma->id_malla), $bloque_archivos);
            $bloque_archivos = str_replace("{ID_CURSO_ENCODEADO}", "", $bloque_archivos);

            $bloque_archivos = str_replace("{FOCO_PROGRAMA}", $listaPrograma->foco, $bloque_archivos);
            $bloque_archivos = str_replace("{ID_FOCO}", $listaPrograma->id_foco, $bloque_archivos);
            $bloque_archivos = str_replace("{CODIGO_FOCO}", $listaPrograma->id_foco, $bloque_archivos);
            $bloque_archivos = str_replace("{IMAGEN_PROGRAMA}", $listaPrograma->imagen_programa, $bloque_archivos);
            $bloque_archivos = str_replace("{DESCRIPCION_PROGRAMA}", utf8_encode($listaPrograma->descripcion_programa), $bloque_archivos);
            //$bloque_archivos = str_replace("{DESCRIPTOR_NOMBRE}",utf8_encode($listaPrograma->descriptor_nombre),$bloque_archivos);
            $bloque_archivos = str_replace("{URL_PROGRAMA}", utf8_encode($listaPrograma->url_programa), $bloque_archivos);
            $bloque_archivos = str_replace("{TEMPLATE}", $plantilla, $bloque_archivos);
            $bloque_archivos = str_replace("{RESULTADO_PROGRAMA_1A7}", "-", $bloque_archivos);
            //echo "<br>".$listaPrograma->avance_malla;

        /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_6 : $time_elapsed<br><br>";

    $start = round(microtime(true) * 1000);    */
            if ($listaPrograma->bbdd_host) {
                if ($contador_acumulador_bbdd > 0) {
                    $bloque_archivos = str_replace("{RESULTADO_PROGRAMA_1A7}", round(($acumulador_nota_bbdd / $contador_acumulador_bbdd), 1), $bloque_archivos);
                } else {
                    $bloque_archivos = str_replace("{RESULTADO_PROGRAMA_1A7}", "-", $bloque_archivos);
                }
            }
            if (utf8_encode($listaPrograma->avance_malla) == 100) {
                if ($listaPrograma->id_programa <> 'bci_competencias') {
                    $bloque_archivos = str_replace("{RESULTADO_PROGRAMA}", utf8_encode($listaPrograma->resultado), $bloque_archivos);
                    $bloque_archivos = str_replace("{RESULTADO_PROGRAMA_1A7}", MuestraNotaConvertidaPorEmpresa($id_empresa, utf8_encode($listaPrograma->resultado)), $bloque_archivos);
                } else {
                    $bloque_archivos = str_replace("{RESULTADO_PROGRAMA}", utf8_encode($listaPrograma->resultado), $bloque_archivos);
                    $bloque_archivos = str_replace("{RESULTADO_PROGRAMA_1A7}", "-", $bloque_archivos);
                }
                if ($listaPrograma->resultado > 0) {
                    $contador_100_porciento++;
                }
                $acumulador_100_porciento = $listaPrograma->resultado + $acumulador_100_porciento;
            } else {
                $bloque_archivos = str_replace("{RESULTADO_PROGRAMA}", utf8_encode($listaPrograma->resultado), $bloque_archivos);
                $bloque_archivos = str_replace("{RESULTADO_PROGRAMA_1A7}", MuestraNotaConvertidaPorEmpresa($id_empresa, utf8_encode($listaPrograma->resultado)), $bloque_archivos);
                if ($listaPrograma->resultado > 0) {
                    $contador_100_porciento++;
                }
                $acumulador_100_porciento = $listaPrograma->resultado + $acumulador_100_porciento;
            }
            //echo $listaPrograma->avance_malla;
            $bloque_archivos = str_replace("{RUT}", utf8_encode($rut), $bloque_archivos);
            $bloque_archivos = str_replace("{CLAVE_RUT}", substr($rut, 0, 4), $bloque_archivos);
            if ($listaPrograma->opcional === NULL) {
                $acumula_avance = $listaPrograma->avance_malla + $acumula_avance;
                //echo $listaPrograma->avance_malla;
                //echo "<br>";
                $cuenta_programas++;
            }
        }


            /*$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    $time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    echo "<br>Int_7 : $time_elapsed<br><br>"; */



    } else {
        $bloque_archivos = file_get_contents("views/integracion/row_lms_programa.html");
    }




    $start = round(microtime(true) * 1000);
    $arreglo[0]              = $bloque_archivos;
    $promedio_avance_general = round($acumula_avance / $cuenta_programas);
    $arreglo[1]              = $promedio_avance_general;
    if ($id_objeto) {
        $arreglo[2] = $nota_objeto_seleccionado;
    } else {
        $arreglo[2] = round($acumulador_100_porciento / $contador_100_porciento);
    }
    $arreglo[3] = $cuenta_programas;

    //$time_elapsed_secs = round(microtime(true) * 1000) - $start;
    //$time_elapsed= gmdate("H:i:s", $time_elapsed_secs);
    //echo "<br>Int_8 : $time_elapsed<br><br>";
    //echo "<br>".$listaPrograma->nombre_programa;//
    //echo "<br>promedio $promedio_avance_general, acuumulad avance $acumula_avance/ cuenta programas $cuenta_programas";
    return ($arreglo);
}

function lms_integracion_programas($rut, $id_empresa, $vista, $id_programa_bbdd, $id_curso, $id_objeto)
{
 //echo "hola lms_integracion_programas";sleep(4);
if ($id_empresa == "62") { //ActualizaLmsReporteInscripcionCierreRUT($rut);
}
// echo "<br /><br />$rut, $id_empresa, $vista, $id_programa_bbdd, $id_curso, $id_objeto";
if ($vista == "opcional") {
    $filtrodata = "opcional";
} else {
    $filtrodata = "";
}
$listaProgramas = lms_integracion_lista_programas($rut, $id_empresa, $id_programa_bbdd, $filtrodata);
// print_r($listaProgramas);
// array_sort_by($listaProgramas, "avance_malla", $order = SORT_ASC);
$bloque_archivos = "";
$cuenta = count($listaProgramas);
if ($cuenta > 0) {
    foreach($listaProgramas as $listaPrograma) {
        // print_r($listaPrograma);
        $html_objetos = "";
        /* if ($vista == "equipo")
        {
        $bloque_archivos.= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_programa_vista_equipo.html");
        }
        else
        if ($vista == "detalle")
        {
        $bloque_archivos.= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_programa_vista_detalle.html");
        }
        */
        if ($vista == "" or $vista == "opcional") {
            if ($listaPrograma->url_programa <> '') {
                $bloque_archivos.= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_programa.html");
            }
            else {
                $bloque_archivos.= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_programa_interno.html");
            }
        }
        $arr_masdeunamalla = Lms_Busca_MasdeunaMalla($rut, $listaPrograma->id_programa, $id_empresa);
        if ($arr_masdeunamalla > 1) {
            $Array_malla = Lms_Busca_MasdeunaMalla_Array($rut, $listaPrograma->id_programa, $id_empresa);
            $avanceProgramaArrCursos = BuscaAvgCierreCursoArrayMalla($Array_malla, $id_empresa, $listaPrograma->rut);
        }
        else {
            $avanceProgramaArrCursos = BuscaAvgCierreCurso($listaPrograma->id_malla, $id_empresa, $listaPrograma->rut);
        }
        $sumaavancecursos = 0;
        $cuentaavancecursos = 0;
        foreach($avanceProgramaArrCursos as $avanceProgramaArrCurso) {
            /* echo "<pre>";               print_r($avanceProgramaArrCurso); */
            $sumaavancecursos = $sumaavancecursos + $avanceProgramaArrCurso->avance;
            $cuentaavancecursos++;
        }
        if ($cuentaavancecursos > 0) {
            $avanceProgramaArrInscripcionCierre = round($sumaavancecursos / $cuentaavancecursos);
        }
        else {
            $avanceProgramaArrInscripcionCierre = 0;
        }

       if ($avanceProgramaArrInscripcionCierre <> $listaPrograma->avance_malla) {
            GuardaDatosTablaReporte2017RutPrograma($listaPrograma->rut, $listaPrograma->id_programa);
            $avance_temporal_array = CalcularAvanceDatosTablaReporte2017RutPrograma($listaPrograma->rut, $listaPrograma->id_programa);
            $listaPrograma->avance_malla = $avance_temporal_array[0]->avance;
        }

        $bloque_archivos = str_replace("{ROW_LISTADO_OBJETOS_TRIVIAS}", $html_objetos, $bloque_archivos);
        // $bloque_archivos = str_replace("{ROW_LISTADO_OBJETOS_TRIVIASV2}", $html_objetos, $bloque_archivos);
        $template = $listaPrograma->template;
        if ($template <> '') {
            $plantilla = $template;
        }
        else {
            $id_template_programa = BuscaTemplatePrograma($listaPrograma->id_programa, $id_empresa);
            if ($id_template_programa <> '') {
                $plantilla = $id_template_programa;
            }
            else {
                $plantilla = "malla3";
            }
        }
        if ($avanceProgramaArrCursos[0]->certificacion == 1) {
            $bloque_archivos = str_replace("{PROGRAMA_NOMBRE}", utf8_encode($listaPrograma->nombre_programa) , $bloque_archivos);
            if ($avanceProgramaArrCursos[0]->estadodescripcion == "Aprueba" or $avanceProgramaArrCursos[0]->estadodescripcion == "APROBADO") {
                $labelcolor = "success";
            }
            if ($avanceProgramaArrCursos[0]->estadodescripcion == "Reprueba" or $avanceProgramaArrCursos[0]->estadodescripcion == "REPROBADO") {
                $labelcolor = "danger";
            }
            $RESULTADO_cert = " <span class='label label-" . $labelcolor . "'><span class='blanco'>" . $avanceProgramaArrCursos[0]->nota . "% " . $avanceProgramaArrCursos[0]->estadodescripcion . "</span></span>";
            $bloque_archivos = str_replace("{RESULTADO_FINAL}", "", $bloque_archivos);
            $bloque_archivos = str_replace("{AVANCE_PROGRAMA}", $avanceProgramaArrCursos[0]->nota, $bloque_archivos);
        }
        else {
            $bloque_archivos = str_replace("{PROGRAMA_NOMBRE}", utf8_encode($listaPrograma->nombre_programa) , $bloque_archivos);
            $bloque_archivos = str_replace("{RESULTADO_FINAL}", "", $bloque_archivos);
            if (utf8_encode($listaPrograma->avance_malla)) {
                $bloque_archivos = str_replace("{AVANCE_PROGRAMA}", utf8_encode(round($listaPrograma->avance_malla)) , $bloque_archivos);
            }
            else {
                $bloque_archivos = str_replace("{AVANCE_PROGRAMA}", "0", $bloque_archivos);
            }
        }
        $bloque_archivos = str_replace("{ID_PROGRAMA_SLIDE}", $listaPrograma->id_programa . $listaPrograma->rut, $bloque_archivos);
        $bloque_archivos = str_replace("{ID_MALLA}", utf8_encode($listaPrograma->id_malla) , $bloque_archivos);
        $bloque_archivos = str_replace("{ID_MALLA_ENCODEADO}", Encodear3($listaPrograma->id_malla) , $bloque_archivos);
        $bloque_archivos = str_replace("{ID_CURSO_ENCODEADO}", "", $bloque_archivos);
        $bloque_archivos = str_replace("{FOCO_PROGRAMA}", $listaPrograma->foco, $bloque_archivos);
        $bloque_archivos = str_replace("{ID_FOCO}", $listaPrograma->id_foco, $bloque_archivos);
        $bloque_archivos = str_replace("{CODIGO_FOCO}", $listaPrograma->id_foco, $bloque_archivos);
        $bloque_archivos = str_replace("{IMAGEN_PROGRAMA}", $listaPrograma->imagen_programa, $bloque_archivos);
        $bloque_archivos = str_replace("{DESCRIPCION_PROGRAMA}", utf8_encode($listaPrograma->descripcion_programa) , $bloque_archivos);
        // $bloque_archivos = str_replace("{DESCRIPTOR_NOMBRE}",utf8_encode($listaPrograma->descriptor_nombre),$bloque_archivos);
        $bloque_archivos = str_replace("{URL_PROGRAMA}", utf8_encode($listaPrograma->url_programa) , $bloque_archivos);
        $bloque_archivos = str_replace("{TEMPLATE}", $plantilla, $bloque_archivos);
        $bloque_archivos = str_replace("{RESULTADO_PROGRAMA_1A7}", "-", $bloque_archivos);
        if (utf8_encode($listaPrograma->avance_malla) == 100) {
            if ($listaPrograma->id_programa <> 'bci_competencias') {
                $bloque_archivos = str_replace("{RESULTADO_PROGRAMA}", utf8_encode($listaPrograma->resultado) , $bloque_archivos);
                $bloque_archivos = str_replace("{RESULTADO_PROGRAMA_1A7}", MuestraNotaConvertidaPorEmpresa($id_empresa, utf8_encode($listaPrograma->resultado)) , $bloque_archivos);
            }
            else {
                $bloque_archivos = str_replace("{RESULTADO_PROGRAMA}", utf8_encode($listaPrograma->resultado) , $bloque_archivos);
                $bloque_archivos = str_replace("{RESULTADO_PROGRAMA_1A7}", "-", $bloque_archivos);
            }
            if ($listaPrograma->resultado > 0) {
                $contador_100_porciento++;
            }
            $acumulador_100_porciento = $listaPrograma->resultado + $acumulador_100_porciento;
        }
        else {
            $bloque_archivos = str_replace("{RESULTADO_PROGRAMA}", utf8_encode($listaPrograma->resultado) , $bloque_archivos);
            $bloque_archivos = str_replace("{RESULTADO_PROGRAMA_1A7}", MuestraNotaConvertidaPorEmpresa($id_empresa, utf8_encode($listaPrograma->resultado)) , $bloque_archivos);
            if ($listaPrograma->resultado > 0) {
                $contador_100_porciento++;
            }
            $acumulador_100_porciento = $listaPrograma->resultado + $acumulador_100_porciento;
        }
        $bloque_archivos = str_replace("{RUT}", utf8_encode($rut) , $bloque_archivos);
        $bloque_archivos = str_replace("{CLAVE_RUT}", substr($rut, 0, 4) , $bloque_archivos);
        if ($listaPrograma->opcional === NULL) {
            $acumula_avance = $listaPrograma->avance_malla + $acumula_avance;
            $cuenta_programas++;
        }

            //echo "opcionales ".$listaPrograma->opcional;

        if($listaPrograma->opcional=="1"){
             $cuenta_programas_op++;
        }



    }
}
else {
    $bloque_archivos = file_get_contents("views/integracion/row_lms_programa.html");
}
if ($cuentaavancecursos > 0) {
    $arreglo[0] = $bloque_archivos;
}
else {
    $arreglo[0] = "";
}
$promedio_avance_general = round($acumula_avance / $cuenta_programas);
$arreglo[1] = $promedio_avance_general;
if ($id_objeto) {
    $arreglo[2] = $nota_objeto_seleccionado;
}
else {
    $arreglo[2] = round($acumulador_100_porciento / $contador_100_porciento);
}

    $arreglo[3] = $cuenta_programas;
    $arreglo[4] = $cuenta_programas_op;

// print_r($arreglo);               // echo "<br />promedio $promedio_avance_general, acuumulad avance $acumula_avance/ cuenta programas $cuenta_programas";

return ($arreglo);
}


function lms_integracion_programas_URL_TEMA($rut, $id_empresa, $vista, $id_programa_bbdd, $id_curso, $id_objeto)
{
    $listaProgramas  = lms_integracion_lista_programas_URLTEMA($rut, $id_empresa, $id_programa_bbdd, $filtrodata);
    //print_r($listaProgramas);
    //array_sort_by($listaProgramas, "avance_malla", $order = SORT_ASC);
    $bloque_archivos = "";
    $cuenta          = count($listaProgramas);
    //echo "cuenta $cuenta";


    if ($cuenta > 0) {
        foreach ($listaProgramas as $listaPrograma) {
            //print_r($listaPrograma);
            if ($vista == "" or $vista == "opcional") {
                if ($listaPrograma->url_programa <> '') {
                    $bloque_archivos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_programa.html");
                } else {
                    $bloque_archivos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_programa_interno.html");
                }
            }
            $avanceProgramaArrCursos = BuscaAvgCierreCurso($listaPrograma->id_malla, $id_empresa, $listaPrograma->rut);
            //print_r($avanceProgramaArrCursos);
            $sumaavancecursos        = 0;
            $cuentaavancecursos      = 0;
            foreach ($avanceProgramaArrCursos as $avanceProgramaArrCurso) {
                $sumaavancecursos = $sumaavancecursos + $avanceProgramaArrCurso->avance;
                $cuentaavancecursos++;
            }
            if ($cuentaavancecursos > 0) {
                $avanceProgramaArrInscripcionCierre = round($sumaavancecursos / $cuentaavancecursos);
            } else {
                $avanceProgramaArrInscripcionCierre = 0;
            }
            //cho "<br>";
            //echo "<br><br><br>hay dif Internos ->".$listaPrograma->nombre_programa."<br>".$avanceProgramaArr[0]->avancePrograma.", avance ".$listaPrograma->avance_malla." - ".$avanceProgramaArrInscripcionCierre;
            if ($avanceProgramaArrInscripcionCierre <> $listaPrograma->avance_malla) {
                //echo "<br>hay dif Internos 2 ->".$listaPrograma->nombre_programa."<br>".$avanceProgramaArr[0]->avancePrograma." avance ".$listaPrograma->avance_malla;
                //print_r($listaPrograma);
                GuardaDatosTablaReporte2017RutPrograma($listaPrograma->rut, $listaPrograma->id_programa);
                $avance_temporal_array       = CalcularAvanceDatosTablaReporte2017RutPrograma($listaPrograma->rut, $listaPrograma->id_programa);
                $listaPrograma->avance_malla = $avance_temporal_array[0]->avance;
            }
            $objetos = TraigoObjetosDadoRutYMalla($listaPrograma->rut, $listaPrograma->id_malla, $id_objeto);
            foreach ($objetos as $obj) {
                //print_r($obj); exit();
                if ($obj->extension_objeto == 23) {
                    $html_objetos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_objetos_desafios.html");
                    $verifica_accion_pendiente = VerificaDesafioEnAccionesPendientes($rut, $id_empresa, $obj->id_curso, $obj->id_objeto);
                    if ($verifica_accion_pendiente[0]->estado === "0") {
                        //pendiente de validacion
                        $html_objetos = str_replace("{ICONO_ESTADO_DESAFIO}", "<img src='img/lms_icons_enproceso.png' width='20px'>", $html_objetos);
                        $html_objetos = str_replace("{VER_DESAFIO}", '<a href="?sw=contenido&i={ID_OBJETO_ENCODEADO}&rc={RUT_COLABORADOR_ENCODEADO}&checkin=1">Ver Desafio</a>', $html_objetos);
                    } else if ($verifica_accion_pendiente[0]->estado === "1") {
                        //Validado
                        $html_objetos = str_replace("{ICONO_ESTADO_DESAFIO}", "<img src='img/lms_icons_aprobado.jpg' width='20px'>", $html_objetos);
                        $html_objetos = str_replace("{VER_DESAFIO}", '<a href="?sw=contenido&i={ID_OBJETO_ENCODEADO}&rc={RUT_COLABORADOR_ENCODEADO}&checkin=1">Ver Desafio</a>', $html_objetos);
                    } else if (count($verifica_accion_pendiente) < 1) {
                        //No se a enviado a validar
                        $html_objetos = str_replace("{ICONO_ESTADO_DESAFIO}", "<img src='img/lms_icons_noiniciado.jpg' width='20px'>", $html_objetos);
                        $html_objetos = str_replace("{VER_DESAFIO}", '', $html_objetos);
                    }
                } else {
                    $html_objetos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_objetos.html");
                }
                //VerificaDesafioEnAccionesPendientes($rut_colaborador, $id_empresa, $id_curso, $id_objeto);
                $html_objetos                = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($obj->id_objeto), $html_objetos);
                $html_objetos                = str_replace("{ID_CURSO_ENCODEADO}", Encodear3($obj->id_curso), $html_objetos);
                $html_objetos                = str_replace("{RUT_COLABORADOR_ENCODEADO}", Encodear3($rut), $html_objetos);
                $html_objetos                = str_replace("{OBJETO_NOMBRE}", utf8_encode($obj->nombre_objeto), $html_objetos);
                $html_objetos                = str_replace("{NOTA_OBJETO}", utf8_encode($obj->nota), $html_objetos);
                $html_objetos                = str_replace("{NOTA_OBJETO_1A7}", ColocaNotaConvertidaTrivia(utf8_encode($obj->nota)), $html_objetos);
                $html_objetos                = str_replace("{ID_OBJETO_SLIDE}", $obj->id_objeto . $listaPrograma->rut, $html_objetos);
                $listado_preguntas_De_Trivia = MuestraInformeIndividualDesdeVistaJefe($listaPrograma->rut, $obj->id_objeto);
                $html_objetos                = str_replace("{LISTADO_PREGUINTAS_DE_TRIVIA}", $listado_preguntas_De_Trivia, $html_objetos);
                //echo ColocaNotaConvertidaTrivia(utf8_encode($obj->nota))."<br>";
                $nota_objeto_seleccionado    = (utf8_encode($obj->nota));
            }
            //echo "aca";
            //echo $html_objetos;
            $bloque_archivos = str_replace("{ROW_LISTADO_OBJETOS_TRIVIAS}", $html_objetos, $bloque_archivos);
            $bloque_archivos = str_replace("{ROW_LISTADO_OBJETOS_TRIVIASV2}", $html_objetos, $bloque_archivos);
            $template        = $listaPrograma->tipo;
            if ($template <> '') {
                $plantilla = $template;
            } else {
                $plantilla = "malla3";
            }
            /*
            echo "<br>".$listaPrograma->nombre_programa;
            echo "<br>".$avanceProgramaArrCursos[0]->certificacion;
            echo "<br>".$avanceProgramaArrCursos[0]->estadodescripcion;
            */
            if ($avanceProgramaArrCursos[0]->certificacion == 1) {
                $bloque_archivos = str_replace("{PROGRAMA_NOMBRE}", utf8_encode($listaPrograma->nombre_programa), $bloque_archivos);
                if ($avanceProgramaArrCursos[0]->estadodescripcion == "Aprueba" or $avanceProgramaArrCursos[0]->estadodescripcion == "APROBADO") {
                    $labelcolor = "success";
                }
                if ($avanceProgramaArrCursos[0]->estadodescripcion == "Reprueba" or $avanceProgramaArrCursos[0]->estadodescripcion == "REPROBADO") {
                    $labelcolor = "danger";
                }
                $RESULTADO_cert  = " <span class='label label-" . $labelcolor . "'><span class='blanco'>" . $avanceProgramaArrCursos[0]->nota . "% " . $avanceProgramaArrCursos[0]->estadodescripcion . "</span></span>";
                $bloque_archivos = str_replace("{RESULTADO_FINAL}", "", $bloque_archivos);
                $bloque_archivos = str_replace("{AVANCE_PROGRAMA}", $avanceProgramaArrCursos[0]->nota, $bloque_archivos);
            } else {
                $bloque_archivos = str_replace("{PROGRAMA_NOMBRE}", utf8_encode($listaPrograma->nombre_programa), $bloque_archivos);
                $bloque_archivos = str_replace("{RESULTADO_FINAL}", "", $bloque_archivos);
                if (utf8_encode($listaPrograma->avance_malla)) {
                    $bloque_archivos = str_replace("{AVANCE_PROGRAMA}", utf8_encode(round($listaPrograma->avance_malla)), $bloque_archivos);
                } else {
                    $bloque_archivos = str_replace("{AVANCE_PROGRAMA}", "0", $bloque_archivos);
                }
            }
            $bloque_archivos = str_replace("{ID_PROGRAMA_SLIDE}", $listaPrograma->id_programa . $listaPrograma->rut, $bloque_archivos);
            $bloque_archivos = str_replace("{ID_MALLA}", utf8_encode($listaPrograma->id_malla), $bloque_archivos);
            $bloque_archivos = str_replace("{ID_MALLA_ENCODEADO}", Encodear3($listaPrograma->id_malla), $bloque_archivos);
            $bloque_archivos = str_replace("{FOCO_PROGRAMA}", $listaPrograma->foco, $bloque_archivos);
            $bloque_archivos = str_replace("{ID_FOCO}", $listaPrograma->id_foco, $bloque_archivos);
            $bloque_archivos = str_replace("{CODIGO_FOCO}", $listaPrograma->id_foco, $bloque_archivos);
            $bloque_archivos = str_replace("{IMAGEN_PROGRAMA}", $listaPrograma->imagen_programa, $bloque_archivos);
            $bloque_archivos = str_replace("{DESCRIPCION_PROGRAMA}", utf8_encode($listaPrograma->descripcion_programa), $bloque_archivos);
            //$bloque_archivos = str_replace("{DESCRIPTOR_NOMBRE}",utf8_encode($listaPrograma->descriptor_nombre),$bloque_archivos);
            $bloque_archivos = str_replace("{URL_PROGRAMA}", utf8_encode($listaPrograma->url_programa), $bloque_archivos);
            $bloque_archivos = str_replace("{TEMPLATE}", $plantilla, $bloque_archivos);
            $bloque_archivos = str_replace("{RESULTADO_PROGRAMA_1A7}", "-", $bloque_archivos);
            //echo "<br>".$listaPrograma->avance_malla;
            if ($listaPrograma->bbdd_host) {
                if ($contador_acumulador_bbdd > 0) {
                    $bloque_archivos = str_replace("{RESULTADO_PROGRAMA_1A7}", round(($acumulador_nota_bbdd / $contador_acumulador_bbdd), 1), $bloque_archivos);
                } else {
                    $bloque_archivos = str_replace("{RESULTADO_PROGRAMA_1A7}", "-", $bloque_archivos);
                }
            }
            if (utf8_encode($listaPrograma->avance_malla) == 100) {
                if ($listaPrograma->id_programa <> 'bci_competencias') {
                    $bloque_archivos = str_replace("{RESULTADO_PROGRAMA}", utf8_encode($listaPrograma->resultado), $bloque_archivos);
                    $bloque_archivos = str_replace("{RESULTADO_PROGRAMA_1A7}", MuestraNotaConvertidaPorEmpresa($id_empresa, utf8_encode($listaPrograma->resultado)), $bloque_archivos);
                } else {
                    $bloque_archivos = str_replace("{RESULTADO_PROGRAMA}", utf8_encode($listaPrograma->resultado), $bloque_archivos);
                    $bloque_archivos = str_replace("{RESULTADO_PROGRAMA_1A7}", "-", $bloque_archivos);
                }
                if ($listaPrograma->resultado > 0) {
                    $contador_100_porciento++;
                }
                $acumulador_100_porciento = $listaPrograma->resultado + $acumulador_100_porciento;
            } else {
                $bloque_archivos = str_replace("{RESULTADO_PROGRAMA}", utf8_encode($listaPrograma->resultado), $bloque_archivos);
                $bloque_archivos = str_replace("{RESULTADO_PROGRAMA_1A7}", MuestraNotaConvertidaPorEmpresa($id_empresa, utf8_encode($listaPrograma->resultado)), $bloque_archivos);
                if ($listaPrograma->resultado > 0) {
                    $contador_100_porciento++;
                }
                $acumulador_100_porciento = $listaPrograma->resultado + $acumulador_100_porciento;
            }
            //echo $listaPrograma->avance_malla;
            $bloque_archivos = str_replace("{RUT}", utf8_encode($rut), $bloque_archivos);
            $bloque_archivos = str_replace("{CLAVE_RUT}", substr($rut, 0, 4), $bloque_archivos);
            if ($listaPrograma->opcional === NULL) {
                $acumula_avance = $listaPrograma->avance_malla + $acumula_avance;
                //echo $listaPrograma->avance_malla;
                //echo "<br>";
                $cuenta_programas++;
            }
        }
    } else {
        $bloque_archivos = "";
    }
    $arreglo[0]              = $bloque_archivos;
    $promedio_avance_general = round($acumula_avance / $cuenta_programas);
    $arreglo[1]              = $promedio_avance_general;
    if ($id_objeto) {
        $arreglo[2] = $nota_objeto_seleccionado;
    } else {
        $arreglo[2] = round($acumulador_100_porciento / $contador_100_porciento);
    }
    $arreglo[3] = $cuenta_programas;
    //echo "<br>".$listaPrograma->nombre_programa;//
    //echo "<br>promedio $promedio_avance_general, acuumulad avance $acumula_avance/ cuenta programas $cuenta_programas";
    return ($arreglo);
}
function lms_integracion_programas_realizados($rut, $id_empresa, $vista, $id_programa_bbdd, $id_curso, $id_objeto)
{
    if ($vista == "opcional") {
        $filtrodata = "opcional";
    } else {
        $filtrodata = "";
    }
    $listaProgramas    = lms_integracion_lista_programas($rut, $id_empresa, $id_programa_bbdd, $filtrodata);
    $cuenta_realizados = 0;
    //print_r($listaProgramas);
    array_sort_by($listaProgramas, "avance_malla", $order = SORT_ASC);
    $bloque_archivos = "";
    $cuenta          = count($listaProgramas);
    if ($cuenta > 0) {
        foreach ($listaProgramas as $listaPrograma) {
            //print_r($listaPrograma);
            $html_objetos = "";
            if ($vista == "equipo") {
                $bloque_archivos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_programa_vista_equipo.html");
            } else if ($vista == "detalle") {
                $bloque_archivos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_programa_vista_detalle.html");
            } else if ($listaPrograma->bbdd_host) {
                //Aca verifico si este usuario esta en la base y host remoto
                INTEGRACION_VerificaUsuarioEnOtraBase($rut, $listaPrograma->bbdd_host, $listaPrograma->bbdd_database, $listaPrograma->bbdd_username, $listaPrograma->bbdd_password, $listaPrograma->id_malla, $listaPrograma->id_empresa_programa);
            } else {
            }
            if ($vista == "" or $vista == "opcional") {
                if ($listaPrograma->url_programa <> '') {
                    //$bloque_archivos.=file_get_contents("views/integracion/".$id_empresa."_row_lms_programa.html");
                } else {
                    if ($listaPrograma->avance_malla == '100') {
                        $bloque_archivos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_programa_interno_realizados.html");
                        $cuenta_realizados++;
                    }
                }
            }
            if ($listaPrograma->bbdd_host) {
                $link_exte = mysql_connect($listaPrograma->bbdd_host, $listaPrograma->bbdd_username, $listaPrograma->bbdd_password);
                //echo 'Conexion Exitosa Rel Malla curso Insert Malla<br>';
                mysql_select_db($listaPrograma->bbdd_database);
                if ($id_objeto) {
                    $filtro_objeto = " and tbl_objeto.id='$id_objeto' ";
                }
                if ($_GET["sw"] == "MuestraBloqueColaboradoresPorJefe" && $_SESSION["id_objeto_para_vistaequipo"]) {
                    $filtro_objeto = " and tbl_objeto.id='" . $_SESSION["id_objeto_para_vistaequipo"] . "' ";
                }
                //verifica avance avg en dicho programa
                $query_lms_reportes = "select ROUND(avg(avance)) as AvancePrograma from tbl_lms_reportes where rut='" . $listaPrograma->rut . "'";
                $result_lms_reportes = mysql_query($query_lms_reportes) or die('Consulta fallida: ' . mysql_error());
                $dATA = mysql_fetch_array($result_lms_reportes, MYSQL_ASSOC);
                if ($dATA[AvancePrograma] > $listaPrograma->avance_malla) {
                    //echo "<br>Externos ->".$listaPrograma->nombre_programa;
                    //echo "---".$dATA[AvancePrograma]." <> $listaPrograma->avance_malla";
                    GuardaDatosTablaReporte2017RutPrograma($listaPrograma->rut, $listaPrograma->id_programa);
                    $avance_temporal_array       = CalcularAvanceDatosTablaReporte2017RutPrograma($listaPrograma->rut, $listaPrograma->id_programa);
                    $listaPrograma->avance_malla = $avance_temporal_array[0]->avance;
                }
                $query_lms_trivia         = "
    select tbl_objeto.id as id_objeto, tbl_objeto.titulo as nombre_objeto, tbl_objetos_finalizados.nota,
    rel_lms_malla_curso.id_curso from rel_lms_malla_curso
    inner join tbl_objeto on tbl_objeto.id_curso=rel_lms_malla_curso.id_curso
    left join tbl_objetos_finalizados
    on tbl_objetos_finalizados.id_objeto=tbl_objeto.id and tbl_objetos_finalizados.rut='" . $listaPrograma->rut . "'
    where rel_lms_malla_curso.id_malla='" . $listaPrograma->id_malla . "' and tbl_objeto.tipo_objeto='5' $filtro_objeto ";
                //$result_lms_trivia = mysql_query($query_lms_trivia) or die('Consulta fallida: ' . mysql_error());
                $contador_acumulador_bbdd = 0;
                $nota_convertida          = "";
                $acumulador_nota_bbdd     = "";
                while ($fila_lms_trivia = mysql_fetch_array($result_lms_trivia, MYSQL_ASSOC)) {
                    $html_objetos .= file_get_contents("views/integracion/row_lms_objetos.html");
                    $html_objetos = str_replace("{OBJETO_NOMBRE}", utf8_encode($fila_lms_trivia["nombre_objeto"]), $html_objetos);
                    if (utf8_encode($fila_lms_trivia["nota"])) {
                        //$html_objetos = str_replace("{NOTA_OBJETO}",MuestraNotaConvertidaPorEmpresa($id_empresa, utf8_encode($fila_lms_trivia["nota"])),$html_objetos);
                        $nota_convertida          = MuestraNotaConvertidaPorEmpresa($id_empresa, utf8_encode($fila_lms_trivia["nota"]));
                        $html_objetos             = str_replace("{NOTA_OBJETO}", $nota_convertida, $html_objetos);
                        $nota_objeto_seleccionado = $fila_lms_trivia["nota"];
                        $acumulador_nota_bbdd     = $acumulador_nota_bbdd + $nota_convertida;
                        $contador_acumulador_bbdd++;
                        //echo $nota_convertida." ".$contador_acumulador_bbdd;
                        //echo "<br>";
                    } else {
                        $html_objetos = str_replace("{NOTA_OBJETO}", "-", $html_objetos);
                    }
                }
                //$bloque_archivos = str_replace("{ROW_LISTADO_OBJETOS_TRIVIAS}",$html_objetos,$bloque_archivos);
                $bloque_archivos = str_replace("{ROW_LISTADO_OBJETOS_TRIVIAS}", "", $bloque_archivos);
            } else {
                $avanceProgramaArrCursos = BuscaAvgCierreCurso($listaPrograma->id_malla, $id_empresa, $listaPrograma->rut);
                //print_r($avanceProgramaArrCursos);
                $sumaavancecursos        = 0;
                $cuentaavancecursos      = 0;
                foreach ($avanceProgramaArrCursos as $avanceProgramaArrCurso) {
                    $sumaavancecursos = $sumaavancecursos + $avanceProgramaArrCurso->avance;
                    $cuentaavancecursos++;
                }
                if ($cuentaavancecursos > 0) {
                    $avanceProgramaArrInscripcionCierre = round($sumaavancecursos / $cuentaavancecursos);
                } else {
                    $avanceProgramaArrInscripcionCierre = 0;
                }
                //cho "<br>";
                //echo "<br><br><br>hay dif Internos ->".$listaPrograma->nombre_programa."<br>".$avanceProgramaArr[0]->avancePrograma.", avance ".$listaPrograma->avance_malla." - ".$avanceProgramaArrInscripcionCierre;
                if ($avanceProgramaArrInscripcionCierre <> $listaPrograma->avance_malla) {
                    //echo "<br>hay dif Internos 2 ->".$listaPrograma->nombre_programa."<br>".$avanceProgramaArr[0]->avancePrograma." avance ".$listaPrograma->avance_malla;
                    //print_r($listaPrograma);
                    GuardaDatosTablaReporte2017RutPrograma($listaPrograma->rut, $listaPrograma->id_programa);
                    $avance_temporal_array       = CalcularAvanceDatosTablaReporte2017RutPrograma($listaPrograma->rut, $listaPrograma->id_programa);
                    $listaPrograma->avance_malla = $avance_temporal_array[0]->avance;
                }
                $objetos = TraigoObjetosDadoRutYMalla($listaPrograma->rut, $listaPrograma->id_malla, $id_objeto);
                foreach ($objetos as $obj) {
                    //print_r($obj); exit();
                    if ($obj->extension_objeto == 23) {
                        $html_objetos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_objetos_desafios.html");
                        $verifica_accion_pendiente = VerificaDesafioEnAccionesPendientes($rut, $id_empresa, $obj->id_curso, $obj->id_objeto);
                        if ($verifica_accion_pendiente[0]->estado === "0") {
                            //pendiente de validacion
                            $html_objetos = str_replace("{ICONO_ESTADO_DESAFIO}", "<img src='img/lms_icons_enproceso.png' width='20px'>", $html_objetos);
                            $html_objetos = str_replace("{VER_DESAFIO}", '<a href="?sw=contenido&i={ID_OBJETO_ENCODEADO}&rc={RUT_COLABORADOR_ENCODEADO}&checkin=1">Ver Desafio</a>', $html_objetos);
                        } else if ($verifica_accion_pendiente[0]->estado === "1") {
                            //Validado
                            $html_objetos = str_replace("{ICONO_ESTADO_DESAFIO}", "<img src='img/lms_icons_aprobado.jpg' width='20px'>", $html_objetos);
                            $html_objetos = str_replace("{VER_DESAFIO}", '<a href="?sw=contenido&i={ID_OBJETO_ENCODEADO}&rc={RUT_COLABORADOR_ENCODEADO}&checkin=1">Ver Desafio</a>', $html_objetos);
                        } else if (count($verifica_accion_pendiente) < 1) {
                            //No se a enviado a validar
                            $html_objetos = str_replace("{ICONO_ESTADO_DESAFIO}", "<img src='img/lms_icons_noiniciado.jpg' width='20px'>", $html_objetos);
                            $html_objetos = str_replace("{VER_DESAFIO}", '', $html_objetos);
                        }
                    } else {
                        $html_objetos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_objetos.html");
                    }
                    //VerificaDesafioEnAccionesPendientes($rut_colaborador, $id_empresa, $id_curso, $id_objeto);
                    $html_objetos                = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($obj->id_objeto), $html_objetos);
                    $html_objetos                = str_replace("{ID_CURSO_ENCODEADO}", Encodear3($obj->id_curso), $html_objetos);
                    $html_objetos                = str_replace("{RUT_COLABORADOR_ENCODEADO}", Encodear3($rut), $html_objetos);
                    $html_objetos                = str_replace("{OBJETO_NOMBRE}", utf8_encode($obj->nombre_objeto), $html_objetos);
                    $html_objetos                = str_replace("{NOTA_OBJETO}", utf8_encode($obj->nota), $html_objetos);
                    $html_objetos                = str_replace("{NOTA_OBJETO_1A7}", ColocaNotaConvertidaTrivia(utf8_encode($obj->nota)), $html_objetos);
                    $html_objetos                = str_replace("{ID_OBJETO_SLIDE}", $obj->id_objeto . $listaPrograma->rut, $html_objetos);
                    $listado_preguntas_De_Trivia = MuestraInformeIndividualDesdeVistaJefe($listaPrograma->rut, $obj->id_objeto);
                    $html_objetos                = str_replace("{LISTADO_PREGUINTAS_DE_TRIVIA}", $listado_preguntas_De_Trivia, $html_objetos);
                    //echo ColocaNotaConvertidaTrivia(utf8_encode($obj->nota))."<br>";
                    $nota_objeto_seleccionado    = (utf8_encode($obj->nota));
                }
                //echo "aca";
                //echo $html_objetos;
                $bloque_archivos = str_replace("{ROW_LISTADO_OBJETOS_TRIVIAS}", $html_objetos, $bloque_archivos);
                $bloque_archivos = str_replace("{ROW_LISTADO_OBJETOS_TRIVIASV2}", $html_objetos, $bloque_archivos);
            }
            $template = $listaPrograma->template;
            if ($template <> '') {
                $plantilla = $template;
            } else {
                $plantilla = "malla3";
            }
            /*
            echo "<br>".$listaPrograma->nombre_programa;
            echo "<br>".$avanceProgramaArrCursos[0]->certificacion;
            echo "<br>".$avanceProgramaArrCursos[0]->estadodescripcion;
            */
            if ($avanceProgramaArrCursos[0]->certificacion == 1) {
                $bloque_archivos = str_replace("{PROGRAMA_NOMBRE}", utf8_encode($listaPrograma->nombre_programa), $bloque_archivos);
                if ($avanceProgramaArrCursos[0]->estadodescripcion == "Aprueba" or $avanceProgramaArrCursos[0]->estadodescripcion == "APROBADO") {
                    $labelcolor = "success";
                }
                if ($avanceProgramaArrCursos[0]->estadodescripcion == "Reprueba" or $avanceProgramaArrCursos[0]->estadodescripcion == "REPROBADO") {
                    $labelcolor = "danger";
                }
                $RESULTADO_cert  = " <span class='label label-" . $labelcolor . "'><span class='blanco'>" . $avanceProgramaArrCursos[0]->nota . "% " . $avanceProgramaArrCursos[0]->estadodescripcion . "</span></span>";
                $bloque_archivos = str_replace("{RESULTADO_FINAL}", "", $bloque_archivos);
                $bloque_archivos = str_replace("{AVANCE_PROGRAMA}", $avanceProgramaArrCursos[0]->nota, $bloque_archivos);
            } else {
                $bloque_archivos = str_replace("{PROGRAMA_NOMBRE}", utf8_encode($listaPrograma->nombre_programa), $bloque_archivos);
                $bloque_archivos = str_replace("{RESULTADO_FINAL}", "", $bloque_archivos);
                if (utf8_encode($listaPrograma->avance_malla)) {
                    $bloque_archivos = str_replace("{AVANCE_PROGRAMA}", utf8_encode(round($listaPrograma->avance_malla)), $bloque_archivos);
                } else {
                    $bloque_archivos = str_replace("{AVANCE_PROGRAMA}", "0", $bloque_archivos);
                }
            }
            $bloque_archivos = str_replace("{ID_PROGRAMA_SLIDE}", $listaPrograma->id_programa . $listaPrograma->rut, $bloque_archivos);
            $bloque_archivos = str_replace("{ID_MALLA}", utf8_encode($listaPrograma->id_malla), $bloque_archivos);
            $bloque_archivos = str_replace("{ID_MALLA_ENCODEADO}", Encodear3($listaPrograma->id_malla), $bloque_archivos);
            $bloque_archivos = str_replace("{FOCO_PROGRAMA}", $listaPrograma->foco, $bloque_archivos);
            $bloque_archivos = str_replace("{ID_FOCO}", $listaPrograma->id_foco, $bloque_archivos);
            $bloque_archivos = str_replace("{CODIGO_FOCO}", $listaPrograma->id_foco, $bloque_archivos);
            $bloque_archivos = str_replace("{IMAGEN_PROGRAMA}", $listaPrograma->imagen_programa, $bloque_archivos);
            $bloque_archivos = str_replace("{DESCRIPCION_PROGRAMA}", utf8_encode($listaPrograma->descripcion_programa), $bloque_archivos);
            //$bloque_archivos = str_replace("{DESCRIPTOR_NOMBRE}",utf8_encode($listaPrograma->descriptor_nombre),$bloque_archivos);
            $bloque_archivos = str_replace("{URL_PROGRAMA}", utf8_encode($listaPrograma->url_programa), $bloque_archivos);
            $bloque_archivos = str_replace("{TEMPLATE}", $plantilla, $bloque_archivos);
            $bloque_archivos = str_replace("{RESULTADO_PROGRAMA_1A7}", "-", $bloque_archivos);
            //echo "<br>".$listaPrograma->avance_malla;
            if ($listaPrograma->bbdd_host) {
                if ($contador_acumulador_bbdd > 0) {
                    $bloque_archivos = str_replace("{RESULTADO_PROGRAMA_1A7}", round(($acumulador_nota_bbdd / $contador_acumulador_bbdd), 1), $bloque_archivos);
                } else {
                    $bloque_archivos = str_replace("{RESULTADO_PROGRAMA_1A7}", "-", $bloque_archivos);
                }
            }
            if (utf8_encode($listaPrograma->avance_malla) == 100) {
                if ($listaPrograma->id_programa <> 'bci_competencias') {
                    $bloque_archivos = str_replace("{RESULTADO_PROGRAMA}", utf8_encode($listaPrograma->resultado), $bloque_archivos);
                    $bloque_archivos = str_replace("{RESULTADO_PROGRAMA_1A7}", MuestraNotaConvertidaPorEmpresa($id_empresa, utf8_encode($listaPrograma->resultado)), $bloque_archivos);
                } else {
                    $bloque_archivos = str_replace("{RESULTADO_PROGRAMA}", utf8_encode($listaPrograma->resultado), $bloque_archivos);
                    $bloque_archivos = str_replace("{RESULTADO_PROGRAMA_1A7}", "-", $bloque_archivos);
                }
                if ($listaPrograma->resultado > 0) {
                    $contador_100_porciento++;
                }
                $acumulador_100_porciento = $listaPrograma->resultado + $acumulador_100_porciento;
            } else {
                $bloque_archivos = str_replace("{RESULTADO_PROGRAMA}", utf8_encode($listaPrograma->resultado), $bloque_archivos);
                $bloque_archivos = str_replace("{RESULTADO_PROGRAMA_1A7}", MuestraNotaConvertidaPorEmpresa($id_empresa, utf8_encode($listaPrograma->resultado)), $bloque_archivos);
                if ($listaPrograma->resultado > 0) {
                    $contador_100_porciento++;
                }
                $acumulador_100_porciento = $listaPrograma->resultado + $acumulador_100_porciento;
            }
            //echo $listaPrograma->avance_malla;
            $bloque_archivos = str_replace("{RUT}", utf8_encode($rut), $bloque_archivos);
            $bloque_archivos = str_replace("{CLAVE_RUT}", substr($rut, 0, 4), $bloque_archivos);
            if ($listaPrograma->opcional === NULL) {
                $acumula_avance = $listaPrograma->avance_malla + $acumula_avance;
                //echo $listaPrograma->avance_malla;
                //echo "<br>";
                $cuenta_programas++;
            }
        }
    } else {
        $bloque_archivos = file_get_contents("views/integracion/row_lms_programa.html");
    }
    $arreglo[0]              = $bloque_archivos;
    $promedio_avance_general = round($acumula_avance / $cuenta_programas);
    $arreglo[1]              = $promedio_avance_general;
    if ($id_objeto) {
        $arreglo[2] = $nota_objeto_seleccionado;
    } else {
        $arreglo[2] = round($acumulador_100_porciento / $contador_100_porciento);
    }
    $arreglo[numcursos] = $cuenta_realizados;
    $arreglo[3] = $cuenta_programas;
    //echo "<br>".$listaPrograma->nombre_programa;//
    //echo "<br>promedio $promedio_avance_general, acuumulad avance $acumula_avance/ cuenta programas $cuenta_programas";
    return ($arreglo);
}
function lms_integracion_programas_pendientes($rut, $id_empresa, $vista, $id_programa_bbdd, $id_curso, $id_objeto)
{
    if ($vista == "opcional") {
        $filtrodata = "opcional";
    } else {
        $filtrodata = "";
    }
    $listaProgramas    = lms_integracion_lista_programas($rut, $id_empresa, $id_programa_bbdd, $filtrodata);
    $cuenta_pendientes = 0;
    array_sort_by($listaProgramas, "avance_malla", $order = SORT_ASC);
    $bloque_archivos = "";
    $cuenta          = count($listaProgramas);
    if ($cuenta > 0) {
        foreach ($listaProgramas as $listaPrograma) {
            //print_r($listaPrograma);
            $html_objetos = "";
            if ($vista == "equipo") {
                $bloque_archivos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_programa_vista_equipo.html");
            } else if ($vista == "detalle") {
                $bloque_archivos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_programa_vista_detalle.html");
            } else if ($listaPrograma->bbdd_host) {
                //Aca verifico si este usuario esta en la base y host remoto
                INTEGRACION_VerificaUsuarioEnOtraBase($rut, $listaPrograma->bbdd_host, $listaPrograma->bbdd_database, $listaPrograma->bbdd_username, $listaPrograma->bbdd_password, $listaPrograma->id_malla, $listaPrograma->id_empresa_programa);
            } else {
            }
            if ($vista == "" or $vista == "opcional") {
                if ($listaPrograma->url_programa <> '') {
                    //$bloque_archivos.=file_get_contents("views/integracion/".$id_empresa."_row_lms_programa.html");
                } else {
                    if ($listaPrograma->avance_malla <> '100') {
                        $cuenta_pendientes++;
                        $bloque_archivos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_programa_interno_pendientes.html");
                    }
                }
            }
            if ($listaPrograma->bbdd_host) {
                $link_exte = mysql_connect($listaPrograma->bbdd_host, $listaPrograma->bbdd_username, $listaPrograma->bbdd_password);
                //echo 'Conexion Exitosa Rel Malla curso Insert Malla<br>';
                mysql_select_db($listaPrograma->bbdd_database);
                if ($id_objeto) {
                    $filtro_objeto = " and tbl_objeto.id='$id_objeto' ";
                }
                if ($_GET["sw"] == "MuestraBloqueColaboradoresPorJefe" && $_SESSION["id_objeto_para_vistaequipo"]) {
                    $filtro_objeto = " and tbl_objeto.id='" . $_SESSION["id_objeto_para_vistaequipo"] . "' ";
                }
                //verifica avance avg en dicho programa
                $query_lms_reportes = "select ROUND(avg(avance)) as AvancePrograma from tbl_lms_reportes where rut='" . $listaPrograma->rut . "'";
                $result_lms_reportes = mysql_query($query_lms_reportes) or die('Consulta fallida: ' . mysql_error());
                $dATA = mysql_fetch_array($result_lms_reportes, MYSQL_ASSOC);
                if ($dATA[AvancePrograma] > $listaPrograma->avance_malla) {
                    //echo "<br>Externos ->".$listaPrograma->nombre_programa;
                    //echo "---".$dATA[AvancePrograma]." <> $listaPrograma->avance_malla";
                    GuardaDatosTablaReporte2017RutPrograma($listaPrograma->rut, $listaPrograma->id_programa);
                    $avance_temporal_array       = CalcularAvanceDatosTablaReporte2017RutPrograma($listaPrograma->rut, $listaPrograma->id_programa);
                    $listaPrograma->avance_malla = $avance_temporal_array[0]->avance;
                }
                $query_lms_trivia         = "
    select tbl_objeto.id as id_objeto, tbl_objeto.titulo as nombre_objeto, tbl_objetos_finalizados.nota,
    rel_lms_malla_curso.id_curso from rel_lms_malla_curso
    inner join tbl_objeto on tbl_objeto.id_curso=rel_lms_malla_curso.id_curso
    left join tbl_objetos_finalizados
    on tbl_objetos_finalizados.id_objeto=tbl_objeto.id and tbl_objetos_finalizados.rut='" . $listaPrograma->rut . "'
    where rel_lms_malla_curso.id_malla='" . $listaPrograma->id_malla . "' and tbl_objeto.tipo_objeto='5' $filtro_objeto ";
                //$result_lms_trivia = mysql_query($query_lms_trivia) or die('Consulta fallida: ' . mysql_error());
                $contador_acumulador_bbdd = 0;
                $nota_convertida          = "";
                $acumulador_nota_bbdd     = "";
                while ($fila_lms_trivia = mysql_fetch_array($result_lms_trivia, MYSQL_ASSOC)) {
                    $html_objetos .= file_get_contents("views/integracion/row_lms_objetos.html");
                    $html_objetos = str_replace("{OBJETO_NOMBRE}", utf8_encode($fila_lms_trivia["nombre_objeto"]), $html_objetos);
                    if (utf8_encode($fila_lms_trivia["nota"])) {
                        //$html_objetos = str_replace("{NOTA_OBJETO}",MuestraNotaConvertidaPorEmpresa($id_empresa, utf8_encode($fila_lms_trivia["nota"])),$html_objetos);
                        $nota_convertida          = MuestraNotaConvertidaPorEmpresa($id_empresa, utf8_encode($fila_lms_trivia["nota"]));
                        $html_objetos             = str_replace("{NOTA_OBJETO}", $nota_convertida, $html_objetos);
                        $nota_objeto_seleccionado = $fila_lms_trivia["nota"];
                        $acumulador_nota_bbdd     = $acumulador_nota_bbdd + $nota_convertida;
                        $contador_acumulador_bbdd++;
                        //echo $nota_convertida." ".$contador_acumulador_bbdd;
                        //echo "<br>";
                    } else {
                        $html_objetos = str_replace("{NOTA_OBJETO}", "-", $html_objetos);
                    }
                }
                //$bloque_archivos = str_replace("{ROW_LISTADO_OBJETOS_TRIVIAS}",$html_objetos,$bloque_archivos);
                $bloque_archivos = str_replace("{ROW_LISTADO_OBJETOS_TRIVIAS}", "", $bloque_archivos);
            } else {
                $avanceProgramaArrCursos = BuscaAvgCierreCurso($listaPrograma->id_malla, $id_empresa, $listaPrograma->rut);
                //print_r($avanceProgramaArrCursos);
                $sumaavancecursos        = 0;
                $cuentaavancecursos      = 0;
                foreach ($avanceProgramaArrCursos as $avanceProgramaArrCurso) {
                    $sumaavancecursos = $sumaavancecursos + $avanceProgramaArrCurso->avance;
                    $cuentaavancecursos++;
                }
                if ($cuentaavancecursos > 0) {
                    $avanceProgramaArrInscripcionCierre = round($sumaavancecursos / $cuentaavancecursos);
                } else {
                    $avanceProgramaArrInscripcionCierre = 0;
                }
                //cho "<br>";
                //echo "<br><br><br>hay dif Internos ->".$listaPrograma->nombre_programa."<br>".$avanceProgramaArr[0]->avancePrograma.", avance ".$listaPrograma->avance_malla." - ".$avanceProgramaArrInscripcionCierre;
                if ($avanceProgramaArrInscripcionCierre <> $listaPrograma->avance_malla) {
                    //echo "<br>hay dif Internos 2 ->".$listaPrograma->nombre_programa."<br>".$avanceProgramaArr[0]->avancePrograma." avance ".$listaPrograma->avance_malla;
                    //print_r($listaPrograma);
                    GuardaDatosTablaReporte2017RutPrograma($listaPrograma->rut, $listaPrograma->id_programa);
                    $avance_temporal_array       = CalcularAvanceDatosTablaReporte2017RutPrograma($listaPrograma->rut, $listaPrograma->id_programa);
                    $listaPrograma->avance_malla = $avance_temporal_array[0]->avance;
                }
                $objetos = TraigoObjetosDadoRutYMalla($listaPrograma->rut, $listaPrograma->id_malla, $id_objeto);
                foreach ($objetos as $obj) {
                    //print_r($obj); exit();
                    if ($obj->extension_objeto == 23) {
                        $html_objetos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_objetos_desafios.html");
                        $verifica_accion_pendiente = VerificaDesafioEnAccionesPendientes($rut, $id_empresa, $obj->id_curso, $obj->id_objeto);
                        if ($verifica_accion_pendiente[0]->estado === "0") {
                            //pendiente de validacion
                            $html_objetos = str_replace("{ICONO_ESTADO_DESAFIO}", "<img src='img/lms_icons_enproceso.png' width='20px'>", $html_objetos);
                            $html_objetos = str_replace("{VER_DESAFIO}", '<a href="?sw=contenido&i={ID_OBJETO_ENCODEADO}&rc={RUT_COLABORADOR_ENCODEADO}&checkin=1">Ver Desafio</a>', $html_objetos);
                        } else if ($verifica_accion_pendiente[0]->estado === "1") {
                            //Validado
                            $html_objetos = str_replace("{ICONO_ESTADO_DESAFIO}", "<img src='img/lms_icons_aprobado.jpg' width='20px'>", $html_objetos);
                            $html_objetos = str_replace("{VER_DESAFIO}", '<a href="?sw=contenido&i={ID_OBJETO_ENCODEADO}&rc={RUT_COLABORADOR_ENCODEADO}&checkin=1">Ver Desafio</a>', $html_objetos);
                        } else if (count($verifica_accion_pendiente) < 1) {
                            //No se a enviado a validar
                            $html_objetos = str_replace("{ICONO_ESTADO_DESAFIO}", "<img src='img/lms_icons_noiniciado.jpg' width='20px'>", $html_objetos);
                            $html_objetos = str_replace("{VER_DESAFIO}", '', $html_objetos);
                        }
                    } else {
                        $html_objetos .= file_get_contents("views/integracion/" . $id_empresa . "_row_lms_objetos.html");
                    }
                    //VerificaDesafioEnAccionesPendientes($rut_colaborador, $id_empresa, $id_curso, $id_objeto);
                    $html_objetos                = str_replace("{ID_OBJETO_ENCODEADO}", Encodear3($obj->id_objeto), $html_objetos);
                    $html_objetos                = str_replace("{ID_CURSO_ENCODEADO}", Encodear3($obj->id_curso), $html_objetos);
                    $html_objetos                = str_replace("{RUT_COLABORADOR_ENCODEADO}", Encodear3($rut), $html_objetos);
                    $html_objetos                = str_replace("{OBJETO_NOMBRE}", utf8_encode($obj->nombre_objeto), $html_objetos);
                    $html_objetos                = str_replace("{NOTA_OBJETO}", utf8_encode($obj->nota), $html_objetos);
                    $html_objetos                = str_replace("{NOTA_OBJETO_1A7}", ColocaNotaConvertidaTrivia(utf8_encode($obj->nota)), $html_objetos);
                    $html_objetos                = str_replace("{ID_OBJETO_SLIDE}", $obj->id_objeto . $listaPrograma->rut, $html_objetos);
                    $listado_preguntas_De_Trivia = MuestraInformeIndividualDesdeVistaJefe($listaPrograma->rut, $obj->id_objeto);
                    $html_objetos                = str_replace("{LISTADO_PREGUINTAS_DE_TRIVIA}", $listado_preguntas_De_Trivia, $html_objetos);
                    //echo ColocaNotaConvertidaTrivia(utf8_encode($obj->nota))."<br>";
                    $nota_objeto_seleccionado    = (utf8_encode($obj->nota));
                }
                //echo "aca";
                //echo $html_objetos;
                $bloque_archivos = str_replace("{ROW_LISTADO_OBJETOS_TRIVIAS}", $html_objetos, $bloque_archivos);
                $bloque_archivos = str_replace("{ROW_LISTADO_OBJETOS_TRIVIASV2}", $html_objetos, $bloque_archivos);
            }
            $template = $listaPrograma->template;
            if ($template <> '') {
                $plantilla = $template;
            } else {
                $plantilla = "malla3";
            }
            /*
            echo "<br>".$listaPrograma->nombre_programa;
            echo "<br>".$avanceProgramaArrCursos[0]->certificacion;
            echo "<br>".$avanceProgramaArrCursos[0]->estadodescripcion;
            */
            if ($avanceProgramaArrCursos[0]->certificacion == 1) {
                $bloque_archivos = str_replace("{PROGRAMA_NOMBRE}", utf8_encode($listaPrograma->nombre_programa), $bloque_archivos);
                if ($avanceProgramaArrCursos[0]->estadodescripcion == "Aprueba" or $avanceProgramaArrCursos[0]->estadodescripcion == "APROBADO") {
                    $labelcolor = "success";
                }
                if ($avanceProgramaArrCursos[0]->estadodescripcion == "Reprueba" or $avanceProgramaArrCursos[0]->estadodescripcion == "REPROBADO") {
                    $labelcolor = "danger";
                }
                $RESULTADO_cert  = " <span class='label label-" . $labelcolor . "'><span class='blanco'>" . $avanceProgramaArrCursos[0]->nota . "% " . $avanceProgramaArrCursos[0]->estadodescripcion . "</span></span>";
                $bloque_archivos = str_replace("{RESULTADO_FINAL}", "", $bloque_archivos);
                $bloque_archivos = str_replace("{AVANCE_PROGRAMA}", $avanceProgramaArrCursos[0]->nota, $bloque_archivos);
            } else {
                $bloque_archivos = str_replace("{PROGRAMA_NOMBRE}", utf8_encode($listaPrograma->nombre_programa), $bloque_archivos);
                $bloque_archivos = str_replace("{RESULTADO_FINAL}", "", $bloque_archivos);
                if (utf8_encode($listaPrograma->avance_malla)) {
                    $bloque_archivos = str_replace("{AVANCE_PROGRAMA}", utf8_encode(round($listaPrograma->avance_malla)), $bloque_archivos);
                } else {
                    $bloque_archivos = str_replace("{AVANCE_PROGRAMA}", "0", $bloque_archivos);
                }
            }
            $bloque_archivos = str_replace("{ID_PROGRAMA_SLIDE}", $listaPrograma->id_programa . $listaPrograma->rut, $bloque_archivos);
            $bloque_archivos = str_replace("{ID_MALLA}", utf8_encode($listaPrograma->id_malla), $bloque_archivos);
            $bloque_archivos = str_replace("{ID_MALLA_ENCODEADO}", Encodear3($listaPrograma->id_malla), $bloque_archivos);
            $bloque_archivos = str_replace("{FOCO_PROGRAMA}", $listaPrograma->foco, $bloque_archivos);
            $bloque_archivos = str_replace("{ID_FOCO}", $listaPrograma->id_foco, $bloque_archivos);
            $bloque_archivos = str_replace("{CODIGO_FOCO}", $listaPrograma->id_foco, $bloque_archivos);
            $bloque_archivos = str_replace("{IMAGEN_PROGRAMA}", $listaPrograma->imagen_programa, $bloque_archivos);
            $bloque_archivos = str_replace("{DESCRIPCION_PROGRAMA}", utf8_encode($listaPrograma->descripcion_programa), $bloque_archivos);
            //$bloque_archivos = str_replace("{DESCRIPTOR_NOMBRE}",utf8_encode($listaPrograma->descriptor_nombre),$bloque_archivos);
            $bloque_archivos = str_replace("{URL_PROGRAMA}", utf8_encode($listaPrograma->url_programa), $bloque_archivos);
            $bloque_archivos = str_replace("{TEMPLATE}", $plantilla, $bloque_archivos);
            $bloque_archivos = str_replace("{RESULTADO_PROGRAMA_1A7}", "-", $bloque_archivos);
            //echo "<br>".$listaPrograma->avance_malla;
            if ($listaPrograma->bbdd_host) {
                if ($contador_acumulador_bbdd > 0) {
                    $bloque_archivos = str_replace("{RESULTADO_PROGRAMA_1A7}", round(($acumulador_nota_bbdd / $contador_acumulador_bbdd), 1), $bloque_archivos);
                } else {
                    $bloque_archivos = str_replace("{RESULTADO_PROGRAMA_1A7}", "-", $bloque_archivos);
                }
            }
            if (utf8_encode($listaPrograma->avance_malla) == 100) {
                if ($listaPrograma->id_programa <> 'bci_competencias') {
                    $bloque_archivos = str_replace("{RESULTADO_PROGRAMA}", utf8_encode($listaPrograma->resultado), $bloque_archivos);
                    $bloque_archivos = str_replace("{RESULTADO_PROGRAMA_1A7}", MuestraNotaConvertidaPorEmpresa($id_empresa, utf8_encode($listaPrograma->resultado)), $bloque_archivos);
                } else {
                    $bloque_archivos = str_replace("{RESULTADO_PROGRAMA}", utf8_encode($listaPrograma->resultado), $bloque_archivos);
                    $bloque_archivos = str_replace("{RESULTADO_PROGRAMA_1A7}", "-", $bloque_archivos);
                }
                if ($listaPrograma->resultado > 0) {
                    $contador_100_porciento++;
                }
                $acumulador_100_porciento = $listaPrograma->resultado + $acumulador_100_porciento;
            } else {
                $bloque_archivos = str_replace("{RESULTADO_PROGRAMA}", utf8_encode($listaPrograma->resultado), $bloque_archivos);
                $bloque_archivos = str_replace("{RESULTADO_PROGRAMA_1A7}", MuestraNotaConvertidaPorEmpresa($id_empresa, utf8_encode($listaPrograma->resultado)), $bloque_archivos);
                if ($listaPrograma->resultado > 0) {
                    $contador_100_porciento++;
                }
                $acumulador_100_porciento = $listaPrograma->resultado + $acumulador_100_porciento;
            }
            //echo $listaPrograma->avance_malla;
            $bloque_archivos = str_replace("{RUT}", utf8_encode($rut), $bloque_archivos);
            $bloque_archivos = str_replace("{CLAVE_RUT}", substr($rut, 0, 4), $bloque_archivos);
            if ($listaPrograma->opcional === NULL) {
                $acumula_avance = $listaPrograma->avance_malla + $acumula_avance;
                //echo $listaPrograma->avance_malla;
                //echo "<br>";
                $cuenta_programas++;
            }
        }
    } else {
        $bloque_archivos = file_get_contents("views/integracion/row_lms_programa.html");
    }
    $arreglo[0]              = $bloque_archivos;
    $promedio_avance_general = round($acumula_avance / $cuenta_programas);
    $arreglo[1]              = $promedio_avance_general;
    if ($id_objeto) {
        $arreglo[2] = $nota_objeto_seleccionado;
    } else {
        $arreglo[2] = round($acumulador_100_porciento / $contador_100_porciento);
    }
    $arreglo[numcursos] = $cuenta_pendientes;

    $arreglo[3] = $cuenta_programas;
    //echo "<br>".$listaPrograma->nombre_programa;//
    //echo "<br>promedio $promedio_avance_general, acuumulad avance $acumula_avance/ cuenta programas $cuenta_programas";
    return ($arreglo);
}
function lms_integracion_programasBK($rut, $id_empresa, $vista)
{
    if ($vista == "detalle") {
        ActualizaTablatblLmsReportePorRut($rut);
    }
    $listaProgramas  = lms_integracion_lista_programas($rut, $id_empresa);
    $bloque_archivos = "";
    $cuenta          = count($listaProgramas);
    //print_r($listaProgramas);
    if ($cuenta > 0) {
        foreach ($listaProgramas as $listaPrograma) {
            $html_objetos = "";
            if ($vista == "equipo") {
                $bloque_archivos .= file_get_contents("views/integracion/row_lms_programa_vista_equipo.html");
            } else if ($vista == "detalle") {
                $bloque_archivos .= file_get_contents("views/integracion/row_lms_programa_vista_detalle.html");
            } else if ($listaPrograma->bbdd_host) {
                //Aca verifico si este usuario esta en la base y host remoto
                INTEGRACION_VerificaUsuarioEnOtraBase($rut, $listaPrograma->bbdd_host, $listaPrograma->bbdd_database, $listaPrograma->bbdd_username, $listaPrograma->bbdd_password, $listaPrograma->id_malla, $listaPrograma->id_empresa_programa);
                $bloque_archivos .= file_get_contents("views/integracion/row_lms_programa.html");
            } else {
                $bloque_archivos .= file_get_contents("views/integracion/row_lms_programa_interno.html");
            }
            if ($listaPrograma->bbdd_host) {
                $link_exte = mysql_connect($listaPrograma->bbdd_host, $listaPrograma->bbdd_username, $listaPrograma->bbdd_password);
                //echo 'Conexion Exitosa Rel Malla curso Insert Malla<br>';
                mysql_select_db($listaPrograma->bbdd_database);
                $query_lms_trivia = "
    select tbl_objeto.id as id_objeto, tbl_objeto.titulo as nombre_objeto, tbl_objetos_finalizados.nota,
    rel_lms_malla_curso.id_curso from rel_lms_malla_curso
    inner join tbl_objeto on tbl_objeto.id_curso=rel_lms_malla_curso.id_curso
    left join tbl_objetos_finalizados
    on tbl_objetos_finalizados.id_objeto=tbl_objeto.id and tbl_objetos_finalizados.rut='" . $listaPrograma->rut . "'
    where rel_lms_malla_curso.id_malla='" . $listaPrograma->id_malla . "' and tbl_objeto.tipo_objeto='5'";
                $result_lms_trivia = mysql_query($query_lms_trivia) or die('Consulta fallida: ' . mysql_error());
                while ($fila_lms_trivia = mysql_fetch_array($result_lms_trivia, MYSQL_ASSOC)) {
                    $html_objetos .= file_get_contents("views/integracion/row_lms_objetos.html");
                    $html_objetos = str_replace("{OBJETO_NOMBRE}", utf8_encode($fila_lms_trivia["nombre_objeto"]), $html_objetos);
                    if (utf8_encode($fila_lms_trivia["nota"])) {
                        $html_objetos = str_replace("{NOTA_OBJETO}", MuestraNotaConvertidaPorEmpresa($id_empresa, utf8_encode($fila_lms_trivia["nota"])), $html_objetos);
                    } else {
                        $html_objetos = str_replace("{NOTA_OBJETO}", "-", $html_objetos);
                    }
                }
                $bloque_archivos = str_replace("{ROW_LISTADO_OBJETOS_TRIVIAS}", $html_objetos, $bloque_archivos);
            } else {
                $objetos = TraigoObjetosDadoRutYMalla($listaPrograma->rut, $listaPrograma->id_malla);
                foreach ($objetos as $obj) {
                    $html_objetos .= file_get_contents("views/integracion/row_lms_objetos.html");
                    $html_objetos = str_replace("{OBJETO_NOMBRE}", utf8_encode($obj->nombre_objeto), $html_objetos);
                    if (utf8_encode($obj->nota)) {
                        $html_objetos = str_replace("{NOTA_OBJETO}", MuestraNotaConvertidaPorEmpresa($id_empresa, utf8_encode(utf8_encode($obj->nota))), $html_objetos);
                    } else {
                        $html_objetos = str_replace("{NOTA_OBJETO}", "-", $html_objetos);
                    }
                }
                $bloque_archivos = str_replace("{ROW_LISTADO_OBJETOS_TRIVIAS}", $html_objetos, $bloque_archivos);
            }
            $template = $listaPrograma->template;
            if ($template <> '') {
                $plantilla = $template;
            } else {
                $plantilla = "malla3";
            }
            $bloque_archivos = str_replace("{PROGRAMA_NOMBRE}", utf8_encode($listaPrograma->nombre_programa), $bloque_archivos);
            $bloque_archivos = str_replace("{ID_MALLA}", utf8_encode($listaPrograma->id_malla), $bloque_archivos);
            $bloque_archivos = str_replace("{ID_MALLA_ENCODEADO}", Encodear3($listaPrograma->id_malla), $bloque_archivos);
            $bloque_archivos = str_replace("{FOCO_PROGRAMA}", $listaPrograma->foco, $bloque_archivos);
            $bloque_archivos = str_replace("{ID_FOCO}", $listaPrograma->id_foco, $bloque_archivos);
            $bloque_archivos = str_replace("{CODIGO_FOCO}", $listaPrograma->id_foco, $bloque_archivos);
            $bloque_archivos = str_replace("{IMAGEN_PROGRAMA}", $listaPrograma->imagen_programa, $bloque_archivos);
            $bloque_archivos = str_replace("{DESCRIPCION_PROGRAMA}", utf8_encode($listaPrograma->descripcion_programa), $bloque_archivos);
            //$bloque_archivos = str_replace("{DESCRIPTOR_NOMBRE}",utf8_encode($listaPrograma->descriptor_nombre),$bloque_archivos);
            $bloque_archivos = str_replace("{URL_PROGRAMA}", utf8_encode($listaPrograma->url_programa), $bloque_archivos);
            $bloque_archivos = str_replace("{TEMPLATE}", $plantilla, $bloque_archivos);
            if (utf8_encode($listaPrograma->avance_malla)) {
                $bloque_archivos = str_replace("{AVANCE_PROGRAMA}", utf8_encode($listaPrograma->avance_malla), $bloque_archivos);
            } else {
                $bloque_archivos = str_replace("{AVANCE_PROGRAMA}", "0", $bloque_archivos);
            }
            if (utf8_encode($listaPrograma->avance_malla) == 100) {
                $bloque_archivos = str_replace("{RESULTADO_PROGRAMA}", utf8_encode($listaPrograma->resultado), $bloque_archivos);
                if ($listaPrograma->resultado > 0) {
                    $contador_100_porciento++;
                }
                $acumulador_100_porciento = $listaPrograma->resultado + $acumulador_100_porciento;
            } else {
                $bloque_archivos = str_replace("{RESULTADO_PROGRAMA}", utf8_encode($listaPrograma->resultado), $bloque_archivos);
                if ($listaPrograma->resultado > 0) {
                    $contador_100_porciento++;
                }
                $acumulador_100_porciento = $listaPrograma->resultado + $acumulador_100_porciento;
            }
            //echo $listaPrograma->avance_malla;
            $bloque_archivos = str_replace("{RUT}", utf8_encode($rut), $bloque_archivos);
            $bloque_archivos = str_replace("{CLAVE_RUT}", substr($rut, 0, 4), $bloque_archivos);
            $acumula_avance  = $listaPrograma->avance_malla + $acumula_avance;
            $cuenta_programas++;
        }
    } else {
        $bloque_archivos = file_get_contents("views/integracion/row_lms_programa.html");
    }
    $arreglo[0]              = $bloque_archivos;
    $promedio_avance_general = round($acumula_avance / $cuenta_programas);
    $arreglo[1]              = $promedio_avance_general;
    $arreglo[2]              = round($acumulador_100_porciento / $contador_100_porciento);
    //echo "promedio $promedio_avance_general, acuumulad avance $acumula_avance/ cuenta programas $cuenta_programas";
    return ($arreglo);
}
function mes_3letras($mes)
{
    if ($mes == 1) {
        $mestxt = "ENE";
    }
    if ($mes == 2) {
        $mestxt = "FEB";
    }
    if ($mes == 3) {
        $mestxt = "MAR";
    }
    if ($mes == 4) {
        $mestxt = "ABR";
    }
    if ($mes == 5) {
        $mestxt = "MAY";
    }
    if ($mes == 6) {
        $mestxt = "JUN";
    }
    if ($mes == 7) {
        $mestxt = "JUL";
    }
    if ($mes == 8) {
        $mestxt = "AGO";
    }
    if ($mes == 9) {
        $mestxt = "SEP";
    }
    if ($mes == 10) {
        $mestxt = "OCT";
    }
    if ($mes == 11) {
        $mestxt = "NOV";
    }
    if ($mes == 12) {
        $mestxt = "DIC";
    }
    return $mestxt;
}
function ListaCursoPostulantes($rut, $id_empresa)
{
    //$ListaCursos=ListaCursosDisponibleYDatos($rut, $id_empresa);
    $ListaCursos   = ListaCursosDisponiblePostulante($rut, $id_empresa);
    //print_r($ListaCursos);
    $row           = "";
    $ok_finalizado = 0;
    foreach ($ListaCursos as $ListaCurso) {
        $id_curso           = $ListaCurso->id;
        $fecha_inicio       = $ListaCurso->fecha_inicio;
        $fecha_termino      = $ListaCurso->fecha_termino;
        $hoy                = date("Y-m-d");
        //echo     "<br>curso $ListaCurso->nombre<br>$hoy - $fecha_inicio - $fecha_termino";
        $diferencia         = -1 * ((strtotime($hoy) - strtotime($fecha_inicio)) / 86400);
        $diferencia_termino = -1 * ((strtotime($hoy) - strtotime($fecha_termino)) / 86400);
        //echo " . diferencia $diferencia, $diferencia_termino";
        $quedan             = ROUND($diferencia_termino - 1);
        if ($diferencia_termino <= 0) {
            continue;
        }
        $row_evento .= file_get_contents("views/evento/row_evento_curso.html");
        $row_evento         = str_replace("{ID}", utf8_encode($ListaCurso->id_curso), $row_evento);
        $row_evento         = str_replace("{NOMBRE_CURSO}", utf8_encode($ListaCurso->nombre), $row_evento);
        $row_evento         = str_replace("{IMAGEN_CURSO}", $ListaCurso->imagen, $row_evento);
        $row_evento         = str_replace("{DESCRIPCION}", utf8_encode($ListaCurso->descripcion), $row_evento);
        $row_evento         = str_replace("{DESCRIPTOR}", utf8_encode($ListaCurso->descriptor), $row_evento);
        $row_evento         = str_replace("{ACERCADE}", utf8_encode($ListaCurso->acercade), $row_evento);
        $row_evento         = str_replace("{OBJETIVO_CURSO}", utf8_encode($ListaCurso->objetivo_curso), $row_evento);
        $row_evento         = str_replace("{DIAS_RESTANTES_PARA_POSTULAR}", utf8_encode($quedan), $row_evento);
        $ListaInscripciones = ListaInscripcionesDisponibleYDatos($ListaCurso->id_curso, $id_empresa);
        //echo "<pre>";
        //print_r($ListaInscripciones);
        foreach ($ListaInscripciones as $ListaInscripcion) {
            $fecha_inicio           = $ListaInscripcion->fecha_inicio;
            $dia                    = date('d', strtotime($ListaInscripcion->fecha_inicio));
            $mes                    = date('m', strtotime($ListaInscripcion->fecha_inicio));
            $fecha_imp_inicio       = $ListaInscripcion->fecha_inicio;
            $fecha_imp_termino      = $ListaInscripcion->fecha_termino;
            $hoy                    = date("Y-m-d");
            //echo     "<br>curso $ListaCurso->nombre<br>$hoy - $fecha_imp_inicio - $fecha_imp_termino";
            $diferencia_IMP_Termino = -1 * ((strtotime($hoy) - strtotime($fecha_imp_inicio)) / 86400);
            $quedan                 = ROUND($diferencia_IMP_Termino - 1);
            $mestxt                 = mes_3letras($mes);
            $num_inscritos          = $ListaInscripcion->Inscritos;
            $num_preinscritos       = $ListaInscripcion->Preinscritos;
            $num_listaespera        = $ListaInscripcion->ListaEspera;
            if ($diferencia_IMP_Termino <= 1 and $num_listaespera <= 0) {
                continue;
            }
            $row_evento .= file_get_contents("views/evento/row_evento_inscripcion.html");
            $cupos_inscritos   = $num_inscritos + $num_preinscritos;
            $cupos_espera      = $num_listaespera;
            $cupos_disponibles = $ListaInscripcion->cupos - $cupos_inscritos;
            //echo "$cupos_inscritos $cupos_espera $cupos_disponibles aca ";
            //echo $cupos_espera;
            if ($cupos_disponibles <= 0) {
                $cupos_disponibles = 0;
            }
            if ($cupos_disponibles > 0) {
                $texto_inscripcion = "<i class='icon-user'></i> $cupos_disponibles Cupos Disponibles de " . $ListaInscripcion->cupos;
                $link_icono        = '<i class="fas fa-check-square"></i>';
                $label             = "label-success";
                $boton_llamada     = "btn btn-success";
                $texto_llamada     = "Postular";
            }
            if ($cupos_disponibles <= 0) {
                $texto_inscripcion = "No hay Cupos, S?lo lista Espera";
                $link_icono        = '<i class="icon-calendar-empty"></i>';
                $label             = "label-warning";
                $boton_llamada     = "btn btn-warning";
                $texto_llamada     = "Dejarme en Lista de Espera";
            }
            $row_evento   = str_replace("{DIA}", $dia, $row_evento);
            $row_evento   = str_replace("{MES}", $mestxt, $row_evento);
            $row_evento   = str_replace("{CUPOS}", $ListaInscripcion->cupos, $row_evento);
            $row_evento   = str_replace("{HORARIO}", utf8_encode($ListaInscripcion->comentarios), $row_evento);
            $row_evento   = str_replace("{CUPOSINSCRIPCIONES}", $cupos_inscritos, $row_evento);
            $row_evento   = str_replace("{CUPOSDISPONIBLES}", $cupos_disponibles, $row_evento);
            $estainscrito = InscripcionRutCursoLms($rut, $ListaInscripcion->codigo_inscripcion, $id_empresa);
            //echo "<br>".$estainscrito[0]->id;
            if ($estainscrito[0]->id > 0) {
                $row_evento = str_replace("{LINK_INSCRIPCION}", "#", $row_evento);
                if ($cupos_disponibles > 0) {
                    $texto_inscripcion = "<i class='icon-user'></i> $cupos_disponibles Cupos Disponibles de " . $ListaInscripcion->cupos;
                    $link_icono        = '<i class="icon-time"></i>';
                    $label             = "label-success";
                    $boton_llamada     = "btn btn-info";
                    $texto_llamada     = "<small>Pre-Inscrito</small>";
                }
                if ($cupos_disponibles <= 0) {
                    $texto_inscripcion = "No hay Cupos, S?lo lista Espera";
                    $link_icono        = '<i class="icon-calendar-empty"></i>';
                    $label             = "label-warning";
                    $boton_llamada     = "btn btn-info";
                    $texto_llamada     = "Pre-Inscrito en Lista de Espera";
                }
                $row_evento = str_replace("{LABEL_INSCRIPCION}", $label, $row_evento);
                $row_evento = str_replace("{TEXTO_INSCRIPCION}", $texto_inscripcion, $row_evento);
            } elseif ($estainscrito[0]->estadoinscripcion == "LISTAESPERA") {
                $row_evento = str_replace("{LINK_INSCRIPCION}", "#", $row_evento);
                if ($cupos_disponibles > 0) {
                    $texto_inscripcion = "<i class='icon-user'></i> $cupos_disponibles Cupos Disponibles de " . $ListaInscripcion->cupos;
                    $link_icono        = '<i class="icon-time"></i>';
                    $label             = "label-success";
                    $boton_llamada     = "btn btn-info";
                    $texto_llamada     = "<small>Pre-Inscrito, falta validacion de Jefe</small>";
                }
                if ($cupos_disponibles <= 0) {
                    $texto_inscripcion = "No hay Cupos, S?lo lista Espera";
                    $link_icono        = '<i class="icon-calendar-empty"></i>';
                    $label             = "label-warning";
                    $boton_llamada     = "btn btn-info";
                    $texto_llamada     = "Pre-Inscrito en Lista de Espera";
                }
                $row_evento = str_replace("{LABEL_INSCRIPCION}", $label, $row_evento);
                $row_evento = str_replace("{TEXTO_INSCRIPCION}", $texto_inscripcion, $row_evento);
            } elseif ($estainscrito[0]->estadoinscripcion == "INSCRITO") {
                $row_evento        = str_replace("{LINK_INSCRIPCION}", "#", $row_evento);
                $link_icono        = '<i class="icon-calendar-empty"></i>';
                $texto_inscripcion = "<i class='icon-user'></i> $cupos_disponibles Cupos Disponibles de " . $ListaInscripcion->cupos;
                $link_icono        = '<i class="icon-ok-sign"></i>';
                $label             = "label-success";
                $boton_llamada     = "label label_inscripcion label-success";
                $texto_llamada     = "?Curso Inscrito!";
                $row_evento        = str_replace("{LABEL_INSCRIPCION}", $label, $row_evento);
                $row_evento        = str_replace("{TEXTO_INSCRIPCION}", $texto_inscripcion, $row_evento);
            } elseif ($estainscrito[0]->estadoinscripcion == "RECHAZADO") {
                $row_evento        = str_replace("{LINK_INSCRIPCION}", "#", $row_evento);
                $texto_inscripcion = "<i class='icon-user'></i> $cupos_disponibles Cupos Disponibles de " . $ListaInscripcion->cupos;
                $link_icono        = '<i class="icon-remove-sign"></i>';
                $label             = "label-success";
                $boton_llamada     = "label label_inscripcion label-danger";
                $texto_llamada     = "Solicitud Rechazada...";
                $row_evento        = str_replace("{LABEL_INSCRIPCION}", $label, $row_evento);
                $row_evento        = str_replace("{TEXTO_INSCRIPCION}", $texto_inscripcion, $row_evento);
            } elseif ($estainscrito[0]->estadoinscripcion == "") {
                //echo "vacio";
                $row_evento = str_replace("{LABEL_INSCRIPCION}", $label, $row_evento);
                $row_evento = str_replace("{TEXTO_INSCRIPCION}", $texto_inscripcion, $row_evento);
                $row_evento = str_replace("{LINK_INSCRIPCION}", "?sw=saveInscripcionCursosSinValidacion&idc=" . $ListaInscripcion->codigo_inscripcion . "&idm=" . $id_malla . "", $row_evento);
            }
            $row_evento   = str_replace("{LINK_ICONO}", $link_icono, $row_evento);
            $row_evento   = str_replace("{LINK_LLAMADA}", $texto_llamada, $row_evento);
            $row_evento   = str_replace("{LINK_MODAL_CURSO}", $cupos_inscritos, $row_evento);
            $row_evento   = str_replace("{BOTON_LLAMADA}", $boton_llamada, $row_evento);
            $row_evento   = str_replace("{HORAINICIO}", $ListaInscripcion->horainicio, $row_evento);
            $row_evento   = str_replace("{HORATERMINADA}", $ListaInscripcion->horatermino, $row_evento);
            $row_evento   = str_replace("{DIRECCION}", utf8_encode($ListaInscripcion->direccion), $row_evento);
            //Trae Sesiones por cada Imparticion
            $sesiones     = TraeTotalDESesionesPorImparticion($id_empresa, $ListaInscripcion->codigo_inscripcion);
            $row_sesiones = "";
            $i            = 1;
            foreach ($sesiones as $ses) {
                $row_sesiones .= file_get_contents("views/evento/row_evento_inscripcion_sesion.html");
                $row_sesiones = str_replace("{NUMERO}", $i, $row_sesiones);
                $row_sesiones = str_replace("{FECHAS}", utf8_encode($ses->fecha), $row_sesiones);
                if ($ses->desde_am == "00:00:00" && $ses->hasta_am == "00:00:00") {
                    $row_sesiones = str_replace("{HORAS}", utf8_encode($ses->desde_pm . " " . $ses->hasta_pm), $row_sesiones);
                } else if ($ses->desde_pm == "00:00:00" && $ses->hasta_pm == "00:00:00") {
                    $row_sesiones = str_replace("{HORAS}", utf8_encode($ses->desde_am . " " . $ses->hasta_am), $row_sesiones);
                } else {
                    $row_sesiones = str_replace("{HORAS}", utf8_encode($ses->desde_am . " " . $ses->hasta_am . " " . $ses->desde_pm . " " . $ses->hasta_pm), $row_sesiones);
                }
                $i++;
            }
            $row_evento = str_replace("{ROW_SESIONES}", utf8_encode($row_sesiones), $row_evento);
        }
    }
    //$row_evento = str_replace("{ROW_CURSOS_DISPONIBLES_ORDENADOS}", $row_evento, $PRINCIPAL);
    return $row_evento;
}
function ListaCursoInscripcionMalla($rut, $id_malla, $id_empresa)
{
    //$ListaCursos=ListaCursosDisponibleYDatos($rut, $id_empresa);
    $ListaCursos   = ListaCursosDisponibleAgrupadosMalla($id_malla, $id_empresa);
    $row           = "";
    $ok_finalizado = 0;
    foreach ($ListaCursos as $ListaCurso) {
        $id_curso = $ListaCurso->id;
        $row_evento .= file_get_contents("views/evento/row_evento_curso.html");
        $row_evento         = str_replace("{ID}", utf8_encode($ListaCurso->id), $row_evento);
        $row_evento         = str_replace("{NOMBRE_CURSO}", utf8_encode($ListaCurso->nombre), $row_evento);
        $row_evento         = str_replace("{IMAGEN_CURSO}", $ListaCurso->imagen, $row_evento);
        $row_evento         = str_replace("{DESCRIPCION}", utf8_encode($ListaCurso->descripcion), $row_evento);
        $row_evento         = str_replace("{DESCRIPTOR}", utf8_encode($ListaCurso->descriptor), $row_evento);
        $row_evento         = str_replace("{ACERCADE}", utf8_encode($ListaCurso->acercade), $row_evento);
        $row_evento         = str_replace("{OBJETIVO_CURSO}", utf8_encode($ListaCurso->objetivo_curso), $row_evento);
        $ListaInscripciones = ListaInscripcionesDisponibleYDatos($id_curso, $id_empresa);
        //print_r($ListaInscripciones);
        foreach ($ListaInscripciones as $ListaInscripcion) {
            $row_evento .= file_get_contents("views/evento/row_evento_inscripcion.html");
            $fecha_inicio      = $ListaInscripcion->fecha_inicio;
            $dia               = date('d', strtotime($ListaInscripcion->fecha_inicio));
            $mes               = date('m', strtotime($ListaInscripcion->fecha_inicio));
            $mestxt            = mes_3letras($mes);
            $num_inscritos     = $ListaInscripcion->Inscritos;
            $num_preinscritos  = $ListaInscripcion->Preinscritos;
            $num_listaespera   = $ListaInscripcion->ListaEspera;
            $cupos_inscritos   = $num_inscritos + $num_preinscritos;
            $cupos_espera      = $num_listaespera;
            $cupos_disponibles = $ListaInscripcion->cupos - $cupos_inscritos;
            if ($cupos_disponibles <= 0) {
                $cupos_disponibles = 0;
            }
            if ($cupos_disponibles > 0) {
                $texto_inscripcion = "<i class='icon-user'></i> $cupos_disponibles Cupos Disponibles de " . $ListaInscripcion->cupos;
                $link_icono        = '<i class="fas fa-check-square"></i>';
                $label             = "label-success";
                $boton_llamada     = "btn btn-success";
                $texto_llamada     = "Postular";
            }
            if ($cupos_disponibles <= 0) {
                $texto_inscripcion = "No hay Cupos, S?lo lista Espera";
                $link_icono        = '<i class="icon-calendar-empty"></i>';
                $label             = "label-warning";
                $boton_llamada     = "btn btn-warning";
                $texto_llamada     = "Dejarme en Lista de Espera";
            }
            $row_evento   = str_replace("{DIA}", $dia, $row_evento);
            $row_evento   = str_replace("{MES}", $mestxt, $row_evento);
            $row_evento   = str_replace("{CUPOS}", $ListaInscripcion->cupos, $row_evento);
            $row_evento   = str_replace("{HORARIO}", $ListaInscripcion->comentarios, $row_evento);
            $row_evento   = str_replace("{CUPOSINSCRIPCIONES}", $cupos_inscritos, $row_evento);
            $row_evento   = str_replace("{CUPOSDISPONIBLES}", $cupos_disponibles, $row_evento);
            $estainscrito = InscripcionRutCursoLms($rut, $ListaInscripcion->codigo_inscripcion, $id_empresa);
            //echo "<br>".$estainscrito[0]->estadoinscripcion;
            if ($estainscrito[0]->estadoinscripcion == "PREINSCRITO") {
                $row_evento = str_replace("{LINK_INSCRIPCION}", "#", $row_evento);
                if ($cupos_disponibles > 0) {
                    $texto_inscripcion = "<i class='icon-user'></i> $cupos_disponibles Cupos Disponibles de " . $ListaInscripcion->cupos;
                    $link_icono        = '<i class="icon-time"></i>';
                    $label             = "label-success";
                    $boton_llamada     = "btn btn-info";
                    $texto_llamada     = "<small>Pre-Inscrito, falta validacion de Jefe</small>";
                }
                if ($cupos_disponibles <= 0) {
                    $texto_inscripcion = "No hay Cupos, S?lo lista Espera";
                    $link_icono        = '<i class="icon-calendar-empty"></i>';
                    $label             = "label-warning";
                    $boton_llamada     = "btn btn-info";
                    $texto_llamada     = "Pre-Inscrito en Lista de Espera";
                }
                $row_evento = str_replace("{LABEL_INSCRIPCION}", $label, $row_evento);
                $row_evento = str_replace("{TEXTO_INSCRIPCION}", $texto_inscripcion, $row_evento);
            } elseif ($estainscrito[0]->estadoinscripcion == "LISTAESPERA") {
                $row_evento = str_replace("{LINK_INSCRIPCION}", "#", $row_evento);
                if ($cupos_disponibles > 0) {
                    $texto_inscripcion = "<i class='icon-user'></i> $cupos_disponibles Cupos Disponibles de " . $ListaInscripcion->cupos;
                    $link_icono        = '<i class="icon-time"></i>';
                    $label             = "label-success";
                    $boton_llamada     = "btn btn-info";
                    $texto_llamada     = "<small>Pre-Inscrito, falta validacion de Jefe</small>";
                }
                if ($cupos_disponibles <= 0) {
                    $texto_inscripcion = "No hay Cupos, S?lo lista Espera";
                    $link_icono        = '<i class="icon-calendar-empty"></i>';
                    $label             = "label-warning";
                    $boton_llamada     = "btn btn-info";
                    $texto_llamada     = "Pre-Inscrito en Lista de Espera";
                }
                $row_evento = str_replace("{LABEL_INSCRIPCION}", $label, $row_evento);
                $row_evento = str_replace("{TEXTO_INSCRIPCION}", $texto_inscripcion, $row_evento);
            } elseif ($estainscrito[0]->estadoinscripcion == "INSCRITO") {
                $row_evento        = str_replace("{LINK_INSCRIPCION}", "#", $row_evento);
                $link_icono        = '<i class="icon-calendar-empty"></i>';
                $texto_inscripcion = "<i class='icon-user'></i> $cupos_disponibles Cupos Disponibles de " . $ListaInscripcion->cupos;
                $link_icono        = '<i class="icon-ok-sign"></i>';
                $label             = "label-success";
                $boton_llamada     = "label label_inscripcion label-success";
                $texto_llamada     = "?Curso Inscrito!";
                $row_evento        = str_replace("{LABEL_INSCRIPCION}", $label, $row_evento);
                $row_evento        = str_replace("{TEXTO_INSCRIPCION}", $texto_inscripcion, $row_evento);
            } elseif ($estainscrito[0]->estadoinscripcion == "RECHAZADO") {
                $row_evento        = str_replace("{LINK_INSCRIPCION}", "#", $row_evento);
                $texto_inscripcion = "<i class='icon-user'></i> $cupos_disponibles Cupos Disponibles de " . $ListaInscripcion->cupos;
                $link_icono        = '<i class="icon-remove-sign"></i>';
                $label             = "label-success";
                $boton_llamada     = "label label_inscripcion label-danger";
                $texto_llamada     = "Solicitud Rechazada...";
                $row_evento        = str_replace("{LABEL_INSCRIPCION}", $label, $row_evento);
                $row_evento        = str_replace("{TEXTO_INSCRIPCION}", $texto_inscripcion, $row_evento);
            } elseif ($estainscrito[0]->estadoinscripcion == "") {
                //echo "vacio";
                $row_evento = str_replace("{LABEL_INSCRIPCION}", $label, $row_evento);
                $row_evento = str_replace("{TEXTO_INSCRIPCION}", $texto_inscripcion, $row_evento);
                $row_evento = str_replace("{LINK_INSCRIPCION}", "?sw=saveInscripcionCursosSinValidacion&idc=" . $ListaInscripcion->codigo_inscripcion . "&idm=" . $id_malla . "", $row_evento);
            }
            $row_evento = str_replace("{LINK_ICONO}", $link_icono, $row_evento);
            $row_evento = str_replace("{LINK_LLAMADA}", $texto_llamada, $row_evento);
            $row_evento = str_replace("{LINK_MODAL_CURSO}", $cupos_inscritos, $row_evento);
            $row_evento = str_replace("{BOTON_LLAMADA}", $boton_llamada, $row_evento);
            $row_evento = str_replace("{HORAINICIO}", $ListaInscripcion->horainicio, $row_evento);
            $row_evento = str_replace("{HORATERMINADA}", $ListaInscripcion->horatermino, $row_evento);
            $row_evento = str_replace("{DIRECCION}", $ListaInscripcion->direccion, $row_evento);
        }
    }
    //$row_evento = str_replace("{ROW_CURSOS_DISPONIBLES_ORDENADOS}", $row_evento, $PRINCIPAL);
    return $row_evento;
}
function ListaCursoInscripcion($rut, $id_empresa)
{
    //$ListaCursos=ListaCursosDisponibleYDatos($rut, $id_empresa);
    $ListaCursos   = ListaCursosDisponibleAgrupados($id_empresa);
    $row           = "";
    $ok_finalizado = 0;
    foreach ($ListaCursos as $ListaCurso) {
        $id_curso = $ListaCurso->id;
        $row_evento .= file_get_contents("views/evento/row_evento_curso.html");
        $row_evento         = str_replace("{ID}", utf8_encode($ListaCurso->id), $row_evento);
        $row_evento         = str_replace("{NOMBRE_CURSO}", utf8_encode($ListaCurso->nombre), $row_evento);
        $row_evento         = str_replace("{IMAGEN_CURSO}", $ListaCurso->imagen, $row_evento);
        $row_evento         = str_replace("{DESCRIPCION}", utf8_encode($ListaCurso->descripcion), $row_evento);
        $row_evento         = str_replace("{DESCRIPTOR}", utf8_encode($ListaCurso->descriptor), $row_evento);
        $row_evento         = str_replace("{ACERCADE}", utf8_encode($ListaCurso->acercade), $row_evento);
        $row_evento         = str_replace("{OBJETIVO_CURSO}", utf8_encode($ListaCurso->objetivo_curso), $row_evento);
        $ListaInscripciones = ListaInscripcionesDisponibleYDatos($id_curso, $id_empresa);
        //print_r($ListaInscripciones);
        foreach ($ListaInscripciones as $ListaInscripcion) {
            $row_evento .= file_get_contents("views/evento/row_evento_inscripcion.html");
            $fecha_inicio      = $ListaInscripcion->fecha_inicio;
            $dia               = date('d', strtotime($ListaInscripcion->fecha_inicio));
            $mes               = date('m', strtotime($ListaInscripcion->fecha_inicio));
            $mestxt            = mes_3letras($mes);
            $num_inscritos     = $ListaInscripcion->Inscritos;
            $num_preinscritos  = $ListaInscripcion->Preinscritos;
            $num_listaespera   = $ListaInscripcion->ListaEspera;
            $cupos_inscritos   = $num_inscritos + $num_preinscritos;
            $cupos_espera      = $num_listaespera;
            $cupos_disponibles = $ListaInscripcion->cupos - $cupos_inscritos;
            if ($cupos_disponibles <= 0) {
                $cupos_disponibles = 0;
            }
            if ($cupos_disponibles > 0) {
                $texto_inscripcion = "<i class='icon-user'></i> $cupos_disponibles Cupos Disponibles de " . $ListaInscripcion->cupos;
                $link_icono        = '<i class="fas fa-check-square"></i>';
                $label             = "label-success";
                $boton_llamada     = "btn btn-success";
                $texto_llamada     = "Postular";
            }
            if ($cupos_disponibles <= 0) {
                $texto_inscripcion = "No hay Cupos, S?lo lista Espera";
                $link_icono        = '<i class="icon-calendar-empty"></i>';
                $label             = "label-warning";
                $boton_llamada     = "btn btn-warning";
                $texto_llamada     = "Dejarme en Lista de Espera";
            }
            $row_evento   = str_replace("{DIA}", $dia, $row_evento);
            $row_evento   = str_replace("{MES}", $mestxt, $row_evento);
            $row_evento   = str_replace("{CUPOS}", $ListaInscripcion->cupos, $row_evento);
            $row_evento   = str_replace("{HORARIO}", $ListaInscripcion->comentarios, $row_evento);
            $row_evento   = str_replace("{CUPOSINSCRIPCIONES}", $cupos_inscritos, $row_evento);
            $row_evento   = str_replace("{CUPOSDISPONIBLES}", $cupos_disponibles, $row_evento);
            $estainscrito = InscripcionRutCursoLms($rut, $ListaInscripcion->codigo_inscripcion, $id_empresa);
            //echo "<br>".$estainscrito[0]->estadoinscripcion;
            if ($estainscrito[0]->estadoinscripcion == "PREINSCRITO") {
                $row_evento = str_replace("{LINK_INSCRIPCION}", "#", $row_evento);
                if ($cupos_disponibles > 0) {
                    $texto_inscripcion = "<i class='icon-user'></i> $cupos_disponibles Cupos Disponibles de " . $ListaInscripcion->cupos;
                    $link_icono        = '<i class="icon-time"></i>';
                    $label             = "label-success";
                    $boton_llamada     = "btn btn-info";
                    $texto_llamada     = "<small>Pre-Inscrito, falta validacion de Jefe</small>";
                }
                if ($cupos_disponibles <= 0) {
                    $texto_inscripcion = "No hay Cupos, S?lo lista Espera";
                    $link_icono        = '<i class="icon-calendar-empty"></i>';
                    $label             = "label-warning";
                    $boton_llamada     = "btn btn-info";
                    $texto_llamada     = "Pre-Inscrito en Lista de Espera";
                }
                $row_evento = str_replace("{LABEL_INSCRIPCION}", $label, $row_evento);
                $row_evento = str_replace("{TEXTO_INSCRIPCION}", $texto_inscripcion, $row_evento);
            } elseif ($estainscrito[0]->estadoinscripcion == "LISTAESPERA") {
                $row_evento = str_replace("{LINK_INSCRIPCION}", "#", $row_evento);
                if ($cupos_disponibles > 0) {
                    $texto_inscripcion = "<i class='icon-user'></i> $cupos_disponibles Cupos Disponibles de " . $ListaInscripcion->cupos;
                    $link_icono        = '<i class="icon-time"></i>';
                    $label             = "label-success";
                    $boton_llamada     = "btn btn-info";
                    $texto_llamada     = "<small>Pre-Inscrito, falta validacion de Jefe</small>";
                }
                if ($cupos_disponibles <= 0) {
                    $texto_inscripcion = "No hay Cupos, S?lo lista Espera";
                    $link_icono        = '<i class="icon-calendar-empty"></i>';
                    $label             = "label-warning";
                    $boton_llamada     = "btn btn-info";
                    $texto_llamada     = "Pre-Inscrito en Lista de Espera";
                }
                $row_evento = str_replace("{LABEL_INSCRIPCION}", $label, $row_evento);
                $row_evento = str_replace("{TEXTO_INSCRIPCION}", $texto_inscripcion, $row_evento);
            } elseif ($estainscrito[0]->estadoinscripcion == "INSCRITO") {
                $row_evento        = str_replace("{LINK_INSCRIPCION}", "#", $row_evento);
                $link_icono        = '<i class="icon-calendar-empty"></i>';
                $texto_inscripcion = "<i class='icon-user'></i> $cupos_disponibles Cupos Disponibles de " . $ListaInscripcion->cupos;
                $link_icono        = '<i class="icon-ok-sign"></i>';
                $label             = "label-success";
                $boton_llamada     = "label label_inscripcion label-success";
                $texto_llamada     = "?Curso Inscrito!";
                $row_evento        = str_replace("{LABEL_INSCRIPCION}", $label, $row_evento);
                $row_evento        = str_replace("{TEXTO_INSCRIPCION}", $texto_inscripcion, $row_evento);
            } elseif ($estainscrito[0]->estadoinscripcion == "RECHAZADO") {
                $row_evento        = str_replace("{LINK_INSCRIPCION}", "#", $row_evento);
                $texto_inscripcion = "<i class='icon-user'></i> $cupos_disponibles Cupos Disponibles de " . $ListaInscripcion->cupos;
                $link_icono        = '<i class="icon-remove-sign"></i>';
                $label             = "label-success";
                $boton_llamada     = "label label_inscripcion label-danger";
                $texto_llamada     = "Solicitud Rechazada...";
                $row_evento        = str_replace("{LABEL_INSCRIPCION}", $label, $row_evento);
                $row_evento        = str_replace("{TEXTO_INSCRIPCION}", $texto_inscripcion, $row_evento);
            } elseif ($estainscrito[0]->estadoinscripcion == "") {
                //echo "vacio";
                $row_evento = str_replace("{LABEL_INSCRIPCION}", $label, $row_evento);
                $row_evento = str_replace("{TEXTO_INSCRIPCION}", $texto_inscripcion, $row_evento);
                $row_evento = str_replace("{LINK_INSCRIPCION}", "?sw=saveInscripcionCursos&idc=" . $ListaInscripcion->codigo_inscripcion . "", $row_evento);
            }
            $row_evento = str_replace("{LINK_ICONO}", $link_icono, $row_evento);
            $row_evento = str_replace("{LINK_LLAMADA}", $texto_llamada, $row_evento);
            $row_evento = str_replace("{LINK_MODAL_CURSO}", $cupos_inscritos, $row_evento);
            $row_evento = str_replace("{BOTON_LLAMADA}", $boton_llamada, $row_evento);
            $row_evento = str_replace("{HORAINICIO}", $ListaInscripcion->horainicio, $row_evento);
            $row_evento = str_replace("{HORATERMINADA}", $ListaInscripcion->horatermino, $row_evento);
            $row_evento = str_replace("{DIRECCION}", $ListaInscripcion->direccion, $row_evento);
        }
    }
    //$row_evento = str_replace("{ROW_CURSOS_DISPONIBLES_ORDENADOS}", $row_evento, $PRINCIPAL);
    return $row_evento;
}
function ListaCursoInscripcionrut($rut, $tipo, $id_empresa)
{
    $ListaCursos   = ListaCursosInscripcionesRut($rut, $tipo, $id_empresa);
    $row           = "";
    $ok_finalizado = 0;
    foreach ($ListaCursos as $ListaCurso) {
        //echo $ListaCurso->nombre_curso;
        $row_evento .= file_get_contents("views/evento/row_misinscripciones.html");
        $row_evento        = str_replace("{NOMBRE_CURSO}", utf8_encode($ListaCurso->curso), $row_evento);
        $row_evento        = str_replace("{IMAGEN_CURSO}", $ListaCurso->imagen, $row_evento);
        $fecha_inicio      = $ListaCurso->fecha_inicio;
        $dia               = date('d', strtotime($ListaCurso->fecha_inicio));
        $mes               = date('m', strtotime($ListaCurso->fecha_inicio));
        $mestxt            = mes_3letras($mes);
        $num_inscritos     = $ListaCurso->Inscritos;
        $num_preinscritos  = $ListaCurso->Preinscritos;
        $num_listaespera   = $ListaCurso->ListaEspera;
        $cupos_inscritos   = $num_inscritos + $num_preinscritos;
        $cupos_espera      = $num_listaespera;
        $cupos_disponibles = $ListaCurso->cupos - $cupos_inscritos;
        $row_evento        = str_replace("{ID}", $ListaCurso->id, $row_evento);
        $row_evento        = str_replace("{DIA}", $dia, $row_evento);
        $row_evento        = str_replace("{MES}", $mestxt, $row_evento);
        $row_evento        = str_replace("{CUPOS}", $ListaCurso->cupos, $row_evento);
        $row_evento        = str_replace("{HORARIO}", $ListaCurso->comentarios, $row_evento);
        $row_evento        = str_replace("{CUPOSINSCRIPCIONES}", $cupos_inscritos, $row_evento);
        $row_evento        = str_replace("{CUPOSDISPONIBLES}", $cupos_disponibles, $row_evento);
        $row_evento        = str_replace("{LABEL_INSCRIPCION}", $label, $row_evento);
        $row_evento        = str_replace("{TEXTO_INSCRIPCION}", $texto_inscripcion, $row_evento);
        $row_evento        = str_replace("{LINK_INSCRIPCION}", $cupos_inscritos, $row_evento);
        $row_evento        = str_replace("{LINK_ICONO}", $link_icono, $row_evento);
        $row_evento        = str_replace("{LINK_LLAMADA}", $texto_llamada, $row_evento);
        $row_evento        = str_replace("{LINK_MODAL_CURSO}", $cupos_inscritos, $row_evento);
        $row_evento        = str_replace("{BOTON_LLAMADA}", $boton_llamada, $row_evento);
        $row_evento        = str_replace("{HORAINICIO}", $ListaCurso->horainicio, $row_evento);
        $row_evento        = str_replace("{HORATERMINADA}", $ListaCurso->horatermino, $row_evento);
        $row_evento        = str_replace("{DIRECCION}", $ListaCurso->direccion, $row_evento);
        $row_evento        = str_replace("{DESCRIPCION}", utf8_encode($ListaCurso->descripcion), $row_evento);
        $row_evento        = str_replace("{DESCRIPTOR}", utf8_encode($ListaCurso->descriptor), $row_evento);
        $row_evento        = str_replace("{ACERCADE}", utf8_encode($ListaCurso->acercade), $row_evento);
        $row_evento        = str_replace("{OBJETIVO_CURSO}", utf8_encode($ListaCurso->objetivo_curso), $row_evento);
    }
    //$row_evento = str_replace("{ROW_CURSOS_DISPONIBLES_ORDENADOS}", $row_evento, $PRINCIPAL);
    return $row_evento;
}
function ListaMisInscripciones($rut, $id_empresa)
{
    $cuentaInscritos      = ListaCuentaInscripciones($rut, "INSCRITO", $id_empresa);
    $cuentaListaEspera    = ListaCuentaInscripciones($rut, "PREINSCRITO", $id_empresa);
    $cuentaValidacionJefe = ListaCuentaInscripciones($rut, "LISTAESPERA", $id_empresa);
    $cuentaRechazados     = ListaCuentaInscripciones($rut, "RECHAZADO", $id_empresa);
    //echo $ListaCurso->nombre_curso;
    $row_evento .= file_get_contents("views/evento/row_resumen_inscripciones.html");
    $row_evento = str_replace("{NUM_INSCRITOS}", $cuentaInscritos, $row_evento);
    $row_evento = str_replace("{NUM_LISTAESPERA}", $cuentaListaEspera, $row_evento);
    $row_evento = str_replace("{NUM_ESPERAAPROBACION}", $cuentaValidacionJefe, $row_evento);
    $row_evento = str_replace("{NUM_RECHAZADO}", $cuentaRechazados, $row_evento);
    return $row_evento;
}
function ListaMisInscripcionesTxt($rut, $tipo, $id_empresa)
{
    $cuenta = ListaCuentaInscripciones($rut, $tipo, $id_empresa);
    if ($cuenta > 0) {
        $txt = "";
    } else {
        $txt = "No tienes cursos en esta categor?a";
    }
    return $txt;
}
function NoticiasMiniSlider($PRINCIPAL, $tipo, $limit, $variable)
{
    if ($tipo == "1") {
        $template_row = file_get_contents("views/noticias/row_noticias_principales.html");
        $noticias     = TraeNoticiasPrincipales($_SESSION["id_empresa"], $variable, $limit);
    } else if ($tipo == "Topleft") {
        $template_row       = file_get_contents("views/noticiasminislider/row_noticiasminislider.html");
        $noticiasminislider = TraeNoticiasMiniSlider($_SESSION["id_empresa"], $limit);
    }
    foreach ($noticiasminislider as $not) {
        $row = $template_row;
        $row = str_replace("{IMAGEN}", $not->imagen, $row);
        $total_html .= $row;
    }
    //echo $total_html;
    $PRINCIPAL = str_replace("{COLUMNAS_NOTICIAS_MINISLIDER}", utf8_encode($total_html), $PRINCIPAL);
    return ($PRINCIPAL);
}